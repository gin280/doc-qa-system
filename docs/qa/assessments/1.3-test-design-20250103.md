# 测试设计：Story 1.3 - 用户注册功能

**日期**: 2025-01-03  
**设计者**: Quinn (测试架构师)

## 测试策略概览

- **总测试场景**: 18
- **单元测试**: 8 (44%)
- **集成测试**: 7 (39%)
- **E2E 测试**: 3 (17%)
- **优先级分布**: P0: 8, P1: 6, P2: 4

## 按验收标准的测试场景

### AC1: 注册页面 UI

#### 场景

| ID           | 级别 | 优先级 | 测试                       | 理由                     |
| ------------ | ---- | ------ | -------------------------- | ------------------------ |
| 1.3-E2E-001  | E2E  | P1     | 注册页面正确渲染           | 关键用户入口点验证       |
| 1.3-UNIT-001 | Unit | P2     | RegisterForm 组件挂载      | 组件生命周期验证         |
| 1.3-UNIT-002 | Unit | P2     | 所有表单字段存在           | UI 完整性验证            |

**状态**: ✅ **已实施** - 页面和组件已创建
**覆盖范围**: 完整

---

### AC2: 前端表单验证

#### 场景

| ID           | 级别 | 优先级 | 测试                      | 理由                 |
| ------------ | ---- | ------ | ------------------------- | -------------------- |
| 1.3-UNIT-003 | Unit | P0     | 邮箱格式验证（Zod）       | 核心验证逻辑         |
| 1.3-UNIT-004 | Unit | P0     | 密码强度验证（8 位+混合） | 安全要求验证         |
| 1.3-UNIT-005 | Unit | P0     | 确认密码匹配验证          | 用户体验关键点       |
| 1.3-UNIT-006 | Unit | P1     | 用户名长度验证            | 数据完整性           |
| 1.3-INT-001  | Int  | P1     | 实时错误提示显示          | 用户反馈验证         |

**状态**: ⚠️ **部分实施** - 验证逻辑存在，但缺少单元测试
**覆盖范围**: 40% - 需要添加前端验证单元测试

---

### AC3: 注册 API 实现

#### 场景

| ID           | 级别 | 优先级 | 测试                         | 理由                     |
| ------------ | ---- | ------ | ---------------------------- | ------------------------ |
| 1.3-UNIT-007 | Unit | P0     | 成功注册新用户               | 主要功能路径             |
| 1.3-UNIT-008 | Unit | P0     | 拒绝重复邮箱                 | 数据完整性约束           |
| 1.3-UNIT-009 | Unit | P0     | 密码正确哈希（bcrypt, salt≥10） | 安全要求验证             |
| 1.3-UNIT-010 | Unit | P0     | 创建 UserUsage 记录          | 数据一致性               |
| 1.3-INT-002  | Int  | P0     | 数据库正确创建用户           | 多组件集成               |
| 1.3-INT-003  | Int  | P0     | 邮箱唯一性数据库级验证       | 并发安全                 |

**状态**: ❌ **测试失败** - 存在但因 Jest 配置问题无法运行
**覆盖范围**: 0% (可执行的) - **关键阻塞问题**

---

### AC4: 注册成功流程

#### 场景

| ID           | 级别 | 优先级 | 测试                     | 理由                     |
| ------------ | ---- | ------ | ------------------------ | ------------------------ |
| 1.3-INT-004  | Int  | P1     | 注册后自动登录           | 用户体验流程             |
| 1.3-E2E-002  | E2E  | P0     | 完整注册到仪表板流程     | 关键用户旅程             |
| 1.3-INT-005  | Int  | P2     | 显示欢迎提示             | 用户反馈                 |

**状态**: ⚠️ **未实施** - 功能存在，测试缺失
**覆盖范围**: 0%

---

### AC5: 错误处理

#### 场景

| ID           | 级别 | 优先级 | 测试                       | 理由                     |
| ------------ | ---- | ------ | -------------------------- | ------------------------ |
| 1.3-UNIT-011 | Unit | P0     | 邮箱已存在错误响应         | 核心错误场景             |
| 1.3-UNIT-012 | Unit | P0     | 密码弱错误响应             | 输入验证                 |
| 1.3-INT-006  | Int  | P1     | 网络错误处理               | 可靠性                   |
| 1.3-INT-007  | Int  | P1     | API 错误标准格式           | 一致性                   |
| 1.3-E2E-003  | E2E  | P2     | 友好错误消息 UI 显示       | 用户体验                 |

**状态**: ⚠️ **部分实施** - 后端处理存在，前端 E2E 测试缺失
**覆盖范围**: 40%

---

## 风险覆盖

基于风险评估文档，测试场景映射：

| 风险 ID  | 相关测试场景                          | 覆盖状态 |
| -------- | ------------------------------------- | -------- |
| TEST-001 | 所有单元测试                          | ❌ 阻塞  |
| SEC-001  | _需要新测试：速率限制_                | ❌ 缺失  |
| SEC-002  | _需要新测试：邮箱验证_                | ❌ 缺失  |
| REL-001  | 1.3-INT-002, 1.3-INT-003（需增强）    | ⚠️ 部分  |
| SEC-003  | _需要新测试：CSRF 保护_               | ❌ 缺失  |
| REL-002  | _需要新测试：日志记录_                | ❌ 缺失  |
| PERF-001 | _需要新测试：性能基准_                | ❌ 缺失  |
| MNT-001  | （非功能性，无测试需求）              | N/A      |

---

## 建议的执行顺序

1. **P0 修复 TEST-001**（失败快速）
   - 修复 Jest 配置
   - 验证所有单元测试可运行

2. **P0 单元测试**
   - 1.3-UNIT-003 到 1.3-UNIT-012（验证和 API 逻辑）

3. **P0 集成测试**
   - 1.3-INT-002, 1.3-INT-003（数据库操作）
   - 1.3-E2E-002（关键用户旅程）

4. **P1 测试**（按顺序）
   - 集成测试
   - E2E 测试

5. **P2+ 测试**（时间允许时）

---

## 测试覆盖率差距

### 关键差距

1. **TEST-001: Jest 基础设施失败** ❌
   - **影响**: 所有单元测试无法运行
   - **优先级**: P0 - **生产阻塞**
   - **行动**: 立即修复 Jest moduleNameMapper 配置

2. **前端验证单元测试** ⚠️
   - **影响**: AC2 无测试覆盖
   - **优先级**: P0 - 安全关键
   - **行动**: 添加 Zod schema 验证的单元测试

3. **完整注册流程 E2E 测试** ⚠️
   - **影响**: AC4 无端到端验证
   - **优先级**: P0 - 关键路径
   - **行动**: 使用 Playwright/Cypress 创建 E2E 测试

4. **安全测试** ❌
   - **影响**: SEC-001, SEC-002, SEC-003 无覆盖
   - **优先级**: P1 - 部署前需要
   - **行动**: 添加速率限制、CSRF、输入消毒测试

5. **性能和可靠性测试** ⚠️
   - **影响**: 无基准或负载测试
   - **优先级**: P1 - 质量保证
   - **行动**: 添加性能测试套件

### 次要差距

6. **事务测试** ⚠️
   - **影响**: REL-001 不完全覆盖
   - **优先级**: P2
   - **行动**: 添加事务回滚测试

7. **日志验证** ⚠️
   - **影响**: REL-002 无覆盖
   - **优先级**: P2
   - **行动**: 验证结构化日志输出

---

## 详细测试场景

### 单元测试

#### 1.3-UNIT-003: 邮箱格式验证

```typescript
describe('RegisterForm validation', () => {
  it('should reject invalid email formats', () => {
    const testCases = [
      'invalid-email',
      'missing@domain',
      '@no-local.com',
      'spaces in@email.com',
    ]
    
    testCases.forEach(email => {
      const result = registerSchema.safeParse({ email, ... })
      expect(result.success).toBe(false)
    })
  })
  
  it('should accept valid email formats', () => {
    const result = registerSchema.safeParse({
      email: 'valid@example.com',
      password: 'password123',
      confirmPassword: 'password123',
      name: 'Test User'
    })
    expect(result.success).toBe(true)
  })
})
```

#### 1.3-UNIT-004: 密码强度验证

```typescript
describe('Password strength validation', () => {
  it('should reject passwords under 8 characters', () => {
    const result = registerSchema.safeParse({
      email: 'test@example.com',
      password: 'short1',
      confirmPassword: 'short1',
      name: 'Test'
    })
    expect(result.success).toBe(false)
  })
  
  it('should reject passwords without letters and numbers', () => {
    const testCases = [
      'onlyletters',    // 只有字母
      '12345678',       // 只有数字
      '!@#$%^&*()',     // 只有特殊字符
    ]
    
    testCases.forEach(password => {
      const result = registerSchema.safeParse({
        email: 'test@example.com',
        password,
        confirmPassword: password,
        name: 'Test'
      })
      expect(result.success).toBe(false)
    })
  })
  
  it('should accept strong passwords', () => {
    const result = registerSchema.safeParse({
      email: 'test@example.com',
      password: 'Strong123',
      confirmPassword: 'Strong123',
      name: 'Test'
    })
    expect(result.success).toBe(true)
  })
})
```

#### 1.3-UNIT-009: 密码哈希验证

```typescript
describe('Password hashing', () => {
  it('should hash password with bcrypt salt rounds >= 10', async () => {
    const mockHash = jest.spyOn(bcrypt, 'hash')
    
    await POST(mockRequest({
      email: 'test@example.com',
      password: 'password123',
      name: 'Test'
    }))
    
    expect(mockHash).toHaveBeenCalledWith('password123', 10)
  })
  
  it('should never store plain-text passwords', async () => {
    const response = await POST(mockRequest({
      email: 'new@example.com',
      password: 'password123',
      name: 'Test'
    }))
    
    const data = await response.json()
    expect(data.user).not.toHaveProperty('password')
    expect(data.user).not.toHaveProperty('passwordHash')
  })
})
```

### 集成测试

#### 1.3-INT-002: 数据库正确创建用户

```typescript
describe('User creation integration', () => {
  it('should create user in database with correct fields', async () => {
    const response = await POST(realRequest({
      email: 'integration@test.com',
      password: 'password123',
      name: 'Integration Test'
    }))
    
    expect(response.status).toBe(201)
    
    // 验证数据库中的用户
    const [user] = await db.select()
      .from(users)
      .where(eq(users.email, 'integration@test.com'))
    
    expect(user).toBeDefined()
    expect(user.name).toBe('Integration Test')
    expect(user.authProvider).toBe('EMAIL')
    expect(user.passwordHash).toBeDefined()
    expect(user.passwordHash).not.toBe('password123')
  })
  
  it('should create UserUsage record for new user', async () => {
    const response = await POST(realRequest({
      email: 'usage@test.com',
      password: 'password123',
      name: 'Usage Test'
    }))
    
    const data = await response.json()
    
    // 验证 UserUsage 记录
    const [usage] = await db.select()
      .from(userUsage)
      .where(eq(userUsage.userId, data.user.id))
    
    expect(usage).toBeDefined()
    expect(usage.documentCount).toBe(0)
    expect(usage.storageUsed).toBe(0)
    expect(usage.queryCount).toBe(0)
  })
})
```

#### 1.3-INT-003: 邮箱唯一性数据库级验证

```typescript
describe('Email uniqueness', () => {
  it('should enforce email uniqueness at database level', async () => {
    // 第一次注册
    await POST(realRequest({
      email: 'duplicate@test.com',
      password: 'password123',
      name: 'First User'
    }))
    
    // 尝试重复注册
    const response = await POST(realRequest({
      email: 'duplicate@test.com',
      password: 'different456',
      name: 'Second User'
    }))
    
    expect(response.status).toBe(400)
    const data = await response.json()
    expect(data.error).toContain('已被注册')
  })
  
  it('should handle concurrent registration attempts', async () => {
    const requests = Array(5).fill(null).map(() =>
      POST(realRequest({
        email: 'concurrent@test.com',
        password: 'password123',
        name: 'Concurrent User'
      }))
    )
    
    const responses = await Promise.all(requests)
    const successCount = responses.filter(r => r.status === 201).length
    const failCount = responses.filter(r => r.status === 400).length
    
    expect(successCount).toBe(1)
    expect(failCount).toBe(4)
  })
})
```

### E2E 测试

#### 1.3-E2E-002: 完整注册到仪表板流程

```typescript
describe('Complete registration flow', () => {
  it('should register user and redirect to dashboard', async () => {
    await page.goto('http://localhost:3000/register')
    
    // 填写表单
    await page.fill('#name', 'E2E Test User')
    await page.fill('#email', 'e2e@test.com')
    await page.fill('#password', 'password123')
    await page.fill('#confirmPassword', 'password123')
    
    // 提交
    await page.click('button[type="submit"]')
    
    // 验证重定向
    await page.waitForNavigation()
    expect(page.url()).toContain('/dashboard')
    
    // 验证欢迎提示
    const welcome = await page.textContent('.welcome-message')
    expect(welcome).toContain('欢迎')
  })
  
  it('should show validation errors in real-time', async () => {
    await page.goto('http://localhost:3000/register')
    
    // 输入无效邮箱
    await page.fill('#email', 'invalid-email')
    await page.blur('#email')
    
    // 验证错误提示
    const error = await page.textContent('.text-red-500')
    expect(error).toContain('邮箱格式不正确')
  })
})
```

---

## 质量检查清单

完成前验证：

- [x] 每个 AC 至少有一个测试
- [❌] 测试级别适当（没有过度测试）- **被 TEST-001 阻塞**
- [❌] 各级别无重复覆盖 - **无法验证**
- [x] 优先级与业务风险一致
- [x] 测试 ID 遵循命名约定
- [❌] 场景是原子和独立的 - **无法验证**

---

## 关键原则

- **左移**: 优先单元测试而非集成测试，集成测试优先于 E2E
- **基于风险**: 专注于可能出错的地方
- **高效覆盖**: 在正确级别测试一次
- **可维护性**: 考虑长期测试维护
- **快速反馈**: 快速测试优先运行

---

## 下一步行动

### 立即行动（P0）

1. **修复 TEST-001** - 修复 Jest 配置，使所有单元测试可运行
2. **添加前端验证单元测试** - AC2 覆盖
3. **创建完整 E2E 测试** - AC4 关键路径覆盖

### 短期行动（P1）

4. **安全测试套件** - 速率限制、输入消毒、CSRF
5. **集成测试增强** - 事务、错误恢复
6. **性能基准测试** - 响应时间、并发用户

### 长期行动（P2+）

7. **日志验证测试**
8. **可访问性测试**
9. **跨浏览器兼容性测试**

