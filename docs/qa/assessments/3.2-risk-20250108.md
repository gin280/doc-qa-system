# Risk Profile: Story 3.2 - RAG向量检索实现

**Date**: 2025-01-08  
**Reviewer**: Quinn (测试架构师)  
**Story**: 3.2 - RAG向量检索实现

---

## Executive Summary

- **Total Risks Identified**: 18
- **Critical Risks (Score 9)**: 2
- **High Risks (Score 6)**: 4
- **Medium Risks (Score 4)**: 8
- **Low Risks (Score 2-3)**: 4
- **Overall Risk Score**: 62/100 (Moderate Risk)

**主要风险领域**:
1. **检索质量** - RAG准确率直接影响用户满意度
2. **LLM API依赖** - 外部服务可用性和成本控制
3. **性能瓶颈** - pgvector在大数据量下的性能
4. **缓存策略** - Redis故障和缓存一致性

---

## Critical Risks Requiring Immediate Attention

### 1. PERF-001: 检索质量不达标

**Score: 9 (Critical)** - Probability: High (3) × Impact: High (3)

**描述**:  
向量检索返回的Top-5结果与用户问题不相关，导致LLM生成错误回答或"无法回答"，严重影响产品可用性。

**Probability: High (>70%)**  
- 首次实现RAG系统，参数调优需要迭代
- 文档分块策略（Story 2.4）可能不完全适配检索需求
- 0.7的相似度阈值可能过于严格或宽松

**Impact: High**  
- 用户得到错误或无关回答 → 信任度下降 → 用户流失
- 产品核心价值（智能问答）无法体现
- 需要大量人工调优和回归测试

**Affected Components**:
- `retrievalService.ts` - 检索编排
- `pgvector.repository.ts` - 向量检索
- `queryVectorizer.ts` - 查询向量化

**Detection Method**: AC9要求的人工质量评估（20个测试问题，Top-5准确率目标 > 85%）

### 2. SEC-002: LLM API密钥泄露

**Score: 9 (Critical)** - Probability: Medium (2) × Impact: Critical (3) + Security Factor

**描述**:  
OpenAI或智谱AI的API密钥被泄露到代码仓库、日志或错误消息中，导致API配额滥用和高额账单。

**Probability: Medium (30-70%)**  
- 开发过程中容易硬编码密钥进行测试
- 错误日志可能包含完整的API请求信息
- Sentry等监控工具可能捕获敏感信息

**Impact: Critical**  
- API配额被恶意消耗 → 高额账单（可能数千美元）
- 服务中断（API限流） → 用户无法使用问答功能
- 安全合规问题 → 公司声誉受损

**Affected Components**:
- `queryVectorizer.ts` - API调用
- `llmConfig` - 配置管理
- 日志系统 - 可能记录API请求

**Detection Method**: 
- 代码审查检查密钥管理
- Git history扫描
- 日志内容审查

---

## High Risks

### 3. PERF-002: pgvector性能瓶颈

**Score: 6 (High)** - Probability: Medium (2) × Impact: High (3)

**描述**:  
随着文档数量增长，pgvector的HNSW索引查询延迟超过500ms (P95目标)，影响用户体验。

**Probability: Medium**  
- MVP阶段数据量小，性能问题不明显
- 当向量数超过100K时，查询延迟可能急剧增加
- HNSW索引参数可能未优化

**Impact: High**  
- 用户等待时间过长 → 体验下降
- 需要紧急迁移到Pinecone等专业向量数据库 → 开发成本高
- 影响系统可扩展性

**Mitigation**:
- 实现性能基准测试（Task 7）
- 准备Pinecone迁移方案（通用接口已设计）
- 监控pgvector查询延迟，设置告警（> 500ms）
- 优化HNSW索引参数（ef_search, m）

**Testing Requirements**:
- 性能测试：1K、10K、100K向量规模下的查询延迟
- 负载测试：10并发、50并发、100并发
- 长期稳定性测试：24小时持续查询

**Residual Risk**: Medium - 即使优化，100K+向量时仍可能需要迁移

---

### 4. TECH-001: LLM API不可用或超时

**Score: 6 (High)** - Probability: Medium (2) × Impact: High (3)

**描述**:  
OpenAI或智谱AI服务不可用、超时或限流，导致查询向量化失败，用户无法获得回答。

**Probability: Medium**  
- 外部API服务偶尔会有故障或维护
- 网络问题导致超时
- API配额超限（尤其是免费层或试用期）

**Impact: High**  
- 所有问答请求失败 → 产品不可用
- 用户体验严重下降
- 需要紧急切换到备用LLM提供商

**Mitigation**:
- AC1要求：向量化超时3秒，快速失败
- AC8要求：重试1次机制
- 使用多LLM适配器（Story 2.4已实现）- 自动降级到备用提供商
- 监控LLM API可用性和响应时间

**Testing Requirements**:
- 模拟API超时场景
- 模拟API 503错误
- 验证自动降级机制
- 验证错误消息友好性

**Residual Risk**: Low - 多提供商策略大幅降低风险

---

### 5. DATA-001: Redis缓存不一致

**Score: 6 (High)** - Probability: Medium (2) × Impact: High (3)

**描述**:  
文档被更新或删除后，Redis中的缓存未失效，用户获得过期的检索结果。

**Probability: Medium**  
- AC5实现了`invalidateDocumentCache()`，但需要在正确的时机调用
- Story 2.5文档删除逻辑可能未调用缓存失效
- 并发更新时可能出现竞态条件

**Impact: High**  
- 用户看到过期内容 → 困惑和不信任
- 基于过期数据生成的回答不准确
- 缓存污染影响其他用户

**Mitigation**:
- 在文档删除API中调用`invalidateDocumentCache()`
- 在文档重新向量化时（Story 2.4）调用缓存失效
- 设置合理的TTL（30分钟）作为保底
- 监控缓存命中率和失效操作

**Testing Requirements**:
- 测试文档删除后缓存失效
- 测试文档更新后缓存失效
- 测试并发场景下的缓存一致性

**Residual Risk**: Low - 有TTL保底，风险可控

---

### 6. OPS-001: Redis服务故障

**Score: 6 (High)** - Probability: Medium (2) × Impact: High (3)

**描述**:  
Upstash Redis服务不可用或网络连接失败，导致缓存功能完全失效。

**Probability: Medium**  
- Upstash免费层可能有可用性限制
- 网络问题导致连接超时
- Redis达到内存上限

**Impact: High**  
- 所有查询都需要向量化 → API成本大幅增加（无缓存）
- 向量化API可能被频繁调用 → 达到速率限制
- 用户体验下降（响应变慢）

**Mitigation**:
- AC5要求：缓存失败降级到无缓存模式（不影响主流程）
- 监控Redis可用性和连接成功率
- 考虑升级到Upstash付费层（99.99% SLA）
- 准备备用缓存方案（本地内存缓存作为L1）

**Testing Requirements**:
- 模拟Redis完全不可用
- 模拟Redis连接超时
- 验证降级逻辑正常工作
- 验证错误日志不会淹没系统

**Residual Risk**: Low - 降级策略保证基本可用性

---

## Medium Risks

### 7. TECH-002: 查询向量化维度不匹配

**Score: 4 (Medium)** - Probability: Low (1) × Impact: High (3) + Technical Debt

**描述**:  
查询向量化使用了不同于文档向量化的embedding模型，导致维度不匹配（如1024维 vs 1536维）。

**Probability: Low**  
- AC1明确要求使用与文档相同的模型
- LLM Repository已封装模型选择逻辑（Story 2.4）
- 有维度验证（检查1536维）

**Impact: High**  
- 向量检索完全失败（pgvector维度不匹配错误）
- 所有查询返回500错误
- 需要紧急修复和部署

**Mitigation**:
- AC1要求：验证向量维度 = 1536
- 单元测试覆盖维度验证逻辑
- 配置管理确保模型一致性
- 错误消息清晰提示维度问题

**Residual Risk**: Very Low - 多重验证机制

---

### 8. PERF-003: 并行优化未生效

**Score: 4 (Medium)** - Probability: Medium (2) × Impact: Medium (2)

**描述**:  
AC7要求的并行执行（权限验证 + 向量化）未正确实现，导致总延迟 = 权限验证延迟 + 向量化延迟，超过500ms目标。

**Probability: Medium**  
- Promise.all使用不当
- 其中一个操作阻塞了另一个
- 数据库连接池耗尽

**Impact: Medium**  
- 响应时间增加100-200ms
- 用户体验轻微下降
- 未达到性能目标

**Mitigation**:
- 代码审查确认Promise.all正确使用
- 性能测试验证并行效果（Task 7）
- 监控各阶段耗时，识别瓶颈

**Residual Risk**: Low - 技术实现简单

---

### 9. DATA-002: 查询缓存键冲突

**Score: 4 (Medium)** - Probability: Low (1) × Impact: High (3) + Edge Case

**描述**:  
MD5哈希冲突导致不同问题映射到相同缓存键，用户A的查询结果被用户B复用。

**Probability: Low**  
- MD5冲突概率极低（2^128）
- 缓存键包含documentId前缀，进一步降低冲突

**Impact: High**  
- 用户得到错误的检索结果
- 隐私问题（虽然仅限于同一文档）
- 调试困难

**Mitigation**:
- AC5使用：`rag:query:{documentId}:{queryHash}`
- documentId前缀隔离不同文档的查询
- 监控缓存命中率异常（突然下降可能是冲突）
- 考虑使用SHA-256（更安全但稍慢）

**Residual Risk**: Very Low - 设计已充分考虑

---

### 10. SEC-001: 查询内容日志泄露隐私

**Score: 4 (Medium)** - Probability: Medium (2) × Impact: Medium (2)

**描述**:  
用户的问题内容被完整记录到日志中，可能包含敏感信息（如个人信息、商业机密）。

**Probability: Medium**  
- AC10要求记录查询内容（前50字符）
- 开发人员可能记录完整问题用于调试
- 日志可能被未授权人员访问

**Impact: Medium**  
- 隐私合规问题（GDPR、个人信息保护法）
- 用户信任度下降
- 可能需要删除历史日志

**Mitigation**:
- AC10已要求：仅记录前50字符
- 脱敏处理：移除手机号、邮箱、身份证等模式
- 日志访问权限控制
- 定期清理历史日志（保留30天）

**Residual Risk**: Low - 已有脱敏策略

---

### 11. BUS-001: 检索成本超预算

**Score: 4 (Medium)** - Probability: Medium (2) × Impact: Medium (2)

**描述**:  
查询向量化API调用量超预期，月度成本超过预算（目标 < $650）。

**Probability: Medium**  
- 用户活跃度可能超出预估
- 缓存命中率低于30%目标
- 用户频繁提问重复或相似问题

**Impact: Medium**  
- 运营成本超支
- 可能需要削减功能或限制用户
- 影响盈利能力

**Mitigation**:
- AC5实现Redis缓存（目标命中率 > 30%）
- 监控embedding API调用量和成本
- 设置每用户每日查询配额（AC6, AC8）
- 告警：月度成本超过80%预算

**Residual Risk**: Low - 有多重成本控制措施

---

### 12. TECH-003: Top-K参数选择不当

**Score: 4 (Medium)** - Probability: Medium (2) × Impact: Medium (2)

**描述**:  
默认Top-K=5可能不够或太多，影响回答质量和Token成本。

**Probability: Medium**  
- 首次设定参数，缺少经验数据
- 不同文档类型可能需要不同Top-K
- 用户问题复杂度差异大

**Impact: Medium**  
- Top-K太小 → 遗漏关键信息 → 回答不完整
- Top-K太大 → Token成本增加 → 回答可能包含噪音

**Mitigation**:
- AC9人工质量评估验证Top-K=5的合理性
- AC4定义RetrievalOptions允许调整（最大20）
- Story 3.3可以动态调整Top-K（基于问题复杂度）
- A/B测试不同Top-K值

**Residual Risk**: Low - 可灵活调整

---

### 13. PERF-004: 数据库连接池耗尽

**Score: 4 (Medium)** - Probability: Low (1) × Impact: High (3) + Scalability

**描述**:  
高并发时Drizzle连接池耗尽，新请求无法获取数据库连接。

**Probability: Low**  
- Drizzle有默认连接池管理
- MVP阶段并发量较低
- Supabase有连接限制（~100连接）

**Impact: High**  
- 部分用户请求失败（500错误）
- 系统可用性下降
- 需要扩展数据库实例

**Mitigation**:
- 确认Drizzle连接池配置合理（max: 20）
- 监控数据库连接数
- 及时释放连接（使用try-finally）
- 考虑连接池大小告警

**Residual Risk**: Low - Drizzle有良好的连接管理

---

### 14. OPS-002: pgvector索引未创建

**Score: 4 (Medium)** - Probability: Low (1) × Impact: High (3) + Configuration

**描述**:  
Migration 0003未在生产环境正确执行，HNSW索引不存在，导致查询极慢（全表扫描）。

**Probability: Low**  
- 部署流程应该自动运行迁移
- Story 2.4已验证索引创建
- AC7要求验证索引存在

**Impact: High**  
- 查询延迟 > 10秒（无法使用）
- 产品完全不可用
- 需要紧急执行迁移（可能需要长时间）

**Mitigation**:
- Task 7明确要求验证索引存在
- 健康检查API检测索引状态
- 部署前冒烟测试验证性能
- 监控查询延迟，异常告警

**Residual Risk**: Very Low - 多重检查机制

---

## Low Risks

### 15. DATA-003: 查询去重逻辑错误

**Score: 3 (Low)** - Probability: Low (1) × Impact: Medium (2) + Edge Case

**描述**:  
AC9要求的去重逻辑（基于chunk ID）未正确实现，相同chunk被返回多次。

**Probability: Low**  
- pgvector查询不太可能返回重复chunk
- 去重逻辑简单（基于ID）

**Impact: Medium**  
- 用户看到重复内容
- LLM Prompt token浪费
- 回答质量轻微下降

**Mitigation**:
- 单元测试验证去重逻辑
- 集成测试检查返回结果唯一性

**Residual Risk**: Very Low

---

### 16. TECH-004: 相似度阈值过于严格

**Score: 3 (Low)** - Probability: Low (1) × Impact: Medium (2) + Tuning

**描述**:  
默认minScore=0.7过于严格，导致很多有用的结果被过滤。

**Probability: Low**  
- 0.7是业界常用阈值
- AC9允许调整

**Impact: Medium**  
- 检索结果太少
- "未找到相关内容"频率过高
- 用户体验下降

**Mitigation**:
- AC9人工评估验证阈值合理性
- AC4定义RetrievalOptions允许调整
- A/B测试不同阈值（0.6, 0.7, 0.8）

**Residual Risk**: Very Low - 易于调整

---

### 17. OPS-003: 日志量过大

**Score: 2 (Low)** - Probability: Low (1) × Impact: Medium (2)

**描述**:  
每次查询都记录详细日志，导致日志量激增，超过Axiom免费限额（500GB/月）。

**Probability: Low**  
- MVP阶段查询量不大
- 日志消息设计较简洁

**Impact: Medium**  
- 日志成本增加（需要付费）
- 日志存储空间不足
- 影响日志分析效率

**Mitigation**:
- AC10日志设计简洁（仅关键信息）
- 考虑采样日志（如10%）
- 定期清理历史日志
- 监控日志量，告警

**Residual Risk**: Very Low

---

### 18. BUS-002: 缓存命中率低于预期

**Score: 2 (Low)** - Probability: Low (1) × Impact: Medium (2)

**描述**:  
实际缓存命中率远低于30%目标，导致成本优化效果不明显。

**Probability: Low**  
- 用户问题表达多样化
- MD5哈希对大小写、空格敏感

**Impact: Medium**  
- API调用量未减少
- 成本节省效果差
- 响应速度优化不明显

**Mitigation**:
- AC5已规范化查询（toLowerCase, trim）
- 考虑语义相似度缓存（Phase 2优化）
- 监控缓存命中率
- 调整TTL优化命中率

**Residual Risk**: Very Low - 有监控和调优手段

---

## Risk Distribution

### By Category

- **Technical (TECH)**: 4 risks (1 high, 3 medium)
- **Security (SEC)**: 2 risks (1 critical, 1 medium)
- **Performance (PERF)**: 4 risks (1 critical, 2 high, 1 medium)
- **Data (DATA)**: 3 risks (1 high, 2 medium)
- **Business (BUS)**: 2 risks (2 medium)
- **Operational (OPS)**: 3 risks (1 high, 2 medium)

### By Component

- **retrievalService.ts**: 6 risks
- **queryVectorizer.ts**: 4 risks
- **pgvector.repository.ts**: 4 risks
- **queryCacheService.ts**: 4 risks
- **API route.ts**: 3 risks
- **Infrastructure**: 4 risks

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Run)

**PERF-001: 检索质量验证**
- AC9人工质量评估：20个测试问题
- Top-5准确率目标 > 85%
- 覆盖4种问题类型（事实性、操作性、比较性、解释性）
- 测试不同文档类型（PDF、Word、Markdown）

**SEC-002: API密钥安全**
- 代码审查：检查硬编码密钥
- Git history扫描：`git log -S "OPENAI_API_KEY"`
- 日志内容审查：确认不含完整API请求
- Sentry配置审查：过滤敏感字段

**Test Data**: 
```typescript
// tests/fixtures/test-questions.json
[
  { type: "factual", question: "什么是React Hooks?" },
  { type: "operational", question: "如何使用useState?" },
  { type: "comparative", question: "useState和useReducer的区别?" },
  { type: "explanatory", question: "为什么需要useEffect?" }
]
```

---

### Priority 2: High Risk Tests

**PERF-002: pgvector性能测试**
- 负载测试：1K、10K、50K、100K向量规模
- 并发测试：1、10、50、100并发请求
- 延迟目标：< 200ms (P95)
- 持续测试：24小时稳定性

**TECH-001: LLM API故障测试**
- 模拟API超时（3秒）
- 模拟API 503错误
- 模拟API 429限流
- 验证重试机制
- 验证自动降级

**DATA-001: 缓存一致性测试**
- 文档删除 → 缓存失效验证
- 文档更新 → 缓存失效验证
- 并发场景：10个用户同时查询相同文档
- TTL到期验证

**OPS-001: Redis故障测试**
- Redis完全不可用场景
- Redis连接超时场景
- 验证降级到无缓存模式
- 验证错误日志不过量

---

### Priority 3: Medium/Low Risk Tests

**Standard Functional Tests**:
- 单元测试覆盖所有service和repository方法
- 集成测试覆盖完整API流程
- 错误处理测试（所有error.message分支）
- 边界条件测试（空查询、超长查询、特殊字符）

**Performance Regression Tests**:
- 基线性能记录（首次实现）
- 回归测试验证性能不退化
- 监控告警阈值验证

---

## Risk Acceptance Criteria

### Must Fix Before Production

- **PERF-001**: 人工质量评估 < 85% → 调优或延期
- **SEC-002**: 任何密钥泄露 → 立即修复和轮换
- **PERF-002**: P95延迟 > 1秒 → 优化或切换向量数据库
- **TECH-001**: 无自动降级 → 实现多提供商支持

### Can Deploy with Mitigation

- **DATA-001**: 缓存一致性问题 → TTL保底
- **OPS-001**: Redis故障 → 降级无缓存模式
- **PERF-003**: 并行优化未生效 → 记录技术债，后续优化
- **Medium risks**: 有缓解措施，可监控后处理

### Accepted Risks

- **TECH-002**: 维度不匹配 → 概率极低，有验证机制
- **DATA-002**: MD5冲突 → 概率极低，影响有限
- **Low risks**: 影响小，成本收益比不划算

**Sign-off Required For**:
- 部署前未完成PERF-001人工评估
- 缓存命中率 < 20%（严重低于目标）
- P95延迟 > 1秒

---

## Monitoring Requirements

### Real-Time Alerts

| Metric | Threshold | Action |
|--------|-----------|--------|
| 检索延迟 P95 | > 1秒 | 立即调查 |
| 检索错误率 | > 5% | 紧急排查 |
| LLM API调用失败率 | > 10% | 检查API状态 |
| 缓存命中率 | < 20% | 调查原因 |
| Redis连接失败 | > 10次/小时 | 检查Redis服务 |
| API配额使用量 | > 80% | 考虑限流或升级 |

### Daily Metrics

- 检索质量抽样：每天随机抽取10个查询人工评估
- Top-K相关性分数分布
- 缓存命中率趋势
- 各错误类型占比
- LLM API成本趋势

### Weekly Review

- 检索质量趋势分析
- 性能瓶颈识别
- 成本优化建议
- 风险复审（如有新风险）

---

## Risk Review Triggers

重新评估风险profile当：

1. **Architecture Changes**
   - 切换到Pinecone或其他向量数据库
   - 更换LLM提供商
   - 修改分块策略

2. **Scale Changes**
   - 向量数量超过50K
   - 日均查询量超过1000
   - 并发用户超过100

3. **Security Incidents**
   - API密钥泄露
   - 隐私投诉
   - 异常API调用

4. **Performance Issues**
   - P95延迟持续 > 500ms
   - 错误率持续 > 5%
   - 缓存命中率持续 < 20%

5. **Business Changes**
   - 用户增长超预期
   - 成本超预算20%
   - 产品策略调整

---

## Key Principles

- **Quality First**: 检索质量是RAG系统的基础，宁可延期也要确保 > 85%准确率
- **Fail Fast**: 外部依赖（LLM API、Redis）故障要快速降级，不阻塞用户
- **Cost Awareness**: 监控API调用量和成本，避免超支
- **Performance Monitoring**: 实时监控延迟，尽早发现性能退化
- **Security Paranoia**: API密钥、用户查询内容等敏感信息严格保护

---

**Risk Assessment Completed**: 2025-01-08  
**Next Review**: 当Story 3.2完成开发后，或发现新风险时  
**Reviewer**: Quinn (测试架构师)
