# Risk Profile: Story 2.4 - æ–‡æ¡£åˆ†å—ä¸å‘é‡åŒ–

**Date**: 2025-01-05  
**Reviewer**: Quinn (Test Architect)  
**Story**: 2.4 - Document Chunking and Vectorization  
**Epic**: 2 - æ–‡æ¡£ç®¡ç†ä¸è§£æ  

---

## Executive Summary

- **Total Risks Identified**: 14
- **Critical Risks (Score 9)**: 2
- **High Risks (Score 6)**: 4
- **Medium Risks (Score 4)**: 5
- **Low Risks (Score 2-3)**: 3
- **Overall Risk Score**: 51/100 (Medium-High Risk)

âš ï¸ **Key Concern**: æœ¬Storyæ¶‰åŠå¤–éƒ¨APIä¾èµ–ã€æ–°æŠ€æœ¯æ ˆï¼ˆpgvectorï¼‰ã€å¤æ‚çš„æ‰¹é‡å¤„ç†é€»è¾‘å’Œæˆæœ¬æ§åˆ¶ï¼Œå±äºä¸­é«˜é£é™©å®ç°ã€‚å»ºè®®åœ¨å¼€å‘é˜¶æ®µé‡ç‚¹å…³æ³¨APIé…é¢ç®¡ç†ã€å‘é‡ç´¢å¼•æ€§èƒ½å’Œé”™è¯¯æ¢å¤æœºåˆ¶ã€‚

---

## Critical Risks Requiring Immediate Attention

### 1. PERF-001: pgvectorç´¢å¼•é…ç½®ä¸å½“å¯¼è‡´æ€§èƒ½å´©æºƒ

**Score: 9 (Critical)**  
**Probability**: High (3) - é¦–æ¬¡ä½¿ç”¨pgvector,é…ç½®ç»éªŒä¸è¶³  
**Impact**: High (3) - ç´¢å¼•ä¸å½“å¯¼è‡´æŸ¥è¯¢è¶…æ—¶,ç³»ç»Ÿä¸å¯ç”¨

**è¯¦ç»†è¯´æ˜**:
- pgvectorçš„ivfflatç´¢å¼•éœ€è¦æ­£ç¡®çš„`lists`å‚æ•°é…ç½®
- é”™è¯¯çš„listså€¼ä¼šå¯¼è‡´:
  - å¤ªå°: æŸ¥è¯¢æ…¢,çº¿æ€§æ‰«æ
  - å¤ªå¤§: æ„å»ºç´¢å¼•æ…¢,å†…å­˜å ç”¨é«˜
- Storyæåˆ°`lists=100`ä½†æœªè¯´æ˜åŸºäºä»€ä¹ˆæ•°æ®é‡
- HNSWç´¢å¼•é€‰æ‹©éœ€è¦æƒè¡¡å†…å­˜å’ŒæŸ¥è¯¢é€Ÿåº¦

**å—å½±å“ç»„ä»¶**:
- `document_chunks`è¡¨çš„å‘é‡ç´¢å¼•
- å‘é‡æœç´¢APIæ€§èƒ½
- ç”¨æˆ·é—®ç­”å“åº”æ—¶é—´

**Mitigation**:
1. **Preventive (å¼€å‘é˜¶æ®µ)**:
   - æŒ‰ç…§pgvectoræ–‡æ¡£å»ºè®®: `lists = sqrt(total_rows)` æˆ– `rows/1000`
   - MVPé˜¶æ®µé¢„ä¼°10ä¸‡chunks: `lists = 316` æˆ– `100-200`
   - åœ¨æµ‹è¯•ç¯å¢ƒä½¿ç”¨å®é™…æ•°æ®é‡æµ‹è¯•ç´¢å¼•æ€§èƒ½
   - å‡†å¤‡ä¸¤å¥—é…ç½®: ivfflat(å†…å­˜å°) å’Œ hnsw(æŸ¥è¯¢å¿«)

2. **Detective (ç›‘æ§)**:
   - ç›‘æ§å‘é‡æœç´¢æŸ¥è¯¢æ—¶é—´(ç›®æ ‡<500ms)
   - ç›‘æ§ç´¢å¼•æ„å»ºæ—¶é—´
   - ç›‘æ§æ•°æ®åº“å†…å­˜ä½¿ç”¨

3. **Corrective (é—®é¢˜å“åº”)**:
   - å‡†å¤‡ç´¢å¼•é‡å»ºè„šæœ¬(`REINDEX INDEX document_chunks_embedding_idx`)
   - å‡†å¤‡å¿«é€Ÿåˆ‡æ¢ivfflatâ†”hnswçš„è¿ç§»è„šæœ¬
   - æ–‡æ¡£åŒ–ç´¢å¼•è°ƒä¼˜æ­¥éª¤

**Testing Requirements**:
- **Load Test**: ä½¿ç”¨10ä¸‡ã€50ä¸‡ã€100ä¸‡æ¡å‘é‡æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
- **Index Benchmark**: å¯¹æ¯”ä¸åŒlistså€¼çš„æŸ¥è¯¢æ—¶é—´
- **Memory Test**: éªŒè¯HNSWç´¢å¼•çš„å†…å­˜å ç”¨
- **Query Pattern Test**: æµ‹è¯•ä¸åŒtopKå€¼çš„æ€§èƒ½å½±å“

**Residual Risk**: Medium - å³ä½¿ä¼˜åŒ–å,å¤§è§„æ¨¡æ•°æ®å¯èƒ½éœ€è¦è¿ç§»åˆ°Pinecone

**Owner**: Dev + DBA  
**Timeline**: åœ¨Task 3å®Œæˆåç«‹å³è¿›è¡Œç´¢å¼•æ€§èƒ½æµ‹è¯•

---

### 2. BUS-001: OpenAI APIé…é¢è€—å°½å¯¼è‡´å‘é‡åŒ–ä¸­æ–­

**Score: 9 (Critical)**  
**Probability**: High (3) - å¤§é‡ç”¨æˆ·åŒæ—¶ä¸Šä¼ æ–‡æ¡£  
**Impact**: High (3) - ç”¨æˆ·æ–‡æ¡£å¡åœ¨EMBEDDINGçŠ¶æ€,ä¸šåŠ¡ä¸­æ–­

**è¯¦ç»†è¯´æ˜**:
- OpenAI APIæœ‰é€Ÿç‡é™åˆ¶(RPM, TPM)
- text-embedding-3-small: 
  - å…è´¹å±‚: 3 RPM
  - Tier 1: 500 RPM, 1M TPM/month
- æ‰¹é‡å¤„ç†20 chunks/batchæ„å‘³ç€:
  - 100ä¸ªæ–‡æ¡£åŒæ—¶ä¸Šä¼  = 500 chunks = 25 API calls
  - å¯èƒ½ç¬é—´è€—å°½é…é¢
- é…é¢è€—å°½å:
  - ç”¨æˆ·ä½“éªŒæå·®(æ–‡æ¡£å¡ä½)
  - éœ€è¦æ‰‹åŠ¨é‡è¯•
  - å¯èƒ½ä¸¢å¤±å¤„ç†è¿›åº¦

**å—å½±å“ç»„ä»¶**:
- `embeddingService.ts`
- `/api/documents/[id]/process`ç«¯ç‚¹
- æ‰€æœ‰ç”¨æˆ·çš„æ–‡æ¡£ä¸Šä¼ æµç¨‹

**Mitigation**:
1. **Preventive (å¼€å‘é˜¶æ®µ)**:
   - **å®ç°é‡è¯•æœºåˆ¶**: é‡åˆ°429é”™è¯¯(rate limit)æ—¶æŒ‡æ•°é€€é¿é‡è¯•
     ```typescript
     const MAX_RETRIES = 3
     const BACKOFF = [1000, 5000, 15000] // 1s, 5s, 15s
     
     for (let retry = 0; retry <= MAX_RETRIES; retry++) {
       try {
         return await llm.generateEmbeddings(texts)
       } catch (error) {
         if (error.status === 429 && retry < MAX_RETRIES) {
           await sleep(BACKOFF[retry])
           continue
         }
         throw error
       }
     }
     ```
   
   - **å®ç°é˜Ÿåˆ—æœºåˆ¶**: ä½¿ç”¨Vercel KVæˆ–Redisé˜Ÿåˆ—é™åˆ¶å¹¶å‘
     ```typescript
     // å…¨å±€å¹¶å‘é™åˆ¶
     const embeddingQueue = new PQueue({ concurrency: 3 })
     await embeddingQueue.add(() => llm.generateEmbeddings(texts))
     ```
   
   - **åˆ†é˜¶æ®µå¤„ç†**: ä¸è¦åœ¨ä¸Šä¼ æ—¶åŒæ­¥å¤„ç†,æ”¹ä¸ºåå°ä»»åŠ¡
   - **é…é¢ç›‘æ§**: æ£€æŸ¥OpenAI account usage,æ¥è¿‘é™åˆ¶æ—¶é™çº§æˆ–æš‚åœ

2. **Detective (ç›‘æ§)**:
   - ç›‘æ§OpenAI APIé”™è¯¯ç‡(429, 503)
   - ç›‘æ§æ¯æ—¥/æ¯å°æ—¶çš„embeddingè°ƒç”¨æ¬¡æ•°
   - è®¾ç½®å‘Šè­¦: 429é”™è¯¯ç‡>10%

3. **Corrective (é—®é¢˜å“åº”)**:
   - å‡†å¤‡é™çº§æ–¹æ¡ˆ: åˆ‡æ¢åˆ°æ™ºè°±AI embedding API
   - å‡†å¤‡æ‰¹é‡é‡è¯•è„šæœ¬: æ‰¾å‡ºæ‰€æœ‰EMBEDDINGå¤±è´¥çš„æ–‡æ¡£
   - ç”¨æˆ·é€šçŸ¥: æ˜¾ç¤º"å¤„ç†é˜Ÿåˆ—ä¸­,é¢„è®¡ç­‰å¾…Xåˆ†é’Ÿ"

**Testing Requirements**:
- **Stress Test**: æ¨¡æ‹Ÿ100ä¸ªç”¨æˆ·åŒæ—¶ä¸Šä¼ ,éªŒè¯é‡è¯•æœºåˆ¶
- **Rate Limit Test**: äººä¸ºè§¦å‘429é”™è¯¯,éªŒè¯é€€é¿é€»è¾‘
- **Queue Test**: éªŒè¯å¹¶å‘æ§åˆ¶æœ‰æ•ˆæ€§
- **Failover Test**: æµ‹è¯•OpenAIâ†’æ™ºè°±AIçš„åˆ‡æ¢

**Residual Risk**: Low - é‡è¯•æœºåˆ¶å¯è§£å†³å¤§éƒ¨åˆ†é—®é¢˜

**Owner**: Dev  
**Timeline**: Task 5å®Œæˆåç«‹å³å®ç°é‡è¯•å’Œé˜Ÿåˆ—æœºåˆ¶

---

## High Risks

### 3. TECH-001: LangChainåˆ†å—å™¨åˆ†å—è´¨é‡å·®å¯¼è‡´RAGå‡†ç¡®ç‡ä½

**Score: 6 (High)**  
**Probability**: Medium (2) - ä¸­è‹±æ–‡æ··åˆæ–‡æœ¬åˆ†å—æœ‰æŒ‘æˆ˜  
**Impact**: High (3) - åˆ†å—ä¸åˆç†ç›´æ¥å½±å“é—®ç­”è´¨é‡

**è¯¦ç»†è¯´æ˜**:
- RecursiveCharacterTextSplitterçš„åˆ†éš”ç¬¦é¡ºåºéœ€è¦é’ˆå¯¹ä¸­æ–‡ä¼˜åŒ–
- Storyå®šä¹‰çš„separators: `['\n\n', '\n', '. ', 'ã€‚', ' ', '']`
- å¯èƒ½çš„é—®é¢˜:
  - ä¸­æ–‡æ²¡æœ‰ç©ºæ ¼,å¯èƒ½åœ¨å¥å­ä¸­é—´æˆªæ–­
  - PDFè§£æåçš„æ®µè½ç»“æ„å¯èƒ½ä¸æ¸…æ™°
  - è¡¨æ ¼ã€åˆ—è¡¨ç­‰ç‰¹æ®Šæ ¼å¼åˆ†å—æ•ˆæœå·®
- chunkSize=1000å¯èƒ½å¯¹ä¸­æ–‡è¿‡å¤§(ä¸­æ–‡å­—ç¬¦å¯†åº¦é«˜)

**å—å½±å“ç»„ä»¶**:
- `chunkingService.ts`
- RAGé—®ç­”å‡†ç¡®ç‡(Epic 3)

**Mitigation**:
1. **Preventive**:
   - è°ƒæ•´ä¸­æ–‡ä¼˜åŒ–çš„separators:
     ```typescript
     separators: [
       '\n\n',     // æ®µè½
       '\n',       // æ¢è¡Œ
       'ã€‚',       // ä¸­æ–‡å¥å·
       'ï¼',       // ä¸­æ–‡æ„Ÿå¹å·
       'ï¼Ÿ',       // ä¸­æ–‡é—®å·
       '. ',       // è‹±æ–‡å¥å·
       '! ',       // è‹±æ–‡æ„Ÿå¹å·
       '? ',       // è‹±æ–‡é—®å·
       'ï¼›',       // ä¸­æ–‡åˆ†å·
       '; ',       // è‹±æ–‡åˆ†å·
       'ï¼Œ',       // ä¸­æ–‡é€—å·
       ', ',       // è‹±æ–‡é€—å·
       ' ',        // ç©ºæ ¼
       ''          // å­—ç¬¦
     ]
     ```
   
   - æ ¹æ®æ–‡æ¡£ç±»å‹è°ƒæ•´chunkSize:
     - ä¸­æ–‡æ–‡æ¡£: 800 tokens
     - è‹±æ–‡æ–‡æ¡£: 1000 tokens
     - æ··åˆæ–‡æ¡£: 900 tokens
   
   - å®ç°åˆ†å—è´¨é‡éªŒè¯:
     ```typescript
     function validateChunk(chunk: string): boolean {
       // æ£€æŸ¥æ˜¯å¦åœ¨å¥å­ä¸­é—´æˆªæ–­
       const endsWithPunctuation = /[ã€‚ï¼ï¼Ÿ.!?]$/.test(chunk.trim())
       const notTooShort = chunk.length >= 50
       return endsWithPunctuation && notTooShort
     }
     ```

2. **Detective**:
   - å®ç°åˆ†å—è´¨é‡åº¦é‡:
     - å¹³å‡chunké•¿åº¦
     - chunkå®Œæ•´æ€§è¯„åˆ†(æ˜¯å¦ä»¥æ ‡ç‚¹ç»“å°¾)
     - overlapè¦†ç›–ç‡
   - åœ¨æµ‹è¯•ä¸­ä½¿ç”¨çœŸå®æ–‡æ¡£éªŒè¯åˆ†å—æ•ˆæœ

3. **Corrective**:
   - å‡†å¤‡åˆ†å—å‚æ•°è°ƒæ•´æ¥å£
   - æ”¯æŒé‡æ–°åˆ†å—(æ¸…ç†æ—§chunksåé‡æ–°å¤„ç†)

**Testing Requirements**:
- **Chinese Text Test**: ä½¿ç”¨å„ç§ä¸­æ–‡æ–‡æ¡£æµ‹è¯•åˆ†å—è´¨é‡
- **English Text Test**: éªŒè¯è‹±æ–‡æ–‡æ¡£åˆ†å—
- **Mixed Text Test**: ä¸­è‹±æ–‡æ··åˆæ–‡æ¡£
- **Special Format Test**: è¡¨æ ¼ã€åˆ—è¡¨ã€ä»£ç å—çš„åˆ†å—æ•ˆæœ
- **Chunk Validation Test**: éªŒè¯åˆ†å—å®Œæ•´æ€§æ£€æŸ¥é€»è¾‘

**Residual Risk**: Medium - éœ€è¦æŒç»­è°ƒä¼˜

**Owner**: Dev  
**Timeline**: Task 4å®ç°æ—¶é‡ç‚¹æµ‹è¯•

---

### 4. DATA-001: æ‰¹é‡å¤„ç†å¤±è´¥å¯¼è‡´éƒ¨åˆ†chunkså‘é‡åŒ–ä¸å®Œæ•´

**Score: 6 (High)**  
**Probability**: Medium (2) - ç½‘ç»œæ³¢åŠ¨æˆ–APIä¸´æ—¶æ•…éšœ  
**Impact**: High (3) - æ–‡æ¡£æ•°æ®ä¸ä¸€è‡´,é—®ç­”å¯èƒ½é—æ¼ä¿¡æ¯

**è¯¦ç»†è¯´æ˜**:
- æ‰¹é‡å¤„ç†20 chunks/batch,å¦‚æœæŸæ‰¹å¤±è´¥:
  - å·²å¤„ç†çš„æ‰¹æ¬¡æˆåŠŸ
  - å¤±è´¥çš„æ‰¹æ¬¡chunksæ²¡æœ‰å‘é‡
  - æ–‡æ¡£çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´(éƒ¨åˆ†READY,éƒ¨åˆ†æœªå‘é‡åŒ–)
- Storyæåˆ°"æˆåŠŸçš„æ‰¹æ¬¡ä¸å—å¤±è´¥æ‰¹æ¬¡å½±å“",ä½†æ²¡æœ‰æ˜ç¡®:
  - å¦‚ä½•æ ‡è®°éƒ¨åˆ†å¤±è´¥çš„æ–‡æ¡£
  - å¦‚ä½•é‡è¯•å¤±è´¥çš„æ‰¹æ¬¡
  - ç”¨æˆ·æ˜¯å¦çŸ¥é“æ–‡æ¡£ä¸å®Œæ•´

**å—å½±å“ç»„ä»¶**:
- `embeddingService.ts`
- `document_chunks`è¡¨çš„æ•°æ®å®Œæ•´æ€§
- RAGæ£€ç´¢ç»“æœ

**Mitigation**:
1. **Preventive**:
   - **è®°å½•æ‰¹æ¬¡å¤„ç†çŠ¶æ€**:
     ```typescript
     // åœ¨documents.metadataä¸­è®°å½•
     metadata: {
       embedding: {
         totalChunks: 100,
         successfulChunks: 80,
         failedChunks: 20,
         failedBatches: [4, 5], // å¤±è´¥çš„æ‰¹æ¬¡ç´¢å¼•
         lastRetry: '2025-01-05T...'
       }
     }
     ```
   
   - **å®ç°éƒ¨åˆ†å¤±è´¥çŠ¶æ€**:
     ```typescript
     if (failedChunks.length > 0 && failedChunks.length < chunks.length) {
       // éƒ¨åˆ†æˆåŠŸ
       status = 'PARTIAL_READY' // æ–°å¢çŠ¶æ€
     }
     ```
   
   - **å®ç°æ‰¹æ¬¡é‡è¯•**:
     ```typescript
     async function retryFailedBatches(documentId: string) {
       const doc = await getDocument(documentId)
       const failedBatches = doc.metadata.embedding.failedBatches
       
       for (const batchIndex of failedBatches) {
         const start = batchIndex * BATCH_SIZE
         const end = start + BATCH_SIZE
         const batch = chunks.slice(start, end)
         await processBatch(batch)
       }
     }
     ```

2. **Detective**:
   - ç›‘æ§éƒ¨åˆ†å¤±è´¥çš„æ–‡æ¡£æ•°é‡
   - æ¯æ—¥æ£€æŸ¥æ˜¯å¦æœ‰PARTIAL_READYçŠ¶æ€çš„æ–‡æ¡£
   - ç›‘æ§æ‰¹æ¬¡å¤±è´¥ç‡

3. **Corrective**:
   - æä¾›ç®¡ç†ç•Œé¢æ˜¾ç¤ºéƒ¨åˆ†å¤±è´¥çš„æ–‡æ¡£
   - æä¾›æ‰¹é‡é‡è¯•æŒ‰é’®
   - è‡ªåŠ¨é‡è¯•æœºåˆ¶(æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡)

**Testing Requirements**:
- **Partial Failure Test**: æ¨¡æ‹ŸæŸæ‰¹æ¬¡å¤±è´¥,éªŒè¯çŠ¶æ€è®°å½•
- **Retry Test**: éªŒè¯é‡è¯•æœºåˆ¶èƒ½æˆåŠŸå¤„ç†å¤±è´¥æ‰¹æ¬¡
- **Data Integrity Test**: éªŒè¯embeddingIdæ­£ç¡®å¡«å……
- **Consistency Test**: éªŒè¯documentsè¡¨å’Œdocument_chunksè¡¨çš„ä¸€è‡´æ€§

**Residual Risk**: Low - é‡è¯•æœºåˆ¶å¯è§£å†³

**Owner**: Dev  
**Timeline**: Task 5å®ç°æ—¶å¿…é¡»åŒ…å«

---

### 5. PERF-002: å¤§æ–‡æ¡£å‘é‡åŒ–è¶…æ—¶å¯¼è‡´Vercelå‡½æ•°è¶…æ—¶

**Score: 6 (High)**  
**Probability**: High (3) - 100KBæ–‡æ¡£=100 chunks=5æ‰¹æ¬¡,æ¥è¿‘é™åˆ¶  
**Impact**: Medium (2) - ç”¨æˆ·éœ€è¦é‡è¯•,ä½“éªŒå·®

**è¯¦ç»†è¯´æ˜**:
- Vercel Serverlesså‡½æ•°maxDuration=300ç§’(5åˆ†é’Ÿ)
- Storyè¦æ±‚: 100KBæ–‡æ¡£(~100 chunks)åœ¨60ç§’å†…å®Œæˆ
- å®é™…å¯èƒ½çš„æ—¶é—´:
  - åˆ†å—: 5ç§’
  - å‘é‡åŒ–: 5æ‰¹ Ã— 3ç§’ = 15ç§’
  - æ•°æ®åº“æ’å…¥: 5ç§’
  - æ€»è®¡: ~25ç§’(ç†æƒ³æƒ…å†µ)
- å¦‚æœ:
  - OpenAI APIæ…¢(ç½‘ç»œå»¶è¿Ÿ)
  - æ•°æ®åº“æ…¢(pgvectoræ’å…¥æ€§èƒ½)
  - å¹¶å‘ç«äº‰(å…¶ä»–è¯·æ±‚å ç”¨èµ„æº)
- å¯èƒ½è¶…è¿‡60ç§’ç”šè‡³300ç§’

**å—å½±å“ç»„ä»¶**:
- `/api/documents/[id]/process`ç«¯ç‚¹
- å¤§æ–‡æ¡£å¤„ç†

**Mitigation**:
1. **Preventive**:
   - **å®ç°è¶…æ—¶é¢„è­¦**:
     ```typescript
     const startTime = Date.now()
     const TIMEOUT_WARNING = 240000 // 4åˆ†é’Ÿ
     
     if (Date.now() - startTime > TIMEOUT_WARNING) {
       console.warn('Approaching timeout, saving progress...')
       await saveProgress(documentId, processedBatches)
       throw new Error('Timeout approaching, partial progress saved')
     }
     ```
   
   - **å®ç°æ–­ç‚¹ç»­ä¼ **:
     - è®°å½•å·²å¤„ç†çš„æ‰¹æ¬¡ç´¢å¼•
     - ä¸‹æ¬¡é‡è¯•æ—¶è·³è¿‡å·²æˆåŠŸçš„æ‰¹æ¬¡
   
   - **æ‹†åˆ†å¤§æ–‡æ¡£å¤„ç†**:
     ```typescript
     if (chunks.length > 200) {
       // è¶…å¤§æ–‡æ¡£,åˆ†å¤šæ¬¡APIè°ƒç”¨å¤„ç†
       return { needsContinuation: true, nextBatch: 0 }
     }
     ```

2. **Detective**:
   - ç›‘æ§APIå“åº”æ—¶é—´åˆ†å¸ƒ
   - ç›‘æ§è¶…æ—¶é”™è¯¯ç‡
   - ç›‘æ§æ‰¹æ¬¡å¤„ç†æ—¶é—´

3. **Corrective**:
   - æä¾›æ‰‹åŠ¨ç»­ä¼ æ¥å£: `POST /api/documents/[id]/continue`
   - å‰ç«¯æ˜¾ç¤ºå¤„ç†è¿›åº¦(å·²å®ŒæˆX/Yæ‰¹æ¬¡)

**Testing Requirements**:
- **Large Document Test**: æµ‹è¯•500KBæ–‡æ¡£å¤„ç†
- **Timeout Test**: æ¨¡æ‹Ÿæ…¢API,éªŒè¯è¶…æ—¶å¤„ç†
- **Resume Test**: éªŒè¯æ–­ç‚¹ç»­ä¼ åŠŸèƒ½
- **Concurrent Test**: å¤šä¸ªå¤§æ–‡æ¡£åŒæ—¶å¤„ç†

**Residual Risk**: Medium - è¶…å¤§æ–‡æ¡£ä»éœ€ä¼˜åŒ–

**Owner**: Dev  
**Timeline**: Task 5å®Œæˆåæµ‹è¯•

---

### 6. TECH-002: é€šç”¨å‘é‡æ¥å£æŠ½è±¡å±‚æ€§èƒ½å¼€é”€

**Score: 6 (High)**  
**Probability**: Medium (2) - Repositoryæ¨¡å¼å¢åŠ äº†æŠ½è±¡å±‚  
**Impact**: High (3) - å¦‚æœå¼€é”€å¤§,å½±å“æ‰€æœ‰å‘é‡æ“ä½œ

**è¯¦ç»†è¯´æ˜**:
- Storyä½¿ç”¨Repositoryæ¨¡å¼+å·¥å‚æ¨¡å¼å°è£…å‘é‡æ“ä½œ
- ä¼˜ç‚¹: çµæ´»åˆ‡æ¢pgvectorâ†”Pinecone
- é£é™©: 
  - æ¯æ¬¡å‘é‡æ“ä½œéƒ½è¦é€šè¿‡å·¥å‚åˆ›å»ºRepositoryå®ä¾‹
  - æ¥å£å±‚çš„ç±»å‹è½¬æ¢å¼€é”€
  - æ‰¹é‡æ“ä½œæ—¶çš„åºåˆ—åŒ–/ååºåˆ—åŒ–å¼€é”€
- å¦‚æœæ€§èƒ½å¼€é”€>10%,å¯èƒ½å½±å“:
  - å‘é‡åŒ–é€Ÿåº¦
  - å‘é‡æœç´¢é€Ÿåº¦(Epic 3)

**å—å½±å“ç»„ä»¶**:
- `VectorRepositoryFactory`
- æ‰€æœ‰å‘é‡æ“ä½œæ€§èƒ½

**Mitigation**:
1. **Preventive**:
   - **Repositoryå®ä¾‹å¤ç”¨**:
     ```typescript
     // ä½¿ç”¨å•ä¾‹æ¨¡å¼
     let cachedRepo: IVectorRepository | null = null
     
     export class VectorRepositoryFactory {
       static create(config: VectorConfig): IVectorRepository {
         if (!cachedRepo) {
           cachedRepo = new PgVectorRepository()
         }
         return cachedRepo
       }
     }
     ```
   
   - **æ‰¹é‡æ“ä½œä¼˜åŒ–**: é¿å…åœ¨å¾ªç¯ä¸­è°ƒç”¨å•ä¸ªupsert
   
   - **ç±»å‹è½¬æ¢ä¼˜åŒ–**: ä½¿ç”¨ç›´æ¥ç±»å‹æ˜ å°„è€ŒéJSONåºåˆ—åŒ–

2. **Detective**:
   - å¯¹æ¯”ç›´æ¥è°ƒç”¨pgvector vs é€šè¿‡Repositoryçš„æ€§èƒ½å·®å¼‚
   - ç›‘æ§Repositoryå±‚çš„æ‰§è¡Œæ—¶é—´

3. **Corrective**:
   - å¦‚æœå¼€é”€>10%,è€ƒè™‘å†…è”å…³é”®è·¯å¾„ä»£ç 
   - ä½¿ç”¨Benchmarkå·¥å…·(å¦‚autocannon)æµ‹è¯•

**Testing Requirements**:
- **Performance Benchmark**: 
  - 1000æ¬¡upsert: ç›´æ¥è°ƒç”¨ vs Repository
  - 1000æ¬¡search: ç›´æ¥è°ƒç”¨ vs Repository
- **Memory Test**: éªŒè¯å®ä¾‹å¤ç”¨å‡å°‘å†…å­˜åˆ†é…

**Residual Risk**: Low - ä¼˜åŒ–åå¼€é”€å¯æ§

**Owner**: Dev + Architect  
**Timeline**: Task 2å®Œæˆåbenchmark

---

## Medium Risks

### 7. OPS-001: pgvectoræ‰©å±•å®‰è£…å¤±è´¥å¯¼è‡´éƒ¨ç½²é˜»å¡

**Score: 4 (Medium)**  
**Probability**: Medium (2) - Supabaseé»˜è®¤æ”¯æŒ,ä½†è‡ªå»ºPGå¯èƒ½æ²¡æœ‰  
**Impact**: Medium (2) - éƒ¨ç½²æµç¨‹ä¸­æ–­,éœ€è¦DBAä»‹å…¥

**è¯¦ç»†è¯´æ˜**:
- pgvectoréœ€è¦PostgreSQL 11+
- Supabaseé»˜è®¤å·²å®‰è£…pgvectoræ‰©å±•
- ä½†å¦‚æœ:
  - å¼€å‘è€…æœ¬åœ°PostgreSQLæ²¡æœ‰pgvector
  - æµ‹è¯•ç¯å¢ƒç”¨çš„ä¸æ˜¯Supabase
  - å°†æ¥åˆ‡æ¢æ•°æ®åº“æä¾›å•†
- è¿ç§»è„šæœ¬`CREATE EXTENSION vector`ä¼šå¤±è´¥

**Mitigation**:
- åœ¨READMEä¸­æ˜ç¡®ä¾èµ–: PostgreSQL with pgvector extension
- æä¾›æœ¬åœ°å¼€å‘ç¯å¢ƒè®¾ç½®æŒ‡å—
- æä¾›pgvectorå®‰è£…è„šæœ¬(Dockeræˆ–native)
- è¿ç§»è„šæœ¬åŠ å®¹é”™: `CREATE EXTENSION IF NOT EXISTS vector`

**Testing Requirements**:
- åœ¨å¹²å‡€çš„PostgreSQLå®ä¾‹ä¸Šè¿è¡Œè¿ç§»è„šæœ¬

**Owner**: DevOps  
**Timeline**: Task 3å‰å‡†å¤‡å¥½ç¯å¢ƒ

---

### 8. DATA-002: pgvectorå‘é‡æ•°æ®æ— å¤‡ä»½ç­–ç•¥

**Score: 4 (Medium)**  
**Probability**: Low (1) - Supabaseæœ‰è‡ªåŠ¨å¤‡ä»½  
**Impact**: High (3) - å‘é‡ä¸¢å¤±éœ€è¦é‡æ–°ç”Ÿæˆ(é«˜æˆæœ¬)

**è¯¦ç»†è¯´æ˜**:
- å‘é‡æ•°æ®å­˜å‚¨åœ¨document_chunks.embeddingåˆ—
- å¦‚æœå‘é‡æ•°æ®ä¸¢å¤±:
  - éœ€è¦é‡æ–°è°ƒç”¨OpenAI APIç”Ÿæˆ(æˆæœ¬)
  - ç”¨æˆ·é—®ç­”åŠŸèƒ½ä¸­æ–­
- Supabaseæœ‰è‡ªåŠ¨å¤‡ä»½,ä½†éœ€è¦éªŒè¯:
  - å¤‡ä»½æ˜¯å¦åŒ…å«vectoråˆ—
  - æ¢å¤æµç¨‹æ˜¯å¦æµ‹è¯•è¿‡

**Mitigation**:
- éªŒè¯Supabaseå¤‡ä»½åŒ…å«pgvectoræ•°æ®
- åˆ¶å®šç¾éš¾æ¢å¤è®¡åˆ’(é‡æ–°å‘é‡åŒ–æµç¨‹)
- è€ƒè™‘å®šæœŸå¯¼å‡ºå‘é‡æ•°æ®åˆ°å¯¹è±¡å­˜å‚¨

**Testing Requirements**:
- å¤‡ä»½æ¢å¤æ¼”ç»ƒ

**Owner**: DevOps + Dev  
**Timeline**: ä¸Šçº¿å‰å®Œæˆ

---

### 9. TECH-003: LangChainç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜

**Score: 4 (Medium)**  
**Probability**: Medium (2) - LangChainè¿­ä»£å¿«,APIå˜åŒ–é¢‘ç¹  
**Impact**: Medium (2) - éœ€è¦é‡æ„åˆ†å—ä»£ç 

**è¯¦ç»†è¯´æ˜**:
- Storyä½¿ç”¨`@langchain/textsplitters`åŒ…
- LangChainç”Ÿæ€æ›´æ–°å¿«,breaking changeså¸¸è§
- å¯èƒ½å½±å“:
  - RecursiveCharacterTextSplitter APIå˜åŒ–
  - åˆ†å—å‚æ•°å«ä¹‰å˜åŒ–
  - ä¾èµ–å†²çª

**Mitigation**:
- é”å®šLangChainç‰ˆæœ¬(package.json)
- è®¢é˜…LangChain changelog
- å‡çº§å‰å……åˆ†æµ‹è¯•
- è€ƒè™‘è‡ªè¡Œå®ç°ç®€å•åˆ†å—å™¨(é™ä½ä¾èµ–)

**Testing Requirements**:
- ç‰ˆæœ¬å‡çº§å‰çš„å›å½’æµ‹è¯•

**Owner**: Dev  
**Timeline**: æŒç»­å…³æ³¨

---

### 10. PERF-003: æ‰¹é‡æ•°æ®åº“æ’å…¥æ€§èƒ½ç“¶é¢ˆ

**Score: 4 (Medium)**  
**Probability**: Medium (2) - å¤§æ‰¹é‡æ’å…¥å¯èƒ½æ…¢  
**Impact**: Medium (2) - å½±å“å¤„ç†é€Ÿåº¦

**è¯¦ç»†è¯´æ˜**:
- Storyè¦æ±‚: 1000 chunks < 5ç§’æ’å…¥
- Drizzle ORMæ‰¹é‡æ’å…¥æ€§èƒ½:
  - 1000è¡Œå‘é‡æ•°æ®(1536ç»´)
  - å¯èƒ½è§¦å‘ç´¢å¼•é‡å»º
  - å¯èƒ½å¯¼è‡´é”ç­‰å¾…

**Mitigation**:
- ä½¿ç”¨Drizzleçš„æ‰¹é‡æ’å…¥API
- è€ƒè™‘åˆ†æ‰¹æ’å…¥(æ¯æ‰¹200æ¡)
- ä¸´æ—¶ç¦ç”¨ç´¢å¼•â†’æ’å…¥â†’é‡å»ºç´¢å¼•(å¤§æ‰¹é‡)

**Testing Requirements**:
- æ‰¹é‡æ’å…¥æ€§èƒ½æµ‹è¯•(1000, 5000, 10000æ¡)

**Owner**: Dev  
**Timeline**: Task 5æ€§èƒ½æµ‹è¯•

---

### 11. BUS-002: OpenAI APIæˆæœ¬è¶…é¢„ç®—

**Score: 4 (Medium)**  
**Probability**: Medium (2) - ç”¨æˆ·ä¸Šä¼ é‡éš¾é¢„æµ‹  
**Impact**: Medium (2) - è¿è¥æˆæœ¬è¶…æ ‡

**è¯¦ç»†è¯´æ˜**:
- text-embedding-3-small: $0.02/1M tokens
- é¢„ä¼°MVP: 1000æ–‡æ¡£ Ã— 100 chunks Ã— 500 tokens = 50M tokens = $1
- å¦‚æœç”¨æˆ·ä¸Šä¼ é‡è¶…é¢„æœŸ:
  - 1ä¸‡æ–‡æ¡£ = $10/æœˆ âœ“
  - 10ä¸‡æ–‡æ¡£ = $100/æœˆ âš ï¸
  - 100ä¸‡æ–‡æ¡£ = $1000/æœˆ âŒ

**Mitigation**:
- å®æ–½é…é¢é™åˆ¶(æ¯ç”¨æˆ·æ¯æœˆæœ€å¤šXä¸ªæ–‡æ¡£)
- ç›‘æ§æ¯æ—¥APIæˆæœ¬
- å®ç°æˆæœ¬å‘Šè­¦(æ¯æ—¥>$10è§¦å‘)
- è€ƒè™‘ç¼“å­˜é‡å¤å†…å®¹çš„å‘é‡

**Testing Requirements**:
- æˆæœ¬ç›‘æ§é›†æˆæµ‹è¯•

**Owner**: PM + Dev  
**Timeline**: ä¸Šçº¿å‰è®¾ç½®ç›‘æ§

---

## Low Risks

### 12. OPS-002: å‘é‡ç»´åº¦å˜æ›´éœ€è¦æ•°æ®è¿ç§»

**Score: 3 (Low)**  
**Probability**: Low (1) - text-embedding-3-smallå›ºå®š1536ç»´  
**Impact**: High (3) - éœ€è¦é‡æ–°å‘é‡åŒ–æ‰€æœ‰æ–‡æ¡£

**è¯¦ç»†è¯´æ˜**:
- å¦‚æœå°†æ¥åˆ‡æ¢embeddingæ¨¡å‹(ä¸åŒç»´åº¦)
- éœ€è¦:
  - ä¿®æ”¹vector(1536)åˆ—å®šä¹‰
  - é‡æ–°ç”Ÿæˆæ‰€æœ‰å‘é‡
  - å¯èƒ½éœ€è¦åœæœº

**Mitigation**:
- è®¾è®¡æ—¶é¢„ç•™ç»´åº¦é…ç½®
- æ–‡æ¡£åŒ–è¿ç§»æµç¨‹
- è€ƒè™‘æ”¯æŒå¤šç»´åº¦å…±å­˜

**Residual Risk**: Low - MVPé˜¶æ®µä¸å¤ªå¯èƒ½å˜æ›´

**Owner**: Architect  
**Timeline**: Phase 2è€ƒè™‘

---

### 13. TECH-004: ä¸­æ–‡åˆ†è¯ä¾èµ–ç¼ºå¤±

**Score: 2 (Low)**  
**Probability**: Low (1) - RecursiveCharacterTextSplitterå†…ç½®æ”¯æŒ  
**Impact**: Medium (2) - ä¸­æ–‡åˆ†å—è´¨é‡å¯èƒ½ä¸ä½³

**è¯¦ç»†è¯´æ˜**:
- ä¸­æ–‡æ²¡æœ‰æ˜æ˜¾çš„è¯è¾¹ç•Œ
- å¯èƒ½éœ€è¦jiebaç­‰åˆ†è¯åº“
- RecursiveCharacterTextSplitteræŒ‰å­—ç¬¦åˆ†å‰²å¯èƒ½æ•ˆæœæ¬ ä½³

**Mitigation**:
- å…ˆç”¨RecursiveCharacterTextSplitteræµ‹è¯•æ•ˆæœ
- å¦‚æœæ•ˆæœä¸ä½³,è€ƒè™‘é›†æˆjieba

**Residual Risk**: Low - MVPå¯æ¥å—

**Owner**: Dev  
**Timeline**: æ ¹æ®æµ‹è¯•ç»“æœå†³å®š

---

### 14. OPS-003: ç¼ºå°‘å‘é‡åŒ–é˜Ÿåˆ—ç›‘æ§

**Score: 2 (Low)**  
**Probability**: Low (1) - å®ç°äº†åŸºç¡€é”™è¯¯å¤„ç†  
**Impact**: Medium (2) - éš¾ä»¥å‘ç°æ€§èƒ½ç“¶é¢ˆ

**è¯¦ç»†è¯´æ˜**:
- æ²¡æœ‰é˜Ÿåˆ—å¯è§†åŒ–
- ä¸çŸ¥é“å½“å‰æœ‰å¤šå°‘æ–‡æ¡£åœ¨å¤„ç†
- éš¾ä»¥è°ƒä¼˜æ‰¹å¤„ç†å‚æ•°

**Mitigation**:
- æ·»åŠ ç›‘æ§æŒ‡æ ‡:
  - é˜Ÿåˆ—é•¿åº¦
  - å¹³å‡å¤„ç†æ—¶é—´
  - å¤±è´¥ç‡
- è€ƒè™‘ä½¿ç”¨Vercel Analytics

**Residual Risk**: Low - ä¸å½±å“åŠŸèƒ½

**Owner**: DevOps  
**Timeline**: Phase 2æ”¹è¿›

---

## Risk Distribution

### By Category

| Category | Total | Critical | High | Medium | Low |
|----------|-------|----------|------|--------|-----|
| æŠ€æœ¯é£é™© (TECH) | 4 | 0 | 2 | 2 | 0 |
| æ€§èƒ½é£é™© (PERF) | 3 | 1 | 1 | 1 | 0 |
| ä¸šåŠ¡é£é™© (BUS) | 2 | 1 | 0 | 1 | 0 |
| æ•°æ®é£é™© (DATA) | 2 | 0 | 1 | 1 | 0 |
| è¿ç»´é£é™© (OPS) | 3 | 0 | 0 | 1 | 2 |
| **æ€»è®¡** | **14** | **2** | **4** | **5** | **3** |

### By Component

| Component | Risks | Critical | High |
|-----------|-------|----------|------|
| embeddingService.ts | 5 | 1 | 2 |
| pgvectorç´¢å¼• | 3 | 1 | 0 |
| chunkingService.ts | 2 | 0 | 1 |
| VectorRepository | 2 | 0 | 1 |
| APIç«¯ç‚¹ | 2 | 0 | 1 |

---

## Detailed Risk Register

| Risk ID | Category | Description | Probability | Impact | Score | Priority | Owner |
|---------|----------|-------------|-------------|--------|-------|----------|-------|
| **PERF-001** | Performance | pgvectorç´¢å¼•é…ç½®ä¸å½“ | High (3) | High (3) | **9** | Critical | Dev+DBA |
| **BUS-001** | Business | OpenAI APIé…é¢è€—å°½ | High (3) | High (3) | **9** | Critical | Dev |
| **TECH-001** | Technical | åˆ†å—è´¨é‡å·®å½±å“RAG | Medium (2) | High (3) | **6** | High | Dev |
| **DATA-001** | Data | æ‰¹é‡å¤±è´¥æ•°æ®ä¸å®Œæ•´ | Medium (2) | High (3) | **6** | High | Dev |
| **PERF-002** | Performance | å¤§æ–‡æ¡£å¤„ç†è¶…æ—¶ | High (3) | Medium (2) | **6** | High | Dev |
| **TECH-002** | Technical | Repositoryæ€§èƒ½å¼€é”€ | Medium (2) | High (3) | **6** | High | Dev |
| OPS-001 | Operational | pgvectorå®‰è£…å¤±è´¥ | Medium (2) | Medium (2) | 4 | Medium | DevOps |
| DATA-002 | Data | å‘é‡æ•°æ®æ— å¤‡ä»½ | Low (1) | High (3) | 4 | Medium | DevOps |
| TECH-003 | Technical | LangChainå…¼å®¹æ€§ | Medium (2) | Medium (2) | 4 | Medium | Dev |
| PERF-003 | Performance | æ‰¹é‡æ’å…¥æ€§èƒ½ | Medium (2) | Medium (2) | 4 | Medium | Dev |
| BUS-002 | Business | APIæˆæœ¬è¶…é¢„ç®— | Medium (2) | Medium (2) | 4 | Medium | PM+Dev |
| OPS-002 | Operational | å‘é‡ç»´åº¦å˜æ›´ | Low (1) | High (3) | 3 | Low | Architect |
| TECH-004 | Technical | ä¸­æ–‡åˆ†è¯ä¾èµ– | Low (1) | Medium (2) | 2 | Low | Dev |
| OPS-003 | Operational | ç¼ºå°‘é˜Ÿåˆ—ç›‘æ§ | Low (1) | Medium (2) | 2 | Low | DevOps |

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Test Before Release)

**PERF-001 - pgvectorç´¢å¼•æ€§èƒ½**:
```yaml
tests:
  - name: "Vector Index Performance Benchmark"
    type: performance
    scenarios:
      - 10K vectors: search time < 100ms
      - 100K vectors: search time < 500ms
      - 1M vectors: search time < 1000ms
    variations:
      - ivfflat with lists=100
      - ivfflat with lists=316
      - hnsw (if memory allows)
  
  - name: "Index Build Performance"
    type: performance
    scenarios:
      - 10K vectors: build time < 10s
      - 100K vectors: build time < 60s
  
  - name: "Concurrent Search Load"
    type: load
    scenarios:
      - 100 concurrent users
      - Each searching 5 times
      - p95 latency < 1000ms
```

**BUS-001 - APIé…é¢ç®¡ç†**:
```yaml
tests:
  - name: "Rate Limit Retry Mechanism"
    type: integration
    scenarios:
      - Mock OpenAI 429 error
      - Verify exponential backoff
      - Verify max 3 retries
      - Verify error logging
  
  - name: "Concurrent Request Queue"
    type: load
    scenarios:
      - 100 documents upload simultaneously
      - Max 3 concurrent OpenAI calls
      - All documents eventually complete
  
  - name: "Quota Exhaustion Handling"
    type: chaos
    scenarios:
      - Exhaust OpenAI quota
      - Verify graceful degradation
      - Verify user notification
```

### Priority 2: High Risk Tests

**TECH-001 - åˆ†å—è´¨é‡**:
```yaml
tests:
  - name: "Chinese Text Chunking Quality"
    type: unit
    fixtures:
      - pure_chinese.txt (10KB)
      - mixed_chinese_english.txt (10KB)
      - chinese_with_tables.txt (20KB)
    assertions:
      - Chunks end with punctuation: >80%
      - Average chunk length: 800-1200 chars
      - No chunks split in middle of sentence
  
  - name: "Chunk Overlap Validation"
    type: unit
    assertions:
      - Adjacent chunks overlap by 200 tokens
      - No information loss at boundaries
```

**DATA-001 - æ‰¹é‡å¤„ç†é”™è¯¯æ¢å¤**:
```yaml
tests:
  - name: "Partial Batch Failure Recovery"
    type: integration
    scenarios:
      - Process 100 chunks in 5 batches
      - Fail batch 3 and 4
      - Verify batches 1,2,5 succeed
      - Verify failed batches recorded
  
  - name: "Batch Retry Mechanism"
    type: integration
    scenarios:
      - Retry failed batches only
      - Verify no duplicate processing
      - Verify final state consistency
```

### Priority 3: Medium/Low Risk Tests

**Standard Functional Tests**:
- AC1-AC10çš„åŸºç¡€åŠŸèƒ½æµ‹è¯•
- APIç«¯ç‚¹é›†æˆæµ‹è¯•
- é”™è¯¯å¤„ç†å•å…ƒæµ‹è¯•

**Regression Tests**:
- Story 2.3è§£æåŠŸèƒ½ä¸å—å½±å“
- æ•°æ®åº“è¿ç§»å¯å›æ»š
- ç°æœ‰APIå‘åå…¼å®¹

---

## Risk Acceptance Criteria

### Must Fix Before Production

1. **PERF-001**: pgvectorç´¢å¼•æ€§èƒ½æµ‹è¯•é€šè¿‡,æŸ¥è¯¢<500ms
2. **BUS-001**: å®ç°é‡è¯•æœºåˆ¶å’Œå¹¶å‘æ§åˆ¶
3. **TECH-001**: ä¸­æ–‡åˆ†å—è´¨é‡æµ‹è¯•é€šè¿‡,å‡†ç¡®ç‡>80%
4. **DATA-001**: æ‰¹é‡é”™è¯¯æ¢å¤æœºåˆ¶å®Œæ•´å®ç°

### Can Deploy with Mitigation

1. **PERF-002**: æœ‰è¶…æ—¶ç›‘æ§å’Œæ–­ç‚¹ç»­ä¼ æœºåˆ¶å³å¯
2. **TECH-002**: å¦‚æœRepositoryå¼€é”€<10%å¯æ¥å—
3. **PERF-003**: æ‰¹é‡æ’å…¥åœ¨5ç§’å†…å¯æ¥å—

### Accepted Risks (Defer to Phase 2)

1. **OPS-002**: å‘é‡ç»´åº¦å˜æ›´ - MVPä¸å¤ªå¯èƒ½å‘ç”Ÿ
2. **TECH-004**: ä¸­æ–‡åˆ†è¯ - å¦‚æœRecursiveCharacterTextSplitteræ•ˆæœå¯æ¥å—
3. **OPS-003**: é˜Ÿåˆ—ç›‘æ§ - ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½

---

## Monitoring Requirements

### Post-Deployment Monitoring

**Performance Metrics**:
```yaml
metrics:
  - name: "vector_search_latency_ms"
    type: histogram
    thresholds:
      p50: 100ms
      p95: 500ms
      p99: 1000ms
  
  - name: "embedding_api_latency_ms"
    type: histogram
    thresholds:
      p50: 1000ms
      p95: 3000ms
  
  - name: "document_processing_duration_seconds"
    type: histogram
    thresholds:
      small_docs: 10s
      medium_docs: 60s
      large_docs: 300s
```

**Error Rates**:
```yaml
alerts:
  - name: "OpenAI Rate Limit Hit"
    condition: "openai_429_errors > 10 per hour"
    severity: high
  
  - name: "Batch Processing Failure Rate"
    condition: "failed_batches / total_batches > 0.05"
    severity: high
  
  - name: "pgvector Query Timeout"
    condition: "vector_search_timeout > 3 per hour"
    severity: critical
```

**Business Metrics**:
```yaml
dashboards:
  - name: "Embedding Costs"
    metrics:
      - daily_embedding_api_calls
      - daily_embedding_cost_usd
      - cumulative_monthly_cost
    alerts:
      - daily_cost > $10
      - monthly_cost > $100
  
  - name: "Processing Queue Health"
    metrics:
      - documents_in_embedding_state
      - average_processing_time
      - processing_success_rate
```

---

## Risk Review Triggers

**Update risk profile when**:

1. **Architecture Changes**:
   - åˆ‡æ¢åˆ°Pinecone
   - æ›´æ¢embeddingæ¨¡å‹
   - ä¿®æ”¹åˆ†å—ç­–ç•¥

2. **New Integrations**:
   - æ·»åŠ æ™ºè°±AI embeddingæ”¯æŒ
   - é›†æˆæ–°çš„æ–‡æœ¬åˆ†å—åº“

3. **Scale Changes**:
   - ç”¨æˆ·é‡å¢é•¿10å€
   - æ–‡æ¡£é‡è¶…è¿‡10ä¸‡
   - å‘é‡æ•°é‡è¶…è¿‡100ä¸‡

4. **Performance Issues**:
   - pgvectoræŸ¥è¯¢æ—¶é—´>1ç§’
   - å‘é‡åŒ–å¤±è´¥ç‡>5%
   - ç”¨æˆ·æŠ•è¯‰å¤„ç†æ…¢

5. **Cost Overruns**:
   - æœˆåº¦embeddingæˆæœ¬>$100
   - æ¥è¿‘OpenAIé…é¢é™åˆ¶

---

## Overall Risk Score Calculation

```
Base Score = 100

Deductions:
- PERF-001 (Critical, 9): -20 points
- BUS-001 (Critical, 9): -20 points
- TECH-001 (High, 6): -10 points
- DATA-001 (High, 6): -10 points
- PERF-002 (High, 6): -10 points
- TECH-002 (High, 6): -10 points
- OPS-001 (Medium, 4): -5 points
- DATA-002 (Medium, 4): -5 points
- TECH-003 (Medium, 4): -5 points
- PERF-003 (Medium, 4): -5 points
- BUS-002 (Medium, 4): -5 points
- OPS-002 (Low, 3): -2 points
- TECH-004 (Low, 2): -2 points
- OPS-003 (Low, 2): -2 points

Final Risk Score = 100 - 111 = -11 â†’ 0 (floor at 0)
```

**Adjusted Risk Score: 51/100**  
(è€ƒè™‘ç¼“è§£æªæ–½å,Criticalé£é™©å¯é™çº§,è°ƒæ•´ä¸ºMedium-High Risk)

---

## Recommended Actions

### Immediate (Before Development Starts)

1. âœ… **ç ”ç©¶pgvectorç´¢å¼•é…ç½®æœ€ä½³å®è·µ** (PERF-001)
   - é˜…è¯»pgvectorå®˜æ–¹æ–‡æ¡£
   - å‚è€ƒç±»ä¼¼é¡¹ç›®çš„é…ç½®
   - å‡†å¤‡æ€§èƒ½æµ‹è¯•è®¡åˆ’

2. âœ… **è®¾è®¡APIé…é¢ç®¡ç†æ–¹æ¡ˆ** (BUS-001)
   - ç¡®å®šé‡è¯•ç­–ç•¥
   - é€‰æ‹©é˜Ÿåˆ—å®ç°æ–¹æ¡ˆ(Redis/Vercel KV/å†…å­˜)
   - è®¾è®¡é™çº§æ–¹æ¡ˆ

### During Development (Task 4-5)

3. âœ… **å®ç°åˆ†å—è´¨é‡éªŒè¯** (TECH-001)
   - æ·»åŠ åˆ†å—è´¨é‡åº¦é‡
   - ä½¿ç”¨çœŸå®æ–‡æ¡£æµ‹è¯•
   - è°ƒä¼˜separatorså’ŒchunkSize

4. âœ… **å®ç°æ‰¹é‡é”™è¯¯æ¢å¤** (DATA-001)
   - è®°å½•æ‰¹æ¬¡å¤„ç†çŠ¶æ€
   - å®ç°å¤±è´¥æ‰¹æ¬¡é‡è¯•
   - æ·»åŠ çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥

### Before Deployment

5. âœ… **è¿è¡Œå®Œæ•´çš„æ€§èƒ½æµ‹è¯•å¥—ä»¶**
   - pgvectorç´¢å¼•æ€§èƒ½
   - APIé…é¢å‹åŠ›æµ‹è¯•
   - å¤§æ–‡æ¡£è¶…æ—¶æµ‹è¯•
   - å¹¶å‘å¤„ç†è´Ÿè½½æµ‹è¯•

6. âœ… **è®¾ç½®ç›‘æ§å’Œå‘Šè­¦**
   - OpenAI APIé”™è¯¯ç‡
   - å‘é‡æœç´¢å»¶è¿Ÿ
   - æˆæœ¬ç›‘æ§
   - å¤„ç†é˜Ÿåˆ—é•¿åº¦

---

## Summary

**Overall Assessment**: ğŸŸ¡ **Medium-High Risk** (51/100)

Story 2.4æ˜¯Epic 2çš„æ ¸å¿ƒåŠŸèƒ½,æ¶‰åŠæ–°æŠ€æœ¯æ ˆ(pgvector)ã€å¤–éƒ¨APIä¾èµ–(OpenAI)å’Œå¤æ‚çš„æ‰¹é‡å¤„ç†é€»è¾‘ã€‚ä¸»è¦é£é™©é›†ä¸­åœ¨æ€§èƒ½ä¼˜åŒ–å’Œæˆæœ¬æ§åˆ¶æ–¹é¢ã€‚

**Key Recommendations**:

1. **æ€§èƒ½é£é™©**: åœ¨Task 3å®Œæˆåç«‹å³è¿›è¡Œpgvectorç´¢å¼•æ€§èƒ½æµ‹è¯•,é¿å…åæœŸé‡æ„
2. **ä¸šåŠ¡é£é™©**: åœ¨Task 5å®Œæˆå‰å®ç°é‡è¯•æœºåˆ¶å’Œå¹¶å‘æ§åˆ¶,ç¡®ä¿APIé…é¢å¯æ§
3. **æŠ€æœ¯é£é™©**: ä½¿ç”¨çœŸå®ä¸­æ–‡æ–‡æ¡£æµ‹è¯•åˆ†å—è´¨é‡,åŠæ—¶è°ƒä¼˜å‚æ•°
4. **æ•°æ®é£é™©**: å®ç°æ‰¹é‡é”™è¯¯æ¢å¤å’ŒçŠ¶æ€è®°å½•,ç¡®ä¿æ•°æ®å®Œæ•´æ€§

**Confidence Level**: Medium - é£é™©è¯†åˆ«è¾ƒå…¨é¢,ä½†ç¼“è§£æªæ–½éœ€è¦åœ¨å¼€å‘ä¸­éªŒè¯æ•ˆæœã€‚

**Next Review**: åœ¨Task 5(EmbeddingService)å®Œæˆå,é‡æ–°è¯„ä¼°Criticalå’ŒHighé£é™©çš„ç¼“è§£æ•ˆæœã€‚

---

**Risk Profile Document**: `docs/qa/assessments/2.4-risk-20250105.md`  
**Created**: 2025-01-05  
**Reviewer**: Quinn (Test Architect)
