# 测试设计：Story 1.7 - Landing Page 与导航实现

**日期**: 2025-01-03  
**设计人**: Quinn (Test Architect)

---

## 测试策略概览

- **测试场景总数**: 24
- **单元测试**: 12 (50%)
- **集成测试**: 8 (33%)
- **E2E 测试**: 4 (17%)
- **优先级分布**: P0: 8, P1: 10, P2: 6

---

## 按验收标准的测试场景

### AC1: 首页基础布局

#### 场景

| ID | 层级 | 优先级 | 测试 | 理由 |
|---|---|---|---|---|
| 1.7-UNIT-001 | Unit | P0 | 验证页面使用正确的根容器类名 | 纯 DOM 结构验证，适合单元测试 |
| 1.7-UNIT-002 | Unit | P1 | 验证页面使用 shadcn/ui 组件 | 组件导入验证，单元测试足够 |
| 1.7-INT-001 | Integration | P1 | 验证页面整体布局在浏览器中正确渲染 | 需要真实浏览器环境验证样式 |

**覆盖分析**: AC1 主要关注布局结构，单元测试验证组件组成，集成测试验证视觉效果。

---

### AC2: Hero Section（英雄区）

#### 场景

| ID | 层级 | 优先级 | 测试 | 理由 |
|---|---|---|---|---|
| 1.7-UNIT-003 | Unit | P0 | 验证主标题文本内容为"智能文档问答系统" | 核心内容验证，单元测试快速反馈 |
| 1.7-UNIT-004 | Unit | P0 | 验证主标题样式类名包含正确的字号和字重 | 样式类验证，单元测试足够 |
| 1.7-UNIT-005 | Unit | P1 | 验证副标题文本和样式 | 次要内容验证 |
| 1.7-UNIT-006 | Unit | P2 | 验证可选产品描述存在性 | 可选功能，低优先级 |
| 1.7-INT-002 | Integration | P1 | 验证 Hero Section 在不同设备宽度下的响应式布局 | 需要真实浏览器测试响应式 |

**覆盖分析**: Hero Section 是用户第一眼看到的内容，P0 测试确保核心信息正确，集成测试验证响应式表现。

---

### AC3: CTA 按钮组

#### 场景

| ID | 层级 | 优先级 | 测试 | 理由 |
|---|---|---|---|---|
| 1.7-UNIT-007 | Unit | P0 | 验证"免费开始使用"按钮存在且链接到 /register | 核心转化路径，必须正确 |
| 1.7-UNIT-008 | Unit | P0 | 验证"登录"按钮存在且链接到 /login | 核心功能入口，必须正确 |
| 1.7-UNIT-009 | Unit | P1 | 验证按钮使用正确的 size 属性 | 视觉一致性验证 |
| 1.7-UNIT-010 | Unit | P1 | 验证按钮使用正确的 variant 属性 | 样式规范验证 |
| 1.7-INT-003 | Integration | P0 | 验证按钮在桌面端水平排列 | 布局关键行为，需浏览器验证 |
| 1.7-INT-004 | Integration | P0 | 验证按钮在移动端垂直堆叠 | 移动端核心体验，需真机测试 |
| 1.7-E2E-001 | E2E | P0 | 点击"免费开始使用"按钮跳转到注册页 | 核心用户旅程，需端到端验证 |
| 1.7-E2E-002 | E2E | P0 | 点击"登录"按钮跳转到登录页 | 核心用户旅程，需端到端验证 |

**覆盖分析**: CTA 按钮是转化的关键，P0 测试覆盖链接正确性和关键布局，E2E 测试验证完整导航流程。

---

### AC4: 用户状态路由逻辑

#### 场景

| ID | 层级 | 优先级 | 测试 | 理由 |
|---|---|---|---|---|
| 1.7-UNIT-011 | Unit | P0 | 未登录用户（session = null）显示 Landing Page | 核心路由逻辑，单元测试验证分支 |
| 1.7-UNIT-012 | Unit | P0 | 已登录用户（session 有效）触发 redirect('/dashboard') | 核心路由逻辑，必须正确 |
| 1.7-INT-005 | Integration | P0 | 验证 auth() 方法被正确调用 | 多组件交互，需集成测试 |
| 1.7-INT-006 | Integration | P1 | Session 过期用户应显示 Landing Page | 边界情况，需验证 Session 处理 |
| 1.7-INT-007 | Integration | P2 | Session 无效（格式错误）应显示 Landing Page 并记录错误 | 异常处理，中等优先级 |
| 1.7-E2E-003 | E2E | P1 | 已登录用户访问首页自动跳转到 Dashboard | 端到端验证完整重定向流程 |

**覆盖分析**: 路由逻辑是核心功能，单元测试覆盖逻辑分支，集成测试验证 Session 交互，E2E 测试验证用户体验。

---

### AC5: 响应式设计

#### 场景

| ID | 层级 | 优先级 | 测试 | 理由 |
|---|---|---|---|---|
| 1.7-INT-008 | Integration | P0 | Desktop（≥1024px）最大宽度为 max-w-5xl | 关键布局约束，需浏览器验证 |
| 1.7-INT-009 | Integration | P1 | Tablet（768-1023px）按钮保持横向排列 | 次要设备体验验证 |
| 1.7-INT-010 | Integration | P1 | Mobile（<768px）主标题字号缩小到 text-4xl | 移动端适配验证 |
| 1.7-INT-011 | Integration | P1 | Mobile 按钮改为纵向堆叠且宽度 w-full | 移动端核心交互验证 |
| 1.7-E2E-004 | E2E | P2 | 在真实移动设备上验证完整布局和交互 | 真机验证，确保实际可用性 |

**覆盖分析**: 响应式设计需要多设备测试，集成测试覆盖断点行为，E2E 测试在真实设备验证。

---

### AC6: 页面性能

#### 场景

| ID | 层级 | 优先级 | 测试 | 理由 |
|---|---|---|---|---|
| 1.7-INT-012 | Integration | P0 | 页面首屏加载时间 < 1秒（本地环境） | 性能关键指标，需性能测试工具 |
| 1.7-INT-013 | Integration | P1 | 累积布局偏移 (CLS) < 0.1 | Core Web Vitals 指标 |
| 1.7-INT-014 | Integration | P2 | Lighthouse 性能评分 > 90 | 综合性能验证 |

**覆盖分析**: 性能测试需要专门工具，集成测试层级使用 Lighthouse 和性能 API 测量。

---

## 详细测试场景设计

### 单元测试（Unit Tests）

```typescript
// tests/unit/landing-page/layout.test.tsx
describe('AC1: 首页基础布局', () => {
  test('1.7-UNIT-001: 验证页面使用正确的根容器类名', () => {
    const { container } = render(<HomePage />);
    const main = container.querySelector('main');
    expect(main).toHaveClass('flex', 'min-h-screen', 'flex-col', 'items-center', 'justify-center');
  });

  test('1.7-UNIT-002: 验证页面使用 shadcn/ui Button 组件', () => {
    render(<HomePage />);
    const buttons = screen.getAllByRole('link');
    buttons.forEach(button => {
      expect(button.firstChild).toHaveClass('inline-flex'); // shadcn Button 特征类
    });
  });
});

describe('AC2: Hero Section', () => {
  test('1.7-UNIT-003: 验证主标题文本内容', () => {
    render(<HomePage />);
    expect(screen.getByRole('heading', { level: 1 })).toHaveTextContent('智能文档问答系统');
  });

  test('1.7-UNIT-004: 验证主标题样式类名', () => {
    render(<HomePage />);
    const h1 = screen.getByRole('heading', { level: 1 });
    expect(h1).toHaveClass('font-bold');
    // 验证响应式字号
    expect(h1.className).toMatch(/text-4xl|text-5xl|text-6xl/);
  });

  test('1.7-UNIT-005: 验证副标题文本和样式', () => {
    render(<HomePage />);
    const subtitle = screen.getByText(/基于 AI 的智能文档分析与问答平台/);
    expect(subtitle).toBeInTheDocument();
    expect(subtitle).toHaveClass('text-gray-600');
  });

  test('1.7-UNIT-006: 验证可选产品描述存在性', () => {
    render(<HomePage />);
    // 可选内容，测试其存在或不存在都应通过
    const description = container.querySelector('.product-description');
    if (description) {
      expect(description).toBeInTheDocument();
    }
  });
});

describe('AC3: CTA 按钮组', () => {
  test('1.7-UNIT-007: 验证"免费开始使用"按钮链接', () => {
    render(<HomePage />);
    const registerButton = screen.getByRole('link', { name: /免费开始使用/ });
    expect(registerButton).toHaveAttribute('href', '/register');
  });

  test('1.7-UNIT-008: 验证"登录"按钮链接', () => {
    render(<HomePage />);
    const loginButton = screen.getByRole('link', { name: /登录/ });
    expect(loginButton).toHaveAttribute('href', '/login');
  });

  test('1.7-UNIT-009: 验证按钮 size 属性', () => {
    render(<HomePage />);
    const buttons = screen.getAllByRole('link');
    buttons.forEach(button => {
      // shadcn Button with size="lg" 应有特定类名
      expect(button.firstChild).toHaveClass('h-11', 'px-8'); // lg size 特征
    });
  });

  test('1.7-UNIT-010: 验证按钮 variant 属性', () => {
    render(<HomePage />);
    const registerButton = screen.getByRole('link', { name: /免费开始使用/ });
    const loginButton = screen.getByRole('link', { name: /登录/ });
    
    // Primary button
    expect(registerButton.firstChild).toHaveClass('bg-primary');
    // Outline button
    expect(loginButton.firstChild).toHaveClass('border', 'border-input');
  });
});

describe('AC4: 用户状态路由逻辑', () => {
  test('1.7-UNIT-011: 未登录用户显示 Landing Page', async () => {
    // Mock auth() 返回 null
    jest.mock('@/lib/auth', () => ({
      auth: jest.fn().mockResolvedValue(null)
    }));

    const { container } = render(<HomePage />);
    
    // 应显示主标题（Landing Page 的标志）
    expect(screen.getByText('智能文档问答系统')).toBeInTheDocument();
    // 应显示 CTA 按钮
    expect(screen.getByText('免费开始使用')).toBeInTheDocument();
  });

  test('1.7-UNIT-012: 已登录用户触发 redirect', async () => {
    // Mock auth() 返回有效 session
    const mockRedirect = jest.fn();
    jest.mock('next/navigation', () => ({
      redirect: mockRedirect
    }));
    jest.mock('@/lib/auth', () => ({
      auth: jest.fn().mockResolvedValue({ user: { id: '1', email: 'test@example.com' } })
    }));

    render(<HomePage />);
    
    // 应调用 redirect
    await waitFor(() => {
      expect(mockRedirect).toHaveBeenCalledWith('/dashboard');
    });
  });
});
```

---

### 集成测试（Integration Tests）

```typescript
// tests/integration/landing-page/layout.test.ts
describe('AC1: 首页布局集成测试', () => {
  test('1.7-INT-001: 验证页面整体布局在浏览器中正确渲染', async () => {
    const page = await browser.newPage();
    await page.goto('http://localhost:3000');
    
    // 验证页面居中
    const main = await page.$('main');
    const box = await main.boundingBox();
    expect(box.width).toBeLessThan(page.viewport().width);
    
    // 验证垂直居中
    const styles = await page.evaluate((el) => {
      return window.getComputedStyle(el);
    }, main);
    expect(styles.alignItems).toBe('center');
    expect(styles.justifyContent).toBe('center');
  });
});

describe('AC2: Hero Section 响应式', () => {
  test('1.7-INT-002: 验证 Hero Section 响应式布局', async () => {
    const page = await browser.newPage();
    
    // Desktop
    await page.setViewport({ width: 1440, height: 900 });
    await page.goto('http://localhost:3000');
    const desktopH1 = await page.$('h1');
    const desktopFontSize = await page.evaluate(el => 
      window.getComputedStyle(el).fontSize, desktopH1
    );
    
    // Mobile
    await page.setViewport({ width: 375, height: 667 });
    await page.reload();
    const mobileH1 = await page.$('h1');
    const mobileFontSize = await page.evaluate(el => 
      window.getComputedStyle(el).fontSize, mobileH1
    );
    
    // 移动端字号应小于桌面端
    expect(parseFloat(mobileFontSize)).toBeLessThan(parseFloat(desktopFontSize));
  });
});

describe('AC3: CTA 按钮布局', () => {
  test('1.7-INT-003: Desktop 按钮水平排列', async () => {
    const page = await browser.newPage();
    await page.setViewport({ width: 1440, height: 900 });
    await page.goto('http://localhost:3000');
    
    const buttonContainer = await page.$('.flex.gap-4');
    const flexDirection = await page.evaluate(el => 
      window.getComputedStyle(el).flexDirection, buttonContainer
    );
    
    expect(flexDirection).toBe('row');
  });

  test('1.7-INT-004: Mobile 按钮垂直堆叠', async () => {
    const page = await browser.newPage();
    await page.setViewport({ width: 375, height: 667 });
    await page.goto('http://localhost:3000');
    
    const buttonContainer = await page.$('.flex.gap-4');
    const flexDirection = await page.evaluate(el => 
      window.getComputedStyle(el).flexDirection, buttonContainer
    );
    
    expect(flexDirection).toBe('column');
    
    // 验证按钮宽度为 100%
    const button = await page.$('a[href="/register"]');
    const buttonWidth = await page.evaluate(el => 
      el.offsetWidth, button
    );
    const containerWidth = await page.evaluate(el => 
      el.parentElement.offsetWidth, button
    );
    
    expect(buttonWidth).toBeGreaterThan(containerWidth * 0.9); // 允许 padding
  });
});

describe('AC4: Session 路由逻辑', () => {
  test('1.7-INT-005: 验证 auth() 方法被正确调用', async () => {
    // 使用 MSW 拦截 NextAuth API
    const server = setupServer(
      rest.get('/api/auth/session', (req, res, ctx) => {
        return res(ctx.json(null));
      })
    );
    server.listen();
    
    await page.goto('http://localhost:3000');
    
    // 验证 session 请求被发送
    const requests = page.requests();
    expect(requests.some(r => r.url().includes('/api/auth/session'))).toBe(true);
    
    server.close();
  });

  test('1.7-INT-006: Session 过期用户显示 Landing Page', async () => {
    // Mock 过期 session
    const server = setupServer(
      rest.get('/api/auth/session', (req, res, ctx) => {
        return res(ctx.status(401));
      })
    );
    server.listen();
    
    await page.goto('http://localhost:3000');
    
    // 应显示 Landing Page
    await expect(page.locator('h1')).toContainText('智能文档问答系统');
    
    server.close();
  });

  test('1.7-INT-007: Session 无效应记录错误', async () => {
    const consoleErrors = [];
    page.on('console', msg => {
      if (msg.type() === 'error') consoleErrors.push(msg.text());
    });
    
    // Mock 无效 session 响应
    const server = setupServer(
      rest.get('/api/auth/session', (req, res, ctx) => {
        return res(ctx.status(500));
      })
    );
    server.listen();
    
    await page.goto('http://localhost:3000');
    
    // 应记录错误
    expect(consoleErrors.length).toBeGreaterThan(0);
    
    server.close();
  });
});

describe('AC5: 响应式设计', () => {
  test('1.7-INT-008: Desktop 最大宽度 max-w-5xl', async () => {
    const page = await browser.newPage();
    await page.setViewport({ width: 1920, height: 1080 });
    await page.goto('http://localhost:3000');
    
    const container = await page.$('.max-w-5xl');
    const width = await page.evaluate(el => el.offsetWidth, container);
    
    // max-w-5xl = 64rem = 1024px
    expect(width).toBeLessThanOrEqual(1024);
  });

  test('1.7-INT-009: Tablet 按钮保持横向', async () => {
    const page = await browser.newPage();
    await page.setViewport({ width: 768, height: 1024 });
    await page.goto('http://localhost:3000');
    
    const buttonContainer = await page.$('.flex.gap-4');
    const flexDirection = await page.evaluate(el => 
      window.getComputedStyle(el).flexDirection, buttonContainer
    );
    
    expect(flexDirection).toBe('row');
  });

  test('1.7-INT-010: Mobile 主标题字号缩小', async () => {
    const page = await browser.newPage();
    
    // Desktop
    await page.setViewport({ width: 1440, height: 900 });
    await page.goto('http://localhost:3000');
    const desktopSize = await page.evaluate(() => {
      const h1 = document.querySelector('h1');
      return window.getComputedStyle(h1).fontSize;
    });
    
    // Mobile
    await page.setViewport({ width: 375, height: 667 });
    await page.reload();
    const mobileSize = await page.evaluate(() => {
      const h1 = document.querySelector('h1');
      return window.getComputedStyle(h1).fontSize;
    });
    
    expect(parseFloat(mobileSize)).toBeLessThan(parseFloat(desktopSize));
  });

  test('1.7-INT-011: Mobile 按钮宽度 w-full', async () => {
    const page = await browser.newPage();
    await page.setViewport({ width: 375, height: 667 });
    await page.goto('http://localhost:3000');
    
    const button = await page.$('a[href="/register"]');
    const buttonWidth = await button.evaluate(el => el.offsetWidth);
    const viewportWidth = page.viewport().width;
    
    // 考虑 padding，按钮应占满容器宽度
    expect(buttonWidth).toBeGreaterThan(viewportWidth * 0.8);
  });
});

describe('AC6: 页面性能', () => {
  test('1.7-INT-012: 页面首屏加载时间 < 1秒', async () => {
    const page = await browser.newPage();
    
    const startTime = Date.now();
    await page.goto('http://localhost:3000', { waitUntil: 'domcontentloaded' });
    const loadTime = Date.now() - startTime;
    
    expect(loadTime).toBeLessThan(1000);
  });

  test('1.7-INT-013: 累积布局偏移 (CLS) < 0.1', async () => {
    const page = await browser.newPage();
    await page.goto('http://localhost:3000');
    
    // 使用 Performance API 测量 CLS
    const cls = await page.evaluate(() => {
      return new Promise(resolve => {
        let clsValue = 0;
        const observer = new PerformanceObserver(list => {
          for (const entry of list.getEntries()) {
            if (!entry.hadRecentInput) {
              clsValue += entry.value;
            }
          }
        });
        observer.observe({ type: 'layout-shift', buffered: true });
        
        setTimeout(() => {
          observer.disconnect();
          resolve(clsValue);
        }, 3000);
      });
    });
    
    expect(cls).toBeLessThan(0.1);
  });

  test('1.7-INT-014: Lighthouse 性能评分 > 90', async () => {
    const lighthouse = require('lighthouse');
    const chromeLauncher = require('chrome-launcher');
    
    const chrome = await chromeLauncher.launch({ chromeFlags: ['--headless'] });
    const options = { port: chrome.port };
    const runnerResult = await lighthouse('http://localhost:3000', options);
    
    const performanceScore = runnerResult.lhr.categories.performance.score * 100;
    
    await chrome.kill();
    
    expect(performanceScore).toBeGreaterThan(90);
  });
});
```

---

### E2E 测试（End-to-End Tests）

```typescript
// tests/e2e/landing-page-navigation.test.ts
describe('AC3: CTA 按钮导航', () => {
  test('1.7-E2E-001: 点击"免费开始使用"跳转到注册页', async () => {
    await page.goto('http://localhost:3000');
    
    // 等待页面加载完成
    await page.waitForSelector('h1:has-text("智能文档问答系统")');
    
    // 点击注册按钮
    await page.click('a:has-text("免费开始使用")');
    
    // 验证 URL 变为 /register
    await page.waitForURL('**/register');
    expect(page.url()).toContain('/register');
    
    // 验证注册页面内容
    await expect(page.locator('h2')).toContainText('注册');
  });

  test('1.7-E2E-002: 点击"登录"跳转到登录页', async () => {
    await page.goto('http://localhost:3000');
    
    await page.waitForSelector('h1:has-text("智能文档问答系统")');
    
    // 点击登录按钮
    await page.click('a:has-text("登录")');
    
    // 验证 URL 变为 /login
    await page.waitForURL('**/login');
    expect(page.url()).toContain('/login');
    
    // 验证登录页面内容
    await expect(page.locator('h2')).toContainText('登录');
  });
});

describe('AC4: 已登录用户重定向', () => {
  test('1.7-E2E-003: 已登录用户访问首页自动跳转', async () => {
    // 先登录
    await page.goto('http://localhost:3000/login');
    await page.fill('input[type="email"]', 'test@example.com');
    await page.fill('input[type="password"]', 'Test123456!');
    await page.click('button[type="submit"]');
    
    // 等待登录成功（应跳转到 dashboard）
    await page.waitForURL('**/dashboard');
    
    // 尝试访问首页
    await page.goto('http://localhost:3000');
    
    // 应立即重定向回 dashboard
    await page.waitForURL('**/dashboard', { timeout: 2000 });
    expect(page.url()).toContain('/dashboard');
    
    // 不应显示 Landing Page 内容
    const landingTitle = await page.$('h1:has-text("智能文档问答系统")');
    expect(landingTitle).toBeNull();
  });
});

describe('AC5: 移动端真机测试', () => {
  test('1.7-E2E-004: 真实移动设备完整体验', async () => {
    // 使用移动设备配置
    const iPhone = devices['iPhone 12'];
    const context = await browser.newContext({
      ...iPhone,
    });
    const page = await context.newPage();
    
    await page.goto('http://localhost:3000');
    
    // 验证页面加载
    await page.waitForSelector('h1');
    
    // 验证主标题在移动端可见
    const h1 = page.locator('h1');
    await expect(h1).toBeVisible();
    const h1Text = await h1.textContent();
    expect(h1Text).toContain('智能文档问答系统');
    
    // 验证按钮垂直堆叠且可点击
    const registerButton = page.locator('a:has-text("免费开始使用")');
    await expect(registerButton).toBeVisible();
    
    // 获取按钮位置
    const buttonBox1 = await registerButton.boundingBox();
    const loginButton = page.locator('a:has-text("登录")');
    const buttonBox2 = await loginButton.boundingBox();
    
    // 验证按钮垂直排列（第二个按钮的 y 坐标大于第一个）
    expect(buttonBox2.y).toBeGreaterThan(buttonBox1.y + buttonBox1.height);
    
    // 测试点击交互
    await registerButton.click();
    await page.waitForURL('**/register');
    expect(page.url()).toContain('/register');
    
    await context.close();
  });
});
```

---

## 测试覆盖缺口

**无覆盖缺口** - 所有验收标准都有对应的测试场景。

---

## 推荐执行顺序

### 阶段 1: P0 单元测试（快速反馈）

1. 1.7-UNIT-003 - 主标题内容
2. 1.7-UNIT-004 - 主标题样式
3. 1.7-UNIT-007 - 注册按钮链接
4. 1.7-UNIT-008 - 登录按钮链接
5. 1.7-UNIT-011 - 未登录用户逻辑
6. 1.7-UNIT-012 - 已登录用户逻辑

### 阶段 2: P0 集成测试（关键路径）

7. 1.7-INT-003 - Desktop 按钮布局
8. 1.7-INT-004 - Mobile 按钮布局
9. 1.7-INT-005 - auth() 调用验证
10. 1.7-INT-008 - Desktop 最大宽度
11. 1.7-INT-012 - 首屏加载性能

### 阶段 3: P0 E2E 测试（用户旅程）

12. 1.7-E2E-001 - 注册按钮导航
13. 1.7-E2E-002 - 登录按钮导航

### 阶段 4: P1 测试（核心质量）

14. 所有 P1 单元测试
15. 所有 P1 集成测试
16. 所有 P1 E2E 测试

### 阶段 5: P2 测试（时间允许）

17. 所有 P2 测试

---

## 质量检查清单

部署前验证：

- [ ] 所有 P0 测试通过
- [ ] 所有 AC 有测试覆盖
- [ ] 测试级别选择合理（无过度测试）
- [ ] 场景 ID 遵循命名约定
- [ ] 测试具有原子性和独立性

---

## 关键原则

- **左移测试**: 优先单元测试，其次集成，最后 E2E
- **基于风险**: 关注可能出错的部分（路由逻辑、性能）
- **高效覆盖**: 在正确的层级测试一次
- **可维护性**: 测试应易于理解和维护
- **快速反馈**: P0 测试应在 < 5 分钟内完成

---

**设计人**: Quinn (Test Architect)  
**设计日期**: 2025-01-03  
**审查状态**: 已完成

