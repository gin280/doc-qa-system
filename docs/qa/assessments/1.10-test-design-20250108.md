# Test Design: Story 1.10 - Chat为中心的统一导航架构

**Date**: 2025-01-08  
**Test Architect**: Quinn  
**Story ID**: 1.10  
**Epic**: 1 - 基础设施与用户认证

---

## 测试策略概览

### 测试复杂度评估

**Story 特性**:
- ✅ 重大架构重构（路由重组）
- ✅ 多个核心组件修改
- ✅ 认证逻辑迁移
- ✅ 用户流程根本性改变
- ✅ 高风险（风险分数: 6）

**测试策略**: **全面测试 + 风险驱动优先级**

### 测试场景统计

- **总测试场景**: 38
- **Unit 测试**: 12 (32%)
- **Integration 测试**: 16 (42%)
- **E2E 测试**: 10 (26%)

**优先级分布**:
- **P0**: 18 场景 (47%) - 必须通过才能部署
- **P1**: 12 场景 (32%) - 重要但非阻塞
- **P2**: 8 场景 (21%) - 建议完成

---

## 按验收标准的测试场景

### AC1: 移除Dashboard，Chat成为默认首页

#### 场景 1.10-INT-001: 已登录用户访问根路径重定向到 /chat

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC1 - 登录成功后直接跳转到 /chat

**测试场景**:
```
Given: 用户已成功登录
When: 用户访问根路径 "/"
Then: 应该重定向到 "/chat"
And: Chat 页面正常加载
```

**实现提示**:
```typescript
// tests/integration/navigation-refactor.test.ts
describe('AC1: Chat as Default Home', () => {
  it('should redirect authenticated user from root to /chat', async () => {
    const session = await signIn('user@example.com');
    const response = await fetch('/');
    
    expect(response.url).toContain('/chat');
    expect(response.status).toBe(200);
  });
});
```

**风险覆盖**: TECH-001（路由重构）

---

#### 场景 1.10-INT-002: 登录成功后直接跳转到 /chat

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC1 - 登录成功后直接跳转

**测试场景**:
```
Given: 用户在登录页面
When: 用户输入正确的凭据并登录
Then: 应该重定向到 "/chat"
And: 不经过 "/dashboard"
```

**实现提示**:
```typescript
it('should redirect to /chat after successful login', async () => {
  await page.goto('/login');
  await page.fill('[name="email"]', 'user@example.com');
  await page.fill('[name="password"]', 'password123');
  await page.click('button[type="submit"]');
  
  await page.waitForURL('**/chat');
  expect(page.url()).toContain('/chat');
});
```

**风险覆盖**: BUS-001（用户流程中断）

---

#### 场景 1.10-INT-003: 注册成功后直接跳转到 /chat

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC1 - 注册成功后直接跳转

**测试场景**:
```
Given: 新用户在注册页面
When: 用户完成注册流程
Then: 应该重定向到 "/chat"
And: 显示首次访问引导（如果没有文档）
```

**实现提示**:
```typescript
it('should redirect to /chat after successful registration', async () => {
  await page.goto('/register');
  await fillRegistrationForm();
  await page.click('button[type="submit"]');
  
  await page.waitForURL('**/chat');
  expect(page.url()).toContain('/chat');
  
  // 验证首次访问引导
  const welcomeText = await page.textContent('h2');
  expect(welcomeText).toContain('欢迎使用 DocQA');
});
```

---

#### 场景 1.10-INT-004: /dashboard 路由返回 404 或重定向

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC1 - 删除 /dashboard 路由

**测试场景**:
```
Given: 用户已登录
When: 用户访问 "/dashboard"
Then: 应该重定向到 "/chat?from=dashboard"
Or: 返回 404 错误
```

**实现提示**:
```typescript
it('should redirect /dashboard to /chat with migration notice', async () => {
  const session = await signIn('user@example.com');
  const response = await fetch('/dashboard');
  
  expect(response.url).toContain('/chat');
  expect(response.url).toContain('from=dashboard');
  
  // 验证迁移提示
  const html = await response.text();
  expect(html).toContain('我们优化了导航');
});
```

**风险覆盖**: DATA-001（现有链接失效）

---

#### 场景 1.10-E2E-001: Chat 页面首次访问友好（无文档）

**Level**: E2E  
**Priority**: P0  
**Requirement**: AC1, AC4 - Chat 页面优化为首次访问友好

**测试场景**:
```
Given: 新用户首次登录且没有上传文档
When: 用户到达 Chat 页面
Then: 应该显示"欢迎使用 DocQA"引导界面
And: 显示"上传文档"大按钮
And: 显示支持的文件格式说明
```

**实现提示**:
```typescript
it('should show upload guide for first-time users with no documents', async () => {
  // 清空用户文档
  await clearUserDocuments('newuser@example.com');
  
  await loginAs('newuser@example.com');
  await page.goto('/chat');
  
  await expect(page.locator('h2')).toContainText('欢迎使用 DocQA');
  await expect(page.locator('button')).toContainText('上传文档');
  await expect(page.locator('text=支持 PDF、Word')).toBeVisible();
});
```

**风险覆盖**: BUS-001（用户流程中断）

---

### AC2: 创建统一的AppHeader组件

#### 场景 1.10-UNIT-001: AppHeader 组件渲染测试

**Level**: Unit  
**Priority**: P0  
**Requirement**: AC2 - AppHeader 包含正确元素

**测试场景**:
```
Given: AppHeader 组件被渲染
When: 组件加载完成
Then: 应该显示 Logo
And: 应该显示"文档"导航链接
And: 应该显示用户菜单
```

**实现提示**:
```typescript
// tests/unit/layout/AppHeader.test.tsx
describe('AppHeader Component', () => {
  it('should render logo, navigation, and user menu', () => {
    const { getByRole, getByText } = render(
      <SessionProvider session={mockSession}>
        <AppHeader />
      </SessionProvider>
    );
    
    expect(getByRole('link', { name: /logo/i })).toBeInTheDocument();
    expect(getByText('文档')).toBeInTheDocument();
    expect(getByRole('button', { name: /user menu/i })).toBeInTheDocument();
  });
});
```

---

#### 场景 1.10-UNIT-002: AppHeader Logo 点击跳转到 /chat

**Level**: Unit  
**Priority**: P1  
**Requirement**: AC2 - Logo 点击回到 Chat

**测试场景**:
```
Given: 用户在任意认证页面
When: 用户点击 AppHeader 中的 Logo
Then: 应该导航到 "/chat"
```

**实现提示**:
```typescript
it('should navigate to /chat when logo is clicked', async () => {
  const { getByRole } = render(<AppHeader />);
  const logoLink = getByRole('link', { name: /logo/i });
  
  expect(logoLink).toHaveAttribute('href', '/chat');
});
```

---

#### 场景 1.10-UNIT-003: AppHeader "文档"导航高亮

**Level**: Unit  
**Priority**: P1  
**Requirement**: AC2 - 当前页面导航高亮

**测试场景**:
```
Given: 用户在 /documents 页面
When: AppHeader 渲染
Then: "文档"按钮应该有 active 样式
```

**实现提示**:
```typescript
it('should highlight active navigation item', () => {
  mockUsePathname.mockReturnValue('/documents');
  
  const { getByText } = render(<AppHeader />);
  const docButton = getByText('文档').closest('button');
  
  expect(docButton).toHaveClass('bg-primary'); // active variant
});
```

---

#### 场景 1.10-INT-005: AppHeader 在所有认证页面显示

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC2 - 所有认证页面共享 AppHeader

**测试场景**:
```
Given: 用户已登录
When: 用户访问 /chat, /documents, /settings 任一页面
Then: 每个页面都应该显示相同的 AppHeader
And: AppHeader 固定在顶部
```

**实现提示**:
```typescript
it('should display AppHeader on all authenticated pages', async () => {
  const session = await signIn('user@example.com');
  
  const pages = ['/chat', '/documents', '/settings'];
  
  for (const path of pages) {
    await page.goto(path);
    const header = await page.locator('header');
    
    expect(await header.isVisible()).toBe(true);
    expect(await header.locator('text=文档').count()).toBe(1);
  }
});
```

---

### AC3: 简化的用户菜单

#### 场景 1.10-UNIT-004: UserMenu 组件渲染测试

**Level**: Unit  
**Priority**: P0  
**Requirement**: AC3 - UserMenu 包含所有菜单项

**测试场景**:
```
Given: UserMenu 组件被渲染
When: 用户点击头像打开菜单
Then: 应该显示用户名和邮箱
And: 应该显示"账户设置"选项
And: 应该显示"主题切换"选项
And: 应该显示"退出登录"选项
```

**实现提示**:
```typescript
// tests/unit/layout/UserMenu.test.tsx
describe('UserMenu Component', () => {
  it('should render all menu items', async () => {
    const { getByRole, getByText } = render(
      <SessionProvider session={mockSession}>
        <UserMenu />
      </SessionProvider>
    );
    
    const trigger = getByRole('button');
    await userEvent.click(trigger);
    
    expect(getByText(mockSession.user.name)).toBeInTheDocument();
    expect(getByText('账户设置')).toBeInTheDocument();
    expect(getByText('主题')).toBeInTheDocument();
    expect(getByText('退出登录')).toBeInTheDocument();
  });
});
```

---

#### 场景 1.10-UNIT-005: UserMenu "账户设置"导航

**Level**: Unit  
**Priority**: P1  
**Requirement**: AC3 - 点击账户设置跳转

**测试场景**:
```
Given: UserMenu 已打开
When: 用户点击"账户设置"
Then: 应该导航到 "/settings"
```

**实现提示**:
```typescript
it('should navigate to /settings when clicking account settings', async () => {
  const { getByText } = render(<UserMenu />);
  
  const settingsLink = getByText('账户设置').closest('a');
  expect(settingsLink).toHaveAttribute('href', '/settings');
});
```

---

#### 场景 1.10-UNIT-006: UserMenu 退出登录功能

**Level**: Unit  
**Priority**: P0  
**Requirement**: AC3 - 退出后跳转到登录页

**测试场景**:
```
Given: UserMenu 已打开
When: 用户点击"退出登录"
Then: 应该调用 signOut 函数
And: 应该重定向到 "/login"
```

**实现提示**:
```typescript
it('should sign out and redirect to /login', async () => {
  const mockSignOut = jest.fn();
  const mockPush = jest.fn();
  
  mockUseSession.mockReturnValue({ data: mockSession });
  mockUseRouter.mockReturnValue({ push: mockPush });
  
  const { getByText } = render(<UserMenu />);
  await userEvent.click(getByText('退出登录'));
  
  expect(mockSignOut).toHaveBeenCalledWith({ redirect: false });
  expect(mockPush).toHaveBeenCalledWith('/login');
});
```

---

#### 场景 1.10-INT-006: UserMenu 主题切换功能

**Level**: Integration  
**Priority**: P2  
**Requirement**: AC3 - 主题切换正常工作

**测试场景**:
```
Given: UserMenu 已打开
When: 用户点击主题切换按钮
Then: 应该切换应用主题（light/dark）
And: 主题设置应该被持久化
```

---

### AC4: Chat页面优化为首次访问友好

#### 场景 1.10-UNIT-007: EmptyState 检测无文档状态

**Level**: Unit  
**Priority**: P0  
**Requirement**: AC4 - 显示上传引导

**测试场景**:
```
Given: 用户没有上传任何文档
When: EmptyState 组件渲染
Then: 应该显示"欢迎使用 DocQA"标题
And: 应该显示"上传文档"按钮
And: 应该显示支持的格式说明
```

**实现提示**:
```typescript
// tests/unit/chat/EmptyState.test.tsx
describe('EmptyState Component', () => {
  it('should show upload guide for users with no documents', async () => {
    mockFetch('/api/documents', { documents: [] });
    
    const { getByText, getByRole } = render(<EmptyState />);
    
    await waitFor(() => {
      expect(getByText('欢迎使用 DocQA! 👋')).toBeInTheDocument();
    });
    
    expect(getByRole('button', { name: /上传文档/i })).toBeInTheDocument();
    expect(getByText(/支持 PDF、Word/)).toBeInTheDocument();
  });
});
```

**风险覆盖**: BUS-001（用户流程中断）

---

#### 场景 1.10-UNIT-008: EmptyState 检测有文档未选择状态

**Level**: Unit  
**Priority**: P1  
**Requirement**: AC4 - 显示选择文档提示

**测试场景**:
```
Given: 用户有文档但未选择
When: EmptyState 组件渲染
Then: 应该显示"请从左侧选择一个文档"提示
```

**实现提示**:
```typescript
it('should show document selection prompt for users with documents', async () => {
  mockFetch('/api/documents', { documents: [{ id: 1, name: 'test.pdf' }] });
  
  const { getByText } = render(<EmptyState hasDocuments={true} />);
  
  expect(getByText(/请从左侧选择/)).toBeInTheDocument();
});
```

---

#### 场景 1.10-UNIT-009: EmptyState 上传按钮导航

**Level**: Unit  
**Priority**: P1  
**Requirement**: AC4 - 上传按钮跳转到文档页面

**测试场景**:
```
Given: EmptyState 显示上传引导
When: 用户点击"上传文档"按钮
Then: 应该导航到 "/documents"
```

**实现提示**:
```typescript
it('should navigate to /documents when upload button clicked', async () => {
  const mockPush = jest.fn();
  mockUseRouter.mockReturnValue({ push: mockPush });
  mockFetch('/api/documents', { documents: [] });
  
  const { getByRole } = render(<EmptyState />);
  
  await waitFor(() => {
    expect(getByRole('button', { name: /上传文档/i })).toBeInTheDocument();
  });
  
  await userEvent.click(getByRole('button', { name: /上传文档/i }));
  
  expect(mockPush).toHaveBeenCalledWith('/documents');
});
```

---

#### 场景 1.10-INT-007: Chat 页面集成 EmptyState

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC4 - Chat 页面根据状态显示内容

**测试场景**:
```
Given: 用户访问 Chat 页面
When: 检查用户文档状态
Then: 根据不同状态显示正确内容
  - 无文档 → 上传引导
  - 有文档未选择 → 选择提示
  - 已选择文档 → 正常 Chat 界面
```

**实现提示**:
```typescript
describe('Chat Page Integration', () => {
  it('should show empty state for users with no documents', async () => {
    await clearUserDocuments('user@example.com');
    await loginAs('user@example.com');
    
    await page.goto('/chat');
    
    await expect(page.locator('h2')).toContainText('欢迎使用 DocQA');
  });
  
  it('should show chat interface when document is selected', async () => {
    await loginAs('user@example.com');
    await page.goto('/chat?doc=1');
    
    await expect(page.locator('[data-testid="chat-input"]')).toBeVisible();
  });
});
```

---

### AC5: 重构应用路由结构

#### 场景 1.10-INT-008: (app) 路由组认证保护

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC5 - 所有 (app) 路由受认证保护

**测试场景**:
```
Given: 用户未登录
When: 用户访问 (app) 路由组内的任何页面
Then: 应该重定向到 "/login"
And: 登录后应该回到原始目标页面
```

**实现提示**:
```typescript
describe('(app) Route Group Auth Protection', () => {
  it('should protect all (app) routes from unauthenticated access', async () => {
    const protectedRoutes = ['/chat', '/documents', '/settings'];
    
    for (const route of protectedRoutes) {
      const response = await fetch(route, { redirect: 'manual' });
      
      expect(response.status).toBe(307); // Redirect
      expect(response.headers.get('location')).toContain('/login');
    }
  });
  
  it('should redirect to original target after login', async () => {
    await page.goto('/documents');
    
    // 应该被重定向到登录页
    await page.waitForURL('**/login**');
    
    // 登录
    await fillLoginForm();
    await page.click('button[type="submit"]');
    
    // 应该回到 /documents
    await page.waitForURL('**/documents');
    expect(page.url()).toContain('/documents');
  });
});
```

**风险覆盖**: TECH-001（路由重构）, SEC-001（认证边界）

---

#### 场景 1.10-INT-009: (public) 路由组公开访问

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC5 - (public) 路由无需认证

**测试场景**:
```
Given: 用户未登录
When: 用户访问 (public) 路由组内的页面
Then: 应该可以正常访问
And: 不应该重定向到登录页
```

**实现提示**:
```typescript
it('should allow public access to (public) routes', async () => {
  const publicRoutes = ['/', '/login', '/register'];
  
  for (const route of publicRoutes) {
    const response = await fetch(route);
    
    expect(response.status).toBe(200);
    expect(response.url).not.toContain('/login');
  }
});
```

---

#### 场景 1.10-INT-010: (app)/layout.tsx 认证逻辑

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC5 - Layout 执行认证检查

**测试场景**:
```
Given: (app)/layout.tsx 被渲染
When: 检查用户会话
Then: 如果无会话，应该重定向到 "/login"
And: 如果有会话，应该渲染 AppHeader 和子页面
```

**实现提示**:
```typescript
describe('(app)/layout.tsx', () => {
  it('should redirect to login if no session', async () => {
    mockAuth.mockResolvedValue(null);
    
    const { redirect } = await import('next/navigation');
    render(await AppLayout({ children: <div>Test</div> }));
    
    expect(redirect).toHaveBeenCalledWith('/login');
  });
  
  it('should render AppHeader and children if session exists', async () => {
    mockAuth.mockResolvedValue(mockSession);
    
    const { getByText } = render(
      await AppLayout({ children: <div>Test Content</div> })
    );
    
    expect(getByText('文档')).toBeInTheDocument(); // AppHeader
    expect(getByText('Test Content')).toBeInTheDocument(); // Children
  });
});
```

**风险覆盖**: TECH-003（认证逻辑迁移）

---

#### 场景 1.10-E2E-002: 完整路由导航流程

**Level**: E2E  
**Priority**: P0  
**Requirement**: AC5 - 路由导航正常工作

**测试场景**:
```
Given: 用户已登录
When: 用户在不同页面间导航
Then: 所有页面应该正常加载
And: AppHeader 始终显示
And: 页面内容正确渲染
```

**实现提示**:
```typescript
it('should navigate between all authenticated pages', async () => {
  await loginAs('user@example.com');
  
  // Chat → Documents
  await page.goto('/chat');
  await page.click('text=文档');
  await page.waitForURL('**/documents');
  expect(await page.locator('h1').textContent()).toContain('文档');
  
  // Documents → Settings
  await page.click('[aria-label="user menu"]');
  await page.click('text=账户设置');
  await page.waitForURL('**/settings');
  expect(await page.locator('h1').textContent()).toContain('设置');
  
  // Settings → Chat (via logo)
  await page.click('[aria-label="logo"]');
  await page.waitForURL('**/chat');
  expect(page.url()).toContain('/chat');
});
```

---

### AC6: 根路径智能重定向

#### 场景 1.10-INT-011: 已登录用户根路径重定向

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC6 - 已登录 → /chat

**测试场景**:
```
Given: 用户已登录
When: 用户访问根路径 "/"
Then: 应该重定向到 "/chat"
```

**实现提示**:
```typescript
it('should redirect authenticated users to /chat from root', async () => {
  const session = await signIn('user@example.com');
  const response = await fetch('/');
  
  expect(response.url).toContain('/chat');
});
```

---

#### 场景 1.10-INT-012: 未登录用户根路径显示 Landing Page

**Level**: Integration  
**Priority**: P0  
**Requirement**: AC6 - 未登录 → Landing Page

**测试场景**:
```
Given: 用户未登录
When: 用户访问根路径 "/"
Then: 应该显示 Landing Page（HeroSection）
And: 不应该重定向
```

**实现提示**:
```typescript
it('should show landing page for unauthenticated users', async () => {
  const response = await fetch('/');
  const html = await response.text();
  
  expect(response.status).toBe(200);
  expect(html).toContain('HeroSection'); // 或其他 Landing Page 标识
});
```

---

### AC7: 文档管理页面独立化

#### 场景 1.10-E2E-003: 文档页面功能完整性

**Level**: E2E  
**Priority**: P1  
**Requirement**: AC7 - 文档管理功能正常

**测试场景**:
```
Given: 用户在 /documents 页面
When: 用户执行各种文档操作
Then: 所有功能应该正常工作
  - 文档列表显示
  - 上传文档
  - 重命名文档
  - 删除文档
```

**实现提示**:
```typescript
describe('Documents Page', () => {
  it('should display document list', async () => {
    await loginAs('user@example.com');
    await page.goto('/documents');
    
    await expect(page.locator('[data-testid="document-list"]')).toBeVisible();
  });
  
  it('should upload document', async () => {
    await page.click('button:has-text("上传")');
    await page.setInputFiles('input[type="file"]', 'tests/fixtures/test.pdf');
    await page.click('button:has-text("确认上传")');
    
    await expect(page.locator('text=test.pdf')).toBeVisible();
  });
});
```

---

#### 场景 1.10-INT-013: Documents 页面与 Chat 页面互相导航

**Level**: Integration  
**Priority**: P1  
**Requirement**: AC7 - 页面间导航流畅

**测试场景**:
```
Given: 用户在 Chat 页面
When: 用户点击"文档"导航
Then: 应该跳转到 /documents
And: 可以从 /documents 回到 Chat
```

**实现提示**:
```typescript
it('should navigate between chat and documents', async () => {
  await page.goto('/chat');
  await page.click('text=文档');
  await page.waitForURL('**/documents');
  
  await page.click('[aria-label="logo"]');
  await page.waitForURL('**/chat');
});
```

---

### AC8: Settings页面简化

#### 场景 1.10-INT-014: Settings 页面使用 AppHeader

**Level**: Integration  
**Priority**: P1  
**Requirement**: AC8 - Settings 使用统一导航

**测试场景**:
```
Given: 用户在 /settings 页面
When: 页面加载完成
Then: 应该显示 AppHeader
And: 不应该有独立的 Header
And: 所有设置功能正常工作
```

**实现提示**:
```typescript
it('should render Settings with AppHeader', async () => {
  await page.goto('/settings');
  
  // 验证 AppHeader 存在
  await expect(page.locator('header >> text=文档')).toBeVisible();
  
  // 验证设置功能
  await expect(page.locator('h1')).toContainText('账户设置');
});
```

---

#### 场景 1.10-E2E-004: Settings 页面功能完整性

**Level**: E2E  
**Priority**: P2  
**Requirement**: AC8 - Settings 功能不受影响

**测试场景**:
```
Given: 用户在 /settings 页面
When: 用户修改个人信息
Then: 修改应该成功保存
And: 其他功能（密码修改、账户删除）正常
```

---

## 组件重构相关测试

### ChatWithHistory 组件重构

#### 场景 1.10-UNIT-010: ChatWithHistory 无内部 Header

**Level**: Unit  
**Priority**: P0  
**Requirement**: 组件重构 - 移除内部 Header

**测试场景**:
```
Given: ChatWithHistory 组件被渲染
When: 组件加载完成
Then: 不应该包含内部 Header 元素
And: 核心功能（对话、历史、侧边栏）正常工作
```

**实现提示**:
```typescript
// tests/unit/chat/ChatWithHistory.test.tsx
describe('ChatWithHistory Refactor', () => {
  it('should not render internal header', () => {
    const { container } = render(<ChatWithHistory />);
    
    const header = container.querySelector('[data-testid="chat-internal-header"]');
    expect(header).toBeNull();
  });
  
  it('should still render sidebar and chat interface', () => {
    const { getByTestId } = render(<ChatWithHistory />);
    
    expect(getByTestId('chat-sidebar')).toBeInTheDocument();
    expect(getByTestId('chat-input')).toBeInTheDocument();
  });
});
```

**风险覆盖**: TECH-002（组件依赖关系）

---

#### 场景 1.10-INT-015: ChatWithHistory 在新布局下正常工作

**Level**: Integration  
**Priority**: P0  
**Requirement**: 组件重构 - 集成测试

**测试场景**:
```
Given: ChatWithHistory 在新的 AppLayout 中
When: 用户进行对话操作
Then: 所有功能正常
  - 创建新对话
  - 发送消息
  - 切换文档
  - 查看历史
```

**实现提示**:
```typescript
describe('ChatWithHistory Integration', () => {
  it('should work correctly in new layout', async () => {
    await page.goto('/chat');
    
    // 创建对话
    await page.click('[data-testid="new-conversation"]');
    
    // 发送消息
    await page.fill('[data-testid="chat-input"]', 'Hello');
    await page.click('[data-testid="send-button"]');
    
    // 验证响应
    await expect(page.locator('.message')).toContainText('Hello');
  });
});
```

---

## 性能和可靠性测试

#### 场景 1.10-PERF-001: EmptyState 文档检查性能

**Level**: Integration  
**Priority**: P2  
**Requirement**: 性能 - 首次加载不延迟

**测试场景**:
```
Given: 用户访问 Chat 页面
When: EmptyState 检查用户文档
Then: API 调用应该在 500ms 内完成
And: 页面应该快速显示内容
```

**实现提示**:
```typescript
it('should check documents quickly', async () => {
  const startTime = Date.now();
  
  await page.goto('/chat');
  await page.waitForSelector('[data-testid="empty-state"]');
  
  const loadTime = Date.now() - startTime;
  expect(loadTime).toBeLessThan(500);
});
```

**风险覆盖**: PERF-001（首次访问延迟）

---

#### 场景 1.10-INT-016: 路由切换性能

**Level**: Integration  
**Priority**: P2  
**Requirement**: 性能 - 导航流畅

**测试场景**:
```
Given: 用户在应用内导航
When: 用户快速切换页面
Then: 每次导航应该在 1 秒内完成
And: 无明显延迟或卡顿
```

---

## 安全和认证测试

#### 场景 1.10-INT-017: 会话过期处理

**Level**: Integration  
**Priority**: P1  
**Requirement**: 安全 - 会话过期正确处理

**测试场景**:
```
Given: 用户在 Chat 页面
When: 用户会话过期
Then: 应该被重定向到登录页
And: 登录后应该回到 Chat
```

**实现提示**:
```typescript
it('should handle session expiry correctly', async () => {
  await loginAs('user@example.com');
  await page.goto('/chat');
  
  // 模拟会话过期
  await expireSession();
  
  // 尝试操作（触发认证检查）
  await page.reload();
  
  // 应该重定向到登录
  await page.waitForURL('**/login**');
});
```

**风险覆盖**: SEC-001（认证边界）

---

#### 场景 1.10-INT-018: 多标签页认证状态同步

**Level**: Integration  
**Priority**: P2  
**Requirement**: 安全 - 认证状态一致性

**测试场景**:
```
Given: 用户在多个标签页打开应用
When: 用户在一个标签页退出登录
Then: 所有标签页应该同步退出
And: 所有标签页重定向到登录页
```

---

## 回归测试

#### 场景 1.10-E2E-005: 核心功能完整回归

**Level**: E2E  
**Priority**: P0  
**Requirement**: 回归 - 现有功能不受影响

**测试场景**:
```
Given: 应用完成导航重构
When: 执行核心用户流程
Then: 所有功能正常
```

**关键流程**:
1. 登录 → Chat（对话功能）
2. 上传文档 → 选择文档 → 提问
3. 查看历史对话
4. 修改账户设置
5. 退出登录

**实现提示**:
```typescript
describe('Core Functionality Regression', () => {
  it('should complete full user journey', async () => {
    // 1. 登录
    await page.goto('/login');
    await fillLoginForm();
    await page.click('button[type="submit"]');
    await page.waitForURL('**/chat');
    
    // 2. 上传文档
    await page.click('text=文档');
    await uploadDocument('test.pdf');
    
    // 3. 回到 Chat 并选择文档
    await page.click('[aria-label="logo"]');
    await selectDocument('test.pdf');
    
    // 4. 发送消息
    await sendMessage('What is this document about?');
    await expectResponse();
    
    // 5. 访问设置
    await page.click('[aria-label="user menu"]');
    await page.click('text=账户设置');
    await page.waitForURL('**/settings');
    
    // 6. 退出登录
    await page.click('[aria-label="user menu"]');
    await page.click('text=退出登录');
    await page.waitForURL('**/login');
  });
});
```

**风险覆盖**: OPS-001（回滚困难）

---

## 浏览器导航和边界测试

#### 场景 1.10-E2E-006: 浏览器后退/前进按钮

**Level**: E2E  
**Priority**: P1  
**Requirement**: 导航 - 浏览器按钮正常工作

**测试场景**:
```
Given: 用户在应用内进行了多次导航
When: 用户使用浏览器后退/前进按钮
Then: 应该正确导航到历史页面
And: 页面状态正确恢复
```

**实现提示**:
```typescript
it('should handle browser back/forward navigation', async () => {
  await page.goto('/chat');
  await page.goto('/documents');
  await page.goto('/settings');
  
  // 后退
  await page.goBack();
  expect(page.url()).toContain('/documents');
  
  // 再后退
  await page.goBack();
  expect(page.url()).toContain('/chat');
  
  // 前进
  await page.goForward();
  expect(page.url()).toContain('/documents');
});
```

---

#### 场景 1.10-E2E-007: 页面刷新状态保持

**Level**: E2E  
**Priority**: P1  
**Requirement**: 可靠性 - 刷新不丢失状态

**测试场景**:
```
Given: 用户在 Chat 页面选择了文档
When: 用户刷新页面
Then: 选择的文档应该保持
And: 对话历史应该恢复
```

---

#### 场景 1.10-E2E-008: 直接 URL 访问

**Level**: E2E  
**Priority**: P1  
**Requirement**: 路由 - 直接访问正常

**测试场景**:
```
Given: 用户已登录
When: 用户在地址栏直接输入 URL
Then: 应该正确加载目标页面
```

**测试 URLs**:
- `/chat`
- `/chat?doc=123`
- `/documents`
- `/settings`

---

## 响应式和可访问性测试

#### 场景 1.10-E2E-009: 移动端导航

**Level**: E2E  
**Priority**: P2  
**Requirement**: 响应式 - 移动端正常工作

**测试场景**:
```
Given: 用户使用移动设备
When: 用户访问应用
Then: AppHeader 应该适配移动端
And: 所有导航功能正常
```

---

#### 场景 1.10-UNIT-011: AppHeader 可访问性

**Level**: Unit  
**Priority**: P2  
**Requirement**: 可访问性 - 符合 WCAG 标准

**测试场景**:
```
Given: AppHeader 组件渲染
When: 运行可访问性检查
Then: 应该无 a11y 错误
And: 键盘导航正常工作
```

**实现提示**:
```typescript
it('should have no accessibility violations', async () => {
  const { container } = render(<AppHeader />);
  const results = await axe(container);
  
  expect(results).toHaveNoViolations();
});
```

---

## 错误处理和边界测试

#### 场景 1.10-INT-019: API 失败处理

**Level**: Integration  
**Priority**: P1  
**Requirement**: 可靠性 - 优雅降级

**测试场景**:
```
Given: EmptyState 检查文档
When: API 调用失败
Then: 应该显示默认内容
And: 不应该阻塞页面加载
```

**实现提示**:
```typescript
it('should handle document check API failure gracefully', async () => {
  mockFetch('/api/documents', { error: 'Server error' }, { status: 500 });
  
  const { getByText } = render(<EmptyState />);
  
  // 应该回退到显示示例问题
  await waitFor(() => {
    expect(getByText(/示例问题/)).toBeInTheDocument();
  });
});
```

---

#### 场景 1.10-E2E-010: 网络错误恢复

**Level**: E2E  
**Priority**: P2  
**Requirement**: 可靠性 - 网络问题恢复

**测试场景**:
```
Given: 用户在使用应用时遇到网络错误
When: 网络恢复
Then: 应用应该自动恢复
And: 用户可以继续操作
```

---

## 首次登录引导测试

#### 场景 1.10-UNIT-012: FirstLoginGuide 组件

**Level**: Unit  
**Priority**: P1  
**Requirement**: 用户体验 - 首次登录引导

**测试场景**:
```
Given: 用户首次登录后导航变化
When: FirstLoginGuide 组件显示
Then: 应该解释新的导航结构
And: 用户可以关闭引导
And: 关闭后不再显示
```

**实现提示**:
```typescript
// tests/unit/onboarding/FirstLoginGuide.test.tsx
describe('FirstLoginGuide', () => {
  it('should show guide for first-time users', () => {
    localStorage.removeItem('seen_new_nav_guide');
    
    const { getByText } = render(<FirstLoginGuide />);
    
    expect(getByText('导航升级')).toBeInTheDocument();
    expect(getByText(/直达对话/)).toBeInTheDocument();
  });
  
  it('should not show guide after dismissed', async () => {
    localStorage.setItem('seen_new_nav_guide', 'true');
    
    const { queryByText } = render(<FirstLoginGuide />);
    
    expect(queryByText('导航升级')).not.toBeInTheDocument();
  });
});
```

**风险覆盖**: BUS-001（用户流程中断）

---

## 测试执行顺序建议

### Phase 1: 核心路由和认证（P0）

**必须全部通过才能继续**:

1. `1.10-INT-008` - (app) 路由认证保护
2. `1.10-INT-009` - (public) 路由公开访问
3. `1.10-INT-010` - Layout 认证逻辑
4. `1.10-INT-001` - 根路径重定向到 /chat
5. `1.10-INT-011` - 已登录用户根路径重定向
6. `1.10-INT-012` - 未登录用户显示 Landing Page
7. `1.10-INT-002` - 登录后跳转 /chat
8. `1.10-INT-003` - 注册后跳转 /chat
9. `1.10-INT-004` - Dashboard 重定向

### Phase 2: 组件功能（P0）

10. `1.10-UNIT-001` - AppHeader 渲染
11. `1.10-INT-005` - AppHeader 在所有页面显示
12. `1.10-UNIT-004` - UserMenu 渲染
13. `1.10-UNIT-006` - UserMenu 退出功能
14. `1.10-UNIT-007` - EmptyState 无文档状态
15. `1.10-UNIT-010` - ChatWithHistory 无内部 Header
16. `1.10-INT-015` - ChatWithHistory 集成测试

### Phase 3: 端到端流程（P0）

17. `1.10-E2E-001` - Chat 首次访问友好
18. `1.10-E2E-002` - 完整路由导航流程
19. `1.10-E2E-005` - 核心功能完整回归

### Phase 4: 重要功能（P1）

20-28. 其他 P1 测试

### Phase 5: 优化和边界（P2）

29-38. P2 测试

---

## 测试覆盖率要求

### 代码覆盖率目标

- **整体覆盖率**: 80%+
- **路由逻辑**: 100%（关键路径）
- **认证逻辑**: 100%（安全关键）
- **AppHeader 组件**: 90%+
- **UserMenu 组件**: 85%+
- **ChatWithHistory**: 80%+（核心功能）
- **EmptyState**: 85%+

### AC 覆盖率

| AC | 场景数 | P0 | P1 | P2 | 覆盖率 |
|----|--------|----|----|----|----|
| AC1 | 5 | 4 | 1 | 0 | ✅ 完整 |
| AC2 | 4 | 2 | 2 | 0 | ✅ 完整 |
| AC3 | 4 | 2 | 1 | 1 | ✅ 完整 |
| AC4 | 4 | 2 | 2 | 0 | ✅ 完整 |
| AC5 | 4 | 4 | 0 | 0 | ✅ 完整 |
| AC6 | 2 | 2 | 0 | 0 | ✅ 完整 |
| AC7 | 2 | 0 | 2 | 0 | ✅ 完整 |
| AC8 | 2 | 0 | 1 | 1 | ✅ 完整 |

**总计**: 所有 AC 都有充分的测试覆盖

---

## 风险覆盖矩阵

| 风险 ID | 相关测试场景 | 覆盖程度 |
|---------|-------------|---------|
| TECH-001 | INT-008, INT-009, INT-010, E2E-002 | ✅ 完整 |
| TECH-002 | UNIT-010, INT-015 | ✅ 完整 |
| TECH-003 | INT-010, INT-017 | ✅ 完整 |
| BUS-001 | E2E-001, INT-002, INT-003, UNIT-012 | ✅ 完整 |
| DATA-001 | INT-004 | ✅ 完整 |
| PERF-001 | PERF-001 | ✅ 完整 |
| SEC-001 | INT-017, INT-018 | ✅ 完整 |
| OPS-001 | E2E-005 | ⚠️ 部分 |

---

## 测试工具和框架

### 推荐技术栈

**Unit Tests**:
- Jest
- React Testing Library
- @testing-library/user-event

**Integration Tests**:
- Jest
- Supertest (API 测试)
- MSW (Mock Service Worker)

**E2E Tests**:
- Playwright
- @playwright/test

**其他工具**:
- axe-core (可访问性测试)
- jest-axe
- Lighthouse (性能测试)

---

## 测试数据需求

### Test Fixtures

```typescript
// tests/fixtures/users.ts
export const testUsers = {
  newUser: {
    email: 'newuser@example.com',
    password: 'Test123!',
    hasDocuments: false,
  },
  existingUser: {
    email: 'user@example.com',
    password: 'Test123!',
    hasDocuments: true,
  },
};

// tests/fixtures/documents.ts
export const testDocuments = [
  { id: 1, name: 'test.pdf', size: 1024 },
  { id: 2, name: 'guide.docx', size: 2048 },
];
```

---

## CI/CD 集成建议

### Pipeline 阶段

```yaml
test:
  stages:
    - lint
    - unit
    - integration
    - e2e
    - coverage

  lint:
    - npm run lint
    - npm run type-check

  unit:
    - npm run test:unit
    - coverage threshold: 80%

  integration:
    - npm run test:integration
    - P0 tests must pass

  e2e:
    - npm run test:e2e
    - P0 tests must pass
    - artifacts: screenshots, videos

  coverage:
    - generate coverage report
    - upload to codecov
```

---

## 成功标准

### 部署前必须满足

- ✅ 所有 P0 测试通过（18/18）
- ✅ 路由测试覆盖率 100%
- ✅ 认证测试覆盖率 100%
- ✅ 整体代码覆盖率 > 80%
- ✅ 无高优先级 linter 错误
- ✅ 所有 E2E 关键路径通过

### 建议满足

- ⭐ P1 测试通过率 > 90%
- ⭐ 组件单元测试覆盖率 > 85%
- ⭐ 无可访问性错误
- ⭐ Lighthouse 性能分数 > 90

---

## 总结

这个测试设计为 Story 1.10 的重大架构重构提供了全面的测试覆盖，包括：

✅ **38 个测试场景** 覆盖所有 8 个 AC  
✅ **风险驱动** 的优先级分配（18 个 P0 测试）  
✅ **多层次测试** (Unit 32% + Integration 42% + E2E 26%)  
✅ **完整的风险覆盖** 特别是高风险项 TECH-001  
✅ **明确的执行顺序** 和成功标准

**关键建议**:
1. 先执行所有 P0 测试（Phase 1-3）
2. P0 测试 100% 通过是部署的前提
3. 重点关注路由和认证测试（安全关键）
4. 使用 CI/CD 自动化执行
5. 保持测试覆盖率 > 80%

---

**测试设计完成日期**: 2025-01-08  
**下一步**: 实施测试并执行

