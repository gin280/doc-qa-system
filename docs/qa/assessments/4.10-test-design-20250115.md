# Test Design: Story 4.10 - E2E 集成测试

Date: 2025-01-15
Designer: Quinn (Test Architect)
Story: 4.10 - E2E 集成测试

---

## Test Strategy Overview

### 综合评估

**测试范围分析**:
- 这是一个**元测试Story**,目标是为系统构建E2E测试框架
- 测试对象不是生产代码,而是**测试基础设施本身**
- 需要验证E2E测试能够正确验证完整业务流程

**测试层级分布**:
- **单元测试**: 30% - 测试E2E辅助函数和工具
- **集成测试**: 70% - 验证E2E测试框架的实际运行
- **E2E测试**: N/A - 这个Story本身就是在构建E2E测试

**优先级分布**:
- **P0**: 75% - 核心E2E测试框架和完整流程
- **P1**: 20% - 边界情况和性能基准
- **P2**: 5% - 可选的CI/CD集成和监控

**总测试场景**: 21个
- 单元测试场景: 6个
- 集成测试场景: 15个

---

## Test Scenarios by Acceptance Criteria

### AC1: 完整问答流程 E2E 测试 ✅

**覆盖目标**: 验证完整的"上传→解析→分块→向量化→检索→生成"流程

#### 场景设计

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 4.10-UNIT-001 | Unit | P0 | E2E辅助函数 - setupE2ETest() | 验证测试环境初始化逻辑,确保用户创建和清理机制正确 |
| 4.10-UNIT-002 | Unit | P0 | E2E辅助函数 - cleanup() | 验证清理逻辑能够正确删除所有测试数据(DB + Storage) |
| 4.10-UNIT-003 | Unit | P0 | E2E辅助函数 - waitForDocumentReady() | 验证轮询机制和超时处理,确保不会无限等待 |
| 4.10-INT-001 | Integration | P0 | 完整流程 - 文档上传到Storage | 验证文件能正确上传到Supabase Storage,返回documentId |
| 4.10-INT-002 | Integration | P0 | 完整流程 - 文档解析 | 验证PDF/DOCX解析正常,提取文本内容 |
| 4.10-INT-003 | Integration | P0 | 完整流程 - 文档分块 | 验证chunks正确生成,数量合理,chunkIndex连续 |
| 4.10-INT-004 | Integration | P0 | 完整流程 - 向量化 | 验证每个chunk的embedding正确生成(1536维),存储到pgvector |
| 4.10-INT-005 | Integration | P0 | 完整流程 - 首次查询(缓存未命中) | 验证查询向量化→检索→LLM生成的完整链路,时间<3秒 |
| 4.10-INT-006 | Integration | P0 | 完整流程 - 后续查询(缓存命中) | 验证Query Embedding缓存生效,响应时间<1秒 |
| 4.10-INT-007 | Integration | P0 | 完整流程 - 对话历史保存 | 验证conversations和messages表正确保存,支持多轮对话 |

**风险覆盖**:
- **RISK-E2E-001**: E2E测试环境污染 → cleanup()机制 + 唯一userId
- **RISK-E2E-002**: 文档处理超时 → waitForDocumentReady()轮询机制
- **RISK-E2E-003**: 缓存验证失败 → 明确区分缓存命中/未命中场景

---

### AC2: 边界情况 E2E 测试 ✅

**覆盖目标**: 验证E2E测试能够正确测试系统边界情况

#### 场景设计

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 4.10-INT-008 | Integration | P1 | 边界情况 - 空文档上传 | 验证E2E测试能检测到空文档被拒绝,返回400错误 |
| 4.10-INT-009 | Integration | P1 | 边界情况 - 超大文档(10MB) | 验证E2E测试能验证大文档处理,chunks数量限制(≤10000) |
| 4.10-INT-010 | Integration | P1 | 边界情况 - 不支持格式(.exe) | 验证E2E测试能检测到不支持格式被拒绝 |
| 4.10-INT-011 | Integration | P1 | 边界情况 - 无相关内容查询 | 验证E2E测试能检测到"无相关内容"的友好提示 |
| 4.10-INT-012 | Integration | P1 | 边界情况 - 并发查询 | 验证E2E测试能模拟并发场景,检测资源冲突 |

**风险覆盖**:
- **RISK-E2E-004**: 边界测试不全面 → 覆盖5种典型边界情况
- **RISK-E2E-005**: 并发问题难以重现 → Promise.all()模拟真实并发

---

### AC3: 性能基准 E2E 测试 ✅

**覆盖目标**: 验证E2E测试能够进行性能基准验证

#### 场景设计

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 4.10-INT-013 | Integration | P1 | 性能基准 - 文档上传(1MB) | 验证E2E测试能准确计时,检测上传性能<2秒 |
| 4.10-INT-014 | Integration | P1 | 性能基准 - 文档处理(1MB) | 验证E2E测试能轮询等待,检测处理性能<30秒 |
| 4.10-INT-015 | Integration | P1 | 性能基准 - 首次查询 | 验证E2E测试能检测查询性能<3秒 |
| 4.10-INT-016 | Integration | P1 | 性能基准 - 缓存命中查询 | 验证E2E测试能检测缓存加速效果<1秒 |

**风险覆盖**:
- **RISK-E2E-006**: 性能测试不稳定 → 多次运行取平均值
- **RISK-E2E-007**: CI环境性能波动 → 提供Mock选项

---

### AC4: 数据清理和测试隔离 ✅

**覆盖目标**: 验证E2E测试的清理机制和隔离性

#### 场景设计

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 4.10-UNIT-004 | Unit | P0 | 测试隔离 - 唯一userId生成 | 验证每次测试使用不同的timestamp-based userId |
| 4.10-UNIT-005 | Unit | P0 | 数据清理 - 数据库记录删除 | 验证cleanup()能删除users,级联删除documents/chunks/conversations |
| 4.10-UNIT-006 | Unit | P0 | 数据清理 - Storage文件删除 | 验证cleanup()能删除Supabase Storage中的测试文件 |
| 4.10-INT-017 | Integration | P0 | 清理机制 - 测试成功后清理 | 验证afterAll中的cleanup在测试通过后执行 |
| 4.10-INT-018 | Integration | P0 | 清理机制 - 测试失败后清理 | 验证try-finally确保测试失败也能清理 |
| 4.10-INT-019 | Integration | P1 | 手动清理脚本 | 验证cleanup-e2e-test-data.ts能手动清理遗留数据 |

**风险覆盖**:
- **RISK-E2E-008**: 测试数据泄漏 → 自动清理 + 手动清理脚本
- **RISK-E2E-009**: 测试隔离失败 → 唯一userId + timestamp

---

### AC5: CI/CD 集成 ✅

**覆盖目标**: 验证E2E测试能在CI/CD环境中运行

#### 场景设计

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 4.10-INT-020 | Integration | P2 | CI配置 - npm run test:e2e | 验证package.json脚本配置正确,能独立运行E2E测试 |
| 4.10-INT-021 | Integration | P2 | CI配置 - 环境变量支持 | 验证E2E测试能从环境变量读取配置(DATABASE_URL, SUPABASE_*, OPENAI_API_KEY) |

**风险覆盖**:
- **RISK-E2E-010**: CI环境配置缺失 → 环境变量检查和友好错误提示
- **RISK-E2E-011**: LLM配额耗尽 → MOCK_LLM选项

---

## Critical Gaps Analysis

### 测试覆盖缺口

**已覆盖**:
- ✅ 完整业务流程验证(AC1)
- ✅ 边界情况测试(AC2)
- ✅ 性能基准验证(AC3)
- ✅ 数据清理机制(AC4)
- ✅ CI/CD集成(AC5)

**需要增强的领域**:

1. **错误恢复测试** (建议添加):
   - 场景: 文档处理失败后的状态回滚
   - 场景: LLM API调用失败的降级处理
   - 优先级: P2

2. **安全性测试** (建议添加):
   - 场景: 未授权用户访问他人文档
   - 场景: SQL注入/XSS攻击防护
   - 优先级: P2

3. **可观测性测试** (建议添加):
   - 场景: 日志正确记录关键步骤
   - 场景: 错误堆栈追踪完整
   - 优先级: P3

### 测试数据管理

**测试固件需求**:
```
tests/fixtures/
├── pdf/
│   ├── empty.pdf           # 0 KB - 空文档测试
│   ├── 1mb.pdf             # ~1 MB - 标准性能测试
│   ├── 10mb.pdf            # ~10 MB - 超大文档测试
│   ├── normal-adobe.pdf    # 已有 - 正常流程测试
│   └── technical-doc.pdf   # 新增 - 无相关内容测试
├── docx/
│   └── empty.docx          # 空DOCX测试
└── text/
    └── empty.txt           # 已有 - 空文本测试
```

---

## Risk-Based Testing Strategy

### 高风险区域优先测试

**P0 测试场景** (必须在Sprint内完成):
1. 完整流程E2E测试 (4.10-INT-001 ~ 007)
2. 测试环境清理机制 (4.10-UNIT-004 ~ 006, 4.10-INT-017 ~ 018)
3. E2E辅助函数正确性 (4.10-UNIT-001 ~ 003)

**P1 测试场景** (高价值,尽量完成):
1. 边界情况覆盖 (4.10-INT-008 ~ 012)
2. 性能基准验证 (4.10-INT-013 ~ 016)
3. 手动清理脚本 (4.10-INT-019)

**P2 测试场景** (时间允许可完成):
1. CI/CD集成 (4.10-INT-020 ~ 021)
2. 错误恢复测试
3. 安全性测试

---

## Test Execution Recommendations

### 执行顺序

**阶段1: 基础设施验证** (Day 1-2)
1. 实现并测试E2E辅助函数 (UNIT-001 ~ 003)
2. 验证测试隔离和清理机制 (UNIT-004 ~ 006)

**阶段2: 核心流程测试** (Day 2-3)
1. 实现完整流程E2E测试 (INT-001 ~ 007)
2. 验证每个步骤的数据正确性

**阶段3: 边界和性能** (Day 3-4)
1. 实现边界情况测试 (INT-008 ~ 012)
2. 实现性能基准测试 (INT-013 ~ 016)

**阶段4: 清理和CI** (Day 4-5)
1. 验证清理机制 (INT-017 ~ 019)
2. 配置CI/CD集成 (INT-020 ~ 021)

### 测试环境要求

**最低环境**:
- Supabase Database (测试实例)
- Supabase Storage (测试bucket)
- Redis (Upstash测试实例)
- OpenAI API Key (可选,支持Mock)

**环境变量**:
```bash
# 数据库
DATABASE_URL=<test-db-url>

# Supabase
SUPABASE_URL=<supabase-url>
SUPABASE_SERVICE_KEY=<service-key>

# LLM
OPENAI_API_KEY=<api-key>
MOCK_LLM=false  # 设为true使用Mock

# Redis
REDIS_URL=<upstash-redis-url>
```

---

## Quality Indicators

### 测试成功标准

**功能正确性**:
- ✅ 所有P0测试场景通过率 100%
- ✅ 所有P1测试场景通过率 ≥ 90%
- ✅ 每个AC至少有2个测试场景覆盖

**测试质量**:
- ✅ E2E测试执行时间 ≤ 10分钟 (不含性能测试)
- ✅ 测试隔离性:每个测试独立运行,不依赖执行顺序
- ✅ 清理完整性:测试后数据库无遗留数据

**文档完整性**:
- ✅ 每个测试有清晰的注释说明意图
- ✅ E2E测试使用文档更新到testing/strategy.md
- ✅ 辅助函数有JSDoc注释

---

## Red Flags to Watch For

### 开发阶段警告信号

**🚩 架构问题**:
- E2E测试运行时间 > 15分钟 → 需要优化或并行化
- cleanup()执行失败但测试通过 → 清理逻辑有bug
- 测试在本地通过但CI失败 → 环境差异或并发问题

**🚩 测试设计问题**:
- 测试频繁超时 → waitForDocumentReady()轮询间隔太短
- 测试结果不稳定 → 存在竞态条件或共享状态
- Mock LLM响应与真实LLM差异大 → Mock实现不真实

**🚩 数据清理问题**:
- 数据库有e2e-user-*遗留数据 → afterAll未执行或清理失败
- Storage有e2e-*遗留文件 → Storage清理逻辑缺失
- Redis有qv:*遗留缓存 → 可选清理,但注意TTL

---

## Integration with Quality Gates

### Gate判定标准

**测试设计完成度**:
- ✅ 所有AC有对应测试场景
- ✅ 测试级别分配合理(unit/integration)
- ✅ 优先级分配基于风险评估

**执行后Gate判定**:
```yaml
# 预期Gate结果
test_design:
  scenarios_total: 21
  by_level:
    unit: 6
    integration: 15
    e2e: 0  # 这是构建E2E测试的Story
  by_priority:
    p0: 16
    p1: 9
    p2: 2
  coverage_gaps: []  # 所有AC都有测试覆盖

gate_prediction: PASS
reasoning: 测试设计覆盖所有AC,测试级别分配合理,优先级基于风险评估
```

**失败条件**:
- 任何AC缺少测试场景 → Gate: FAIL
- P0测试通过率 < 100% → Gate: FAIL
- 数据清理机制缺失 → Gate: CONCERNS
- 测试执行时间 > 20分钟 → Gate: CONCERNS

---

## Maintenance Considerations

### 长期维护建议

**测试维护成本**:
- **低成本**: E2E辅助函数(稳定,很少改动)
- **中成本**: 完整流程测试(需随API变化更新)
- **高成本**: 边界情况测试(需持续发现新边界)

**维护触发条件**:
1. API接口变更 → 更新executeQuery()等辅助函数
2. 数据库Schema变更 → 更新cleanup()清理逻辑
3. 新增边界情况 → 添加新的边界测试场景
4. 性能目标调整 → 更新性能基准值

**持续改进建议**:
- 每月review E2E测试覆盖,发现新的边界情况
- 监控E2E测试执行时间,超过10分钟需优化
- 定期清理测试数据,验证cleanup机制有效性

---

## 附录: 测试场景详细说明

### 单元测试场景

#### 4.10-UNIT-001: setupE2ETest()
**测试内容**:
- 创建唯一的userId (基于timestamp)
- 创建测试用户到数据库
- 返回正确的E2ETestContext对象
- 验证cleanup函数存在

**测试数据**:
```typescript
const context = await setupE2ETest()
expect(context.userId).toMatch(/^e2e-user-\d+$/)
expect(context.userEmail).toMatch(/^e2e-\d+@example\.com$/)
expect(context.cleanup).toBeDefined()
```

#### 4.10-UNIT-002: cleanup()
**测试内容**:
- 删除测试用户(级联删除documents/chunks/conversations)
- 删除Supabase Storage文件
- 处理不存在的资源(不报错)

**验证方法**:
```typescript
await context.cleanup()
const users = await db.select().from(users).where(eq(users.id, context.userId))
expect(users.length).toBe(0)
```

#### 4.10-UNIT-003: waitForDocumentReady()
**测试内容**:
- 轮询检查document status
- status='ready'时返回
- status='failed'时抛出错误
- 超时后抛出错误

**Mock策略**:
```typescript
// Mock API response: 'processing' → 'processing' → 'ready'
jest.spyOn(request, 'get')
  .mockResolvedValueOnce({ body: { status: 'processing' } })
  .mockResolvedValueOnce({ body: { status: 'processing' } })
  .mockResolvedValueOnce({ body: { status: 'ready' } })
```

### 集成测试场景

#### 4.10-INT-001: 文档上传到Storage
**测试内容**:
- 调用POST /api/documents/upload
- 验证返回documentId和filename
- 验证文件存在于Supabase Storage

**测试文件**: `tests/fixtures/pdf/normal-adobe.pdf`

#### 4.10-INT-005: 首次查询(缓存未命中)
**测试内容**:
- 清空Redis缓存
- 发起查询
- 验证查询向量化 → 相似度检索 → LLM生成
- 验证响应时间 < 3秒
- 验证缓存Key存在于Redis

**验证方法**:
```typescript
// 清空缓存
await redis.del(`qv:${hash(query)}`)

const startTime = Date.now()
const result = await executeQuery(userId, documentId, query)
const duration = Date.now() - startTime

expect(duration).toBeLessThan(3000)
expect(result.answer).toBeDefined()

// 验证缓存已生成
const cacheValue = await redis.get(`qv:${hash(query)}`)
expect(cacheValue).toBeDefined()
```

---

**文档生成时间**: 2025-01-15  
**下次更新**: Story实现完成后,基于实际测试结果更新

