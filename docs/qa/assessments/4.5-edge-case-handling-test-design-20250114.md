# Test Design: Story 4.5

**Story**: 4.5 - è¾¹ç•Œæƒ…å†µå¤„ç†å¢å¼º  
**Date**: 2025-01-14  
**Designer**: Quinn (æµ‹è¯•æ¶æ„å¸ˆ)

---

## Test Strategy Overview

- **Total test scenarios**: 23
- **Unit tests**: 14 (61%)
- **Integration tests**: 9 (39%)
- **E2E tests**: 0 (0%)
- **Priority distribution**: 
  - P0: 16 (70%) - å…³é”®è¾¹ç•Œå¤„ç†
  - P1: 5 (22%) - Unicode å’Œæ—¥å¿—
  - P2: 2 (8%) - è¾¹ç•Œå€¼éªŒè¯

**æµ‹è¯•ç­–ç•¥**:
- âœ… **Shift-left approach**: ä¸»è¦ä¾èµ–å•å…ƒæµ‹è¯•å¿«é€ŸéªŒè¯è¾¹ç•Œé€»è¾‘
- âœ… **Integration tests**: éªŒè¯ç«¯åˆ°ç«¯é”™è¯¯å¤„ç†æµç¨‹å’Œæ•°æ®åº“çŠ¶æ€
- âœ… **No E2E tests**: è¾¹ç•Œå¤„ç†å±äºæœåŠ¡å±‚é€»è¾‘ï¼Œæ— éœ€ UI æµ‹è¯•
- âœ… **Risk-based prioritization**: é«˜é£é™©åœºæ™¯æ ‡è®°ä¸º P0

---

## Test Scenarios by Acceptance Criteria

### AC1: ç©ºæ–‡æ¡£æ£€æµ‹å’Œå¤„ç†

**éœ€æ±‚**: æ£€æµ‹å†…å®¹é•¿åº¦ä¸º 0 æˆ–ä»…åŒ…å«ç©ºç™½å­—ç¬¦ï¼ŒæŠ›å‡ºå‹å¥½é”™è¯¯å¹¶è®¾ç½® FAILED çŠ¶æ€

**é£é™©è¦†ç›–**: DATA-001 (åˆ†æ•° 4)

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 4.5-UNIT-001 | Unit | P0 | å®Œå…¨ç©ºæ–‡æ¡£æŠ›å‡ºé”™è¯¯ | çº¯é€»è¾‘éªŒè¯ï¼Œæ— ä¾èµ– | DATA-001 |
| 4.5-UNIT-002 | Unit | P0 | é”™è¯¯æ¶ˆæ¯ä¸º "æ–‡æ¡£å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¤„ç†" | éªŒè¯é”™è¯¯æ¶ˆæ¯å‹å¥½æ€§ | DATA-001 |
| 4.5-INT-001 | Integration | P0 | ç©ºæ–‡æ¡£ç«¯åˆ°ç«¯æµç¨‹è®¾ç½® FAILED çŠ¶æ€ | éªŒè¯æ•°æ®åº“çŠ¶æ€å˜æ›´ | DATA-001 |
| 4.5-INT-002 | Integration | P0 | metadata åŒ…å« EMPTY_CONTENT é”™è¯¯ç±»å‹ | éªŒè¯é”™è¯¯è®°å½•å®Œæ•´æ€§ | DATA-001 |

**æµ‹è¯•æ•°æ®**:
- ç©ºå­—ç¬¦ä¸²: `''`
- Null: `null`
- Undefined: `undefined`

**é¢„æœŸè¡Œä¸º**:
- æŠ›å‡º `ChunkingError`
- é”™è¯¯æ¶ˆæ¯: "æ–‡æ¡£å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¤„ç†"
- æ–‡æ¡£çŠ¶æ€: FAILED
- Metadata: `{ errorType: 'EMPTY_CONTENT' }`

---

### AC2: ç©ºç™½å­—ç¬¦æ–‡æ¡£æ£€æµ‹

**éœ€æ±‚**: æ£€æµ‹ä»…åŒ…å«ç©ºç™½å­—ç¬¦ï¼ˆç©ºæ ¼ã€æ¢è¡Œã€åˆ¶è¡¨ç¬¦ï¼‰çš„æ–‡æ¡£ï¼Œä½¿ç”¨ trim() åæ£€æŸ¥é•¿åº¦

**é£é™©è¦†ç›–**: DATA-001 (åˆ†æ•° 4)

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 4.5-UNIT-003 | Unit | P0 | ä»…ç©ºæ ¼æ–‡æ¡£æŠ›å‡ºé”™è¯¯ | éªŒè¯ trim() é€»è¾‘ | DATA-001 |
| 4.5-UNIT-004 | Unit | P0 | ä»…æ¢è¡Œç¬¦æ–‡æ¡£æŠ›å‡ºé”™è¯¯ | è¾¹ç•Œæƒ…å†µéªŒè¯ | DATA-001 |
| 4.5-UNIT-005 | Unit | P0 | æ··åˆç©ºç™½å­—ç¬¦æ–‡æ¡£æŠ›å‡ºé”™è¯¯ | ç»¼åˆç©ºç™½å­—ç¬¦æµ‹è¯• | DATA-001 |
| 4.5-INT-003 | Integration | P0 | ç©ºç™½æ–‡æ¡£ç«¯åˆ°ç«¯è¿”å›å‹å¥½é”™è¯¯ | ç”¨æˆ·ä½“éªŒéªŒè¯ | DATA-001 |

**æµ‹è¯•æ•°æ®**:
- ä»…ç©ºæ ¼: `'   '` (3ä¸ªç©ºæ ¼)
- ä»…æ¢è¡Œ: `'\n\n\n'`
- ä»…åˆ¶è¡¨ç¬¦: `'\t\t\t'`
- æ··åˆ: `' \n\t \n '`

**é¢„æœŸè¡Œä¸º**:
- ä¸ AC1 ç›¸åŒçš„é”™è¯¯å¤„ç†
- trim() åé•¿åº¦ä¸º 0

---

### AC3: è¶…å¤§æ–‡æ¡£é™åˆ¶

**éœ€æ±‚**: å®šä¹‰ MAX_CHUNKS = 10000ï¼Œè¶…è¿‡æ—¶æˆªæ–­å¹¶è®°å½•å‘Šè­¦ï¼Œåœ¨ metadata ä¸­æ ‡è®°

**é£é™©è¦†ç›–**: PERF-001 (åˆ†æ•° 6, HIGH)

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 4.5-UNIT-006 | Unit | P0 | è¶…è¿‡ 10000 chunks æ—¶æˆªæ–­åˆ° 10000 | æ ¸å¿ƒæˆªæ–­é€»è¾‘ | PERF-001 |
| 4.5-UNIT-007 | Unit | P0 | æˆªæ–­æ—¶è®°å½• WARN æ—¥å¿— | éªŒè¯æ—¥å¿—çº§åˆ«å’Œå†…å®¹ | PERF-001, OPS-001 |
| 4.5-UNIT-008 | Unit | P2 | æ°å¥½ 10000 chunks ä¸æˆªæ–­ | è¾¹ç•Œå€¼æµ‹è¯• | PERF-001 |
| 4.5-UNIT-009 | Unit | P2 | 9999 chunks ä¸æˆªæ–­ | è¾¹ç•Œå€¼æµ‹è¯•ï¼ˆä¸´ç•Œå€¼ä¸‹ï¼‰ | PERF-001 |
| 4.5-INT-004 | Integration | P0 | æˆªæ–­å metadata åŒ…å«å®Œæ•´ä¿¡æ¯ | éªŒè¯æ•°æ®å®Œæ•´æ€§ | PERF-001, DATA-003 |
| 4.5-INT-005 | Integration | P0 | è¶…å¤§æ–‡æ¡£ç«¯åˆ°ç«¯æˆåŠŸå¤„ç† | éªŒè¯ä¸ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒ | PERF-001 |

**æµ‹è¯•æ•°æ®**:
- è¶…é™æ–‡æ¡£: 15000 chunks (æ¨¡æ‹Ÿ 50MB PDF)
- è¾¹ç•Œæ–‡æ¡£: 10000 chunks
- ä¸´ç•Œæ–‡æ¡£: 9999 chunks

**é¢„æœŸè¡Œä¸º**:
- **15000 chunks**:
  - æˆªæ–­åˆ° 10000
  - WARN æ—¥å¿—åŒ…å«: `{ documentId, originalChunksCount: 15000, maxChunks: 10000 }`
  - Metadata: `{ chunking: { truncated: true, originalChunksCount: 15000, storedChunksCount: 10000 } }`
- **10000 chunks**: ä¸æˆªæ–­ï¼Œæ— å‘Šè­¦
- **9999 chunks**: ä¸æˆªæ–­ï¼Œæ— å‘Šè­¦

---

### AC4: å‘é‡ç»´åº¦éªŒè¯

**éœ€æ±‚**: åœ¨ embedding ç”ŸæˆåéªŒè¯ç»´åº¦ï¼ŒZhipuAI 1024, OpenAI 1536ï¼Œä¸åŒ¹é…æ—¶æŠ›å‡º DIMENSION_MISMATCH

**é£é™©è¦†ç›–**: DATA-002 (åˆ†æ•° 3)

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 4.5-UNIT-010 | Unit | P0 | ZhipuAI å‘é‡ç»´åº¦ 1024 é€šè¿‡éªŒè¯ | éªŒè¯æ­£ç¡®ç»´åº¦ | DATA-002 |
| 4.5-UNIT-011 | Unit | P0 | ZhipuAI å‘é‡ç»´åº¦ 1536 æŠ›å‡ºé”™è¯¯ | éªŒè¯é”™è¯¯ç»´åº¦æ£€æµ‹ | DATA-002 |
| 4.5-UNIT-012 | Unit | P0 | OpenAI å‘é‡ç»´åº¦ 1536 é€šè¿‡éªŒè¯ | éªŒè¯æ­£ç¡®ç»´åº¦ | DATA-002 |
| 4.5-UNIT-013 | Unit | P0 | OpenAI å‘é‡ç»´åº¦ 1024 æŠ›å‡ºé”™è¯¯ | éªŒè¯é”™è¯¯ç»´åº¦æ£€æµ‹ | DATA-002 |
| 4.5-UNIT-014 | Unit | P0 | ç»´åº¦ä¸åŒ¹é…è®°å½• ERROR æ—¥å¿— | éªŒè¯æ—¥å¿—è®°å½• | DATA-002, OPS-001 |

**æµ‹è¯•æ•°æ®** (Mock):
- ZhipuAI provider:
  - æ­£ç¡®: 1024 ç»´å‘é‡
  - é”™è¯¯: 1536 ç»´å‘é‡
- OpenAI provider:
  - æ­£ç¡®: 1536 ç»´å‘é‡
  - é”™è¯¯: 1024 ç»´å‘é‡

**é¢„æœŸè¡Œä¸º**:
- **ç»´åº¦æ­£ç¡®**: ç»§ç»­å¤„ç†ï¼Œæ— å¼‚å¸¸
- **ç»´åº¦ä¸åŒ¹é…**:
  - æŠ›å‡º `EmbeddingError` (type: 'DIMENSION_MISMATCH')
  - é”™è¯¯æ¶ˆæ¯: `Vector dimension mismatch: expected {expected}, got {actual}`
  - ERROR æ—¥å¿—åŒ…å«: `{ documentId, chunkId, expectedDimension, actualDimension, provider }`

---

### AC5: Unicode ç‰¹æ®Šå­—ç¬¦å¤„ç†

**éœ€æ±‚**: éªŒè¯åˆ†å—å™¨æ­£ç¡®å¤„ç†ä¸­æ–‡ã€Emojiã€æ··åˆç‰¹æ®Šç¬¦å·

**é£é™©è¦†ç›–**: TECH-001 (åˆ†æ•° 2)

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 4.5-INT-006 | Integration | P1 | çº¯ä¸­æ–‡æ–‡æ¡£æ­£ç¡®åˆ†å— | éªŒè¯ä¸­æ–‡å­—ç¬¦æ”¯æŒ | TECH-001 |
| 4.5-INT-007 | Integration | P1 | Emoji æ–‡æ¡£æ­£ç¡®åˆ†å— | éªŒè¯ Emoji æ”¯æŒ | TECH-001 |
| 4.5-INT-008 | Integration | P1 | ä¸­è‹±æ–‡æ··åˆæ–‡æ¡£æ­£ç¡®åˆ†å— | éªŒè¯æ··åˆå­—ç¬¦é›† | TECH-001 |
| 4.5-INT-009 | Integration | P1 | ç‰¹æ®Šç¬¦å·æ–‡æ¡£æ­£ç¡®åˆ†å— | éªŒè¯ç¬¦å·æ”¯æŒ | TECH-001 |

**æµ‹è¯•æ•°æ®**:
- **çº¯ä¸­æ–‡**: "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æ¡£ã€‚å†…å®¹åŒ…å«å®Œæ•´çš„ä¸­æ–‡å¥å­ã€‚" Ã— 100
- **Emoji**: "Hello ğŸ‘‹ World ğŸŒ Test ğŸš€ Document ğŸ“„" Ã— 100
- **æ··åˆ**: "Price: â‚¬100, ç‰ˆæƒ Copyright Â©2025, å–œæ¬¢ Love â™¥" Ã— 100
- **ç‰¹æ®Šç¬¦å·**: "â„¢ Â® Â© â‚¬ Â£ Â¥ Â± Ã— Ã· â‰  â‰¤ â‰¥" Ã— 100

**é¢„æœŸè¡Œä¸º**:
- åˆ†å—æˆåŠŸï¼Œæ— å¼‚å¸¸
- Chunks å†…å®¹ä¿ç•™å®Œæ•´çš„ Unicode å­—ç¬¦
- å­—ç¬¦ä¸è¢«æŸåæˆ–æ›¿æ¢
- å‘é‡åŒ–æˆåŠŸ

**æ³¨æ„**: è¿™äº›æ˜¯é›†æˆæµ‹è¯•ï¼Œå› ä¸ºéœ€è¦éªŒè¯æ•´ä¸ªæµç¨‹ï¼ˆè§£æ â†’ åˆ†å— â†’ å‘é‡åŒ–ï¼‰

---

### AC6: é”™è¯¯æ—¥å¿—ç»“æ„åŒ–

**éœ€æ±‚**: æ‰€æœ‰é”™è¯¯æ—¥å¿—åŒ…å«æ ‡å‡†å­—æ®µ (timestamp, documentId, errorType, message, context)

**é£é™©è¦†ç›–**: OPS-001 (åˆ†æ•° 4)

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 4.5-UNIT-015 | Unit | P1 | ChunkingError æ—¥å¿—åŒ…å«æ ‡å‡†å­—æ®µ | éªŒè¯æ—¥å¿—ç»“æ„ | OPS-001 |
| 4.5-UNIT-016 | Unit | P1 | EmbeddingError æ—¥å¿—åŒ…å«æ ‡å‡†å­—æ®µ | éªŒè¯æ—¥å¿—ç»“æ„ | OPS-001 |

**éªŒè¯å­—æ®µ**:
```typescript
{
  timestamp: string,        // ISO-8601 æ ¼å¼
  documentId: string,       // æ–‡æ¡£ ID
  errorType: string,        // é”™è¯¯ç±»å‹æšä¸¾
  message: string,          // é”™è¯¯æ¶ˆæ¯
  context: {                // ä¸Šä¸‹æ–‡ä¿¡æ¯
    // ç›¸å…³å‚æ•°
  }
}
```

**é¢„æœŸè¡Œä¸º**:
- æ‰€æœ‰é”™è¯¯æ—¥å¿—ä½¿ç”¨ `console.error('[Service] é”™è¯¯:', structuredLog)`
- æ‰€æœ‰å‘Šè­¦æ—¥å¿—ä½¿ç”¨ `console.warn('[Service] å‘Šè­¦:', structuredLog)`
- å­—æ®µå®Œæ•´ä¸”ç±»å‹æ­£ç¡®

---

### AC7: é”™è¯¯çŠ¶æ€å’Œæ¢å¤

**éœ€æ±‚**: FAILED çŠ¶æ€çš„æ–‡æ¡£åœ¨ metadata ä¸­åŒ…å«å®Œæ•´é”™è¯¯ä¿¡æ¯ï¼Œé”™è¯¯ç±»å‹å¯åŒºåˆ†

**é£é™©è¦†ç›–**: DATA-001, DATA-002, OPS-001 (ç»¼åˆ)

**æ³¨æ„**: æ­¤ AC çš„æµ‹è¯•å·²åœ¨ AC1-AC6 ä¸­è¦†ç›–ï¼Œæ— éœ€é¢å¤–æµ‹è¯•åœºæ™¯

**éªŒè¯ç‚¹**:
- AC1, AC2 çš„é›†æˆæµ‹è¯•å·²éªŒè¯ `EMPTY_CONTENT` é”™è¯¯ç±»å‹
- AC3 çš„é›†æˆæµ‹è¯•å·²éªŒè¯æˆªæ–­ä¿¡æ¯è®°å½•
- AC4 çš„å•å…ƒæµ‹è¯•å·²éªŒè¯ `DIMENSION_MISMATCH` é”™è¯¯ç±»å‹
- æ‰€æœ‰é›†æˆæµ‹è¯•éªŒè¯ metadata å®Œæ•´æ€§

---

## Risk Coverage Matrix

å°†æµ‹è¯•åœºæ™¯æ˜ å°„åˆ°å·²è¯†åˆ«çš„é£é™©ï¼š

| é£é™© ID | é£é™©æ ‡é¢˜ | åˆ†æ•° | æµ‹è¯•åœºæ™¯ | è¦†ç›–ç‡ |
|---------|----------|------|----------|--------|
| PERF-001 | è¶…å¤§æ–‡æ¡£æœªæˆªæ–­ | 6 | 4.5-UNIT-006, 007, 008, 009<br>4.5-INT-004, 005 | âœ… å®Œå…¨è¦†ç›– |
| DATA-001 | ç©ºæ–‡æ¡£æ£€æµ‹ä¸å®Œæ•´ | 4 | 4.5-UNIT-001, 002, 003, 004, 005<br>4.5-INT-001, 002, 003 | âœ… å®Œå…¨è¦†ç›– |
| OPS-001 | é”™è¯¯æ—¥å¿—ä¸ç»“æ„åŒ– | 4 | 4.5-UNIT-007, 014, 015, 016 | âœ… å®Œå…¨è¦†ç›– |
| DATA-003 | æˆªæ–­åç”¨æˆ·ä¸çŸ¥æƒ… | 4 | 4.5-INT-004 | âš ï¸ éƒ¨åˆ†è¦†ç›–* |
| DATA-002 | ç»´åº¦ä¸åŒ¹é… | 3 | 4.5-UNIT-010, 011, 012, 013, 014 | âœ… å®Œå…¨è¦†ç›– |
| TECH-001 | Unicode å¤„ç†é”™è¯¯ | 2 | 4.5-INT-006, 007, 008, 009 | âœ… å®Œå…¨è¦†ç›– |

**æ³¨**: 
- *DATA-003 çš„ UI æ˜¾ç¤ºéƒ¨åˆ†ä¸åœ¨æ­¤ Story èŒƒå›´å†…ï¼Œmetadata è®°å½•å·²è¦†ç›–

**é£é™©ç¼“è§£ç‡**: 100% (æ‰€æœ‰è¯†åˆ«çš„é£é™©éƒ½æœ‰å¯¹åº”æµ‹è¯•)

---

## Test Scenarios Summary Table

| ID | AC | Level | Priority | Test Description | Mitigates Risk |
|----|----|----|----------|------------------|----------------|
| 4.5-UNIT-001 | AC1 | Unit | P0 | å®Œå…¨ç©ºæ–‡æ¡£æŠ›å‡ºé”™è¯¯ | DATA-001 |
| 4.5-UNIT-002 | AC1 | Unit | P0 | é”™è¯¯æ¶ˆæ¯ä¸º "æ–‡æ¡£å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¤„ç†" | DATA-001 |
| 4.5-UNIT-003 | AC2 | Unit | P0 | ä»…ç©ºæ ¼æ–‡æ¡£æŠ›å‡ºé”™è¯¯ | DATA-001 |
| 4.5-UNIT-004 | AC2 | Unit | P0 | ä»…æ¢è¡Œç¬¦æ–‡æ¡£æŠ›å‡ºé”™è¯¯ | DATA-001 |
| 4.5-UNIT-005 | AC2 | Unit | P0 | æ··åˆç©ºç™½å­—ç¬¦æ–‡æ¡£æŠ›å‡ºé”™è¯¯ | DATA-001 |
| 4.5-UNIT-006 | AC3 | Unit | P0 | è¶…è¿‡ 10000 chunks æ—¶æˆªæ–­åˆ° 10000 | PERF-001 |
| 4.5-UNIT-007 | AC3 | Unit | P0 | æˆªæ–­æ—¶è®°å½• WARN æ—¥å¿— | PERF-001, OPS-001 |
| 4.5-UNIT-008 | AC3 | Unit | P2 | æ°å¥½ 10000 chunks ä¸æˆªæ–­ | PERF-001 |
| 4.5-UNIT-009 | AC3 | Unit | P2 | 9999 chunks ä¸æˆªæ–­ | PERF-001 |
| 4.5-UNIT-010 | AC4 | Unit | P0 | ZhipuAI å‘é‡ç»´åº¦ 1024 é€šè¿‡éªŒè¯ | DATA-002 |
| 4.5-UNIT-011 | AC4 | Unit | P0 | ZhipuAI å‘é‡ç»´åº¦ 1536 æŠ›å‡ºé”™è¯¯ | DATA-002 |
| 4.5-UNIT-012 | AC4 | Unit | P0 | OpenAI å‘é‡ç»´åº¦ 1536 é€šè¿‡éªŒè¯ | DATA-002 |
| 4.5-UNIT-013 | AC4 | Unit | P0 | OpenAI å‘é‡ç»´åº¦ 1024 æŠ›å‡ºé”™è¯¯ | DATA-002 |
| 4.5-UNIT-014 | AC4 | Unit | P0 | ç»´åº¦ä¸åŒ¹é…è®°å½• ERROR æ—¥å¿— | DATA-002, OPS-001 |
| 4.5-UNIT-015 | AC6 | Unit | P1 | ChunkingError æ—¥å¿—åŒ…å«æ ‡å‡†å­—æ®µ | OPS-001 |
| 4.5-UNIT-016 | AC6 | Unit | P1 | EmbeddingError æ—¥å¿—åŒ…å«æ ‡å‡†å­—æ®µ | OPS-001 |
| 4.5-INT-001 | AC1 | Integration | P0 | ç©ºæ–‡æ¡£ç«¯åˆ°ç«¯æµç¨‹è®¾ç½® FAILED çŠ¶æ€ | DATA-001 |
| 4.5-INT-002 | AC1 | Integration | P0 | metadata åŒ…å« EMPTY_CONTENT é”™è¯¯ç±»å‹ | DATA-001 |
| 4.5-INT-003 | AC2 | Integration | P0 | ç©ºç™½æ–‡æ¡£ç«¯åˆ°ç«¯è¿”å›å‹å¥½é”™è¯¯ | DATA-001 |
| 4.5-INT-004 | AC3 | Integration | P0 | æˆªæ–­å metadata åŒ…å«å®Œæ•´ä¿¡æ¯ | PERF-001, DATA-003 |
| 4.5-INT-005 | AC3 | Integration | P0 | è¶…å¤§æ–‡æ¡£ç«¯åˆ°ç«¯æˆåŠŸå¤„ç† | PERF-001 |
| 4.5-INT-006 | AC5 | Integration | P1 | çº¯ä¸­æ–‡æ–‡æ¡£æ­£ç¡®åˆ†å— | TECH-001 |
| 4.5-INT-007 | AC5 | Integration | P1 | Emoji æ–‡æ¡£æ­£ç¡®åˆ†å— | TECH-001 |
| 4.5-INT-008 | AC5 | Integration | P1 | ä¸­è‹±æ–‡æ··åˆæ–‡æ¡£æ­£ç¡®åˆ†å— | TECH-001 |
| 4.5-INT-009 | AC5 | Integration | P1 | ç‰¹æ®Šç¬¦å·æ–‡æ¡£æ­£ç¡®åˆ†å— | TECH-001 |

---

## Recommended Execution Order

### Phase 1: P0 Unit Tests (Fast Feedback)

**æ‰§è¡Œæ—¶é—´**: ~5 åˆ†é’Ÿ  
**æµ‹è¯•æ•°**: 14 ä¸ª

```bash
npm test tests/unit/services/documents/chunkingService.test.ts
npm test tests/unit/services/documents/embeddingService.test.ts
```

**åŒ…å«æµ‹è¯•**:
- 4.5-UNIT-001 åˆ° 4.5-UNIT-014

**ç›®çš„**: å¿«é€ŸéªŒè¯æ ¸å¿ƒé€»è¾‘ï¼Œå¦‚æœå¤±è´¥ç«‹å³åœæ­¢

---

### Phase 2: P0 Integration Tests (Critical Paths)

**æ‰§è¡Œæ—¶é—´**: ~3 åˆ†é’Ÿ  
**æµ‹è¯•æ•°**: 7 ä¸ª

```bash
npm run test:integration tests/integration/documents/edge-cases.test.ts
```

**åŒ…å«æµ‹è¯•**:
- 4.5-INT-001, 002, 003 (ç©ºæ–‡æ¡£ç«¯åˆ°ç«¯)
- 4.5-INT-004, 005 (è¶…å¤§æ–‡æ¡£ç«¯åˆ°ç«¯)

**ç›®çš„**: éªŒè¯ç«¯åˆ°ç«¯æµç¨‹å’Œæ•°æ®åº“çŠ¶æ€

---

### Phase 3: P1 Tests (Important Coverage)

**æ‰§è¡Œæ—¶é—´**: ~4 åˆ†é’Ÿ  
**æµ‹è¯•æ•°**: 6 ä¸ª

```bash
# å•å…ƒæµ‹è¯•
npm test tests/unit/services/documents/ -- --testNamePattern="æ—¥å¿—"

# é›†æˆæµ‹è¯•
npm run test:integration tests/integration/documents/unicode-handling.test.ts
```

**åŒ…å«æµ‹è¯•**:
- 4.5-UNIT-015, 016 (æ—¥å¿—ç»“æ„åŒ–)
- 4.5-INT-006, 007, 008, 009 (Unicode å¤„ç†)

**ç›®çš„**: éªŒè¯æ—¥å¿—å’Œ Unicode æ”¯æŒ

---

### Phase 4: P2 Tests (Edge Cases)

**æ‰§è¡Œæ—¶é—´**: ~1 åˆ†é’Ÿ  
**æµ‹è¯•æ•°**: 2 ä¸ª

```bash
npm test tests/unit/services/documents/chunkingService.test.ts -- --testNamePattern="è¾¹ç•Œ"
```

**åŒ…å«æµ‹è¯•**:
- 4.5-UNIT-008 (æ°å¥½ 10000 chunks)
- 4.5-UNIT-009 (9999 chunks)

**ç›®çš„**: è¾¹ç•Œå€¼éªŒè¯

---

## Test Implementation Guide

### Unit Test File Structure

**æ–‡ä»¶**: `tests/unit/services/documents/chunkingService.test.ts`

```typescript
describe('ChunkingService - Edge Cases', () => {
  describe('AC1 & AC2: ç©ºæ–‡æ¡£æ£€æµ‹', () => {
    it('4.5-UNIT-001: åº”è¯¥åœ¨å®Œå…¨ç©ºæ–‡æ¡£æ—¶æŠ›å‡ºé”™è¯¯', async () => {
      // Arrange
      const emptyContent = ''
      
      // Act & Assert
      await expect(chunkingService.chunkDocument(documentId, emptyContent))
        .rejects
        .toThrow('æ–‡æ¡£å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¤„ç†')
    })
    
    it('4.5-UNIT-003: åº”è¯¥åœ¨ä»…ç©ºæ ¼æ–‡æ¡£æ—¶æŠ›å‡ºé”™è¯¯', async () => {
      const whitespaceContent = '   '
      await expect(chunkingService.chunkDocument(documentId, whitespaceContent))
        .rejects
        .toThrow('æ–‡æ¡£å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¤„ç†')
    })
    
    // ... å…¶ä»–æµ‹è¯•
  })
  
  describe('AC3: è¶…å¤§æ–‡æ¡£é™åˆ¶', () => {
    it('4.5-UNIT-006: åº”è¯¥åœ¨è¶…è¿‡ 10000 chunks æ—¶æˆªæ–­', async () => {
      // Arrange
      const largeContent = 'x'.repeat(5000000) // äº§ç”Ÿ ~15000 chunks
      const consoleWarnSpy = jest.spyOn(console, 'warn')
      
      // Act
      const result = await chunkingService.chunkDocument(documentId, largeContent)
      
      // Assert
      expect(result.chunks.length).toBe(10000)
      expect(consoleWarnSpy).toHaveBeenCalledWith(
        expect.stringContaining('[Chunking] æ–‡æ¡£è¶…è¿‡æœ€å¤§chunksé™åˆ¶'),
        expect.objectContaining({
          documentId,
          maxChunks: 10000
        })
      )
    })
    
    it('4.5-UNIT-008: åº”è¯¥åœ¨æ°å¥½ 10000 chunks æ—¶ä¸æˆªæ–­', async () => {
      // Arrange - ç²¾ç¡®æ§åˆ¶å†…å®¹äº§ç”Ÿæ°å¥½ 10000 chunks
      const exactContent = generateExactChunks(10000)
      const consoleWarnSpy = jest.spyOn(console, 'warn')
      
      // Act
      const result = await chunkingService.chunkDocument(documentId, exactContent)
      
      // Assert
      expect(result.chunks.length).toBe(10000)
      expect(consoleWarnSpy).not.toHaveBeenCalled()
    })
    
    // ... å…¶ä»–æµ‹è¯•
  })
})
```

---

**æ–‡ä»¶**: `tests/unit/services/documents/embeddingService.test.ts`

```typescript
describe('EmbeddingService - Dimension Validation', () => {
  describe('AC4: å‘é‡ç»´åº¦éªŒè¯', () => {
    it('4.5-UNIT-010: åº”è¯¥éªŒè¯ ZhipuAI 1024 ç»´å‘é‡é€šè¿‡', async () => {
      // Arrange
      mockLLMConfig.provider = 'zhipu'
      const mockVector = new Array(1024).fill(0.1)
      mockLLM.generateEmbeddings.mockResolvedValue([mockVector])
      
      // Act & Assert
      await expect(embeddingService.embedAndStoreChunks(chunks))
        .resolves
        .not.toThrow()
    })
    
    it('4.5-UNIT-011: åº”è¯¥åœ¨ ZhipuAI è¿”å› 1536 ç»´å‘é‡æ—¶æŠ›å‡ºé”™è¯¯', async () => {
      // Arrange
      mockLLMConfig.provider = 'zhipu'
      const wrongVector = new Array(1536).fill(0.1) // é”™è¯¯ç»´åº¦
      mockLLM.generateEmbeddings.mockResolvedValue([wrongVector])
      
      // Act & Assert
      await expect(embeddingService.embedAndStoreChunks(chunks))
        .rejects
        .toThrow(EmbeddingError)
      
      await expect(embeddingService.embedAndStoreChunks(chunks))
        .rejects
        .toThrow('Vector dimension mismatch: expected 1024, got 1536')
    })
    
    // ... å…¶ä»–æµ‹è¯•
  })
})
```

---

### Integration Test File Structure

**æ–‡ä»¶**: `tests/integration/documents/edge-cases.test.ts`

```typescript
describe('Edge Cases - Integration Tests', () => {
  describe('AC1 & AC2: ç©ºæ–‡æ¡£ç«¯åˆ°ç«¯å¤„ç†', () => {
    it('4.5-INT-001: ç©ºæ–‡æ¡£åº”è®¾ç½® FAILED çŠ¶æ€', async () => {
      // Arrange
      const emptyFile = createTestFile('empty.txt', '')
      
      // Act
      const response = await uploadDocument(emptyFile)
      
      // Assert - API è¿”å›é”™è¯¯
      expect(response.status).toBe(400)
      expect(response.body.error).toContain('æ–‡æ¡£å†…å®¹ä¸ºç©º')
      
      // Assert - æ•°æ®åº“çŠ¶æ€
      const doc = await db.query.documents.findFirst({
        where: eq(documents.id, response.body.documentId)
      })
      expect(doc.status).toBe('FAILED')
      expect(doc.metadata.errorType).toBe('EMPTY_CONTENT')
    })
    
    it('4.5-INT-003: ç©ºç™½æ–‡æ¡£åº”è¿”å›å‹å¥½é”™è¯¯', async () => {
      const whitespaceFile = createTestFile('whitespace.txt', '   \n\t  ')
      const response = await uploadDocument(whitespaceFile)
      
      expect(response.status).toBe(400)
      expect(response.body.error).toBe('æ–‡æ¡£å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¤„ç†')
    })
  })
  
  describe('AC3: è¶…å¤§æ–‡æ¡£ç«¯åˆ°ç«¯å¤„ç†', () => {
    it('4.5-INT-004: æˆªæ–­å metadata åŒ…å«å®Œæ•´ä¿¡æ¯', async () => {
      // Arrange - ç”Ÿæˆè¶…å¤§æµ‹è¯•æ–‡ä»¶
      const largeFile = await generateLargeTestFile(15000) // 15000 chunks
      
      // Act
      const response = await uploadDocument(largeFile)
      
      // Assert
      expect(response.status).toBe(200)
      
      const doc = await db.query.documents.findFirst({
        where: eq(documents.id, response.body.documentId)
      })
      
      expect(doc.status).toBe('COMPLETED')
      expect(doc.metadata.chunking).toEqual({
        truncated: true,
        originalChunksCount: 15000,
        storedChunksCount: 10000
      })
      
      // Verify only 10000 chunks stored
      const chunks = await db.query.documentChunks.findMany({
        where: eq(documentChunks.documentId, doc.id)
      })
      expect(chunks.length).toBe(10000)
    })
    
    it('4.5-INT-005: è¶…å¤§æ–‡æ¡£åº”æˆåŠŸå¤„ç†ä¸å´©æºƒ', async () => {
      const largeFile = await generateLargeTestFile(15000)
      
      // Act - åº”è¯¥åœ¨åˆç†æ—¶é—´å†…å®Œæˆ
      const startTime = Date.now()
      const response = await uploadDocument(largeFile)
      const duration = Date.now() - startTime
      
      // Assert
      expect(response.status).toBe(200)
      expect(duration).toBeLessThan(300000) // < 5 åˆ†é’Ÿ
    })
  })
})
```

---

**æ–‡ä»¶**: `tests/integration/documents/unicode-handling.test.ts`

```typescript
describe('Unicode Handling - Integration Tests', () => {
  describe('AC5: Unicode ç‰¹æ®Šå­—ç¬¦å¤„ç†', () => {
    it('4.5-INT-006: åº”è¯¥æ­£ç¡®å¤„ç†çº¯ä¸­æ–‡æ–‡æ¡£', async () => {
      // Arrange
      const chineseContent = 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æ¡£ã€‚å†…å®¹åŒ…å«å®Œæ•´çš„ä¸­æ–‡å¥å­ã€‚'.repeat(100)
      const chineseFile = createTestFile('chinese.txt', chineseContent)
      
      // Act
      const response = await uploadDocument(chineseFile)
      
      // Assert
      expect(response.status).toBe(200)
      
      // Verify chunks preserved Chinese characters
      const chunks = await getDocumentChunks(response.body.documentId)
      expect(chunks[0].content).toMatch(/[\u4e00-\u9fa5]/) // åŒ…å«ä¸­æ–‡
      expect(chunks[0].content).not.toContain('ï¿½') // æ— ä¹±ç 
    })
    
    it('4.5-INT-007: åº”è¯¥æ­£ç¡®å¤„ç† Emoji æ–‡æ¡£', async () => {
      const emojiContent = 'Hello ğŸ‘‹ World ğŸŒ Test ğŸš€ Document ğŸ“„'.repeat(100)
      const emojiFile = createTestFile('emoji.txt', emojiContent)
      
      const response = await uploadDocument(emojiFile)
      expect(response.status).toBe(200)
      
      const chunks = await getDocumentChunks(response.body.documentId)
      expect(chunks[0].content).toMatch(/ğŸ‘‹|ğŸŒ|ğŸš€|ğŸ“„/)
    })
    
    it('4.5-INT-008: åº”è¯¥æ­£ç¡®å¤„ç†ä¸­è‹±æ–‡æ··åˆæ–‡æ¡£', async () => {
      const mixedContent = 'Price: â‚¬100, ç‰ˆæƒ Copyright Â©2025, å–œæ¬¢ Love â™¥'.repeat(100)
      const mixedFile = createTestFile('mixed.txt', mixedContent)
      
      const response = await uploadDocument(mixedFile)
      expect(response.status).toBe(200)
      
      const chunks = await getDocumentChunks(response.body.documentId)
      expect(chunks[0].content).toMatch(/ç‰ˆæƒ/)
      expect(chunks[0].content).toMatch(/â‚¬|Â©|â™¥/)
    })
    
    it('4.5-INT-009: åº”è¯¥æ­£ç¡®å¤„ç†ç‰¹æ®Šç¬¦å·æ–‡æ¡£', async () => {
      const symbolContent = 'â„¢ Â® Â© â‚¬ Â£ Â¥ Â± Ã— Ã· â‰  â‰¤ â‰¥'.repeat(100)
      const symbolFile = createTestFile('symbols.txt', symbolContent)
      
      const response = await uploadDocument(symbolFile)
      expect(response.status).toBe(200)
    })
  })
})
```

---

## Test Data Generation

### Helper Functions

```typescript
// tests/helpers/testDataGenerator.ts

/**
 * ç”Ÿæˆæ°å¥½æŒ‡å®šæ•°é‡ chunks çš„æ–‡æœ¬å†…å®¹
 * @param chunkCount æœŸæœ›çš„ chunks æ•°é‡
 * @param chunkSize æ¯ä¸ª chunk çš„å¤§å°ï¼ˆé»˜è®¤ 500ï¼‰
 * @param overlap é‡å å¤§å°ï¼ˆé»˜è®¤ 50ï¼‰
 */
export function generateExactChunks(
  chunkCount: number, 
  chunkSize: number = 500, 
  overlap: number = 50
): string {
  // è®¡ç®—éœ€è¦çš„æ€»å­—ç¬¦æ•°
  // å…¬å¼: totalChars = chunkSize + (chunkCount - 1) * (chunkSize - overlap)
  const totalChars = chunkSize + (chunkCount - 1) * (chunkSize - overlap)
  
  // ç”Ÿæˆæœ‰æ„ä¹‰çš„æµ‹è¯•æ–‡æœ¬
  const sentence = 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¥å­ç”¨äºç”Ÿæˆå¤§é‡æ–‡æœ¬å†…å®¹ã€‚'
  const content = sentence.repeat(Math.ceil(totalChars / sentence.length))
  
  return content.slice(0, totalChars)
}

/**
 * ç”Ÿæˆè¶…å¤§æµ‹è¯•æ–‡ä»¶
 * @param chunkCount æœŸæœ›äº§ç”Ÿçš„ chunks æ•°é‡
 */
export async function generateLargeTestFile(chunkCount: number): Promise<File> {
  const content = generateExactChunks(chunkCount)
  return new File([content], `large-${chunkCount}.txt`, { type: 'text/plain' })
}

/**
 * åˆ›å»ºæµ‹è¯•æ–‡ä»¶
 */
export function createTestFile(filename: string, content: string): File {
  return new File([content], filename, { type: 'text/plain' })
}
```

---

## Coverage Validation

### Expected Coverage by File

| æ–‡ä»¶ | æ–°å¢ä»£ç è¡Œ | æµ‹è¯•è¦†ç›–ç›®æ ‡ | å…³é”®åˆ†æ”¯ |
|------|-----------|-------------|---------|
| `chunkingService.ts` | ~30 è¡Œ | 100% | ç©ºå†…å®¹æ£€æŸ¥, æˆªæ–­é€»è¾‘ |
| `embeddingService.ts` | ~15 è¡Œ | 100% | ç»´åº¦éªŒè¯å¾ªç¯ |
| é”™è¯¯ç±»å‹å®šä¹‰ | ~5 è¡Œ | 100% | æ–°å¢é”™è¯¯ç±»å‹ |

### Coverage Gaps Check

è¿è¡Œè¦†ç›–ç‡æŠ¥å‘Šåæ£€æŸ¥:

```bash
npm run test:coverage

# æ£€æŸ¥å…³é”®æ–‡ä»¶
open coverage/lcov-report/chunkingService.ts.html
open coverage/lcov-report/embeddingService.ts.html
```

**å¿…é¡»è¾¾åˆ°**:
- è¯­å¥è¦†ç›–ç‡ (Statements): 100%
- åˆ†æ”¯è¦†ç›–ç‡ (Branches): 100%
- å‡½æ•°è¦†ç›–ç‡ (Functions): 100%
- è¡Œè¦†ç›–ç‡ (Lines): 100%

---

## Quality Checklist

éªŒè¯æµ‹è¯•è®¾è®¡è´¨é‡ï¼š

- [x] **Every AC has test coverage**: æ‰€æœ‰ 7 ä¸ª AC éƒ½æœ‰å¯¹åº”æµ‹è¯•
- [x] **Test levels are appropriate**: 
  - å•å…ƒæµ‹è¯•ç”¨äºçº¯é€»è¾‘éªŒè¯ (ç©ºæ–‡æ¡£ã€ç»´åº¦ã€æˆªæ–­é€»è¾‘)
  - é›†æˆæµ‹è¯•ç”¨äºç«¯åˆ°ç«¯æµç¨‹å’Œæ•°æ®åº“éªŒè¯
  - æ— ä¸å¿…è¦çš„ E2E æµ‹è¯•
- [x] **No duplicate coverage**: æ¯ä¸ªåœºæ™¯åªåœ¨ä¸€ä¸ªå±‚çº§æµ‹è¯•
- [x] **Priorities align with risk**: 
  - é«˜é£é™© PERF-001, DATA-001 â†’ P0
  - ä¸­é£é™© OPS-001 â†’ P1
  - ä½é£é™© TECH-001 â†’ P1
- [x] **Test IDs follow naming convention**: 4.5-{LEVEL}-{SEQ}
- [x] **Scenarios are atomic**: æ¯ä¸ªæµ‹è¯•éªŒè¯ä¸€ä¸ªæ˜ç¡®çš„è¡Œä¸º
- [x] **Risk coverage complete**: æ‰€æœ‰ 6 ä¸ªé£é™©éƒ½æœ‰ç¼“è§£æµ‹è¯•

---

## Success Criteria

**æµ‹è¯•è®¾è®¡æˆåŠŸæ ‡å‡†**:

1. âœ… **å®Œæ•´æ€§**: æ‰€æœ‰ AC å’Œé£é™©éƒ½æœ‰æµ‹è¯•è¦†ç›–
2. âœ… **æ•ˆç‡æ€§**: Shift-left ç­–ç•¥ï¼Œ61% å•å…ƒæµ‹è¯•
3. âœ… **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„æµ‹è¯•ç»“æ„å’Œå‘½å
4. âœ… **å¯è¿½æº¯æ€§**: æ¯ä¸ªæµ‹è¯•åœºæ™¯æ˜ å°„åˆ° AC å’Œé£é™©
5. âœ… **å¯æ‰§è¡Œæ€§**: æä¾›å®Œæ•´çš„å®ç°æŒ‡å¯¼

**æ‰§è¡ŒåéªŒæ”¶**:
- æ‰€æœ‰ 23 ä¸ªæµ‹è¯•ç”¨ä¾‹é€šè¿‡
- ä»£ç è¦†ç›–ç‡ 100%
- æ‰€æœ‰é£é™©å¾—åˆ°ç¼“è§£
- æµ‹è¯•æ‰§è¡Œæ—¶é—´ < 15 åˆ†é’Ÿ

---

## Conclusion

**æµ‹è¯•ç­–ç•¥æ€»ç»“**:
- âœ… **23 ä¸ªæµ‹è¯•åœºæ™¯** å…¨é¢è¦†ç›– 7 ä¸ªéªŒæ”¶æ ‡å‡†
- âœ… **100% é£é™©è¦†ç›–** - æ‰€æœ‰è¯†åˆ«çš„é£é™©éƒ½æœ‰å¯¹åº”æµ‹è¯•
- âœ… **Shift-left approach** - 61% å•å…ƒæµ‹è¯•æä¾›å¿«é€Ÿåé¦ˆ
- âœ… **ä¼˜å…ˆçº§æ¸…æ™°** - 70% P0 æµ‹è¯•ç¡®ä¿å…³é”®è·¯å¾„
- âœ… **å¯æ‰§è¡Œæ€§å¼º** - æä¾›å®Œæ•´çš„å®ç°ä»£ç ç¤ºä¾‹

**æ¨èæ‰§è¡Œé¡ºåº**:
1. Phase 1: P0 å•å…ƒæµ‹è¯• (14 ä¸ª) - 5 åˆ†é’Ÿ
2. Phase 2: P0 é›†æˆæµ‹è¯• (7 ä¸ª) - 3 åˆ†é’Ÿ
3. Phase 3: P1 æµ‹è¯• (6 ä¸ª) - 4 åˆ†é’Ÿ
4. Phase 4: P2 è¾¹ç•Œæµ‹è¯• (2 ä¸ª) - 1 åˆ†é’Ÿ

**æ€»æ‰§è¡Œæ—¶é—´**: ~13 åˆ†é’Ÿ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-14  
**è®¾è®¡è€…**: Quinn (æµ‹è¯•æ¶æ„å¸ˆ)  
**ä¸‹æ¬¡å®¡æŸ¥**: å®æ–½åéªŒè¯è¦†ç›–ç‡

