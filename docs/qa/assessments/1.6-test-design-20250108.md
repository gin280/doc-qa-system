# Test Design: Story 1.6 - 用户账户管理页面

**日期**: 2025-01-08  
**设计者**: Quinn (Test Architect)  
**Story ID**: 1.6  
**Epic**: 1 - 基础设施与用户认证

---

## 测试策略概览

- **测试场景总数**: 47
- **单元测试**: 18 (38%)
- **集成测试**: 21 (45%)
- **E2E测试**: 8 (17%)
- **优先级分布**: P0: 22, P1: 17, P2: 8

### 测试金字塔分布

```
       E2E (8)
      /       \
    Integration (21)
   /                \
  Unit Tests (18)
```

---

## 按验收标准的测试场景

### AC1: 账户设置页面路由与布局

**覆盖范围**: 页面访问控制、布局结构、响应式设计

| ID              | Level       | Priority | 测试描述                                | 理由                    | 风险缓解 |
|-----------------|-------------|----------|-----------------------------------------|-------------------------|----------|
| 1.6-E2E-001     | E2E         | P0       | 未登录用户访问 /settings 自动跳转到 /login | 关键安全路径            | -        |
| 1.6-E2E-002     | E2E         | P1       | 已登录用户访问 /settings 显示设置页面    | 核心用户流程            | -        |
| 1.6-INT-001     | Integration | P1       | 页面包含三个主要卡片区域                 | 组件集成验证            | -        |
| 1.6-UNIT-001    | Unit        | P2       | 页面标题显示"账户设置"                   | UI 组件渲染             | -        |
| 1.6-UNIT-002    | Unit        | P2       | "返回主页"链接指向 /dashboard            | 导航逻辑验证            | -        |

**Given-When-Then 映射示例**:
- **1.6-E2E-001**:
  - Given: 用户未登录
  - When: 访问 /settings 页面
  - Then: 自动重定向到 /login 页面

---

### AC2: 个人信息展示与编辑

**覆盖范围**: 用户信息显示、用户名编辑、OAuth 用户特殊处理

| ID              | Level       | Priority | 测试描述                                      | 理由                    | 风险缓解 |
|-----------------|-------------|----------|-----------------------------------------------|-------------------------|----------|
| 1.6-INT-002     | Integration | P0       | GET /api/user/profile 返回完整用户信息         | 核心 API 功能           | -        |
| 1.6-INT-003     | Integration | P0       | PATCH /api/user/profile 更新用户名成功         | 核心数据修改            | -        |
| 1.6-UNIT-003    | Unit        | P0       | 用户名验证：长度2-50字符                       | 输入验证逻辑            | -        |
| 1.6-UNIT-004    | Unit        | P0       | 用户名验证：拒绝空字符串                       | 边界条件                | -        |
| 1.6-UNIT-005    | Unit        | P1       | 用户名验证：拒绝超过50字符                     | 边界条件                | -        |
| 1.6-INT-004     | Integration | P1       | PATCH /api/user/profile 验证失败返回400        | 错误处理                | -        |
| 1.6-UNIT-006    | Unit        | P1       | 头像显示：有 avatarUrl 显示图片               | UI 逻辑                 | -        |
| 1.6-UNIT-007    | Unit        | P1       | 头像显示：无 avatarUrl 显示首字母             | Fallback 逻辑           | -        |
| 1.6-UNIT-008    | Unit        | P2       | 邮箱地址只读显示                              | UI 状态                 | -        |
| 1.6-UNIT-009    | Unit        | P2       | 显示认证方式标签（EMAIL/GOOGLE/GITHUB）       | UI 逻辑                 | -        |
| 1.6-UNIT-010    | Unit        | P2       | OAuth 用户显示"头像已同步"提示                | 条件渲染                | -        |
| 1.6-UNIT-011    | Unit        | P2       | 注册时间格式化显示（中文格式）                | 数据格式化              | DATA-002 |
| 1.6-E2E-003     | E2E         | P1       | 完整用户名修改流程（输入-保存-刷新验证）      | 关键用户操作            | -        |

**Given-When-Then 映射示例**:
- **1.6-INT-003**:
  - Given: 已登录用户，用户名为 "OldName"
  - When: PATCH /api/user/profile 请求 {"name": "NewName"}
  - Then: 返回 200，用户名更新为 "NewName"，updatedAt 更新

---

### AC3: 修改密码功能

**覆盖范围**: 密码修改流程、验证规则、OAuth 用户限制、安全控制

| ID              | Level       | Priority | 测试描述                                      | 理由                    | 风险缓解     |
|-----------------|-------------|----------|-----------------------------------------------|-------------------------|--------------|
| 1.6-INT-005     | Integration | P0       | PATCH /api/user/password 修改密码成功          | 核心安全功能            | SEC-001      |
| 1.6-INT-006     | Integration | P0       | 验证当前密码错误时返回401                      | 安全验证                | SEC-001      |
| 1.6-UNIT-012    | Unit        | P0       | 密码验证：至少8位                             | 安全规则                | SEC-001      |
| 1.6-UNIT-013    | Unit        | P0       | 密码验证：必须包含字母和数字                   | 安全规则                | SEC-001      |
| 1.6-UNIT-014    | Unit        | P0       | 密码验证：新密码与确认密码一致                 | 用户体验                | SEC-001      |
| 1.6-INT-007     | Integration | P0       | 密码修改成功后 passwordHash 更新               | 数据持久化              | SEC-001      |
| 1.6-INT-008     | Integration | P0       | bcrypt 哈希验证（salt rounds = 10）           | 密码安全存储            | SEC-001      |
| 1.6-INT-009     | Integration | P0       | OAuth 用户（authProvider != EMAIL）无法修改密码 | 安全边界                | SEC-003      |
| 1.6-INT-010     | Integration | P0       | Rate limiting: 5分钟内最多3次尝试              | 防暴力破解              | SEC-001      |
| 1.6-INT-011     | Integration | P1       | 超过 rate limit 返回 429                      | 限流验证                | SEC-001, OPS-001 |
| 1.6-UNIT-015    | Unit        | P1       | 密码强度指示器：弱（<8位或无字母数字）         | 用户反馈                | SEC-001      |
| 1.6-UNIT-016    | Unit        | P1       | 密码强度指示器：中（8-11位，有字母数字）       | 用户反馈                | SEC-001      |
| 1.6-UNIT-017    | Unit        | P1       | 密码强度指示器：强（≥12位，含特殊字符）        | 用户反馈                | SEC-001      |
| 1.6-E2E-004     | E2E         | P0       | 完整密码修改流程（EMAIL 用户）                 | 关键安全路径            | SEC-001      |
| 1.6-E2E-005     | E2E         | P1       | OAuth 用户不显示"修改密码"按钮                | 用户体验                | SEC-003      |
| 1.6-INT-012     | Integration | P0       | 密码修改后记录审计日志                         | 合规要求                | SEC-002      |

**Given-When-Then 映射示例**:
- **1.6-INT-005**:
  - Given: EMAIL 用户已登录，当前密码为 "OldPass123"
  - When: PATCH /api/user/password {"currentPassword": "OldPass123", "newPassword": "NewPass456", "confirmPassword": "NewPass456"}
  - Then: 返回 200，passwordHash 更新，审计日志记录

- **1.6-INT-009**:
  - Given: GOOGLE 用户已登录，passwordHash 为 null
  - When: PATCH /api/user/password 请求修改密码
  - Then: 返回 403，错误信息 "OAuth 用户不支持密码修改"

---

### AC4: 使用量统计展示

**覆盖范围**: 使用量数据获取、进度条显示、格式化逻辑

| ID              | Level       | Priority | 测试描述                                      | 理由                    | 风险缓解     |
|-----------------|-------------|----------|-----------------------------------------------|-------------------------|--------------|
| 1.6-INT-013     | Integration | P1       | GET /api/user/usage 返回使用量统计             | 核心 API 功能           | PERF-001     |
| 1.6-INT-014     | Integration | P1       | 用户无使用记录时返回初始值 0                   | 边界条件                | -            |
| 1.6-UNIT-018    | Unit        | P1       | 进度条颜色：使用率 <50% 显示绿色               | UI 逻辑                 | -            |
| 1.6-UNIT-019    | Unit        | P1       | 进度条颜色：使用率 50-80% 显示黄色             | UI 逻辑                 | -            |
| 1.6-UNIT-020    | Unit        | P1       | 进度条颜色：使用率 >80% 显示红色               | UI 逻辑                 | -            |
| 1.6-UNIT-021    | Unit        | P2       | 存储空间格式化：0 字节 → "0 MB"               | 数据格式化              | DATA-002     |
| 1.6-UNIT-022    | Unit        | P2       | 存储空间格式化：500 MB → "500 MB"             | 数据格式化              | DATA-002     |
| 1.6-UNIT-023    | Unit        | P2       | 存储空间格式化：1.5 GB → "1.50 GB"            | 数据格式化              | DATA-002     |
| 1.6-INT-015     | Integration | P2       | userUsage.userId 有数据库索引（性能验证）      | 性能优化                | PERF-001     |
| 1.6-E2E-006     | E2E         | P2       | 使用量统计卡片正确显示所有三项数据             | 完整 UI 验证            | -            |

**Given-When-Then 映射示例**:
- **1.6-INT-013**:
  - Given: 用户已登录，user_usage 表有记录
  - When: GET /api/user/usage
  - Then: 返回 {documentCount, storageUsed, queryCount, queryResetDate, documentLimit, storageLimit, queryLimit}

---

### AC5: 删除账户功能（危险操作）

**覆盖范围**: 删除确认、级联删除、session 清除、数据安全

| ID              | Level       | Priority | 测试描述                                      | 理由                    | 风险缓解     |
|-----------------|-------------|----------|-----------------------------------------------|-------------------------|--------------|
| 1.6-INT-016     | Integration | P0       | DELETE /api/user/account 删除账户成功          | 关键操作                | DATA-001, SEC-002 |
| 1.6-INT-017     | Integration | P0       | 验证邮箱输入与当前用户匹配                     | 安全验证                | -            |
| 1.6-INT-018     | Integration | P0       | 邮箱不匹配时返回 400                          | 错误处理                | -            |
| 1.6-INT-019     | Integration | P0       | 级联删除：users 删除时关联数据也删除           | 数据完整性              | DATA-001     |
| 1.6-INT-020     | Integration | P0       | 级联删除验证：documents 表数据被删除           | 级联逻辑                | DATA-001     |
| 1.6-INT-021     | Integration | P0       | 级联删除验证：user_usage 表数据被删除          | 级联逻辑                | DATA-001     |
| 1.6-INT-022     | Integration | P0       | 账户删除后记录审计日志                         | 合规要求                | SEC-002      |
| 1.6-INT-023     | Integration | P0       | Rate limiting: 1小时内最多1次删除尝试          | 防误操作                | OPS-001      |
| 1.6-E2E-007     | E2E         | P0       | 完整删除流程：确认-删除-登出-跳转              | 关键用户路径            | DATA-001, TECH-001 |
| 1.6-E2E-008     | E2E         | P1       | 删除后 localStorage 和 sessionStorage 被清除   | 数据清理                | -            |

**Given-When-Then 映射示例**:
- **1.6-INT-016**:
  - Given: 用户 user@example.com 已登录
  - When: DELETE /api/user/account {"email": "user@example.com"}
  - Then: 返回 204，users 表记录删除，审计日志记录，相关数据级联删除

- **1.6-INT-019**:
  - Given: 用户有 3 个文档、10 条对话记录
  - When: 删除该用户账户
  - Then: documents、conversations、messages 表的相关记录都被删除

---

### AC6: API 端点实现

**覆盖范围**: API 规范遵循、输入验证、错误处理

| ID              | Level       | Priority | 测试描述                                      | 理由                    | 风险缓解     |
|-----------------|-------------|----------|-----------------------------------------------|-------------------------|--------------|
| 1.6-INT-024     | Integration | P0       | GET /api/user/profile 未登录返回 401           | 认证验证                | -            |
| 1.6-INT-025     | Integration | P0       | PATCH /api/user/profile 未登录返回 401         | 认证验证                | -            |
| 1.6-INT-026     | Integration | P0       | PATCH /api/user/password 未登录返回 401        | 认证验证                | -            |
| 1.6-INT-027     | Integration | P0       | GET /api/user/usage 未登录返回 401             | 认证验证                | -            |
| 1.6-INT-028     | Integration | P0       | DELETE /api/user/account 未登录返回 401        | 认证验证                | -            |
| 1.6-INT-029     | Integration | P1       | 所有 API 使用 zod 进行输入验证                 | 数据安全                | -            |
| 1.6-INT-030     | Integration | P1       | API 错误返回标准格式 {error: string}           | 错误处理一致性          | -            |

---

### AC7: 错误处理与安全

**覆盖范围**: 错误提示、安全机制、审计日志、限流保护

| ID              | Level       | Priority | 测试描述                                      | 理由                    | 风险缓解     |
|-----------------|-------------|----------|-----------------------------------------------|-------------------------|--------------|
| 1.6-UNIT-024    | Unit        | P1       | API 调用失败时显示友好 Toast 提示              | 用户体验                | -            |
| 1.6-INT-031     | Integration | P0       | 审计日志记录：账户删除事件                     | 合规要求                | SEC-002      |
| 1.6-INT-032     | Integration | P0       | 审计日志记录：密码修改事件                     | 合规要求                | SEC-002      |
| 1.6-INT-033     | Integration | P1       | 审计日志记录：个人信息更新事件                 | 合规要求                | SEC-002      |
| 1.6-INT-034     | Integration | P0       | 审计日志包含：userId, action, ipAddress, timestamp | 日志完整性              | SEC-002      |
| 1.6-INT-035     | Integration | P1       | 所有表单验证在客户端和服务端都执行             | 防绕过                  | -            |
| 1.6-INT-036     | Integration | P0       | CSRF Token 保护（NextAuth 内置验证）          | 安全保护                | -            |

**Given-When-Then 映射示例**:
- **1.6-INT-032**:
  - Given: 用户修改密码成功
  - When: 操作完成
  - Then: audit_logs 表插入记录 {userId, action: "CHANGE_PASSWORD", ipAddress, timestamp}

---

## 风险覆盖映射

基于风险评估报告，以下测试场景覆盖了识别的风险：

### Critical Risks (Score 9)

| 风险 ID  | 风险描述                     | 覆盖测试场景                                    |
|---------|------------------------------|-------------------------------------------------|
| SEC-001 | 密码修改安全控制不足          | 1.6-INT-005 ~ 012, 1.6-UNIT-012 ~ 017, 1.6-E2E-004 |
| SEC-002 | 账户删除缺乏审计日志          | 1.6-INT-012, 1.6-INT-022, 1.6-INT-031 ~ 034   |

### High Risks (Score 6)

| 风险 ID   | 风险描述                     | 覆盖测试场景                                    |
|----------|------------------------------|-------------------------------------------------|
| DATA-001 | 级联删除配置风险              | 1.6-INT-019 ~ 021, 1.6-E2E-007                |
| SEC-003  | OAuth 用户密码防护不完整      | 1.6-INT-009, 1.6-E2E-005                       |

### Medium Risks (Score 4)

| 风险 ID   | 风险描述                     | 覆盖测试场景                                    |
|----------|------------------------------|-------------------------------------------------|
| PERF-001 | 使用量查询性能问题            | 1.6-INT-015                                    |
| OPS-001  | Rate limiter 可靠性问题       | 1.6-INT-010, 1.6-INT-011, 1.6-INT-023         |

### Low Risks (Score 2-3)

| 风险 ID   | 风险描述                     | 覆盖测试场景                                    |
|----------|------------------------------|-------------------------------------------------|
| TECH-001 | Session 清除时序问题          | 1.6-E2E-007                                    |
| DATA-002 | 存储空间显示不准确            | 1.6-UNIT-021 ~ 023                             |

---

## 测试执行优先级

### Phase 1: P0 单元测试（快速反馈）

**目标**: 5分钟内完成，捕获基本逻辑错误

1. 1.6-UNIT-003: 用户名长度验证
2. 1.6-UNIT-004: 用户名空字符串验证
3. 1.6-UNIT-012: 密码至少8位
4. 1.6-UNIT-013: 密码包含字母和数字
5. 1.6-UNIT-014: 密码一致性验证

**执行命令**: `npm test -- --testPathPattern=unit/api/user-settings`

---

### Phase 2: P0 集成测试（核心功能）

**目标**: 15分钟内完成，验证 API 和数据库交互

**安全相关 (优先执行)**:
1. 1.6-INT-005: 密码修改成功
2. 1.6-INT-006: 当前密码错误验证
3. 1.6-INT-007: passwordHash 更新
4. 1.6-INT-008: bcrypt 哈希验证
5. 1.6-INT-009: OAuth 用户密码限制
6. 1.6-INT-010: Rate limiting 验证
7. 1.6-INT-012: 密码修改审计日志

**数据相关**:
8. 1.6-INT-016: 账户删除成功
9. 1.6-INT-017: 邮箱匹配验证
10. 1.6-INT-019: 级联删除验证
11. 1.6-INT-020: documents 级联删除
12. 1.6-INT-021: user_usage 级联删除
13. 1.6-INT-022: 账户删除审计日志

**认证相关**:
14. 1.6-INT-024 ~ 028: 所有 API 未登录返回 401

**执行命令**: `npm test -- --testPathPattern=integration/settings-flow`

---

### Phase 3: P0 E2E 测试（关键路径）

**目标**: 10分钟内完成，验证完整用户流程

1. 1.6-E2E-001: 未登录跳转
2. 1.6-E2E-004: 完整密码修改流程
3. 1.6-E2E-007: 完整账户删除流程

**执行命令**: `npm test -- --testPathPattern=e2e/account-settings`

---

### Phase 4: P1 测试（核心体验）

**单元测试**:
- 1.6-UNIT-005 ~ 011: 边界条件和 UI 逻辑
- 1.6-UNIT-015 ~ 017: 密码强度指示器
- 1.6-UNIT-018 ~ 020: 进度条颜色逻辑

**集成测试**:
- 1.6-INT-002 ~ 004: 个人信息 API
- 1.6-INT-011: Rate limiting 429
- 1.6-INT-013 ~ 014: 使用量统计 API
- 1.6-INT-029 ~ 030: API 规范
- 1.6-INT-033: 审计日志（个人信息）
- 1.6-INT-035: 双重验证

**E2E 测试**:
- 1.6-E2E-002: 已登录访问设置页面
- 1.6-E2E-003: 用户名修改流程
- 1.6-E2E-005: OAuth 用户 UI 差异
- 1.6-E2E-008: 删除后存储清除

---

### Phase 5: P2 测试（次要功能）

**单元测试**:
- 1.6-UNIT-001 ~ 002: 页面布局元素
- 1.6-UNIT-008 ~ 011: UI 显示逻辑
- 1.6-UNIT-021 ~ 023: 存储空间格式化
- 1.6-UNIT-024: Toast 提示

**集成测试**:
- 1.6-INT-001: 卡片区域验证
- 1.6-INT-015: 数据库索引验证

**E2E 测试**:
- 1.6-E2E-006: 使用量统计 UI

---

## 测试数据需求

### 用户账户数据

```typescript
const testUsers = {
  emailUser: {
    email: 'email-user@test.com',
    passwordHash: bcrypt.hashSync('Test1234', 10),
    name: 'Email User',
    authProvider: 'EMAIL',
    avatarUrl: null
  },
  googleUser: {
    email: 'google-user@test.com',
    passwordHash: null,
    name: 'Google User',
    authProvider: 'GOOGLE',
    avatarUrl: 'https://example.com/avatar.jpg'
  },
  githubUser: {
    email: 'github-user@test.com',
    passwordHash: null,
    name: 'GitHub User',
    authProvider: 'GITHUB',
    avatarUrl: 'https://github.com/avatar.jpg'
  }
}
```

### 使用量统计数据

```typescript
const testUsage = {
  normal: {
    documentCount: 10,
    storageUsed: 100 * 1024 * 1024, // 100 MB
    queryCount: 150,
    queryResetDate: new Date('2025-02-01')
  },
  nearLimit: {
    documentCount: 45, // 90% of 50
    storageUsed: 850 * 1024 * 1024, // 850 MB (85% of 1GB)
    queryCount: 850, // 85% of 1000
    queryResetDate: new Date('2025-02-01')
  },
  overLimit: {
    documentCount: 51, // Over limit
    storageUsed: 1.2 * 1024 * 1024 * 1024, // 1.2 GB
    queryCount: 1050, // Over limit
    queryResetDate: new Date('2025-02-01')
  }
}
```

### 边界条件测试数据

```typescript
const edgeCases = {
  userNames: {
    valid: ['AB', 'A'.repeat(50)], // Min and max length
    invalid: ['A', 'A'.repeat(51), '', '   '] // Too short, too long, empty
  },
  passwords: {
    valid: ['Pass1234', 'VeryStr0ngP@ssw0rd!'],
    weak: ['1234567', 'password', 'AAAAAAAA'],
    invalid: ['Pass', 'password123'] // Too short, no number
  },
  emails: {
    valid: ['user@example.com'],
    mismatch: ['wrong@example.com', 'USER@EXAMPLE.COM']
  }
}
```

---

## 测试环境要求

### 数据库配置

- PostgreSQL 测试实例
- 独立的测试数据库
- 测试前清空数据
- 测试后恢复初始状态

### API Mock 需求

- NextAuth session mock
- bcrypt 在单元测试中可选 mock（加速）
- Rate limiter 需要实际实例（Redis 或内存）

### 测试隔离

```typescript
// 每个测试前
beforeEach(async () => {
  await cleanDatabase()
  await seedTestData()
})

// 每个测试后
afterEach(async () => {
  await cleanDatabase()
})
```

---

## 覆盖率目标

### 代码覆盖率

- **API 路由**: ≥90% (关键业务逻辑)
- **组件**: ≥80% (UI 渲染和交互)
- **工具函数**: 100% (格式化、验证函数)

### 功能覆盖率

- **验收标准**: 100% (所有 AC 都有测试)
- **关键风险**: 100% (所有 P0 风险有对应测试)
- **边界条件**: ≥80%

---

## 测试维护策略

### 测试稳定性

- 避免硬编码时间戳（使用相对时间）
- 使用测试工厂生成数据
- 避免测试间依赖
- 清晰的测试命名

### 测试可读性

```typescript
// Good: 清晰的测试描述
describe('PATCH /api/user/password', () => {
  it('should successfully change password for EMAIL users', async () => {
    // Given: EMAIL user with current password
    const user = await createTestUser({ authProvider: 'EMAIL' })
    
    // When: Request password change
    const response = await request(app)
      .patch('/api/user/password')
      .send({
        currentPassword: 'OldPass123',
        newPassword: 'NewPass456',
        confirmPassword: 'NewPass456'
      })
    
    // Then: Password updated successfully
    expect(response.status).toBe(200)
    const updatedUser = await getUser(user.id)
    expect(await bcrypt.compare('NewPass456', updatedUser.passwordHash)).toBe(true)
  })
})
```

### 性能优化

- 单元测试并行执行
- 集成测试可能需要串行（数据库共享）
- E2E 测试独立运行（启动完整应用）

---

## 质量检查清单

在提交测试代码前验证：

- [ ] 每个 AC 至少有一个测试场景
- [ ] 所有 P0 测试场景已实现
- [ ] 测试 ID 遵循命名规范 `{epic}.{story}-{LEVEL}-{SEQ}`
- [ ] 所有测试相互独立
- [ ] 测试数据使用工厂模式生成
- [ ] 敏感操作有安全测试（SEC-001, SEC-002, SEC-003）
- [ ] 级联删除有完整验证（DATA-001）
- [ ] Rate limiting 有集成测试（OPS-001）
- [ ] 审计日志记录被验证（SEC-002）
- [ ] 所有边界条件被测试
- [ ] 测试描述清晰可读
- [ ] 测试可以稳定重复执行

---

## 附录: 测试命令速查

```bash
# 运行所有测试
npm test

# 运行单元测试
npm test -- --testPathPattern=unit

# 运行集成测试
npm test -- --testPathPattern=integration

# 运行 E2E 测试
npm test -- --testPathPattern=e2e

# 运行特定文件
npm test -- user-settings.test.ts

# 运行 P0 测试（需要在 package.json 配置）
npm run test:p0

# 生成覆盖率报告
npm test -- --coverage

# 监听模式
npm test -- --watch

# 单次运行（CI 环境）
npm test -- --ci --coverage
```

---

## 下一步行动

1. **开发团队**: 参考测试场景实现功能
2. **测试团队**: 根据测试设计编写测试代码
3. **QA 审查**: 实现完成后运行 `*trace 1.6` 验证需求覆盖

---

**文档生成时间**: 2025-01-08  
**下次审查**: 实现完成后

