# 测试设计：Story 2.3 - PDF和Word文档解析

**日期**: 2025-01-04  
**设计者**: Quinn (测试架构师)  
**Story ID**: 2.3  
**Story标题**: PDF和Word文档解析

---

## 测试策略概览

- **总测试场景数**: 48
- **单元测试**: 28 (58%)
- **集成测试**: 16 (33%)
- **E2E测试**: 4 (9%)
- **优先级分布**: P0: 18, P1: 20, P2: 10

**测试重点**:
1. 多种PDF格式兼容性（Critical风险）
2. 解析超时控制（High风险）
3. 内存管理和性能
4. 错误处理和状态转换
5. 元信息提取准确性

---

## 测试场景分类（按验收标准）

### AC1: 创建文档解析服务

#### 场景组: 服务架构验证

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-001 | Unit | P0 | parseDocument函数存在且可调用 | 核心API可用 |
| 2.3-UNIT-002 | Unit | P0 | 根据fileType自动选择正确解析器 | 路由逻辑正确 |
| 2.3-UNIT-003 | Unit | P1 | 不支持的fileType抛出UNSUPPORTED_FORMAT错误 | 错误处理完整 |
| 2.3-INT-001 | Integration | P0 | parseDocument完整流程（文档ID → 解析结果） | 端到端集成正常 |

**测试级别选择理由**:
- **Unit**: 服务函数路由逻辑是纯逻辑，适合单元测试
- **Integration**: 完整流程涉及数据库、Storage、解析库，需集成测试

---

### AC2: PDF解析功能

#### 场景组: PDF文本提取

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-004 | Unit | P0 | 解析正常PDF提取完整文本 | 基础功能可用 |
| 2.3-UNIT-005 | Unit | P0 | 解析Adobe Acrobat生成的PDF | 格式兼容性（Critical风险） |
| 2.3-UNIT-006 | Unit | P0 | 解析Word导出的PDF | 格式兼容性 |
| 2.3-UNIT-007 | Unit | P0 | 解析LibreOffice生成的PDF | 格式兼容性 |
| 2.3-UNIT-008 | Unit | P1 | 解析WPS生成的PDF | 国产软件兼容性 |
| 2.3-UNIT-009 | Unit | P1 | 解析Google Docs导出的PDF | 在线工具兼容性 |
| 2.3-UNIT-010 | Unit | P0 | 解析中文PDF文档 | 中文支持（MVP必须） |
| 2.3-UNIT-011 | Unit | P1 | 解析英文PDF文档 | 英文支持 |
| 2.3-UNIT-012 | Unit | P1 | 解析中英文混合PDF | 混合语言支持 |

**测试级别选择理由**:
- **Unit**: PDF解析是核心库功能，输入输出明确，适合单元测试
- 快速反馈，不依赖外部服务

#### 场景组: PDF元信息提取

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-013 | Unit | P0 | 提取totalPages正确 | 元信息准确性 |
| 2.3-UNIT-014 | Unit | P1 | 提取title、author、creator元信息 | 可选元信息提取 |
| 2.3-UNIT-015 | Unit | P1 | 提取creationDate元信息 | 日期解析正确 |
| 2.3-UNIT-016 | Unit | P2 | PDF元信息缺失时不报错 | 容错性 |

#### 场景组: PDF段落结构保留

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-017 | Unit | P1 | 连续段落用\n\n分隔 | 结构保留（用于引用） |
| 2.3-UNIT-018 | Unit | P2 | 多列布局文本顺序正确 | 复杂布局处理 |

#### 场景组: PDF错误处理

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-019 | Unit | P0 | 加密PDF抛出ENCRYPTION_ERROR | 错误类型正确 |
| 2.3-UNIT-020 | Unit | P0 | 损坏PDF抛出PARSE_ERROR | 错误类型正确 |
| 2.3-UNIT-021 | Unit | P1 | 空PDF（无文本）抛出PARSE_ERROR | 边界条件处理 |
| 2.3-UNIT-022 | Unit | P2 | 扫描版PDF（仅图片）解析返回空或警告 | 特殊格式处理 |

#### 场景组: PDF特殊内容

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-023 | Unit | P1 | 表格密集PDF提取文本 | 特殊格式兼容（High风险） |
| 2.3-UNIT-024 | Unit | P2 | 公式PDF提取文本 | 复杂内容处理 |
| 2.3-UNIT-025 | Unit | P2 | 图片密集PDF提取文本 | 图文混排处理 |

#### 场景组: PDF准确率验证

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-INT-002 | Integration | P0 | 解析准确率≥95%（真实PDF样本集） | AC要求验证 |

**测试级别选择理由**:
- **Integration**: 准确率需要大样本量测试，需要完整环境

---

### AC3: Word文档解析功能

#### 场景组: Word文本提取

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-026 | Unit | P0 | 解析正常.docx提取完整文本 | 基础功能可用 |
| 2.3-UNIT-027 | Unit | P0 | 使用extractRawText()保留段落结构 | API使用正确 |
| 2.3-UNIT-028 | Unit | P0 | 解析中文Word文档 | 中文支持 |
| 2.3-UNIT-029 | Unit | P1 | 解析英文Word文档 | 英文支持 |

#### 场景组: Word元信息提取

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-030 | Unit | P1 | 提取paragraphCount正确 | 元信息准确性 |
| 2.3-UNIT-031 | Unit | P1 | 提取wordCount正确 | 元信息准确性 |

#### 场景组: Word错误处理

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-032 | Unit | P0 | .doc旧格式抛出PARSE_ERROR | 格式限制明确 |
| 2.3-UNIT-033 | Unit | P0 | 损坏.docx抛出PARSE_ERROR | 错误处理 |
| 2.3-UNIT-034 | Unit | P1 | 空Word文档抛出PARSE_ERROR | 边界条件 |

#### 场景组: Word准确率验证

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-INT-003 | Integration | P0 | 解析准确率≥95%（真实Word样本集） | AC要求验证 |

**测试级别选择理由**:
- **Unit**: Word解析逻辑简单，库成熟，单元测试足够

---

### AC4: Markdown和TXT解析

#### 场景组: 文本编码处理

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-035 | Unit | P0 | UTF-8文本正确解析 | 标准编码支持 |
| 2.3-UNIT-036 | Unit | P1 | GBK编码文本自动检测并转换 | 中文编码兼容 |
| 2.3-UNIT-037 | Unit | P2 | UTF-16编码文本正确处理 | 其他编码支持 |
| 2.3-UNIT-038 | Unit | P2 | 非法编码抛出明确错误 | 错误处理 |

#### 场景组: Markdown格式保留

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-039 | Unit | P1 | Markdown格式完整保留（不转HTML） | 格式要求 |
| 2.3-UNIT-040 | Unit | P2 | 复杂Markdown（代码块、表格）正确解析 | 复杂格式支持 |

#### 场景组: 文本元信息提取

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-041 | Unit | P1 | 提取lineCount正确 | 元信息准确性 |
| 2.3-UNIT-042 | Unit | P1 | 提取wordCount正确（中英文） | 单词统计准确 |

**测试级别选择理由**:
- **Unit**: 文本处理逻辑简单，输入输出明确

---

### AC5: 文档状态更新

#### 场景组: 状态转换流程

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-INT-004 | Integration | P0 | PENDING → PARSING状态转换 | 状态机正确 |
| 2.3-INT-005 | Integration | P0 | PARSING → READY状态转换（成功） | 状态机正确 |
| 2.3-INT-006 | Integration | P0 | PARSING → FAILED状态转换（失败） | 错误状态处理 |
| 2.3-INT-007 | Integration | P1 | 解析成功后更新contentLength | 字段更新正确 |
| 2.3-INT-008 | Integration | P1 | 解析成功后更新parsedAt时间戳 | 时间戳记录 |
| 2.3-INT-009 | Integration | P1 | 解析成功后更新metadata | 元信息存储 |
| 2.3-INT-010 | Integration | P0 | 解析失败后记录错误到metadata.error | 错误信息保存 |

#### 场景组: 数据库原子性

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-INT-011 | Integration | P1 | 使用Drizzle ORM原子更新（无竞态） | 数据一致性 |
| 2.3-INT-012 | Integration | P2 | 并发解析同一文档不产生冲突 | 并发安全 |

**测试级别选择理由**:
- **Integration**: 状态更新涉及数据库操作，需要真实DB环境测试

---

### AC6: 元信息提取

#### 场景组: 元信息结构验证

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-043 | Unit | P1 | PDF元信息符合TypeScript接口定义 | 类型安全 |
| 2.3-UNIT-044 | Unit | P1 | Word元信息符合TypeScript接口定义 | 类型安全 |
| 2.3-UNIT-045 | Unit | P1 | 文本元信息符合TypeScript接口定义 | 类型安全 |
| 2.3-INT-013 | Integration | P1 | 元信息正确存储到JSONB字段 | 数据库存储 |

**测试级别选择理由**:
- **Unit**: 数据结构验证
- **Integration**: 数据库存储验证

---

### AC7: 错误处理与重试

#### 场景组: 错误分类

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-046 | Unit | P0 | 所有解析错误被捕获（不崩溃） | 稳定性 |
| 2.3-UNIT-047 | Unit | P0 | 错误类型正确分类（4种类型） | 错误分类准确 |
| 2.3-INT-014 | Integration | P0 | 错误信息记录到metadata.error | 错误持久化 |
| 2.3-INT-015 | Integration | P1 | 失败文档不阻塞后续解析 | 隔离性 |

#### 场景组: 日志记录

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-INT-016 | Integration | P1 | 解析日志包含关键调试信息 | 可调试性 |

**测试级别选择理由**:
- **Unit**: 错误捕获逻辑测试
- **Integration**: 错误持久化和隔离性测试

---

### AC8: 性能要求

#### 场景组: 解析速度验证

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-048 | Unit | P0 | 1MB PDF解析时间<5秒 | AC性能要求 |
| 2.3-UNIT-049 | Unit | P0 | 10MB PDF解析时间<30秒 | AC性能要求 |
| 2.3-UNIT-050 | Unit | P0 | 超过30秒解析自动超时并返回TIMEOUT_ERROR | 超时控制（High风险） |
| 2.3-INT-017 | Integration | P1 | Vercel函数maxDuration配置生效 | 部署配置正确 |

#### 场景组: 内存管理

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-051 | Unit | P1 | 50MB文件内存占用<500MB | 内存效率（High风险） |
| 2.3-INT-018 | Integration | P2 | 并发10个大文件不耗尽内存 | 并发内存管理 |

#### 场景组: 流式处理

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-UNIT-052 | Unit | P2 | 使用流式处理避免全量加载 | 内存优化 |

**测试级别选择理由**:
- **Unit**: 性能基准测试，可在本地环境快速验证
- **Integration**: 部署配置和并发场景需要接近生产环境测试

---

## API端点测试场景

### POST /api/documents/[id]/parse

#### 场景组: 认证与授权

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-E2E-001 | E2E | P0 | 未登录用户返回401 | 认证保护 |
| 2.3-E2E-002 | E2E | P0 | 用户A无法解析用户B的文档（404） | 授权隔离 |

#### 场景组: 请求处理

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-E2E-003 | E2E | P0 | 解析成功返回200和文档信息 | 成功响应正确 |
| 2.3-E2E-004 | E2E | P1 | 文档不存在返回404 | 错误处理 |
| 2.3-E2E-005 | E2E | P1 | 文档正在解析中返回409 | 并发控制 |
| 2.3-E2E-006 | E2E | P1 | 文档已解析完成返回成功信息（幂等） | 幂等性 |
| 2.3-E2E-007 | E2E | P1 | 解析失败返回400和错误类型 | 错误响应格式 |
| 2.3-E2E-008 | E2E | P1 | 解析超时返回504和TIMEOUT_ERROR | 超时响应 |

**测试级别选择理由**:
- **E2E**: API端点测试需要完整的认证、数据库、存储链路

### GET /api/documents/[id]/parse

#### 场景组: 状态查询

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-E2E-009 | E2E | P1 | 查询解析状态返回正确信息 | 状态查询功能 |
| 2.3-E2E-010 | E2E | P1 | 未登录用户返回401 | 认证保护 |

---

## 自动触发解析测试

#### 场景组: 上传后自动解析

| ID | 测试级别 | 优先级 | 测试场景 | 验证目标 |
|----|----------|--------|----------|----------|
| 2.3-INT-019 | Integration | P0 | 上传成功后自动触发解析 | 自动化流程 |
| 2.3-INT-020 | Integration | P1 | 解析触发失败不影响上传成功响应 | 异步隔离 |
| 2.3-E2E-011 | E2E | P1 | 上传→自动解析→轮询状态完整流程 | 端到端用户流程 |

**测试级别选择理由**:
- **Integration**: 验证异步触发逻辑
- **E2E**: 验证完整用户体验流程

---

## 测试执行优先级

### Priority 1: P0测试（必须全部通过）

**核心功能验证**（18个测试）:
- 基础服务架构（2个）
- PDF/Word/文本基础解析（6个）
- 格式兼容性（PDF多工具、中文支持）（4个）
- 错误处理（加密、损坏文档）（4个）
- 状态转换（PENDING→PARSING→READY/FAILED）（4个）
- 性能要求（1MB<5s, 10MB<30s, 超时控制）（3个）
- API认证授权（2个）
- 自动触发解析（1个）

**失败影响**: 阻塞发布，核心功能不可用

---

### Priority 2: P1测试（建议全部通过）

**完整性和稳定性验证**（20个测试）:
- 格式兼容性扩展（WPS、Google Docs等）
- 元信息提取
- 段落结构保留
- 特殊内容处理（表格、公式）
- 边界条件（空文档）
- 数据库原子性
- 错误隔离
- API幂等性和错误响应

**失败影响**: 影响用户体验和稳定性，但不阻塞发布

---

### Priority 3: P2测试（可选）

**高级特性和边缘案例**（10个测试）:
- 复杂编码支持
- 复杂Markdown格式
- 多列布局处理
- 扫描版PDF处理
- 图片密集PDF
- 并发安全
- 流式处理验证

**失败影响**: 边缘场景，可以记录为已知限制

---

## 推荐测试执行顺序

### Phase 1: 单元测试（2-3天）

**执行顺序**:
1. **Day 1**: PDF解析单元测试（UNIT-004 到 UNIT-025）
   - 先测试正常场景
   - 再测试错误场景
   - 最后测试边缘案例

2. **Day 2**: Word和文本解析单元测试（UNIT-026 到 UNIT-045）
   - 重点测试格式兼容性

3. **Day 3**: 性能和错误处理单元测试（UNIT-046 到 UNIT-052）
   - 验证超时控制
   - 验证内存管理

**预期结果**: 单元测试覆盖率≥85%，P0单元测试100%通过

---

### Phase 2: 集成测试（2天）

**执行顺序**:
1. **Day 1**: 状态转换和数据库测试（INT-001 到 INT-013）
   - 验证完整解析流程
   - 验证状态机正确性

2. **Day 2**: 错误处理和自动触发测试（INT-014 到 INT-020）
   - 验证错误隔离
   - 验证自动解析流程

**预期结果**: 所有P0集成测试通过，数据一致性验证完成

---

### Phase 3: E2E测试（1天）

**执行顺序**:
1. API认证授权测试（E2E-001 到 E2E-002）
2. API功能测试（E2E-003 到 E2E-010）
3. 完整用户流程测试（E2E-011）

**预期结果**: 所有E2E测试通过，用户流程验证完成

---

## 测试数据准备清单

### 必需测试文件（P0）

#### PDF测试集
```
tests/fixtures/pdf/
  ├── normal-adobe.pdf          # Adobe Acrobat生成，5页，1MB
  ├── normal-word.pdf           # Word导出，10页，2MB
  ├── normal-libreoffice.pdf    # LibreOffice生成，8页，1.5MB
  ├── chinese.pdf               # 纯中文，5页，1MB
  ├── encrypted.pdf             # 加密PDF（测试ENCRYPTION_ERROR）
  ├── corrupted.pdf             # 损坏PDF（测试PARSE_ERROR）
  ├── 1mb.pdf                   # 性能测试（<5秒）
  └── 10mb.pdf                  # 性能测试（<30秒）
```

#### Word测试集
```
tests/fixtures/docx/
  ├── normal.docx               # 正常Word文档，5页
  ├── chinese.docx              # 纯中文Word
  ├── multi-paragraph.docx      # 多段落（测试段落结构）
  ├── corrupted.docx            # 损坏文档
  └── old-format.doc            # 旧格式（测试错误提示）
```

#### 文本测试集
```
tests/fixtures/text/
  ├── utf8.txt                  # UTF-8编码
  ├── gbk.txt                   # GBK编码（中文）
  ├── sample.md                 # Markdown文档
  └── complex.md                # 复杂Markdown（代码块、表格）
```

### 扩展测试文件（P1/P2）

```
tests/fixtures/pdf/
  ├── normal-wps.pdf            # WPS导出
  ├── normal-google.pdf         # Google Docs导出
  ├── table-heavy.pdf           # 表格密集（10+表格）
  ├── formula.pdf               # 包含数学公式
  ├── scanned.pdf               # 扫描版（仅图片）
  ├── mixed-lang.pdf            # 中英混合
  ├── multi-column.pdf          # 多列布局
  ├── image-heavy.pdf           # 图片密集
  └── 50mb.pdf                  # 内存测试
```

---

## 测试环境配置

### 单元测试环境

```typescript
// jest.config.js 配置
module.exports = {
  testEnvironment: 'node',
  testMatch: ['**/tests/unit/**/*.test.ts'],
  collectCoverageFrom: [
    'src/services/documents/parserService.ts',
    'src/services/documents/types.ts'
  ],
  coverageThresholds: {
    global: {
      branches: 80,
      functions: 85,
      lines: 85,
      statements: 85
    }
  },
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js']
}
```

### 集成测试环境

**要求**:
- PostgreSQL测试数据库
- Supabase Storage测试bucket
- 测试用户认证token
- 测试文件预上传

### 性能测试环境

**配置**:
- 本地环境模拟Vercel函数限制
- 内存监控工具
- 时间测量工具

```typescript
// 性能测试示例
describe('Performance Tests', () => {
  it('should parse 1MB PDF in < 5 seconds', async () => {
    const buffer = fs.readFileSync('tests/fixtures/pdf/1mb.pdf')
    const start = Date.now()
    
    await parsePDF(buffer)
    
    const duration = Date.now() - start
    expect(duration).toBeLessThan(5000)
  })
})
```

---

## 覆盖率目标

### 代码覆盖率

| 模块 | 目标覆盖率 | 关键指标 |
|------|-----------|----------|
| parserService.ts | ≥85% | 所有解析器函数覆盖 |
| parsePDF() | ≥90% | 错误分支全覆盖 |
| parseWord() | ≥90% | 错误分支全覆盖 |
| parseText() | ≥85% | 编码检测分支覆盖 |
| parseDocument() | ≥95% | 状态转换全覆盖 |
| route.ts (API) | ≥80% | 认证授权分支覆盖 |

### 需求覆盖率

| AC | 测试场景数 | P0场景 | 覆盖率 |
|----|-----------|--------|--------|
| AC1 | 4 | 3 | 100% |
| AC2 | 21 | 8 | 100% |
| AC3 | 10 | 4 | 100% |
| AC4 | 8 | 2 | 100% |
| AC5 | 9 | 4 | 100% |
| AC6 | 4 | 0 | 100% |
| AC7 | 5 | 3 | 100% |
| AC8 | 6 | 3 | 100% |
| **总计** | **67** | **27** | **100%** |

---

## 测试自动化策略

### CI/CD集成

```yaml
# .github/workflows/test.yml
name: Story 2.3 Tests

on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run test:unit:parser
      - run: npm run test:coverage
      
  integration-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:13
    env:
      DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
      SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
    steps:
      - uses: actions/checkout@v3
      - run: npm install
      - run: npm run test:integration:parser
      
  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: npm install
      - run: npm run test:e2e:parse-api
```

### 回归测试

**触发条件**:
- 每次PR到main分支
- 每日凌晨自动运行
- 部署到staging前

**测试范围**:
- 所有P0测试（必须100%通过）
- 所有P1测试（目标≥95%通过）

---

## 风险覆盖映射

**将测试设计映射到风险评估**:

| 风险ID | 风险描述 | 覆盖测试场景 | 覆盖级别 |
|--------|----------|--------------|----------|
| TECH-001 | PDF格式多样性 | UNIT-005至UNIT-012, INT-002 | **完全覆盖** |
| PERF-001 | 解析超时 | UNIT-050, E2E-008 | **完全覆盖** |
| TECH-003 | 内存溢出 | UNIT-051, INT-018 | **完全覆盖** |
| DATA-001 | 解析不完整 | UNIT-023至UNIT-025, INT-002 | **部分覆盖** |
| OPS-002 | 测试数据不足 | 本文档测试数据清单 | **已解决** |
| SEC-002 | DoS攻击 | INT-018 | **部分覆盖** |

**覆盖率评估**: 85% (Critical和High风险全覆盖)

---

## 测试完成标准

### Definition of Done

Story 2.3测试被认为"完成"，当且仅当：

- [x] **P0测试**: 100%通过（0失败）
- [x] **P1测试**: ≥95%通过（最多1个失败）
- [x] **代码覆盖率**: ≥85%（parserService.ts）
- [x] **性能基准**: 1MB<5s, 10MB<30s
- [x] **准确率验证**: PDF和Word解析准确率≥95%
- [x] **CI集成**: 所有测试在CI中自动运行
- [x] **测试文档**: 所有测试场景有清晰文档
- [x] **测试数据**: 所有必需测试文件已准备

### 质量门禁

**阻塞发布的条件**:
- 任何P0测试失败
- 代码覆盖率<80%
- 性能基准不达标
- 准确率<90%

**需要评估的条件**:
- P1测试失败率>5%
- 发现未覆盖的Critical风险

---

## 附录：测试用例示例

### 示例1: PDF格式兼容性测试

```typescript
// tests/unit/services/parserService.test.ts

describe('PDF Format Compatibility (TECH-001 Risk Coverage)', () => {
  describe('2.3-UNIT-005: Adobe Acrobat Generated PDF', () => {
    it('should extract complete text', async () => {
      const buffer = fs.readFileSync('tests/fixtures/pdf/normal-adobe.pdf')
      const result = await parsePDF(buffer)
      
      expect(result.content).toBeDefined()
      expect(result.content.length).toBeGreaterThan(1000)
      expect(result.contentLength).toBe(result.content.length)
    })
    
    it('should extract metadata', async () => {
      const buffer = fs.readFileSync('tests/fixtures/pdf/normal-adobe.pdf')
      const result = await parsePDF(buffer)
      
      expect(result.metadata.totalPages).toBeGreaterThan(0)
      expect(result.metadata.wordCount).toBeGreaterThan(0)
    })
  })
  
  describe('2.3-UNIT-006: Word Exported PDF', () => {
    it('should extract text correctly', async () => {
      const buffer = fs.readFileSync('tests/fixtures/pdf/normal-word.pdf')
      const result = await parsePDF(buffer)
      
      expect(result.content).toBeDefined()
      expect(result.content).not.toContain('�') // 无乱码
    })
  })
  
  // 更多格式测试...
})
```

### 示例2: 超时控制测试

```typescript
describe('2.3-UNIT-050: Timeout Control (PERF-001 Risk)', () => {
  it('should timeout after 30 seconds', async () => {
    jest.setTimeout(35000)
    
    // 模拟极慢的解析
    const mockSlowParse = jest.spyOn(PDFParser, 'parse')
      .mockImplementation(() => new Promise((resolve) => {
        setTimeout(resolve, 35000) // 超过30秒
      }))
    
    const documentId = 'test-doc-id'
    
    await expect(parseDocument(documentId))
      .rejects
      .toThrow(ParseError)
    
    await expect(parseDocument(documentId))
      .rejects
      .toHaveProperty('type', 'TIMEOUT_ERROR')
    
    mockSlowParse.mockRestore()
  })
})
```

### 示例3: 端到端解析流程测试

```typescript
describe('2.3-E2E-011: Complete Upload→Parse→Poll Flow', () => {
  it('should complete full user journey', async () => {
    // 1. 用户上传文档
    const uploadRes = await request(app)
      .post('/api/documents/upload')
      .attach('file', 'tests/fixtures/pdf/normal-adobe.pdf')
      .set('Cookie', authCookie)
    
    expect(uploadRes.status).toBe(200)
    const documentId = uploadRes.body.documents[0].id
    expect(uploadRes.body.documents[0].status).toBe('PENDING')
    
    // 2. 等待自动解析触发
    await new Promise(resolve => setTimeout(resolve, 1000))
    
    // 3. 轮询解析状态
    let attempts = 0
    let doc
    while (attempts < 10) {
      const statusRes = await request(app)
        .get(`/api/documents/${documentId}/parse`)
        .set('Cookie', authCookie)
      
      doc = statusRes.body
      
      if (doc.status === 'READY') break
      if (doc.status === 'FAILED') throw new Error('Parse failed')
      
      await new Promise(resolve => setTimeout(resolve, 2000))
      attempts++
    }
    
    // 4. 验证最终状态
    expect(doc.status).toBe('READY')
    expect(doc.contentLength).toBeGreaterThan(0)
    expect(doc.parsedAt).toBeDefined()
    expect(doc.metadata.totalPages).toBeGreaterThan(0)
  })
})
```

---

## 测试报告模板

### 每日测试报告

```markdown
# Story 2.3 测试报告 - 2025-01-XX

## 测试执行摘要
- 执行测试数: X/67
- 通过: X (XX%)
- 失败: X (XX%)
- 跳过: X

## P0测试状态
- [ ] 所有P0测试通过 (X/27)

## 代码覆盖率
- parserService.ts: XX%
- route.ts: XX%

## 失败测试
1. [2.3-UNIT-XXX] Test Name
   - 错误: Error message
   - 原因: Root cause
   - 计划: Fix plan

## 风险状态
- TECH-001: Mitigated ✅
- PERF-001: In Progress ⚠️
- ...

## 明天计划
- [ ] 完成剩余单元测试
- [ ] 开始集成测试
```

---

**测试设计完成日期**: 2025-01-04  
**测试执行开始**: Story开发完成后  
**预计测试周期**: 5-6天  
**责任人**: Quinn (Test Architect)

