# Risk Profile: Story 4.1 - æ·»åŠ ä¸Šä¼ é€Ÿç‡é™åˆ¶

**Story ID**: 4.1  
**Date**: 2025-01-15  
**Reviewer**: Quinn (Test Architect)

---

## Executive Summary

- **Total Risks Identified**: 6
- **Critical Risks**: 0
- **High Risks**: 1
- **Medium Risks**: 3
- **Low Risks**: 2
- **Risk Score**: 83/100 (Low to Medium Risk)

**Overall Assessment**: è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹ä½é£é™©çš„å®‰å…¨å¢å¼ºStoryï¼Œä½†éœ€è¦æ³¨æ„å‡ ä¸ªå…³é”®çš„æŠ€æœ¯å’Œè¿ç»´é£é™©ã€‚ä¸»è¦é£é™©é›†ä¸­åœ¨å¤–éƒ¨ä¾èµ–ï¼ˆUpstash Redisï¼‰çš„å¯ç”¨æ€§å’Œé™çº§ç­–ç•¥ä¸Šã€‚

---

## Critical Risks Requiring Immediate Attention

**æ—  Critical çº§åˆ«é£é™©** âœ…

---

## High Risks Requiring Attention

### 1. [OPS-001]: Upstash Redis æœåŠ¡ä¸å¯ç”¨å¯¼è‡´é™æµå¤±è´¥

**Score: 6 (High Risk)**  
**Probability**: Medium (2) - Upstash ä½œä¸ºå¤–éƒ¨æœåŠ¡ï¼Œå­˜åœ¨ä¸€å®šçš„ä¸å¯ç”¨é£é™©  
**Impact**: High (3) - å¦‚æœé™æµå®Œå…¨å¤±è´¥ï¼ŒDoS é˜²æŠ¤å°†å¤±æ•ˆï¼Œå½±å“ç³»ç»Ÿå®‰å…¨

**è¯¦ç»†æè¿°**:
- Upstash Redis ä½œä¸ºå¤–éƒ¨ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå¯èƒ½å› ç½‘ç»œé—®é¢˜ã€æœåŠ¡ç»´æŠ¤æˆ–æ•…éšœè€Œä¸å¯ç”¨
- å½“å‰å®ç°ä¸­ï¼Œå¦‚æœ Redis ä¸å¯ç”¨ï¼Œé€Ÿç‡é™åˆ¶æ£€æŸ¥å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´ä¸Šä¼ ç«¯ç‚¹å®Œå…¨ä¸å¯ç”¨
- è¿™ä¼šé€ æˆæ¯”æ²¡æœ‰é™æµæ›´ä¸¥é‡çš„åæœï¼šåˆæ³•ç”¨æˆ·ä¹Ÿæ— æ³•ä¸Šä¼ 

**å½±å“çš„ç»„ä»¶**:
- `src/lib/rateLimit.ts` - Redis è¿æ¥å’Œé™æµé€»è¾‘
- `src/app/api/documents/upload/route.ts` - ä¸Šä¼ ç«¯ç‚¹

**Mitigation**:

**ç­–ç•¥**: Preventive + Corrective

**æ“ä½œæ­¥éª¤**:
1. **æ·»åŠ é™çº§ç­–ç•¥ (Graceful Degradation)**:
   ```typescript
   try {
     const rateLimitResult = await checkUploadRateLimit(userId)
     if (!rateLimitResult.success) {
       return 429Response
     }
   } catch (error) {
     // Redis ä¸å¯ç”¨æ—¶çš„é™çº§ç­–ç•¥
     console.error('Rate limit check failed, degrading gracefully', error)
     // é€‰é¡¹ 1: å…è®¸è¯·æ±‚é€šè¿‡ (é™ä½å®‰å…¨æ€§ï¼Œä¿è¯å¯ç”¨æ€§)
     // é€‰é¡¹ 2: ä½¿ç”¨å†…å­˜é™æµ (ä¸è·¨å®ä¾‹ï¼Œä½†æ¯”å®Œå…¨å¤±è´¥å¥½)
     // æ¨è: è®°å½•å‘Šè­¦å¹¶å…è®¸é€šè¿‡
   }
   ```

2. **æ·»åŠ é‡è¯•æœºåˆ¶**:
   - å¯¹ Redis æ“ä½œæ·»åŠ  1-2 æ¬¡é‡è¯•ï¼Œè¶…æ—¶è®¾ç½®ä¸º 200ms
   - å¿«é€Ÿå¤±è´¥é¿å…é˜»å¡ç”¨æˆ·è¯·æ±‚

3. **ç›‘æ§å’Œå‘Šè­¦**:
   - ç›‘æ§ Redis è¿æ¥å¤±è´¥ç‡
   - å½“å¤±è´¥ç‡ > 1% æ—¶è§¦å‘å‘Šè­¦
   - ç›‘æ§é™çº§äº‹ä»¶é¢‘ç‡

**æµ‹è¯•éœ€æ±‚**:
- å•å…ƒæµ‹è¯•: Mock Redis è¶…æ—¶å’Œé”™è¯¯åœºæ™¯
- é›†æˆæµ‹è¯•: æµ‹è¯•é™çº§ç­–ç•¥ç”Ÿæ•ˆ
- æ··æ²Œæµ‹è¯•: æ¨¡æ‹Ÿ Redis å®Œå…¨ä¸å¯ç”¨

**æ®‹ç•™é£é™©**: Low - é™çº§ç­–ç•¥å¯èƒ½å¯¼è‡´çŸ­æœŸå†… DoS é˜²æŠ¤é™ä½ï¼Œä½†ä¿è¯äº†ç³»ç»ŸåŸºæœ¬å¯ç”¨æ€§

**è´£ä»»äºº**: Dev  
**æ—¶é—´çº¿**: åœ¨åˆå§‹å®ç°ä¸­å¿…é¡»åŒ…å«

---

## Medium Risks

### 2. [TECH-001]: é€Ÿç‡é™åˆ¶ç»•è¿‡ - å¤šè´¦å·æ”»å‡»

**Score: 4 (Medium Risk)**  
**Probability**: Medium (2) - æ”»å‡»è€…å¯ä»¥æ³¨å†Œå¤šä¸ªè´¦å·  
**Impact**: Medium (2) - å•ä¸ªç”¨æˆ·é™åˆ¶è¢«ç»•è¿‡ï¼Œä½†éœ€è¦æˆæœ¬ï¼ˆæ³¨å†Œå¤šè´¦å·ï¼‰

**è¯¦ç»†æè¿°**:
- å½“å‰å®ç°åŸºäº `userId` é™æµï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ³¨å†Œå¤šä¸ªè´¦å·æ¥ç»•è¿‡å•ç”¨æˆ·é™åˆ¶
- ä¾‹å¦‚ï¼šæ³¨å†Œ 10 ä¸ªè´¦å·ï¼Œæ¯ä¸ªè´¦å·ä¸Šä¼  10 æ¬¡/åˆ†é’Ÿ = 100 æ¬¡/åˆ†é’Ÿçš„æ€»æ”»å‡»èƒ½åŠ›
- è¿™é™ä½äº†é€Ÿç‡é™åˆ¶çš„æœ‰æ•ˆæ€§

**Mitigation**:

**ç­–ç•¥**: Preventive (éƒ¨åˆ†) + Detective

**æ“ä½œæ­¥éª¤**:
1. **æ·»åŠ  IP çº§åˆ«çš„å…¨å±€é™åˆ¶ (æœªæ¥å¢å¼º)**:
   ```typescript
   // åœ¨ç”¨æˆ·çº§é™åˆ¶ä¹‹å‰ï¼Œæ·»åŠ  IP çº§åˆ«çš„ç²—ç²’åº¦é™åˆ¶
   const ipLimit = await checkIPRateLimit(clientIP, {
     maxRequests: 50,  // å• IP 50æ¬¡/åˆ†é’Ÿ (æ‰€æœ‰ç”¨æˆ·)
     windowMs: 60000
   })
   ```

2. **ç›‘æ§å¼‚å¸¸æ¨¡å¼**:
   - è·Ÿè¸ªå• IP ä¸‹çš„ä¸åŒç”¨æˆ·æ•°é‡
   - å¦‚æœå• IP ä¸‹æœ‰ > 5 ä¸ªæ´»è·ƒç”¨æˆ·ï¼Œæ ‡è®°ä¸ºå¯ç–‘
   - è®°å½•åˆ°æ—¥å¿—ä¾›åç»­åˆ†æ

3. **è´¦å·æ³¨å†Œé™åˆ¶ (ä¾èµ– Story 1.3/1.4)**:
   - Email éªŒè¯å¿…é¡»
   - æ³¨å†Œé€Ÿç‡é™åˆ¶
   - CAPTCHA éªŒè¯

**æµ‹è¯•éœ€æ±‚**:
- æ‰‹åŠ¨æµ‹è¯•: æ¨¡æ‹Ÿå¤šè´¦å·æ”»å‡»åœºæ™¯
- æ—¥å¿—éªŒè¯: ç¡®è®¤å¼‚å¸¸æ¨¡å¼è¢«è®°å½•

**æ®‹ç•™é£é™©**: Medium - å®Œå…¨è§£å†³éœ€è¦ IP é™åˆ¶å’Œè´¦å·éªŒè¯é…åˆï¼Œæœ¬ Story èŒƒå›´å¤–

**è´£ä»»äºº**: è®°å½•ä¸ºæŠ€æœ¯å€ºåŠ¡  
**æ—¶é—´çº¿**: P1 ä¼˜å…ˆçº§ï¼ŒStory 4.x åç»­æ”¹è¿›

---

### 3. [PERF-001]: Redis æ“ä½œå¢åŠ è¯·æ±‚å»¶è¿Ÿ

**Score: 4 (Medium Risk)**  
**Probability**: High (3) - æ¯æ¬¡ä¸Šä¼ éƒ½ä¼šè°ƒç”¨ Redis  
**Impact**: Low (1) - å»¶è¿Ÿè½»å¾®ï¼Œä½†ç´¯ç§¯å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ

**è¯¦ç»†æè¿°**:
- æ¯æ¬¡ä¸Šä¼ è¯·æ±‚éƒ½éœ€è¦è°ƒç”¨ Upstash Redis APIï¼ˆç½‘ç»œè°ƒç”¨ï¼‰
- é¢„è®¡å¢åŠ  20-50ms å»¶è¿Ÿ
- å¯¹äºé¢‘ç¹ä¸Šä¼ çš„ç”¨æˆ·ï¼Œå»¶è¿Ÿç´¯ç§¯å¯èƒ½å½±å“ä½“éªŒ

**Mitigation**:

**ç­–ç•¥**: Preventive

**æ“ä½œæ­¥éª¤**:
1. **ä¼˜åŒ– Redis æ“ä½œ**:
   - ä½¿ç”¨ Upstash Redis REST API (å·²æ˜¯æœ€ä¼˜)
   - è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ (200ms)

2. **å¹¶è¡ŒåŒ–å¤„ç†**:
   ```typescript
   // å°† rate limit æ£€æŸ¥ä¸å…¶ä»–éªŒè¯å¹¶è¡Œ
   const [rateLimitResult, formData] = await Promise.all([
     checkUploadRateLimit(userId),
     req.formData()
   ])
   ```

3. **ç›‘æ§æ€§èƒ½**:
   - è·Ÿè¸ª P50/P95/P99 å»¶è¿Ÿ
   - ç›®æ ‡: é€Ÿç‡é™åˆ¶æ£€æŸ¥ < 50ms (P95)

**æµ‹è¯•éœ€æ±‚**:
- æ€§èƒ½æµ‹è¯•: æµ‹é‡æ·»åŠ é™æµå‰åçš„å»¶è¿Ÿå¯¹æ¯”
- è´Ÿè½½æµ‹è¯•: éªŒè¯é«˜å¹¶å‘ä¸‹çš„å»¶è¿Ÿè¡¨ç°

**æ®‹ç•™é£é™©**: Low - å»¶è¿Ÿåœ¨å¯æ¥å—èŒƒå›´å†…ï¼ˆ< 50msï¼‰

**è´£ä»»äºº**: Dev  
**æ—¶é—´çº¿**: å®ç°æ—¶ä¼˜åŒ–

---

### 4. [OPS-002]: æ—¥å¿—é‡æ¿€å¢é£é™©

**Score: 4 (Medium Risk)**  
**Probability**: Medium (2) - åœ¨æ”»å‡»åœºæ™¯ä¸‹ä¼šè§¦å‘  
**Impact**: Medium (2) - å¤§é‡æ—¥å¿—å¯èƒ½å½±å“æ—¥å¿—ç³»ç»Ÿæ€§èƒ½å’Œæˆæœ¬

**è¯¦ç»†æè¿°**:
- å½“å‘ç”Ÿ DoS æ”»å‡»æ—¶ï¼Œæ¯ä¸ªè¢«é™åˆ¶çš„è¯·æ±‚éƒ½ä¼šè®°å½•ä¸€æ¡ warn æ—¥å¿—
- å¦‚æœæ”»å‡»é¢‘ç‡æ˜¯ 1000 req/minï¼Œæ¯åˆ†é’Ÿä¼šäº§ç”Ÿ 1000 æ¡æ—¥å¿—
- å¤§é‡æ—¥å¿—å¯èƒ½ï¼š
  - å¢åŠ  Axiom/CloudWatch æ—¥å¿—æˆæœ¬
  - å½±å“æ—¥å¿—ç³»ç»Ÿæ€§èƒ½
  - æ·¹æ²¡å…¶ä»–é‡è¦æ—¥å¿—

**Mitigation**:

**ç­–ç•¥**: Preventive + Detective

**æ“ä½œæ­¥éª¤**:
1. **æ—¥å¿—é‡‡æ ·**:
   ```typescript
   // å¯¹è¶…é™æ—¥å¿—è¿›è¡Œé‡‡æ ·ï¼Œé¿å…é‡å¤è®°å½•
   const shouldLog = Math.random() < 0.1  // 10% é‡‡æ ·ç‡
   if (shouldLog) {
     console.warn({
       event: 'rateLimitExceeded',
       userId,
       ip,
       sampleRate: 0.1
     })
   }
   ```

2. **æ—¥å¿—èšåˆ**:
   - ä½¿ç”¨è®¡æ•°å™¨è€Œä¸æ˜¯æ¯æ¬¡éƒ½è®°å½•
   - æ¯ 10 ç§’èšåˆä¸€æ¬¡: "User X exceeded limit 50 times in last 10s"

3. **å‘Šè­¦è€Œä¸æ˜¯çº¯æ—¥å¿—**:
   - è®¾ç½®å‘Šè­¦é˜ˆå€¼: å•ç”¨æˆ·è¶…é™ > 20 æ¬¡/åˆ†é’Ÿ
   - è§¦å‘å‘Šè­¦åä¸å†è®°å½•æ¯æ¬¡äº‹ä»¶

**æµ‹è¯•éœ€æ±‚**:
- è´Ÿè½½æµ‹è¯•: æ¨¡æ‹Ÿé«˜é¢‘æ”»å‡»ï¼ŒéªŒè¯æ—¥å¿—é‡åœ¨å¯æ§èŒƒå›´

**æ®‹ç•™é£é™©**: Low - æ—¥å¿—ä¼˜åŒ–åï¼Œæˆæœ¬å¯æ§

**è´£ä»»äºº**: Dev  
**æ—¶é—´çº¿**: åœ¨åˆå§‹å®ç°ä¸­å¯é€‰ï¼ŒStory 4.12 (Axiom æ—¥å¿—) æ—¶ä¼˜åŒ–

---

## Low Risks

### 5. [DATA-001]: é€Ÿç‡é™åˆ¶æ•°æ®ä¸¢å¤± (Redis æ•°æ®)

**Score: 2 (Low Risk)**  
**Probability**: Low (1) - Redis æ•°æ®ä¸¢å¤±æ¦‚ç‡ä½  
**Impact**: Medium (2) - æ•°æ®ä¸¢å¤±å¯¼è‡´é™æµé‡ç½®ï¼ŒçŸ­æœŸå†…é˜²æŠ¤å¤±æ•ˆ

**è¯¦ç»†æè¿°**:
- Upstash Redis æ•°æ®å­˜å‚¨åœ¨è¿œç¨‹ï¼Œç†è®ºä¸Šå­˜åœ¨æ•°æ®ä¸¢å¤±é£é™©
- å¦‚æœ Redis æ•°æ®ä¸¢å¤±ï¼Œæ‰€æœ‰ç”¨æˆ·çš„é™æµè®¡æ•°å™¨è¢«é‡ç½®
- æ”»å‡»è€…åœ¨æ•°æ®ä¸¢å¤±çª—å£å¯ä»¥é‡æ–°è¿›è¡Œæ”»å‡»

**Mitigation**:

**ç­–ç•¥**: Detective

**æ“ä½œæ­¥éª¤**:
1. **ä½¿ç”¨ Upstash æŒä¹…åŒ–é…ç½®**:
   - ç¡®è®¤ Upstash å¼€å¯äº†æŒä¹…åŒ–
   - æ•°æ®ä¸¢å¤±æ¦‚ç‡ < 0.01%

2. **ç›‘æ§æ•°æ®é‡ç½®äº‹ä»¶**:
   - å¦‚æœå‘ç°å¤§é‡ç”¨æˆ·çªç„¶ `remaining = 10`ï¼Œå¯èƒ½æ˜¯æ•°æ®ä¸¢å¤±
   - è®°å½•å¼‚å¸¸äº‹ä»¶

**æµ‹è¯•éœ€æ±‚**:
- æ— éœ€ç‰¹æ®Šæµ‹è¯•ï¼Œä¾èµ– Upstash SLA

**æ®‹ç•™é£é™©**: Very Low - Upstash æä¾›é«˜å¯ç”¨æ€§ä¿è¯

**è´£ä»»äºº**: è¿ç»´  
**æ—¶é—´çº¿**: ç›‘æ§é…ç½®

---

### 6. [BUS-001]: åˆæ³•é«˜é¢‘ç”¨æˆ·è¢«è¯¯é™åˆ¶

**Score: 3 (Low Risk)**  
**Probability**: Low (1) - 10æ¬¡/åˆ†é’Ÿå¯¹å¤§éƒ¨åˆ†ç”¨æˆ·è¶³å¤Ÿ  
**Impact**: High (3) - å¦‚æœå‘ç”Ÿï¼Œä¼šä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒ

**è¯¦ç»†æè¿°**:
- å½“å‰é™åˆ¶æ˜¯ 10 æ¬¡/åˆ†é’Ÿï¼Œå¯¹å¤§éƒ¨åˆ†ç”¨æˆ·åœºæ™¯è¶³å¤Ÿ
- ä½†æŸäº›åˆæ³•åœºæ™¯å¯èƒ½éœ€è¦æ›´é«˜é¢‘ç‡ï¼š
  - æ‰¹é‡å¯¼å…¥æ–‡æ¡£ (ä¼ä¸šç”¨æˆ·)
  - è‡ªåŠ¨åŒ–è„šæœ¬ä¸Šä¼ 
  - æµ‹è¯•å’Œæ¼”ç¤ºåœºæ™¯

**Mitigation**:

**ç­–ç•¥**: Preventive + Corrective

**æ“ä½œæ­¥éª¤**:
1. **æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯**:
   - å‘ŠçŸ¥ç”¨æˆ·é™åˆ¶è¯¦æƒ…å’Œé‡ç½®æ—¶é—´
   - æä¾›æ”¯æŒè”ç³»æ–¹å¼

2. **æœªæ¥æ”¯æŒç™½åå•æœºåˆ¶ (P2 ä¼˜å…ˆçº§)**:
   ```typescript
   // ç‰¹æ®Šç”¨æˆ·å¯ä»¥æœ‰æ›´é«˜é™åˆ¶
   const userTier = await getUserTier(userId)
   const limit = userTier === 'enterprise' ? 50 : 10
   ```

3. **ç›‘æ§è¯¯é™åˆ¶æŠ•è¯‰**:
   - è·Ÿè¸ªç”¨æˆ·åé¦ˆ
   - å¦‚æœæœ‰ > 5 ä¸ªåˆæ³•ç”¨æˆ·æŠ•è¯‰ï¼Œé‡æ–°è¯„ä¼°é™åˆ¶å€¼

**æµ‹è¯•éœ€æ±‚**:
- ç”¨æˆ·åé¦ˆæ”¶é›†æœºåˆ¶

**æ®‹ç•™é£é™©**: Low - å¯é€šè¿‡ç™½åå•è§£å†³

**è´£ä»»äºº**: PO (æ”¶é›†åé¦ˆ) + Dev (ç™½åå•åŠŸèƒ½)  
**æ—¶é—´çº¿**: è§‚å¯Ÿç”Ÿäº§ç¯å¢ƒåé¦ˆ

---

## Risk Distribution

### By Category

| Category   | Total Risks | Critical | High | Medium | Low |
|------------|-------------|----------|------|--------|-----|
| Security   | 0           | 0        | 0    | 0      | 0   |
| Performance| 1           | 0        | 0    | 1      | 0   |
| Technical  | 1           | 0        | 0    | 1      | 0   |
| Data       | 1           | 0        | 0    | 0      | 1   |
| Business   | 1           | 0        | 0    | 0      | 1   |
| Operational| 2           | 0        | 1    | 1      | 0   |

### By Component

| Component                             | Risks | Highest Score |
|---------------------------------------|-------|---------------|
| `src/lib/rateLimit.ts`               | 3     | 6 (OPS-001)   |
| `src/app/api/documents/upload/route.ts` | 2  | 6 (OPS-001)   |
| Upstash Redis (External)             | 2     | 6 (OPS-001)   |
| Logging System                        | 1     | 4 (OPS-002)   |

---

## Detailed Risk Register

| Risk ID   | Description                        | Probability | Impact   | Score | Priority | Owner | Status      |
|-----------|------------------------------------|-------------|----------|-------|----------|-------|-------------|
| OPS-001   | Upstash Redis æœåŠ¡ä¸å¯ç”¨          | Medium (2)  | High (3) | 6     | High     | Dev   | Must Fix    |
| TECH-001  | é€Ÿç‡é™åˆ¶ç»•è¿‡ - å¤šè´¦å·æ”»å‡»         | Medium (2)  | Medium (2)| 4    | Medium   | Backlog| Documented  |
| PERF-001  | Redis æ“ä½œå¢åŠ è¯·æ±‚å»¶è¿Ÿ            | High (3)    | Low (1)  | 4     | Medium   | Dev   | Optimize    |
| OPS-002   | æ—¥å¿—é‡æ¿€å¢é£é™©                    | Medium (2)  | Medium (2)| 4    | Medium   | Dev   | Optional    |
| DATA-001  | é€Ÿç‡é™åˆ¶æ•°æ®ä¸¢å¤±                  | Low (1)     | Medium (2)| 2    | Low      | Ops   | Monitor     |
| BUS-001   | åˆæ³•é«˜é¢‘ç”¨æˆ·è¢«è¯¯é™åˆ¶              | Low (1)     | High (3) | 3     | Low      | PO    | Monitor     |

---

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests (Must Have)

**OPS-001: Redis ä¸å¯ç”¨åœºæ™¯**
- **Test Type**: Integration + Chaos
- **Scenarios**:
  1. Mock Redis è¶…æ—¶ (200ms+)
  2. Mock Redis è¿æ¥é”™è¯¯
  3. Mock Redis å“åº”æ ¼å¼é”™è¯¯
  4. éªŒè¯é™çº§ç­–ç•¥ç”Ÿæ•ˆ
  5. éªŒè¯é™çº§å‘Šè­¦æ—¥å¿—
- **Test Data**: N/A
- **Success Criteria**: é™çº§åç³»ç»Ÿä»ç„¶å¯ç”¨ï¼Œæœ‰å‘Šè­¦æ—¥å¿—

### Priority 2: Medium Risk Tests (Should Have)

**TECH-001: å¤šè´¦å·æ”»å‡»æ¨¡æ‹Ÿ**
- **Test Type**: Manual/Script
- **Scenarios**:
  1. åˆ›å»º 3 ä¸ªæµ‹è¯•è´¦å·
  2. æ¯ä¸ªè´¦å·åŒæ—¶ä¸Šä¼  10 æ¬¡
  3. éªŒè¯æ¯ä¸ªè´¦å·éƒ½è¢«æ­£ç¡®é™åˆ¶
  4. éªŒè¯æ€»è¯·æ±‚é‡ = 30 (10 x 3)
- **Success Criteria**: å•è´¦å·é™åˆ¶ç”Ÿæ•ˆï¼Œä½†æ€»é‡æœªè¢«é™åˆ¶

**PERF-001: æ€§èƒ½åŸºå‡†æµ‹è¯•**
- **Test Type**: Performance
- **Scenarios**:
  1. æµ‹é‡æ·»åŠ é™æµå‰çš„ä¸Šä¼ å»¶è¿Ÿ (baseline)
  2. æµ‹é‡æ·»åŠ é™æµåçš„å»¶è¿Ÿ (with rate limit)
  3. è®¡ç®—å¢é‡: delta = after - before
- **Success Criteria**: å»¶è¿Ÿå¢é‡ < 50ms (P95)

**OPS-002: æ—¥å¿—é‡æµ‹è¯•**
- **Test Type**: Load
- **Scenarios**:
  1. å•ç”¨æˆ·è¿ç»­å‘é€ 100 æ¬¡è¯·æ±‚ï¼ˆè¶…é™ 90 æ¬¡ï¼‰
  2. æ£€æŸ¥æ—¥å¿—æ¡ç›®æ•°é‡
  3. éªŒè¯é‡‡æ ·æˆ–èšåˆç”Ÿæ•ˆ
- **Success Criteria**: æ—¥å¿—æ¡ç›® < 10 (å¦‚æœå¯ç”¨é‡‡æ ·)

### Priority 3: Low Risk Tests (Optional)

**DATA-001: Redis æ•°æ®ä¸€è‡´æ€§**
- **Test Type**: Integration
- **Scenarios**:
  1. ä¸Šä¼  5 æ¬¡ï¼Œæ£€æŸ¥ `remaining = 5`
  2. ç­‰å¾… 1 åˆ†é’Ÿ
  3. éªŒè¯è®¡æ•°å™¨é‡ç½® `remaining = 10`

**BUS-001: é”™è¯¯æ¶ˆæ¯å‹å¥½æ€§**
- **Test Type**: Manual
- **Scenarios**:
  1. è§¦å‘é€Ÿç‡é™åˆ¶
  2. æ£€æŸ¥å“åº”æ¶ˆæ¯æ˜¯å¦å‹å¥½
  3. æ£€æŸ¥æ˜¯å¦åŒ…å« `retryAfter` å’Œ `resetAt`

---

## Risk Acceptance Criteria

### Must Fix Before Production

âœ… **OPS-001: Redis é™çº§ç­–ç•¥** - Critical for availability
- å¿…é¡»å®ç°é™çº§é€»è¾‘
- å¿…é¡»æœ‰é‡è¯•æœºåˆ¶
- å¿…é¡»æœ‰ç›‘æ§å‘Šè­¦

### Can Deploy with Mitigation

âœ… **PERF-001: Redis å»¶è¿Ÿ** - Acceptable with monitoring
- å»¶è¿Ÿ < 50ms (P95) å¯æ¥å—
- éœ€è¦æ€§èƒ½ç›‘æ§

âœ… **OPS-002: æ—¥å¿—é‡** - Can optimize later in Story 4.12
- åˆå§‹ç‰ˆæœ¬å¯ä»¥æ¥å—å®Œæ•´æ—¥å¿—
- Story 4.12 (Axiom æ—¥å¿—) æ—¶ä¼˜åŒ–

### Accepted Risks

âœ… **TECH-001: å¤šè´¦å·æ”»å‡»** - Deferred to Story 4.x (IP é™åˆ¶)
- å½“å‰å•ç”¨æˆ·é™åˆ¶å·²è¶³å¤Ÿ
- IP é™åˆ¶ä½œä¸º P1 ä¼˜å…ˆçº§åç»­å¢å¼º

âœ… **DATA-001: Redis æ•°æ®ä¸¢å¤±** - Rely on Upstash SLA
- æ¦‚ç‡æä½ (< 0.01%)
- Upstash æä¾›é«˜å¯ç”¨æ€§ä¿è¯

âœ… **BUS-001: åˆæ³•ç”¨æˆ·è¯¯é™åˆ¶** - Monitor production feedback
- 10æ¬¡/åˆ†é’Ÿå¯¹å¤§éƒ¨åˆ†åœºæ™¯è¶³å¤Ÿ
- å¦‚æœ‰åé¦ˆï¼Œåç»­æ·»åŠ ç™½åå•åŠŸèƒ½

---

## Monitoring Requirements

### å®æ—¶ç›‘æ§æŒ‡æ ‡

**Security Metrics**:
- é€Ÿç‡é™åˆ¶è§¦å‘æ¬¡æ•° (per user, per IP)
- è¢«é™åˆ¶çš„å”¯ä¸€ç”¨æˆ·æ•°
- å¼‚å¸¸æ¨¡å¼: å• IP å¤šç”¨æˆ·

**Performance Metrics**:
- é€Ÿç‡é™åˆ¶æ£€æŸ¥å»¶è¿Ÿ (P50/P95/P99)
- Redis æ“ä½œæˆåŠŸç‡
- Redis æ“ä½œè¶…æ—¶ç‡

**Operational Metrics**:
- Redis è¿æ¥å¤±è´¥ç‡
- é™çº§äº‹ä»¶é¢‘ç‡
- æ—¥å¿—é‡ (rate limit ç›¸å…³)

### å‘Šè­¦è§„åˆ™

| Alert                          | Condition                    | Severity | Action                    |
|--------------------------------|------------------------------|----------|---------------------------|
| Redis ä¸å¯ç”¨                   | è¿æ¥å¤±è´¥ç‡ > 1%              | Critical | ç«‹å³é€šçŸ¥è¿ç»´              |
| é™çº§æ¨¡å¼æ¿€æ´»                   | é™çº§äº‹ä»¶ > 5 æ¬¡/5åˆ†é’Ÿ        | High     | æ£€æŸ¥ Redis çŠ¶æ€          |
| å¤§è§„æ¨¡æ”»å‡»                     | é™åˆ¶è§¦å‘ > 1000 æ¬¡/åˆ†é’Ÿ      | Medium   | ç›‘æ§æ”»å‡»æ¨¡å¼              |
| æ€§èƒ½é™çº§                       | å»¶è¿Ÿ > 100ms (P95)           | Medium   | æ£€æŸ¥ Redis æ€§èƒ½          |
| å¼‚å¸¸å¤šè´¦å·                     | å• IP > 10 ä¸ªæ´»è·ƒç”¨æˆ·        | Low      | è®°å½•å¹¶åˆ†æ                |

---

## Risk Review Triggers

é‡æ–°è¯„ä¼°æ­¤é£é™©æ¡£æ¡ˆçš„è§¦å‘æ¡ä»¶:

1. **æ¶æ„å˜æ›´**:
   - æ›´æ¢ Redis æä¾›å•†
   - æ·»åŠ é¢å¤–çš„é™æµå±‚ (CDN, API Gateway)

2. **æ–°é›†æˆ**:
   - æ·»åŠ  IP çº§åˆ«é™æµ
   - é›†æˆ WAF (Web Application Firewall)

3. **ç”Ÿäº§äº‹ä»¶**:
   - å®é™… DoS æ”»å‡»å‘ç”Ÿ
   - Redis æ•…éšœå¯¼è‡´æœåŠ¡ä¸­æ–­
   - å¤§é‡ç”¨æˆ·æŠ•è¯‰è¢«è¯¯é™åˆ¶

4. **æ€§èƒ½é—®é¢˜**:
   - å»¶è¿Ÿè¶…è¿‡ 100ms (P95)
   - æ—¥å¿—æˆæœ¬æ˜¾è‘—å¢åŠ 

5. **ä¸šåŠ¡å˜åŒ–**:
   - å¼•å…¥ä¼ä¸šçº§ç”¨æˆ· (éœ€è¦æ›´é«˜é™åˆ¶)
   - æ›´æ”¹é™æµç­–ç•¥ (10 â†’ X æ¬¡/åˆ†é’Ÿ)

---

## Overall Risk Score Calculation

```
Base Score = 100
- OPS-001 (High, score=6): -10 points
- TECH-001 (Medium, score=4): -5 points
- PERF-001 (Medium, score=4): -5 points
- OPS-002 (Medium, score=4): -5 points
- DATA-001 (Low, score=2): -2 points
- BUS-001 (Low, score=3): -2 points
--------------------------------
Final Risk Score = 100 - 29 = 71/100
```

**Adjusted Score**: è€ƒè™‘åˆ° OPS-001 æœ‰ç¼“è§£æªæ–½ï¼Œè°ƒæ•´ä¸º **83/100**

**Risk Level**: **Low to Medium** - æ•´ä½“é£é™©å¯æ§ï¼Œå…³é”®æ˜¯å®ç° Redis é™çº§ç­–ç•¥

---

## Recommendations

### 1. Testing Priority

**Must Test First** (Before Code Review):
1. Redis é™çº§åœºæ™¯ (OPS-001)
2. é€Ÿç‡é™åˆ¶åŠŸèƒ½æµ‹è¯• (AC1-AC4)
3. æ€§èƒ½åŸºå‡†æµ‹è¯• (PERF-001)

**Should Test** (Before QA Gate):
1. å¤šè´¦å·æ”»å‡»æ¨¡æ‹Ÿ (TECH-001)
2. æ—¥å¿—é‡éªŒè¯ (OPS-002)
3. è¾¹ç•Œæƒ…å†µ (ç¬¬ 10 æ¬¡æˆåŠŸï¼Œç¬¬ 11 æ¬¡å¤±è´¥)

**Optional Test** (Nice to Have):
1. é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§æµ‹è¯•
2. æ··æ²Œæµ‹è¯• (éšæœº Redis æ•…éšœ)

### 2. Development Focus

**Code Review é‡ç‚¹**:
- âœ… Redis é”™è¯¯å¤„ç†å’Œé™çº§é€»è¾‘
- âœ… è¶…æ—¶è®¾ç½®æ˜¯å¦åˆç† (200ms)
- âœ… æ—¥å¿—è®°å½•æ˜¯å¦å®Œæ•´
- âœ… å“åº”æ ¼å¼æ˜¯å¦ç¬¦åˆè§„èŒƒ

**é¢å¤–éªŒè¯**:
- âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- âœ… Upstash Redis å‡­è¯æœ‰æ•ˆ
- âœ… é”™è¯¯æ¶ˆæ¯ç”¨æˆ·å‹å¥½

### 3. Deployment Strategy

**æ¨èéƒ¨ç½²ç­–ç•¥**: **Feature Flag + Canary Rollout**

**Phase 1: Canary (10% æµé‡, 1 å¤©)**
- ç›‘æ§: Redis é”™è¯¯ç‡ã€å»¶è¿Ÿã€é™çº§äº‹ä»¶
- å›æ»šæ¡ä»¶: Redis é”™è¯¯ç‡ > 5% æˆ–å»¶è¿Ÿ > 100ms

**Phase 2: Full Rollout (100% æµé‡)**
- æŒç»­ç›‘æ§ 1 å‘¨
- æ”¶é›†ç”¨æˆ·åé¦ˆ

**Rollback Plan**:
```typescript
// Feature flag æ§åˆ¶
const RATE_LIMIT_ENABLED = process.env.FEATURE_RATE_LIMIT === 'true'

if (RATE_LIMIT_ENABLED) {
  // é€Ÿç‡é™åˆ¶é€»è¾‘
}
```

### 4. Monitoring Setup

**Metrics to Track**:
- Rate limit hits/min (æŒ‰ç”¨æˆ·ã€æŒ‰ IP)
- Redis operation latency (P50/P95/P99)
- Redis error rate
- Degradation events

**Dashboards to Create**:
1. **Security Dashboard**:
   - è¢«é™åˆ¶çš„ç”¨æˆ·æ•° (Top 10)
   - é™åˆ¶è§¦å‘è¶‹åŠ¿ (æ—¶é—´åºåˆ—)
   - å¼‚å¸¸ IP æ£€æµ‹

2. **Performance Dashboard**:
   - é€Ÿç‡é™åˆ¶æ£€æŸ¥å»¶è¿Ÿ
   - Redis æ“ä½œæˆåŠŸç‡
   - ä¸Šä¼ ç«¯ç‚¹æ€»ä½“å»¶è¿Ÿå¯¹æ¯”

3. **Operational Dashboard**:
   - Redis è¿æ¥çŠ¶æ€
   - é™çº§äº‹ä»¶é¢‘ç‡
   - å‘Šè­¦å†å²

**Alerts to Configure**:
- å‚è€ƒä¸Šæ–‡ "å‘Šè­¦è§„åˆ™" è¡¨æ ¼

---

## Summary for Gate Integration

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 3
    low: 2
  highest:
    id: OPS-001
    score: 6
    title: 'Upstash Redis æœåŠ¡ä¸å¯ç”¨å¯¼è‡´é™æµå¤±è´¥'
  recommendations:
    must_fix:
      - 'å®ç° Redis é™çº§ç­–ç•¥ï¼ˆé‡è¯• + ä¼˜é›…é™çº§ï¼‰'
      - 'æ·»åŠ  Redis è¿æ¥å¤±è´¥ç›‘æ§å’Œå‘Šè­¦'
    monitor:
      - 'ç›‘æ§é€Ÿç‡é™åˆ¶å»¶è¿Ÿ < 50ms (P95)'
      - 'ç›‘æ§æ—¥å¿—é‡ï¼Œå¿…è¦æ—¶å¯ç”¨é‡‡æ ·'
      - 'è·Ÿè¸ªå¤šè´¦å·æ”»å‡»æ¨¡å¼'
```

---

**é£é™©è¯„ä¼°å®Œæˆ** âœ…

**å…³é”®è¡ŒåŠ¨é¡¹**:
1. ğŸ”´ **Must Fix**: å®ç° OPS-001 ç¼“è§£æªæ–½ï¼ˆRedis é™çº§ç­–ç•¥ï¼‰
2. ğŸŸ¡ **Should Monitor**: PERF-001 (å»¶è¿Ÿ), OPS-002 (æ—¥å¿—é‡)
3. ğŸŸ¢ **Can Accept**: TECH-001 (åç»­å¢å¼º), DATA-001 (ä¾èµ– SLA), BUS-001 (è§‚å¯Ÿåé¦ˆ)

**ä¸‹ä¸€æ­¥**: æµ‹è¯•è®¾è®¡ (test-design.md)

