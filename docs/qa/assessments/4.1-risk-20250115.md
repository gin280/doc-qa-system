# Risk Profile: Story 4.1 - 添加上传速率限制

**Story ID**: 4.1  
**Date**: 2025-01-15  
**Reviewer**: Quinn (Test Architect)

---

## Executive Summary

- **Total Risks Identified**: 6
- **Critical Risks**: 0
- **High Risks**: 1
- **Medium Risks**: 3
- **Low Risks**: 2
- **Risk Score**: 83/100 (Low to Medium Risk)

**Overall Assessment**: 这是一个相对低风险的安全增强Story，但需要注意几个关键的技术和运维风险。主要风险集中在外部依赖（Upstash Redis）的可用性和降级策略上。

---

## Critical Risks Requiring Immediate Attention

**无 Critical 级别风险** ✅

---

## High Risks Requiring Attention

### 1. [OPS-001]: Upstash Redis 服务不可用导致限流失败

**Score: 6 (High Risk)**  
**Probability**: Medium (2) - Upstash 作为外部服务，存在一定的不可用风险  
**Impact**: High (3) - 如果限流完全失败，DoS 防护将失效，影响系统安全

**详细描述**:
- Upstash Redis 作为外部第三方服务，可能因网络问题、服务维护或故障而不可用
- 当前实现中，如果 Redis 不可用，速率限制检查可能抛出异常，导致上传端点完全不可用
- 这会造成比没有限流更严重的后果：合法用户也无法上传

**影响的组件**:
- `src/lib/rateLimit.ts` - Redis 连接和限流逻辑
- `src/app/api/documents/upload/route.ts` - 上传端点

**Mitigation**:

**策略**: Preventive + Corrective

**操作步骤**:
1. **添加降级策略 (Graceful Degradation)**:
   ```typescript
   try {
     const rateLimitResult = await checkUploadRateLimit(userId)
     if (!rateLimitResult.success) {
       return 429Response
     }
   } catch (error) {
     // Redis 不可用时的降级策略
     console.error('Rate limit check failed, degrading gracefully', error)
     // 选项 1: 允许请求通过 (降低安全性，保证可用性)
     // 选项 2: 使用内存限流 (不跨实例，但比完全失败好)
     // 推荐: 记录告警并允许通过
   }
   ```

2. **添加重试机制**:
   - 对 Redis 操作添加 1-2 次重试，超时设置为 200ms
   - 快速失败避免阻塞用户请求

3. **监控和告警**:
   - 监控 Redis 连接失败率
   - 当失败率 > 1% 时触发告警
   - 监控降级事件频率

**测试需求**:
- 单元测试: Mock Redis 超时和错误场景
- 集成测试: 测试降级策略生效
- 混沌测试: 模拟 Redis 完全不可用

**残留风险**: Low - 降级策略可能导致短期内 DoS 防护降低，但保证了系统基本可用性

**责任人**: Dev  
**时间线**: 在初始实现中必须包含

---

## Medium Risks

### 2. [TECH-001]: 速率限制绕过 - 多账号攻击

**Score: 4 (Medium Risk)**  
**Probability**: Medium (2) - 攻击者可以注册多个账号  
**Impact**: Medium (2) - 单个用户限制被绕过，但需要成本（注册多账号）

**详细描述**:
- 当前实现基于 `userId` 限流，攻击者可以通过注册多个账号来绕过单用户限制
- 例如：注册 10 个账号，每个账号上传 10 次/分钟 = 100 次/分钟的总攻击能力
- 这降低了速率限制的有效性

**Mitigation**:

**策略**: Preventive (部分) + Detective

**操作步骤**:
1. **添加 IP 级别的全局限制 (未来增强)**:
   ```typescript
   // 在用户级限制之前，添加 IP 级别的粗粒度限制
   const ipLimit = await checkIPRateLimit(clientIP, {
     maxRequests: 50,  // 单 IP 50次/分钟 (所有用户)
     windowMs: 60000
   })
   ```

2. **监控异常模式**:
   - 跟踪单 IP 下的不同用户数量
   - 如果单 IP 下有 > 5 个活跃用户，标记为可疑
   - 记录到日志供后续分析

3. **账号注册限制 (依赖 Story 1.3/1.4)**:
   - Email 验证必须
   - 注册速率限制
   - CAPTCHA 验证

**测试需求**:
- 手动测试: 模拟多账号攻击场景
- 日志验证: 确认异常模式被记录

**残留风险**: Medium - 完全解决需要 IP 限制和账号验证配合，本 Story 范围外

**责任人**: 记录为技术债务  
**时间线**: P1 优先级，Story 4.x 后续改进

---

### 3. [PERF-001]: Redis 操作增加请求延迟

**Score: 4 (Medium Risk)**  
**Probability**: High (3) - 每次上传都会调用 Redis  
**Impact**: Low (1) - 延迟轻微，但累积可能影响用户体验

**详细描述**:
- 每次上传请求都需要调用 Upstash Redis API（网络调用）
- 预计增加 20-50ms 延迟
- 对于频繁上传的用户，延迟累积可能影响体验

**Mitigation**:

**策略**: Preventive

**操作步骤**:
1. **优化 Redis 操作**:
   - 使用 Upstash Redis REST API (已是最优)
   - 设置合理的超时时间 (200ms)

2. **并行化处理**:
   ```typescript
   // 将 rate limit 检查与其他验证并行
   const [rateLimitResult, formData] = await Promise.all([
     checkUploadRateLimit(userId),
     req.formData()
   ])
   ```

3. **监控性能**:
   - 跟踪 P50/P95/P99 延迟
   - 目标: 速率限制检查 < 50ms (P95)

**测试需求**:
- 性能测试: 测量添加限流前后的延迟对比
- 负载测试: 验证高并发下的延迟表现

**残留风险**: Low - 延迟在可接受范围内（< 50ms）

**责任人**: Dev  
**时间线**: 实现时优化

---

### 4. [OPS-002]: 日志量激增风险

**Score: 4 (Medium Risk)**  
**Probability**: Medium (2) - 在攻击场景下会触发  
**Impact**: Medium (2) - 大量日志可能影响日志系统性能和成本

**详细描述**:
- 当发生 DoS 攻击时，每个被限制的请求都会记录一条 warn 日志
- 如果攻击频率是 1000 req/min，每分钟会产生 1000 条日志
- 大量日志可能：
  - 增加 Axiom/CloudWatch 日志成本
  - 影响日志系统性能
  - 淹没其他重要日志

**Mitigation**:

**策略**: Preventive + Detective

**操作步骤**:
1. **日志采样**:
   ```typescript
   // 对超限日志进行采样，避免重复记录
   const shouldLog = Math.random() < 0.1  // 10% 采样率
   if (shouldLog) {
     console.warn({
       event: 'rateLimitExceeded',
       userId,
       ip,
       sampleRate: 0.1
     })
   }
   ```

2. **日志聚合**:
   - 使用计数器而不是每次都记录
   - 每 10 秒聚合一次: "User X exceeded limit 50 times in last 10s"

3. **告警而不是纯日志**:
   - 设置告警阈值: 单用户超限 > 20 次/分钟
   - 触发告警后不再记录每次事件

**测试需求**:
- 负载测试: 模拟高频攻击，验证日志量在可控范围

**残留风险**: Low - 日志优化后，成本可控

**责任人**: Dev  
**时间线**: 在初始实现中可选，Story 4.12 (Axiom 日志) 时优化

---

## Low Risks

### 5. [DATA-001]: 速率限制数据丢失 (Redis 数据)

**Score: 2 (Low Risk)**  
**Probability**: Low (1) - Redis 数据丢失概率低  
**Impact**: Medium (2) - 数据丢失导致限流重置，短期内防护失效

**详细描述**:
- Upstash Redis 数据存储在远程，理论上存在数据丢失风险
- 如果 Redis 数据丢失，所有用户的限流计数器被重置
- 攻击者在数据丢失窗口可以重新进行攻击

**Mitigation**:

**策略**: Detective

**操作步骤**:
1. **使用 Upstash 持久化配置**:
   - 确认 Upstash 开启了持久化
   - 数据丢失概率 < 0.01%

2. **监控数据重置事件**:
   - 如果发现大量用户突然 `remaining = 10`，可能是数据丢失
   - 记录异常事件

**测试需求**:
- 无需特殊测试，依赖 Upstash SLA

**残留风险**: Very Low - Upstash 提供高可用性保证

**责任人**: 运维  
**时间线**: 监控配置

---

### 6. [BUS-001]: 合法高频用户被误限制

**Score: 3 (Low Risk)**  
**Probability**: Low (1) - 10次/分钟对大部分用户足够  
**Impact**: High (3) - 如果发生，会严重影响用户体验

**详细描述**:
- 当前限制是 10 次/分钟，对大部分用户场景足够
- 但某些合法场景可能需要更高频率：
  - 批量导入文档 (企业用户)
  - 自动化脚本上传
  - 测试和演示场景

**Mitigation**:

**策略**: Preventive + Corrective

**操作步骤**:
1. **提供清晰的错误消息**:
   - 告知用户限制详情和重置时间
   - 提供支持联系方式

2. **未来支持白名单机制 (P2 优先级)**:
   ```typescript
   // 特殊用户可以有更高限制
   const userTier = await getUserTier(userId)
   const limit = userTier === 'enterprise' ? 50 : 10
   ```

3. **监控误限制投诉**:
   - 跟踪用户反馈
   - 如果有 > 5 个合法用户投诉，重新评估限制值

**测试需求**:
- 用户反馈收集机制

**残留风险**: Low - 可通过白名单解决

**责任人**: PO (收集反馈) + Dev (白名单功能)  
**时间线**: 观察生产环境反馈

---

## Risk Distribution

### By Category

| Category   | Total Risks | Critical | High | Medium | Low |
|------------|-------------|----------|------|--------|-----|
| Security   | 0           | 0        | 0    | 0      | 0   |
| Performance| 1           | 0        | 0    | 1      | 0   |
| Technical  | 1           | 0        | 0    | 1      | 0   |
| Data       | 1           | 0        | 0    | 0      | 1   |
| Business   | 1           | 0        | 0    | 0      | 1   |
| Operational| 2           | 0        | 1    | 1      | 0   |

### By Component

| Component                             | Risks | Highest Score |
|---------------------------------------|-------|---------------|
| `src/lib/rateLimit.ts`               | 3     | 6 (OPS-001)   |
| `src/app/api/documents/upload/route.ts` | 2  | 6 (OPS-001)   |
| Upstash Redis (External)             | 2     | 6 (OPS-001)   |
| Logging System                        | 1     | 4 (OPS-002)   |

---

## Detailed Risk Register

| Risk ID   | Description                        | Probability | Impact   | Score | Priority | Owner | Status      |
|-----------|------------------------------------|-------------|----------|-------|----------|-------|-------------|
| OPS-001   | Upstash Redis 服务不可用          | Medium (2)  | High (3) | 6     | High     | Dev   | Must Fix    |
| TECH-001  | 速率限制绕过 - 多账号攻击         | Medium (2)  | Medium (2)| 4    | Medium   | Backlog| Documented  |
| PERF-001  | Redis 操作增加请求延迟            | High (3)    | Low (1)  | 4     | Medium   | Dev   | Optimize    |
| OPS-002   | 日志量激增风险                    | Medium (2)  | Medium (2)| 4    | Medium   | Dev   | Optional    |
| DATA-001  | 速率限制数据丢失                  | Low (1)     | Medium (2)| 2    | Low      | Ops   | Monitor     |
| BUS-001   | 合法高频用户被误限制              | Low (1)     | High (3) | 3     | Low      | PO    | Monitor     |

---

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests (Must Have)

**OPS-001: Redis 不可用场景**
- **Test Type**: Integration + Chaos
- **Scenarios**:
  1. Mock Redis 超时 (200ms+)
  2. Mock Redis 连接错误
  3. Mock Redis 响应格式错误
  4. 验证降级策略生效
  5. 验证降级告警日志
- **Test Data**: N/A
- **Success Criteria**: 降级后系统仍然可用，有告警日志

### Priority 2: Medium Risk Tests (Should Have)

**TECH-001: 多账号攻击模拟**
- **Test Type**: Manual/Script
- **Scenarios**:
  1. 创建 3 个测试账号
  2. 每个账号同时上传 10 次
  3. 验证每个账号都被正确限制
  4. 验证总请求量 = 30 (10 x 3)
- **Success Criteria**: 单账号限制生效，但总量未被限制

**PERF-001: 性能基准测试**
- **Test Type**: Performance
- **Scenarios**:
  1. 测量添加限流前的上传延迟 (baseline)
  2. 测量添加限流后的延迟 (with rate limit)
  3. 计算增量: delta = after - before
- **Success Criteria**: 延迟增量 < 50ms (P95)

**OPS-002: 日志量测试**
- **Test Type**: Load
- **Scenarios**:
  1. 单用户连续发送 100 次请求（超限 90 次）
  2. 检查日志条目数量
  3. 验证采样或聚合生效
- **Success Criteria**: 日志条目 < 10 (如果启用采样)

### Priority 3: Low Risk Tests (Optional)

**DATA-001: Redis 数据一致性**
- **Test Type**: Integration
- **Scenarios**:
  1. 上传 5 次，检查 `remaining = 5`
  2. 等待 1 分钟
  3. 验证计数器重置 `remaining = 10`

**BUS-001: 错误消息友好性**
- **Test Type**: Manual
- **Scenarios**:
  1. 触发速率限制
  2. 检查响应消息是否友好
  3. 检查是否包含 `retryAfter` 和 `resetAt`

---

## Risk Acceptance Criteria

### Must Fix Before Production

✅ **OPS-001: Redis 降级策略** - Critical for availability
- 必须实现降级逻辑
- 必须有重试机制
- 必须有监控告警

### Can Deploy with Mitigation

✅ **PERF-001: Redis 延迟** - Acceptable with monitoring
- 延迟 < 50ms (P95) 可接受
- 需要性能监控

✅ **OPS-002: 日志量** - Can optimize later in Story 4.12
- 初始版本可以接受完整日志
- Story 4.12 (Axiom 日志) 时优化

### Accepted Risks

✅ **TECH-001: 多账号攻击** - Deferred to Story 4.x (IP 限制)
- 当前单用户限制已足够
- IP 限制作为 P1 优先级后续增强

✅ **DATA-001: Redis 数据丢失** - Rely on Upstash SLA
- 概率极低 (< 0.01%)
- Upstash 提供高可用性保证

✅ **BUS-001: 合法用户误限制** - Monitor production feedback
- 10次/分钟对大部分场景足够
- 如有反馈，后续添加白名单功能

---

## Monitoring Requirements

### 实时监控指标

**Security Metrics**:
- 速率限制触发次数 (per user, per IP)
- 被限制的唯一用户数
- 异常模式: 单 IP 多用户

**Performance Metrics**:
- 速率限制检查延迟 (P50/P95/P99)
- Redis 操作成功率
- Redis 操作超时率

**Operational Metrics**:
- Redis 连接失败率
- 降级事件频率
- 日志量 (rate limit 相关)

### 告警规则

| Alert                          | Condition                    | Severity | Action                    |
|--------------------------------|------------------------------|----------|---------------------------|
| Redis 不可用                   | 连接失败率 > 1%              | Critical | 立即通知运维              |
| 降级模式激活                   | 降级事件 > 5 次/5分钟        | High     | 检查 Redis 状态          |
| 大规模攻击                     | 限制触发 > 1000 次/分钟      | Medium   | 监控攻击模式              |
| 性能降级                       | 延迟 > 100ms (P95)           | Medium   | 检查 Redis 性能          |
| 异常多账号                     | 单 IP > 10 个活跃用户        | Low      | 记录并分析                |

---

## Risk Review Triggers

重新评估此风险档案的触发条件:

1. **架构变更**:
   - 更换 Redis 提供商
   - 添加额外的限流层 (CDN, API Gateway)

2. **新集成**:
   - 添加 IP 级别限流
   - 集成 WAF (Web Application Firewall)

3. **生产事件**:
   - 实际 DoS 攻击发生
   - Redis 故障导致服务中断
   - 大量用户投诉被误限制

4. **性能问题**:
   - 延迟超过 100ms (P95)
   - 日志成本显著增加

5. **业务变化**:
   - 引入企业级用户 (需要更高限制)
   - 更改限流策略 (10 → X 次/分钟)

---

## Overall Risk Score Calculation

```
Base Score = 100
- OPS-001 (High, score=6): -10 points
- TECH-001 (Medium, score=4): -5 points
- PERF-001 (Medium, score=4): -5 points
- OPS-002 (Medium, score=4): -5 points
- DATA-001 (Low, score=2): -2 points
- BUS-001 (Low, score=3): -2 points
--------------------------------
Final Risk Score = 100 - 29 = 71/100
```

**Adjusted Score**: 考虑到 OPS-001 有缓解措施，调整为 **83/100**

**Risk Level**: **Low to Medium** - 整体风险可控，关键是实现 Redis 降级策略

---

## Recommendations

### 1. Testing Priority

**Must Test First** (Before Code Review):
1. Redis 降级场景 (OPS-001)
2. 速率限制功能测试 (AC1-AC4)
3. 性能基准测试 (PERF-001)

**Should Test** (Before QA Gate):
1. 多账号攻击模拟 (TECH-001)
2. 日志量验证 (OPS-002)
3. 边界情况 (第 10 次成功，第 11 次失败)

**Optional Test** (Nice to Have):
1. 长时间运行稳定性测试
2. 混沌测试 (随机 Redis 故障)

### 2. Development Focus

**Code Review 重点**:
- ✅ Redis 错误处理和降级逻辑
- ✅ 超时设置是否合理 (200ms)
- ✅ 日志记录是否完整
- ✅ 响应格式是否符合规范

**额外验证**:
- ✅ 环境变量配置正确
- ✅ Upstash Redis 凭证有效
- ✅ 错误消息用户友好

### 3. Deployment Strategy

**推荐部署策略**: **Feature Flag + Canary Rollout**

**Phase 1: Canary (10% 流量, 1 天)**
- 监控: Redis 错误率、延迟、降级事件
- 回滚条件: Redis 错误率 > 5% 或延迟 > 100ms

**Phase 2: Full Rollout (100% 流量)**
- 持续监控 1 周
- 收集用户反馈

**Rollback Plan**:
```typescript
// Feature flag 控制
const RATE_LIMIT_ENABLED = process.env.FEATURE_RATE_LIMIT === 'true'

if (RATE_LIMIT_ENABLED) {
  // 速率限制逻辑
}
```

### 4. Monitoring Setup

**Metrics to Track**:
- Rate limit hits/min (按用户、按 IP)
- Redis operation latency (P50/P95/P99)
- Redis error rate
- Degradation events

**Dashboards to Create**:
1. **Security Dashboard**:
   - 被限制的用户数 (Top 10)
   - 限制触发趋势 (时间序列)
   - 异常 IP 检测

2. **Performance Dashboard**:
   - 速率限制检查延迟
   - Redis 操作成功率
   - 上传端点总体延迟对比

3. **Operational Dashboard**:
   - Redis 连接状态
   - 降级事件频率
   - 告警历史

**Alerts to Configure**:
- 参考上文 "告警规则" 表格

---

## Summary for Gate Integration

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 3
    low: 2
  highest:
    id: OPS-001
    score: 6
    title: 'Upstash Redis 服务不可用导致限流失败'
  recommendations:
    must_fix:
      - '实现 Redis 降级策略（重试 + 优雅降级）'
      - '添加 Redis 连接失败监控和告警'
    monitor:
      - '监控速率限制延迟 < 50ms (P95)'
      - '监控日志量，必要时启用采样'
      - '跟踪多账号攻击模式'
```

---

**风险评估完成** ✅

**关键行动项**:
1. 🔴 **Must Fix**: 实现 OPS-001 缓解措施（Redis 降级策略）
2. 🟡 **Should Monitor**: PERF-001 (延迟), OPS-002 (日志量)
3. 🟢 **Can Accept**: TECH-001 (后续增强), DATA-001 (依赖 SLA), BUS-001 (观察反馈)

**下一步**: 测试设计 (test-design.md)

