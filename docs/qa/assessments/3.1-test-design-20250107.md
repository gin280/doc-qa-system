# 测试设计: Story 3.1 - 问答界面与输入处理

**日期**: 2025-01-07  
**设计者**: Quinn (测试架构师)  
**Story ID**: 3.1  
**Story标题**: 问答界面与输入处理

---

## 测试策略概览

- **总测试场景数**: 47
- **单元测试**: 18 (38%)
- **集成测试**: 19 (40%)
- **E2E测试**: 10 (22%)
- **优先级分布**: P0: 24, P1: 15, P2: 8

---

## 按验收标准的测试场景

### AC1: 文档选择界面

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.1-UNIT-001 | Unit | P0 | DocumentSelector过滤READY状态文档 | 纯逻辑过滤功能 |
| 3.1-UNIT-002 | Unit | P1 | 搜索功能实时过滤文档名称 | 搜索逻辑独立测试 |
| 3.1-UNIT-003 | Unit | P1 | 空状态显示正确提示文本 | UI组件边界情况 |
| 3.1-INT-001 | Integration | P0 | 集成useDocuments Hook返回READY文档 | 组件间数据流验证 |
| 3.1-INT-002 | Integration | P1 | 选择文档更新URL参数?docId=xxx | 路由状态同步 |
| 3.1-E2E-001 | E2E | P0 | 用户访问/chat看到文档列表 | 关键用户旅程 |
| 3.1-E2E-002 | E2E | P1 | 搜索文档名称过滤列表 | 完整搜索流程 |

**覆盖的AC子项**:
- ✅ 显示READY状态文档
- ✅ 显示文件类型图标
- ✅ 默认选中最近上传
- ✅ 搜索过滤功能
- ✅ URL参数保存
- ✅ 空状态提示

---

### AC2: 问题输入界面

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.1-UNIT-004 | Unit | P0 | 输入验证: 长度1-1000字符 | 核心业务规则 |
| 3.1-UNIT-005 | Unit | P0 | 输入为空时禁用发送按钮 | 防止无效提交 |
| 3.1-UNIT-006 | Unit | P1 | 字符计数实时更新 | UI反馈逻辑 |
| 3.1-UNIT-007 | Unit | P1 | 超过1000字符显示警告 | 边界情况处理 |
| 3.1-UNIT-008 | Unit | P1 | 自动高度调整(最多5行) | UI行为逻辑 |
| 3.1-UNIT-009 | Unit | P0 | Ctrl/Cmd+Enter快捷键发送 | 关键交互逻辑 |
| 3.1-UNIT-010 | Unit | P1 | Shift+Enter换行功能 | 交互逻辑 |
| 3.1-INT-003 | Integration | P0 | ChatInput组件集成useChat Hook | 组件间状态传递 |
| 3.1-E2E-003 | E2E | P0 | 用户输入问题并点击发送 | 核心用户流程 |
| 3.1-E2E-004 | E2E | P1 | 快捷键Ctrl+Enter发送问题 | 高级用户流程 |

**覆盖的AC子项**:
- ✅ 多行输入框(最多5行)
- ✅ 占位符文本
- ✅ 字符计数显示
- ✅ 空输入禁用发送
- ✅ 快捷键支持
- ✅ 输入验证
- ✅ 过长警告

---

### AC3: 发送问题功能

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.1-UNIT-011 | Unit | P0 | useChat.sendMessage调用API | 核心Hook功能 |
| 3.1-UNIT-012 | Unit | P0 | 发送后清空输入框 | 状态管理逻辑 |
| 3.1-UNIT-013 | Unit | P0 | 用户消息立即添加到messages数组 | 状态更新逻辑 |
| 3.1-UNIT-014 | Unit | P1 | 生成conversationId(如果不存在) | UUID生成逻辑 |
| 3.1-INT-004 | Integration | P0 | POST /api/chat/query参数正确 | API契约验证 |
| 3.1-INT-005 | Integration | P0 | 发送时禁用输入和按钮 | UI状态管理 |
| 3.1-INT-006 | Integration | P1 | 显示加载状态(Spinner) | UI反馈集成 |
| 3.1-E2E-005 | E2E | P0 | 完整发送流程: 输入→发送→显示消息 | 端到端验证 |

**覆盖的AC子项**:
- ✅ 问题显示在右侧气泡
- ✅ 输入框清空并聚焦
- ✅ 发送按钮加载状态
- ✅ AI思考中提示
- ✅ API调用正确参数
- ✅ 发送时禁用交互
- ✅ 错误处理

---

### AC4: 对话历史显示

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.1-UNIT-015 | Unit | P1 | ChatMessage正确渲染用户消息 | 组件渲染逻辑 |
| 3.1-UNIT-016 | Unit | P1 | ChatMessage正确渲染AI消息 | 组件渲染逻辑 |
| 3.1-UNIT-017 | Unit | P1 | 时间戳格式化显示 | 时间处理逻辑 |
| 3.1-UNIT-018 | Unit | P2 | 自动滚动到最新消息 | 滚动行为逻辑 |
| 3.1-INT-007 | Integration | P1 | ChatMessageList渲染消息数组 | 列表渲染集成 |
| 3.1-INT-008 | Integration | P1 | 空状态显示欢迎提示 | 空状态处理 |
| 3.1-INT-009 | Integration | P2 | Framer Motion动画正常工作 | 动画集成 |
| 3.1-E2E-006 | E2E | P1 | 发送多条消息形成对话历史 | 完整对话流程 |

**覆盖的AC子项**:
- ✅ 历史消息显示
- ✅ 用户问题右对齐蓝色
- ✅ AI回答左对齐白色
- ✅ 时间戳显示
- ✅ 自动滚动
- ✅ 支持滚动查看
- ✅ 空状态提示

---

### AC5: 加载状态和反馈

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.1-INT-010 | Integration | P0 | 发送按钮显示Spinner图标 | 加载状态UI |
| 3.1-INT-011 | Integration | P0 | 输入框和按钮正确禁用 | 交互状态管理 |
| 3.1-INT-012 | Integration | P1 | 显示"AI思考中..."动画 | 加载反馈 |
| 3.1-INT-013 | Integration | P2 | 骨架加载效果显示 | UI优化 |
| 3.1-INT-014 | Integration | P1 | 10秒后显示"正在处理"提示 | 超时反馈 |
| 3.1-INT-015 | Integration | P0 | 30秒后显示超时提示 | 超时处理 |
| 3.1-E2E-007 | E2E | P1 | 完整加载流程用户可见 | 用户体验验证 |

**覆盖的AC子项**:
- ✅ Spinner图标显示
- ✅ 输入禁用
- ✅ AI思考中动画
- ✅ 骨架加载
- ✅ 10秒提示
- ✅ 30秒超时

---

### AC6: 错误处理

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.1-INT-016 | Integration | P0 | 网络错误显示正确toast | 错误处理核心 |
| 3.1-INT-017 | Integration | P0 | 401错误提示重新登录 | 认证错误处理 |
| 3.1-INT-018 | Integration | P0 | 404错误提示文档不存在 | 资源错误处理 |
| 3.1-INT-019 | Integration | P0 | 500错误提示服务不可用 | 服务器错误处理 |
| 3.1-INT-020 | Integration | P1 | 配额限制错误提示 | 业务错误处理 |
| 3.1-INT-021 | Integration | P1 | 错误消息标记为失败状态 | 错误状态管理 |
| 3.1-INT-022 | Integration | P1 | 重试按钮功能正常 | 错误恢复功能 |
| 3.1-INT-023 | Integration | P0 | 错误后恢复输入可用状态 | 状态恢复 |
| 3.1-E2E-008 | E2E | P0 | 模拟网络错误完整流程 | 端到端错误处理 |

**覆盖的AC子项**:
- ✅ Toast通知显示
- ✅ 网络错误提示
- ✅ 401错误处理
- ✅ 404错误处理
- ✅ 500错误处理
- ✅ 配额限制提示
- ✅ 失败状态标记
- ✅ 重试按钮
- ✅ 状态恢复

---

### AC7: 新建对话功能

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.1-INT-024 | Integration | P1 | newConversation清空消息数组 | 状态重置逻辑 |
| 3.1-INT-025 | Integration | P1 | conversationId重置为null | 会话管理 |
| 3.1-INT-026 | Integration | P1 | 显示欢迎提示 | UI状态切换 |
| 3.1-INT-027 | Integration | P1 | 输入框聚焦并可用 | 焦点管理 |
| 3.1-INT-028 | Integration | P2 | 文档选择保持不变 | 部分状态保留 |
| 3.1-E2E-009 | E2E | P1 | 完整新建对话流程 | 端到端验证 |

**覆盖的AC子项**:
- ✅ 清空对话区域
- ✅ 显示欢迎提示
- ✅ conversationId重置
- ✅ 输入框聚焦
- ✅ 文档选择保持

---

### AC8: 响应式设计

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.1-E2E-010 | E2E | P1 | 桌面视口(≥1024px)完整布局 | 响应式验证 |
| 3.1-E2E-011 | E2E | P1 | 平板视口(768-1023px)折叠布局 | 响应式验证 |
| 3.1-E2E-012 | E2E | P2 | 手机视口(≤767px)垂直布局 | 响应式验证 |
| 3.1-E2E-013 | E2E | P1 | 输入框固定底部所有视口 | 布局约束 |
| 3.1-E2E-014 | E2E | P2 | 触摸目标≥44px(移动端) | 可用性验证 |

**覆盖的AC子项**:
- ✅ 桌面完整布局
- ✅ 平板折叠布局
- ✅ 手机垂直布局
- ✅ 输入框固定底部
- ✅ 对话区域自适应
- ✅ 触摸友好

---

### AC9: 性能要求

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.1-PERF-001 | Integration | P0 | 输入框响应时间 < 50ms | 关键性能指标 |
| 3.1-PERF-002 | Integration | P0 | 发送按钮点击响应 < 100ms | 关键性能指标 |
| 3.1-PERF-003 | Integration | P0 | API调用发起 < 200ms | 关键性能指标 |
| 3.1-PERF-004 | Integration | P0 | 100条消息渲染 < 500ms | 关键性能指标 |
| 3.1-PERF-005 | Integration | P1 | 自动滚动动画 < 300ms | 性能优化 |
| 3.1-PERF-006 | Integration | P1 | 输入防抖优化验证 | 性能优化 |

**覆盖的AC子项**:
- ✅ 输入响应 < 50ms
- ✅ 按钮响应 < 100ms
- ✅ API调用 < 200ms
- ✅ 消息渲染 < 500ms
- ✅ 滚动动画 < 300ms
- ✅ 输入防抖

---

### AC10: 可访问性

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.1-A11Y-001 | Integration | P0 | 键盘导航支持所有交互元素 | 可访问性核心 |
| 3.1-A11Y-002 | Integration | P0 | Tab顺序符合视觉顺序 | 导航逻辑 |
| 3.1-A11Y-003 | Integration | P1 | 输入框有正确label | ARIA标签 |
| 3.1-A11Y-004 | Integration | P1 | 发送按钮有aria-label | ARIA标签 |
| 3.1-A11Y-005 | Integration | P1 | 加载状态通过aria-live通知 | 动态内容通知 |
| 3.1-A11Y-006 | Integration | P1 | 错误信息role="alert" | 错误通知 |
| 3.1-A11Y-007 | Integration | P1 | 对话区域role="log" | 语义化标记 |
| 3.1-A11Y-008 | Integration | P2 | 快捷键提示清晰显示 | 用户引导 |
| 3.1-E2E-015 | E2E | P0 | axe-core自动化扫描无严重问题 | 可访问性验证 |

**覆盖的AC子项**:
- ✅ 键盘导航支持
- ✅ Tab顺序正确
- ✅ label标签
- ✅ aria-label标签
- ✅ aria-live通知
- ✅ role="alert"
- ✅ role="log"
- ✅ 快捷键提示

---

## 测试场景汇总

### 按测试级别分类

#### 单元测试 (18个场景, 38%)

**useChat Hook测试** (5个):
- 3.1-UNIT-011: sendMessage调用API
- 3.1-UNIT-012: 发送后清空输入框
- 3.1-UNIT-013: 用户消息立即添加
- 3.1-UNIT-014: 生成conversationId

**ChatInput组件测试** (6个):
- 3.1-UNIT-004: 输入验证1-1000字符
- 3.1-UNIT-005: 空输入禁用按钮
- 3.1-UNIT-006: 字符计数实时更新
- 3.1-UNIT-007: 超过1000字符警告
- 3.1-UNIT-008: 自动高度调整
- 3.1-UNIT-009: Ctrl+Enter快捷键
- 3.1-UNIT-010: Shift+Enter换行

**DocumentSelector组件测试** (2个):
- 3.1-UNIT-001: 过滤READY状态文档
- 3.1-UNIT-002: 搜索过滤功能
- 3.1-UNIT-003: 空状态提示

**ChatMessage组件测试** (4个):
- 3.1-UNIT-015: 渲染用户消息
- 3.1-UNIT-016: 渲染AI消息
- 3.1-UNIT-017: 时间戳格式化
- 3.1-UNIT-018: 自动滚动

---

#### 集成测试 (19个场景, 40%)

**组件集成测试** (9个):
- 3.1-INT-001: 集成useDocuments Hook
- 3.1-INT-002: 更新URL参数
- 3.1-INT-003: ChatInput集成useChat
- 3.1-INT-004: API调用参数
- 3.1-INT-005: 发送时禁用交互
- 3.1-INT-006: 加载状态显示
- 3.1-INT-007: 消息列表渲染
- 3.1-INT-008: 空状态显示
- 3.1-INT-009: Framer Motion动画

**加载状态测试** (6个):
- 3.1-INT-010: 发送按钮Spinner
- 3.1-INT-011: 输入禁用
- 3.1-INT-012: AI思考中动画
- 3.1-INT-013: 骨架加载
- 3.1-INT-014: 10秒提示
- 3.1-INT-015: 30秒超时

**错误处理测试** (8个):
- 3.1-INT-016: 网络错误toast
- 3.1-INT-017: 401错误
- 3.1-INT-018: 404错误
- 3.1-INT-019: 500错误
- 3.1-INT-020: 配额限制
- 3.1-INT-021: 失败状态标记
- 3.1-INT-022: 重试按钮
- 3.1-INT-023: 状态恢复

**新建对话测试** (5个):
- 3.1-INT-024: 清空消息数组
- 3.1-INT-025: conversationId重置
- 3.1-INT-026: 显示欢迎提示
- 3.1-INT-027: 输入框聚焦
- 3.1-INT-028: 文档选择保持

**性能测试** (6个):
- 3.1-PERF-001: 输入响应 < 50ms
- 3.1-PERF-002: 按钮响应 < 100ms
- 3.1-PERF-003: API调用 < 200ms
- 3.1-PERF-004: 100条消息 < 500ms
- 3.1-PERF-005: 滚动动画 < 300ms
- 3.1-PERF-006: 输入防抖

**可访问性测试** (8个):
- 3.1-A11Y-001: 键盘导航
- 3.1-A11Y-002: Tab顺序
- 3.1-A11Y-003: 输入框label
- 3.1-A11Y-004: 按钮aria-label
- 3.1-A11Y-005: aria-live通知
- 3.1-A11Y-006: role="alert"
- 3.1-A11Y-007: role="log"
- 3.1-A11Y-008: 快捷键提示

---

#### E2E测试 (10个场景, 22%)

**核心用户流程** (6个):
- 3.1-E2E-001: 访问/chat看到文档列表 (P0)
- 3.1-E2E-003: 输入问题并发送 (P0)
- 3.1-E2E-005: 完整发送流程 (P0)
- 3.1-E2E-008: 网络错误流程 (P0)
- 3.1-E2E-002: 搜索文档过滤 (P1)
- 3.1-E2E-004: 快捷键发送 (P1)

**对话管理** (2个):
- 3.1-E2E-006: 多条消息对话历史 (P1)
- 3.1-E2E-009: 新建对话流程 (P1)

**响应式设计** (5个):
- 3.1-E2E-010: 桌面视口 (P1)
- 3.1-E2E-011: 平板视口 (P1)
- 3.1-E2E-013: 输入框固定底部 (P1)
- 3.1-E2E-012: 手机视口 (P2)
- 3.1-E2E-014: 触摸目标大小 (P2)

**可访问性** (1个):
- 3.1-E2E-015: axe-core自动化扫描 (P0)

---

### 按优先级分类

#### P0测试 (24个) - 必须通过

**单元测试** (5个):
- 输入验证、空输入禁用、快捷键、sendMessage、消息添加

**集成测试** (13个):
- useDocuments集成、API参数、发送禁用、加载状态、30秒超时
- 网络错误、401/404/500错误、状态恢复
- 所有性能指标测试
- 键盘导航、Tab顺序

**E2E测试** (6个):
- 访问页面、输入发送、完整流程、网络错误、axe-core扫描

---

#### P1测试 (15个) - 重要但非阻塞

**单元测试** (7个):
- 搜索过滤、字符计数、超长警告、高度调整、换行、消息渲染、时间戳

**集成测试** (4个):
- URL参数、10秒提示、配额限制、重试按钮
- 新建对话功能、ARIA标签

**E2E测试** (4个):
- 搜索文档、快捷键、多条消息、新建对话、响应式(桌面/平板)

---

#### P2测试 (8个) - 优化项

**单元测试** (2个):
- 自动滚动、空状态

**集成测试** (4个):
- Framer Motion动画、骨架加载、文档选择保持、快捷键提示

**E2E测试** (2个):
- 手机视口、触摸目标大小

---

## 测试覆盖率分析

### 验收标准覆盖

| AC | 测试场景数 | 单元 | 集成 | E2E | 覆盖率 |
|----|-----------|------|------|-----|--------|
| AC1 | 7 | 3 | 2 | 2 | 100% |
| AC2 | 10 | 7 | 1 | 2 | 100% |
| AC3 | 8 | 4 | 3 | 1 | 100% |
| AC4 | 8 | 4 | 3 | 1 | 100% |
| AC5 | 7 | 0 | 6 | 1 | 100% |
| AC6 | 9 | 0 | 8 | 1 | 100% |
| AC7 | 6 | 0 | 5 | 1 | 100% |
| AC8 | 5 | 0 | 0 | 5 | 100% |
| AC9 | 6 | 0 | 6 | 0 | 100% |
| AC10 | 9 | 0 | 8 | 1 | 100% |

**总覆盖率**: 100% (所有AC都有对应测试)

---

## 推荐测试执行顺序

### 第一阶段: P0单元测试 (快速反馈)

1. 输入验证逻辑
2. useChat Hook核心功能
3. 快捷键功能
4. 组件渲染基础

**预期时间**: 1-2小时  
**失败标准**: 任何P0单元测试失败 → 停止开发修复

---

### 第二阶段: P0集成测试 (组件交互)

1. API调用和参数验证
2. 错误处理(401/404/500/网络)
3. 性能测试(所有指标)
4. 可访问性基础(键盘导航、Tab顺序)

**预期时间**: 2-3小时  
**失败标准**: 性能不达标或错误处理失败 → 优化代码

---

### 第三阶段: P0 E2E测试 (端到端验证)

1. 访问/chat页面流程
2. 完整发送问题流程
3. 网络错误完整处理
4. axe-core可访问性扫描

**预期时间**: 1-2小时  
**失败标准**: 任何关键流程失败 → 修复后重测

---

### 第四阶段: P1测试 (时间允许)

1. P1单元测试(搜索、字符计数等)
2. P1集成测试(ARIA标签、新建对话)
3. P1 E2E测试(快捷键、响应式)

**预期时间**: 2-3小时  
**失败标准**: 不阻塞发布,记录技术债

---

### 第五阶段: P2测试 (优化验证)

1. 动画和视觉效果
2. 移动端触摸优化
3. 边界情况

**预期时间**: 1-2小时  
**失败标准**: 不影响发布

---

## 风险覆盖映射

### 关键风险的测试覆盖

| 风险ID | 风险描述 | 相关测试场景 |
|--------|----------|-------------|
| PERF-001 | 消息列表性能 | 3.1-PERF-004 (100条消息<500ms) |
| UX-001 | 输入防抖卡顿 | 3.1-PERF-001 (输入<50ms), 3.1-PERF-006 (防抖) |
| SEC-001 | XSS注入 | 3.1-UNIT-015/016 (消息渲染), 手动安全测试 |
| REL-001 | API超时 | 3.1-INT-015 (30秒超时), 3.1-INT-023 (状态恢复) |
| DATA-001 | 状态丢失 | 3.1-E2E-006 (多条消息), 需额外localStorage测试 |

**覆盖率**: 5/5 (100%)  
**缺口**: 需手动XSS安全测试, localStorage持久化测试

---

## 测试数据需求

### Mock数据

**文档列表**:
```typescript
const mockDocuments = [
  { id: '1', name: 'PRD.pdf', status: 'READY', type: 'pdf', createdAt: '2025-01-01' },
  { id: '2', name: 'Architecture.docx', status: 'READY', type: 'docx', createdAt: '2025-01-02' },
  { id: '3', name: 'Processing.pdf', status: 'PROCESSING', type: 'pdf', createdAt: '2025-01-03' },
  { id: '4', name: 'Failed.pdf', status: 'FAILED', type: 'pdf', createdAt: '2025-01-04' }
]
```

**消息数据**:
```typescript
const mockMessages = [
  { id: '1', role: 'user', content: '这是什么文档?', timestamp: new Date(), status: 'success' },
  { id: '2', role: 'assistant', content: '这是一个PRD文档...', timestamp: new Date(), status: 'success' },
  // ... 100条用于性能测试
]
```

**API响应**:
```typescript
// 成功响应
{ success: true, conversationId: 'xxx', message: 'API验证通过' }

// 错误响应
{ error: '未授权,请先登录' } // 401
{ error: '文档不存在或无权访问' } // 404
{ error: '服务器错误' } // 500
```

---

## 测试环境配置

### 所需工具

- **Jest**: 单元和集成测试
- **React Testing Library**: 组件测试
- **MSW (Mock Service Worker)**: API Mock
- **Playwright**: E2E测试
- **axe-core**: 可访问性测试
- **Chrome DevTools**: 性能分析

### 环境变量

```env
# 测试环境
NODE_ENV=test
NEXT_PUBLIC_API_URL=http://localhost:3000
DATABASE_URL=postgresql://test:test@localhost:5432/docqa_test

# Mock用户
TEST_USER_ID=test-user-1
TEST_USER_EMAIL=test@example.com
```

---

## 测试完成检查清单

### 单元测试完成标准

- [ ] 所有P0单元测试通过
- [ ] 代码覆盖率 > 70% (关键Hook和组件)
- [ ] 所有边界情况测试
- [ ] 快照测试更新

### 集成测试完成标准

- [ ] 所有P0集成测试通过
- [ ] API Mock配置正确
- [ ] 错误处理全覆盖
- [ ] 性能指标全达标

### E2E测试完成标准

- [ ] 所有P0 E2E测试通过
- [ ] 关键用户流程验证
- [ ] 跨浏览器测试(Chrome, Firefox)
- [ ] axe-core扫描无严重问题

### 整体完成标准

- [ ] 24个P0测试全部通过
- [ ] 至少10个P1测试通过
- [ ] 无已知阻塞问题
- [ ] 性能指标全部达标
- [ ] 可访问性基本达标

---

## 关键测试代码示例

### 示例1: 输入验证单元测试

```typescript
// tests/unit/components/ChatInput.test.tsx

import { render, screen, fireEvent } from '@testing-library/react'
import { ChatInput } from '@/components/chat/ChatInput'

describe('ChatInput - 3.1-UNIT-004: 输入验证', () => {
  it('应该在输入为空时禁用发送按钮', () => {
    const onSend = jest.fn()
    render(<ChatInput onSend={onSend} />)
    
    const button = screen.getByRole('button', { name: /发送/i })
    expect(button).toBeDisabled()
  })

  it('应该在输入有效时启用发送按钮', () => {
    const onSend = jest.fn()
    render(<ChatInput onSend={onSend} />)
    
    const textarea = screen.getByRole('textbox')
    fireEvent.change(textarea, { target: { value: '这是一个问题' } })
    
    const button = screen.getByRole('button', { name: /发送/i })
    expect(button).not.toBeDisabled()
  })

  it('应该在超过1000字符时显示警告', () => {
    const onSend = jest.fn()
    render(<ChatInput onSend={onSend} />)
    
    const textarea = screen.getByRole('textbox')
    const longText = 'a'.repeat(1001)
    fireEvent.change(textarea, { target: { value: longText } })
    
    expect(screen.getByText(/问题过长,请精简/i)).toBeInTheDocument()
  })
})
```

---

### 示例2: API集成测试

```typescript
// tests/integration/api/chat-query.test.ts

import { POST } from '@/app/api/chat/query/route'
import { NextRequest } from 'next/server'

describe('API /api/chat/query - 3.1-INT-004', () => {
  it('应该验证必需参数', async () => {
    const req = new NextRequest('http://localhost:3000/api/chat/query', {
      method: 'POST',
      body: JSON.stringify({ question: '测试问题' }) // 缺少documentId
    })

    const response = await POST(req)
    const data = await response.json()

    expect(response.status).toBe(400)
    expect(data.error).toContain('缺少documentId')
  })

  it('应该验证问题长度', async () => {
    const req = new NextRequest('http://localhost:3000/api/chat/query', {
      method: 'POST',
      body: JSON.stringify({
        documentId: 'doc-1',
        question: 'a'.repeat(1001) // 超长
      })
    })

    const response = await POST(req)
    const data = await response.json()

    expect(response.status).toBe(400)
    expect(data.error).toContain('问题过长')
  })
})
```

---

### 示例3: 性能测试

```typescript
// tests/integration/performance/message-list.test.tsx

import { render } from '@testing-library/react'
import { ChatMessageList } from '@/components/chat/ChatMessageList'
import { performance } from 'perf_hooks'

describe('性能测试 - 3.1-PERF-004', () => {
  it('应该在500ms内渲染100条消息', () => {
    const messages = Array.from({ length: 100 }, (_, i) => ({
      id: `msg-${i}`,
      role: i % 2 === 0 ? 'user' : 'assistant',
      content: `消息内容 ${i}`,
      timestamp: new Date(),
      status: 'success'
    }))

    const startTime = performance.now()
    render(<ChatMessageList messages={messages} isLoading={false} />)
    const endTime = performance.now()

    const renderTime = endTime - startTime
    expect(renderTime).toBeLessThan(500)
  })
})
```

---

### 示例4: E2E测试

```typescript
// tests/e2e/chat-interface.test.ts

import { test, expect } from '@playwright/test'

test('3.1-E2E-005: 完整发送流程', async ({ page }) => {
  // 1. 登录
  await page.goto('/login')
  await page.fill('input[name="email"]', 'test@example.com')
  await page.fill('input[name="password"]', 'password123')
  await page.click('button[type="submit"]')

  // 2. 访问问答页面
  await page.goto('/chat')
  await expect(page).toHaveURL(/\/chat/)

  // 3. 选择文档
  await page.click('select[name="document"]')
  await page.selectOption('select[name="document"]', 'doc-1')

  // 4. 输入问题
  const textarea = page.locator('textarea[placeholder*="请输入"]')
  await textarea.fill('这是什么文档?')

  // 5. 点击发送
  await page.click('button[aria-label="发送问题"]')

  // 6. 验证用户消息显示
  await expect(page.locator('text=这是什么文档?')).toBeVisible()

  // 7. 验证加载状态
  await expect(page.locator('text=AI思考中')).toBeVisible()

  // 8. 验证输入框清空
  await expect(textarea).toHaveValue('')
})
```

---

## 附录: 测试优先级决策矩阵

### 决策标准

| 标准 | P0 | P1 | P2 |
|------|----|----|-----|
| 影响范围 | 核心功能 | 重要功能 | 优化功能 |
| 失败影响 | 阻塞使用 | 降低体验 | 轻微影响 |
| 用户可见性 | 高 | 中 | 低 |
| 业务价值 | 必需 | 重要 | 可选 |
| 测试成本 | 任何成本 | 合理成本 | 低成本 |

### 测试级别选择

**单元测试** (优先):
- 纯逻辑函数
- 独立组件
- Hook功能
- 输入验证

**集成测试** (重点):
- 组件间交互
- API调用
- 状态管理
- 错误处理

**E2E测试** (关键路径):
- 核心用户流程
- 跨页面交互
- 真实用户场景

---

**测试设计完成日期**: 2025-01-07  
**设计者**: Quinn (测试架构师)  
**总测试场景**: 47个 (P0: 24, P1: 15, P2: 8)  
**预估执行时间**: 9-13小时
