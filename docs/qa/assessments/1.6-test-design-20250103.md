# 测试设计: Story 1.6 - 用户账户管理页面

**日期**: 2025-01-03  
**设计者**: Quinn (测试架构师)  
**Story**: 1.6 - 用户账户管理页面

---

## 测试策略概述

- **测试场景总数**: 47
- **单元测试**: 24 (51%)
- **集成测试**: 18 (38%)
- **E2E 测试**: 5 (11%)
- **优先级分布**:
  - P0: 15 (32%)
  - P1: 18 (38%)
  - P2: 10 (21%)
  - P3: 4 (9%)

**测试策略**: 重点关注安全和数据完整性,采用左移测试策略,优先单元测试验证业务逻辑,集成测试验证组件交互,E2E 测试验证关键用户旅程。

---

## 按验收标准的测试场景

### AC1: 账户设置页面路由与布局

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-E2E-001 | E2E | P0 | 未登录用户访问 /settings 自动跳转到 /login | 关键用户旅程 - 安全边界 |
| 1.6-INT-001 | Integration | P0 | 已登录用户访问 /settings 页面成功加载 | 核心功能 - 页面可访问性 |
| 1.6-UNIT-001 | Unit | P1 | useSession hook 返回 unauthenticated 状态时触发跳转 | 认证逻辑 - 状态处理 |
| 1.6-UNIT-002 | Unit | P1 | 页面加载时显示三个主要卡片区域 | UI 组件 - 布局完整性 |
| 1.6-UNIT-003 | Unit | P2 | 页面加载中显示 spinner | UX - 加载状态 |

**覆盖的 AC**: AC1 完全覆盖

---

### AC2: 个人信息展示与编辑

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-INT-002 | Integration | P0 | GET /api/user/profile 返回完整用户信息 | 数据完整性 - API 响应 |
| 1.6-UNIT-004 | Unit | P1 | 显示用户头像(有头像和无头像两种情况) | UI 渲染 - 条件渲染 |
| 1.6-UNIT-005 | Unit | P1 | OAuth 用户显示"头像与第三方账号同步"提示 | UI 逻辑 - OAuth 特殊处理 |
| 1.6-UNIT-006 | Unit | P0 | 用户名输入框实时验证长度(2-50字符) | 表单验证 - 输入约束 |
| 1.6-UNIT-007 | Unit | P1 | 用户名未改变时"保存"按钮禁用 | 交互逻辑 - 按钮状态 |
| 1.6-INT-003 | Integration | P0 | PATCH /api/user/profile 成功更新用户名 | 核心功能 - 数据更新 |
| 1.6-INT-004 | Integration | P1 | 更新用户名成功后显示 Toast 提示 | UX - 反馈机制 |
| 1.6-UNIT-008 | Unit | P1 | 注册时间格式化为中文日期格式 | 数据展示 - 格式化 |
| 1.6-UNIT-009 | Unit | P2 | 邮箱地址显示认证方式标签 | UI 展示 - 信息完整性 |

**覆盖的 AC**: AC2 完全覆盖

---

### AC3: 修改密码功能

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-UNIT-010 | Unit | P0 | EMAIL 认证用户显示"修改密码"按钮 | 权限控制 - 条件显示 |
| 1.6-UNIT-011 | Unit | P0 | OAuth 用户隐藏"修改密码"按钮 | 权限控制 - 安全边界 |
| 1.6-UNIT-012 | Unit | P1 | 点击"修改密码"打开模态框 | 交互逻辑 - 模态框控制 |
| 1.6-UNIT-013 | Unit | P0 | 新密码验证: 至少8位 | 表单验证 - 密码规则 |
| 1.6-UNIT-014 | Unit | P0 | 新密码验证: 包含字母和数字 | 表单验证 - 密码强度 |
| 1.6-UNIT-015 | Unit | P0 | 确认密码与新密码不一致时显示错误 | 表单验证 - 一致性检查 |
| 1.6-UNIT-016 | Unit | P1 | 密码强度指示器正确显示(弱/中/强) | UX - 密码强度反馈 |
| 1.6-INT-005 | Integration | P0 | PATCH /api/user/password 验证当前密码正确 | 安全 - 身份验证 |
| 1.6-INT-006 | Integration | P0 | PATCH /api/user/password 当前密码错误返回 401 | 安全 - 错误处理 |
| 1.6-INT-007 | Integration | P0 | 修改密码成功后更新数据库 passwordHash | 数据完整性 - 哈希存储 |
| 1.6-INT-008 | Integration | P0 | OAuth 用户调用修改密码 API 返回 400 | 安全 - API 权限控制 |
| 1.6-INT-009 | Integration | P0 | 修改密码 rate limiting: 5分钟内最多3次 | 安全 - 暴力破解防护 |
| 1.6-E2E-002 | E2E | P1 | 完整修改密码流程: 输入→验证→提交→成功 | 用户旅程 - 端到端验证 |

**覆盖的 AC**: AC3 完全覆盖

---

### AC4: 使用量统计展示

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-INT-010 | Integration | P1 | GET /api/user/usage 返回使用量统计数据 | 数据查询 - API 响应 |
| 1.6-INT-011 | Integration | P1 | 新用户无 usage 记录时返回默认值 0 | 边界情况 - 数据初始化 |
| 1.6-UNIT-017 | Unit | P1 | 进度条根据使用率显示正确颜色(绿/黄/红) | UI 逻辑 - 颜色编码 |
| 1.6-UNIT-018 | Unit | P1 | 使用率计算正确(当前/限额 * 100) | 业务逻辑 - 百分比计算 |
| 1.6-UNIT-019 | Unit | P2 | 存储空间格式化: bytes → MB/GB | 数据展示 - 单位转换 |
| 1.6-UNIT-020 | Unit | P2 | 查询重置日期格式化显示 | 数据展示 - 日期格式化 |

**覆盖的 AC**: AC4 完全覆盖

---

### AC5: 删除账户功能(危险操作)

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-UNIT-021 | Unit | P1 | "删除账户"按钮显示在危险操作卡片 | UI 展示 - 危险标识 |
| 1.6-UNIT-022 | Unit | P1 | 点击"删除账户"打开确认模态框 | 交互逻辑 - 二次确认 |
| 1.6-UNIT-023 | Unit | P0 | 输入邮箱与当前用户邮箱不一致时禁用删除按钮 | 表单验证 - 邮箱匹配 |
| 1.6-INT-012 | Integration | P0 | DELETE /api/user/account 验证邮箱匹配 | 安全 - 服务端验证 |
| 1.6-INT-013 | Integration | P0 | 删除账户后级联删除相关数据(onDelete: cascade) | 数据完整性 - 级联删除 |
| 1.6-INT-014 | Integration | P0 | 删除账户后清除 NextAuth session | 安全 - Session 管理 |
| 1.6-INT-015 | Integration | P0 | 删除账户 rate limiting: 1小时内最多1次 | 安全 - 操作限制 |
| 1.6-E2E-003 | E2E | P0 | 完整删除账户流程: 确认→删除→登出→跳转 | 用户旅程 - 关键流程 |
| 1.6-E2E-004 | E2E | P0 | 删除账户后清除 localStorage 和 sessionStorage | 安全 - 客户端清理 |

**覆盖的 AC**: AC5 完全覆盖

---

### AC6: API 端点实现

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-UNIT-024 | Unit | P0 | PATCH /api/user/profile 输入验证: name 2-50字符 | 输入验证 - 字段约束 |
| 1.6-INT-016 | Integration | P1 | PATCH /api/user/profile 更新 updatedAt 时间戳 | 数据完整性 - 时间戳 |
| 1.6-UNIT-025 | Unit | P0 | PATCH /api/user/password 验证三个密码字段非空 | 输入验证 - 必填字段 |
| 1.6-UNIT-026 | Unit | P0 | PATCH /api/user/password 使用 bcrypt 哈希(salt=10) | 安全 - 密码哈希 |
| 1.6-INT-017 | Integration | P1 | GET /api/user/usage 查询 user_usage 表 | 数据查询 - 表关联 |
| 1.6-INT-018 | Integration | P0 | DELETE /api/user/account 返回 204 No Content | API 规范 - 状态码 |

**覆盖的 AC**: AC6 完全覆盖

---

### AC7: 错误处理与安全

#### 测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-INT-019 | Integration | P1 | API 调用失败时显示友好错误提示 | UX - 错误处理 |
| 1.6-INT-020 | Integration | P1 | 密码修改失败3次后显示警告 | 安全 - 用户提示 |
| 1.6-UNIT-027 | Unit | P0 | 所有表单在客户端执行验证 | 安全 - 双重验证 |
| 1.6-UNIT-028 | Unit | P0 | 所有 API 在服务端执行验证 | 安全 - 双重验证 |
| 1.6-E2E-005 | E2E | P2 | 敏感操作需 CSRF Token 保护 | 安全 - CSRF 防护 |
| 1.6-INT-021 | Integration | P2 | Rate limiting 在多实例场景下工作 | 性能 - 分布式限流 |

**覆盖的 AC**: AC7 完全覆盖

---

## 额外的边界和错误测试场景

### 边界情况测试

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-UNIT-029 | Unit | P2 | 用户名边界: 正好2个字符 | 边界值 - 最小值 |
| 1.6-UNIT-030 | Unit | P2 | 用户名边界: 正好50个字符 | 边界值 - 最大值 |
| 1.6-UNIT-031 | Unit | P2 | 用户名边界: 1个字符(失败) | 边界值 - 小于最小 |
| 1.6-UNIT-032 | Unit | P2 | 用户名边界: 51个字符(失败) | 边界值 - 大于最大 |
| 1.6-UNIT-033 | Unit | P3 | 密码边界: 正好8个字符 | 边界值 - 最小长度 |
| 1.6-UNIT-034 | Unit | P3 | 密码边界: 包含特殊字符 | 边界值 - 字符类型 |

### 并发和竞态测试

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-INT-022 | Integration | P1 | 同时修改用户名和密码(乐观锁) | 并发 - 数据一致性 |
| 1.6-INT-023 | Integration | P2 | 快速连续点击"保存"按钮 | 并发 - 重复提交 |

### 安全测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-INT-024 | Integration | P0 | XSS 注入测试: 用户名包含 <script> 标签 | 安全 - XSS 防护 |
| 1.6-INT-025 | Integration | P0 | SQL 注入测试: 邮箱包含 SQL 语句 | 安全 - SQL 注入防护 |
| 1.6-INT-026 | Integration | P1 | CSRF 攻击模拟: 跨站请求删除账户 | 安全 - CSRF 防护 |

### 性能测试场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 1.6-INT-027 | Integration | P3 | API 响应时间 < 200ms (p95) | 性能 - 响应速度 |
| 1.6-INT-028 | Integration | P3 | 大存储值格式化(TB级别) | 性能 - 大数值处理 |

---

## 测试级别选择理由

### 单元测试 (24个场景)

**选择理由**: 纯前端逻辑、表单验证、UI 状态管理

**典型场景**:
- 表单验证规则(密码强度、用户名长度)
- UI 条件渲染(OAuth 用户特殊处理)
- 数据格式化(日期、存储空间)
- 业务逻辑计算(使用率百分比)

**优势**: 快速反馈、易于调试、覆盖边界情况

---

### 集成测试 (18个场景)

**选择理由**: API 端点、数据库交互、组件间通信

**典型场景**:
- API 端点的完整请求-响应流程
- 数据库 CRUD 操作
- Rate limiting 机制
- Session 管理
- 级联删除操作

**优势**: 验证组件协作、发现集成问题

---

### E2E 测试 (5个场景)

**选择理由**: 关键用户旅程、跨多个组件的复杂流程

**典型场景**:
- 未登录用户跳转流程
- 完整修改密码流程
- 完整删除账户流程
- 客户端存储清理

**优势**: 验证真实用户场景、发现系统级问题

---

## 优先级分配理由

### P0 (15个场景) - 必须通过才能发布

**关键标准**:
- 安全相关(认证、授权、密码哈希)
- 数据完整性(级联删除、Session 清理)
- 核心功能(登录控制、密码修改、账户删除)

**典型场景**:
- 未登录用户访问控制
- 密码验证和哈希
- OAuth 用户权限控制
- 账户删除和数据清理

---

### P1 (18个场景) - 重要但非阻塞

**关键标准**:
- 核心用户体验
- 常用功能
- 重要错误处理

**典型场景**:
- 用户名更新
- 使用量统计显示
- Toast 通知
- API 错误处理

---

### P2 (10个场景) - 增强功能

**关键标准**:
- 次要 UI 功能
- 边界值测试
- 性能优化

**典型场景**:
- 加载状态
- 数据格式化细节
- 边界值测试

---

### P3 (4个场景) - 可选优化

**关键标准**:
- Nice-to-have 功能
- 性能基准测试
- 罕见边界情况

**典型场景**:
- 性能基准
- 特殊字符处理
- 大数值处理

---

## 推荐的测试执行顺序

### 第一阶段: P0 测试 (阻塞发布)

1. **安全测试优先**
   - 认证和授权测试
   - 密码哈希和验证
   - Rate limiting
   - XSS/SQL 注入防护

2. **数据完整性测试**
   - 级联删除
   - Session 管理
   - 数据更新

3. **核心功能测试**
   - 登录控制
   - 密码修改
   - 账户删除

**预期通过率**: 100% (所有 P0 必须通过)

---

### 第二阶段: P1 测试

1. **用户体验测试**
   - Toast 通知
   - 错误提示
   - 加载状态

2. **功能完整性测试**
   - 用户名更新
   - 使用量统计
   - 模态框交互

**预期通过率**: > 95%

---

### 第三阶段: P2 & P3 测试

1. **边界值测试**
2. **性能测试**
3. **优化功能测试**

**预期通过率**: > 90%

---

## 测试覆盖率分析

### 按验收标准

| AC | 测试场景数 | P0 | P1 | P2 | P3 | 覆盖率 |
|----|-----------|----|----|----|----|--------|
| AC1 | 5 | 2 | 2 | 1 | 0 | 100% |
| AC2 | 9 | 3 | 5 | 1 | 0 | 100% |
| AC3 | 13 | 8 | 4 | 0 | 1 | 100% |
| AC4 | 6 | 0 | 4 | 2 | 0 | 100% |
| AC5 | 9 | 6 | 2 | 0 | 1 | 100% |
| AC6 | 6 | 4 | 2 | 0 | 0 | 100% |
| AC7 | 6 | 3 | 2 | 1 | 0 | 100% |

**总体覆盖率**: 100% - 所有 AC 都有测试覆盖

---

### 覆盖缺口

**已识别的缺口**: 无 - 所有 AC 都有充分的测试覆盖

**额外测试**:
- 边界值测试 (6个场景)
- 并发测试 (2个场景)
- 安全测试 (3个场景)
- 性能测试 (2个场景)

---

## 风险覆盖映射

基于 `1.6-risk-20250103.md` 的风险评估:

### 严重风险覆盖

| 风险 ID | 相关测试场景 | 覆盖状态 |
|---------|-------------|----------|
| SEC-001 | 1.6-INT-005, 1.6-INT-006, 1.6-INT-009, 1.6-INT-020 | ✅ 完全覆盖 |
| DATA-001 | 1.6-INT-013, 1.6-INT-014, 1.6-E2E-003, 1.6-E2E-004 | ✅ 完全覆盖 |
| SEC-002 | 1.6-INT-014, 1.6-E2E-003, 1.6-E2E-004 | ✅ 完全覆盖 |

### 高风险覆盖

| 风险 ID | 相关测试场景 | 覆盖状态 |
|---------|-------------|----------|
| SEC-003 | 1.6-UNIT-010, 1.6-UNIT-011, 1.6-INT-008 | ✅ 完全覆盖 |
| DATA-002 | 1.6-INT-010, 1.6-INT-011 | ✅ 完全覆盖 |

### 中风险覆盖

| 风险 ID | 相关测试场景 | 覆盖状态 |
|---------|-------------|----------|
| PERF-001 | 1.6-INT-021 | ⚠️ 部分覆盖 - 需要实际多实例测试 |
| OPS-001 | 1.6-UNIT-016 | ⚠️ 部分覆盖 - 建议使用专业密码强度库 |
| SEC-004 | 1.6-E2E-005, 1.6-INT-026 | ✅ 完全覆盖 |
| OPS-002 | 1.6-INT-024 | ⚠️ 部分覆盖 - 需要更多字符类型测试 |

**风险覆盖率**: 85% - 大部分风险都有对应测试

---

## 测试数据要求

### 测试用户数据

```javascript
// EMAIL 用户
const emailUser = {
  id: 'test-user-1',
  email: 'test@example.com',
  passwordHash: bcrypt.hashSync('Password123', 10),
  name: '测试用户',
  authProvider: 'EMAIL',
  createdAt: new Date('2024-01-01')
}

// Google OAuth 用户
const googleUser = {
  id: 'test-user-2',
  email: 'google@example.com',
  passwordHash: null,
  name: 'Google用户',
  avatarUrl: 'https://example.com/avatar.jpg',
  authProvider: 'GOOGLE',
  createdAt: new Date('2024-06-01')
}

// GitHub OAuth 用户
const githubUser = {
  id: 'test-user-3',
  email: 'github@example.com',
  passwordHash: null,
  name: 'GitHub用户',
  authProvider: 'GITHUB',
  createdAt: new Date('2024-07-01')
}
```

### 使用量测试数据

```javascript
// 低使用率用户
const lowUsage = {
  userId: 'test-user-1',
  documentCount: 5,      // 10% (limit: 50)
  storageUsed: 52428800, // 50MB (limit: 1GB)
  queryCount: 100,       // 10% (limit: 1000)
  queryResetDate: new Date('2025-02-01')
}

// 中使用率用户
const mediumUsage = {
  userId: 'test-user-2',
  documentCount: 30,       // 60%
  storageUsed: 644245094,  // 614MB (limit: 1GB)
  queryCount: 650,         // 65%
  queryResetDate: new Date('2025-02-01')
}

// 高使用率用户
const highUsage = {
  userId: 'test-user-3',
  documentCount: 45,        // 90%
  storageUsed: 966367641,   // 921MB (limit: 1GB)
  queryCount: 950,          // 95%
  queryResetDate: new Date('2025-02-01')
}
```

---

## Mock 和 Stub 策略

### API Mock

**使用场景**: 单元测试前端组件

```typescript
// Mock fetch for API calls
jest.mock('next/navigation', () => ({
  useRouter: () => ({
    push: jest.fn(),
  }),
}))

jest.mock('next-auth/react', () => ({
  useSession: () => ({
    data: { user: { email: 'test@example.com' } },
    status: 'authenticated',
  }),
}))
```

### 数据库 Stub

**使用场景**: 集成测试 API 端点

```typescript
// Use in-memory SQLite for integration tests
const testDb = drizzle(new Database(':memory:'))
```

### NextAuth Mock

**使用场景**: 测试需要认证的端点

```typescript
// Mock auth() function
jest.mock('@/lib/auth', () => ({
  auth: jest.fn().mockResolvedValue({
    user: { email: 'test@example.com' }
  })
}))
```

---

## 测试环境要求

### 单元测试环境

- **框架**: Jest + React Testing Library
- **覆盖率目标**: > 80%
- **Mock 策略**: Mock 所有外部依赖

### 集成测试环境

- **数据库**: In-memory SQLite (或 Docker PostgreSQL)
- **框架**: Jest + Supertest
- **清理策略**: 每个测试后清理数据库

### E2E 测试环境

- **框架**: Playwright 或 Cypress
- **浏览器**: Chrome, Firefox, Safari
- **环境**: Staging environment
- **清理策略**: 使用测试专用账户

---

## 质量指标

### 测试通过标准

**必须满足**:
- 所有 P0 测试通过 (100%)
- P1 测试通过率 > 95%
- P2 测试通过率 > 90%
- P3 测试通过率 > 80%

### 代码覆盖率目标

- **单元测试**: > 80% 代码覆盖
- **集成测试**: > 70% API 端点覆盖
- **E2E 测试**: 100% 关键用户旅程覆盖

### 性能基准

- API 响应时间 < 200ms (p95)
- 页面加载时间 < 2s
- 无内存泄漏

---

## 测试自动化建议

### CI/CD 集成

```yaml
# .github/workflows/test.yml
test-story-1.6:
  runs-on: ubuntu-latest
  steps:
    - name: Run Unit Tests
      run: npm run test:unit -- tests/unit/api/user-settings.test.ts
    
    - name: Run Integration Tests
      run: npm run test:integration -- tests/integration/settings-flow.test.ts
    
    - name: Run E2E Tests
      run: npm run test:e2e -- tests/e2e/settings.test.ts
    
    - name: Upload Coverage
      uses: codecov/codecov-action@v3
```

### 测试执行时间预估

- 单元测试: ~3 分钟 (24个场景)
- 集成测试: ~8 分钟 (18个场景)
- E2E 测试: ~5 分钟 (5个场景)
- **总计**: ~16 分钟

---

## 建议的测试文件结构

```
tests/
├── unit/
│   ├── api/
│   │   ├── user-profile.test.ts
│   │   ├── user-password.test.ts
│   │   ├── user-usage.test.ts
│   │   └── user-account.test.ts
│   └── components/
│       ├── SettingsPage.test.tsx
│       ├── ChangePasswordModal.test.tsx
│       └── DeleteAccountModal.test.tsx
├── integration/
│   ├── settings-profile-flow.test.ts
│   ├── settings-password-flow.test.ts
│   ├── settings-usage-flow.test.ts
│   └── settings-delete-flow.test.ts
└── e2e/
    └── settings-complete-flow.test.ts
```

---

## 关键测试原则

1. **左移测试**: 单元测试优先,尽早发现问题
2. **风险驱动**: 高风险区域(安全、数据)优先测试
3. **独立性**: 每个测试独立运行,不依赖其他测试
4. **可重复性**: 测试结果一致,不受环境影响
5. **清晰断言**: 每个测试只验证一个行为
6. **快速反馈**: 单元测试秒级反馈,集成测试分钟级

---

## 后续行动

### 立即执行

1. **创建测试文件结构**
2. **准备测试数据和 Mock**
3. **实现 P0 测试场景**
4. **配置 CI/CD 自动化**

### 测试执行后

1. **收集覆盖率报告**
2. **分析失败测试**
3. **更新风险评估**
4. **生成质量报告**

---

**测试设计完成**: 47个测试场景已设计完成,覆盖所有验收标准和主要风险。建议按优先级顺序执行测试,确保所有 P0 测试通过后再考虑发布。

