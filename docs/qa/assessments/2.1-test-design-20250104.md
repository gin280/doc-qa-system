# Test Design: Story 2.1

**Story**: 2.1 - 文档上传UI与文件处理  
**Date**: 2025-01-04  
**Designer**: Quinn (Test Architect)  
**Epic**: 2 - 文档管理与解析

---

## Test Strategy Overview

- **Total test scenarios**: 42
- **Unit tests**: 18 (43%)
- **Integration tests**: 16 (38%)
- **E2E tests**: 8 (19%)
- **Priority distribution**: P0: 22, P1: 15, P2: 5

### Coverage Summary

| Acceptance Criteria | Unit | Integration | E2E | Total |
|---------------------|------|-------------|-----|-------|
| AC1: 拖拽上传功能 | 2 | 2 | 2 | 6 |
| AC2: 点击上传功能 | 1 | 2 | 1 | 4 |
| AC3: 文件格式验证 | 4 | 3 | 2 | 9 |
| AC4: 实时上传进度显示 | 3 | 2 | 1 | 6 |
| AC5: 批量上传处理 | 2 | 2 | 1 | 5 |
| AC6: 错误处理与重试 | 3 | 2 | 0 | 5 |
| AC7: 用户配额检查 | 2 | 2 | 1 | 5 |
| AC8: UI/UX体验 | 1 | 1 | 0 | 2 |

---

## Test Scenarios by Acceptance Criteria

### AC1: 拖拽上传功能

**Requirement**: 用户可以拖拽文件到上传区域进行上传

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-001 | Unit | P1 | 测试 `useDropzone` hook 配置正确 | 验证配置逻辑 | - |
| 2.1-UNIT-002 | Unit | P2 | 测试拖拽状态变化逻辑 | 纯状态管理逻辑 | - |
| 2.1-INT-001 | Integration | P0 | 测试拖拽文件后正确添加到队列 | 组件交互 | TECH-002 |
| 2.1-INT-002 | Integration | P1 | 测试拖拽多个文件（≤10个） | 批量处理流程 | PERF-002 |
| 2.1-E2E-001 | E2E | P0 | 用户拖拽PDF文件完整流程 | 关键用户路径 | - |
| 2.1-E2E-002 | E2E | P1 | 用户拖拽被拒绝文件显示反馈 | 错误处理路径 | - |

**Test Details**:

```typescript
// 2.1-UNIT-001: useDropzone 配置
test('dropzone accepts correct file types', () => {
  const { result } = renderHook(() => useDropzone({
    accept: {
      'application/pdf': ['.pdf'],
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
      // ...
    },
    maxSize: 50 * 1024 * 1024,
    maxFiles: 10
  }))
  
  expect(result.current.acceptedFiles).toBeDefined()
})

// 2.1-INT-001: 拖拽添加到队列
test('files added to upload queue on drop', () => {
  render(<FileDropzone onFilesSelected={mockHandler} />)
  
  const file = new File(['content'], 'test.pdf', { type: 'application/pdf' })
  const dropzone = screen.getByRole('button')
  
  fireEvent.drop(dropzone, {
    dataTransfer: { files: [file] }
  })
  
  expect(mockHandler).toHaveBeenCalledWith([file])
})

// 2.1-E2E-001: 完整拖拽流程
test('user can drag and drop PDF file', async ({ page }) => {
  await page.goto('/dashboard/documents')
  
  const fileInput = await page.locator('input[type="file"]')
  await fileInput.setInputFiles('tests/fixtures/sample.pdf')
  
  await expect(page.locator('[data-testid="upload-progress"]')).toBeVisible()
  await expect(page.locator('text=上传完成')).toBeVisible({ timeout: 30000 })
})
```

---

### AC2: 点击上传功能

**Requirement**: 用户可以点击按钮选择文件上传

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-003 | Unit | P2 | 测试文件选择器 accept 属性 | 配置验证 | TECH-002 |
| 2.1-INT-003 | Integration | P0 | 测试点击触发文件选择对话框 | 用户交互 | - |
| 2.1-INT-004 | Integration | P1 | 测试选择文件后添加到队列 | 组件集成 | - |
| 2.1-E2E-003 | E2E | P0 | 用户点击上传完整流程 | 核心用户路径 | - |

**Test Details**:

```typescript
// 2.1-INT-003: 点击触发文件选择
test('clicking upload button opens file dialog', () => {
  render(<DocumentUploadModal />)
  
  const uploadButton = screen.getByText('上传文档')
  const fileInput = document.querySelector('input[type="file"]')
  
  const clickSpy = jest.spyOn(fileInput, 'click')
  fireEvent.click(uploadButton)
  
  expect(clickSpy).toHaveBeenCalled()
})

// 2.1-E2E-003: 完整点击上传流程
test('user can upload via click', async ({ page }) => {
  await page.goto('/dashboard/documents')
  await page.click('button:has-text("上传文档")')
  
  const fileChooserPromise = page.waitForEvent('filechooser')
  await page.click('[data-testid="upload-button"]')
  const fileChooser = await fileChooserPromise
  
  await fileChooser.setFiles('tests/fixtures/sample.pdf')
  await expect(page.locator('text=上传完成')).toBeVisible({ timeout: 30000 })
})
```

---

### AC3: 文件格式验证

**Requirement**: 系统验证文件格式和大小，拒绝不符合要求的文件

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-004 | Unit | P0 | 测试 `validateFileType` 正确识别允许的格式 | 核心验证逻辑 | SEC-001 |
| 2.1-UNIT-005 | Unit | P0 | 测试 `validateFileSize` 正确限制50MB | 核心验证逻辑 | - |
| 2.1-UNIT-006 | Unit | P0 | 测试文件名清理函数 | 安全防护 | SEC-001 |
| 2.1-UNIT-007 | Unit | P0 | 测试 Magic Bytes 验证 | 安全关键逻辑 | SEC-001 |
| 2.1-INT-005 | Integration | P0 | 测试上传不支持格式返回400错误 | API 验证 | SEC-001 |
| 2.1-INT-006 | Integration | P0 | 测试上传超大文件返回400错误 | API 限制 | PERF-001 |
| 2.1-INT-007 | Integration | P0 | 测试伪造MIME类型文件被拒绝 | 安全防护 | SEC-001 |
| 2.1-E2E-004 | E2E | P0 | 用户上传不支持格式显示错误Toast | 错误反馈 | SEC-001 |
| 2.1-E2E-005 | E2E | P1 | 用户上传超大文件显示错误Toast | 用户体验 | - |

**Test Details**:

```typescript
// 2.1-UNIT-004: 文件类型验证
describe('validateFileType', () => {
  test('accepts PDF files', () => {
    const file = new File(['content'], 'test.pdf', { type: 'application/pdf' })
    expect(validateFileType(file)).toBe(true)
  })
  
  test('rejects EXE files', () => {
    const file = new File(['content'], 'malware.exe', { type: 'application/x-msdownload' })
    expect(validateFileType(file)).toBe(false)
  })
  
  test('rejects files with fake PDF extension', () => {
    const file = new File(['MZ\x90\x00'], 'fake.pdf', { type: 'application/pdf' })
    expect(validateFileType(file)).toBe(false)
  })
})

// 2.1-UNIT-007: Magic Bytes 验证 (CRITICAL - SEC-001)
describe('validateFileMagicBytes', () => {
  test('validates real PDF signature', async () => {
    const pdfBuffer = Buffer.from('%PDF-1.4', 'utf-8')
    const file = new File([pdfBuffer], 'test.pdf', { type: 'application/pdf' })
    
    const result = await validateFileMagicBytes(file)
    expect(result).toBe(true)
  })
  
  test('rejects EXE with PDF extension', async () => {
    const exeBuffer = Buffer.from('MZ\x90\x00\x03', 'binary')
    const file = new File([exeBuffer], 'malware.pdf', { type: 'application/pdf' })
    
    const result = await validateFileMagicBytes(file)
    expect(result).toBe(false)
  })
  
  test('rejects polyglot files', async () => {
    // 同时满足 PDF 和 JS 签名的文件
    const polyglot = await readFile('tests/fixtures/polyglot.pdf-js')
    const result = await validateFileMagicBytes(polyglot)
    expect(result).toBe(false)
  })
})

// 2.1-INT-007: 伪造 MIME 类型测试 (CRITICAL - SEC-001)
test('API rejects file with fake MIME type', async () => {
  const exeContent = Buffer.from('MZ\x90\x00', 'binary')
  const formData = new FormData()
  formData.append('file', new Blob([exeContent], { type: 'application/pdf' }), 'malware.pdf')
  
  const response = await fetch('/api/documents/upload', {
    method: 'POST',
    body: formData,
    headers: { 'Cookie': authCookie }
  })
  
  expect(response.status).toBe(400)
  const data = await response.json()
  expect(data.error).toContain('File signature validation failed')
})

// 2.1-E2E-004: 错误提示
test('shows error toast for unsupported file type', async ({ page }) => {
  await page.goto('/dashboard/documents')
  await page.setInputFiles('input[type="file"]', 'tests/fixtures/test.exe')
  
  await expect(page.locator('text=不支持的文件格式')).toBeVisible()
})
```

---

### AC4: 实时上传进度显示

**Requirement**: 显示每个文件的上传进度条和状态

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-008 | Unit | P1 | 测试进度百分比计算逻辑 | 纯计算逻辑 | - |
| 2.1-UNIT-009 | Unit | P1 | 测试文件大小格式化函数 | 显示逻辑 | - |
| 2.1-UNIT-010 | Unit | P2 | 测试剩余时间估算算法 | 辅助功能 | - |
| 2.1-INT-008 | Integration | P0 | 测试 XHR progress 事件正确更新状态 | 核心功能 | TECH-001 |
| 2.1-INT-009 | Integration | P1 | 测试多个文件独立进度显示 | 并发处理 | - |
| 2.1-E2E-006 | E2E | P1 | 用户看到进度条从0%到100% | 用户体验 | - |

**Test Details**:

```typescript
// 2.1-UNIT-008: 进度计算
test('calculates upload progress correctly', () => {
  const loaded = 5 * 1024 * 1024  // 5MB
  const total = 10 * 1024 * 1024   // 10MB
  
  const progress = calculateProgress(loaded, total)
  expect(progress).toBe(50)
})

// 2.1-INT-008: XHR 进度更新 (CRITICAL)
test('XHR progress event updates upload progress', async () => {
  const { result } = renderHook(() => useDocumentUpload())
  
  const file = new File(['x'.repeat(1024 * 1024)], 'test.pdf')
  
  act(() => {
    result.current.addFiles([file])
  })
  
  // 等待进度更新
  await waitFor(() => {
    const item = result.current.items[0]
    expect(item.progress).toBeGreaterThan(0)
    expect(item.status).toBe('uploading')
  })
  
  await waitFor(() => {
    const item = result.current.items[0]
    expect(item.progress).toBe(100)
    expect(item.status).toBe('success')
  }, { timeout: 10000 })
})

// 2.1-E2E-006: 进度可见性
test('user sees upload progress bar', async ({ page }) => {
  await page.goto('/dashboard/documents')
  await page.setInputFiles('input[type="file"]', 'tests/fixtures/large.pdf')
  
  const progressBar = page.locator('[role="progressbar"]')
  await expect(progressBar).toBeVisible()
  
  // 等待进度变化
  await expect(progressBar).toHaveAttribute('aria-valuenow', /[1-9]\d*/)
  
  await expect(page.locator('text=100%')).toBeVisible({ timeout: 30000 })
})
```

---

### AC5: 批量上传处理

**Requirement**: 支持批量上传，最多同时上传3个文件

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-011 | Unit | P0 | 测试并发控制逻辑（最多3个） | 核心限制逻辑 | PERF-002 |
| 2.1-UNIT-012 | Unit | P1 | 测试总体进度计算（3/5完成） | 显示逻辑 | - |
| 2.1-INT-010 | Integration | P0 | 测试同时上传10个文件，只有3个并发 | 并发控制 | PERF-002 |
| 2.1-INT-011 | Integration | P1 | 测试批量完成后显示汇总Toast | 用户反馈 | PERF-003 |
| 2.1-E2E-007 | E2E | P1 | 用户批量上传5个文件看到进度 | 完整流程 | - |

**Test Details**:

```typescript
// 2.1-UNIT-011: 并发控制 (CRITICAL)
test('limits concurrent uploads to 3', async () => {
  const { result } = renderHook(() => useDocumentUpload())
  
  const files = Array.from({ length: 10 }, (_, i) =>
    new File(['content'], `file${i}.pdf`, { type: 'application/pdf' })
  )
  
  act(() => {
    result.current.addFiles(files)
  })
  
  // 检查同时上传的文件数
  await waitFor(() => {
    const uploading = result.current.items.filter(i => i.status === 'uploading')
    expect(uploading.length).toBeLessThanOrEqual(3)
  })
})

// 2.1-INT-010: 批量上传并发
test('processes 10 files with max 3 concurrent', async () => {
  const mockFetch = jest.fn().mockImplementation(() => 
    new Promise(resolve => setTimeout(() => resolve({ ok: true }), 1000))
  )
  global.fetch = mockFetch
  
  const files = Array.from({ length: 10 }, (_, i) =>
    new File(['content'], `file${i}.pdf`)
  )
  
  const { result } = renderHook(() => useDocumentUpload())
  
  act(() => {
    result.current.addFiles(files)
  })
  
  // 第一批3个立即开始
  await waitFor(() => {
    expect(mockFetch).toHaveBeenCalledTimes(3)
  })
  
  // 等待全部完成
  await waitFor(() => {
    expect(mockFetch).toHaveBeenCalledTimes(10)
    expect(result.current.items.every(i => i.status === 'success')).toBe(true)
  }, { timeout: 15000 })
})
```

---

### AC6: 错误处理与重试

**Requirement**: 上传失败时显示错误并支持重试

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-013 | Unit | P1 | 测试网络错误识别逻辑 | 错误分类 | - |
| 2.1-UNIT-014 | Unit | P1 | 测试服务器错误识别逻辑 | 错误分类 | - |
| 2.1-UNIT-015 | Unit | P1 | 测试重试逻辑重置状态 | 状态管理 | - |
| 2.1-INT-012 | Integration | P0 | 测试网络错误后可以重试 | 用户恢复路径 | - |
| 2.1-INT-013 | Integration | P1 | 测试取消上传中的文件 | 用户控制 | - |

**Test Details**:

```typescript
// 2.1-UNIT-013: 网络错误识别
test('identifies network errors', () => {
  const error = new TypeError('Failed to fetch')
  expect(isNetworkError(error)).toBe(true)
  
  const serverError = new Error('500 Internal Server Error')
  expect(isNetworkError(serverError)).toBe(false)
})

// 2.1-INT-012: 重试功能
test('can retry failed upload', async () => {
  let attemptCount = 0
  const mockFetch = jest.fn().mockImplementation(() => {
    attemptCount++
    if (attemptCount === 1) {
      return Promise.reject(new Error('Network error'))
    }
    return Promise.resolve({ ok: true, json: () => ({ success: true }) })
  })
  global.fetch = mockFetch
  
  const { result } = renderHook(() => useDocumentUpload())
  const file = new File(['content'], 'test.pdf')
  
  act(() => {
    result.current.addFiles([file])
  })
  
  // 等待失败
  await waitFor(() => {
    expect(result.current.items[0].status).toBe('error')
  })
  
  // 重试
  act(() => {
    result.current.retryUpload(result.current.items[0].id)
  })
  
  // 等待成功
  await waitFor(() => {
    expect(result.current.items[0].status).toBe('success')
  })
})
```

---

### AC7: 用户配额检查

**Requirement**: 检查用户文档数量和存储空间配额

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-016 | Unit | P0 | 测试配额计算逻辑 | 核心业务逻辑 | DATA-001 |
| 2.1-UNIT-017 | Unit | P0 | 测试原子更新条件构建 | 防竞态条件 | DATA-001 |
| 2.1-INT-014 | Integration | P0 | 测试文档数量达到限制时拒绝上传 | 配额强制执行 | DATA-001 |
| 2.1-INT-015 | Integration | P0 | 测试并发上传不会绕过配额 | 竞态条件防护 | DATA-001 |
| 2.1-E2E-008 | E2E | P0 | 用户配额用尽显示明确错误 | 用户反馈 | - |

**Test Details**:

```typescript
// 2.1-UNIT-016: 配额计算
test('calculates quota correctly', () => {
  const usage = { documentCount: 45, storageUsed: 400 * 1024 * 1024 }
  const file = { size: 50 * 1024 * 1024 }
  
  expect(canUpload(usage, file, { maxDocs: 50, maxStorage: 500 * 1024 * 1024 })).toBe(true)
  
  const tooBig = { size: 150 * 1024 * 1024 }
  expect(canUpload(usage, tooBig, { maxDocs: 50, maxStorage: 500 * 1024 * 1024 })).toBe(false)
})

// 2.1-INT-015: 并发配额测试 (CRITICAL - DATA-001)
test('prevents quota bypass via concurrent uploads', async () => {
  // 设置用户配额为49
  await db.update(userUsage)
    .set({ documentCount: 49 })
    .where(eq(userUsage.userId, testUserId))
  
  // 同时发起10个上传请求
  const files = Array.from({ length: 10 }, (_, i) =>
    new File(['content'], `file${i}.pdf`)
  )
  
  const uploadPromises = files.map(file => {
    const formData = new FormData()
    formData.append('file', file)
    return fetch('/api/documents/upload', {
      method: 'POST',
      body: formData,
      headers: { 'Cookie': authCookie }
    })
  })
  
  const responses = await Promise.all(uploadPromises)
  
  // 只有1个应该成功
  const succeeded = responses.filter(r => r.ok)
  expect(succeeded.length).toBe(1)
  
  // 验证最终配额
  const [finalUsage] = await db.select()
    .from(userUsage)
    .where(eq(userUsage.userId, testUserId))
  
  expect(finalUsage.documentCount).toBe(50)  // 49 + 1，不是49 + 10
})

// 2.1-E2E-008: 配额错误提示
test('shows quota error when limit reached', async ({ page }) => {
  // 设置用户已达配额限制
  await setUserQuota(testUser.id, { documentCount: 50, storageUsed: 0 })
  
  await page.goto('/dashboard/documents')
  await page.setInputFiles('input[type="file"]', 'tests/fixtures/test.pdf')
  
  await expect(page.locator('text=文档数量已达上限')).toBeVisible()
  await expect(page.locator('text=50个')).toBeVisible()
})
```

---

### AC8: UI/UX体验

**Requirement**: 美观、流畅的界面体验和暗色模式支持

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-018 | Unit | P2 | 测试主题类名正确应用 | 样式一致性 | - |
| 2.1-INT-016 | Integration | P2 | 测试暗色模式下颜色对比度 | 可访问性 | - |

**Test Details**:

```typescript
// 2.1-UNIT-018: 主题系统
test('uses theme system color classes', () => {
  render(<FileDropzone onFilesSelected={jest.fn()} />)
  
  const dropzone = screen.getByRole('button')
  expect(dropzone).toHaveClass(/border-muted-foreground/)
  expect(dropzone).not.toHaveClass(/border-gray-400/)  // 禁止硬编码颜色
})

// 2.1-INT-016: 暗色模式对比度
test('maintains contrast in dark mode', () => {
  document.documentElement.classList.add('dark')
  
  render(<UploadProgressList items={mockItems} {...mockHandlers} />)
  
  const text = screen.getByText('test.pdf')
  const styles = window.getComputedStyle(text)
  const contrast = calculateContrast(styles.color, styles.backgroundColor)
  
  expect(contrast).toBeGreaterThanOrEqual(4.5)  // WCAG AA
})
```

---

## Risk Coverage Matrix

将测试场景映射到已识别的风险:

| Risk ID | Score | Test IDs | Coverage |
|---------|-------|----------|----------|
| **SEC-001** | 9 | 2.1-UNIT-004, 2.1-UNIT-006, 2.1-UNIT-007, 2.1-INT-005, 2.1-INT-007, 2.1-E2E-004 | ✅ Full |
| **DATA-001** | 9 | 2.1-UNIT-016, 2.1-UNIT-017, 2.1-INT-014, 2.1-INT-015, 2.1-E2E-008 | ✅ Full |
| **PERF-001** | 6 | 2.1-INT-006, 2.1-E2E-005 | 🟡 Partial (需要负载测试) |
| **PERF-002** | 6 | 2.1-UNIT-011, 2.1-INT-010 | ✅ Full |
| **TECH-001** | 6 | 2.1-INT-008 | 🟡 Partial (需要多浏览器测试) |
| **DATA-002** | 4 | 2.1-INT-014 | 🟡 Partial (Story 2.2) |
| **PERF-003** | 4 | 2.1-INT-011 | ✅ Full |
| **TECH-002** | 4 | 2.1-INT-001 | ✅ Full |

**未完全覆盖的风险**:
- ⚠️ **PERF-001**: 需要添加内存使用监控测试
- ⚠️ **TECH-001**: 需要在 Safari、Firefox、Mobile Chrome 上执行 E2E 测试

---

## Recommended Execution Order

### Phase 1: Fail Fast (P0 Unit Tests)
**时间**: ~30分钟  
**目标**: 快速发现核心逻辑错误

```bash
# 安全关键测试 (SEC-001, DATA-001)
npm test -- 2.1-UNIT-004  # validateFileType
npm test -- 2.1-UNIT-005  # validateFileSize
npm test -- 2.1-UNIT-006  # sanitizeFilename
npm test -- 2.1-UNIT-007  # validateFileMagicBytes (CRITICAL)
npm test -- 2.1-UNIT-016  # 配额计算
npm test -- 2.1-UNIT-017  # 原子更新

# 核心业务逻辑
npm test -- 2.1-UNIT-011  # 并发控制
```

### Phase 2: Integration Tests (P0)
**时间**: ~1小时  
**目标**: 验证组件交互和 API 行为

```bash
# 安全测试
npm test -- 2.1-INT-005   # 格式验证
npm test -- 2.1-INT-006   # 大小限制
npm test -- 2.1-INT-007   # 伪造 MIME 类型 (CRITICAL)

# 配额测试
npm test -- 2.1-INT-014   # 配额限制
npm test -- 2.1-INT-015   # 并发配额 (CRITICAL)

# 核心功能
npm test -- 2.1-INT-001   # 拖拽上传
npm test -- 2.1-INT-003   # 点击上传
npm test -- 2.1-INT-008   # 进度更新
npm test -- 2.1-INT-010   # 批量上传
```

### Phase 3: E2E Tests (P0)
**时间**: ~30分钟  
**目标**: 验证关键用户路径

```bash
npm run test:e2e -- 2.1-E2E-001  # 拖拽上传完整流程
npm run test:e2e -- 2.1-E2E-003  # 点击上传完整流程
npm run test:e2e -- 2.1-E2E-004  # 错误提示
npm run test:e2e -- 2.1-E2E-008  # 配额错误
```

### Phase 4: P1 Tests
**时间**: ~1.5小时  
**目标**: 完整功能覆盖

```bash
# Unit Tests (P1)
npm test -- tests/unit/useDocumentUpload.test.ts

# Integration Tests (P1)
npm test -- tests/integration/upload-api.test.ts

# E2E Tests (P1)
npm run test:e2e -- tests/e2e/document-upload.spec.ts
```

### Phase 5: Cross-Browser & Performance
**时间**: ~1小时  
**目标**: 兼容性和性能验证

```bash
# 多浏览器 E2E
npm run test:e2e -- --project=chromium
npm run test:e2e -- --project=firefox
npm run test:e2e -- --project=webkit

# 性能测试
npm run test:perf -- upload-performance.test.ts
```

---

## Test Data Requirements

### 测试文件准备

```
tests/
├── fixtures/
│   ├── sample.pdf                 # 正常 PDF (5MB)
│   ├── large.pdf                  # 大文件 (45MB)
│   ├── oversized.pdf              # 超大文件 (51MB)
│   ├── sample.docx                # Word 文档
│   ├── sample.md                  # Markdown
│   ├── sample.txt                 # 纯文本
│   ├── malware.exe                # 恶意文件
│   ├── fake.pdf                   # 伪造扩展名 (exe改名)
│   ├── polyglot.pdf-js            # Polyglot 文件
│   ├── corrupted.pdf              # 损坏的 PDF
│   └── empty.pdf                  # 空文件
```

### 用户测试数据

```typescript
const testUsers = {
  normalUser: {
    id: 'user_normal',
    email: 'normal@test.com',
    quota: { documentCount: 10, storageUsed: 100 * 1024 * 1024 }
  },
  nearLimitUser: {
    id: 'user_near_limit',
    email: 'nearlimit@test.com',
    quota: { documentCount: 49, storageUsed: 480 * 1024 * 1024 }
  },
  atLimitUser: {
    id: 'user_at_limit',
    email: 'atlimit@test.com',
    quota: { documentCount: 50, storageUsed: 500 * 1024 * 1024 }
  }
}
```

---

## Test Environment Setup

### 单元测试环境

```typescript
// jest.setup.js
import '@testing-library/jest-dom'
import { TextEncoder, TextDecoder } from 'util'

global.TextEncoder = TextEncoder
global.TextDecoder = TextDecoder

// Mock XMLHttpRequest 进度
class MockXMLHttpRequest {
  upload = {
    addEventListener: jest.fn(),
    removeEventListener: jest.fn()
  }
  addEventListener = jest.fn()
  open = jest.fn()
  send = jest.fn()
  setRequestHeader = jest.fn()
}

global.XMLHttpRequest = MockXMLHttpRequest as any
```

### 集成测试环境

```typescript
// tests/setup/test-db.ts
import { beforeAll, afterAll, beforeEach } from 'vitest'
import { db } from '@/lib/db'

beforeAll(async () => {
  // 使用测试数据库
  process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/docqa_test'
})

beforeEach(async () => {
  // 清空测试数据
  await db.delete(documents)
  await db.delete(userUsage)
})

afterAll(async () => {
  // 关闭连接
  await db.$client.end()
})
```

### E2E 测试环境

```typescript
// playwright.config.ts
export default defineConfig({
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'webkit', use: { ...devices['Desktop Safari'] } },
    { name: 'mobile-chrome', use: { ...devices['Pixel 5'] } },
  ],
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    video: 'retain-on-failure'
  }
})
```

---

## Coverage Goals

### 代码覆盖率目标

| Component | Line Coverage | Branch Coverage | Function Coverage |
|-----------|---------------|-----------------|-------------------|
| `useDocumentUpload.ts` | ≥ 90% | ≥ 85% | ≥ 90% |
| `FileDropzone.tsx` | ≥ 80% | ≥ 75% | ≥ 80% |
| `lib/validators.ts` | ≥ 95% | ≥ 90% | ≥ 95% |
| `/api/documents/upload` | ≥ 85% | ≥ 80% | ≥ 85% |
| **Overall** | **≥ 85%** | **≥ 80%** | **≥ 85%** |

### AC 覆盖率验证

```bash
# 生成覆盖率报告
npm test -- --coverage

# 验证每个 AC 至少有一个测试
npm run test:coverage-check
```

**覆盖率不达标时的行动**:
- < 80%: 警告，识别未覆盖的分支
- < 70%: 阻止合并，必须添加测试
- < 60%: 严重，需要测试策略审查

---

## Quality Checklist

在测试执行前验证:

- [x] 每个 AC 都有至少一个测试场景
- [x] 所有 P0 风险都有对应测试覆盖
- [x] 测试级别分配合理（不过度测试）
- [x] 没有重复的测试覆盖
- [x] 测试 ID 遵循命名约定 `{epic}.{story}-{LEVEL}-{SEQ}`
- [x] 每个测试场景都是原子和独立的
- [x] 关键路径有多层测试（Unit + Integration + E2E）
- [x] 测试数据和夹具已准备
- [x] 测试环境配置已定义

---

## Test Maintenance Strategy

### 测试更新触发条件

1. **AC 变更**: 更新相关测试场景
2. **API 变更**: 更新集成测试
3. **UI 组件变更**: 更新 E2E 选择器
4. **依赖升级**: 验证兼容性测试

### 失败测试处理

```bash
# 失败测试分类
- Flaky (不稳定): 添加重试或等待逻辑
- Broken (代码破坏): 修复代码或更新测试
- Outdated (过时): 更新测试匹配新需求
```

### 测试性能监控

```typescript
// 测试执行时间基准
const benchmarks = {
  'unit-tests': 30 * 1000,        // 30秒
  'integration-tests': 60 * 1000, // 1分钟
  'e2e-tests': 180 * 1000         // 3分钟
}

// 超时告警
if (testDuration > benchmark) {
  console.warn(`Tests slower than baseline: ${testDuration}ms > ${benchmark}ms`)
}
```

---

## Conclusion

本测试设计为 Story 2.1 提供了 **42 个全面的测试场景**，覆盖所有 8 个验收标准和 14 个已识别的风险。

### 关键测试要求

**必须执行 (P0)**:
1. ✅ SEC-001 缓解验证（Magic Bytes、文件名清理）
2. ✅ DATA-001 缓解验证（并发配额测试）
3. ✅ 核心功能测试（拖拽、点击、进度、批量）

**推荐执行 (P1)**:
4. 🟡 完整功能覆盖
5. 🟡 错误处理和重试
6. 🟡 多浏览器兼容性

**可选执行 (P2)**:
7. ⚪ UI/UX 细节测试
8. ⚪ 性能基准测试

**总执行时间估算**: 4-5小时（完整套件）  
**最小可行测试**: 2小时（P0 only）

---

**Test Design Status**: ✅ Complete  
**Ready for Implementation**: Yes  
**Next Step**: 开发团队实施测试，QA 执行验证

