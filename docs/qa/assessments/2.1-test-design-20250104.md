# Test Design: Story 2.1

**Story**: 2.1 - æ–‡æ¡£ä¸Šä¼ UIä¸æ–‡ä»¶å¤„ç†  
**Date**: 2025-01-04  
**Designer**: Quinn (Test Architect)  
**Epic**: 2 - æ–‡æ¡£ç®¡ç†ä¸è§£æ

---

## Test Strategy Overview

- **Total test scenarios**: 42
- **Unit tests**: 18 (43%)
- **Integration tests**: 16 (38%)
- **E2E tests**: 8 (19%)
- **Priority distribution**: P0: 22, P1: 15, P2: 5

### Coverage Summary

| Acceptance Criteria | Unit | Integration | E2E | Total |
|---------------------|------|-------------|-----|-------|
| AC1: æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½ | 2 | 2 | 2 | 6 |
| AC2: ç‚¹å‡»ä¸Šä¼ åŠŸèƒ½ | 1 | 2 | 1 | 4 |
| AC3: æ–‡ä»¶æ ¼å¼éªŒè¯ | 4 | 3 | 2 | 9 |
| AC4: å®æ—¶ä¸Šä¼ è¿›åº¦æ˜¾ç¤º | 3 | 2 | 1 | 6 |
| AC5: æ‰¹é‡ä¸Šä¼ å¤„ç† | 2 | 2 | 1 | 5 |
| AC6: é”™è¯¯å¤„ç†ä¸é‡è¯• | 3 | 2 | 0 | 5 |
| AC7: ç”¨æˆ·é…é¢æ£€æŸ¥ | 2 | 2 | 1 | 5 |
| AC8: UI/UXä½“éªŒ | 1 | 1 | 0 | 2 |

---

## Test Scenarios by Acceptance Criteria

### AC1: æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½

**Requirement**: ç”¨æˆ·å¯ä»¥æ‹–æ‹½æ–‡ä»¶åˆ°ä¸Šä¼ åŒºåŸŸè¿›è¡Œä¸Šä¼ 

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-001 | Unit | P1 | æµ‹è¯• `useDropzone` hook é…ç½®æ­£ç¡® | éªŒè¯é…ç½®é€»è¾‘ | - |
| 2.1-UNIT-002 | Unit | P2 | æµ‹è¯•æ‹–æ‹½çŠ¶æ€å˜åŒ–é€»è¾‘ | çº¯çŠ¶æ€ç®¡ç†é€»è¾‘ | - |
| 2.1-INT-001 | Integration | P0 | æµ‹è¯•æ‹–æ‹½æ–‡ä»¶åæ­£ç¡®æ·»åŠ åˆ°é˜Ÿåˆ— | ç»„ä»¶äº¤äº’ | TECH-002 |
| 2.1-INT-002 | Integration | P1 | æµ‹è¯•æ‹–æ‹½å¤šä¸ªæ–‡ä»¶ï¼ˆâ‰¤10ä¸ªï¼‰ | æ‰¹é‡å¤„ç†æµç¨‹ | PERF-002 |
| 2.1-E2E-001 | E2E | P0 | ç”¨æˆ·æ‹–æ‹½PDFæ–‡ä»¶å®Œæ•´æµç¨‹ | å…³é”®ç”¨æˆ·è·¯å¾„ | - |
| 2.1-E2E-002 | E2E | P1 | ç”¨æˆ·æ‹–æ‹½è¢«æ‹’ç»æ–‡ä»¶æ˜¾ç¤ºåé¦ˆ | é”™è¯¯å¤„ç†è·¯å¾„ | - |

**Test Details**:

```typescript
// 2.1-UNIT-001: useDropzone é…ç½®
test('dropzone accepts correct file types', () => {
  const { result } = renderHook(() => useDropzone({
    accept: {
      'application/pdf': ['.pdf'],
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
      // ...
    },
    maxSize: 50 * 1024 * 1024,
    maxFiles: 10
  }))
  
  expect(result.current.acceptedFiles).toBeDefined()
})

// 2.1-INT-001: æ‹–æ‹½æ·»åŠ åˆ°é˜Ÿåˆ—
test('files added to upload queue on drop', () => {
  render(<FileDropzone onFilesSelected={mockHandler} />)
  
  const file = new File(['content'], 'test.pdf', { type: 'application/pdf' })
  const dropzone = screen.getByRole('button')
  
  fireEvent.drop(dropzone, {
    dataTransfer: { files: [file] }
  })
  
  expect(mockHandler).toHaveBeenCalledWith([file])
})

// 2.1-E2E-001: å®Œæ•´æ‹–æ‹½æµç¨‹
test('user can drag and drop PDF file', async ({ page }) => {
  await page.goto('/dashboard/documents')
  
  const fileInput = await page.locator('input[type="file"]')
  await fileInput.setInputFiles('tests/fixtures/sample.pdf')
  
  await expect(page.locator('[data-testid="upload-progress"]')).toBeVisible()
  await expect(page.locator('text=ä¸Šä¼ å®Œæˆ')).toBeVisible({ timeout: 30000 })
})
```

---

### AC2: ç‚¹å‡»ä¸Šä¼ åŠŸèƒ½

**Requirement**: ç”¨æˆ·å¯ä»¥ç‚¹å‡»æŒ‰é’®é€‰æ‹©æ–‡ä»¶ä¸Šä¼ 

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-003 | Unit | P2 | æµ‹è¯•æ–‡ä»¶é€‰æ‹©å™¨ accept å±æ€§ | é…ç½®éªŒè¯ | TECH-002 |
| 2.1-INT-003 | Integration | P0 | æµ‹è¯•ç‚¹å‡»è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡† | ç”¨æˆ·äº¤äº’ | - |
| 2.1-INT-004 | Integration | P1 | æµ‹è¯•é€‰æ‹©æ–‡ä»¶åæ·»åŠ åˆ°é˜Ÿåˆ— | ç»„ä»¶é›†æˆ | - |
| 2.1-E2E-003 | E2E | P0 | ç”¨æˆ·ç‚¹å‡»ä¸Šä¼ å®Œæ•´æµç¨‹ | æ ¸å¿ƒç”¨æˆ·è·¯å¾„ | - |

**Test Details**:

```typescript
// 2.1-INT-003: ç‚¹å‡»è§¦å‘æ–‡ä»¶é€‰æ‹©
test('clicking upload button opens file dialog', () => {
  render(<DocumentUploadModal />)
  
  const uploadButton = screen.getByText('ä¸Šä¼ æ–‡æ¡£')
  const fileInput = document.querySelector('input[type="file"]')
  
  const clickSpy = jest.spyOn(fileInput, 'click')
  fireEvent.click(uploadButton)
  
  expect(clickSpy).toHaveBeenCalled()
})

// 2.1-E2E-003: å®Œæ•´ç‚¹å‡»ä¸Šä¼ æµç¨‹
test('user can upload via click', async ({ page }) => {
  await page.goto('/dashboard/documents')
  await page.click('button:has-text("ä¸Šä¼ æ–‡æ¡£")')
  
  const fileChooserPromise = page.waitForEvent('filechooser')
  await page.click('[data-testid="upload-button"]')
  const fileChooser = await fileChooserPromise
  
  await fileChooser.setFiles('tests/fixtures/sample.pdf')
  await expect(page.locator('text=ä¸Šä¼ å®Œæˆ')).toBeVisible({ timeout: 30000 })
})
```

---

### AC3: æ–‡ä»¶æ ¼å¼éªŒè¯

**Requirement**: ç³»ç»ŸéªŒè¯æ–‡ä»¶æ ¼å¼å’Œå¤§å°ï¼Œæ‹’ç»ä¸ç¬¦åˆè¦æ±‚çš„æ–‡ä»¶

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-004 | Unit | P0 | æµ‹è¯• `validateFileType` æ­£ç¡®è¯†åˆ«å…è®¸çš„æ ¼å¼ | æ ¸å¿ƒéªŒè¯é€»è¾‘ | SEC-001 |
| 2.1-UNIT-005 | Unit | P0 | æµ‹è¯• `validateFileSize` æ­£ç¡®é™åˆ¶50MB | æ ¸å¿ƒéªŒè¯é€»è¾‘ | - |
| 2.1-UNIT-006 | Unit | P0 | æµ‹è¯•æ–‡ä»¶åæ¸…ç†å‡½æ•° | å®‰å…¨é˜²æŠ¤ | SEC-001 |
| 2.1-UNIT-007 | Unit | P0 | æµ‹è¯• Magic Bytes éªŒè¯ | å®‰å…¨å…³é”®é€»è¾‘ | SEC-001 |
| 2.1-INT-005 | Integration | P0 | æµ‹è¯•ä¸Šä¼ ä¸æ”¯æŒæ ¼å¼è¿”å›400é”™è¯¯ | API éªŒè¯ | SEC-001 |
| 2.1-INT-006 | Integration | P0 | æµ‹è¯•ä¸Šä¼ è¶…å¤§æ–‡ä»¶è¿”å›400é”™è¯¯ | API é™åˆ¶ | PERF-001 |
| 2.1-INT-007 | Integration | P0 | æµ‹è¯•ä¼ªé€ MIMEç±»å‹æ–‡ä»¶è¢«æ‹’ç» | å®‰å…¨é˜²æŠ¤ | SEC-001 |
| 2.1-E2E-004 | E2E | P0 | ç”¨æˆ·ä¸Šä¼ ä¸æ”¯æŒæ ¼å¼æ˜¾ç¤ºé”™è¯¯Toast | é”™è¯¯åé¦ˆ | SEC-001 |
| 2.1-E2E-005 | E2E | P1 | ç”¨æˆ·ä¸Šä¼ è¶…å¤§æ–‡ä»¶æ˜¾ç¤ºé”™è¯¯Toast | ç”¨æˆ·ä½“éªŒ | - |

**Test Details**:

```typescript
// 2.1-UNIT-004: æ–‡ä»¶ç±»å‹éªŒè¯
describe('validateFileType', () => {
  test('accepts PDF files', () => {
    const file = new File(['content'], 'test.pdf', { type: 'application/pdf' })
    expect(validateFileType(file)).toBe(true)
  })
  
  test('rejects EXE files', () => {
    const file = new File(['content'], 'malware.exe', { type: 'application/x-msdownload' })
    expect(validateFileType(file)).toBe(false)
  })
  
  test('rejects files with fake PDF extension', () => {
    const file = new File(['MZ\x90\x00'], 'fake.pdf', { type: 'application/pdf' })
    expect(validateFileType(file)).toBe(false)
  })
})

// 2.1-UNIT-007: Magic Bytes éªŒè¯ (CRITICAL - SEC-001)
describe('validateFileMagicBytes', () => {
  test('validates real PDF signature', async () => {
    const pdfBuffer = Buffer.from('%PDF-1.4', 'utf-8')
    const file = new File([pdfBuffer], 'test.pdf', { type: 'application/pdf' })
    
    const result = await validateFileMagicBytes(file)
    expect(result).toBe(true)
  })
  
  test('rejects EXE with PDF extension', async () => {
    const exeBuffer = Buffer.from('MZ\x90\x00\x03', 'binary')
    const file = new File([exeBuffer], 'malware.pdf', { type: 'application/pdf' })
    
    const result = await validateFileMagicBytes(file)
    expect(result).toBe(false)
  })
  
  test('rejects polyglot files', async () => {
    // åŒæ—¶æ»¡è¶³ PDF å’Œ JS ç­¾åçš„æ–‡ä»¶
    const polyglot = await readFile('tests/fixtures/polyglot.pdf-js')
    const result = await validateFileMagicBytes(polyglot)
    expect(result).toBe(false)
  })
})

// 2.1-INT-007: ä¼ªé€  MIME ç±»å‹æµ‹è¯• (CRITICAL - SEC-001)
test('API rejects file with fake MIME type', async () => {
  const exeContent = Buffer.from('MZ\x90\x00', 'binary')
  const formData = new FormData()
  formData.append('file', new Blob([exeContent], { type: 'application/pdf' }), 'malware.pdf')
  
  const response = await fetch('/api/documents/upload', {
    method: 'POST',
    body: formData,
    headers: { 'Cookie': authCookie }
  })
  
  expect(response.status).toBe(400)
  const data = await response.json()
  expect(data.error).toContain('File signature validation failed')
})

// 2.1-E2E-004: é”™è¯¯æç¤º
test('shows error toast for unsupported file type', async ({ page }) => {
  await page.goto('/dashboard/documents')
  await page.setInputFiles('input[type="file"]', 'tests/fixtures/test.exe')
  
  await expect(page.locator('text=ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼')).toBeVisible()
})
```

---

### AC4: å®æ—¶ä¸Šä¼ è¿›åº¦æ˜¾ç¤º

**Requirement**: æ˜¾ç¤ºæ¯ä¸ªæ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦æ¡å’ŒçŠ¶æ€

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-008 | Unit | P1 | æµ‹è¯•è¿›åº¦ç™¾åˆ†æ¯”è®¡ç®—é€»è¾‘ | çº¯è®¡ç®—é€»è¾‘ | - |
| 2.1-UNIT-009 | Unit | P1 | æµ‹è¯•æ–‡ä»¶å¤§å°æ ¼å¼åŒ–å‡½æ•° | æ˜¾ç¤ºé€»è¾‘ | - |
| 2.1-UNIT-010 | Unit | P2 | æµ‹è¯•å‰©ä½™æ—¶é—´ä¼°ç®—ç®—æ³• | è¾…åŠ©åŠŸèƒ½ | - |
| 2.1-INT-008 | Integration | P0 | æµ‹è¯• XHR progress äº‹ä»¶æ­£ç¡®æ›´æ–°çŠ¶æ€ | æ ¸å¿ƒåŠŸèƒ½ | TECH-001 |
| 2.1-INT-009 | Integration | P1 | æµ‹è¯•å¤šä¸ªæ–‡ä»¶ç‹¬ç«‹è¿›åº¦æ˜¾ç¤º | å¹¶å‘å¤„ç† | - |
| 2.1-E2E-006 | E2E | P1 | ç”¨æˆ·çœ‹åˆ°è¿›åº¦æ¡ä»0%åˆ°100% | ç”¨æˆ·ä½“éªŒ | - |

**Test Details**:

```typescript
// 2.1-UNIT-008: è¿›åº¦è®¡ç®—
test('calculates upload progress correctly', () => {
  const loaded = 5 * 1024 * 1024  // 5MB
  const total = 10 * 1024 * 1024   // 10MB
  
  const progress = calculateProgress(loaded, total)
  expect(progress).toBe(50)
})

// 2.1-INT-008: XHR è¿›åº¦æ›´æ–° (CRITICAL)
test('XHR progress event updates upload progress', async () => {
  const { result } = renderHook(() => useDocumentUpload())
  
  const file = new File(['x'.repeat(1024 * 1024)], 'test.pdf')
  
  act(() => {
    result.current.addFiles([file])
  })
  
  // ç­‰å¾…è¿›åº¦æ›´æ–°
  await waitFor(() => {
    const item = result.current.items[0]
    expect(item.progress).toBeGreaterThan(0)
    expect(item.status).toBe('uploading')
  })
  
  await waitFor(() => {
    const item = result.current.items[0]
    expect(item.progress).toBe(100)
    expect(item.status).toBe('success')
  }, { timeout: 10000 })
})

// 2.1-E2E-006: è¿›åº¦å¯è§æ€§
test('user sees upload progress bar', async ({ page }) => {
  await page.goto('/dashboard/documents')
  await page.setInputFiles('input[type="file"]', 'tests/fixtures/large.pdf')
  
  const progressBar = page.locator('[role="progressbar"]')
  await expect(progressBar).toBeVisible()
  
  // ç­‰å¾…è¿›åº¦å˜åŒ–
  await expect(progressBar).toHaveAttribute('aria-valuenow', /[1-9]\d*/)
  
  await expect(page.locator('text=100%')).toBeVisible({ timeout: 30000 })
})
```

---

### AC5: æ‰¹é‡ä¸Šä¼ å¤„ç†

**Requirement**: æ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼Œæœ€å¤šåŒæ—¶ä¸Šä¼ 3ä¸ªæ–‡ä»¶

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-011 | Unit | P0 | æµ‹è¯•å¹¶å‘æ§åˆ¶é€»è¾‘ï¼ˆæœ€å¤š3ä¸ªï¼‰ | æ ¸å¿ƒé™åˆ¶é€»è¾‘ | PERF-002 |
| 2.1-UNIT-012 | Unit | P1 | æµ‹è¯•æ€»ä½“è¿›åº¦è®¡ç®—ï¼ˆ3/5å®Œæˆï¼‰ | æ˜¾ç¤ºé€»è¾‘ | - |
| 2.1-INT-010 | Integration | P0 | æµ‹è¯•åŒæ—¶ä¸Šä¼ 10ä¸ªæ–‡ä»¶ï¼Œåªæœ‰3ä¸ªå¹¶å‘ | å¹¶å‘æ§åˆ¶ | PERF-002 |
| 2.1-INT-011 | Integration | P1 | æµ‹è¯•æ‰¹é‡å®Œæˆåæ˜¾ç¤ºæ±‡æ€»Toast | ç”¨æˆ·åé¦ˆ | PERF-003 |
| 2.1-E2E-007 | E2E | P1 | ç”¨æˆ·æ‰¹é‡ä¸Šä¼ 5ä¸ªæ–‡ä»¶çœ‹åˆ°è¿›åº¦ | å®Œæ•´æµç¨‹ | - |

**Test Details**:

```typescript
// 2.1-UNIT-011: å¹¶å‘æ§åˆ¶ (CRITICAL)
test('limits concurrent uploads to 3', async () => {
  const { result } = renderHook(() => useDocumentUpload())
  
  const files = Array.from({ length: 10 }, (_, i) =>
    new File(['content'], `file${i}.pdf`, { type: 'application/pdf' })
  )
  
  act(() => {
    result.current.addFiles(files)
  })
  
  // æ£€æŸ¥åŒæ—¶ä¸Šä¼ çš„æ–‡ä»¶æ•°
  await waitFor(() => {
    const uploading = result.current.items.filter(i => i.status === 'uploading')
    expect(uploading.length).toBeLessThanOrEqual(3)
  })
})

// 2.1-INT-010: æ‰¹é‡ä¸Šä¼ å¹¶å‘
test('processes 10 files with max 3 concurrent', async () => {
  const mockFetch = jest.fn().mockImplementation(() => 
    new Promise(resolve => setTimeout(() => resolve({ ok: true }), 1000))
  )
  global.fetch = mockFetch
  
  const files = Array.from({ length: 10 }, (_, i) =>
    new File(['content'], `file${i}.pdf`)
  )
  
  const { result } = renderHook(() => useDocumentUpload())
  
  act(() => {
    result.current.addFiles(files)
  })
  
  // ç¬¬ä¸€æ‰¹3ä¸ªç«‹å³å¼€å§‹
  await waitFor(() => {
    expect(mockFetch).toHaveBeenCalledTimes(3)
  })
  
  // ç­‰å¾…å…¨éƒ¨å®Œæˆ
  await waitFor(() => {
    expect(mockFetch).toHaveBeenCalledTimes(10)
    expect(result.current.items.every(i => i.status === 'success')).toBe(true)
  }, { timeout: 15000 })
})
```

---

### AC6: é”™è¯¯å¤„ç†ä¸é‡è¯•

**Requirement**: ä¸Šä¼ å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯å¹¶æ”¯æŒé‡è¯•

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-013 | Unit | P1 | æµ‹è¯•ç½‘ç»œé”™è¯¯è¯†åˆ«é€»è¾‘ | é”™è¯¯åˆ†ç±» | - |
| 2.1-UNIT-014 | Unit | P1 | æµ‹è¯•æœåŠ¡å™¨é”™è¯¯è¯†åˆ«é€»è¾‘ | é”™è¯¯åˆ†ç±» | - |
| 2.1-UNIT-015 | Unit | P1 | æµ‹è¯•é‡è¯•é€»è¾‘é‡ç½®çŠ¶æ€ | çŠ¶æ€ç®¡ç† | - |
| 2.1-INT-012 | Integration | P0 | æµ‹è¯•ç½‘ç»œé”™è¯¯åå¯ä»¥é‡è¯• | ç”¨æˆ·æ¢å¤è·¯å¾„ | - |
| 2.1-INT-013 | Integration | P1 | æµ‹è¯•å–æ¶ˆä¸Šä¼ ä¸­çš„æ–‡ä»¶ | ç”¨æˆ·æ§åˆ¶ | - |

**Test Details**:

```typescript
// 2.1-UNIT-013: ç½‘ç»œé”™è¯¯è¯†åˆ«
test('identifies network errors', () => {
  const error = new TypeError('Failed to fetch')
  expect(isNetworkError(error)).toBe(true)
  
  const serverError = new Error('500 Internal Server Error')
  expect(isNetworkError(serverError)).toBe(false)
})

// 2.1-INT-012: é‡è¯•åŠŸèƒ½
test('can retry failed upload', async () => {
  let attemptCount = 0
  const mockFetch = jest.fn().mockImplementation(() => {
    attemptCount++
    if (attemptCount === 1) {
      return Promise.reject(new Error('Network error'))
    }
    return Promise.resolve({ ok: true, json: () => ({ success: true }) })
  })
  global.fetch = mockFetch
  
  const { result } = renderHook(() => useDocumentUpload())
  const file = new File(['content'], 'test.pdf')
  
  act(() => {
    result.current.addFiles([file])
  })
  
  // ç­‰å¾…å¤±è´¥
  await waitFor(() => {
    expect(result.current.items[0].status).toBe('error')
  })
  
  // é‡è¯•
  act(() => {
    result.current.retryUpload(result.current.items[0].id)
  })
  
  // ç­‰å¾…æˆåŠŸ
  await waitFor(() => {
    expect(result.current.items[0].status).toBe('success')
  })
})
```

---

### AC7: ç”¨æˆ·é…é¢æ£€æŸ¥

**Requirement**: æ£€æŸ¥ç”¨æˆ·æ–‡æ¡£æ•°é‡å’Œå­˜å‚¨ç©ºé—´é…é¢

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-016 | Unit | P0 | æµ‹è¯•é…é¢è®¡ç®—é€»è¾‘ | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ | DATA-001 |
| 2.1-UNIT-017 | Unit | P0 | æµ‹è¯•åŸå­æ›´æ–°æ¡ä»¶æ„å»º | é˜²ç«æ€æ¡ä»¶ | DATA-001 |
| 2.1-INT-014 | Integration | P0 | æµ‹è¯•æ–‡æ¡£æ•°é‡è¾¾åˆ°é™åˆ¶æ—¶æ‹’ç»ä¸Šä¼  | é…é¢å¼ºåˆ¶æ‰§è¡Œ | DATA-001 |
| 2.1-INT-015 | Integration | P0 | æµ‹è¯•å¹¶å‘ä¸Šä¼ ä¸ä¼šç»•è¿‡é…é¢ | ç«æ€æ¡ä»¶é˜²æŠ¤ | DATA-001 |
| 2.1-E2E-008 | E2E | P0 | ç”¨æˆ·é…é¢ç”¨å°½æ˜¾ç¤ºæ˜ç¡®é”™è¯¯ | ç”¨æˆ·åé¦ˆ | - |

**Test Details**:

```typescript
// 2.1-UNIT-016: é…é¢è®¡ç®—
test('calculates quota correctly', () => {
  const usage = { documentCount: 45, storageUsed: 400 * 1024 * 1024 }
  const file = { size: 50 * 1024 * 1024 }
  
  expect(canUpload(usage, file, { maxDocs: 50, maxStorage: 500 * 1024 * 1024 })).toBe(true)
  
  const tooBig = { size: 150 * 1024 * 1024 }
  expect(canUpload(usage, tooBig, { maxDocs: 50, maxStorage: 500 * 1024 * 1024 })).toBe(false)
})

// 2.1-INT-015: å¹¶å‘é…é¢æµ‹è¯• (CRITICAL - DATA-001)
test('prevents quota bypass via concurrent uploads', async () => {
  // è®¾ç½®ç”¨æˆ·é…é¢ä¸º49
  await db.update(userUsage)
    .set({ documentCount: 49 })
    .where(eq(userUsage.userId, testUserId))
  
  // åŒæ—¶å‘èµ·10ä¸ªä¸Šä¼ è¯·æ±‚
  const files = Array.from({ length: 10 }, (_, i) =>
    new File(['content'], `file${i}.pdf`)
  )
  
  const uploadPromises = files.map(file => {
    const formData = new FormData()
    formData.append('file', file)
    return fetch('/api/documents/upload', {
      method: 'POST',
      body: formData,
      headers: { 'Cookie': authCookie }
    })
  })
  
  const responses = await Promise.all(uploadPromises)
  
  // åªæœ‰1ä¸ªåº”è¯¥æˆåŠŸ
  const succeeded = responses.filter(r => r.ok)
  expect(succeeded.length).toBe(1)
  
  // éªŒè¯æœ€ç»ˆé…é¢
  const [finalUsage] = await db.select()
    .from(userUsage)
    .where(eq(userUsage.userId, testUserId))
  
  expect(finalUsage.documentCount).toBe(50)  // 49 + 1ï¼Œä¸æ˜¯49 + 10
})

// 2.1-E2E-008: é…é¢é”™è¯¯æç¤º
test('shows quota error when limit reached', async ({ page }) => {
  // è®¾ç½®ç”¨æˆ·å·²è¾¾é…é¢é™åˆ¶
  await setUserQuota(testUser.id, { documentCount: 50, storageUsed: 0 })
  
  await page.goto('/dashboard/documents')
  await page.setInputFiles('input[type="file"]', 'tests/fixtures/test.pdf')
  
  await expect(page.locator('text=æ–‡æ¡£æ•°é‡å·²è¾¾ä¸Šé™')).toBeVisible()
  await expect(page.locator('text=50ä¸ª')).toBeVisible()
})
```

---

### AC8: UI/UXä½“éªŒ

**Requirement**: ç¾è§‚ã€æµç•…çš„ç•Œé¢ä½“éªŒå’Œæš—è‰²æ¨¡å¼æ”¯æŒ

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk Mitigation |
|----|-------|----------|------|---------------|-----------------|
| 2.1-UNIT-018 | Unit | P2 | æµ‹è¯•ä¸»é¢˜ç±»åæ­£ç¡®åº”ç”¨ | æ ·å¼ä¸€è‡´æ€§ | - |
| 2.1-INT-016 | Integration | P2 | æµ‹è¯•æš—è‰²æ¨¡å¼ä¸‹é¢œè‰²å¯¹æ¯”åº¦ | å¯è®¿é—®æ€§ | - |

**Test Details**:

```typescript
// 2.1-UNIT-018: ä¸»é¢˜ç³»ç»Ÿ
test('uses theme system color classes', () => {
  render(<FileDropzone onFilesSelected={jest.fn()} />)
  
  const dropzone = screen.getByRole('button')
  expect(dropzone).toHaveClass(/border-muted-foreground/)
  expect(dropzone).not.toHaveClass(/border-gray-400/)  // ç¦æ­¢ç¡¬ç¼–ç é¢œè‰²
})

// 2.1-INT-016: æš—è‰²æ¨¡å¼å¯¹æ¯”åº¦
test('maintains contrast in dark mode', () => {
  document.documentElement.classList.add('dark')
  
  render(<UploadProgressList items={mockItems} {...mockHandlers} />)
  
  const text = screen.getByText('test.pdf')
  const styles = window.getComputedStyle(text)
  const contrast = calculateContrast(styles.color, styles.backgroundColor)
  
  expect(contrast).toBeGreaterThanOrEqual(4.5)  // WCAG AA
})
```

---

## Risk Coverage Matrix

å°†æµ‹è¯•åœºæ™¯æ˜ å°„åˆ°å·²è¯†åˆ«çš„é£é™©:

| Risk ID | Score | Test IDs | Coverage |
|---------|-------|----------|----------|
| **SEC-001** | 9 | 2.1-UNIT-004, 2.1-UNIT-006, 2.1-UNIT-007, 2.1-INT-005, 2.1-INT-007, 2.1-E2E-004 | âœ… Full |
| **DATA-001** | 9 | 2.1-UNIT-016, 2.1-UNIT-017, 2.1-INT-014, 2.1-INT-015, 2.1-E2E-008 | âœ… Full |
| **PERF-001** | 6 | 2.1-INT-006, 2.1-E2E-005 | ğŸŸ¡ Partial (éœ€è¦è´Ÿè½½æµ‹è¯•) |
| **PERF-002** | 6 | 2.1-UNIT-011, 2.1-INT-010 | âœ… Full |
| **TECH-001** | 6 | 2.1-INT-008 | ğŸŸ¡ Partial (éœ€è¦å¤šæµè§ˆå™¨æµ‹è¯•) |
| **DATA-002** | 4 | 2.1-INT-014 | ğŸŸ¡ Partial (Story 2.2) |
| **PERF-003** | 4 | 2.1-INT-011 | âœ… Full |
| **TECH-002** | 4 | 2.1-INT-001 | âœ… Full |

**æœªå®Œå…¨è¦†ç›–çš„é£é™©**:
- âš ï¸ **PERF-001**: éœ€è¦æ·»åŠ å†…å­˜ä½¿ç”¨ç›‘æ§æµ‹è¯•
- âš ï¸ **TECH-001**: éœ€è¦åœ¨ Safariã€Firefoxã€Mobile Chrome ä¸Šæ‰§è¡Œ E2E æµ‹è¯•

---

## Recommended Execution Order

### Phase 1: Fail Fast (P0 Unit Tests)
**æ—¶é—´**: ~30åˆ†é’Ÿ  
**ç›®æ ‡**: å¿«é€Ÿå‘ç°æ ¸å¿ƒé€»è¾‘é”™è¯¯

```bash
# å®‰å…¨å…³é”®æµ‹è¯• (SEC-001, DATA-001)
npm test -- 2.1-UNIT-004  # validateFileType
npm test -- 2.1-UNIT-005  # validateFileSize
npm test -- 2.1-UNIT-006  # sanitizeFilename
npm test -- 2.1-UNIT-007  # validateFileMagicBytes (CRITICAL)
npm test -- 2.1-UNIT-016  # é…é¢è®¡ç®—
npm test -- 2.1-UNIT-017  # åŸå­æ›´æ–°

# æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
npm test -- 2.1-UNIT-011  # å¹¶å‘æ§åˆ¶
```

### Phase 2: Integration Tests (P0)
**æ—¶é—´**: ~1å°æ—¶  
**ç›®æ ‡**: éªŒè¯ç»„ä»¶äº¤äº’å’Œ API è¡Œä¸º

```bash
# å®‰å…¨æµ‹è¯•
npm test -- 2.1-INT-005   # æ ¼å¼éªŒè¯
npm test -- 2.1-INT-006   # å¤§å°é™åˆ¶
npm test -- 2.1-INT-007   # ä¼ªé€  MIME ç±»å‹ (CRITICAL)

# é…é¢æµ‹è¯•
npm test -- 2.1-INT-014   # é…é¢é™åˆ¶
npm test -- 2.1-INT-015   # å¹¶å‘é…é¢ (CRITICAL)

# æ ¸å¿ƒåŠŸèƒ½
npm test -- 2.1-INT-001   # æ‹–æ‹½ä¸Šä¼ 
npm test -- 2.1-INT-003   # ç‚¹å‡»ä¸Šä¼ 
npm test -- 2.1-INT-008   # è¿›åº¦æ›´æ–°
npm test -- 2.1-INT-010   # æ‰¹é‡ä¸Šä¼ 
```

### Phase 3: E2E Tests (P0)
**æ—¶é—´**: ~30åˆ†é’Ÿ  
**ç›®æ ‡**: éªŒè¯å…³é”®ç”¨æˆ·è·¯å¾„

```bash
npm run test:e2e -- 2.1-E2E-001  # æ‹–æ‹½ä¸Šä¼ å®Œæ•´æµç¨‹
npm run test:e2e -- 2.1-E2E-003  # ç‚¹å‡»ä¸Šä¼ å®Œæ•´æµç¨‹
npm run test:e2e -- 2.1-E2E-004  # é”™è¯¯æç¤º
npm run test:e2e -- 2.1-E2E-008  # é…é¢é”™è¯¯
```

### Phase 4: P1 Tests
**æ—¶é—´**: ~1.5å°æ—¶  
**ç›®æ ‡**: å®Œæ•´åŠŸèƒ½è¦†ç›–

```bash
# Unit Tests (P1)
npm test -- tests/unit/useDocumentUpload.test.ts

# Integration Tests (P1)
npm test -- tests/integration/upload-api.test.ts

# E2E Tests (P1)
npm run test:e2e -- tests/e2e/document-upload.spec.ts
```

### Phase 5: Cross-Browser & Performance
**æ—¶é—´**: ~1å°æ—¶  
**ç›®æ ‡**: å…¼å®¹æ€§å’Œæ€§èƒ½éªŒè¯

```bash
# å¤šæµè§ˆå™¨ E2E
npm run test:e2e -- --project=chromium
npm run test:e2e -- --project=firefox
npm run test:e2e -- --project=webkit

# æ€§èƒ½æµ‹è¯•
npm run test:perf -- upload-performance.test.ts
```

---

## Test Data Requirements

### æµ‹è¯•æ–‡ä»¶å‡†å¤‡

```
tests/
â”œâ”€â”€ fixtures/
â”‚   â”œâ”€â”€ sample.pdf                 # æ­£å¸¸ PDF (5MB)
â”‚   â”œâ”€â”€ large.pdf                  # å¤§æ–‡ä»¶ (45MB)
â”‚   â”œâ”€â”€ oversized.pdf              # è¶…å¤§æ–‡ä»¶ (51MB)
â”‚   â”œâ”€â”€ sample.docx                # Word æ–‡æ¡£
â”‚   â”œâ”€â”€ sample.md                  # Markdown
â”‚   â”œâ”€â”€ sample.txt                 # çº¯æ–‡æœ¬
â”‚   â”œâ”€â”€ malware.exe                # æ¶æ„æ–‡ä»¶
â”‚   â”œâ”€â”€ fake.pdf                   # ä¼ªé€ æ‰©å±•å (exeæ”¹å)
â”‚   â”œâ”€â”€ polyglot.pdf-js            # Polyglot æ–‡ä»¶
â”‚   â”œâ”€â”€ corrupted.pdf              # æŸåçš„ PDF
â”‚   â””â”€â”€ empty.pdf                  # ç©ºæ–‡ä»¶
```

### ç”¨æˆ·æµ‹è¯•æ•°æ®

```typescript
const testUsers = {
  normalUser: {
    id: 'user_normal',
    email: 'normal@test.com',
    quota: { documentCount: 10, storageUsed: 100 * 1024 * 1024 }
  },
  nearLimitUser: {
    id: 'user_near_limit',
    email: 'nearlimit@test.com',
    quota: { documentCount: 49, storageUsed: 480 * 1024 * 1024 }
  },
  atLimitUser: {
    id: 'user_at_limit',
    email: 'atlimit@test.com',
    quota: { documentCount: 50, storageUsed: 500 * 1024 * 1024 }
  }
}
```

---

## Test Environment Setup

### å•å…ƒæµ‹è¯•ç¯å¢ƒ

```typescript
// jest.setup.js
import '@testing-library/jest-dom'
import { TextEncoder, TextDecoder } from 'util'

global.TextEncoder = TextEncoder
global.TextDecoder = TextDecoder

// Mock XMLHttpRequest è¿›åº¦
class MockXMLHttpRequest {
  upload = {
    addEventListener: jest.fn(),
    removeEventListener: jest.fn()
  }
  addEventListener = jest.fn()
  open = jest.fn()
  send = jest.fn()
  setRequestHeader = jest.fn()
}

global.XMLHttpRequest = MockXMLHttpRequest as any
```

### é›†æˆæµ‹è¯•ç¯å¢ƒ

```typescript
// tests/setup/test-db.ts
import { beforeAll, afterAll, beforeEach } from 'vitest'
import { db } from '@/lib/db'

beforeAll(async () => {
  // ä½¿ç”¨æµ‹è¯•æ•°æ®åº“
  process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/docqa_test'
})

beforeEach(async () => {
  // æ¸…ç©ºæµ‹è¯•æ•°æ®
  await db.delete(documents)
  await db.delete(userUsage)
})

afterAll(async () => {
  // å…³é—­è¿æ¥
  await db.$client.end()
})
```

### E2E æµ‹è¯•ç¯å¢ƒ

```typescript
// playwright.config.ts
export default defineConfig({
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'webkit', use: { ...devices['Desktop Safari'] } },
    { name: 'mobile-chrome', use: { ...devices['Pixel 5'] } },
  ],
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    video: 'retain-on-failure'
  }
})
```

---

## Coverage Goals

### ä»£ç è¦†ç›–ç‡ç›®æ ‡

| Component | Line Coverage | Branch Coverage | Function Coverage |
|-----------|---------------|-----------------|-------------------|
| `useDocumentUpload.ts` | â‰¥ 90% | â‰¥ 85% | â‰¥ 90% |
| `FileDropzone.tsx` | â‰¥ 80% | â‰¥ 75% | â‰¥ 80% |
| `lib/validators.ts` | â‰¥ 95% | â‰¥ 90% | â‰¥ 95% |
| `/api/documents/upload` | â‰¥ 85% | â‰¥ 80% | â‰¥ 85% |
| **Overall** | **â‰¥ 85%** | **â‰¥ 80%** | **â‰¥ 85%** |

### AC è¦†ç›–ç‡éªŒè¯

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm test -- --coverage

# éªŒè¯æ¯ä¸ª AC è‡³å°‘æœ‰ä¸€ä¸ªæµ‹è¯•
npm run test:coverage-check
```

**è¦†ç›–ç‡ä¸è¾¾æ ‡æ—¶çš„è¡ŒåŠ¨**:
- < 80%: è­¦å‘Šï¼Œè¯†åˆ«æœªè¦†ç›–çš„åˆ†æ”¯
- < 70%: é˜»æ­¢åˆå¹¶ï¼Œå¿…é¡»æ·»åŠ æµ‹è¯•
- < 60%: ä¸¥é‡ï¼Œéœ€è¦æµ‹è¯•ç­–ç•¥å®¡æŸ¥

---

## Quality Checklist

åœ¨æµ‹è¯•æ‰§è¡Œå‰éªŒè¯:

- [x] æ¯ä¸ª AC éƒ½æœ‰è‡³å°‘ä¸€ä¸ªæµ‹è¯•åœºæ™¯
- [x] æ‰€æœ‰ P0 é£é™©éƒ½æœ‰å¯¹åº”æµ‹è¯•è¦†ç›–
- [x] æµ‹è¯•çº§åˆ«åˆ†é…åˆç†ï¼ˆä¸è¿‡åº¦æµ‹è¯•ï¼‰
- [x] æ²¡æœ‰é‡å¤çš„æµ‹è¯•è¦†ç›–
- [x] æµ‹è¯• ID éµå¾ªå‘½åçº¦å®š `{epic}.{story}-{LEVEL}-{SEQ}`
- [x] æ¯ä¸ªæµ‹è¯•åœºæ™¯éƒ½æ˜¯åŸå­å’Œç‹¬ç«‹çš„
- [x] å…³é”®è·¯å¾„æœ‰å¤šå±‚æµ‹è¯•ï¼ˆUnit + Integration + E2Eï¼‰
- [x] æµ‹è¯•æ•°æ®å’Œå¤¹å…·å·²å‡†å¤‡
- [x] æµ‹è¯•ç¯å¢ƒé…ç½®å·²å®šä¹‰

---

## Test Maintenance Strategy

### æµ‹è¯•æ›´æ–°è§¦å‘æ¡ä»¶

1. **AC å˜æ›´**: æ›´æ–°ç›¸å…³æµ‹è¯•åœºæ™¯
2. **API å˜æ›´**: æ›´æ–°é›†æˆæµ‹è¯•
3. **UI ç»„ä»¶å˜æ›´**: æ›´æ–° E2E é€‰æ‹©å™¨
4. **ä¾èµ–å‡çº§**: éªŒè¯å…¼å®¹æ€§æµ‹è¯•

### å¤±è´¥æµ‹è¯•å¤„ç†

```bash
# å¤±è´¥æµ‹è¯•åˆ†ç±»
- Flaky (ä¸ç¨³å®š): æ·»åŠ é‡è¯•æˆ–ç­‰å¾…é€»è¾‘
- Broken (ä»£ç ç ´å): ä¿®å¤ä»£ç æˆ–æ›´æ–°æµ‹è¯•
- Outdated (è¿‡æ—¶): æ›´æ–°æµ‹è¯•åŒ¹é…æ–°éœ€æ±‚
```

### æµ‹è¯•æ€§èƒ½ç›‘æ§

```typescript
// æµ‹è¯•æ‰§è¡Œæ—¶é—´åŸºå‡†
const benchmarks = {
  'unit-tests': 30 * 1000,        // 30ç§’
  'integration-tests': 60 * 1000, // 1åˆ†é’Ÿ
  'e2e-tests': 180 * 1000         // 3åˆ†é’Ÿ
}

// è¶…æ—¶å‘Šè­¦
if (testDuration > benchmark) {
  console.warn(`Tests slower than baseline: ${testDuration}ms > ${benchmark}ms`)
}
```

---

## Conclusion

æœ¬æµ‹è¯•è®¾è®¡ä¸º Story 2.1 æä¾›äº† **42 ä¸ªå…¨é¢çš„æµ‹è¯•åœºæ™¯**ï¼Œè¦†ç›–æ‰€æœ‰ 8 ä¸ªéªŒæ”¶æ ‡å‡†å’Œ 14 ä¸ªå·²è¯†åˆ«çš„é£é™©ã€‚

### å…³é”®æµ‹è¯•è¦æ±‚

**å¿…é¡»æ‰§è¡Œ (P0)**:
1. âœ… SEC-001 ç¼“è§£éªŒè¯ï¼ˆMagic Bytesã€æ–‡ä»¶åæ¸…ç†ï¼‰
2. âœ… DATA-001 ç¼“è§£éªŒè¯ï¼ˆå¹¶å‘é…é¢æµ‹è¯•ï¼‰
3. âœ… æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ˆæ‹–æ‹½ã€ç‚¹å‡»ã€è¿›åº¦ã€æ‰¹é‡ï¼‰

**æ¨èæ‰§è¡Œ (P1)**:
4. ğŸŸ¡ å®Œæ•´åŠŸèƒ½è¦†ç›–
5. ğŸŸ¡ é”™è¯¯å¤„ç†å’Œé‡è¯•
6. ğŸŸ¡ å¤šæµè§ˆå™¨å…¼å®¹æ€§

**å¯é€‰æ‰§è¡Œ (P2)**:
7. âšª UI/UX ç»†èŠ‚æµ‹è¯•
8. âšª æ€§èƒ½åŸºå‡†æµ‹è¯•

**æ€»æ‰§è¡Œæ—¶é—´ä¼°ç®—**: 4-5å°æ—¶ï¼ˆå®Œæ•´å¥—ä»¶ï¼‰  
**æœ€å°å¯è¡Œæµ‹è¯•**: 2å°æ—¶ï¼ˆP0 onlyï¼‰

---

**Test Design Status**: âœ… Complete  
**Ready for Implementation**: Yes  
**Next Step**: å¼€å‘å›¢é˜Ÿå®æ–½æµ‹è¯•ï¼ŒQA æ‰§è¡ŒéªŒè¯

