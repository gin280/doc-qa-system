# Test Design: Story 1.5 - OAuth第三方登录

**Date**: 2025-01-03  
**Designer**: Quinn (Test Architect)  
**Story ID**: 1.5  
**Story Title**: OAuth第三方登录

---

## Test Strategy Overview

### Summary Statistics

- **Total test scenarios**: 28
- **Unit tests**: 8 (29%)
- **Integration tests**: 14 (50%)
- **E2E tests**: 6 (21%)
- **Priority distribution**:
  - P0: 12 scenarios (43%) - Critical path & security
  - P1: 10 scenarios (36%) - Core functionality
  - P2: 6 scenarios (21%) - Edge cases & UX

### Test Approach

OAuth 集成的测试策略采用 **安全优先 + 风险驱动** 的方法：

1. **安全测试优先**: 所有安全相关场景标记为 P0
2. **多级别覆盖**: Critical paths 使用 Unit + Integration + E2E 三级覆盖
3. **Mock 外部依赖**: OAuth Provider API 使用 Mock 避免外部依赖
4. **真实流程验证**: E2E 测试使用测试账号进行真实 OAuth 流程

---

## Test Scenarios by Acceptance Criteria

### AC1: NextAuth.js OAuth Provider 配置

#### Unit Tests

| ID           | Level | Priority | Test                                | Justification                |
|--------------|-------|----------|-------------------------------------|------------------------------|
| 1.5-UNIT-001 | Unit  | P0       | 验证 GoogleProvider 配置正确加载      | 配置错误会导致整个功能不可用   |
| 1.5-UNIT-002 | Unit  | P0       | 验证 GitHubProvider 配置正确加载      | 配置错误会导致整个功能不可用   |
| 1.5-UNIT-003 | Unit  | P0       | 验证环境变量缺失时抛出明确错误         | 提前发现配置问题             |
| 1.5-UNIT-004 | Unit  | P1       | 验证 NEXTAUTH_SECRET 长度要求        | 安全密钥强度验证             |

**覆盖的 AC**: AC1  
**风险缓解**: TECH-001, OPS-001, SEC-002

---

### AC2: Google OAuth 集成

#### Integration Tests

| ID           | Level       | Priority | Test                                      | Justification                    |
|--------------|-------------|----------|-------------------------------------------|----------------------------------|
| 1.5-INT-001  | Integration | P0       | Mock Google OAuth 授权流程成功返回         | 核心功能验证                     |
| 1.5-INT-002  | Integration | P0       | 验证 Google OAuth 回调正确处理 user info   | 数据提取逻辑验证                 |
| 1.5-INT-003  | Integration | P1       | Google OAuth 授权被用户取消时的处理        | 错误处理验证                     |
| 1.5-INT-004  | Integration | P1       | Google OAuth 返回错误时的降级处理          | 错误处理验证                     |

#### E2E Tests

| ID          | Level | Priority | Test                                      | Justification                    |
|-------------|-------|----------|-------------------------------------------|----------------------------------|
| 1.5-E2E-001 | E2E   | P0       | 完整 Google OAuth 登录流程（真实测试账号）  | Critical path 端到端验证         |
| 1.5-E2E-002 | E2E   | P1       | Google OAuth 登录后头像正确显示            | 用户体验验证                     |

**覆盖的 AC**: AC2, AC6 (部分), AC7 (部分)  
**风险缓解**: SEC-001, DATA-001, TECH-001

---

### AC3: GitHub OAuth 集成

#### Integration Tests

| ID           | Level       | Priority | Test                                      | Justification                    |
|--------------|-------------|----------|-------------------------------------------|----------------------------------|
| 1.5-INT-005  | Integration | P0       | Mock GitHub OAuth 授权流程成功返回         | 核心功能验证                     |
| 1.5-INT-006  | Integration | P0       | 验证 GitHub OAuth 回调正确处理 user info   | 数据提取逻辑验证                 |
| 1.5-INT-007  | Integration | P1       | GitHub OAuth 授权被用户取消时的处理        | 错误处理验证                     |
| 1.5-INT-008  | Integration | P1       | GitHub OAuth 返回错误时的降级处理          | 错误处理验证                     |

#### E2E Tests

| ID          | Level | Priority | Test                                      | Justification                    |
|-------------|-------|----------|-------------------------------------------|----------------------------------|
| 1.5-E2E-003 | E2E   | P0       | 完整 GitHub OAuth 登录流程（真实测试账号）  | Critical path 端到端验证         |
| 1.5-E2E-004 | E2E   | P1       | GitHub OAuth 登录后头像正确显示            | 用户体验验证                     |

**覆盖的 AC**: AC3, AC6 (部分), AC7 (部分)  
**风险缓解**: SEC-001, DATA-001, TECH-001

---

### AC4: OAuth 用户自动创建与关联

#### Unit Tests

| ID           | Level | Priority | Test                                           | Justification                        |
|--------------|-------|----------|------------------------------------------------|--------------------------------------|
| 1.5-UNIT-005 | Unit  | P0       | signIn 回调创建新 Google OAuth 用户             | 核心业务逻辑验证                     |
| 1.5-UNIT-006 | Unit  | P0       | signIn 回调创建新 GitHub OAuth 用户             | 核心业务逻辑验证                     |
| 1.5-UNIT-007 | Unit  | P0       | OAuth 用户 passwordHash 字段为 null            | 数据一致性验证                       |
| 1.5-UNIT-008 | Unit  | P0       | OAuth 用户 authProvider 字段正确设置            | 数据一致性验证                       |

#### Integration Tests

| ID           | Level       | Priority | Test                                           | Justification                        |
|--------------|-------------|----------|------------------------------------------------|--------------------------------------|
| 1.5-INT-009  | Integration | P0       | 已存在用户 OAuth 登录时更新头像                  | 用户数据更新逻辑验证                 |
| 1.5-INT-010  | Integration | P0       | 相同邮箱 EMAIL 用户存在时 OAuth 登录被阻止       | **CRITICAL**: 防止账户冲突（DATA-001）|
| 1.5-INT-011  | Integration | P1       | 相同邮箱但不同 authProvider 的用户可以共存       | 多登录方式支持验证                   |
| 1.5-INT-012  | Integration | P1       | OAuth 用户邮箱格式验证                          | 数据质量验证                         |

**覆盖的 AC**: AC4  
**风险缓解**: DATA-001 (Critical), DATA-002, DATA-003

---

### AC5: UI/UX 实现

#### Integration Tests

| ID           | Level       | Priority | Test                                           | Justification                        |
|--------------|-------------|----------|------------------------------------------------|--------------------------------------|
| 1.5-INT-013  | Integration | P1       | 登录页正确渲染 OAuth 按钮组                      | UI 组件验证                          |
| 1.5-INT-014  | Integration | P1       | 注册页正确渲染 OAuth 按钮组                      | UI 组件验证                          |

#### E2E Tests

| ID          | Level | Priority | Test                                           | Justification                        |
|-------------|-------|----------|------------------------------------------------|--------------------------------------|
| 1.5-E2E-005 | E2E   | P1       | OAuth 按钮加载状态正确显示                       | 用户体验验证                         |
| 1.5-E2E-006 | E2E   | P2       | OAuth 按钮在请求进行中被禁用                     | 防止重复点击                         |

**覆盖的 AC**: AC5  
**风险缓解**: BUS-001, BUS-002

---

### AC6: 头像存储与显示

#### Integration Tests

| ID           | Level       | Priority | Test                                           | Justification                        |
|--------------|-------------|----------|------------------------------------------------|--------------------------------------|
| 1.5-INT-015  | Integration | P1       | OAuth 头像 URL 存储到数据库                      | 数据持久化验证                       |
| 1.5-INT-016  | Integration | P1       | 头像 URL 无效时显示 fallback                     | 错误处理验证                         |
| 1.5-INT-017  | Integration | P2       | 头像 URL 格式验证（HTTP/HTTPS）                  | 数据质量验证                         |

**覆盖的 AC**: AC6  
**风险缓解**: DATA-002, PERF-002

---

### AC7: 错误处理与安全

#### Integration Tests

| ID           | Level       | Priority | Test                                           | Justification                        |
|--------------|-------------|----------|------------------------------------------------|--------------------------------------|
| 1.5-INT-018  | Integration | P0       | OAuth 回调 URL 验证（拒绝非授权域名）             | **CRITICAL**: 防止回调劫持（SEC-001） |
| 1.5-INT-019  | Integration | P0       | CSRF Token (state) 验证                         | 安全验证（NextAuth 内置）            |
| 1.5-INT-020  | Integration | P1       | OAuth 错误时显示友好提示                         | 用户体验验证                         |

**覆盖的 AC**: AC7  
**风险缓解**: SEC-001 (Critical), SEC-003

---

## Additional Test Scenarios (Beyond ACs)

### Performance Tests

| ID          | Level       | Priority | Test                                           | Justification                        |
|-------------|-------------|----------|------------------------------------------------|--------------------------------------|
| 1.5-PERF-001| Integration | P0       | OAuth 回调处理时间 < 500ms                      | 性能要求（PERF-001）                 |
| 1.5-PERF-002| E2E         | P1       | 完整 OAuth 流程时间 < 5s (P95)                  | 用户体验要求                         |

### Security Tests

| ID          | Level       | Priority | Test                                           | Justification                        |
|-------------|-------------|----------|------------------------------------------------|--------------------------------------|
| 1.5-SEC-001 | Integration | P0       | NEXTAUTH_SECRET 强度验证（≥32字符）             | 安全配置验证                         |
| 1.5-SEC-002 | Integration | P0       | Session Token 使用 HTTP-Only Cookie 存储        | Session 劫持防护（SEC-003）          |

### Cross-Browser Tests

| ID          | Level | Priority | Test                                           | Justification                        |
|-------------|-------|----------|------------------------------------------------|--------------------------------------|
| 1.5-E2E-007 | E2E   | P2       | Chrome 浏览器 OAuth 流程                        | 浏览器兼容性                         |
| 1.5-E2E-008 | E2E   | P2       | Safari 浏览器 OAuth 流程                        | 浏览器兼容性                         |
| 1.5-E2E-009 | E2E   | P2       | Firefox 浏览器 OAuth 流程                       | 浏览器兼容性                         |

---

## Detailed Test Scenarios

### Critical Path Tests (P0)

#### 1.5-INT-001: Mock Google OAuth 授权流程成功返回

**Test Level**: Integration  
**Priority**: P0  
**Description**: 模拟 Google OAuth 完整授权流程，验证用户成功登录

**Preconditions**:
- NextAuth.js 已配置 GoogleProvider
- 测试数据库可用
- Mock Google OAuth API

**Test Steps**:
1. Mock Google OAuth API 返回成功的授权响应
2. 调用 `signIn('google')`
3. 模拟 Google 授权回调，返回 user info
4. 验证 signIn 回调被触发
5. 验证新用户被创建
6. 验证 Session 被建立

**Expected Results**:
- 用户记录被创建，authProvider = 'GOOGLE'
- passwordHash = null
- email, name, avatarUrl 正确存储
- Session token 被创建
- 返回 true（授权成功）

**Risk Mitigation**: TECH-001, DATA-001

**Test Data**:
```typescript
const mockGoogleUser = {
  email: 'test@gmail.com',
  name: 'Test User',
  image: 'https://lh3.googleusercontent.com/a/test-avatar'
}
```

---

#### 1.5-INT-010: 相同邮箱 EMAIL 用户存在时 OAuth 登录被阻止

**Test Level**: Integration  
**Priority**: P0  
**Description**: **CRITICAL** - 验证邮箱归属验证策略，防止账户冲突

**Preconditions**:
- 数据库中已存在 EMAIL 用户（test@example.com）
- NextAuth.js 配置包含邮箱验证逻辑

**Test Steps**:
1. 创建 EMAIL 用户: `{ email: 'test@example.com', authProvider: 'EMAIL', passwordHash: 'hashed' }`
2. 尝试使用 Google OAuth 登录（相同邮箱）
3. Mock Google 返回 user info（邮箱相同）
4. 验证 signIn 回调处理

**Expected Results**:
- OAuth 登录被拒绝
- 返回错误: "此邮箱已使用邮箱密码注册，请先登录后在设置中关联社交账号"
- 不创建新用户记录
- 不更新现有用户记录

**Risk Mitigation**: DATA-001 (Critical Risk)

**Test Data**:
```typescript
const existingUser = {
  email: 'test@example.com',
  name: 'Existing User',
  authProvider: 'EMAIL',
  passwordHash: 'bcrypt-hashed-password'
}

const mockOAuthAttempt = {
  provider: 'google',
  email: 'test@example.com',  // 相同邮箱
  name: 'OAuth User',
  image: 'https://...'
}
```

**Notes**: 这是 **最关键** 的测试场景，必须 100% 通过

---

#### 1.5-INT-018: OAuth 回调 URL 验证（拒绝非授权域名）

**Test Level**: Integration  
**Priority**: P0  
**Description**: **CRITICAL** - 验证 OAuth 回调 URL 白名单，防止回调劫持

**Preconditions**:
- NEXTAUTH_URL 配置为 `https://docqa-system.vercel.app`
- Google/GitHub OAuth 应用配置了正确的回调 URL

**Test Steps**:
1. 尝试使用非授权的回调 URL: `https://attacker.com/api/auth/callback/google`
2. 发起 OAuth 授权请求
3. 验证 NextAuth 的处理

**Expected Results**:
- OAuth 回调被拒绝
- 返回错误或重定向到错误页
- 不创建 Session
- 日志记录可疑活动

**Risk Mitigation**: SEC-001 (Critical Risk)

**Test Approach**:
```typescript
// 在集成测试中验证 NextAuth 配置
describe('OAuth Callback URL Security', () => {
  it('should reject callback from unauthorized domain', async () => {
    const unauthorizedCallback = 'https://attacker.com/callback'
    
    // 尝试触发回调
    const result = await fetch('/api/auth/callback/google', {
      method: 'GET',
      headers: { 'Referer': unauthorizedCallback }
    })
    
    expect(result.status).toBe(400) // Bad Request
    expect(await result.text()).toContain('Invalid callback URL')
  })
})
```

**Manual Verification**:
1. 在 Google Cloud Console 检查 Authorized redirect URIs
2. 确认只包含: `https://docqa-system.vercel.app/api/auth/callback/google`
3. 在 GitHub OAuth App 检查 Authorization callback URL
4. 确认只包含: `https://docqa-system.vercel.app/api/auth/callback/github`

---

#### 1.5-PERF-001: OAuth 回调处理时间 < 500ms

**Test Level**: Integration  
**Priority**: P0  
**Description**: 验证 signIn 回调的性能满足要求

**Preconditions**:
- 测试数据库可用
- Mock OAuth Provider API

**Test Steps**:
1. Mock Google/GitHub OAuth 响应
2. 记录开始时间
3. 调用 signIn 回调处理逻辑
4. 记录结束时间
5. 计算处理时间

**Expected Results**:
- P50: < 200ms
- P95: < 500ms
- P99: < 800ms

**Performance Optimization Points**:
- 数据库查询使用 email 索引
- 使用 upsert 代替 select + insert/update
- 避免同步阻塞操作

**Risk Mitigation**: PERF-001

---

### Core Functionality Tests (P1)

#### 1.5-E2E-001: 完整 Google OAuth 登录流程（真实测试账号）

**Test Level**: E2E  
**Priority**: P0  
**Description**: 使用真实 Google 测试账号验证完整 OAuth 流程

**Preconditions**:
- 测试环境配置了真实的 Google OAuth 凭据
- 有专用的 Google 测试账号（test-oauth@gmail.com）

**Test Steps**:
1. 访问登录页 `/login`
2. 点击"使用 Google 登录"按钮
3. 验证重定向到 Google 授权页
4. 使用测试账号登录 Google
5. 授权应用访问
6. 验证回调到应用
7. 验证重定向到 Dashboard
8. 验证 Dashboard 显示用户信息和头像

**Expected Results**:
- 完整流程无错误
- 用户成功登录
- Dashboard 显示 Google 头像
- 数据库中用户记录正确
- Session 正常工作

**Test Duration**: ~30-60 seconds

**Notes**: 
- 可以使用 Playwright 自动化
- 需要处理 Google 的 CAPTCHA（测试环境可能需要特殊配置）

---

#### 1.5-INT-009: 已存在用户 OAuth 登录时更新头像

**Test Level**: Integration  
**Priority**: P0  
**Description**: 验证已存在 OAuth 用户再次登录时头像更新逻辑

**Preconditions**:
- 数据库中已存在 Google OAuth 用户
- 用户旧头像 URL: `https://old-avatar.com/avatar.jpg`

**Test Steps**:
1. 创建现有用户记录
2. Mock Google OAuth 返回新头像 URL: `https://new-avatar.com/avatar.jpg`
3. 触发 signIn 回调
4. 验证用户记录被更新

**Expected Results**:
- avatarUrl 更新为新 URL
- updatedAt 时间戳更新
- 其他字段保持不变
- 不创建新用户记录

**Test Data**:
```typescript
const existingUser = {
  id: 'user_123',
  email: 'existing@gmail.com',
  authProvider: 'GOOGLE',
  avatarUrl: 'https://old-avatar.com/avatar.jpg',
  createdAt: '2025-01-01T00:00:00Z'
}

const updatedOAuthInfo = {
  email: 'existing@gmail.com',
  image: 'https://new-avatar.com/avatar.jpg'  // 新头像
}
```

---

### Edge Cases & Error Handling (P1-P2)

#### 1.5-INT-003: Google OAuth 授权被用户取消时的处理

**Test Level**: Integration  
**Priority**: P1  
**Description**: 验证用户取消 OAuth 授权时的错误处理

**Test Steps**:
1. 发起 Google OAuth 授权
2. Mock 用户点击"取消"
3. 验证回调处理

**Expected Results**:
- 返回登录页
- URL 包含 `error=OAuthCallback` 参数
- 显示友好提示: "您已取消授权，请使用其他方式登录"
- 不创建用户记录

---

#### 1.5-INT-016: 头像 URL 无效时显示 fallback

**Test Level**: Integration  
**Priority**: P1  
**Description**: 验证头像加载失败时的降级逻辑

**Test Steps**:
1. 创建 OAuth 用户，avatarUrl 为无效 URL
2. 渲染 Dashboard Avatar 组件
3. 验证 fallback 显示

**Expected Results**:
- 显示用户名首字母作为头像
- 背景色和文字颜色符合 UI 规范
- 不影响页面其他部分渲染

---

## Test Coverage Analysis

### By Acceptance Criteria

| AC | Description                        | Test Scenarios | Coverage |
|----|------------------------------------|----------------|----------|
| AC1 | NextAuth OAuth Provider 配置       | 4              | Full     |
| AC2 | Google OAuth 集成                  | 6              | Full     |
| AC3 | GitHub OAuth 集成                  | 6              | Full     |
| AC4 | OAuth 用户自动创建与关联            | 12             | Full     |
| AC5 | UI/UX 实现                         | 4              | Full     |
| AC6 | 头像存储与显示                      | 5              | Full     |
| AC7 | 错误处理与安全                      | 3              | Full     |

**Total**: 40 test scenarios covering 7 ACs → **100% AC coverage**

---

### By Test Level

**Unit Tests (8 scenarios)**:
- NextAuth 配置验证 (4)
- signIn 回调业务逻辑 (4)

**Integration Tests (20 scenarios)**:
- OAuth 流程验证 (8)
- 用户数据管理 (4)
- 安全和错误处理 (3)
- UI 组件渲染 (2)
- 性能测试 (1)
- 头像处理 (2)

**E2E Tests (9 scenarios)**:
- 完整 OAuth 流程 (2)
- 用户体验验证 (4)
- 跨浏览器测试 (3)

---

### By Priority

**P0 (Critical Path - 12 scenarios)**:
- OAuth 核心流程 (4)
- 用户创建逻辑 (4)
- 安全验证 (3)
- 性能要求 (1)

**P1 (Core Functionality - 10 scenarios)**:
- 错误处理 (4)
- 头像管理 (3)
- UI/UX (3)

**P2 (Edge Cases - 6 scenarios)**:
- 跨浏览器 (3)
- 边缘情况 (3)

---

### Coverage Gaps

**None identified** - All ACs have corresponding test scenarios at appropriate levels.

**Additional Recommendations**:
- ⚠️ 考虑添加负载测试（并发 OAuth 登录）
- ⚠️ 考虑添加 Chaos Engineering 测试（模拟 OAuth Provider 间歇性失败）

---

## Test Execution Strategy

### Phase 1: Unit Tests (Day 1 - 2 hours)

**Execution Order**:
1. 配置验证测试 (1.5-UNIT-001 to 004)
2. signIn 回调逻辑测试 (1.5-UNIT-005 to 008)

**Exit Criteria**: 所有 8 个 Unit Tests 通过

---

### Phase 2: Integration Tests (Day 1-2 - 4 hours)

**Execution Order** (按风险优先级):
1. **Critical Security Tests**:
   - 1.5-INT-018: OAuth 回调 URL 验证
   - 1.5-INT-019: CSRF Token 验证
   - 1.5-SEC-001: NEXTAUTH_SECRET 强度

2. **Critical Data Tests**:
   - 1.5-INT-010: 邮箱冲突验证（DATA-001）
   - 1.5-INT-009: 头像更新逻辑

3. **Core OAuth Flow Tests**:
   - 1.5-INT-001: Google OAuth 流程
   - 1.5-INT-005: GitHub OAuth 流程

4. **Performance Tests**:
   - 1.5-PERF-001: OAuth 回调性能

5. **Error Handling Tests**:
   - 剩余的集成测试

**Exit Criteria**: 所有 P0 和 P1 Integration Tests 通过

---

### Phase 3: E2E Tests (Day 2 - 3 hours)

**Execution Order**:
1. **真实 OAuth 流程**:
   - 1.5-E2E-001: Google OAuth（真实测试账号）
   - 1.5-E2E-003: GitHub OAuth（真实测试账号）

2. **用户体验验证**:
   - 1.5-E2E-002/004: 头像显示
   - 1.5-E2E-005: 加载状态

3. **跨浏览器测试** (可选，P2):
   - Chrome, Safari, Firefox

**Exit Criteria**: 所有 P0 和 P1 E2E Tests 通过

---

### Phase 4: Manual Security Audit (Day 2 - 1 hour)

**Manual Checks**:
1. 审查 Google Cloud Console OAuth 配置
2. 审查 GitHub OAuth App 配置
3. 验证 Vercel 环境变量设置
4. 检查代码中是否有硬编码 Secret
5. 验证 .gitignore 排除敏感文件

---

## Test Environment Requirements

### Development Environment

- Node.js 20.x
- Next.js 14.x
- NextAuth.js 5.x
- 测试数据库（PostgreSQL）
- Mock OAuth Provider APIs

### Testing Tools

- **Unit/Integration**: Jest + React Testing Library
- **E2E**: Playwright
- **Performance**: Jest Performance Tests
- **Security**: Manual Audit + git-secrets

### Test Data

**Test Accounts**:
- Google 测试账号: `test-oauth-docqa@gmail.com`
- GitHub 测试账号: `docqa-test-user`

**Test Database**:
- 使用独立测试数据库
- 每次测试前清空并重新初始化

---

## Test Data Management

### Mock OAuth Responses

#### Google OAuth Mock Data

```typescript
export const mockGoogleOAuthSuccess = {
  account: {
    provider: 'google',
    type: 'oauth',
    providerAccountId: 'google-123456',
  },
  user: {
    email: 'test@gmail.com',
    name: 'Test User',
    image: 'https://lh3.googleusercontent.com/a/test-avatar',
  },
  profile: {
    sub: 'google-123456',
    email: 'test@gmail.com',
    email_verified: true,
    name: 'Test User',
    picture: 'https://lh3.googleusercontent.com/a/test-avatar',
  }
}

export const mockGoogleOAuthCancel = {
  error: 'OAuthCallback',
  error_description: 'User canceled authorization'
}
```

#### GitHub OAuth Mock Data

```typescript
export const mockGitHubOAuthSuccess = {
  account: {
    provider: 'github',
    type: 'oauth',
    providerAccountId: 'github-789012',
  },
  user: {
    email: 'test@github.com',
    name: 'GitHub Test User',
    image: 'https://avatars.githubusercontent.com/u/test',
  },
  profile: {
    id: 'github-789012',
    email: 'test@github.com',
    name: 'GitHub Test User',
    avatar_url: 'https://avatars.githubusercontent.com/u/test',
  }
}
```

---

## Risk-Based Test Prioritization

### Critical Risks → P0 Tests

| Risk ID  | Test Scenarios                           | Must Pass |
|----------|------------------------------------------|-----------|
| DATA-001 | 1.5-INT-010                              | YES       |
| SEC-001  | 1.5-INT-018, 1.5-INT-019, 1.5-SEC-001   | YES       |
| TECH-001 | 1.5-INT-001, 1.5-INT-005                 | YES       |
| PERF-001 | 1.5-PERF-001                             | YES       |

**Deployment Blocker**: 如果任何 P0 测试失败，不能部署到生产环境

---

### High Risks → P1 Tests

| Risk ID  | Test Scenarios                           | Recommendation |
|----------|------------------------------------------|----------------|
| SEC-002  | Manual Security Audit                    | Should Pass    |
| OPS-001  | 1.5-UNIT-003, Manual Config Check        | Should Pass    |
| PERF-002 | 1.5-E2E-005, 1.5-PERF-002               | Nice to Have   |

---

## Test Automation Strategy

### Unit Tests (100% Automated)

```bash
npm run test:unit -- tests/unit/api/oauth.test.ts
```

**Target Coverage**: 100% for signIn callback logic

---

### Integration Tests (100% Automated)

```bash
npm run test:integration -- tests/integration/oauth-flow.test.ts
```

**Mock Strategy**:
- Mock Google/GitHub OAuth API responses
- Mock database in isolated test environment
- Use Supertest for API endpoint testing

---

### E2E Tests (90% Automated)

```bash
npm run test:e2e -- tests/e2e/oauth-login.spec.ts
```

**Automation Approach**:
- Playwright for browser automation
- 使用真实测试账号（需要维护凭据）
- 处理 Google/GitHub 登录页面交互

**Manual Fallback**:
- 跨浏览器测试可以手动执行（P2）

---

## Success Criteria

### Definition of Success

- ✅ 所有 P0 测试 100% 通过
- ✅ 所有 P1 测试 ≥ 95% 通过
- ✅ P2 测试 ≥ 80% 通过
- ✅ 测试覆盖率: AC 覆盖 100%, 代码覆盖 ≥ 80%
- ✅ 所有 Critical Risks 对应的测试通过
- ✅ 性能测试满足要求（OAuth 回调 < 500ms）
- ✅ 安全审计通过（无 Secret 泄露）

---

## Test Schedule

| Day | Phase                  | Duration | Owner |
|-----|------------------------|----------|-------|
| 1   | Unit Tests             | 2h       | Dev   |
| 1   | Integration Tests (P0) | 3h       | Dev   |
| 2   | Integration Tests (P1) | 2h       | Dev   |
| 2   | E2E Tests (P0)         | 2h       | QA    |
| 2   | Manual Security Audit  | 1h       | QA    |
| 2   | E2E Tests (P1-P2)      | 2h       | QA    |

**Total**: ~12 hours testing effort

---

## Appendix: Sample Test Code

### Unit Test Example

```typescript
// tests/unit/api/oauth.test.ts
import { signInCallback } from '@/app/api/auth/[...nextauth]/route'
import { db } from '@/lib/db'

describe('OAuth signIn Callback', () => {
  beforeEach(async () => {
    await db.delete(users).execute()
  })

  it('should create new user for first-time Google login', async () => {
    const result = await signInCallback({
      user: mockGoogleOAuthSuccess.user,
      account: mockGoogleOAuthSuccess.account,
      profile: mockGoogleOAuthSuccess.profile,
    })

    expect(result).toBe(true)

    const user = await db.query.users.findFirst({
      where: eq(users.email, 'test@gmail.com')
    })

    expect(user).toBeDefined()
    expect(user.authProvider).toBe('GOOGLE')
    expect(user.passwordHash).toBeNull()
    expect(user.avatarUrl).toBe('https://lh3.googleusercontent.com/a/test-avatar')
  })

  it('should reject OAuth login when EMAIL user with same email exists', async () => {
    // 先创建 EMAIL 用户
    await db.insert(users).values({
      email: 'test@gmail.com',
      name: 'Email User',
      authProvider: 'EMAIL',
      passwordHash: 'hashed-password',
    })

    // 尝试 Google OAuth 登录
    await expect(
      signInCallback({
        user: mockGoogleOAuthSuccess.user,
        account: mockGoogleOAuthSuccess.account,
        profile: mockGoogleOAuthSuccess.profile,
      })
    ).rejects.toThrow('此邮箱已使用邮箱密码注册')
  })
})
```

---

### Integration Test Example

```typescript
// tests/integration/oauth-flow.test.ts
import { POST } from '@/app/api/auth/[...nextauth]/route'

describe('OAuth Authentication Flow', () => {
  it('should complete Google OAuth flow with mocked provider', async () => {
    // Mock Google OAuth API
    vi.mock('next-auth/providers/google', () => ({
      default: vi.fn(() => ({
        authorize: async () => mockGoogleOAuthSuccess.user
      }))
    }))

    // Simulate OAuth callback
    const response = await POST(
      new Request('http://localhost:3000/api/auth/callback/google', {
        method: 'POST',
        body: JSON.stringify({
          code: 'mock-auth-code',
          state: 'mock-state',
        })
      })
    )

    expect(response.status).toBe(200)
    
    // Verify user created
    const user = await db.query.users.findFirst({
      where: eq(users.email, 'test@gmail.com')
    })
    expect(user).toBeDefined()
  })
})
```

---

### E2E Test Example

```typescript
// tests/e2e/oauth-login.spec.ts
import { test, expect } from '@playwright/test'

test('Complete Google OAuth login flow', async ({ page }) => {
  // 访问登录页
  await page.goto('http://localhost:3000/login')

  // 点击 Google OAuth 按钮
  await page.click('button:has-text("使用 Google 登录")')

  // 等待重定向到 Google
  await expect(page).toHaveURL(/accounts\.google\.com/)

  // 使用测试账号登录（需要真实凭据）
  await page.fill('input[type="email"]', 'test-oauth-docqa@gmail.com')
  await page.click('button:has-text("下一步")')
  await page.fill('input[type="password"]', process.env.TEST_GOOGLE_PASSWORD!)
  await page.click('button:has-text("下一步")')

  // 如果需要，授权应用
  if (await page.locator('button:has-text("允许")').isVisible()) {
    await page.click('button:has-text("允许")')
  }

  // 验证重定向回应用
  await expect(page).toHaveURL('http://localhost:3000/dashboard')

  // 验证用户头像显示
  const avatar = page.locator('img[alt*="Test"]')
  await expect(avatar).toBeVisible()
})
```

---

## Conclusion

这份测试设计为 Story 1.5 OAuth 集成提供了全面的测试策略：

**强项**:
- ✅ 100% AC 覆盖
- ✅ 风险驱动优先级
- ✅ 多级别测试（Unit + Integration + E2E）
- ✅ Critical Risks 有对应的 P0 测试

**关键测试场景**:
1. **DATA-001 测试**: 邮箱冲突验证（必须通过）
2. **SEC-001 测试**: OAuth 回调 URL 安全（必须通过）
3. **完整 OAuth 流程**: Google + GitHub E2E 测试

**预计测试工作量**: 12 hours (Dev 7h + QA 5h)

**部署门槛**: 所有 P0 测试必须通过 ✅


