# Test Design: Story 2.5 - 文档列表与管理

**Date**: 2025-01-05  
**Designer**: Quinn (Test Architect)  
**Story**: 2.5 - 文档列表与管理  
**Epic**: 2 - 文档管理与解析

---

## Test Strategy Overview

- **Total test scenarios**: 68
- **Unit tests**: 28 (41%)
- **Integration tests**: 25 (37%)
- **E2E tests**: 15 (22%)
- **Priority distribution**: P0: 32, P1: 24, P2: 12

### Test Philosophy

This story has **high complexity** with 10 acceptance criteria covering UI, API, data management, and performance. Testing strategy focuses on:

1. **Security First**: Authorization and cascade delete scenarios (P0)
2. **Data Integrity**: Ensure no orphaned data after operations (P0)
3. **User Experience**: Real-time updates, loading states, error handling (P0-P1)
4. **Performance**: Meet latency and throughput targets (P1)
5. **Responsive Design**: Multi-device compatibility (P1-P2)

### Risk-Based Testing Alignment

Based on risk profile 2.5-risk-20250105.md:
- **Critical risks** (SEC-001, SEC-002): 15 P0 tests
- **High risks** (PERF-001, DATA-001, TECH-001): 12 P0 tests
- **Medium/Low risks**: P1-P2 tests

---

## Test Scenarios by Acceptance Criteria

### AC1: 文档列表页面展示 (Document List Display)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.5-UNIT-001 | Unit | P0 | DocumentCard renders with all document properties | Pure rendering logic, no external dependencies |
| 2.5-UNIT-002 | Unit | P0 | File type icon mapping (PDF/Word/Markdown/TXT) | Pure function, fast feedback |
| 2.5-UNIT-003 | Unit | P0 | File size formatting (bytes to MB/KB) | Pure formatting logic |
| 2.5-UNIT-004 | Unit | P0 | Relative time formatting with date-fns | Pure date formatting |
| 2.5-UNIT-005 | Unit | P1 | Empty state displays when no documents | UI component state |
| 2.5-UNIT-006 | Unit | P1 | Loading state displays skeleton grid | UI loading state |
| 2.5-INT-001 | Integration | P0 | GET /api/documents returns user's documents only | Multi-component: Auth + DB query |
| 2.5-INT-002 | Integration | P0 | Documents ordered by uploadedAt DESC by default | DB query with ordering |
| 2.5-INT-003 | Integration | P1 | DocumentList fetches and displays documents via useDocuments | React Hook + API integration |
| 2.5-E2E-001 | E2E | P0 | User visits /documents and sees their uploaded documents | Critical user journey |

**Coverage Summary**: All AC1 requirements covered (10 tests: 6 unit, 3 integration, 1 e2e)

---

### AC2: 文档状态实时显示 (Real-time Status Display)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.5-UNIT-007 | Unit | P0 | DocumentStatusBadge renders PENDING with gray badge | Pure rendering |
| 2.5-UNIT-008 | Unit | P0 | DocumentStatusBadge renders PARSING with blue badge + spinner | Pure rendering |
| 2.5-UNIT-009 | Unit | P0 | DocumentStatusBadge renders EMBEDDING with purple badge + spinner | Pure rendering |
| 2.5-UNIT-010 | Unit | P0 | DocumentStatusBadge renders READY with green badge | Pure rendering |
| 2.5-UNIT-011 | Unit | P0 | DocumentStatusBadge renders FAILED with red badge | Pure rendering |
| 2.5-UNIT-012 | Unit | P1 | useDocuments configures SWR with 5s refreshInterval | Hook configuration logic |
| 2.5-UNIT-013 | Unit | P1 | useDocuments only polls when processing documents exist | Conditional polling logic (mitigates PERF-001) |
| 2.5-INT-004 | Integration | P1 | SWR automatically refetches processing documents every 5s | Data fetching behavior |
| 2.5-INT-005 | Integration | P1 | Toast notification appears on status change | UI feedback integration |
| 2.5-E2E-002 | E2E | P1 | User sees status change from PARSING to READY in real-time | End-to-end polling flow |

**Coverage Summary**: All AC2 requirements covered (10 tests: 7 unit, 2 integration, 1 e2e)

**Risk Mitigation**: PERF-001 (Polling) - 2.5-UNIT-013 verifies conditional polling

---

### AC3: 搜索功能 (Search Functionality)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.5-UNIT-014 | Unit | P0 | DocumentSearchBar applies debounce (300ms) to search input | Pure debounce logic |
| 2.5-UNIT-015 | Unit | P1 | Search clear button resets search term | UI interaction |
| 2.5-INT-006 | Integration | P0 | GET /api/documents?search=keyword filters by filename LIKE | API + DB query |
| 2.5-INT-007 | Integration | P1 | Search returns empty array when no matches | Edge case handling |
| 2.5-INT-008 | Integration | P2 | Search with special characters is safely escaped | SQL injection prevention |
| 2.5-E2E-003 | E2E | P0 | User types search term, sees filtered results in real-time | Critical search journey |
| 2.5-E2E-004 | E2E | P1 | Search highlights matched keywords in results | UX enhancement |

**Coverage Summary**: All AC3 requirements covered (7 tests: 2 unit, 3 integration, 2 e2e)

**Performance Test**: PERF-002 (Search) covered by integration tests

---

### AC4: 重命名功能 (Rename Functionality)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.5-UNIT-016 | Unit | P0 | Filename validation rejects empty string | Pure validation logic |
| 2.5-UNIT-017 | Unit | P0 | Filename validation rejects special chars `/\:*?"<>|` | Security validation |
| 2.5-UNIT-018 | Unit | P0 | Filename validation enforces 1-255 char limit | Validation logic |
| 2.5-UNIT-019 | Unit | P1 | Rename dialog preserves file extension | UI logic |
| 2.5-INT-009 | Integration | P0 | PATCH /api/documents/:id updates filename in DB | API + DB update |
| 2.5-INT-010 | Integration | P0 | PATCH validates document ownership before rename (SEC-002) | Authorization check |
| 2.5-INT-011 | Integration | P0 | PATCH returns 404 for non-existent document | Error handling |
| 2.5-INT-012 | Integration | P0 | User A cannot rename User B's document (SEC-002) | Cross-user security |
| 2.5-INT-013 | Integration | P1 | SWR optimistically updates filename in UI | Cache update |
| 2.5-E2E-005 | E2E | P0 | User renames document, new name displays immediately | Critical rename journey |
| 2.5-E2E-006 | E2E | P1 | Rename shows validation error for invalid filename | Error handling UX |

**Coverage Summary**: All AC4 requirements covered (11 tests: 4 unit, 5 integration, 2 e2e)

**Risk Mitigation**: SEC-002 (Authorization) - Tests 2.5-INT-010, 2.5-INT-012; SEC-003 (Injection) - Test 2.5-UNIT-017

---

### AC5: 删除功能 (Delete Functionality)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.5-UNIT-020 | Unit | P1 | Delete dialog displays warning and file info | UI component rendering |
| 2.5-INT-014 | Integration | P0 | DELETE /api/documents/:id validates ownership (SEC-002) | Authorization check |
| 2.5-INT-015 | Integration | P0 | DELETE cascades: vectors → storage → DB (SEC-001) | Critical cascade delete |
| 2.5-INT-016 | Integration | P0 | DELETE rollback on vector deletion failure (SEC-001) | Failure recovery |
| 2.5-INT-017 | Integration | P0 | DELETE rollback on storage deletion failure (SEC-001) | Failure recovery |
| 2.5-INT-018 | Integration | P0 | DELETE retries transient failures up to 3 times (SEC-001) | Resilience |
| 2.5-INT-019 | Integration | P0 | DELETE removes all document_chunks records | DB cascade |
| 2.5-INT-020 | Integration | P0 | DELETE removes file from Supabase Storage | Storage cleanup |
| 2.5-INT-021 | Integration | P0 | User A cannot delete User B's document (SEC-002) | Cross-user security |
| 2.5-INT-022 | Integration | P0 | DELETE leaves no orphaned vectors (DATA-001) | Data integrity |
| 2.5-INT-023 | Integration | P1 | SWR optimistically removes document from UI | Cache update |
| 2.5-INT-024 | Integration | P1 | DELETE updates document count in UI | UI state update |
| 2.5-E2E-007 | E2E | P0 | User deletes document, confirms, document disappears | Critical delete journey |
| 2.5-E2E-008 | E2E | P1 | Delete shows error toast if operation fails | Error handling UX |

**Coverage Summary**: All AC5 requirements covered (14 tests: 1 unit, 11 integration, 2 e2e)

**Risk Mitigation**: 
- SEC-001 (Cascade Delete) - Tests 2.5-INT-015 to 2.5-INT-018, 2.5-INT-022
- SEC-002 (Authorization) - Tests 2.5-INT-014, 2.5-INT-021
- DATA-001 (Orphaned Data) - Test 2.5-INT-022

---

### AC6: 分页功能 (Pagination)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.5-UNIT-021 | Unit | P1 | Pagination component disables prev on page 1 | UI state logic |
| 2.5-UNIT-022 | Unit | P1 | Pagination component disables next on last page | UI state logic |
| 2.5-INT-025 | Integration | P0 | GET /api/documents?page=1&limit=20 returns first 20 docs | API pagination |
| 2.5-INT-026 | Integration | P0 | GET /api/documents returns correct totalPages count | Pagination metadata |
| 2.5-INT-027 | Integration | P1 | Pagination state persists in URL query params | URL state management |
| 2.5-E2E-009 | E2E | P1 | User navigates through pages, URL updates correctly | Pagination journey |
| 2.5-E2E-010 | E2E | P2 | Page scroll to top on pagination change | UX enhancement |

**Coverage Summary**: All AC6 requirements covered (7 tests: 2 unit, 3 integration, 2 e2e)

---

### AC7: 排序功能 (Sorting)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.5-INT-028 | Integration | P0 | GET /api/documents?sortBy=uploadedAt&order=desc (default) | Default sort |
| 2.5-INT-029 | Integration | P1 | GET /api/documents?sortBy=filename&order=asc sorts A-Z | Filename sorting |
| 2.5-INT-030 | Integration | P1 | GET /api/documents?sortBy=fileSize&order=desc sorts largest first | Size sorting |
| 2.5-INT-031 | Integration | P1 | GET /api/documents?sortBy=status prioritizes READY | Status sorting |
| 2.5-INT-032 | Integration | P1 | Sort state persists in URL query params | URL state management |
| 2.5-E2E-011 | E2E | P1 | User changes sort option, list reorders correctly | Sort journey |

**Coverage Summary**: All AC7 requirements covered (6 tests: 0 unit, 5 integration, 1 e2e)

---

### AC8: 文档预览 (Document Preview)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.5-UNIT-023 | Unit | P1 | DocumentPreviewModal shows loading skeleton initially | UI loading state |
| 2.5-UNIT-024 | Unit | P0 | DocumentPreviewModal falls back to download on PDF error (TECH-001) | Error handling |
| 2.5-UNIT-025 | Unit | P1 | Preview renders markdown content with react-markdown | Content rendering |
| 2.5-INT-033 | Integration | P0 | GET /api/documents/:id/preview validates ownership (SEC-002) | Authorization |
| 2.5-INT-034 | Integration | P0 | Preview returns content from metadata.parsedContent | Data retrieval |
| 2.5-INT-035 | Integration | P1 | Preview truncates content to 500 chars | Performance optimization |
| 2.5-INT-036 | Integration | P1 | Preview returns 400 if document not READY | Status validation |
| 2.5-INT-037 | Integration | P2 | Preview handles different file types (PDF/Word/MD/TXT) | Multi-format support |
| 2.5-E2E-012 | E2E | P1 | User clicks preview, sees document content in modal | Preview journey |
| 2.5-E2E-013 | E2E | P1 | Preview shows download link for unsupported formats | Fallback UX |

**Coverage Summary**: All AC8 requirements covered (10 tests: 3 unit, 5 integration, 2 e2e)

**Risk Mitigation**: 
- TECH-001 (React-PDF) - Test 2.5-UNIT-024
- SEC-002 (Authorization) - Test 2.5-INT-033

---

### AC9: 性能要求 (Performance Requirements)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.5-INT-038 | Integration | P0 | GET /api/documents completes in <1s with 20 documents | Performance SLA |
| 2.5-INT-039 | Integration | P0 | Search response time <300ms (client-side filtering) | Performance SLA |
| 2.5-INT-040 | Integration | P0 | DELETE operation completes in <2s | Performance SLA |
| 2.5-INT-041 | Integration | P1 | Preview opens in <1s | Performance SLA |
| 2.5-INT-042 | Integration | P1 | SWR cache reduces redundant API calls | Caching effectiveness |
| 2.5-E2E-014 | E2E | P0 | Initial page load <1s (20 docs) | End-to-end performance |

**Coverage Summary**: All AC9 requirements covered (6 tests: 0 unit, 5 integration, 1 e2e)

**Note**: Performance tests use real timing assertions, not just functional validation.

---

### AC10: 响应式设计 (Responsive Design)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.5-UNIT-026 | Unit | P1 | DocumentList grid renders 3 columns on desktop (≥1024px) | Responsive layout |
| 2.5-UNIT-027 | Unit | P1 | DocumentList grid renders 2 columns on tablet (768-1023px) | Responsive layout |
| 2.5-UNIT-028 | Unit | P1 | DocumentList renders 1 column on mobile (≤767px) | Responsive layout |
| 2.5-E2E-015 | E2E | P2 | Dialogs display fullscreen on mobile devices | Mobile UX |

**Coverage Summary**: All AC10 requirements covered (4 tests: 3 unit, 0 integration, 1 e2e)

---

## Test Scenario Details (Key Tests)

### Critical Security Tests

#### 2.5-INT-015: CASCADE DELETE (P0, SEC-001)

**Given**: User has uploaded document with 10 chunks and vectors  
**When**: DELETE /api/documents/:id is called  
**Then**:
- Step 1: All 10 vectors deleted from pgvector
- Step 2: File deleted from Supabase Storage
- Step 3: 10 document_chunks records deleted from DB
- Step 4: Document record deleted from DB
- Step 5: Verify no orphaned data remains

**Implementation**:
```typescript
describe('DELETE /api/documents/:id - Cascade Delete', () => {
  it('should delete in correct order: vectors → storage → DB', async () => {
    // Setup: Upload and process document
    const doc = await uploadAndProcessTestDocument({
      filename: 'test.pdf',
      chunks: 10
    })
    
    // Verify setup
    expect(await countVectors(doc.id)).toBe(10)
    expect(await checkStorageExists(doc.storagePath)).toBe(true)
    expect(await countChunks(doc.id)).toBe(10)
    
    // Act: Delete document
    const response = await authenticatedDelete(`/api/documents/${doc.id}`)
    
    // Assert: All traces removed
    expect(response.status).toBe(200)
    expect(await countVectors(doc.id)).toBe(0)
    expect(await checkStorageExists(doc.storagePath)).toBe(false)
    expect(await countChunks(doc.id)).toBe(0)
    expect(await findDocument(doc.id)).toBeNull()
  })
})
```

---

#### 2.5-INT-016: DELETE ROLLBACK ON VECTOR FAILURE (P0, SEC-001)

**Given**: Vector service experiences transient failure  
**When**: DELETE is called and vector deletion fails  
**Then**: 
- Operation should rollback
- Document remains in DB
- No partial deletion occurs
- Error is logged

**Implementation**:
```typescript
it('should rollback on vector deletion failure', async () => {
  // Setup: Mock vector service failure
  mockVectorRepo.deleteBatch.mockRejectedValue(new Error('Vector service timeout'))
  
  const doc = await uploadAndProcessTestDocument()
  const initialState = await captureDocumentState(doc.id)
  
  // Act: Attempt delete
  const response = await authenticatedDelete(`/api/documents/${doc.id}`)
  
  // Assert: Operation failed but data intact
  expect(response.status).toBe(500)
  expect(await findDocument(doc.id)).toBeDefined()
  expect(await countChunks(doc.id)).toBe(initialState.chunksCount)
  expect(await checkStorageExists(doc.storagePath)).toBe(true)
  
  // Assert: Error logged
  expect(mockLogger.error).toHaveBeenCalledWith(
    expect.stringContaining('Delete failed'),
    expect.objectContaining({ documentId: doc.id })
  )
})
```

---

#### 2.5-INT-012: CROSS-USER AUTHORIZATION (P0, SEC-002)

**Given**: User A and User B both have documents  
**When**: User A attempts to rename User B's document  
**Then**: 
- Request returns 404 (not 403, to avoid leaking existence)
- No changes occur
- Attempt is logged

**Implementation**:
```typescript
describe('Authorization - Cross-User Access Prevention', () => {
  it('should prevent User A from renaming User B document', async () => {
    // Setup: Create two users with documents
    const userA = await createTestUser('userA@test.com')
    const userB = await createTestUser('userB@test.com')
    const docB = await uploadDocument(userB, 'userB-doc.pdf')
    
    // Act: User A tries to rename B's document
    const response = await fetch(`/api/documents/${docB.id}`, {
      method: 'PATCH',
      headers: { 
        'Authorization': `Bearer ${userA.token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ filename: 'hacked.pdf' })
    })
    
    // Assert: Access denied
    expect(response.status).toBe(404) // Not 403 - don't leak existence
    
    // Assert: Document unchanged
    const unchanged = await findDocument(docB.id)
    expect(unchanged.filename).toBe('userB-doc.pdf')
    
    // Assert: Attempt logged
    expect(mockSecurityLogger.warn).toHaveBeenCalledWith(
      'Unauthorized document access attempt',
      expect.objectContaining({ 
        userId: userA.id, 
        documentId: docB.id 
      })
    )
  })
  
  it('should prevent User A from deleting User B document', async () => {
    const userA = await createTestUser('userA@test.com')
    const userB = await createTestUser('userB@test.com')
    const docB = await uploadDocument(userB, 'userB-doc.pdf')
    
    const response = await fetch(`/api/documents/${docB.id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${userA.token}` }
    })
    
    expect(response.status).toBe(404)
    expect(await findDocument(docB.id)).toBeDefined()
  })
  
  it('should prevent User A from previewing User B document', async () => {
    const userA = await createTestUser('userA@test.com')
    const userB = await createTestUser('userB@test.com')
    const docB = await uploadDocument(userB, 'userB-doc.pdf')
    
    const response = await fetch(`/api/documents/${docB.id}/preview`, {
      headers: { 'Authorization': `Bearer ${userA.token}` }
    })
    
    expect(response.status).toBe(404)
  })
})
```

---

### Critical Performance Tests

#### 2.5-INT-038: API RESPONSE TIME (P0, AC9)

**Given**: Database has 20 documents for user  
**When**: GET /api/documents is called  
**Then**: Response completes in <1s

**Implementation**:
```typescript
describe('Performance - API Response Time', () => {
  beforeEach(async () => {
    await seedDocuments(testUser, 20)
  })
  
  it('should return 20 documents in <1s', async () => {
    const start = Date.now()
    
    const response = await authenticatedGet('/api/documents')
    
    const duration = Date.now() - start
    
    expect(response.status).toBe(200)
    expect(response.body.documents).toHaveLength(20)
    expect(duration).toBeLessThan(1000) // <1s
  })
  
  it('should maintain performance with sorting', async () => {
    const start = Date.now()
    
    const response = await authenticatedGet(
      '/api/documents?sortBy=fileSize&order=desc'
    )
    
    const duration = Date.now() - start
    expect(duration).toBeLessThan(1000)
  })
  
  it('should maintain performance with search', async () => {
    const start = Date.now()
    
    const response = await authenticatedGet(
      '/api/documents?search=test'
    )
    
    const duration = Date.now() - start
    expect(duration).toBeLessThan(300) // Search is faster (client-side)
  })
})
```

---

#### 2.5-INT-040: DELETE PERFORMANCE (P0, AC9)

**Given**: Document with 50 chunks and vectors exists  
**When**: DELETE operation is executed  
**Then**: Completes in <2s

**Implementation**:
```typescript
it('should delete document with 50 chunks in <2s', async () => {
  // Setup: Large document
  const doc = await uploadAndProcessTestDocument({
    filename: 'large.pdf',
    chunks: 50
  })
  
  const start = Date.now()
  
  // Act: Delete
  const response = await authenticatedDelete(`/api/documents/${doc.id}`)
  
  const duration = Date.now() - start
  
  // Assert: Performance met
  expect(response.status).toBe(200)
  expect(duration).toBeLessThan(2000) // <2s
  
  // Assert: Cleanup complete
  expect(await countVectors(doc.id)).toBe(0)
})
```

---

### Critical Polling Tests

#### 2.5-UNIT-013: CONDITIONAL POLLING (P1, PERF-001)

**Given**: DocumentList with mixed document statuses  
**When**: useDocuments hook is called  
**Then**: Only polls if PENDING/PARSING/EMBEDDING docs exist

**Implementation**:
```typescript
describe('useDocuments Hook - Conditional Polling', () => {
  it('should NOT poll when all documents are READY', () => {
    const documents = [
      { id: '1', status: 'READY' },
      { id: '2', status: 'READY' },
      { id: '3', status: 'READY' }
    ]
    
    mockSWR.mockReturnValue({ data: { documents } })
    
    const { result } = renderHook(() => useDocuments())
    
    // Assert: No polling configured
    expect(mockSWR).toHaveBeenCalledWith(
      expect.any(String),
      expect.objectContaining({
        refreshInterval: 0 // No polling
      })
    )
  })
  
  it('should poll when documents are PARSING', () => {
    const documents = [
      { id: '1', status: 'READY' },
      { id: '2', status: 'PARSING' }, // Processing
      { id: '3', status: 'READY' }
    ]
    
    mockSWR.mockReturnValue({ data: { documents } })
    
    const { result } = renderHook(() => useDocuments())
    
    // Assert: Polling enabled
    expect(mockSWR).toHaveBeenCalledWith(
      expect.any(String),
      expect.objectContaining({
        refreshInterval: 5000 // 5s polling
      })
    )
  })
  
  it('should poll when documents are EMBEDDING', () => {
    const documents = [
      { id: '1', status: 'EMBEDDING' }
    ]
    
    mockSWR.mockReturnValue({ data: { documents } })
    
    renderHook(() => useDocuments())
    
    expect(mockSWR).toHaveBeenCalledWith(
      expect.any(String),
      expect.objectContaining({
        refreshInterval: 5000
      })
    )
  })
  
  it('should stop polling when last processing document completes', async () => {
    const { result, rerender } = renderHook(() => useDocuments())
    
    // Initial: One processing document
    mockSWR.mockReturnValue({
      data: { documents: [{ id: '1', status: 'PARSING' }] }
    })
    rerender()
    
    // Verify polling enabled
    expect(result.current.refreshInterval).toBe(5000)
    
    // Simulate status change to READY
    act(() => {
      mockSWR.mockReturnValue({
        data: { documents: [{ id: '1', status: 'READY' }] }
      })
    })
    rerender()
    
    // Verify polling disabled
    expect(result.current.refreshInterval).toBe(0)
  })
})
```

---

## Test Execution Order

### Phase 1: Security & Data Integrity (Must Pass First)

**Priority**: P0, Blocks all other testing

1. **Authorization Tests** (2.5-INT-010, 2.5-INT-012, 2.5-INT-014, 2.5-INT-021, 2.5-INT-033)
   - Cross-user access prevention
   - Ownership validation
   - ~1 hour to run

2. **Cascade Delete Tests** (2.5-INT-015 to 2.5-INT-022)
   - Delete integrity
   - Rollback scenarios
   - Retry logic
   - ~2 hours to run

**Gate**: All P0 security/data tests must pass before proceeding

---

### Phase 2: Core Functionality (Unit + Integration)

**Priority**: P0-P1, Core features

1. **Unit Tests** (2.5-UNIT-001 to 2.5-UNIT-028)
   - Pure component logic
   - Formatters, validators
   - Fast execution: ~5 minutes

2. **API Integration Tests** (2.5-INT-001 to 2.5-INT-042)
   - CRUD operations
   - Pagination, sorting, search
   - ~30 minutes to run

---

### Phase 3: User Journeys (E2E)

**Priority**: P0-P2, End-to-end validation

1. **Critical Journeys** (2.5-E2E-001, 2.5-E2E-003, 2.5-E2E-005, 2.5-E2E-007)
   - List, search, rename, delete
   - ~15 minutes

2. **Enhanced Journeys** (2.5-E2E-002, 2.5-E2E-012)
   - Real-time updates, preview
   - ~10 minutes

---

### Phase 4: Performance & Polish

**Priority**: P1-P2, Quality gates

1. **Performance Tests** (2.5-INT-038 to 2.5-INT-042)
   - Timing assertions
   - Load testing
   - ~20 minutes

2. **Responsive Design** (2.5-E2E-015)
   - Mobile viewport testing
   - ~5 minutes

---

## Coverage Validation

### Requirements Coverage Matrix

| AC | Requirement | Unit | Integration | E2E | Total | Covered |
|---|---|---|---|---|---|---|
| AC1 | List Display | 6 | 3 | 1 | 10 | ✅ |
| AC2 | Status Display | 7 | 2 | 1 | 10 | ✅ |
| AC3 | Search | 2 | 3 | 2 | 7 | ✅ |
| AC4 | Rename | 4 | 5 | 2 | 11 | ✅ |
| AC5 | Delete | 1 | 11 | 2 | 14 | ✅ |
| AC6 | Pagination | 2 | 3 | 2 | 7 | ✅ |
| AC7 | Sorting | 0 | 5 | 1 | 6 | ✅ |
| AC8 | Preview | 3 | 5 | 2 | 10 | ✅ |
| AC9 | Performance | 0 | 5 | 1 | 6 | ✅ |
| AC10 | Responsive | 3 | 0 | 1 | 4 | ✅ |

**Total Coverage**: 10/10 ACs = **100%**

### Risk Coverage Matrix

| Risk ID | Risk | Test IDs | Count |
|---|---|---|---|
| SEC-001 | Cascade Delete | 2.5-INT-015 to 2.5-INT-022 | 8 |
| SEC-002 | Authorization | 2.5-INT-010, 2.5-INT-012, 2.5-INT-014, 2.5-INT-021, 2.5-INT-033 | 5 |
| SEC-003 | Injection | 2.5-UNIT-017, 2.5-INT-008 | 2 |
| PERF-001 | Polling | 2.5-UNIT-013, 2.5-INT-004 | 2 |
| PERF-002 | Search Perf | 2.5-INT-006, 2.5-INT-038, 2.5-INT-039 | 3 |
| DATA-001 | Orphaned Data | 2.5-INT-022 | 1 |
| TECH-001 | React-PDF | 2.5-UNIT-024, 2.5-INT-037 | 2 |

**All identified risks have test coverage.**

---

## Test Data Requirements

### Test Users

```typescript
// Test fixtures
const testUsers = {
  userA: {
    email: 'user-a@test.com',
    id: 'test-user-a-id',
    name: 'Test User A'
  },
  userB: {
    email: 'user-b@test.com',
    id: 'test-user-b-id',
    name: 'Test User B'
  }
}
```

### Test Documents

```typescript
// Document fixtures with various states
const testDocuments = {
  ready: {
    filename: 'ready-doc.pdf',
    status: 'READY',
    chunksCount: 10,
    fileSize: 1024 * 1024 * 2 // 2MB
  },
  parsing: {
    filename: 'parsing-doc.pdf',
    status: 'PARSING',
    chunksCount: 0,
    fileSize: 1024 * 1024 * 5 // 5MB
  },
  failed: {
    filename: 'failed-doc.pdf',
    status: 'FAILED',
    chunksCount: 0,
    metadata: {
      error: {
        type: 'PARSE_ERROR',
        message: 'Corrupted PDF'
      }
    }
  }
}
```

### Test Files (from tests/fixtures/)

- `tests/fixtures/pdf/sample.pdf` (standard PDF)
- `tests/fixtures/pdf/scanned-image.pdf` (image-based PDF)
- `tests/fixtures/pdf/password-protected.pdf` (secured PDF)
- `tests/fixtures/docx/sample.docx` (Word document)
- `tests/fixtures/text/sample.md` (Markdown)
- `tests/fixtures/text/sample.txt` (Plain text)

---

## Mock Strategy

### API Mocks

```typescript
// Mock SWR for unit tests
jest.mock('swr', () => ({
  __esModule: true,
  default: jest.fn()
}))

// Mock next-auth for authorization tests
jest.mock('next-auth', () => ({
  auth: jest.fn()
}))

// Mock vector repository for delete tests
jest.mock('@/infrastructure/vector/vector-repository.factory', () => ({
  VectorRepositoryFactory: {
    create: jest.fn(() => ({
      deleteBatch: jest.fn().mockResolvedValue(true)
    }))
  }
}))

// Mock storage service for delete tests
jest.mock('@/services/documents/storageService', () => ({
  StorageService: {
    deleteFile: jest.fn().mockResolvedValue(true)
  }
}))
```

### Database Mocks

```typescript
// Use in-memory SQLite for integration tests
import { drizzle } from 'drizzle-orm/better-sqlite3'
import Database from 'better-sqlite3'

const testDb = new Database(':memory:')
const db = drizzle(testDb)

// Seed test data
beforeEach(async () => {
  await resetDatabase(db)
  await seedTestData(db)
})
```

---

## Test Environment Setup

### Prerequisites

- Node.js 18+
- PostgreSQL with pgvector (for integration tests)
- Test database: `doc_qa_test`
- Supabase Storage test bucket

### Environment Variables

```bash
# .env.test
DATABASE_URL=postgresql://test:test@localhost:5432/doc_qa_test
NEXTAUTH_SECRET=test-secret-key
SUPABASE_URL=http://localhost:54321
SUPABASE_SERVICE_ROLE_KEY=test-key

# Disable real API calls
OPENAI_API_KEY=sk-test-mock-key
ZHIPU_API_KEY=test-mock-key
```

### Test Commands

```bash
# Run all tests
npm test

# Run unit tests only
npm run test:unit

# Run integration tests
npm run test:integration

# Run E2E tests
npm run test:e2e

# Run with coverage
npm run test:coverage

# Run performance tests
npm run test:perf
```

---

## Acceptance Criteria Validation

### Test Coverage by Priority

**P0 Tests (32)**: Must pass for story completion
- Security: 15 tests
- Core functionality: 12 tests
- Performance: 5 tests

**P1 Tests (24)**: Should pass for quality
- Enhanced features: 14 tests
- Error handling: 6 tests
- UX polish: 4 tests

**P2 Tests (12)**: Nice to have
- Edge cases: 8 tests
- Responsive design: 4 tests

### Definition of Done (Testing Perspective)

- [ ] All P0 tests passing (32/32)
- [ ] All P1 tests passing (24/24)
- [ ] Test coverage ≥80% for new code
- [ ] All identified risks have test coverage
- [ ] Performance tests meet SLA targets
- [ ] Security tests validate authorization
- [ ] E2E tests pass on all supported browsers
- [ ] No test flakiness (3 consecutive clean runs)

---

## Continuous Integration

### CI Pipeline Stages

1. **Lint & Type Check** (2 min)
2. **Unit Tests** (5 min)
3. **Integration Tests** (30 min)
4. **E2E Tests** (25 min)
5. **Performance Tests** (20 min)
6. **Coverage Report** (2 min)

**Total CI Time**: ~84 minutes

### Test Parallelization

- Unit tests: Run in parallel (4 workers)
- Integration tests: Run in parallel (2 workers)
- E2E tests: Sequential (shared state)
- Performance tests: Sequential (accurate timing)

---

## Test Maintenance

### Test Ownership

- **Unit Tests**: Dev team maintains with components
- **Integration Tests**: Shared dev/QA ownership
- **E2E Tests**: QA team maintains
- **Performance Tests**: DevOps + QA collaboration

### Review Triggers

Review and update tests when:
1. New file types added (preview tests)
2. Performance SLAs change
3. Security requirements evolve
4. UI/UX redesign occurs
5. API contracts change

---

## Recommendations

### High Priority

1. **Implement Security Tests First**: Authorization and cascade delete are critical
2. **Set Up Test DB Early**: Integration tests need pgvector support
3. **Mock External Services**: Don't depend on real Supabase/AI APIs in tests
4. **Performance Baselines**: Establish baseline metrics before optimization

### Test Optimization

1. **Parallel Execution**: Configure Jest for parallel runs
2. **Test Fixtures**: Reuse test data to speed up setup
3. **Selective Testing**: Run only affected tests during development
4. **Snapshot Testing**: Use for UI components to detect regressions

### Coverage Goals

- **Overall**: ≥80% line coverage
- **Security Code**: 100% coverage (auth, delete)
- **API Endpoints**: 100% coverage
- **UI Components**: ≥70% coverage (focus on logic, not styling)

---

**Test Design Complete**  
**Total Test Scenarios**: 68  
**Estimated Test Development Time**: 8-10 hours  
**Estimated Test Execution Time**: 84 minutes (CI)

**Next Step**: Implement P0 tests first, then proceed with development following TDD approach where beneficial.
