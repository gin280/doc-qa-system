# Test Design: Story 4.1 - æ·»åŠ ä¸Šä¼ é€Ÿç‡é™åˆ¶

**Story ID**: 4.1  
**Date**: 2025-01-15  
**Designer**: Quinn (Test Architect)

---

## Test Strategy Overview

- **Total test scenarios**: 18
- **Unit tests**: 8 (44%)
- **Integration tests**: 8 (44%)
- **E2E tests**: 2 (12%)
- **Priority distribution**: P0: 12, P1: 4, P2: 2

**Testing Philosophy**: 
æ­¤ Story çš„æµ‹è¯•ç­–ç•¥éµå¾ª "Shift Left" åŸåˆ™ï¼Œé‡ç‚¹åœ¨å•å…ƒå’Œé›†æˆæµ‹è¯•å±‚é¢éªŒè¯é€Ÿç‡é™åˆ¶é€»è¾‘ã€‚æ ¸å¿ƒæµ‹è¯•ç›®æ ‡:
1. éªŒè¯é™æµé€»è¾‘æ­£ç¡®æ€§ï¼ˆå•å…ƒï¼‰
2. éªŒè¯ API é›†æˆæ­£ç¡®æ€§ï¼ˆé›†æˆï¼‰
3. éªŒè¯é™çº§ç­–ç•¥å’Œé”™è¯¯å¤„ç†ï¼ˆå•å…ƒ + é›†æˆï¼‰
4. éªŒè¯ç”¨æˆ·ä½“éªŒï¼ˆé›†æˆ + E2Eï¼‰

---

## Test Scenarios by Acceptance Criteria

### AC1: ä¸Šä¼ ç«¯ç‚¹é€Ÿç‡é™åˆ¶

**Acceptance Criteria**:
- [x] ä¸Šä¼ APIæ·»åŠ é€Ÿç‡é™åˆ¶: 10æ¬¡/åˆ†é’Ÿ (per user)
- [x] ä½¿ç”¨Upstash Rate Limitå®ç°
- [x] åŸºäºç”¨æˆ·IDè¿›è¡Œé™åˆ¶ (å·²ç™»å½•ç”¨æˆ·)
- [x] é€Ÿç‡é™åˆ¶é…ç½®å¯é€šè¿‡ç¯å¢ƒå˜é‡è°ƒæ•´

#### Test Scenarios

| ID           | Level       | Priority | Test                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|-----------------------------------------|----------------------------------------|----------------|
| 4.1-UNIT-001 | Unit        | P0       | éªŒè¯ checkUploadRateLimit åŸºæœ¬åŠŸèƒ½     | çº¯å‡½æ•°é€»è¾‘ï¼Œéš”ç¦»æµ‹è¯•æ ¸å¿ƒé™æµç®—æ³•       | -              |
| 4.1-UNIT-002 | Unit        | P0       | éªŒè¯é™æµé…ç½® (10æ¬¡/åˆ†é’Ÿ)               | ç¡®ä¿é…ç½®å‚æ•°æ­£ç¡®                       | -              |
| 4.1-UNIT-003 | Unit        | P0       | éªŒè¯åŸºäº userId çš„é™æµé”®ç”Ÿæˆ           | ç¡®ä¿ä¸åŒç”¨æˆ·ç‹¬ç«‹é™æµ                   | -              |
| 4.1-INT-001  | Integration | P0       | éªŒè¯ä¸Šä¼ ç«¯ç‚¹é›†æˆé™æµä¸­é—´ä»¶             | éªŒè¯é™æµé€»è¾‘æ­£ç¡®é›†æˆåˆ° API             | -              |
| 4.1-INT-002  | Integration | P0       | éªŒè¯ 10 æ¬¡è¯·æ±‚å…¨éƒ¨æˆåŠŸ                 | éªŒè¯é™æµé˜ˆå€¼è®¾ç½®æ­£ç¡®                   | -              |
| 4.1-INT-003  | Integration | P0       | éªŒè¯ç¬¬ 11 æ¬¡è¯·æ±‚è¿”å› 429               | è¾¹ç•Œæµ‹è¯•ï¼ŒéªŒè¯é™æµè§¦å‘ç‚¹               | -              |
| 4.1-INT-004  | Integration | P1       | éªŒè¯ä¸åŒç”¨æˆ·ç‹¬ç«‹é™æµ                   | å¤šç”¨æˆ·åœºæ™¯ï¼Œç¡®ä¿é™æµéš”ç¦»               | TECH-001       |

**Coverage**: âœ… AC1 å®Œå…¨è¦†ç›–

---

### AC2: è¶…é™å“åº”å¤„ç†

**Acceptance Criteria**:
- [x] è¶…è¿‡é™åˆ¶è¿”å› HTTP 429 çŠ¶æ€ç 
- [x] å“åº”åŒ…å« `Retry-After` å¤´ (ç§’æ•°)
- [x] å“åº”ä½“åŒ…å«å‹å¥½çš„é”™è¯¯æ¶ˆæ¯ (ä¸­æ–‡)
- [x] å“åº”ä½“åŒ…å«é™åˆ¶è¯¦æƒ… (å½“å‰æ¬¡æ•°ã€é™åˆ¶æ¬¡æ•°ã€é‡ç½®æ—¶é—´)

#### Test Scenarios

| ID           | Level       | Priority | Test                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|-----------------------------------------|----------------------------------------|----------------|
| 4.1-INT-005  | Integration | P0       | éªŒè¯ 429 å“åº”çŠ¶æ€ç                      | HTTP æ ‡å‡†åˆè§„æ€§æµ‹è¯•                    | -              |
| 4.1-INT-006  | Integration | P0       | éªŒè¯ Retry-After å¤´å­˜åœ¨ä¸”æ­£ç¡®          | å®¢æˆ·ç«¯é‡è¯•é€»è¾‘ä¾èµ–æ­¤å¤´                 | -              |
| 4.1-INT-007  | Integration | P0       | éªŒè¯å“åº”ä½“é”™è¯¯æ¶ˆæ¯ä¸ºä¸­æ–‡                | ç”¨æˆ·ä½“éªŒæµ‹è¯•                           | BUS-001        |
| 4.1-INT-008  | Integration | P0       | éªŒè¯å“åº”ä½“åŒ…å«é™åˆ¶è¯¦æƒ…                 | é€æ˜åº¦å’Œå¯è°ƒè¯•æ€§æµ‹è¯•                   | BUS-001        |
| 4.1-E2E-001  | E2E         | P1       | ç”¨æˆ·è¿ç»­ä¸Šä¼ è§¦å‘é™åˆ¶å¹¶çœ‹åˆ°å‹å¥½æç¤º     | å®Œæ•´ç”¨æˆ·æ—…ç¨‹æµ‹è¯•                       | BUS-001        |

**Coverage**: âœ… AC2 å®Œå…¨è¦†ç›–

---

### AC3: æµ‹è¯•è¦†ç›–

**Acceptance Criteria**:
- [x] å•å…ƒæµ‹è¯•: éªŒè¯é€Ÿç‡é™åˆ¶é€»è¾‘
- [x] é›†æˆæµ‹è¯•: éªŒè¯é™åˆ¶ç”Ÿæ•ˆ (è¿ç»­11æ¬¡è¯·æ±‚)
- [x] é›†æˆæµ‹è¯•: éªŒè¯é‡ç½®æ—¶é—´åå¯ä»¥ç»§ç»­ä¸Šä¼ 
- [x] è¾¹ç•Œæµ‹è¯•: ç¬¬10æ¬¡æˆåŠŸã€ç¬¬11æ¬¡å¤±è´¥

#### Test Scenarios

| ID           | Level       | Priority | Test                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|-----------------------------------------|----------------------------------------|----------------|
| 4.1-UNIT-004 | Unit        | P0       | Mock Redis å“åº”æµ‹è¯•é™æµé€»è¾‘            | å•å…ƒæµ‹è¯•æ ¸å¿ƒç®—æ³•ï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡       | -              |
| 4.1-INT-003  | Integration | P0       | è¿ç»­ 11 æ¬¡è¯·æ±‚ï¼Œç¬¬ 11 æ¬¡å¤±è´¥           | **å·²åœ¨ AC1 ä¸­å®šä¹‰**                    | -              |
| 4.1-INT-009  | Integration | P1       | 1 åˆ†é’Ÿåé™åˆ¶é‡ç½®æµ‹è¯•                   | éªŒè¯æ—¶é—´çª—å£é€»è¾‘æ­£ç¡®                   | -              |

**Coverage**: âœ… AC3 å®Œå…¨è¦†ç›–

---

### AC4: æ—¥å¿—å’Œç›‘æ§

**Acceptance Criteria**:
- [x] è®°å½•è¶…é™äº‹ä»¶åˆ°æ—¥å¿— (ç”¨æˆ·IDã€IPã€æ—¶é—´)
- [x] æ—¥å¿—çº§åˆ«ä¸º `warn`
- [x] æ—¥å¿—åŒ…å« `rateLimitExceeded` æ ‡è®°ä¾¿äºç›‘æ§

#### Test Scenarios

| ID           | Level       | Priority | Test                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|-----------------------------------------|----------------------------------------|----------------|
| 4.1-UNIT-005 | Unit        | P0       | éªŒè¯æ—¥å¿—è®°å½•å‡½æ•°è°ƒç”¨                   | éš”ç¦»æµ‹è¯•æ—¥å¿—é€»è¾‘                       | OPS-002        |
| 4.1-UNIT-006 | Unit        | P0       | éªŒè¯æ—¥å¿—å†…å®¹åŒ…å«å¿…è¦å­—æ®µ               | ç¡®ä¿æ—¥å¿—å¯ç”¨äºç›‘æ§å’Œè°ƒè¯•               | OPS-002        |
| 4.1-INT-010  | Integration | P1       | è§¦å‘é™åˆ¶åéªŒè¯æ—¥å¿—å®é™…è¾“å‡º             | ç«¯åˆ°ç«¯éªŒè¯æ—¥å¿—æµç¨‹                     | OPS-002        |

**Coverage**: âœ… AC4 å®Œå…¨è¦†ç›–

---

### Additional: é£é™©ç¼“è§£æµ‹è¯•

åŸºäº Risk Profile (4.1-risk-20250115.md) ä¸­è¯†åˆ«çš„é£é™©ï¼Œé¢å¤–è®¾è®¡æµ‹è¯•ã€‚

#### Risk-Driven Test Scenarios

| ID           | Level       | Priority | Test                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|-----------------------------------------|----------------------------------------|----------------|
| 4.1-UNIT-007 | Unit        | P0       | Redis è¶…æ—¶åœºæ™¯æµ‹è¯•ï¼ˆé™çº§ç­–ç•¥ï¼‰         | éªŒè¯ OPS-001 ç¼“è§£æªæ–½ç”Ÿæ•ˆ              | OPS-001        |
| 4.1-UNIT-008 | Unit        | P0       | Redis é”™è¯¯åœºæ™¯æµ‹è¯•ï¼ˆé™çº§ç­–ç•¥ï¼‰         | éªŒè¯ OPS-001 ç¼“è§£æªæ–½ç”Ÿæ•ˆ              | OPS-001        |
| 4.1-INT-011  | Integration | P0       | Redis ä¸å¯ç”¨æ—¶ç³»ç»Ÿä»å¯ç”¨               | å®Œæ•´éªŒè¯é™çº§æµç¨‹                       | OPS-001        |
| 4.1-INT-012  | Integration | P2       | æ€§èƒ½æµ‹è¯•: å»¶è¿Ÿ < 50ms (P95)            | éªŒè¯ PERF-001 æ€§èƒ½è¦æ±‚                 | PERF-001       |
| 4.1-E2E-002  | E2E         | P2       | å¤šè´¦å·æ”»å‡»æ¨¡æ‹Ÿ                         | è®°å½• TECH-001 è¡Œä¸ºï¼Œä¸ºåç»­æ”¹è¿›æä¾›æ•°æ® | TECH-001       |

**Coverage**: âœ… æ‰€æœ‰ High å’Œ Medium é£é™©éƒ½æœ‰å¯¹åº”æµ‹è¯•

---

## Risk Coverage Matrix

å°†æµ‹è¯•åœºæ™¯æ˜ å°„åˆ°å·²è¯†åˆ«çš„é£é™©ï¼š

| Risk ID   | Risk Title                        | Score | Test IDs                             | Coverage Status |
|-----------|-----------------------------------|-------|--------------------------------------|-----------------|
| OPS-001   | Redis æœåŠ¡ä¸å¯ç”¨                  | 6     | 4.1-UNIT-007, 4.1-UNIT-008, 4.1-INT-011 | âœ… å……åˆ†è¦†ç›–    |
| TECH-001  | å¤šè´¦å·æ”»å‡»ç»•è¿‡                    | 4     | 4.1-INT-004, 4.1-E2E-002             | âš ï¸  éƒ¨åˆ†è¦†ç›–   |
| PERF-001  | Redis å»¶è¿Ÿå½±å“                    | 4     | 4.1-INT-012                          | âœ… æœ‰è¦†ç›–      |
| OPS-002   | æ—¥å¿—é‡æ¿€å¢                        | 4     | 4.1-UNIT-005, 4.1-UNIT-006, 4.1-INT-010 | âœ… å……åˆ†è¦†ç›–  |
| DATA-001  | Redis æ•°æ®ä¸¢å¤±                    | 2     | -                                    | âš ï¸  æ— éœ€æµ‹è¯•ï¼ˆä¾èµ– Upstash SLAï¼‰|
| BUS-001   | åˆæ³•ç”¨æˆ·è¯¯é™åˆ¶                    | 3     | 4.1-INT-007, 4.1-INT-008, 4.1-E2E-001 | âœ… å……åˆ†è¦†ç›–  |

**è¦†ç›–åº¦è¯„ä¼°**: 
- âœ… æ‰€æœ‰ P0 é£é™©æœ‰æµ‹è¯•è¦†ç›–
- âš ï¸  TECH-001 å’Œ DATA-001 ä¸ºæ¥å—é£é™©ï¼Œéƒ¨åˆ†è¦†ç›–æˆ–æ— è¦†ç›–å¯æ¥å—

---

## Detailed Test Specifications

### Unit Tests (8 scenarios)

#### 4.1-UNIT-001: éªŒè¯ checkUploadRateLimit åŸºæœ¬åŠŸèƒ½

**Priority**: P0  
**Level**: Unit  
**File**: `tests/unit/lib/rateLimit.test.ts`

**Setup**:
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { checkUploadRateLimit } from '@/lib/rateLimit'
```

**Test Steps**:
1. Mock Upstash Rate Limit è¿”å›æˆåŠŸå“åº”
2. è°ƒç”¨ `checkUploadRateLimit('user_test_123')`
3. éªŒè¯è¿”å›å€¼ç»“æ„

**Expected Results**:
```typescript
{
  success: true,
  limit: 10,
  remaining: 9,  // æˆ–å…¶ä»–æ­£æ•°
  reset: <timestamp>
}
```

**Assertions**:
- `result.success === true`
- `result.limit === 10`
- `result.remaining >= 0`
- `typeof result.reset === 'number'`

---

#### 4.1-UNIT-002: éªŒè¯é™æµé…ç½® (10æ¬¡/åˆ†é’Ÿ)

**Priority**: P0  
**Level**: Unit  
**File**: `tests/unit/lib/rateLimit.test.ts`

**Test Steps**:
1. è¯»å– `uploadRateLimit` é…ç½®
2. éªŒè¯ limiter ç±»å‹ä¸º `slidingWindow`
3. éªŒè¯å‚æ•°: `10` requests per `1 m`

**Expected Results**:
- Limiter é…ç½®: `Ratelimit.slidingWindow(10, '1 m')`
- Prefix: `'ratelimit:upload'`

---

#### 4.1-UNIT-003: éªŒè¯åŸºäº userId çš„é™æµé”®ç”Ÿæˆ

**Priority**: P0  
**Level**: Unit  
**File**: `tests/unit/lib/rateLimit.test.ts`

**Test Steps**:
1. è°ƒç”¨ `checkUploadRateLimit('user_123')`
2. éªŒè¯ Redis key ä¸º `ratelimit:upload:upload:user_123`

**Expected Results**:
- ä¸åŒ userId ç”Ÿæˆä¸åŒçš„ key
- Key æ ¼å¼ä¸€è‡´

---

#### 4.1-UNIT-004: Mock Redis å“åº”æµ‹è¯•é™æµé€»è¾‘

**Priority**: P0  
**Level**: Unit  
**File**: `tests/unit/lib/rateLimit.test.ts`

**Test Steps**:
1. Mock `uploadRateLimit.limit()` è¿”å› `success: false`
2. è°ƒç”¨ `checkUploadRateLimit('user_456')`
3. éªŒè¯è¿”å›è¶…é™çŠ¶æ€

**Expected Results**:
```typescript
{
  success: false,
  limit: 10,
  remaining: 0,
  reset: <timestamp>
}
```

---

#### 4.1-UNIT-005: éªŒè¯æ—¥å¿—è®°å½•å‡½æ•°è°ƒç”¨

**Priority**: P0  
**Level**: Unit  
**File**: `tests/unit/api/upload-logging.test.ts`

**Test Steps**:
1. Mock `console.warn`
2. æ¨¡æ‹Ÿè¶…é™åœºæ™¯
3. éªŒè¯ `console.warn` è¢«è°ƒç”¨

**Expected Results**:
- `console.warn` è¢«è°ƒç”¨ 1 æ¬¡
- è°ƒç”¨å‚æ•°åŒ…å« `event: 'rateLimitExceeded'`

---

#### 4.1-UNIT-006: éªŒè¯æ—¥å¿—å†…å®¹åŒ…å«å¿…è¦å­—æ®µ

**Priority**: P0  
**Level**: Unit  
**File**: `tests/unit/api/upload-logging.test.ts`

**Test Steps**:
1. Mock `console.warn`
2. è§¦å‘è¶…é™æ—¥å¿—
3. éªŒè¯æ—¥å¿—å¯¹è±¡åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ

**Expected Log Object**:
```typescript
{
  event: 'rateLimitExceeded',
  userId: 'user_123',
  ip: '192.168.1.1',
  endpoint: '/api/documents/upload',
  timestamp: '2025-01-15T...'
}
```

---

#### 4.1-UNIT-007: Redis è¶…æ—¶åœºæ™¯æµ‹è¯•ï¼ˆé™çº§ç­–ç•¥ï¼‰

**Priority**: P0  
**Level**: Unit  
**File**: `tests/unit/lib/rateLimit.test.ts`

**Test Steps**:
1. Mock Redis æ“ä½œè¶…æ—¶ï¼ˆæŠ›å‡º TimeoutErrorï¼‰
2. è°ƒç”¨ `checkUploadRateLimit('user_789')`
3. éªŒè¯é™çº§ç­–ç•¥ç”Ÿæ•ˆ

**Expected Results**:
- å‡½æ•°ä¸æŠ›å‡ºå¼‚å¸¸
- è¿”å›é™çº§å“åº”ï¼ˆå…è®¸é€šè¿‡æˆ–ä½¿ç”¨å†…å­˜é™æµï¼‰
- è®°å½•å‘Šè­¦æ—¥å¿—

**Mitigates**: OPS-001 (High Risk)

---

#### 4.1-UNIT-008: Redis é”™è¯¯åœºæ™¯æµ‹è¯•ï¼ˆé™çº§ç­–ç•¥ï¼‰

**Priority**: P0  
**Level**: Unit  
**File**: `tests/unit/lib/rateLimit.test.ts`

**Test Steps**:
1. Mock Redis è¿æ¥é”™è¯¯ï¼ˆæŠ›å‡º ConnectionErrorï¼‰
2. è°ƒç”¨ `checkUploadRateLimit('user_101')`
3. éªŒè¯é™çº§ç­–ç•¥ç”Ÿæ•ˆ

**Expected Results**:
- å‡½æ•°ä¸æŠ›å‡ºå¼‚å¸¸
- ç³»ç»Ÿä»ç„¶å¯ç”¨ï¼ˆé™çº§æ¨¡å¼ï¼‰
- å‘Šè­¦æ—¥å¿—åŒ…å«é”™è¯¯è¯¦æƒ…

**Mitigates**: OPS-001 (High Risk)

---

### Integration Tests (8 scenarios)

#### 4.1-INT-001: éªŒè¯ä¸Šä¼ ç«¯ç‚¹é›†æˆé™æµä¸­é—´ä»¶

**Priority**: P0  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Setup**:
```typescript
import { POST as uploadDocument } from '@/app/api/documents/upload/route'
import { createMockRequest, createMockSession } from '@/tests/helpers'
```

**Test Steps**:
1. åˆ›å»ºè®¤è¯çš„æµ‹è¯•è¯·æ±‚
2. è°ƒç”¨ä¸Šä¼  API
3. éªŒè¯é€Ÿç‡é™åˆ¶é€»è¾‘è¢«æ‰§è¡Œ

**Expected Results**:
- å“åº”åŒ…å« `X-RateLimit-*` å¤´
- å“åº”æ­£å¸¸ï¼ˆæœªè¶…é™æ—¶ï¼‰

---

#### 4.1-INT-002: éªŒè¯ 10 æ¬¡è¯·æ±‚å…¨éƒ¨æˆåŠŸ

**Priority**: P0  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Test Steps**:
1. è¿ç»­å‘é€ 10 æ¬¡ä¸Šä¼ è¯·æ±‚ï¼ˆåŒä¸€ç”¨æˆ·ï¼‰
2. éªŒè¯æ‰€æœ‰è¯·æ±‚éƒ½è¿”å› 200 æˆ– 201

**Expected Results**:
```typescript
for (let i = 1; i <= 10; i++) {
  const res = await uploadDocument(req)
  expect(res.status).not.toBe(429)
  expect(res.headers.get('X-RateLimit-Remaining')).toBe(String(10 - i))
}
```

---

#### 4.1-INT-003: éªŒè¯ç¬¬ 11 æ¬¡è¯·æ±‚è¿”å› 429 (è¾¹ç•Œæµ‹è¯•)

**Priority**: P0  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Test Steps**:
1. è¿ç»­å‘é€ 11 æ¬¡ä¸Šä¼ è¯·æ±‚
2. éªŒè¯å‰ 10 æ¬¡æˆåŠŸï¼Œç¬¬ 11 æ¬¡å¤±è´¥

**Expected Results**:
- Request 1-10: `status !== 429`
- Request 11: `status === 429`
- Request 11 å“åº”ä½“åŒ…å«é”™è¯¯æ¶ˆæ¯

**Critical**: è¿™æ˜¯æœ€é‡è¦çš„è¾¹ç•Œæµ‹è¯•

---

#### 4.1-INT-004: éªŒè¯ä¸åŒç”¨æˆ·ç‹¬ç«‹é™æµ

**Priority**: P1  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Test Steps**:
1. ç”¨æˆ· A ä¸Šä¼  10 æ¬¡
2. ç”¨æˆ· B ä¸Šä¼  10 æ¬¡
3. éªŒè¯ä¸¤ä¸ªç”¨æˆ·éƒ½ä¸è¢«é™åˆ¶

**Expected Results**:
- ç”¨æˆ· A: 10 æ¬¡å…¨éƒ¨æˆåŠŸ
- ç”¨æˆ· B: 10 æ¬¡å…¨éƒ¨æˆåŠŸ
- é™æµéš”ç¦»ç”Ÿæ•ˆ

**Mitigates**: TECH-001 (éªŒè¯å•ç”¨æˆ·é™åˆ¶æœ‰æ•ˆ)

---

#### 4.1-INT-005: éªŒè¯ 429 å“åº”çŠ¶æ€ç 

**Priority**: P0  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Test Steps**:
1. è§¦å‘é€Ÿç‡é™åˆ¶ï¼ˆ11 æ¬¡è¯·æ±‚ï¼‰
2. éªŒè¯å“åº”çŠ¶æ€ç 

**Expected Results**:
```typescript
const response = await uploadDocument(req11)
expect(response.status).toBe(429)
```

---

#### 4.1-INT-006: éªŒè¯ Retry-After å¤´å­˜åœ¨ä¸”æ­£ç¡®

**Priority**: P0  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Test Steps**:
1. è§¦å‘é€Ÿç‡é™åˆ¶
2. è¯»å– `Retry-After` å¤´
3. éªŒè¯å€¼ä¸ºæ­£æ•´æ•°ï¼ˆç§’ï¼‰

**Expected Results**:
```typescript
const retryAfter = response.headers.get('Retry-After')
expect(retryAfter).toBeTruthy()
expect(Number(retryAfter)).toBeGreaterThan(0)
expect(Number(retryAfter)).toBeLessThanOrEqual(60)
```

---

#### 4.1-INT-007: éªŒè¯å“åº”ä½“é”™è¯¯æ¶ˆæ¯ä¸ºä¸­æ–‡

**Priority**: P0  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Test Steps**:
1. è§¦å‘é€Ÿç‡é™åˆ¶
2. è§£æå“åº”ä½“
3. éªŒè¯é”™è¯¯æ¶ˆæ¯ä¸ºä¸­æ–‡

**Expected Results**:
```typescript
const body = await response.json()
expect(body.error).toBe('ä¸Šä¼ è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•')
```

**Mitigates**: BUS-001 (ç”¨æˆ·ä½“éªŒ)

---

#### 4.1-INT-008: éªŒè¯å“åº”ä½“åŒ…å«é™åˆ¶è¯¦æƒ…

**Priority**: P0  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Test Steps**:
1. è§¦å‘é€Ÿç‡é™åˆ¶
2. è§£æå“åº”ä½“
3. éªŒè¯ `details` å­—æ®µ

**Expected Results**:
```typescript
const body = await response.json()
expect(body.details).toMatchObject({
  limit: 10,
  remaining: 0,
  retryAfter: expect.any(Number),
  resetAt: expect.any(String)  // ISO timestamp
})
```

**Mitigates**: BUS-001 (é€æ˜åº¦å’Œå¯è°ƒè¯•æ€§)

---

#### 4.1-INT-009: 1 åˆ†é’Ÿåé™åˆ¶é‡ç½®æµ‹è¯•

**Priority**: P1  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Test Steps**:
1. ä¸Šä¼  11 æ¬¡ï¼ˆè§¦å‘é™åˆ¶ï¼‰
2. ç­‰å¾… 61 ç§’ï¼ˆæˆ–ä½¿ç”¨ fake timersï¼‰
3. å†æ¬¡ä¸Šä¼ ï¼ŒéªŒè¯æˆåŠŸ

**Expected Results**:
- ç¬¬ 11 æ¬¡è¯·æ±‚: 429
- ç­‰å¾… 61 ç§’å
- ç¬¬ 12 æ¬¡è¯·æ±‚: æˆåŠŸ (200/201)

**Note**: ä½¿ç”¨ `vi.useFakeTimers()` åŠ é€Ÿæµ‹è¯•

---

#### 4.1-INT-010: è§¦å‘é™åˆ¶åéªŒè¯æ—¥å¿—å®é™…è¾“å‡º

**Priority**: P1  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Test Steps**:
1. Mock `console.warn`
2. è§¦å‘é€Ÿç‡é™åˆ¶
3. éªŒè¯æ—¥å¿—è¾“å‡º

**Expected Results**:
- `console.warn` è¢«è°ƒç”¨
- æ—¥å¿—åŒ…å«å®Œæ•´çš„å¿…è¦å­—æ®µ

**Mitigates**: OPS-002 (æ—¥å¿—éªŒè¯)

---

#### 4.1-INT-011: Redis ä¸å¯ç”¨æ—¶ç³»ç»Ÿä»å¯ç”¨

**Priority**: P0  
**Level**: Integration  
**File**: `tests/integration/api/upload-rate-limit.test.ts`

**Test Steps**:
1. Mock Upstash Rate Limit æŠ›å‡ºé”™è¯¯
2. å°è¯•ä¸Šä¼ æ–‡æ¡£
3. éªŒè¯è¯·æ±‚æˆåŠŸï¼ˆé™çº§æ¨¡å¼ï¼‰

**Expected Results**:
- è¯·æ±‚ä¸è¿”å› 500 é”™è¯¯
- è¯·æ±‚æˆåŠŸï¼ˆ200/201ï¼‰æˆ–è¿”å›ä¸šåŠ¡é”™è¯¯
- é™çº§å‘Šè­¦æ—¥å¿—å­˜åœ¨

**Mitigates**: OPS-001 (Critical - ç³»ç»Ÿå¯ç”¨æ€§)

---

#### 4.1-INT-012: æ€§èƒ½æµ‹è¯• - å»¶è¿Ÿ < 50ms (P95)

**Priority**: P2  
**Level**: Integration (Performance)  
**File**: `tests/performance/upload-rate-limit-perf.test.ts`

**Test Steps**:
1. è®°å½•æ·»åŠ é™æµå‰çš„åŸºå‡†å»¶è¿Ÿï¼ˆå¦‚æœå¯èƒ½ï¼‰
2. å‘é€ 100 æ¬¡ä¸Šä¼ è¯·æ±‚
3. æµ‹é‡æ¯æ¬¡è¯·æ±‚çš„ "é€Ÿç‡é™åˆ¶æ£€æŸ¥" å»¶è¿Ÿ
4. è®¡ç®— P95 å»¶è¿Ÿ

**Expected Results**:
- P95 å»¶è¿Ÿ < 50ms
- å¹³å‡å»¶è¿Ÿ < 30ms

**Mitigates**: PERF-001 (æ€§èƒ½è¦æ±‚)

**Note**: éœ€è¦åœ¨çœŸå® Redis ç¯å¢ƒè¿è¡Œï¼Œæˆ–ä½¿ç”¨ Redis mock ä½†æ ‡è®°ä¸ºæ‰‹åŠ¨æ€§èƒ½æµ‹è¯•

---

### E2E Tests (2 scenarios)

#### 4.1-E2E-001: ç”¨æˆ·è¿ç»­ä¸Šä¼ è§¦å‘é™åˆ¶å¹¶çœ‹åˆ°å‹å¥½æç¤º

**Priority**: P1  
**Level**: E2E  
**File**: `tests/e2e/upload-rate-limit.spec.ts`

**Setup**:
- ä½¿ç”¨çœŸå®æµè§ˆå™¨ï¼ˆPlaywright/Puppeteerï¼‰
- ç™»å½•æµ‹è¯•ç”¨æˆ·

**Test Steps**:
1. ç”¨æˆ·è®¿é—®ä¸Šä¼ é¡µé¢
2. è¿ç»­é€‰æ‹©å¹¶ä¸Šä¼  11 ä¸ªæ–‡ä»¶
3. è§‚å¯Ÿ UI åé¦ˆ

**Expected Results**:
- å‰ 10 æ¬¡ä¸Šä¼ : æ˜¾ç¤ºæˆåŠŸ
- ç¬¬ 11 æ¬¡ä¸Šä¼ : æ˜¾ç¤ºé”™è¯¯æç¤º
- é”™è¯¯æç¤ºä¸ºä¸­æ–‡: "ä¸Šä¼ è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"
- æ˜¾ç¤ºé‡è¯•æ—¶é—´

**User Journey Validation**:
- éªŒè¯å®Œæ•´çš„ç”¨æˆ·ä½“éªŒæµç¨‹
- ç¡®ä¿é”™è¯¯æ¶ˆæ¯å¯¹ç”¨æˆ·å‹å¥½

**Mitigates**: BUS-001 (ç”¨æˆ·ä½“éªŒ)

---

#### 4.1-E2E-002: å¤šè´¦å·æ”»å‡»æ¨¡æ‹Ÿ

**Priority**: P2  
**Level**: E2E  
**File**: `tests/e2e/multi-account-attack.spec.ts`

**Setup**:
- åˆ›å»º 3 ä¸ªæµ‹è¯•è´¦å·
- å‡†å¤‡æµ‹è¯•æ–‡ä»¶

**Test Steps**:
1. è´¦å· A: ä¸Šä¼  10 æ¬¡
2. è´¦å· B: ä¸Šä¼  10 æ¬¡
3. è´¦å· C: ä¸Šä¼  10 æ¬¡
4. è®°å½•æ€»è¯·æ±‚æ•°å’ŒæˆåŠŸæ•°

**Expected Results**:
- æ€»è¯·æ±‚æ•°: 30
- æ€»æˆåŠŸæ•°: 30
- å•è´¦å·é™åˆ¶ç”Ÿæ•ˆï¼Œä½†æ€»é‡æœªè¢«é™åˆ¶

**Purpose**: 
- è®°å½• TECH-001 é£é™©çš„å®é™…è¡Œä¸º
- ä¸ºåç»­æ·»åŠ  IP é™åˆ¶æä¾›åŸºçº¿æ•°æ®

**Mitigates**: TECH-001 (éƒ¨åˆ† - è®°å½•è¡Œä¸º)

---

## Recommended Execution Order

### Phase 1: å¿«é€ŸéªŒè¯ï¼ˆå•å…ƒæµ‹è¯•ï¼‰

**ç›®æ ‡**: åœ¨ Code Review å‰éªŒè¯æ ¸å¿ƒé€»è¾‘

1. 4.1-UNIT-001: åŸºæœ¬åŠŸèƒ½ âœ…
2. 4.1-UNIT-002: é…ç½®éªŒè¯ âœ…
3. 4.1-UNIT-003: Key ç”Ÿæˆ âœ…
4. 4.1-UNIT-004: Mock Redis âœ…
5. 4.1-UNIT-007: Redis è¶…æ—¶é™çº§ ğŸ”´ (Critical)
6. 4.1-UNIT-008: Redis é”™è¯¯é™çº§ ğŸ”´ (Critical)

**é¢„è®¡æ—¶é—´**: ~10 åˆ†é’Ÿ

---

### Phase 2: é›†æˆéªŒè¯ï¼ˆP0 é›†æˆæµ‹è¯•ï¼‰

**ç›®æ ‡**: QA Gate å‰éªŒè¯ API é›†æˆ

7. 4.1-INT-001: é›†æˆéªŒè¯ âœ…
8. 4.1-INT-002: 10 æ¬¡æˆåŠŸ âœ…
9. 4.1-INT-003: ç¬¬ 11 æ¬¡å¤±è´¥ ğŸ”´ (è¾¹ç•Œæµ‹è¯•)
10. 4.1-INT-005: 429 çŠ¶æ€ç  âœ…
11. 4.1-INT-006: Retry-After å¤´ âœ…
12. 4.1-INT-007: ä¸­æ–‡é”™è¯¯æ¶ˆæ¯ âœ…
13. 4.1-INT-008: é™åˆ¶è¯¦æƒ… âœ…
14. 4.1-INT-011: Redis ä¸å¯ç”¨é™çº§ ğŸ”´ (Critical)

**é¢„è®¡æ—¶é—´**: ~15 åˆ†é’Ÿ

---

### Phase 3: æ—¥å¿—å’Œç›‘æ§éªŒè¯

**ç›®æ ‡**: ç¡®ä¿å¯è§‚æµ‹æ€§

15. 4.1-UNIT-005: æ—¥å¿—è°ƒç”¨ âœ…
16. 4.1-UNIT-006: æ—¥å¿—å†…å®¹ âœ…
17. 4.1-INT-010: å®é™…æ—¥å¿—è¾“å‡º âœ…

**é¢„è®¡æ—¶é—´**: ~5 åˆ†é’Ÿ

---

### Phase 4: æ‰©å±•æµ‹è¯•ï¼ˆP1-P2ï¼‰

**ç›®æ ‡**: å®Œæ•´æ€§å’Œæ€§èƒ½éªŒè¯

18. 4.1-INT-004: å¤šç”¨æˆ·éš”ç¦» âœ…
19. 4.1-INT-009: æ—¶é—´é‡ç½® âœ…
20. 4.1-INT-012: æ€§èƒ½æµ‹è¯• âš¡ (å¦‚æœ‰æ—¶é—´)
21. 4.1-E2E-001: ç”¨æˆ·ä½“éªŒ âœ… (å¦‚æœ‰æ—¶é—´)
22. 4.1-E2E-002: å¤šè´¦å·æ”»å‡» ğŸ”¬ (è§‚å¯Ÿæ€§æµ‹è¯•)

**é¢„è®¡æ—¶é—´**: ~20 åˆ†é’Ÿ

---

## Test Data Requirements

### Mock ç”¨æˆ·æ•°æ®

```typescript
const testUsers = {
  user_normal: {
    id: 'user_test_normal_123',
    email: 'normal@example.com',
    session: { /* valid session */ }
  },
  user_attacker: {
    id: 'user_test_attacker_456',
    email: 'attacker@example.com',
    session: { /* valid session */ }
  },
  user_multi_a: {
    id: 'user_test_multi_a',
    email: 'multi_a@example.com',
    session: { /* valid session */ }
  },
  user_multi_b: {
    id: 'user_test_multi_b',
    email: 'multi_b@example.com',
    session: { /* valid session */ }
  },
  user_multi_c: {
    id: 'user_test_multi_c',
    email: 'multi_c@example.com',
    session: { /* valid session */ }
  }
}
```

### æµ‹è¯•æ–‡ä»¶

```typescript
const testFiles = {
  small: new File(['small content'], 'small.txt', { type: 'text/plain' }),
  medium: new File([new ArrayBuffer(1024 * 100)], 'medium.pdf', { type: 'application/pdf' }),
  large: new File([new ArrayBuffer(1024 * 1024 * 5)], 'large.pdf', { type: 'application/pdf' })
}
```

### Redis Mock å“åº”

```typescript
const mockRedisResponses = {
  success: {
    success: true,
    limit: 10,
    remaining: 5,
    reset: Date.now() + 60000
  },
  rateLimited: {
    success: false,
    limit: 10,
    remaining: 0,
    reset: Date.now() + 30000
  },
  error: new Error('Redis connection failed'),
  timeout: new Error('Operation timeout')
}
```

---

## Test Environment Requirements

### å¼€å‘ç¯å¢ƒ

**Required**:
- Node.js 18+
- Vitest é…ç½®
- Mock å·¥å…· (vi.mock)
- æµ‹è¯•ç”¨ Redis (Upstash æˆ– local Redis)

**Optional**:
- Playwright (for E2E)
- k6 (for performance testing)

---

### CI/CD ç¯å¢ƒ

**Must Have**:
- å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•åœ¨ CI ä¸­è¿è¡Œ
- æµ‹è¯•å¤±è´¥é˜»æ­¢ merge

**Optional**:
- æ€§èƒ½æµ‹è¯•åœ¨æ¯æ—¥ nightly build è¿è¡Œ
- E2E æµ‹è¯•åœ¨ staging ç¯å¢ƒè¿è¡Œ

---

## Coverage Goals

### ä»£ç è¦†ç›–ç‡ç›®æ ‡

| Component                             | Target Coverage | Rationale                              |
|---------------------------------------|-----------------|----------------------------------------|
| `src/lib/rateLimit.ts`               | â‰¥ 90%           | æ ¸å¿ƒé™æµé€»è¾‘ï¼Œé«˜è¦†ç›–ç‡å¿…éœ€             |
| `src/app/api/documents/upload/route.ts` (é™æµéƒ¨åˆ†) | â‰¥ 85% | API é›†æˆç‚¹ï¼Œé‡ç‚¹è¦†ç›–é™æµåˆ†æ”¯ |
| æ—¥å¿—é€»è¾‘                              | â‰¥ 80%           | ç›‘æ§å’Œå¯è§‚æµ‹æ€§ä»£ç                      |

### åŠŸèƒ½è¦†ç›–ç‡ç›®æ ‡

- âœ… æ‰€æœ‰ AC æœ‰æµ‹è¯•è¦†ç›–: 100%
- âœ… æ‰€æœ‰è¾¹ç•Œæƒ…å†µæœ‰æµ‹è¯•: 100%
- âœ… æ‰€æœ‰ High Risk æœ‰ç¼“è§£æµ‹è¯•: 100%
- âš ï¸  Medium/Low Risk: > 75%

---

## Test Automation Strategy

### è‡ªåŠ¨åŒ–ä¼˜å…ˆçº§

**Tier 1: å¿…é¡»è‡ªåŠ¨åŒ– (CI/CD)**
- æ‰€æœ‰å•å…ƒæµ‹è¯• (4.1-UNIT-001 ~ 4.1-UNIT-008)
- æ‰€æœ‰ P0 é›†æˆæµ‹è¯• (4.1-INT-001 ~ 4.1-INT-008, 4.1-INT-011)

**Tier 2: åº”è¯¥è‡ªåŠ¨åŒ– (Nightly)**
- P1 é›†æˆæµ‹è¯• (4.1-INT-004, 4.1-INT-009, 4.1-INT-010)
- æ€§èƒ½æµ‹è¯• (4.1-INT-012)

**Tier 3: å¯ä»¥æ‰‹åŠ¨ (æŒ‰éœ€)**
- E2E æµ‹è¯• (4.1-E2E-001, 4.1-E2E-002)

---

## Quality Checklist

åœ¨æäº¤ QA Gate å‰ï¼Œç¡®è®¤:

- [ ] æ‰€æœ‰ P0 æµ‹è¯•é€šè¿‡ (18/18)
- [ ] ä»£ç è¦†ç›–ç‡ â‰¥ 85% (é™æµç›¸å…³ä»£ç )
- [ ] è¾¹ç•Œæµ‹è¯• (ç¬¬ 10 vs ç¬¬ 11 æ¬¡) é€šè¿‡
- [ ] Redis é™çº§æµ‹è¯•é€šè¿‡ (OPS-001)
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡ (å»¶è¿Ÿ < 50ms P95)
- [ ] æ—¥å¿—è¾“å‡ºéªŒè¯é€šè¿‡
- [ ] è‡³å°‘ä¸€ä¸ª E2E æµ‹è¯•æ‰§è¡ŒéªŒè¯

---

## Test Execution Report Template

```markdown
# Test Execution Report: Story 4.1

**Date**: {date}
**Executor**: {name}

## Summary

- Total Tests: 18
- Passed: {X}
- Failed: {Y}
- Skipped: {Z}

## P0 Tests Status

- Unit Tests: {X/8} âœ…
- Integration Tests: {Y/8} âœ…
- E2E Tests: {Z/2} âœ…

## Coverage

- Line Coverage: {X}%
- Branch Coverage: {Y}%
- Function Coverage: {Z}%

## Critical Test Results

### OPS-001 Mitigation (Redis é™çº§)
- 4.1-UNIT-007: âœ… PASS
- 4.1-UNIT-008: âœ… PASS
- 4.1-INT-011: âœ… PASS

### Boundary Test
- 4.1-INT-003 (ç¬¬ 11 æ¬¡å¤±è´¥): âœ… PASS

## Failed Tests

{List any failed tests with details}

## Performance Metrics

- Rate Limit Check Latency (P95): {X} ms
- Target: < 50ms
- Status: {PASS/FAIL}

## Recommendations

{Any recommendations based on test results}
```

---

## Integration with Quality Gate

### Gate YAML Block

```yaml
# test_design (paste into gate file):
test_design:
  scenarios_total: 18
  by_level:
    unit: 8
    integration: 8
    e2e: 2
  by_priority:
    p0: 12
    p1: 4
    p2: 2
  coverage_gaps: []  # No gaps - all ACs covered
  risk_coverage:
    ops_001: covered  # Redisé™çº§æµ‹è¯•
    tech_001: partial # å•ç”¨æˆ·é™åˆ¶å·²æµ‹è¯•ï¼Œå¤šè´¦å·æ”»å‡»è®°å½•æ€§æµ‹è¯•
    perf_001: covered # æ€§èƒ½æµ‹è¯•
    ops_002: covered  # æ—¥å¿—æµ‹è¯•
    bus_001: covered  # ç”¨æˆ·ä½“éªŒæµ‹è¯•
```

---

## Summary for Review Task

**æµ‹è¯•è®¾è®¡å®Œæˆ** âœ…

**å…³é”®æµ‹è¯•åœºæ™¯**:
- ğŸ”´ **Critical**: Redis é™çº§æµ‹è¯• (4.1-UNIT-007/008, 4.1-INT-011)
- ğŸ”´ **Critical**: è¾¹ç•Œæµ‹è¯• (4.1-INT-003)
- âœ… **Required**: æ‰€æœ‰ AC è¦†ç›– (18 ä¸ªæµ‹è¯•åœºæ™¯)
- âš¡ **Performance**: å»¶è¿Ÿ < 50ms (4.1-INT-012)

**è¦†ç›–åº¦**:
- AC è¦†ç›–ç‡: 100% âœ…
- é£é™©è¦†ç›–ç‡: 100% (High/Medium risks) âœ…
- ä»£ç è¦†ç›–ç‡ç›®æ ‡: â‰¥ 85% âœ…

**æ¨èæ‰§è¡Œé¡ºåº**:
1. Phase 1: å•å…ƒæµ‹è¯• (10 min)
2. Phase 2: P0 é›†æˆæµ‹è¯• (15 min)
3. Phase 3: æ—¥å¿—éªŒè¯ (5 min)
4. Phase 4: æ‰©å±•æµ‹è¯• (20 min, optional)

**ä¸‹ä¸€æ­¥**: å®æ–½æµ‹è¯•å¹¶ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š

---

**Hook Line for Review Task**:
```
Test design matrix: docs/qa/assessments/4.1-test-design-20250115.md
P0 tests identified: 12
```

