# Test Design: Story 4.12 - Axiom 日志集成

**Date**: 2025-01-15  
**Designer**: Quinn (测试架构师)  
**Story**: 4.12 - Axiom 日志集成

---

## Test Strategy Overview

- **Total test scenarios**: 15
- **Unit tests**: 10 (67%)
- **Integration tests**: 4 (27%)
- **E2E tests**: 1 (6%)
- **Priority distribution**: P0: 6, P1: 7, P2: 2

**关键测试策略**:
1. **重点**: Logger 配置逻辑和辅助函数的单元测试
2. **集成**: API 错误日志发送到 Axiom 的集成测试
3. **手动**: Axiom Dashboard 和告警规则的手动验证

---

## Test Scenarios by Acceptance Criteria

### AC1: Axiom 账号和项目配置

**Status**: ❌ 手动任务,无自动化测试

**Manual Validation**:
- [ ] 验证 Axiom 账号注册成功 (Free 计划,500GB/月)
- [ ] 验证 Dataset `docqa-system` 创建成功
- [ ] 验证 API Token 生成并保存到安全位置
- [ ] 验证环境变量配置:
  - [ ] `.env.local` 包含 AXIOM_DATASET, AXIOM_TOKEN, AXIOM_ORG_ID, LOG_LEVEL
  - [ ] Vercel Project Settings 环境变量已配置 (Production, Preview, Development)
  - [ ] AXIOM_TOKEN 标记为 Secret

---

### AC2: Pino + Axiom 集成实现

#### Test Scenarios

| ID             | Level | Priority | Test                                          | Justification                           |
| -------------- | ----- | -------- | --------------------------------------------- | --------------------------------------- |
| 4.12-UNIT-001  | Unit  | P0       | Logger 实例创建 (development 环境)            | 验证开发环境配置 pino-pretty            |
| 4.12-UNIT-002  | Unit  | P0       | Logger 实例创建 (production 环境)             | 验证生产环境配置 pino-axiom             |
| 4.12-UNIT-003  | Unit  | P0       | 环境变量驱动的配置切换                        | 验证 LOG_LEVEL, NODE_ENV, AXIOM_TOKEN  |
| 4.12-UNIT-004  | Unit  | P1       | sanitizeQuery() 截断测试                      | 验证查询截断到 100 字符                 |
| 4.12-UNIT-005  | Unit  | P1       | sanitizeEmail() 脱敏测试                      | 验证 Email 脱敏为 `a***@example.com`    |
| 4.12-UNIT-006  | Unit  | P1       | logError() 错误格式化测试                     | 验证错误消息和堆栈正确格式化            |
| 4.12-UNIT-007  | Unit  | P1       | logDocumentUpload() 辅助函数测试              | 验证文档上传日志格式                    |
| 4.12-UNIT-008  | Unit  | P1       | logRetrieval() 辅助函数测试                   | 验证 RAG 检索日志格式                   |
| 4.12-UNIT-009  | Unit  | P2       | logCache() 辅助函数测试                       | 验证缓存日志格式                        |
| 4.12-UNIT-010  | Unit  | P2       | Mock pino-axiom transport                     | 验证日志发送逻辑                        |

**Coverage Target**: >80% for `src/lib/logger.ts`

**Implementation Notes**:
```typescript
// tests/unit/lib/logger.test.ts
import { logger, sanitizeQuery, sanitizeEmail, logError } from '@/lib/logger'

describe('Logger', () => {
  describe('Instance Creation', () => {
    it('should create logger instance', () => {
      expect(logger).toBeDefined()
    expect(logger.info).toBeInstanceOf(Function)
    })
  })

  describe('Environment Configuration', () => {
    it('should use pino-pretty in development', () => {
      process.env.NODE_ENV = 'development'
      // Mock and verify pino-pretty transport
    })

    it('should use pino-axiom in production with AXIOM_TOKEN', () => {
      process.env.NODE_ENV = 'production'
      process.env.AXIOM_TOKEN = 'test-token'
      // Mock and verify pino-axiom transport
    })
  })

  describe('Sanitization Functions', () => {
    it('should truncate query to 100 characters', () => {
      const longQuery = 'A'.repeat(150)
      expect(sanitizeQuery(longQuery)).toHaveLength(103) // 100 + '...'
    })

    it('should mask email', () => {
      expect(sanitizeEmail('test@example.com')).toBe('t***@example.com')
    })
  })

  describe('Error Logging', () => {
    it('should format error with message and stack', () => {
      const error = new Error('Test error')
      const context = { userId: 'test-user' }
      // Spy on logger.error and verify format
    })
  })
})
```

---

### AC3: 关键路径日志重构

#### Test Scenarios

| ID            | Level       | Priority | Test                           | Justification                       |
| ------------- | ----------- | -------- | ------------------------------ | ----------------------------------- |
| 4.12-INT-001  | Integration | P0       | API 文档上传日志记录           | 验证上传成功/失败日志正确记录       |
| 4.12-INT-002  | Integration | P0       | API RAG 查询日志记录           | 验证查询日志正确记录                |
| 4.12-INT-003  | Integration | P1       | 文档处理路径日志链追踪         | 验证 documentId 在各阶段保持一致    |
| 4.12-INT-004  | Integration | P1       | 错误日志发送到 Axiom           | 验证 error 日志成功发送到 Axiom     |

**Coverage Target**: Services 层和 API Routes 层的 console 调用 100% 替换为 logger

**Implementation Notes**:
```typescript
// tests/integration/logging/api-logging.test.ts
describe('API Logging Integration', () => {
  it('should log document upload success', async () => {
    const spy = jest.spyOn(logger, 'info')
    // Call upload API
    expect(spy).toHaveBeenCalledWith(
      expect.objectContaining({
        userId: expect.any(String),
        documentId: expect.any(String),
        action: 'upload_success'
      }),
      expect.any(String)
    )
  })
  
  it('should log API errors', async () => {
    const spy = jest.spyOn(logger, 'error')
    // Trigger API error
    expect(spy).toHaveBeenCalledWith(
      expect.objectContaining({ 
        error: expect.any(String),
        action: expect.stringContaining('_error')
      }),
      expect.any(String)
    )
  })
})
```

---

### AC4: Axiom Dashboard 配置

**Status**: ❌ 手动任务,无自动化测试

**Manual Validation**:
- [ ] **Saved Queries**:
  - [ ] "错误日志" (level == "error" or level == "fatal")
  - [ ] "上传日志" (action contains "upload")
  - [ ] "查询日志" (action contains "query")
  - [ ] "缓存日志" (action contains "cache")

- [ ] **Monitoring Dashboard**:
  - [ ] Panel 1: 错误趋势 (24h, 1h interval)
  - [ ] Panel 2: 请求量分布 (按 action)
  - [ ] Panel 3: 平均响应时间 (按 service)
  - [ ] Panel 4: 缓存命中率 (如适用)
  - [ ] Panel 5: Top 错误类型 (groupBy error.type)

- [ ] **告警规则**:
  - [ ] Alert 1: 错误率 >5% (5min window) → 验证告警触发
  - [ ] Alert 2: 上传失败 >10次/hour → 验证告警触发
  - [ ] Alert 3: Axiom 配额使用 >80% → 验证告警触发

---

### AC5: 日志验证和测试

#### Test Scenarios

| ID           | Level | Priority | Test                           | Justification                       |
| ------------ | ----- | -------- | ------------------------------ | ----------------------------------- |
| 4.12-E2E-001 | E2E   | P0       | 端到端日志链追踪               | 验证从上传到查询的完整日志链        |

**Manual Validation**:
- [ ] **开发环境验证**:
  - [ ] 启动 dev server: `npm run dev`
  - [ ] 验证控制台彩色日志输出 (pino-pretty)
  - [ ] 验证日志格式美化易读
  - [ ] 验证包含时间戳和日志级别

- [ ] **生产环境验证**:
  - [ ] 本地生产构建: `npm run build && npm start`
  - [ ] 故意触发错误 (如无效文件上传)
  - [ ] 等待 1-2 分钟
  - [ ] 访问 Axiom Dashboard
  - [ ] 验证错误日志出现在 `docqa-system` Dataset

- [ ] **结构化查询测试**:
  - [ ] 在 Axiom 中运行查询: `userId == "<test-user-id>"`
  - [ ] 验证能查询到该用户的所有操作日志
  - [ ] 测试按 action 筛选: `action contains "upload" | count`

- [ ] **性能影响测试**:
  - [ ] 对比日志记录前后的 API 响应时间
  - [ ] 验证日志记录开销 <5ms
  - [ ] 验证 Axiom 发送异步,不阻塞主流程

---

### AC6: 文档和运维指南

**Status**: ❌ 手动任务,无自动化测试

**Manual Validation**:
- [ ] **部署文档** (`docs/deployment/axiom-logging-setup.md`):
  - [ ] Axiom 账号注册流程
  - [ ] 环境变量配置步骤
  - [ ] Dashboard 访问和使用指南

- [ ] **运维手册** (`docs/deployment/axiom-operations-guide.md`):
  - [ ] 常见查询语句示例
  - [ ] 告警规则配置和调整方法
  - [ ] 配额监控和优化建议
  - [ ] 故障排查 Checklist

- [ ] **开发者文档** (`docs/architecture/logging-guide.md`):
  - [ ] Logger 使用指南和最佳实践
  - [ ] 日志级别选择规范
  - [ ] 敏感信息脱敏规则

---

## Test Design Recommendations

### Priority 1: Critical Tests (Must Implement)

1. **Logger 单元测试** (4.12-UNIT-001 至 4.12-UNIT-010):
   - 测试 Logger 实例创建和环境配置
   - 测试辅助函数 (sanitizeQuery, sanitizeEmail, logError)
   - Mock pino-axiom transport 验证日志发送逻辑
   - 目标覆盖率: >80%

2. **API 日志集成测试** (4.12-INT-001 至 4.12-INT-004):
   - 验证 API 错误日志正确记录
   - 验证日志链追踪 (documentId 一致性)
   - 验证错误日志发送到 Axiom

### Priority 2: Important Tests (Should Implement)

3. **端到端日志链追踪** (4.12-E2E-001):
   - 完整流程: 上传 → 解析 → 分块 → 向量化 → 查询 → 生成回答
   - 验证日志链完整,可追踪

### Priority 3: Manual Tests (Hand动验证)

4. **Axiom 配置和 Dashboard 验证**:
   - Saved Queries, Monitoring Dashboard, 告警规则
   - 手动触发错误,验证告警发送

5. **文档完整性验证**:
   - 运维文档、开发者文档的完整性和准确性

---

## Risk Assessment

Based on gaps identified, recommend:

1. **Testing Priority**:
   - **High**: Logger 单元测试 (TEST-001 风险)
   - **High**: API 日志集成测试 (MNT-001 风险)
   - **Medium**: Axiom 配置验证 (OPS-001 风险)

2. **Development Focus**:
   - 修复 API Routes 层 console 日志 (MNT-001)
   - 添加 Logger 单元测试 (TEST-001)
   - 完成 Axiom 手动配置任务 (OPS-001)

3. **Deployment Strategy**:
   - 代码修复后先部署到 Dev 环境验证
   - Axiom 配置完成后再部署到 Production
   - 监控配额使用,避免超出 Free 计划限制

---

## Integration with Quality Gates

**Gate Mapping**:
- **测试覆盖率 <80%** → Gate = FAIL (当前状态)
- **API 日志未迁移** → Gate = FAIL (当前状态)
- **手动任务未完成** → Gate = CONCERNS (当前状态)
- **所有 Critical 测试通过** → Gate = PASS (目标状态)

---

## Key Principles

- **Shift Left**: 优先单元测试,快速反馈
- **Risk-Based**: 聚焦 High Risk 测试 (Logger, API 日志)
- **Efficient Coverage**: 单元测试覆盖核心逻辑,集成测试覆盖关键路径
- **Maintainability**: 测试代码清晰,易于维护
- **Fast Feedback**: 单元测试快速执行 (<1s),集成测试 <10s
