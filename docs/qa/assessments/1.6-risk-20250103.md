# 风险评估: Story 1.6 - 用户账户管理页面

**日期**: 2025-01-03  
**评审人**: Quinn (测试架构师)  
**Story**: 1.6 - 用户账户管理页面

---

## 执行摘要

- **识别的风险总数**: 12
- **严重风险**: 3 (score 9)
- **高风险**: 2 (score 6)
- **中风险**: 4 (score 4)
- **低风险**: 3 (score 2-3)
- **风险评分**: 52/100

**关键发现**: 此 Story 涉及多个高风险操作,包括密码修改、账户删除和级联数据删除。必须重点关注安全验证、数据完整性和错误恢复机制。

---

## 需要立即关注的严重风险

### 1. [SEC-001] 密码修改功能的暴力破解风险

**评分: 9 (严重)**  
**概率**: 高 (3) - 密码修改是常见攻击目标  
**影响**: 高 (3) - 账户被接管,数据泄露

**详细描述**:  
即使有 rate limiting (5分钟3次),攻击者仍可能通过分布式攻击或慢速攻击绕过限制。当前密码验证失败后没有锁定机制。

**受影响组件**:
- `src/app/api/user/password/route.ts`
- `ChangePasswordModal.tsx`

**缓解措施**:
- ✅ 已有: Rate limiting (5分钟3次)
- 🔴 必须添加: 连续失败3次后临时锁定账户(15分钟)
- 🔴 必须添加: 记录所有密码修改尝试到审计日志
- 🔴 必须添加: 发送密码修改通知邮件
- 🟡 建议添加: 要求输入当前登录的邮箱验证码

**测试要求**:
- 安全测试: 模拟暴力破解攻击
- 单元测试: 验证 rate limiting 和锁定机制
- 集成测试: 验证审计日志记录

**剩余风险**: 中 - 即使有上述措施,仍存在社会工程学攻击风险

---

### 2. [DATA-001] 账户删除的级联删除风险

**评分: 9 (严重)**  
**概率**: 中 (2) - 用户可能误操作或被社会工程学攻击  
**影响**: 高 (3) - 所有用户数据永久丢失,无法恢复

**详细描述**:  
删除账户会级联删除所有相关数据(文档、对话记录、使用量统计)。一旦删除无法恢复,且当前只有邮箱确认这一道防线。

**受影响组件**:
- `src/app/api/user/account/route.ts`
- `DeleteAccountModal.tsx`
- `drizzle/schema.ts` (CASCADE 关系)

**缓解措施**:
- ✅ 已有: 邮箱确认输入
- ✅ 已有: Rate limiting (1小时1次)
- 🔴 必须添加: 软删除机制(标记为删除,30天后真正删除)
- 🔴 必须添加: 删除前创建数据备份
- 🔴 必须添加: 发送确认邮件(带撤销链接,24小时有效)
- 🟡 建议添加: 要求输入"DELETE"文本确认
- 🟡 建议添加: 显示用户将要失去的数据统计

**测试要求**:
- 集成测试: 验证软删除和数据保留
- 集成测试: 验证数据恢复流程
- 手动测试: 验证邮件通知和撤销链接

**剩余风险**: 中 - 30天缓冲期后仍会永久删除

---

### 3. [SEC-002] Session 清除不彻底的风险

**评分: 9 (严重)**  
**概率**: 高 (3) - 多端登录场景常见  
**影响**: 高 (3) - 删除账户后仍可访问系统

**详细描述**:  
当前实现只清除当前 session 和客户端存储。如果用户在多个设备登录,其他设备的 session 仍然有效,删除账户后仍可访问系统。

**受影响组件**:
- `src/app/api/user/account/route.ts`
- `DeleteAccountModal.tsx`
- NextAuth session 管理

**缓解措施**:
- ✅ 已有: 清除当前 session 和客户端存储
- 🔴 必须添加: 清除数据库中所有该用户的 session 记录
- 🔴 必须添加: 使用 NextAuth 的 session 失效机制
- 🔴 必须添加: 验证删除后立即查询用户返回 404
- 🟡 建议添加: 实现全局 session 管理表

**测试要求**:
- 集成测试: 模拟多设备登录场景
- 集成测试: 验证删除后所有 session 失效
- 手动测试: 在多个浏览器/设备测试

**剩余风险**: 低 - 完成上述措施后风险可控

---

## 高风险

### 4. [SEC-003] OAuth 用户的密码修改权限控制

**评分: 6 (高)**  
**概率**: 中 (2) - API 调用可能绕过前端检查  
**影响**: 高 (3) - OAuth 用户设置密码可能导致账户不一致

**详细描述**:  
前端隐藏了 OAuth 用户的"修改密码"按钮,但 API 端点必须也要验证 `authProvider` 和 `passwordHash`,防止直接 API 调用绕过。

**缓解措施**:
- ✅ 已有: API 验证 `passwordHash` 是否存在
- 🟡 建议添加: 验证 `authProvider === 'EMAIL'`
- 🟡 建议添加: 记录所有非法尝试

**测试要求**:
- 单元测试: OAuth 用户调用修改密码 API 返回 400
- 安全测试: 尝试直接调用 API

---

### 5. [DATA-002] 使用量统计数据不一致风险

**评分: 6 (高)**  
**概率**: 高 (3) - 新用户没有 usage 记录  
**影响**: 中 (2) - 显示错误或 UI 崩溃

**详细描述**:  
`user_usage` 表不是用户注册时自动创建的,导致首次访问设置页面时可能没有数据。当前实现返回默认值,但可能导致数据不一致。

**缓解措施**:
- ✅ 已有: 返回默认值 0
- 🟡 建议添加: 用户注册时自动创建 `user_usage` 记录
- 🟡 建议添加: 首次查询时自动创建记录

**测试要求**:
- 单元测试: 新用户访问 usage API
- 集成测试: 注册后立即访问设置页面

---

## 中风险

### 6. [PERF-001] Rate Limiting 的分布式场景

**评分: 4 (中)**  
**概率**: 中 (2) - 多实例部署常见  
**影响**: 中 (2) - Rate limiting 失效

**详细描述**:  
当前 rate limiting 实现基于内存,多实例部署时每个实例独立计数,实际限制会成倍放宽。

**缓解措施**:
- 🟡 建议添加: 使用 Redis 或数据库实现分布式 rate limiting
- 🟡 建议添加: 在部署文档中说明当前限制

**测试要求**:
- 性能测试: 多实例场景下的 rate limiting

---

### 7. [OPS-001] 密码强度指示器的误导性

**评分: 4 (中)**  
**概率**: 中 (2) - 用户依赖强度指示器  
**影响**: 中 (2) - 弱密码被认为是强密码

**详细描述**:  
当前密码强度指示器逻辑较简单,可能给弱密码打高分。例如 "12345678a" 符合"包含字母和数字"但很弱。

**缓解措施**:
- 🟡 建议添加: 使用 zxcvbn 等专业密码强度库
- 🟡 建议添加: 检查常见弱密码字典

**测试要求**:
- 单元测试: 各种密码强度场景

---

### 8. [SEC-004] CSRF Token 依赖 NextAuth 内置保护

**评分: 4 (中)**  
**概率**: 中 (2) - NextAuth 配置可能不完整  
**影响**: 中 (2) - CSRF 攻击风险

**详细描述**:  
Story 假设 NextAuth 提供 CSRF 保护,但没有明确验证。需要确认 NextAuth 配置正确启用了 CSRF Token。

**缓解措施**:
- 🔴 必须验证: NextAuth CSRF 配置正确
- 🟡 建议添加: 敏感操作添加额外的 CSRF Token 验证

**测试要求**:
- 安全测试: CSRF 攻击模拟

---

### 9. [OPS-002] 用户名修改的实时验证不足

**评分: 4 (中)**  
**概率**: 中 (2) - 用户可能输入特殊字符  
**影响**: 中 (2) - 数据库错误或 XSS 风险

**详细描述**:  
当前只验证长度(2-50字符),没有验证字符类型。用户名可能包含 HTML/SQL 特殊字符。

**缓解措施**:
- 🟡 建议添加: 限制字符类型(字母、数字、中文、空格、连字符)
- 🟡 建议添加: 前端和后端都进行 XSS 过滤
- 🟡 建议添加: 显示允许字符的提示

**测试要求**:
- 单元测试: 特殊字符输入
- 安全测试: XSS 注入尝试

---

## 低风险

### 10. [PERF-002] 存储空间格式化性能

**评分: 3 (低)**  
**概率**: 低 (1) - 只在设置页面计算  
**影响**: 高 (3) - 大数值可能导致精度问题

**详细描述**:  
`formatStorageSize` 函数使用简单的除法转换,对于超大存储值(TB级别)可能有精度问题。

**缓解措施**:
- 🟢 低优先级: 使用库函数(如 `bytes`)
- 🟢 低优先级: 添加 TB 级别支持

**测试要求**:
- 单元测试: 各种存储大小转换

---

### 11. [OPS-003] 日期格式化的国际化问题

**评分: 3 (低)**  
**概率**: 低 (1) - 当前只支持中文  
**影响**: 高 (3) - 国际化时需要重构

**详细描述**:  
`formatDate` 函数硬编码使用 `'zh-CN'` 格式,国际化时需要重构。

**缓解措施**:
- 🟢 低优先级: 使用 i18n 库
- 🟢 低优先级: 从用户偏好读取语言

**测试要求**:
- 手动测试: 不同语言环境

---

### 12. [UI-001] 加载状态的用户体验

**评分: 2 (低)**  
**概率**: 中 (2) - 网络慢时常见  
**影响**: 低 (1) - 用户等待体验差

**详细描述**:  
当前只有简单的 spinner,没有 skeleton loading 或进度提示。

**缓解措施**:
- 🟢 低优先级: 使用 Skeleton 组件
- 🟢 低优先级: 添加加载进度提示

**测试要求**:
- 手动测试: 慢网络场景

---

## 风险矩阵

| 风险 ID | 描述 | 概率 | 影响 | 评分 | 优先级 |
|---------|------|------|------|------|--------|
| SEC-001 | 密码修改暴力破解 | 高 (3) | 高 (3) | 9 | 严重 |
| DATA-001 | 账户删除级联删除 | 高 (3) | 高 (3) | 9 | 严重 |
| SEC-002 | Session 清除不彻底 | 高 (3) | 高 (3) | 9 | 严重 |
| SEC-003 | OAuth 用户密码修改 | 中 (2) | 高 (3) | 6 | 高 |
| DATA-002 | 使用量统计不一致 | 高 (3) | 中 (2) | 6 | 高 |
| PERF-001 | Rate Limiting 分布式 | 中 (2) | 中 (2) | 4 | 中 |
| OPS-001 | 密码强度指示器 | 中 (2) | 中 (2) | 4 | 中 |
| SEC-004 | CSRF Token 验证 | 中 (2) | 中 (2) | 4 | 中 |
| OPS-002 | 用户名验证不足 | 中 (2) | 中 (2) | 4 | 中 |
| PERF-002 | 存储格式化精度 | 低 (1) | 高 (3) | 3 | 低 |
| OPS-003 | 日期格式化国际化 | 低 (1) | 高 (3) | 3 | 低 |
| UI-001 | 加载状态体验 | 中 (2) | 低 (1) | 2 | 低 |

---

## 风险分布

### 按类别

- **安全 (SEC)**: 4 个风险 (3个严重/高风险)
- **数据 (DATA)**: 2 个风险 (2个严重/高风险)  
- **性能 (PERF)**: 2 个风险 (1个中风险, 1个低风险)
- **运维 (OPS)**: 3 个风险 (2个中风险, 1个低风险)
- **界面 (UI)**: 1 个风险 (低风险)

### 按组件

- **API 端点**: 8 个风险
- **前端组件**: 4 个风险
- **数据库 Schema**: 2 个风险
- **Session 管理**: 2 个风险

---

## 基于风险的测试策略

### 优先级 1: 严重风险测试

**SEC-001: 密码修改暴力破解**
- 安全测试: 模拟暴力破解攻击(每秒100次尝试)
- 单元测试: Rate limiting 计数器正确性
- 集成测试: 连续失败后账户锁定
- 集成测试: 审计日志记录所有尝试

**DATA-001: 账户删除级联删除**
- 集成测试: 软删除标记正确设置
- 集成测试: 30天后数据真正删除
- 集成测试: 删除前备份创建成功
- 集成测试: 邮件撤销链接功能
- 手动测试: 端到端删除和恢复流程

**SEC-002: Session 清除**
- 集成测试: 多设备 session 同时失效
- 集成测试: 删除后立即访问返回 401
- 手动测试: 不同浏览器/设备场景

### 优先级 2: 高风险测试

**SEC-003: OAuth 用户密码修改**
- 单元测试: OAuth 用户调用修改密码 API 返回 400
- 安全测试: 绕过前端直接调用 API

**DATA-002: 使用量统计**
- 单元测试: 新用户访问 usage API 返回默认值
- 集成测试: 注册流程自动创建 usage 记录

### 优先级 3: 中风险测试

- **PERF-001**: 多实例 rate limiting 测试
- **OPS-001**: 各种密码强度场景测试
- **SEC-004**: CSRF 攻击模拟
- **OPS-002**: 特殊字符和 XSS 注入测试

---

## 风险接受标准

### 生产环境上线前必须修复

- 所有严重风险 (score 9)
- 影响安全和数据完整性的高风险

### 可以带风险上线(但需缓解措施)

- 中风险(有监控和补偿控制)
- 低风险(有明确的未来改进计划)

### 已接受的风险

| 风险 ID | 接受理由 | 补偿措施 | 批准人 |
|---------|----------|----------|--------|
| PERF-002 | MVP 不支持 TB 级存储 | 文档说明限制 | 待定 |
| OPS-003 | MVP 只支持中文 | i18n 规划在 v2.0 | 待定 |
| UI-001 | 用户体验优化非阻塞 | 后续迭代改进 | 待定 |

---

## 监控要求

生产环境部署后必须监控:

### 安全指标
- 密码修改失败率和尝试次数
- Rate limiting 触发频率
- OAuth 用户非法密码修改尝试
- CSRF Token 验证失败次数

### 数据完整性指标
- 账户删除请求数量
- 软删除数据恢复请求
- 使用量统计查询失败率
- 级联删除异常

### 性能指标
- API 响应时间(p50, p95, p99)
- 数据库查询性能
- Session 查询性能

### 业务指标
- 密码修改成功率
- 用户名修改频率
- 账户删除率(每日/每周/每月)

---

## 风险评审触发条件

以下情况发生时需要重新评估风险:

1. 认证机制发生重大变更
2. 新增 OAuth 提供商
3. 数据库 schema 修改
4. 发现新的安全漏洞
5. 用户报告数据丢失或账户异常
6. 监控发现异常指标
7. 法规要求变更(如 GDPR)

---

## 关键原则

1. **安全优先**: 所有敏感操作必须有多重验证
2. **数据保护**: 删除操作必须有恢复机制
3. **防御深度**: 前端和后端都要验证
4. **审计追踪**: 记录所有关键操作
5. **最小权限**: OAuth 用户不应设置密码
6. **优雅降级**: 错误不应导致数据丢失

---

**评审结论**:  
Story 1.6 包含多个高风险操作,**不建议直接上线生产环境**。必须先解决 3 个严重风险(SEC-001, DATA-001, SEC-002),并对所有严重和高风险进行充分测试。

**建议**: 在 staging 环境进行至少 1 周的测试,包括安全测试、压力测试和多设备场景测试。

