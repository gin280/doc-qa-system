# 风险评估：Story 1.3 - 用户注册功能

**日期**: 2025-01-03  
**审查人**: Quinn (测试架构师)

## 执行摘要

- **识别的总风险**: 8
- **关键风险**: 1
- **高风险**: 2  
- **中风险**: 3
- **低风险**: 2
- **风险评分**: 60/100

## 需要立即关注的关键风险

### 1. TEST-001: Jest 模块解析失败

**评分: 9 (关键)**  
**概率**: 高 - 当前测试无法运行  
**影响**: 高 - 阻止所有 API 单元测试执行  
**缓解措施**:
- 立即修复 Jest 配置中的 `@/drizzle/*` 路径映射
- 或重构导入以使用相对路径
- 验证所有测试可以成功运行

**测试重点**: 
- 验证 Jest moduleNameMapper 正确解析路径
- 确保所有单元测试可执行
- 创建 CI/CD 集成以防止回归

---

### 2. SEC-001: 缺少速率限制

**评分: 6 (高)**  
**概率**: 中 - 常见的攻击向量  
**影响**: 高 - 可能遭受暴力攻击、垃圾注册  
**缓解措施**:
- 在注册端点添加速率限制中间件（建议: 每 IP 每小时 5 次尝试）
- 考虑添加 CAPTCHA 验证
- 实施邮箱验证流程

**测试重点**:
- 负载测试验证速率限制有效
- 手动测试尝试超过限制的注册

---

### 3. SEC-002: 缺少邮箱验证流程

**评分**: 6 (高)  
**概率**: 高 - 注册后立即可用  
**影响**: 中 - 可能创建虚假账户  
**缓解措施**:
- 实施邮箱验证令牌系统
- 在验证前限制账户功能
- 添加重新发送验证邮件功能

**测试重点**:
- 验证未验证邮箱的账户功能受限
- 测试验证令牌的生成和过期

## 风险分布

### 按类别

- **测试基础设施**: 1 个风险（1 个关键）
- **安全**: 3 个风险（2 个高，1 个中）
- **可靠性**: 2 个风险（2 个中）
- **性能**: 1 个风险（1 个低）
- **可维护性**: 1 个风险（1 个低）

### 按组件

- **测试基础设施**: 1 个风险（关键）
- **API 端点**: 3 个风险（2 高，1 中）
- **前端表单**: 2 个风险（1 中，1 低）
- **数据库操作**: 1 个风险（中）
- **监控/日志**: 1 个风险（低）

## 详细风险登记册

| 风险 ID   | 描述                    | 概率   | 影响   | 评分 | 优先级 |
| --------- | ----------------------- | ------ | ------ | ---- | ------ |
| TEST-001  | Jest 模块解析失败       | 高 (3) | 高 (3) | 9    | 关键   |
| SEC-001   | 缺少速率限制            | 中 (2) | 高 (3) | 6    | 高     |
| SEC-002   | 缺少邮箱验证            | 高 (3) | 中 (2) | 6    | 高     |
| REL-001   | 数据库事务未包装        | 中 (2) | 中 (2) | 4    | 中     |
| SEC-003   | 缺少 CSRF 保护          | 中 (2) | 中 (2) | 4    | 中     |
| REL-002   | 错误日志不完整          | 中 (2) | 中 (2) | 4    | 中     |
| PERF-001  | bcrypt 可能阻塞事件循环 | 低 (1) | 中 (2) | 2    | 低     |
| MNT-001   | 前端缺少类型导出        | 低 (1) | 低 (1) | 1    | 低     |

## 风险缓解策略

### TEST-001: Jest 模块解析失败

**策略**: 预防性  
**行动**:
- 调查并修复 Jest 配置中的 moduleNameMapper
- 考虑使用 tsconfig-paths-jest 或类似工具
- 验证所有路径别名在测试环境中正确工作
- 添加 CI 检查以防止测试基础设施回归

**测试要求**:
- 所有现有单元测试必须通过
- 验证新测试可以正确导入模块
- CI/CD 管道必须运行测试

**剩余风险**: 低 - 修复后应完全解决

**负责人**: dev  
**时间线**: 在任何新功能之前必须修复

---

### SEC-001: 缺少速率限制

**策略**: 预防性  
**行动**:
- 安装并配置速率限制中间件（如 `next-rate-limit` 或 Redis）
- 在注册端点应用速率限制（建议: 每 IP 每小时 5 次）
- 添加友好的速率限制错误消息
- 考虑为已知良好 IP 设置白名单

**测试要求**:
- 负载测试验证速率限制正常工作
- 手动测试超过限制后的行为
- 验证错误消息清晰

**剩余风险**: 低 - 实施后风险大幅降低

**负责人**: dev  
**时间线**: 在生产部署前

---

### SEC-002: 缺少邮箱验证

**策略**: 预防性  
**行动**:
- 实施邮箱验证令牌系统
- 创建邮箱发送服务集成
- 添加验证状态字段到用户表
- 在验证前限制某些功能

**测试要求**:
- 验证邮件发送和令牌生成
- 测试令牌过期逻辑
- 确保未验证用户功能受限

**剩余风险**: 中 - 完全实施需要额外的 Story

**负责人**: po (决定是否为 MVP 必需)  
**时间线**: Story 1.4 或后续 Sprint

---

### REL-001: 数据库事务未包装

**策略**: 预防性  
**行动**:
- 将用户创建和 UserUsage 初始化包装在事务中
- 添加错误处理和回滚逻辑
- 测试失败场景（如 UserUsage 创建失败）

**测试要求**:
- 集成测试验证事务回滚
- 模拟数据库错误场景

**剩余风险**: 低

**负责人**: dev  
**时间线**: 下次代码审查周期

---

### SEC-003: 缺少 CSRF 保护

**策略**: 预防性  
**行动**:
- 评估 Next.js 应用的 CSRF 风险
- 如果使用 cookie-based 会话，添加 CSRF 令牌
- 如果使用 JWT（当前），文档说明 CSRF 缓解策略

**测试要求**:
- 安全扫描工具（如 OWASP ZAP）
- 手动 CSRF 攻击尝试

**剩余风险**: 中 - 取决于认证实施

**负责人**: architect  
**时间线**: Story 1.4（登录功能）

---

### REL-002: 错误日志不完整

**策略**: 检测性  
**行动**:
- 添加结构化日志记录
- 记录所有关键操作（注册尝试、验证失败、错误）
- 集成应用监控工具（如 Sentry）

**测试要求**:
- 验证日志输出包含必要上下文
- 确保敏感信息（密码）不被记录

**剩余风险**: 低

**负责人**: dev  
**时间线**: 与监控系统集成时

---

### PERF-001: bcrypt 可能阻塞

**策略**: 监控  
**行动**:
- 当前 salt rounds (10) 是可接受的
- 考虑在高负载时使用异步 worker
- 监控注册端点响应时间

**测试要求**:
- 性能测试验证响应时间 < 500ms
- 负载测试验证并发注册性能

**剩余风险**: 低 - 当前配置合理

**负责人**: N/A（监控）  
**时间线**: 如果性能问题出现时

---

### MNT-001: 前端缺少类型导出

**策略**: 预防性  
**行动**:
- 将共享类型提取到 `src/types/auth.ts`
- 导出 RegisterFormData 类型供其他组件使用
- 改进类型重用

**测试要求**:
- TypeScript 编译无错误
- IDE 自动完成正常工作

**剩余风险**: 极低

**负责人**: dev  
**时间线**: 代码重构时

## 基于风险的测试策略

### 优先级 1：关键风险测试

**TEST-001 修复**:
- 必须能够运行所有单元测试
- CI/CD 管道集成
- 测试覆盖率报告

### 优先级 2：高风险测试

**安全测试**:
- 速率限制测试（手动 + 自动化）
- 输入验证测试（SQL 注入、XSS）
- 密码哈希验证

**可靠性测试**:
- 数据库事务测试
- 错误恢复测试
- 并发注册测试

### 优先级 3：中/低风险测试

**性能测试**:
- 响应时间基准测试
- 并发用户负载测试

## 风险接受标准

### 生产部署前必须修复

- TEST-001: Jest 测试基础设施
- SEC-001: 速率限制（至少基本实现）
- REL-001: 数据库事务

### 可通过缓解措施部署

- SEC-002: 邮箱验证（如果有人工审核流程）
- SEC-003: CSRF 保护（取决于认证策略）

### 已接受的风险

- PERF-001: bcrypt 性能（当前配置合理）
- MNT-001: 类型导出（不影响功能）

## 监控要求

部署后监控：

- **错误率**: 注册失败的频率
- **性能指标**: P95 响应时间
- **安全事件**: 速率限制触发、验证失败
- **业务 KPI**: 注册完成率、验证率（如果实施）

## 风险审查触发条件

在以下情况下重新审查风险：

- 认证架构发生重大变化
- 集成新的第三方服务
- 发现安全漏洞
- 性能问题报告
- 监管要求变化

## 关键原则

- 尽早系统地识别风险
- 使用一致的概率 × 影响评分
- 提供可操作的缓解策略
- 将风险与具体测试要求关联
- 修复后跟踪剩余风险
- 随 Story 演变更新风险档案

