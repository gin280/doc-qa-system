# Test Design: Story 2.4 - 文档分块与向量化

Date: 2025-01-05
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 42
- **Unit tests**: 22 (52%)
- **Integration tests**: 16 (38%)
- **E2E tests**: 4 (10%)
- **Priority distribution**: P0: 24, P1: 12, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: 创建文档分块服务

**Core Functionality**: ChunkingService creation and basic operation

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-001 | Unit | P0 | ChunkingService exports chunkDocument function | Pure module interface validation |
| 2.4-UNIT-002 | Unit | P0 | RecursiveCharacterTextSplitter is instantiated with correct params | Algorithm configuration validation |
| 2.4-UNIT-003 | Unit | P0 | chunkDocument validates document exists before processing | Input validation logic |
| 2.4-UNIT-004 | Unit | P1 | chunkDocument preserves chunk metadata (index, length) | Data structure validation |
| 2.4-INT-001 | Integration | P0 | chunkDocument reads parsed content from documents table | Database read operation |
| 2.4-INT-002 | Integration | P0 | chunkDocument saves chunks to document_chunks table | Database write operation |
| 2.4-INT-003 | Integration | P1 | chunkDocument returns array of ChunkResult objects | Service interface contract |

### AC2: 分块策略和参数

**Core Functionality**: Chunking algorithm configuration and behavior

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-005 | Unit | P0 | TextSplitter uses chunkSize=1000, chunkOverlap=200 | Configuration validation |
| 2.4-UNIT-006 | Unit | P0 | Separator priority order is correctly set | Algorithm behavior |
| 2.4-UNIT-007 | Unit | P1 | Chunks split on paragraph boundaries first | Algorithm behavior validation |
| 2.4-UNIT-008 | Unit | P1 | Chunks don't break words or sentences mid-stream | Quality validation |
| 2.4-UNIT-009 | Unit | P1 | Chinese text is properly handled with correct separators | Internationalization |
| 2.4-INT-004 | Integration | P1 | ChunkIndex is sequential starting from 0 | Data integrity |
| 2.4-INT-005 | Integration | P2 | Chunk metadata includes all required fields | Data completeness |

### AC3: 创建向量化服务

**Core Functionality**: EmbeddingService creation and vector generation

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-010 | Unit | P0 | EmbeddingService exports embedAndStoreChunks function | Module interface validation |
| 2.4-UNIT-011 | Unit | P0 | embedAndStoreChunks validates documentId exists | Input validation |
| 2.4-UNIT-012 | Unit | P0 | Batch size is correctly configured (20 chunks/batch) | Configuration validation |
| 2.4-UNIT-013 | Unit | P1 | Generated embeddings are 1536-dimensional vectors | Output structure validation |
| 2.4-INT-006 | Integration | P0 | embedAndStoreChunks calls LLM Repository for embeddings | Service integration |
| 2.4-INT-007 | Integration | P0 | embedAndStoreChunks calls VectorRepository.upsertBatch | Vector storage integration |
| 2.4-INT-008 | Integration | P0 | embeddingId is updated in document_chunks table | Database update operation |
| 2.4-INT-009 | Integration | P0 | Document status is updated to 'READY' after completion | State management |

### AC4: 通用向量接口实现

**Core Functionality**: VectorRepository interface and factory pattern

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-014 | Unit | P0 | IVectorRepository interface defines all required methods | Interface contract |
| 2.4-UNIT-015 | Unit | P0 | PgVectorRepository implements IVectorRepository | Type safety validation |
| 2.4-UNIT-016 | Unit | P1 | VectorRepositoryFactory returns correct implementation based on config | Factory pattern validation |
| 2.4-UNIT-017 | Unit | P1 | VectorConfig supports pgvector and pinecone providers | Configuration flexibility |
| 2.4-INT-010 | Integration | P0 | PgVectorRepository.upsert inserts vector correctly | Single insert operation |
| 2.4-INT-011 | Integration | P0 | PgVectorRepository.upsertBatch inserts multiple vectors | Batch insert operation |

### AC5: pgvector数据库集成

**Core Functionality**: pgvector extension and operations

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-INT-012 | Integration | P0 | pgvector extension is enabled in database | Database setup validation |
| 2.4-INT-013 | Integration | P0 | document_chunks.embedding column exists and is vector(1536) type | Schema validation |
| 2.4-INT-014 | Integration | P0 | Vector index is created (ivfflat or hnsw) | Index validation |
| 2.4-INT-015 | Integration | P0 | PgVectorRepository.search performs cosine similarity search | Search operation |
| 2.4-INT-016 | Integration | P1 | Search supports filtering by userId and documentId | Filter functionality |
| 2.4-INT-017 | Integration | P1 | Search returns results ordered by similarity score | Result ordering |
| 2.4-E2E-001 | E2E | P1 | Complete vector search workflow returns relevant chunks | End-to-end validation |

### AC6: 批量处理优化

**Core Functionality**: Batch processing for efficiency

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-018 | Unit | P1 | Batch processing splits chunks into batches of 20 | Batch logic validation |
| 2.4-UNIT-019 | Unit | P1 | Failed batch does not affect successful batches | Error isolation |
| 2.4-INT-018 | Integration | P0 | Batch processing uses Promise.all for parallel execution | Concurrency validation |
| 2.4-INT-019 | Integration | P1 | Single API call generates multiple embeddings | API efficiency |
| 2.4-INT-020 | Integration | P1 | Failed chunks are logged with their IDs | Error tracking |
| 2.4-E2E-002 | E2E | P1 | Large document (100+ chunks) is processed efficiently | Performance validation |

### AC7: 文档状态流转

**Core Functionality**: Document status state machine

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-020 | Unit | P0 | Status transitions follow correct order (READY→EMBEDDING→READY) | State machine logic |
| 2.4-UNIT-021 | Unit | P0 | Status transitions to FAILED on error with error details | Error state handling |
| 2.4-INT-021 | Integration | P0 | Status is atomically updated using Drizzle ORM | Database transaction |
| 2.4-INT-022 | Integration | P1 | chunksCount is updated when processing completes | Metadata update |
| 2.4-INT-023 | Integration | P1 | parsedAt timestamp is preserved during processing | Data preservation |
| 2.4-INT-024 | Integration | P2 | Retry mechanism clears old chunks before reprocessing | Cleanup logic |

### AC8: 错误处理与监控

**Core Functionality**: Comprehensive error handling

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-022 | Unit | P0 | ChunkingError is thrown with correct error type | Error classification |
| 2.4-INT-025 | Integration | P0 | CHUNKING_ERROR is caught and logged to metadata | Error handling |
| 2.4-INT-026 | Integration | P0 | EMBEDDING_ERROR is caught and logged to metadata | Error handling |
| 2.4-INT-027 | Integration | P0 | EMBEDDING_TIMEOUT is caught and logged to metadata | Timeout handling |
| 2.4-INT-028 | Integration | P0 | STORAGE_ERROR is caught and logged to metadata | Storage error handling |
| 2.4-INT-029 | Integration | P1 | QUOTA_EXCEEDED is caught and logged to metadata | Rate limit handling |
| 2.4-INT-030 | Integration | P1 | Error messages include chunk index and details | Error detail logging |

### AC9: 性能要求

**Core Functionality**: Performance benchmarks

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-E2E-003 | E2E | P0 | 10KB document processes in < 10 seconds | Performance requirement |
| 2.4-E2E-004 | E2E | P0 | 100KB document processes in < 60 seconds | Performance requirement |
| 2.4-INT-031 | Integration | P1 | Batch vectorization API call completes in < 3 seconds | API performance |
| 2.4-INT-032 | Integration | P1 | 1000 chunks insert into pgvector in < 5 seconds | Database performance |
| 2.4-INT-033 | Integration | P2 | Vercel function maxDuration is configured to 300 seconds | Configuration validation |

### AC10: API端点实现

**Core Functionality**: API endpoints for triggering processing

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-INT-034 | Integration | P0 | POST /api/documents/[id]/process requires authentication | Security validation |
| 2.4-INT-035 | Integration | P0 | POST /api/documents/[id]/process validates document ownership | Authorization validation |
| 2.4-INT-036 | Integration | P0 | POST /api/documents/[id]/process checks document status is READY | Business logic validation |
| 2.4-INT-037 | Integration | P0 | POST /api/documents/[id]/process calls chunkDocument and embedAndStoreChunks | Service orchestration |
| 2.4-INT-038 | Integration | P0 | POST /api/documents/[id]/process returns processing results | Response validation |
| 2.4-INT-039 | Integration | P1 | GET /api/documents/[id]/chunks requires authentication | Security validation |
| 2.4-INT-040 | Integration | P1 | GET /api/documents/[id]/chunks supports pagination (limit, offset) | Pagination validation |
| 2.4-INT-041 | Integration | P1 | POST /api/documents/[id]/process returns 409 if already processing | Concurrency handling |
| 2.4-INT-042 | Integration | P2 | maxDuration=300 is configured for process route | Configuration validation |

## Risk Coverage

This test design addresses the following risks identified in the risk profile:

### High-Priority Risks
- **PERF-001**: Performance degradation with large documents → Covered by 2.4-E2E-003, 2.4-E2E-004
- **SEC-001**: Unauthorized access to processing APIs → Covered by 2.4-INT-034, 2.4-INT-035, 2.4-INT-039
- **DATA-001**: Vector data corruption during batch processing → Covered by 2.4-INT-018, 2.4-UNIT-019
- **TECH-001**: LLM API failures or timeouts → Covered by 2.4-INT-027, 2.4-INT-029

### Medium-Priority Risks
- **TECH-002**: pgvector performance issues → Covered by 2.4-INT-032
- **OPS-001**: Concurrent processing conflicts → Covered by 2.4-INT-041
- **DATA-002**: Incomplete chunk metadata → Covered by 2.4-INT-005

## Test Coverage Analysis

### By Acceptance Criterion
- AC1 (ChunkingService): 7 tests (3 unit, 4 integration)
- AC2 (Chunking Strategy): 7 tests (5 unit, 2 integration)
- AC3 (EmbeddingService): 8 tests (4 unit, 4 integration)
- AC4 (Vector Interface): 6 tests (4 unit, 2 integration)
- AC5 (pgvector Integration): 7 tests (0 unit, 6 integration, 1 e2e)
- AC6 (Batch Processing): 6 tests (2 unit, 3 integration, 1 e2e)
- AC7 (Status Management): 6 tests (2 unit, 4 integration)
- AC8 (Error Handling): 7 tests (1 unit, 6 integration)
- AC9 (Performance): 5 tests (0 unit, 3 integration, 2 e2e)
- AC10 (API Endpoints): 9 tests (0 unit, 9 integration)

**Total**: 68 test scenarios across all acceptance criteria

### Coverage Gaps
- None identified - all ACs have comprehensive test coverage

## Test File Organization

### Unit Tests
```
tests/unit/
├── infrastructure/
│   └── vector/
│       ├── pgvector.repository.test.ts          # Tests: 2.4-UNIT-014, 015, 016, 017
│       └── vector-repository.factory.test.ts    # Tests: 2.4-UNIT-016, 017
├── services/
│   ├── chunkingService.test.ts                  # Tests: 2.4-UNIT-001-009, 020-022
│   └── embeddingService.test.ts                 # Tests: 2.4-UNIT-010-013, 018, 019
└── config/
    └── vector.config.test.ts                    # Tests: 2.4-UNIT-017
```

### Integration Tests
```
tests/integration/
├── api/
│   ├── process.test.ts                          # Tests: 2.4-INT-034-042
│   └── chunks.test.ts                           # Tests: 2.4-INT-039, 040
├── services/
│   ├── chunkingService.integration.test.ts      # Tests: 2.4-INT-001-005
│   └── embeddingService.integration.test.ts     # Tests: 2.4-INT-006-009, 018-033
└── db/
    └── pgvector.integration.test.ts             # Tests: 2.4-INT-010-017
```

### E2E Tests
```
tests/e2e/
└── document-processing-flow.test.ts             # Tests: 2.4-E2E-001-004
```

## Recommended Execution Order

### Phase 1: Fast Feedback (Unit Tests - ~30 seconds)
1. P0 Unit tests (2.4-UNIT-001 through 2.4-UNIT-022)
   - Run first for immediate feedback on pure logic
   - No external dependencies
   - Fast execution

### Phase 2: Integration Validation (~3-5 minutes)
2. P0 Integration tests - Database operations
   - Tests: 2.4-INT-001, 002, 010, 011, 012, 013, 014
3. P0 Integration tests - Service integration
   - Tests: 2.4-INT-006, 007, 008, 009, 018
4. P0 Integration tests - API endpoints
   - Tests: 2.4-INT-034, 035, 036, 037, 038
5. P0 Integration tests - Error handling
   - Tests: 2.4-INT-025, 026, 027, 028

### Phase 3: Extended Coverage (~5-10 minutes)
6. P1 Integration tests
   - All remaining P1 integration tests
7. P1 E2E tests
   - Tests: 2.4-E2E-001, 002

### Phase 4: Performance Validation (~2-3 minutes)
8. P0 E2E performance tests
   - Tests: 2.4-E2E-003, 004
9. P2 tests (as time permits)

## Test Data Requirements

### Test Documents
- **Small document**: 10KB, ~10 chunks (plain text)
- **Medium document**: 50KB, ~50 chunks (mixed formatting)
- **Large document**: 100KB, ~100 chunks (complex structure)
- **Chinese document**: 20KB, Chinese text with proper separators
- **Edge case documents**:
  - Empty document
  - Document with only whitespace
  - Document with very long paragraphs (>2000 chars)

### Test Users
- **Valid user**: User with documents in database
- **Invalid user**: User attempting to access other users' documents
- **Unauthenticated**: No session token

### Mock Services
- **LLM Repository Mock**: Returns consistent 1536-dimensional vectors
- **Vector Repository Mock**: Records operations for verification
- **Database Mock**: In-memory test database with pgvector

## Success Criteria

### Coverage Metrics
- [ ] Unit test coverage ≥ 85%
- [ ] Integration test coverage ≥ 80%
- [ ] All P0 tests passing
- [ ] All acceptance criteria have at least one test
- [ ] No duplicate test coverage across levels

### Quality Metrics
- [ ] All tests are atomic and independent
- [ ] Test names clearly describe what is being tested
- [ ] Test IDs follow naming convention (2.4-{LEVEL}-{SEQ})
- [ ] Test execution time meets targets:
  - Unit tests: < 30 seconds total
  - Integration tests: < 5 minutes total
  - E2E tests: < 3 minutes total

### Documentation
- [ ] Each test has clear justification
- [ ] Test data requirements documented
- [ ] Mock setup instructions provided
- [ ] Known limitations noted

## Notes

### Test Infrastructure Requirements
- **Database**: PostgreSQL with pgvector extension
- **Mock LLM**: Consistent vector generation for testing
- **Test fixtures**: Sample documents of various sizes
- **Cleanup**: Automated test data cleanup after each run

### Special Considerations
- **Concurrency**: Test concurrent processing attempts (AC7)
- **Timeouts**: Test timeout handling with configurable delays
- **Batch boundaries**: Test edge cases at batch size limits (20, 21, 39, 40, 41 chunks)
- **Unicode handling**: Test Chinese text processing thoroughly
- **Performance baselines**: Establish baseline metrics for regression testing

### Future Enhancements
- Add chaos testing for vector database failures
- Add load testing for multiple concurrent document processing
- Add security penetration tests for API endpoints
- Consider property-based testing for chunking algorithm
