# Test Design: Story 2.2

Date: 2025-01-04
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 34
- Unit tests: 12 (35%)
- Integration tests: 16 (47%)
- E2E tests: 6 (18%)
- Priority distribution: P0: 18, P1: 11, P2: 5

## Test Scenarios by Acceptance Criteria

### AC1: Supabase Storage集成配置

**关键测试重点**: 验证Storage基础设施配置正确性

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.2-UNIT-001 | Unit | P0 | Supabase客户端初始化成功 | 验证客户端配置正确 |
| 2.2-UNIT-002 | Unit | P0 | supabaseAdmin实例使用Service Role Key | 验证服务端权限配置 |
| 2.2-UNIT-003 | Unit | P1 | getSupabaseWithAuth正确注入用户token | 验证用户上下文传递 |
| 2.2-INT-001 | Integration | P0 | Storage bucket "documents"存在且可访问 | 验证基础设施就绪 |
| 2.2-INT-002 | Integration | P0 | RLS policies正确限制用户访问 | 安全性基础验证 |

**风险**: 配置错误会导致所有Storage操作失败
**缓解**: 优先运行P0配置测试

---

### AC2: 文件上传到Supabase Storage

**关键测试重点**: 验证文件上传流程和路径规范

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.2-UNIT-004 | Unit | P0 | uploadFile生成正确的storage路径格式 | 路径规范核心逻辑 |
| 2.2-UNIT-005 | Unit | P0 | uploadFile在失败后重试(最多3次) | 可靠性核心逻辑 |
| 2.2-UNIT-006 | Unit | P1 | uploadFile使用正确的contentType | 文件类型正确性 |
| 2.2-INT-003 | Integration | P0 | 实际文件上传到Supabase Storage成功 | 核心功能验证 |
| 2.2-INT-004 | Integration | P0 | 上传使用用户Session Token认证 | 安全性验证 |
| 2.2-INT-005 | Integration | P1 | 上传返回正确的storage path | 返回值正确性 |
| 2.2-INT-006 | Integration | P1 | 大文件(45MB)上传成功 | 边界条件测试 |
| 2.2-E2E-001 | E2E | P0 | 用户通过UI上传文件到Storage | 端到端核心流程 |

**风险**: Storage网络不稳定可能导致上传失败
**缓解**: 重试机制必须经过充分测试

---

### AC3: 存储路径和元数据更新

**关键测试重点**: 验证数据库记录与Storage同步

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.2-INT-007 | Integration | P0 | 上传成功后storagePath正确更新 | 数据一致性核心 |
| 2.2-INT-008 | Integration | P0 | document status保持为PENDING | 状态机正确性 |
| 2.2-INT-009 | Integration | P1 | metadata包含Supabase存储元信息 | 元数据完整性 |
| 2.2-INT-010 | Integration | P1 | uploadedAt时间戳准确记录 | 审计追踪 |

**风险**: Storage成功但数据库更新失败导致不一致
**缓解**: 测试回滚机制

---

### AC4: 用户配额实时更新

**关键测试重点**: 验证使用量统计的原子性和准确性

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.2-UNIT-007 | Unit | P0 | userUsage增量计算正确 | 核心业务逻辑 |
| 2.2-INT-011 | Integration | P0 | documentCount +1原子更新 | 并发安全性 |
| 2.2-INT-012 | Integration | P0 | storageUsed增加实际文件大小 | 配额准确性 |
| 2.2-INT-013 | Integration | P0 | 并发上传时配额更新正确 | 竞态条件测试 |
| 2.2-INT-014 | Integration | P1 | 上传失败时userUsage回滚 | 事务完整性 |

**风险**: 并发上传可能导致配额计算错误
**缓解**: 使用数据库原子操作测试

---

### AC5: 文件下载和访问控制

**关键测试重点**: 验证权限控制和临时URL生成

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.2-UNIT-008 | Unit | P0 | getFile正确下载文件Buffer | 核心读取逻辑 |
| 2.2-UNIT-009 | Unit | P0 | getSignedUrl生成有效期1小时的URL | URL生成逻辑 |
| 2.2-INT-015 | Integration | P0 | GET /api/documents/[id]/download返回signed URL | API功能验证 |
| 2.2-INT-016 | Integration | P0 | 无权限用户无法下载他人文件 | 访问控制核心 |
| 2.2-INT-017 | Integration | P1 | signed URL在有效期内可访问 | URL有效性验证 |
| 2.2-INT-018 | Integration | P2 | signed URL过期后无法访问 | 安全性验证 |
| 2.2-E2E-002 | E2E | P1 | 用户下载自己上传的文档 | 端到端下载流程 |

**风险**: 权限控制不严格可能泄露文件
**缓解**: P0优先级测试权限隔离

---

### AC6: 文件删除和清理

**关键测试重点**: 验证删除操作的完整性和一致性

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.2-UNIT-010 | Unit | P0 | deleteFile成功删除Storage文件 | 核心删除逻辑 |
| 2.2-INT-019 | Integration | P0 | DELETE /api/documents/[id]完整删除流程 | API功能验证 |
| 2.2-INT-020 | Integration | P0 | 删除时Storage文件和数据库记录同步清理 | 一致性验证 |
| 2.2-INT-021 | Integration | P0 | 删除后userUsage正确减少 | 配额更新准确性 |
| 2.2-INT-022 | Integration | P1 | 数据库删除级联删除chunks | 级联关系验证 |
| 2.2-INT-023 | Integration | P1 | 无权限用户无法删除他人文件 | 访问控制 |
| 2.2-E2E-003 | E2E | P1 | 用户删除文档后UI更新 | 端到端删除流程 |

**风险**: 部分删除失败导致资源泄露
**缓解**: 测试事务回滚机制

---

### AC7: 错误处理和重试机制

**关键测试重点**: 验证系统在故障场景下的鲁棒性

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.2-UNIT-011 | Unit | P0 | uploadFile重试失败后抛出明确错误 | 错误处理逻辑 |
| 2.2-UNIT-012 | Unit | P1 | 重试使用指数退避策略(1s, 2s, 4s) | 重试策略验证 |
| 2.2-INT-024 | Integration | P0 | Storage上传失败时清理数据库记录 | 回滚机制核心 |
| 2.2-INT-025 | Integration | P0 | Storage上传失败时回滚userUsage | 配额回滚 |
| 2.2-INT-026 | Integration | P1 | 网络超时时正确重试 | 网络异常处理 |
| 2.2-INT-027 | Integration | P2 | 部分上传文件被清理 | 清理机制验证 |
| 2.2-E2E-004 | E2E | P2 | 上传失败时显示明确错误信息 | 用户体验验证 |

**风险**: 错误处理不当导致数据不一致
**缓解**: 完整测试回滚场景

---

### AC8: 存储配额和文件数量限制

**关键测试重点**: 验证配额限制的执行

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.2-INT-028 | Integration | P0 | 文档数量达到50时拒绝上传 | 配额限制核心 |
| 2.2-INT-029 | Integration | P0 | 存储空间达到500MB时拒绝上传 | 存储限制核心 |
| 2.2-INT-030 | Integration | P1 | 超出配额返回明确的错误信息 | 错误提示清晰 |
| 2.2-INT-031 | Integration | P1 | API返回当前使用量和剩余配额 | 透明度验证 |
| 2.2-E2E-005 | E2E | P1 | UI显示存储使用情况 | 用户可见性 |
| 2.2-E2E-006 | E2E | P2 | 达到配额时UI显示明确提示 | 用户体验验证 |

**风险**: 配额检查不准确导致超额使用
**缓解**: 并发场景下测试配额准确性

---

## 横向关注点测试

### 性能测试

| ID | Level | Priority | Test | Requirement |
|---|---|---|---|---|
| 2.2-INT-032 | Integration | P1 | 10MB文件上传时间 | ≤ 30秒 |
| 2.2-INT-033 | Integration | P2 | signed URL生成时间 | < 500ms |
| 2.2-INT-034 | Integration | P2 | 文件删除操作时间 | < 2秒 |

### 安全测试

已集成在各AC的测试场景中:
- RLS policies验证 (2.2-INT-002)
- 用户Session认证 (2.2-INT-004)
- 跨用户访问控制 (2.2-INT-016, 2.2-INT-023)

---

## 推荐执行顺序

### Phase 1: 基础设施验证 (P0配置测试)
1. 2.2-INT-001: Storage bucket存在
2. 2.2-INT-002: RLS policies配置
3. 2.2-UNIT-001, 002: 客户端初始化

### Phase 2: 核心上传流程 (P0功能测试)
4. 2.2-INT-003: 文件上传成功
5. 2.2-INT-007: storagePath更新
6. 2.2-INT-011, 012: userUsage更新

### Phase 3: 权限和安全 (P0安全测试)
7. 2.2-INT-004: 认证验证
8. 2.2-INT-016: 下载权限控制
9. 2.2-INT-023: 删除权限控制

### Phase 4: 错误处理 (P0鲁棒性测试)
10. 2.2-INT-024, 025: 回滚机制
11. 2.2-UNIT-011: 重试失败处理

### Phase 5: 配额和限制 (P0业务规则)
12. 2.2-INT-028, 029: 配额限制

### Phase 6: 完整流程 (P0/P1 E2E)
13. 2.2-E2E-001: 完整上传流程
14. 2.2-E2E-002, 003: 下载删除流程

### Phase 7: 边界和性能 (P1/P2)
15. 剩余P1测试
16. P2测试(时间允许)

---

## 测试数据需求

### 测试文件准备

```typescript
// tests/fixtures/
const testFiles = {
  small: {
    name: 'small-test.txt',
    size: '1KB',
    type: 'text/plain'
  },
  medium: {
    name: 'medium-test.pdf',
    size: '10MB',
    type: 'application/pdf'
  },
  large: {
    name: 'large-test.docx',
    size: '45MB',
    type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
  },
  boundary: {
    name: 'boundary-test.pdf',
    size: '49.9MB', // 接近50MB限制
    type: 'application/pdf'
  }
}
```

### Mock用户数据

```typescript
const testUsers = {
  normalUser: {
    id: 'user-001',
    documentCount: 5,
    storageUsed: 50 * 1024 * 1024 // 50MB
  },
  nearLimitUser: {
    id: 'user-002',
    documentCount: 49,
    storageUsed: 490 * 1024 * 1024 // 490MB
  },
  atLimitUser: {
    id: 'user-003',
    documentCount: 50,
    storageUsed: 500 * 1024 * 1024 // 500MB
  }
}
```

---

## 风险覆盖矩阵

基于Story 2.2的风险评估:

| 风险ID | 风险 | 缓解测试 | 优先级 |
|---|---|---|---|
| TECH-001 | Storage网络不稳定 | 2.2-UNIT-005, 2.2-INT-026 | P0 |
| SEC-001 | 跨用户文件访问 | 2.2-INT-016, 2.2-INT-023 | P0 |
| DATA-001 | 上传失败导致数据不一致 | 2.2-INT-024, 2.2-INT-025 | P0 |
| PERF-001 | 大文件上传超时 | 2.2-INT-006, 2.2-INT-032 | P1 |
| BUS-001 | 配额计算错误 | 2.2-INT-013, 2.2-INT-028, 2.2-INT-029 | P0 |

---

## 测试环境需求

### Supabase环境

- **开发环境**: 独立Supabase项目用于测试
- **Storage Bucket**: `documents-test` (与生产隔离)
- **测试数据隔离**: 使用test_前缀的用户ID

### 环境变量

```bash
# .env.test
NEXT_PUBLIC_SUPABASE_URL=https://test-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=test-anon-key
SUPABASE_SERVICE_ROLE_KEY=test-service-key
SUPABASE_STORAGE_BUCKET=documents-test
```

### 数据清理策略

- **单元测试**: 使用Mock,无需清理
- **集成测试**: 每个测试后删除创建的Storage文件和数据库记录
- **E2E测试**: 使用专用测试用户,测试套件结束后批量清理

---

## 成功标准

### 覆盖率目标
- ✅ 所有8个AC都有对应测试
- ✅ P0测试100%通过
- ✅ P1测试≥95%通过
- ✅ 代码覆盖率≥80%

### 质量门禁
- ✅ 所有P0测试必须通过才能合并
- ✅ 安全测试(2.2-INT-002, 016, 023)必须通过
- ✅ 回滚机制测试(2.2-INT-024, 025)必须通过
- ✅ 配额限制测试(2.2-INT-028, 029)必须通过

### 性能基准
- ✅ 10MB文件上传时间 ≤ 30秒
- ✅ signed URL生成 < 500ms
- ✅ 文件删除 < 2秒

---

## 已知测试Gap和建议

### 当前覆盖完整的领域
- ✅ 上传流程(含重试)
- ✅ 权限控制
- ✅ 配额管理
- ✅ 回滚机制

### 可选增强测试(超出MVP范围)
- **压力测试**: 1000个并发上传
- **长期运行测试**: 连续上传48小时
- **网络分区测试**: 模拟Supabase完全不可用
- **混沌工程**: 随机故障注入

### 建议
- P0测试是MVP的最低要求,必须100%通过
- P1测试建议在发布前完成
- P2测试可以在生产环境监控中补充
- 性能测试应使用接近生产的数据规模

---

## 附录: 测试实现示例

### 单元测试示例

```typescript
// tests/unit/services/storageService.test.ts

describe('StorageService.uploadFile - 2.2-UNIT-005', () => {
  it('should retry upload on failure (max 3 attempts)', async () => {
    // Mock: 前2次失败,第3次成功
    let attemptCount = 0
    vi.spyOn(supabaseAdmin.storage, 'from').mockImplementation(() => ({
      upload: async () => {
        attemptCount++
        if (attemptCount < 3) {
          throw new Error('Network error')
        }
        return { data: { path: 'user/doc_test.txt' }, error: null }
      }
    }))

    const result = await StorageService.uploadFile(
      'user-001',
      'doc-001',
      new File(['content'], 'test.txt'),
      'test.txt'
    )

    expect(attemptCount).toBe(3)
    expect(result).toBe('user/doc_test.txt')
  })
})
```

### 集成测试示例

```typescript
// tests/integration/api/storage-rollback.test.ts

describe('POST /api/documents/upload - 2.2-INT-024', () => {
  it('should rollback database when Storage upload fails', async () => {
    // Mock Storage失败
    vi.spyOn(StorageService, 'uploadFile').mockRejectedValue(
      new Error('Storage error')
    )

    const formData = new FormData()
    formData.append('file', testFile)

    const response = await POST(createRequest(formData))
    
    // 验证返回错误
    expect(response.status).toBe(500)

    // 验证数据库无记录
    const docs = await db.select()
      .from(documents)
      .where(eq(documents.userId, testUserId))
    expect(docs).toHaveLength(0)

    // 验证userUsage未更新
    const [usage] = await db.select()
      .from(userUsage)
      .where(eq(userUsage.userId, testUserId))
    expect(usage.documentCount).toBe(0)
  })
})
```

---

**测试设计完成日期**: 2025-01-04
**下一步**: 请开发团队实现测试,并在实现过程中更新此文档
