# 测试设计：Story 3.5 - 对话历史管理

**日期**: 2025-01-08  
**设计者**: Quinn (测试架构师)  
**Story**: 3.5 - 对话历史管理

---

## 测试策略概览

- **测试场景总数**: 45
- **单元测试**: 18 (40%)
- **集成测试**: 20 (44%)
- **E2E测试**: 7 (16%)
- **优先级分布**: 
  - P0: 15 (关键路径)
  - P1: 18 (核心功能)
  - P2: 10 (次要功能)
  - P3: 2 (优化功能)

---

## 按验收标准分类的测试场景

### AC1: 对话列表UI组件

#### 场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.5-UNIT-001 | Unit | P1 | ConversationList组件正确渲染对话列表 | 纯UI组件逻辑 |
| 3.5-UNIT-002 | Unit | P1 | 对话项显示所有必需信息（标题、文档、时间、数量） | UI数据呈现 |
| 3.5-UNIT-003 | Unit | P1 | 当前活动对话正确高亮显示 | UI状态管理 |
| 3.5-UNIT-004 | Unit | P2 | 空状态组件正确显示引导文本 | 边界条件处理 |
| 3.5-UNIT-005 | Unit | P2 | 加载状态正确显示加载指示器 | UI反馈 |
| 3.5-INT-001 | Integration | P1 | 对话列表从API加载并正确渲染 | 前后端集成 |
| 3.5-E2E-001 | E2E | P1 | 用户访问对话历史页面看到所有对话 | 关键用户路径 |

---

### AC2: 对话列表API端点

#### 场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.5-UNIT-006 | Unit | P0 | API权限验证：未登录用户返回401 | 安全关键 |
| 3.5-UNIT-007 | Unit | P0 | API权限验证：只返回当前用户的对话 | 数据隔离关键 |
| 3.5-UNIT-008 | Unit | P1 | 分页参数正确解析和应用 | 核心功能逻辑 |
| 3.5-UNIT-009 | Unit | P1 | documentId筛选参数正确应用 | 功能逻辑 |
| 3.5-UNIT-010 | Unit | P1 | search参数正确应用到标题搜索 | 功能逻辑 |
| 3.5-INT-002 | Integration | P0 | GET /api/conversations返回正确格式的对话列表 | API契约关键 |
| 3.5-INT-003 | Integration | P0 | 对话按updatedAt倒序排列 | 核心业务规则 |
| 3.5-INT-004 | Integration | P0 | JOIN documents表正确获取文档名称 | 数据关联关键 |
| 3.5-INT-005 | Integration | P1 | 分页返回正确的pagination元数据 | 分页功能 |
| 3.5-INT-006 | Integration | P0 | 用户A无法访问用户B的对话 | 安全隔离验证 |
| 3.5-INT-007 | Integration | P0 | 查询性能：100条对话 < 1秒 | 性能关键指标 |

---

### AC3: 对话搜索功能

#### 场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.5-UNIT-011 | Unit | P1 | 搜索框输入触发debounce（300ms） | 性能优化逻辑 |
| 3.5-UNIT-012 | Unit | P1 | 清除搜索按钮清空搜索并重置列表 | UI交互逻辑 |
| 3.5-UNIT-013 | Unit | P2 | 搜索无结果时显示提示信息 | 边界条件 |
| 3.5-INT-008 | Integration | P1 | 按标题搜索返回匹配的对话（模糊匹配） | 搜索功能核心 |
| 3.5-INT-009 | Integration | P1 | 搜索响应时间 < 500ms | 性能要求 |
| 3.5-INT-010 | Integration | P0 | SQL注入测试：搜索输入包含特殊字符不导致错误 | 安全关键 |
| 3.5-E2E-002 | E2E | P1 | 用户输入搜索关键词实时过滤对话列表 | 关键用户体验 |

---

### AC4: 对话详情查看

#### 场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.5-UNIT-014 | Unit | P0 | API权限验证：只能查看自己的对话 | 安全关键 |
| 3.5-UNIT-015 | Unit | P1 | 对话不存在时返回404 | 错误处理 |
| 3.5-INT-011 | Integration | P0 | GET /api/conversations/:id返回完整对话信息 | API契约关键 |
| 3.5-INT-012 | Integration | P0 | 消息列表按createdAt升序排列 | 业务规则 |
| 3.5-INT-013 | Integration | P0 | 用户A无法查看用户B的对话详情 | 安全验证 |
| 3.5-INT-014 | Integration | P1 | 对话详情加载时间 < 800ms | 性能要求 |
| 3.5-E2E-003 | E2E | P1 | 用户点击对话查看完整消息历史 | 核心用户路径 |

---

### AC5: 对话删除功能

#### 场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.5-UNIT-016 | Unit | P0 | API权限验证：只能删除自己的对话 | 安全关键 |
| 3.5-UNIT-017 | Unit | P1 | 删除前显示确认对话框 | UX安全措施 |
| 3.5-UNIT-018 | Unit | P2 | 删除成功显示toast提示 | 用户反馈 |
| 3.5-INT-015 | Integration | P0 | DELETE /api/conversations/:id成功删除对话 | 核心功能 |
| 3.5-INT-016 | Integration | P0 | 级联删除：对话删除后关联消息也被删除 | 数据完整性关键 |
| 3.5-INT-017 | Integration | P0 | 用户A无法删除用户B的对话 | 安全验证 |
| 3.5-INT-018 | Integration | P1 | 删除操作响应时间 < 300ms | 性能要求 |
| 3.5-INT-019 | Integration | P1 | 删除后对话列表自动刷新 | 数据同步 |
| 3.5-INT-020 | Integration | P2 | 删除不存在的对话返回404 | 错误处理 |
| 3.5-E2E-004 | E2E | P0 | 用户删除对话后对话从列表消失 | 关键用户路径 |

---

### AC6: 继续对话功能

#### 场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.5-INT-021 | Integration | P1 | 点击历史对话加载完整消息历史 | 核心功能 |
| 3.5-INT-022 | Integration | P1 | 新消息追加到现有对话保持conversationId | 数据关联 |
| 3.5-INT-023 | Integration | P1 | 继续对话更新conversations.updatedAt | 业务逻辑 |
| 3.5-E2E-005 | E2E | P1 | 用户继续历史对话并成功提问 | 核心用户路径 |

---

### AC7: 对话自动标题生成

#### 场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.5-UNIT-019 | Unit | P1 | 使用第一个用户问题作为标题 | 业务逻辑 |
| 3.5-UNIT-020 | Unit | P1 | 标题超过30字符时截断并添加省略号 | 业务规则 |
| 3.5-UNIT-021 | Unit | P2 | 空标题时使用默认标题"新对话" | 边界条件 |
| 3.5-INT-024 | Integration | P1 | 创建对话时标题自动生成 | 端到端功能 |

---

### AC8: 分页和无限滚动

#### 场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.5-UNIT-022 | Unit | P2 | 默认加载前20条对话 | 配置验证 |
| 3.5-UNIT-023 | Unit | P2 | hasMore标志正确计算 | 分页逻辑 |
| 3.5-INT-025 | Integration | P1 | 分页：第1页和第2页返回不同的对话 | 分页功能 |
| 3.5-INT-026 | Integration | P2 | 分页：总数total正确计算 | 数据准确性 |
| 3.5-INT-027 | Integration | P2 | 性能：分页OFFSET在1000+对话时性能 | 大数据量测试 |
| 3.5-E2E-006 | E2E | P2 | 用户滚动到底部加载更多对话 | 用户体验 |

---

### AC9: 对话数据同步

#### 场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.5-UNIT-024 | Unit | P1 | React Query mutation成功后触发列表刷新 | 状态管理逻辑 |
| 3.5-UNIT-025 | Unit | P2 | Optimistic update在mutation前更新UI | UX优化 |
| 3.5-INT-028 | Integration | P1 | 新建对话后列表自动包含新对话 | 数据同步 |
| 3.5-INT-029 | Integration | P2 | 数据同步延迟 < 1秒 | 性能要求 |

---

### AC10: 错误处理和边界情况

#### 场景

| ID | 级别 | 优先级 | 测试场景 | 理由 |
|----|------|--------|----------|------|
| 3.5-UNIT-026 | Unit | P1 | 网络错误显示重试按钮 | 错误处理 |
| 3.5-UNIT-027 | Unit | P0 | 401错误跳转到登录页 | 认证流程 |
| 3.5-UNIT-028 | Unit | P1 | 404错误显示友好提示 | 用户体验 |
| 3.5-UNIT-029 | Unit | P1 | 500错误显示重试选项 | 错误恢复 |
| 3.5-INT-030 | Integration | P1 | API错误正确记录到日志 | 可观测性 |
| 3.5-E2E-007 | E2E | P2 | 网络中断时显示错误并可重试 | 容错能力 |

---

## 风险覆盖映射

基于风险评估报告，测试场景对风险的覆盖：

### 关键风险 (评分9)

**SEC-001: 权限验证不充分**
- 覆盖场景：
  - 3.5-UNIT-006 (未登录返回401)
  - 3.5-UNIT-007 (数据隔离)
  - 3.5-UNIT-014 (查看权限)
  - 3.5-UNIT-016 (删除权限)
  - 3.5-INT-006 (跨用户访问隔离)
  - 3.5-INT-013 (查看权限集成)
  - 3.5-INT-017 (删除权限集成)

**PERF-001: N+1查询**
- 覆盖场景：
  - 3.5-INT-004 (JOIN验证)
  - 3.5-INT-007 (性能基准测试)

### 高风险 (评分6)

**SEC-002: SQL注入**
- 覆盖场景：
  - 3.5-INT-010 (SQL注入防御测试)

**PERF-002: 搜索性能**
- 覆盖场景：
  - 3.5-INT-009 (搜索响应时间)

**DATA-001: 级联删除**
- 覆盖场景：
  - 3.5-INT-016 (级联删除验证)

---

## 推荐执行顺序

### 阶段1: P0测试（发布阻断）

**必须全部通过才能发布**

1. **安全测试**（快速失败策略）
   - 3.5-UNIT-006, 007, 014, 016 (权限验证单元测试)
   - 3.5-INT-002 (API基本功能)
   - 3.5-INT-006, 013, 017 (跨用户安全)
   - 3.5-INT-010 (SQL注入防御)
   - 3.5-UNIT-027 (认证流程)

2. **核心功能测试**
   - 3.5-INT-003 (排序逻辑)
   - 3.5-INT-004 (数据关联)
   - 3.5-INT-007 (列表性能)
   - 3.5-INT-011 (对话详情)
   - 3.5-INT-012 (消息排序)
   - 3.5-INT-015, 016 (删除和级联)

3. **关键E2E测试**
   - 3.5-E2E-001 (查看对话列表)
   - 3.5-E2E-004 (删除对话)

---

### 阶段2: P1测试（核心功能）

**应在发布前完成**

4. **UI组件测试**
   - 3.5-UNIT-001 to 003 (UI渲染)
   - 3.5-INT-001 (前后端集成)

5. **功能完整性测试**
   - 3.5-UNIT-008 to 013 (API参数和搜索)
   - 3.5-INT-005, 008, 009 (分页和搜索)
   - 3.5-INT-014, 018, 019 (性能和同步)
   - 3.5-INT-021 to 024 (继续对话和标题)

6. **用户路径测试**
   - 3.5-E2E-002, 003, 005 (关键用户流程)

---

### 阶段3: P2测试（次要功能）

**时间允许时完成**

7. **边界条件和UX**
   - 3.5-UNIT-004, 005, 013, 017, 018, 021 (边界和反馈)
   - 3.5-INT-020, 025, 026, 027, 029 (边界和性能)
   - 3.5-E2E-006, 007 (UX测试)

---

### 阶段4: P3测试（优化功能）

**可推迟到后续迭代**

8. **性能优化验证**
   - 大规模数据测试
   - 并发用户测试
   - 压力测试

---

## 详细测试规范

### 关键测试详细说明

#### 3.5-INT-006: 跨用户数据隔离测试

**目的**: 验证用户A无法访问用户B的对话

**前置条件**:
- 系统中存在两个测试用户：userA和userB
- userA有3个对话
- userB有2个对话

**测试步骤**:
1. 使用userA身份认证
2. 调用`GET /api/conversations`
3. 验证只返回userA的3个对话
4. 尝试用userA身份访问userB的conversationId
5. 验证返回403或404错误

**预期结果**:
- userA的列表查询只返回userA的对话
- 跨用户访问被拒绝
- 错误日志记录访问尝试

**Given-When-Then**:
- **Given**: 两个用户各有自己的对话记录
- **When**: 用户A尝试列出对话或访问用户B的对话
- **Then**: 只能看到自己的对话，访问他人对话被拒绝

---

#### 3.5-INT-007: 列表查询性能测试

**目的**: 验证100条对话的加载时间 < 1秒

**前置条件**:
- 数据库中为测试用户创建100条对话
- 每个对话包含5-20条消息
- 数据库索引已正确配置

**测试步骤**:
1. 清空所有缓存
2. 记录开始时间
3. 调用`GET /api/conversations?limit=20&page=1`
4. 记录结束时间
5. 计算响应时间
6. 检查SQL查询日志，验证使用JOIN而非N+1

**预期结果**:
- 响应时间 < 1000ms
- SQL查询数量 = 2（1次对话查询 + 1次计数查询）
- 不是N次查询

**Given-When-Then**:
- **Given**: 数据库中有100条对话记录
- **When**: 用户请求第一页对话列表（20条）
- **Then**: 响应时间小于1秒，且只执行2次SQL查询

---

#### 3.5-INT-010: SQL注入防御测试

**目的**: 验证搜索功能不受SQL注入攻击

**前置条件**:
- 系统正常运行
- 用户已登录

**测试步骤**:
1. 尝试各种SQL注入payload：
   - `'; DROP TABLE conversations; --`
   - `' OR '1'='1`
   - `%27 UNION SELECT * FROM users--`
   - `'; DELETE FROM messages WHERE '1'='1`
2. 调用`GET /api/conversations?search={payload}`
3. 验证响应正常（不是500错误）
4. 验证数据库表完整
5. 验证不返回未授权数据

**预期结果**:
- 所有SQL注入尝试都失败
- API返回空结果或正常数据
- 数据库表未被修改
- 错误日志记录可疑输入

**Given-When-Then**:
- **Given**: 用户在搜索框输入恶意SQL语句
- **When**: 搜索请求发送到服务器
- **Then**: 请求被安全处理，不执行恶意SQL，数据库完好无损

---

#### 3.5-INT-016: 级联删除验证测试

**目的**: 验证删除对话时关联消息也被删除

**前置条件**:
- 创建一个包含10条消息的测试对话
- 记录conversationId和所有messageId

**测试步骤**:
1. 查询messages表，验证10条消息存在
2. 调用`DELETE /api/conversations/:conversationId`
3. 验证API返回成功（200或204）
4. 查询conversations表，验证对话已删除
5. 查询messages表，验证所有10条消息也被删除
6. 查询是否存在孤立消息（WHERE conversation_id NOT IN ...）

**预期结果**:
- 对话成功删除
- 所有关联消息自动删除
- 不存在孤立消息记录

**Given-When-Then**:
- **Given**: 一个对话包含多条消息记录
- **When**: 用户删除该对话
- **Then**: 对话和所有关联消息都从数据库中删除

---

#### 3.5-E2E-001: 查看对话列表完整流程

**目的**: 验证用户可以查看自己的所有历史对话

**前置条件**:
- 用户已登录
- 用户有至少3个历史对话

**测试步骤**:
1. 导航到对话历史页面
2. 等待对话列表加载完成
3. 验证至少显示3个对话
4. 验证每个对话显示：
   - 对话标题
   - 文档名称
   - 时间戳（相对时间）
   - 消息数量
5. 验证对话按时间倒序排列
6. 验证当前对话（如果有）被高亮

**预期结果**:
- 对话列表正确显示
- 所有必需信息都可见
- 排序正确
- 加载时间 < 1秒

**Given-When-Then**:
- **Given**: 已登录用户有多个历史对话
- **When**: 用户访问对话历史页面
- **Then**: 看到所有对话按时间倒序排列，显示完整信息

---

#### 3.5-E2E-004: 删除对话完整流程

**目的**: 验证用户可以删除对话

**前置条件**:
- 用户已登录
- 用户有至少1个可删除的对话

**测试步骤**:
1. 导航到对话历史页面
2. 悬停在某个对话上
3. 点击删除按钮
4. 验证确认对话框出现
5. 点击确认删除
6. 验证toast提示显示"对话已删除"
7. 验证对话从列表中消失
8. 刷新页面，验证对话确实已删除

**预期结果**:
- 删除流程流畅
- 确认对话框防止误删
- 对话成功删除
- UI实时更新

**Given-When-Then**:
- **Given**: 用户在对话列表页面
- **When**: 用户选择并确认删除某个对话
- **Then**: 对话从列表中消失，后端数据也被删除

---

## 测试数据要求

### 基础测试数据

**用户**:
- testUserA: 基本测试用户，3个对话
- testUserB: 隔离测试用户，2个对话
- testUserEmpty: 无对话的用户

**对话**:
- 短标题对话（< 30字符）
- 长标题对话（> 30字符，测试截断）
- 包含特殊字符的标题（测试转义）
- 不同时间戳的对话（测试排序）

**消息**:
- 单消息对话（1条消息）
- 普通对话（5-10条消息）
- 长对话（50+条消息）

### 性能测试数据

**大规模数据**:
- 100条对话（测试基本性能）
- 500条对话（测试分页性能）
- 1000条对话（测试OFFSET性能下降）

**搜索测试数据**:
- 包含常见关键词的对话
- 包含中文、英文、数字的标题
- 包含特殊字符的标题

---

## 测试工具和框架

### 单元测试
- **框架**: Jest
- **工具**: React Testing Library (UI), Mock Service Worker (API模拟)
- **覆盖率目标**: > 80%

### 集成测试
- **框架**: Jest + Supertest
- **数据库**: 独立测试数据库
- **清理策略**: 每个测试后清理数据

### E2E测试
- **框架**: Playwright或Cypress
- **环境**: 独立测试环境
- **数据**: 固定的seed数据

### 性能测试
- **工具**: k6或Artillery
- **指标**: 响应时间、吞吐量、并发用户
- **基准**: AC中定义的性能目标

### 安全测试
- **工具**: OWASP ZAP、SQLMap
- **范围**: SQL注入、XSS、权限绕过
- **频率**: 每次发布前

---

## 覆盖率分析

### AC覆盖率

| AC | 测试场景数 | P0 | P1 | P2 | 覆盖率 |
|----|-----------|----|----|----|----|
| AC1 | 7 | 0 | 4 | 3 | 完全 |
| AC2 | 11 | 6 | 5 | 0 | 完全 |
| AC3 | 7 | 1 | 4 | 2 | 完全 |
| AC4 | 7 | 4 | 3 | 0 | 完全 |
| AC5 | 10 | 4 | 4 | 2 | 完全 |
| AC6 | 4 | 0 | 4 | 0 | 完全 |
| AC7 | 4 | 0 | 3 | 1 | 完全 |
| AC8 | 6 | 0 | 1 | 5 | 完全 |
| AC9 | 4 | 0 | 2 | 2 | 完全 |
| AC10 | 6 | 1 | 4 | 1 | 完全 |

### 风险覆盖率

| 风险 | 覆盖场景 | 覆盖程度 |
|------|---------|---------|
| SEC-001 (权限) | 7个测试 | 充分 |
| PERF-001 (N+1) | 2个测试 | 充分 |
| SEC-002 (SQL注入) | 1个测试 | 充分 |
| PERF-002 (搜索) | 2个测试 | 充分 |
| DATA-001 (级联删除) | 1个测试 | 充分 |

---

## 质量指标

### 必须达到的指标（P0）

- ✅ 所有P0测试通过率 = 100%
- ✅ 安全测试无关键漏洞
- ✅ 性能测试达到所有AC目标：
  - 列表加载 < 1秒
  - 搜索响应 < 500ms
  - 详情加载 < 800ms
  - 删除操作 < 300ms
- ✅ 代码覆盖率 > 80%

### 推荐达到的指标（P1）

- ✅ P0 + P1测试通过率 = 100%
- ✅ E2E测试通过率 = 100%
- ✅ 无已知的高风险缺陷

### 理想指标（P2+）

- ✅ 所有测试通过率 = 100%
- ✅ 代码覆盖率 > 90%
- ✅ 无已知缺陷

---

## 关键原则

1. **安全优先**: 所有权限验证测试必须在P0
2. **性能关键**: 所有性能目标必须有对应的测试验证
3. **快速反馈**: P0测试应在5分钟内完成
4. **隔离测试**: 每个测试独立，不依赖其他测试
5. **可重复性**: 所有测试都可以在本地和CI中重复运行

---

**测试设计版本**: 1.0  
**下次更新**: 实施完成后根据实际情况调整
