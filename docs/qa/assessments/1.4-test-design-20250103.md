# 测试设计：Story 1.4 - 用户登录功能

**日期**: 2025-01-03  
**设计者**: Quinn (测试架构师)

## 测试策略概览

- **总测试场景**: 24
- **单元测试**: 10 (42%)
- **集成测试**: 9 (37%)
- **E2E 测试**: 5 (21%)
- **优先级分布**: P0: 11, P1: 8, P2: 5

## 按验收标准的测试场景

### AC1: 登录页面 UI

#### 场景

| ID           | 级别 | 优先级 | 测试                           | 理由                     |
| ------------ | ---- | ------ | ------------------------------ | ------------------------ |
| 1.4-E2E-001  | E2E  | P1     | 登录页面正确渲染               | 关键用户入口点验证       |
| 1.4-UNIT-001 | Unit | P2     | LoginForm 组件挂载             | 组件生命周期验证         |
| 1.4-UNIT-002 | Unit | P2     | 所有表单字段存在               | UI 完整性验证            |

**状态**: 📝 **待实施** - UI 组件未创建  
**覆盖范围**: 0%

---

### AC2: 前端表单验证

#### 场景

| ID           | 级别 | 优先级 | 测试                      | 理由                 |
| ------------ | ---- | ------ | ------------------------- | -------------------- |
| 1.4-UNIT-003 | Unit | P0     | 邮箱格式验证（Zod）       | 核心验证逻辑         |
| 1.4-UNIT-004 | Unit | P0     | 密码非空验证              | 必填字段验证         |
| 1.4-UNIT-005 | Unit | P1     | 实时错误提示显示          | 用户体验关键点       |
| 1.4-INT-001  | Int  | P1     | 表单提交禁用状态管理      | 防止重复提交         |

**状态**: 📝 **待实施**  
**覆盖范围**: 0%

---

### AC3: NextAuth.js 集成与配置

#### 场景

| ID           | 级别 | 优先级 | 测试                               | 理由                     |
| ------------ | ---- | ------ | ---------------------------------- | ------------------------ |
| 1.4-UNIT-006 | Unit | P0     | NextAuth 配置对象验证              | 配置正确性检查           |
| 1.4-UNIT-007 | Unit | P0     | Credentials Provider 配置          | 认证提供者配置验证       |
| 1.4-INT-002  | Int  | P0     | JWT 回调函数逻辑                   | Token 生成逻辑           |
| 1.4-INT-003  | Int  | P0     | Session 回调函数逻辑               | Session 数据映射         |
| 1.4-INT-004  | Int  | P0     | Cookie 安全属性设置                | 安全配置验证             |

**状态**: 📝 **待实施** - NextAuth 配置未创建  
**覆盖范围**: 0%

**关键测试**:
- ✅ HTTP-Only Cookie 验证
- ✅ Secure 标志验证（生产环境）
- ✅ SameSite='lax' 验证
- ✅ Session 过期时间验证

---

### AC4: 登录 API 实现

#### 场景

| ID           | 级别 | 优先级 | 测试                               | 理由                     |
| ------------ | ---- | ------ | ---------------------------------- | ------------------------ |
| 1.4-UNIT-008 | Unit | P0     | 成功登录用户                       | 主要功能路径             |
| 1.4-UNIT-009 | Unit | P0     | 拒绝不存在邮箱                     | 错误处理                 |
| 1.4-UNIT-010 | Unit | P0     | 拒绝错误密码                       | 安全验证                 |
| 1.4-INT-005  | Int  | P0     | bcrypt 密码验证                    | 密码安全                 |
| 1.4-INT-006  | Int  | P0     | 速率限制实施                       | 防暴力破解               |
| 1.4-INT-007  | Int  | P1     | 统一错误消息                       | 安全最佳实践             |

**状态**: 📝 **待实施**  
**覆盖范围**: 0%

**安全测试重点**:
- ✅ 速率限制（10 次/小时/IP）
- ✅ 错误消息不透露账户存在性
- ✅ bcrypt 验证正确性

---

### AC5: 登录成功流程

#### 场景

| ID           | 级别 | 优先级 | 测试                     | 理由                     |
| ------------ | ---- | ------ | ------------------------ | ------------------------ |
| 1.4-INT-008  | Int  | P0     | Session 创建成功         | 核心功能                 |
| 1.4-INT-009  | Int  | P0     | 用户信息存储到 Session   | 数据完整性               |
| 1.4-E2E-002  | E2E  | P0     | 完整登录到 Dashboard 流程| 关键用户旅程             |
| 1.4-INT-010  | Int  | P1     | 页面刷新保持登录状态     | Session 持久化           |
| 1.4-E2E-003  | E2E  | P2     | 显示欢迎回来提示         | 用户反馈                 |

**状态**: 📝 **待实施**  
**覆盖范围**: 0%

---

### AC6: 错误处理

#### 场景

| ID           | 级别 | 优先级 | 测试                       | 理由                     |
| ------------ | ---- | ------ | -------------------------- | ------------------------ |
| 1.4-UNIT-011 | Unit | P0     | 邮箱不存在错误响应         | 核心错误场景             |
| 1.4-UNIT-012 | Unit | P0     | 密码错误响应               | 核心错误场景             |
| 1.4-INT-011  | Int  | P1     | 网络错误处理               | 可靠性                   |
| 1.4-INT-012  | Int  | P1     | API 错误标准格式           | 一致性                   |
| 1.4-E2E-004  | E2E  | P2     | 友好错误消息 UI 显示       | 用户体验                 |

**状态**: 📝 **待实施**  
**覆盖范围**: 0%

---

### AC7: 登出功能

#### 场景

| ID           | 级别 | 优先级 | 测试                   | 理由                     |
| ------------ | ---- | ------ | ---------------------- | ------------------------ |
| 1.4-INT-013  | Int  | P0     | 登出清除 Session       | 安全关键功能             |
| 1.4-INT-014  | Int  | P0     | 登出清除 Cookie        | 安全关键功能             |
| 1.4-E2E-005  | E2E  | P1     | 完整登出流程           | 用户旅程验证             |

**状态**: 📝 **待实施**  
**覆盖范围**: 0%

---

## 风险覆盖

基于风险评估文档，测试场景映射：

| 风险 ID   | 相关测试场景                              | 覆盖状态 |
| --------- | ----------------------------------------- | -------- |
| TECH-001  | 1.4-UNIT-006, 1.4-UNIT-007, 1.4-INT-002/003/004 | 📝 待实施 |
| SEC-001   | 1.4-INT-004 (Cookie 安全属性)             | 📝 待实施 |
| SEC-002   | 1.4-INT-006 (速率限制)                    | 📝 待实施 |
| SEC-003   | 1.4-INT-008 (Session 管理)                | 📝 待实施 |
| SEC-004   | 1.4-INT-007 (统一错误消息)                | 📝 待实施 |
| TECH-002  | _需要新测试：记住我功能_                  | ❌ 缺失  |
| SEC-005   | 1.4-INT-004 (CSRF 保护)                   | 📝 待实施 |
| DATA-001  | 1.4-INT-009 (Session 数据)                | 📝 待实施 |

---

## 建议的执行顺序

1. **P0 NextAuth 配置验证**（关键风险 TECH-001）
   - 1.4-UNIT-006, 1.4-UNIT-007
   - 1.4-INT-002, 1.4-INT-003, 1.4-INT-004

2. **P0 登录 API 核心功能**
   - 1.4-UNIT-008, 1.4-UNIT-009, 1.4-UNIT-010
   - 1.4-INT-005, 1.4-INT-006

3. **P0 Session 管理**
   - 1.4-INT-008, 1.4-INT-009
   - 1.4-E2E-002（关键用户旅程）

4. **P0 登出功能**
   - 1.4-INT-013, 1.4-INT-014

5. **P1 测试**（按顺序）
   - 前端验证和错误处理
   - Session 持久化

6. **P2+ 测试**（时间允许时）

---

## 测试覆盖率差距

### 关键差距

1. **NextAuth.js 配置测试** ⚠️
   - **影响**: TECH-001 风险未缓解
   - **优先级**: P0 - **生产阻塞**
   - **行动**: 创建 NextAuth 配置单元测试和集成测试

2. **Cookie 安全属性验证** ⚠️
   - **影响**: SEC-001 风险未缓解
   - **优先级**: P0 - 安全关键
   - **行动**: 验证 HTTP-Only, Secure, SameSite 设置

3. **速率限制测试** ⚠️
   - **影响**: SEC-002 风险未缓解
   - **优先级**: P0 - 安全关键
   - **行动**: 测试速率限制有效性

4. **Session 持久化测试** ⚠️
   - **影响**: AC5 核心功能
   - **优先级**: P0 - 功能关键
   - **行动**: 测试页面刷新后 Session 保持

5. **"记住我"功能测试** ❌
   - **影响**: TECH-002 风险，AC3 功能
   - **优先级**: P1
   - **行动**: 添加记住我功能的专项测试

### 次要差距

6. **时序攻击测试** ⚠️
   - **影响**: SEC-004 风险
   - **优先级**: P2
   - **行动**: 响应时间一致性测试

7. **CSRF 保护验证** ⚠️
   - **影响**: SEC-005 风险
   - **优先级**: P2
   - **行动**: 验证 NextAuth CSRF 保护

---

## 详细测试场景

### 单元测试

#### 1.4-UNIT-006: NextAuth 配置对象验证

```typescript
describe('NextAuth Configuration', () => {
  it('should have correct provider configuration', () => {
    expect(authOptions.providers).toHaveLength(1)
    expect(authOptions.providers[0].name).toBe('Credentials')
  })
  
  it('should use JWT strategy', () => {
    expect(authOptions.session.strategy).toBe('jwt')
  })
  
  it('should have correct session maxAge', () => {
    expect(authOptions.session.maxAge).toBe(7 * 24 * 60 * 60) // 7天
  })
  
  it('should have custom sign-in page', () => {
    expect(authOptions.pages.signIn).toBe('/login')
  })
})
```

#### 1.4-UNIT-008: 成功登录用户

```typescript
describe('Login API - Authorize Callback', () => {
  it('should authenticate valid user', async () => {
    // Mock 数据库查询
    const mockUser = {
      id: 'user_123',
      email: 'test@example.com',
      passwordHash: await bcrypt.hash('password123', 10),
      name: 'Test User',
    }
    
    db.select = jest.fn().mockResolvedValue([mockUser])
    
    const result = await authorize({
      email: 'test@example.com',
      password: 'password123',
    })
    
    expect(result).toEqual({
      id: 'user_123',
      email: 'test@example.com',
      name: 'Test User',
    })
  })
})
```

#### 1.4-UNIT-009: 拒绝不存在邮箱

```typescript
describe('Login API - Invalid Email', () => {
  it('should reject non-existent email', async () => {
    db.select = jest.fn().mockResolvedValue([]) // 空数组
    
    await expect(
      authorize({
        email: 'nonexistent@example.com',
        password: 'password123',
      })
    ).rejects.toThrow('邮箱或密码错误')
  })
  
  it('should not reveal if email exists', async () => {
    // 确保错误消息统一
    const error1 = await getLoginError('nonexistent@example.com', 'pass')
    const error2 = await getLoginError('existing@example.com', 'wrongpass')
    
    expect(error1).toBe(error2) // 相同的错误消息
  })
})
```

### 集成测试

#### 1.4-INT-004: Cookie 安全属性设置

```typescript
describe('Cookie Security Attributes', () => {
  it('should set HTTP-Only cookie', async () => {
    const response = await loginUser('test@example.com', 'password123')
    const cookies = response.headers['set-cookie']
    
    expect(cookies).toContain('HttpOnly')
  })
  
  it('should set Secure flag in production', async () => {
    process.env.NODE_ENV = 'production'
    
    const response = await loginUser('test@example.com', 'password123')
    const cookies = response.headers['set-cookie']
    
    expect(cookies).toContain('Secure')
  })
  
  it('should set SameSite=lax', async () => {
    const response = await loginUser('test@example.com', 'password123')
    const cookies = response.headers['set-cookie']
    
    expect(cookies).toContain('SameSite=lax')
  })
})
```

#### 1.4-INT-006: 速率限制实施

```typescript
describe('Rate Limiting', () => {
  it('should allow 10 login attempts per hour', async () => {
    const ip = '192.168.1.100'
    
    // 尝试 10 次登录
    for (let i = 0; i < 10; i++) {
      const response = await loginFromIP(ip, 'test@example.com', 'wrongpass')
      expect(response.status).not.toBe(429)
    }
  })
  
  it('should block 11th login attempt', async () => {
    const ip = '192.168.1.100'
    
    // 尝试 11 次登录
    for (let i = 0; i < 10; i++) {
      await loginFromIP(ip, 'test@example.com', 'wrongpass')
    }
    
    const response = await loginFromIP(ip, 'test@example.com', 'wrongpass')
    expect(response.status).toBe(429)
    expect(response.headers).toHaveProperty('Retry-After')
  })
  
  it('should reset rate limit after 1 hour', async () => {
    const ip = '192.168.1.100'
    
    // 触发速率限制
    for (let i = 0; i < 11; i++) {
      await loginFromIP(ip, 'test@example.com', 'wrongpass')
    }
    
    // 模拟 1 小时后
    jest.advanceTimersByTime(60 * 60 * 1000)
    
    // 应该可以再次登录
    const response = await loginFromIP(ip, 'test@example.com', 'password123')
    expect(response.status).toBe(200)
  })
})
```

#### 1.4-INT-010: 页面刷新保持登录状态

```typescript
describe('Session Persistence', () => {
  it('should maintain session across page refresh', async () => {
    // 登录
    const session1 = await loginAndGetSession('test@example.com', 'password123')
    expect(session1.user.email).toBe('test@example.com')
    
    // 模拟页面刷新（获取新 session）
    const session2 = await getSession()
    expect(session2.user.email).toBe('test@example.com')
    expect(session2.user.id).toBe(session1.user.id)
  })
  
  it('should expire session after maxAge', async () => {
    await loginUser('test@example.com', 'password123')
    
    // 模拟 7 天后
    jest.advanceTimersByTime(7 * 24 * 60 * 60 * 1000 + 1)
    
    const session = await getSession()
    expect(session).toBeNull()
  })
})
```

### E2E 测试

#### 1.4-E2E-002: 完整登录到 Dashboard 流程

```typescript
describe('Complete Login Flow', () => {
  it('should login user and redirect to dashboard', async () => {
    await page.goto('http://localhost:3000/login')
    
    // 填写表单
    await page.fill('#email', 'test@example.com')
    await page.fill('#password', 'password123')
    
    // 提交
    await page.click('button[type="submit"]')
    
    // 验证重定向
    await page.waitForNavigation()
    expect(page.url()).toContain('/dashboard')
    
    // 验证用户信息显示
    const userName = await page.textContent('[data-testid="user-name"]')
    expect(userName).toContain('Test User')
  })
  
  it('should show error for invalid credentials', async () => {
    await page.goto('http://localhost:3000/login')
    
    // 填写错误凭证
    await page.fill('#email', 'test@example.com')
    await page.fill('#password', 'wrongpassword')
    
    // 提交
    await page.click('button[type="submit"]')
    
    // 验证错误提示
    const error = await page.textContent('.text-red-500')
    expect(error).toContain('邮箱或密码错误')
    
    // 确认未跳转
    expect(page.url()).toContain('/login')
  })
  
  it('should maintain session across page refresh', async () => {
    // 登录
    await loginViaUI('test@example.com', 'password123')
    expect(page.url()).toContain('/dashboard')
    
    // 刷新页面
    await page.reload()
    
    // 应该仍在 dashboard
    expect(page.url()).toContain('/dashboard')
    const userName = await page.textContent('[data-testid="user-name"]')
    expect(userName).toContain('Test User')
  })
})
```

#### 1.4-E2E-005: 完整登出流程

```typescript
describe('Logout Flow', () => {
  it('should logout user and clear session', async () => {
    // 登录
    await loginViaUI('test@example.com', 'password123')
    expect(page.url()).toContain('/dashboard')
    
    // 登出
    await page.click('[data-testid="logout-button"]')
    
    // 验证跳转到登录页
    await page.waitForNavigation()
    expect(page.url()).toContain('/login')
    
    // 尝试访问 dashboard（应该重定向到登录）
    await page.goto('http://localhost:3000/dashboard')
    await page.waitForNavigation()
    expect(page.url()).toContain('/login')
  })
})
```

---

## 特殊测试场景

### "记住我"功能测试

```typescript
describe('Remember Me Functionality', () => {
  it('should extend session to 30 days when checked', async () => {
    const response = await loginUser('test@example.com', 'password123', {
      remember: true
    })
    
    // 检查 Cookie maxAge
    const cookies = parseCookies(response.headers['set-cookie'])
    const sessionCookie = cookies.find(c => c.name === 'next-auth.session-token')
    
    expect(sessionCookie.maxAge).toBe(30 * 24 * 60 * 60) // 30天
  })
  
  it('should use default 7 days when unchecked', async () => {
    const response = await loginUser('test@example.com', 'password123', {
      remember: false
    })
    
    const cookies = parseCookies(response.headers['set-cookie'])
    const sessionCookie = cookies.find(c => c.name === 'next-auth.session-token')
    
    expect(sessionCookie.maxAge).toBe(7 * 24 * 60 * 60) // 7天
  })
})
```

### 时序攻击防护测试

```typescript
describe('Timing Attack Protection', () => {
  it('should have consistent response time for invalid credentials', async () => {
    const times = []
    
    // 测试 10 次登录（不同错误）
    for (let i = 0; i < 5; i++) {
      const start = Date.now()
      await loginUser('nonexistent@example.com', 'password123')
      times.push(Date.now() - start)
    }
    
    for (let i = 0; i < 5; i++) {
      const start = Date.now()
      await loginUser('existing@example.com', 'wrongpassword')
      times.push(Date.now() - start)
    }
    
    // 计算标准差（应该很小）
    const avg = times.reduce((a, b) => a + b) / times.length
    const variance = times.reduce((sum, t) => sum + Math.pow(t - avg, 2), 0) / times.length
    const stdDev = Math.sqrt(variance)
    
    // 标准差应小于 10ms
    expect(stdDev).toBeLessThan(10)
  })
})
```

---

## 质量检查清单

完成前验证：

- [❌] 每个 AC 至少有一个测试 - **待实施**
- [❌] 测试级别适当（没有过度测试） - **待验证**
- [❌] 各级别无重复覆盖 - **待验证**
- [✅] 优先级与业务风险一致
- [✅] 测试 ID 遵循命名约定
- [❌] 场景是原子和独立的 - **待验证**

---

## 关键原则

- **左移**: 优先单元测试而非集成测试，集成测试优先于 E2E
- **基于风险**: 专注于可能出错的地方（NextAuth 配置、Cookie 安全、速率限制）
- **高效覆盖**: 在正确级别测试一次
- **可维护性**: 考虑长期测试维护
- **快速反馈**: 快速测试优先运行
- **安全优先**: 认证功能的安全测试是重中之重

---

## 下一步行动

### 立即行动（P0）

1. **创建 NextAuth 配置测试** - 验证 TECH-001 风险缓解
2. **创建 Cookie 安全属性测试** - 验证 SEC-001 风险缓解
3. **创建速率限制测试** - 验证 SEC-002 风险缓解
4. **创建 Session 管理测试** - 核心功能验证

### 短期行动（P1）

5. **添加 Session 持久化测试** - AC5 关键功能
6. **添加"记住我"功能测试** - TECH-002 风险
7. **创建完整 E2E 测试** - 关键用户旅程覆盖

### 长期行动（P2+）

8. **时序攻击测试**
9. **CSRF 保护验证**
10. **性能基准测试**

---

## 测试环境要求

### 单元测试环境
- Jest 配置
- NextAuth mocking
- bcrypt mocking
- 数据库 mocking

### 集成测试环境
- 测试数据库实例
- NextAuth 完整配置
- 真实 bcrypt 验证
- Cookie 解析工具

### E2E 测试环境
- Playwright 或 Cypress
- 测试用户账户
- 完整应用运行
- 浏览器自动化

---

**Quinn (测试架构师) - 测试设计完成**


