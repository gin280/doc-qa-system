# Test Design: Story 5.1 - Ragas 评估环境搭建

Date: 2025-01-22  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 26
- **Unit tests**: 15 (58%)
- **Integration tests**: 11 (42%)
- **E2E tests**: 0 (0%)
- **Priority distribution**: P0: 12, P1: 10, P2: 4

### Strategy Rationale

这是一个基础设施搭建 Story，重点关注：
1. **服务可靠性**: Docker 环境和健康检查是 P0
2. **API 集成**: Service 与 Ragas API 的通信必须健壮
3. **错误处理**: 网络问题、API 故障必须优雅处理
4. **配置灵活性**: 支持智谱AI和OpenAI两种配置

不需要 E2E 测试：这是后端基础设施，无用户界面交互。

---

## Test Scenarios by Acceptance Criteria

### AC1: Docker 环境搭建

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 5.1-INT-001 | Integration | P0 | Docker 容器成功启动并进入运行状态 | 核心基础设施，容器无法启动则整个功能不可用 |
| 5.1-INT-002 | Integration | P0 | 健康检查端点 `/health` 返回 200 OK | 服务可用性的关键指标，必须通过 |
| 5.1-INT-003 | Integration | P0 | 智谱AI配置下容器正常响应评估请求 | 推荐配置路径，国内环境主要使用方式 |
| 5.1-INT-004 | Integration | P1 | OpenAI配置下容器正常响应评估请求 | 备选配置，需要验证但非主要路径 |
| 5.1-INT-005 | Integration | P1 | Docker 网络配置允许 Next.js 容器访问 Ragas | 跨容器通信是集成成功的关键 |
| 5.1-INT-006 | Integration | P2 | 容器重启后环境变量和配置保持 | 验证配置持久化和容器可靠性 |

**测试说明 (AC1)**:
- 使用 `docker-compose -f docker-compose.ragas.yml up -d` 启动
- 验证 `docker ps` 显示容器状态为 `running`
- 健康检查使用 `curl http://localhost:8000/health`
- 网络测试需要 Next.js 容器运行在同一网络

---

### AC2 & AC3: RagasEvaluator Service 实现与评估指标完整性

#### Scenarios - Unit Tests

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 5.1-UNIT-001 | Unit | P0 | `evaluateQA()` 返回完整的 4 个核心指标 | 核心功能验证，必须返回所有 AC3 要求的指标 |
| 5.1-UNIT-002 | Unit | P0 | `evaluateQA()` 正确计算 `ragas_score` 综合分数 | 综合分数是评估的最终依据 |
| 5.1-UNIT-003 | Unit | P0 | Ragas API 不可用时抛出清晰错误信息 | 错误处理是 Story 明确要求，必须测试 |
| 5.1-UNIT-004 | Unit | P0 | API 调用超时（30秒）后正确处理 | 防止长时间阻塞，保护系统可用性 |
| 5.1-UNIT-005 | Unit | P1 | `evaluateDataset()` 成功评估多个测试用例 | 批量评估是主要使用场景 |
| 5.1-UNIT-006 | Unit | P1 | 批量评估返回正确格式的 `EvaluationReport` | 报告格式必须符合类型定义 |
| 5.1-UNIT-007 | Unit | P1 | 批量评估时部分失败不影响整体执行 | 部分失败应记录但不应导致全部失败 |
| 5.1-UNIT-008 | Unit | P1 | 无效输入参数被 Zod 验证拒绝 | 输入验证防止错误数据传播到 API |
| 5.1-UNIT-009 | Unit | P2 | 重试逻辑在网络临时故障时生效 | 提高系统健壮性和成功率 |
| 5.1-UNIT-010 | Unit | P2 | 日志记录包含评估关键信息 | 可观测性需求，方便问题排查 |

#### Scenarios - Integration Tests

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 5.1-INT-007 | Integration | P0 | `evaluateQA()` 成功调用真实 Ragas API | 端到端集成验证，确保 API 契约正确 |
| 5.1-INT-008 | Integration | P1 | 批量评估并发控制避免 API 过载 | 防止并发请求导致 API 限流或拒绝 |

**测试数据示例**:

```typescript
// Mock 成功响应
const mockMetrics: RagasMetrics = {
  context_precision: 0.85,
  context_recall: 0.78,
  faithfulness: 0.92,
  answer_relevancy: 0.88,
  ragas_score: 0.86
}

// 测试用例样本
const validTestCase: TestCase = {
  question: "What is RAG?",
  answer: "RAG is Retrieval-Augmented Generation that combines retrieval with generation...",
  contexts: ["RAG combines retrieval with generation to improve answer quality..."],
  groundTruth: "RAG stands for Retrieval-Augmented Generation"
}

// 无效输入测试
const invalidInputs = [
  { question: "", answer: "...", contexts: [] }, // 空 question
  { question: "Test", answer: "", contexts: [] }, // 空 answer
  { question: "Test", answer: "Test", contexts: [] } // 空 contexts
]
```

---

### AC4: 环境配置

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 5.1-UNIT-011 | Unit | P0 | `RAGAS_API_URL` 环境变量正确读取 | 核心配置，无此配置服务无法工作 |
| 5.1-UNIT-012 | Unit | P1 | 缺少环境变量时使用默认值 `http://localhost:8000` | 开发体验优化，降低配置复杂度 |
| 5.1-UNIT-013 | Unit | P2 | `ragas.config.ts` 导出正确格式的配置对象 | 配置标准化和类型安全 |
| 5.1-INT-009 | Integration | P1 | `.env.example` 包含所有必需的环境变量 | 新开发者入门体验，文档与代码一致 |

**配置验证要点**:
- 必须支持智谱AI配置（推荐）
- 必须支持OpenAI配置（备选）
- 配置切换不需要改代码
- `.env.example` 包含清晰的注释说明

---

### AC5: 单元测试覆盖率

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 5.1-UNIT-014 | Unit | P0 | Jest 测试覆盖率报告显示 ≥ 80% | Story 明确要求的覆盖率目标 |
| 5.1-UNIT-015 | Unit | P0 | 所有 public 方法都有对应测试 | 确保 API 契约稳定性 |

**覆盖率验证**:
```bash
npm test -- --coverage
# 检查 coverage/lcov-report/index.html
# src/services/evaluation/ragasEvaluator.ts 覆盖率必须 ≥ 80%
```

---

### AC6: 文档

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 5.1-INT-010 | Integration | P1 | `docs/deployment/ragas-setup.md` 中的 Docker 命令可执行 | 文档准确性验证，避免误导开发者 |
| 5.1-INT-011 | Integration | P2 | 故障排查指南包含常见问题解决方案 | 运维友好性，减少支持成本 |

**文档验证要点**:
- 所有命令可以直接复制粘贴执行
- 包含智谱AI和OpenAI两种配置示例
- 包含网络问题排查步骤
- 包含使用示例代码

---

## Risk Coverage

### 风险映射

| Risk ID | Risk Description | Mitigating Tests |
|---------|-----------------|------------------|
| R1 | Docker 镜像拉取失败 | 5.1-INT-001, 5.1-INT-010 (文档包含离线方案) |
| R2 | API 响应慢影响开发 | 5.1-UNIT-004 (超时处理), 5.1-UNIT-009 (重试逻辑) |
| R3 | OpenAI 网络访问问题 | 5.1-INT-003 (验证智谱AI作为主要方案) |
| R4 | LLM API 成本 | 5.1-UNIT-010 (日志监控 API 调用) |

---

## Recommended Execution Order

### Phase 1: Quick Feedback (P0 Unit Tests)
运行时间: ~5分钟

```bash
npm test tests/unit/services/evaluation/ragasEvaluator.test.ts
```

- 5.1-UNIT-001: 指标完整性
- 5.1-UNIT-002: ragas_score 计算
- 5.1-UNIT-003: 错误处理
- 5.1-UNIT-004: 超时处理
- 5.1-UNIT-011: 配置读取
- 5.1-UNIT-014: 覆盖率验证
- 5.1-UNIT-015: Public API 测试

### Phase 2: Integration Validation (P0 Integration Tests)
运行时间: ~10分钟

```bash
docker-compose -f docker-compose.ragas.yml up -d
npm test tests/integration/services/evaluation/ragasEvaluator.test.ts
```

- 5.1-INT-001: Docker 启动
- 5.1-INT-002: 健康检查
- 5.1-INT-003: 智谱AI 配置
- 5.1-INT-007: API 集成

### Phase 3: Additional Scenarios (P1)
运行时间: ~15分钟

- 所有 P1 unit tests
- 所有 P1 integration tests

### Phase 4: Enhanced Robustness (P2)
运行时间: ~10分钟

- 所有 P2 tests

**总预计时间**: ~40分钟

---

## Test Environment Requirements

### Local Development
- Node.js 18+
- Docker & Docker Compose
- 网络访问：智谱AI API (推荐) 或 OpenAI API
- 环境变量：`.env.local` 配置完整

### CI/CD Pipeline
- Docker-in-Docker 支持
- 智谱AI API Key (secret)
- 测试覆盖率报告上传

### Mock Strategy
- **Unit Tests**: Mock `global.fetch` 模拟 Ragas API
- **Integration Tests**: 使用真实 Docker 容器和 API
- 可选：使用 `nock` 录制真实 API 响应用于回放

---

## Success Criteria

### Functional Success
- ✅ 所有 P0 tests 通过
- ✅ 覆盖率 ≥ 80%
- ✅ Docker 容器稳定运行
- ✅ 智谱AI 配置下评估成功

### Quality Success
- ✅ 错误消息清晰可操作
- ✅ 日志信息完整有用
- ✅ 文档准确可执行
- ✅ 测试执行时间 < 1小时

### Operational Success
- ✅ 新开发者可根据文档独立搭建环境
- ✅ CI/CD pipeline 自动运行测试
- ✅ 问题排查有明确指引

---

## Notes

1. **智谱AI 优先**: 所有测试应优先验证智谱AI配置路径，这是国内环境的主要使用方式
2. **Mock 数据真实性**: Unit test 的 mock 数据应基于真实 API 响应格式
3. **网络问题处理**: Integration tests 应包含网络超时和重试的验证
4. **文档测试**: 文档中的命令应作为自动化测试的一部分执行验证

---

## Appendix: Test Code Templates

### Unit Test Template

```typescript
// tests/unit/services/evaluation/ragasEvaluator.test.ts

import { RagasEvaluator } from '@/services/evaluation/ragasEvaluator'
import type { RagasMetrics } from '@/types/evaluation'

// Mock fetch
global.fetch = jest.fn()

describe('RagasEvaluator', () => {
  let evaluator: RagasEvaluator

  beforeEach(() => {
    evaluator = new RagasEvaluator()
    jest.clearAllMocks()
  })

  describe('5.1-UNIT-001: evaluateQA returns complete metrics', () => {
    it('should return all 4 core metrics plus ragas_score', async () => {
      const mockResponse: RagasMetrics = {
        context_precision: 0.85,
        context_recall: 0.78,
        faithfulness: 0.92,
        answer_relevancy: 0.88,
        ragas_score: 0.86
      }

      ;(global.fetch as jest.Mock).mockResolvedValueOnce({
        ok: true,
        json: async () => mockResponse
      })

      const result = await evaluator.evaluateQA({
        question: 'What is RAG?',
        answer: 'RAG is Retrieval-Augmented Generation...',
        contexts: ['RAG combines retrieval with generation...']
      })

      expect(result).toHaveProperty('context_precision')
      expect(result).toHaveProperty('context_recall')
      expect(result).toHaveProperty('faithfulness')
      expect(result).toHaveProperty('answer_relevancy')
      expect(result).toHaveProperty('ragas_score')
    })
  })

  describe('5.1-UNIT-003: API unavailable error handling', () => {
    it('should throw clear error when API is not reachable', async () => {
      ;(global.fetch as jest.Mock).mockRejectedValueOnce(
        new Error('ECONNREFUSED')
      )

      await expect(
        evaluator.evaluateQA({
          question: 'Test',
          answer: 'Test',
          contexts: ['Test']
        })
      ).rejects.toThrow(/Ragas API.*not available/)
    })
  })
})
```

### Integration Test Template

```typescript
// tests/integration/services/evaluation/ragasEvaluator.test.ts

import { RagasEvaluator } from '@/services/evaluation/ragasEvaluator'

describe('RagasEvaluator Integration', () => {
  let evaluator: RagasEvaluator

  beforeAll(async () => {
    // 验证 Docker 容器运行
    evaluator = new RagasEvaluator()
  })

  describe('5.1-INT-002: Health check endpoint', () => {
    it('should return 200 OK', async () => {
      const response = await fetch('http://localhost:8000/health')
      expect(response.status).toBe(200)
    })
  })

  describe('5.1-INT-007: Real API call', () => {
    it('should successfully evaluate with real Ragas API', async () => {
      const result = await evaluator.evaluateQA({
        question: 'What is machine learning?',
        answer: 'Machine learning is a subset of artificial intelligence...',
        contexts: ['Machine learning involves training models on data...']
      })

      expect(result.ragas_score).toBeGreaterThan(0)
      expect(result.ragas_score).toBeLessThanOrEqual(1)
    }, 30000) // 30 second timeout
  })
})
```

---

**End of Test Design Document**

