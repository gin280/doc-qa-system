# Risk Profile: Story 1.6 - 用户账户管理页面

**日期**: 2025-01-08  
**评审人**: Quinn (Test Architect)  
**Story ID**: 1.6  
**Epic**: 1 - 基础设施与用户认证

---

## 执行摘要

- **识别风险总数**: 9
- **关键风险 (Critical)**: 2
- **高风险 (High)**: 2
- **中等风险 (Medium)**: 3
- **低风险 (Low)**: 2
- **总体风险评分**: 66/100

### 风险评分计算
```
基础分: 100
- Critical (9分) × 2 = -40
- High (6分) × 2 = -20
- Medium (4分) × 3 = -15
- Low (2-3分) × 2 = -5
= 66/100 (中等风险)
```

---

## 需要立即关注的关键风险

### 1. [SEC-001]: 密码修改功能缺乏足够的安全控制

**分数**: 9 (Critical)  
**概率**: High - 密码修改功能是攻击者的常见目标,尤其是弱 rate limiting 容易被绕过  
**影响**: High - 账户接管可能导致数据泄露、身份盗用、系统信誉受损

**详细描述**:
当前实现的 rate limiting (5分钟3次尝试) 对于密码修改操作来说可能不够严格:
- 攻击者可以通过慢速攻击绕过简单的时间窗口限制
- 没有账户锁定机制,失败后可以继续尝试
- 缺乏邮件通知,用户可能不知道账户被攻击
- 没有密码历史检查,可能重复使用旧密码

**缓解措施**:
1. **强化 Rate Limiting**:
   - 密码修改失败 3 次后锁定账户 30 分钟
   - 使用 Redis 实现分布式限流(如果有多个服务实例)
   - 添加 IP 级别的限流

2. **实现邮件通知系统**:
   - 密码修改成功后立即发送邮件通知
   - 邮件包含时间、IP 地址、设备信息
   - 提供"这不是我"的快速响应链接

3. **密码历史检查**:
   - 存储最近 3 次密码的哈希值
   - 新密码不能与历史密码相同
   - 添加 `password_history` 表

4. **可选增强措施**:
   - IP 白名单或地理位置验证
   - 双因素认证 (2FA) - 后续 Story
   - 密码强度评分更严格(禁止常见密码)

**测试要求**:
- **安全测试**: 使用 OWASP ZAP 或 Burp Suite 模拟暴力破解
- **单元测试**: 验证 rate limiting 在边界条件下的行为
- **集成测试**: 验证邮件发送、账户锁定、解锁流程
- **手动测试**: 验证用户体验和错误提示

**残留风险**: 低 - 实施所有缓解措施后,仍可能面临高级社会工程学攻击

**责任人**: dev  
**时间线**: 实现前必须完成(P0)

---

### 2. [SEC-002]: 账户删除操作缺乏审计日志

**分数**: 9 (Critical)  
**概率**: High - 恶意删除、误操作、法律合规需求都很常见  
**影响**: High - 数据永久丢失且无法追溯,可能导致法律问题

**详细描述**:
当前代码中账户删除操作没有审计日志:
- 无法追溯谁在何时删除了账户
- 无法识别恶意删除或误操作
- 不符合 GDPR/CCPA 等数据保护法规的审计要求
- 无法提供用户行为的证据链

**缓解措施**:
1. **实现审计日志系统**:
   ```typescript
   // 创建审计日志表
   export const auditLogs = pgTable('audit_logs', {
     id: text('id').primaryKey().$defaultFn(() => createId()),
     userId: text('user_id').references(() => users.id),
     action: text('action').notNull(), // 'DELETE_ACCOUNT', 'CHANGE_PASSWORD', 'UPDATE_PROFILE'
     ipAddress: text('ip_address'),
     userAgent: text('user_agent'),
     metadata: jsonb('metadata'), // 额外信息
     createdAt: timestamp('created_at').defaultNow().notNull()
   })
   ```

2. **记录的关键操作**:
   - 账户删除 (`DELETE_ACCOUNT`)
   - 密码修改 (`CHANGE_PASSWORD`)
   - 个人信息更新 (`UPDATE_PROFILE`)
   - 登录/登出事件(已在 1.4 中实现)

3. **日志内容**:
   - 用户 ID 和邮箱
   - 操作类型和时间戳
   - IP 地址和 User-Agent
   - 操作前的数据快照(JSON)
   - 操作结果(成功/失败)

4. **日志查询功能**:
   - 管理员可以查看审计日志
   - 用户可以查看自己的操作历史
   - 支持按时间、操作类型过滤

**测试要求**:
- **集成测试**: 验证所有关键操作都记录日志
- **单元测试**: 验证日志记录函数的正确性
- **手动测试**: 检查日志内容的完整性和可读性
- **性能测试**: 确保日志写入不影响主流程性能

**残留风险**: 低 - 需要额外的日志分析和告警系统

**责任人**: dev  
**时间线**: 部署前必须完成(P0)

---

## 风险分布

### 按类别

| 类别     | 风险数量 | 关键风险 |
|---------|---------|---------|
| Security | 3       | 2       |
| Data     | 2       | 1       |
| Performance | 1    | 0       |
| Operations | 1    | 0       |
| Business | 1      | 0       |
| Technical | 1     | 0       |

### 按组件

| 组件                          | 风险数量 |
|------------------------------|---------|
| `/api/user/password`         | 2       |
| `/api/user/account`          | 2       |
| `ChangePasswordModal.tsx`    | 2       |
| `drizzle/schema.ts`          | 1       |
| `/api/user/usage`            | 1       |
| `@/lib/rate-limit`           | 1       |
| `/api/user/profile`          | 1       |
| `DeleteAccountModal.tsx`     | 1       |
| `SettingsPage`               | 2       |

---

## 详细风险登记册

### 高风险 (High - Score 6)

#### DATA-001: 级联删除可能导致意外数据丢失

**分数**: 6  
**概率**: Medium - 如果 schema 配置错误或理解不当  
**影响**: High - 用户所有数据被永久删除

**详细描述**:
Drizzle ORM 的 `onDelete: 'cascade'` 配置会在删除用户时自动删除所有关联数据:
- `documents` 表: 用户上传的所有文档
- `document_chunks` 表: 文档的向量化数据
- `conversations` 表: 对话历史
- `messages` 表: 对话消息
- `user_usage` 表: 使用量统计

**潜在问题**:
- Schema 配置错误可能导致级联删除失败,数据库状态不一致
- 删除操作不可逆,误操作无法恢复
- 大量数据删除可能导致性能问题

**缓解措施**:
1. **审查 Schema 配置**:
   - 在实现前仔细检查所有外键的 `onDelete` 配置
   - 确保所有需要级联删除的表都配置了 `cascade`
   - 文档所有级联关系

2. **实现软删除**:
   ```typescript
   // 为关键表添加 deletedAt 字段
   export const users = pgTable('users', {
     // ... existing fields
     deletedAt: timestamp('deleted_at')
   })
   ```

3. **数据导出功能**:
   - 在删除前允许用户导出所有数据
   - 提供 JSON 或 CSV 格式下载

4. **数据备份策略**:
   - 实现定期数据库备份
   - 删除操作前创建临时备份
   - 保留备份 30 天

**测试要求**:
- **单元测试**: 验证级联删除的行为符合预期
- **集成测试**: 完整测试删除流程,验证所有相关数据被删除
- **手动测试**: 在测试环境中删除账户,检查数据库状态

**残留风险**: 低 - 软删除和备份提供恢复机制

**责任人**: dev  
**时间线**: 实现前必须完成

---

#### SEC-003: OAuth 用户密码修改防护不完整

**分数**: 6  
**概率**: Medium - 边界条件处理不当  
**影响**: High - OAuth 用户可能绕过前端限制调用 API

**详细描述**:
当前实现可能存在漏洞:
- 前端只检查 `authProvider` 来决定是否显示"修改密码"按钮
- API 端点虽然检查 `passwordHash` 是否存在,但可能不够严格
- 如果 OAuth 用户通过 API 直接调用,可能绕过前端限制

**缓解措施**:
1. **服务端严格验证**:
   ```typescript
   // 在 /api/user/password 中添加
   if (user.authProvider !== 'EMAIL') {
     return NextResponse.json(
       { error: 'OAuth 用户不支持密码修改' },
       { status: 403 }
     )
   }
   ```

2. **前端双重检查**:
   - 不仅隐藏按钮,还要在表单提交前验证
   - 如果用户通过开发者工具启用按钮,仍然阻止提交

3. **添加专门测试**:
   - OAuth 用户尝试修改密码应返回 403
   - 测试边界条件(如 `passwordHash` 为空字符串而非 null)

**测试要求**:
- **单元测试**: OAuth 用户调用密码 API 返回 403
- **安全测试**: 尝试绕过前端限制直接调用 API
- **集成测试**: 完整流程验证

**残留风险**: 极低

**责任人**: dev  
**时间线**: 实现前完成

---

### 中等风险 (Medium - Score 4)

#### PERF-001: 使用量查询可能成为性能瓶颈

**分数**: 4  
**概率**: Medium - 每次加载设置页面都查询  
**影响**: Medium - 页面加载缓慢,用户体验下降

**缓解措施**:
1. 为 `userUsage.userId` 添加数据库索引
2. 实现客户端缓存(5分钟)
3. 考虑使用 SWR 或 React Query

**测试要求**: 性能测试,并发 100 请求

---

#### OPS-001: Rate limiter 实现可能不可靠

**分数**: 4  
**概率**: Medium - 简单内存实现  
**影响**: Medium - 服务重启后限流状态丢失

**缓解措施**:
1. 使用 Redis 实现分布式 rate limiting
2. 添加监控和告警

**测试要求**: 集成测试验证限流触发和重置

---

#### BUS-001: 用户名修改缺乏去重检查

**分数**: 4  
**概率**: Medium - 如果未来添加唯一约束  
**影响**: Medium - 可能产生冲突

**缓解措施**:
1. 确认用户名是否需要唯一
2. 如果需要,添加唯一索引和去重检查

---

### 低风险 (Low - Score 2-3)

#### TECH-001: Session 清除时序问题

**分数**: 2  
**概率**: Low - NextAuth 处理较成熟  
**影响**: Medium - 删除账户后 session 未及时清除

**缓解措施**: 确保 `signOut()` 在数据库删除后立即调用

---

#### DATA-002: 存储空间计算可能不准确

**分数**: 1  
**概率**: Low - 简单的字节计算  
**影响**: Low - 显示值不准确但不影响功能

**缓解措施**: 添加单元测试验证格式化函数

---

## 基于风险的测试策略

### Priority 1: 关键风险测试

**必须在部署前完成**:

1. **安全渗透测试**:
   - 使用 OWASP ZAP 测试密码修改端点
   - 模拟暴力破解攻击
   - 验证 rate limiting 有效性

2. **OAuth 用户边界测试**:
   - 尝试各种方式绕过密码修改限制
   - 测试 API 直接调用

3. **审计日志完整性测试**:
   - 验证所有关键操作都被记录
   - 检查日志内容的完整性

4. **级联删除测试**:
   - 完整测试账户删除流程
   - 验证所有关联数据被正确处理

### Priority 2: 高风险测试

1. **数据导出测试**: 验证删除前数据导出功能
2. **邮件通知测试**: 验证密码修改后邮件发送

### Priority 3: 中/低风险测试

1. **性能测试**: 使用量查询响应时间
2. **缓存测试**: 验证客户端缓存机制
3. **UI 测试**: 存储空间显示格式

---

## 部署策略

基于风险评估,建议采用以下部署策略:

### 阶段 1: 风险缓解 (实现前)
- [ ] 实现审计日志系统
- [ ] 强化 rate limiting
- [ ] 添加邮件通知功能
- [ ] 审查 schema 级联配置
- [ ] 实现数据导出功能

### 阶段 2: 核心功能实现
- [ ] 实现所有 AC 功能
- [ ] 遵循安全最佳实践

### 阶段 3: 测试验证
- [ ] 完成所有 P0/P1 测试
- [ ] 修复所有高/关键风险

### 阶段 4: 灰度发布
- [ ] 10% 用户灰度测试 1 周
- [ ] 监控审计日志和错误率
- [ ] 全量发布

---

## 监控要求

部署后需要监控的指标:

### 安全指标
- 密码修改失败次数和分布
- 账户锁定事件
- 账户删除事件
- 审计日志异常模式

### 性能指标
- `/api/user/usage` 响应时间 (P95/P99)
- 数据库查询耗时
- 客户端缓存命中率

### 业务指标
- 用户名修改频率
- 密码修改频率
- 账户删除率和原因分析

---

## 风险接受标准

### 可以带缓解措施部署的风险
- 中等风险(Score 4),已有监控和补偿措施
- 低风险(Score ≤ 3),有明确恢复计划

### 必须修复才能部署的风险
- 所有关键风险(Score 9)
- 高风险中的安全和数据类风险(Score 6)

### 接受的残留风险
- 高级社会工程学攻击
- 零日漏洞
- 内存 rate limiter 的状态丢失(如使用 Redis 则无此问题)

需要相关权限人员(Product Owner / Security Lead)签字批准。

---

## 风险审查触发条件

以下情况需要重新评估风险:

1. **架构变更**: 数据库 schema 重大调整
2. **新集成**: 添加第三方服务或 API
3. **安全事件**: 发现新的安全漏洞
4. **性能问题**: 生产环境出现性能瓶颈
5. **合规要求**: 法律法规变化

---

## 附录: 风险评分方法论

### 概率级别
- **High (3)**: >70% 可能发生
- **Medium (2)**: 30-70% 可能发生
- **Low (1)**: <30% 可能发生

### 影响级别
- **High (3)**: 严重后果(数据泄露、系统崩溃、重大财务损失)
- **Medium (2)**: 中等后果(性能下降、功能受限)
- **Low (1)**: 轻微后果(显示问题、用户体验略差)

### 风险分数
**分数 = 概率 × 影响**
- 9: Critical (红色) - 必须立即处理
- 6: High (橙色) - 高优先级处理
- 4: Medium (黄色) - 计划处理
- 2-3: Low (绿色) - 监控即可
- 1: Minimal (蓝色) - 可接受

---

**报告生成时间**: 2025-01-08  
**下次审查日期**: 2025-01-15 (实现完成后)

