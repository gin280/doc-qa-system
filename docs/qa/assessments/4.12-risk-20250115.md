# Risk Profile: Story 4.12 - Axiom 日志集成

**Date**: 2025-01-15  
**Reviewer**: Quinn (测试架构师)  
**Story**: 4.12 - Axiom 日志集成
**Status**: CONCERNS

---

## Executive Summary

- **Total Risks Identified**: 4
- **High Risks**: 2 (MNT-001, TEST-001)
- **Medium Risks**: 1 (OPS-001)
- **Low Risks**: 1 (MNT-002)
- **Overall Risk Score**: 65/100 (Medium Risk)

**关键发现**:
1. ✅ Logger 核心实现质量优秀,符合架构设计
2. ❌ API Routes 层日志未迁移 (19 文件),违反 AC3
3. ❌ 缺少单元测试,无法保证功能稳定性
4. ⚠️ 手动配置任务未完成,无法真正投入使用

---

## Critical Risks Requiring Immediate Attention

### 1. [MNT-001]: API Routes 层日志未迁移

**Score: 6 (High)**  
**Category**: Technical Debt / Maintainability

**Probability**: High (3/3)  
- 已确认存在: `src/app/api/` 目录下 19 个文件仍使用 console 日志
- 影响范围广: 所有 API 错误无法发送到 Axiom

**Impact**: Medium (2/3)  
- **运维影响**: API 错误无法集中监控,故障排查时间增加
- **功能影响**: 违反 AC3 "100% 消除 console 日志" 承诺
- **技术债务**: 日志分散在 Vercel Logs 和 Axiom 之间,增加维护复杂度

**Mitigation**:
1. **Immediate Action**: 
   - 将所有 API route 中的 `console.log` → `logger.info`
   - 将所有 `console.error` → `logger.error`
   - 将所有 `console.warn` → `logger.warn`
   - 预估工作量: 2-3 小时

2. **Validation**:
   - 手动测试每个修改的 API route
   - 验证错误日志成功发送到 Axiom (需配置 Token)
   - 检查日志格式符合结构化规范

3. **Prevention**:
   - 添加 ESLint rule 禁止在 `src/app/api/` 中使用 `console.*`
   - 在 Code Review 中强制检查日志使用

**Testing Requirements**:
- Integration tests 验证 API 错误日志正确记录
- Manual tests 触发 API 错误,检查 Axiom 收到日志

**Residual Risk**: Low  
- 修复后,API 错误可集中监控,技术债务消除

**Owner**: Dev  
**Timeline**: Before Ready for Done (必须完成)

---

### 2. [TEST-001]: 缺少单元测试

**Score: 6 (High)**  
**Category**: Quality / Reliability

**Probability**: High (3/3)  
- 已确认: `tests/unit/lib/logger.test.ts` 不存在
- Logger 配置逻辑和辅助函数未验证

**Impact**: Medium (2/3)  
- **质量影响**: 无法保证 Logger 配置在不同环境下正确工作
- **维护风险**: 重构或升级 pino 时可能破坏功能
- **战略影响**: 违反 Epic 4 测试覆盖率目标 (80%)

**Mitigation**:
1. **Immediate Action**:
   - 创建 `tests/unit/lib/logger.test.ts`
   - 测试 Logger 实例创建 (development vs production)
   - 测试环境变量配置 (LOG_LEVEL, AXIOM_TOKEN, NODE_ENV)
   - 测试辅助函数:
     - `sanitizeQuery()` - 截断到 100 字符
     - `sanitizeEmail()` - 脱敏为 `a***@example.com`
     - `logError()` - 错误格式化
   - Mock pino-axiom transport,验证日志发送逻辑
   - 目标覆盖率: >80%
   - 预估工作量: 3-4 小时

2. **Testing Strategy**:
   - Unit tests: Logger 配置逻辑、辅助函数
   - Integration tests: 验证 Axiom 发送 (可选,需 Token)

**Testing Requirements**:
- Mock `process.env` 测试环境变量驱动的配置切换
- Mock `pino-axiom` 验证日志发送逻辑
- 测试边界情况: 超长查询、特殊字符 Email

**Residual Risk**: Low  
- 测试覆盖后,配置逻辑稳定性大幅提升

**Owner**: Dev  
**Timeline**: Before Ready for Done (必须完成)

---

## Medium Risks

### 3. [OPS-001]: 手动配置任务未完成

**Score: 4 (Medium)**  
**Category**: Operational / Business

**Probability**: Medium (2/3)  
- 手动任务依赖用户操作,非代码问题
- Axiom 账号注册、Token 生成、Dashboard 配置、告警规则、运维文档均未完成

**Impact**: Medium (2/3)  
- **功能影响**: 即使代码完美,日志也无法发送到 Axiom (Token 未配置)
- **运维影响**: Dashboard 和告警规则未配置,无法监控系统健康
- **知识影响**: 运维文档未创建,团队无法使用监控功能

**Mitigation**:
1. **Task 1: Axiom 账号配置** (预估 1-2h):
   - 注册 Axiom 账号 (Free 计划,500GB/月)
   - 创建 Dataset: `docqa-system`
   - 生成 API Token (Ingest 权限)
   - 配置环境变量到 Vercel:
     - `AXIOM_DATASET=docqa-system`
     - `AXIOM_TOKEN=<token>` (标记为 Secret)
     - `AXIOM_ORG_ID=<org-id>`
     - `LOG_LEVEL=info`

2. **Task 4: Dashboard 配置** (预估 1-2h):
   - Task 4.1: 创建 Saved Queries:
     - "错误日志" (level == "error" or level == "fatal")
     - "上传日志" (action contains "upload")
     - "查询日志" (action contains "query" or "retrieval" or "generation")
     - "缓存日志" (action contains "cache")
   - Task 4.2: 创建监控 Dashboard:
     - Panel 1: 错误趋势 (折线图,24h)
     - Panel 2: 请求量分布 (柱状图,按 action)
     - Panel 3: 平均响应时间 (折线图)
     - Panel 4: 缓存命中率 (折线图,如适用)
     - Panel 5: Top 错误类型 (表格)
   - Task 4.3: 配置告警规则:
     - Alert 1: 高错误率 (count(where level=="error") > 20 in 5m)
     - Alert 2: 上传失败激增 (count(where action=="upload_error") > 10 in 1h)
     - Alert 3: Axiom 配额告警 (月度使用 >80%)

3. **Task 6: 运维文档** (预估 2-3h):
   - 创建 `docs/deployment/axiom-logging-setup.md`:
     - Axiom 账号注册步骤
     - API Token 生成和环境变量配置
     - Dashboard 访问和使用指南
   - 创建 `docs/deployment/axiom-operations-guide.md`:
     - 常见查询语句 (错误排查、性能分析)
     - 告警规则配置和调整
     - 配额监控和优化建议
     - 故障排查 Checklist
   - 创建 `docs/architecture/logging-guide.md`:
     - Logger 使用规范和最佳实践
     - 日志级别选择 (debug/info/warn/error/fatal)
     - 敏感信息脱敏规则
   - 更新 `docs/architecture.md` 状态 (❌ → ✅)

**Residual Risk**: Low  
- 配置完成后,系统可正常投入使用

**Owner**: PO / User  
**Timeline**: Can mark as "Blocked - 待用户完成" (可标记为阻塞)

---

## Low Risks

### 4. [MNT-002]: Frontend 组件仍有 console 调用

**Score: 2 (Low)**  
**Category**: Maintainability

**Probability**: Low (1/3)  
- Frontend 错误主要通过 Sentry 监控,console 调用影响有限

**Impact**: Medium (2/3)  
- **可观测性影响**: 前端错误无法集中到 Axiom (但有 Sentry)
- **技术债务**: 日志分散,增加维护复杂度

**Mitigation**:
- **Option 1**: 考虑创建前端专用 logger
- **Option 2**: 继续使用 Sentry,接受 console 调用 (推荐)

**Residual Risk**: Low  
- Sentry 已覆盖前端错误追踪,console 调用影响有限

**Owner**: Dev  
**Timeline**: Future (可选优化,低优先级)

---

## Risk Distribution

### By Category

- **Technical Debt / Maintainability**: 2 risks (MNT-001, MNT-002)
- **Quality / Reliability**: 1 risk (TEST-001)
- **Operational / Business**: 1 risk (OPS-001)

### By Component

- **API Routes**: MNT-001 (High)
- **Logger Tests**: TEST-001 (High)
- **Axiom Configuration**: OPS-001 (Medium)
- **Frontend**: MNT-002 (Low)

---

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests

**MNT-001 - API Routes 日志迁移**:
- Integration tests 验证 API 错误日志记录
- Manual tests 触发各种 API 错误,检查 Axiom 收到
- Edge cases: 认证失败、数据库错误、文件上传错误

**TEST-001 - Logger 单元测试**:
- Unit tests 验证 Logger 配置逻辑
- Mock tests 验证 Axiom transport 发送
- Environment tests 验证环境变量驱动的配置切换

### Priority 2: Medium Risk Tests

**OPS-001 - Axiom 配置验证**:
- Manual tests 验证 Axiom Token 配置正确
- Dashboard tests 验证查询和监控面板工作
- Alert tests 故意触发告警,验证通知发送

### Priority 3: Low Risk Tests

**MNT-002 - Frontend 日志 (可选)**:
- 继续依赖 Sentry,无需额外测试

---

## Risk Acceptance Criteria

### Must Fix Before Production

- ✅ **High Risks** (MNT-001, TEST-001): 必须修复
  - API Routes 日志迁移完成
  - Logger 单元测试覆盖率 >80%

### Can Deploy with Mitigation

- ⚠️ **Medium Risks** (OPS-001): 可标记为 "Blocked - 待用户完成"
  - Axiom 配置任务为手动操作,不阻塞代码完成

### Accepted Risks

- ✅ **Low Risks** (MNT-002): 接受风险
  - Frontend console 调用可继续使用,Sentry 已覆盖错误追踪

---

## Monitoring Requirements

Post-deployment monitoring for:

1. **Axiom 日志量监控**:
   - 每日摄入量 (预期 <5MB/day)
   - 月度配额使用 (预期 <150MB/月 << 500GB)
   - 告警配置: >80% 配额使用 → 发送通知

2. **日志质量监控**:
   - 错误日志数量趋势 (24h, 1h interval)
   - API 错误率 (目标 <5%)
   - 日志结构化合规率 (目标 100%)

3. **业务指标监控**:
   - 上传成功/失败率
   - 查询响应时间
   - 缓存命中率 (如 Story 4.2 完成)

---

## Risk Review Triggers

Review and update risk profile when:

1. **Architecture 变化**:
   - 新增 API routes
   - 修改 Logger 配置
   - 升级 pino 或 pino-axiom 版本

2. **Axiom 配额变化**:
   - 月度使用量接近 80% (400GB)
   - 考虑升级付费计划或优化日志策略

3. **故障发现**:
   - Axiom 日志丢失
   - Dashboard 查询失败
   - 告警未触发

---

## Key Principles

- **风险优先级**: High Risks 必须修复,Medium Risks 可标记为阻塞
- **测试优先**: 单元测试覆盖 Logger 核心逻辑
- **运维就绪**: 配置和文档完成后才能投入使用
- **持续监控**: 配额、错误率、业务指标
