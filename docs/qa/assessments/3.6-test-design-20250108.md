# 测试设计：故事 3.6 - 对话导出与分享

日期：2025-01-08  
设计者：Quinn（测试架构师）

## 测试策略概览

- 总测试场景：28
- 单元测试：12（已完成）
- 集成测试：10（待完成）
- E2E 测试：6（待完成）
- 优先级分布：P0: 12，P1: 10，P2: 6

## 按验收标准的测试场景

### AC1: Markdown 格式导出

#### 场景

| ID | 级别 | 优先级 | 测试 | 理由 |
|----|------|--------|------|------|
| 3.6-UNIT-001 | Unit | P0 | 验证 Markdown 格式生成 | 核心格式化逻辑 |
| 3.6-UNIT-002 | Unit | P0 | 验证包含引用的导出 | 引用是关键功能 |
| 3.6-UNIT-003 | Unit | P0 | 验证不含引用的导出 | 边界情况 |
| 3.6-UNIT-004 | Unit | P0 | 验证元数据包含 | 完整性检查 |
| 3.6-INT-001 | Integration | P0 | 完整导出 API 流程 | API + 数据库交互 |
| 3.6-INT-002 | Integration | P0 | 文件下载响应格式 | HTTP 响应验证 |
| 3.6-E2E-001 | E2E | P1 | 用户点击导出并下载文件 | 端到端用户流程 |

**Given-When-Then 映射：**

**单元测试：markdownExporter.test.ts（已实现 ✅）**
- Given: 对话数据包含标题、消息、引用
- When: 调用 generateMarkdownExport
- Then: 返回正确格式的 Markdown Buffer

**集成测试：conversation-export.test.ts（待实现）**
- Given: 数据库中存在用户的对话
- When: GET /api/conversations/:id/export?format=markdown
- Then: 返回 200，Content-Type: text/markdown，正确的文件名

**E2E 测试：conversation-export.spec.ts（待实现）**
- Given: 用户已登录并查看对话
- When: 点击"导出"按钮
- Then: 文件下载到本地，内容包含对话

---

### AC2: PDF 格式导出

**状态：❌ 功能已移除**

所有 AC2 相关测试推迟到 Phase 2。

---

### AC3: 批量导出功能

#### 场景

| ID | 级别 | 优先级 | 测试 | 理由 |
|----|------|--------|------|------|
| 3.6-UNIT-005 | Unit | P1 | ZIP 文件生成 | ZIP 打包逻辑 |
| 3.6-UNIT-006 | Unit | P1 | 批量文件命名 | 文件名冲突处理 |
| 3.6-INT-003 | Integration | P0 | 批量导出 API | API 多对话处理 |
| 3.6-INT-004 | Integration | P1 | 批量导出权限验证 | 安全性 |
| 3.6-INT-005 | Integration | P1 | 批量导出数量限制 | 防止滥用 |
| 3.6-E2E-002 | E2E | P2 | 批量选择并导出（UI 待实现） | 完整批量流程 |

**Given-When-Then 映射：**

**单元测试：zipGenerator.test.ts（待实现）**
- Given: 多个 Markdown Buffer
- When: 调用 generateZipExport
- Then: 返回包含所有文件的 ZIP Buffer

**集成测试**
- Given: 数据库中存在用户的多个对话
- When: POST /api/conversations/export-batch
- Then: 返回 ZIP 文件，包含所有对话

---

### AC4: 导出按钮 UI 集成

#### 场景

| ID | 级别 | 优先级 | 测试 | 理由 |
|----|------|--------|------|------|
| 3.6-UNIT-007 | Unit | P1 | ExportButton 渲染 | 组件测试 |
| 3.6-UNIT-008 | Unit | P1 | ExportButton 加载状态 | UI 状态管理 |
| 3.6-E2E-003 | E2E | P1 | 导出按钮可见性和点击 | UI 交互 |

**Given-When-Then 映射：**

**单元测试：ExportButton.test.tsx（待实现）**
- Given: ExportButton 组件渲染
- When: 用户点击按钮
- Then: 调用 API，显示加载状态

**E2E 测试**
- Given: 用户查看对话
- When: 悬停在导出按钮上
- Then: 显示提示文字

---

### AC5: 导出内容格式化

**覆盖**：已由 AC1 单元测试覆盖（3.6-UNIT-001 到 004）

---

### AC6: 导出权限验证

#### 场景

| ID | 级别 | 优先级 | 测试 | 理由 |
|----|------|--------|------|------|
| 3.6-INT-006 | Integration | P0 | 未认证用户导出（401） | 安全性 - 关键 |
| 3.6-INT-007 | Integration | P0 | 导出他人对话（403） | 授权 - 关键 |
| 3.6-INT-008 | Integration | P0 | 导出不存在的对话（404） | 错误处理 |
| 3.6-INT-009 | Integration | P0 | **速率限制测试（待实现功能）** | 防止滥用 - 关键 |

**Given-When-Then 映射：**

**集成测试**
- Given: 用户未登录
- When: GET /api/conversations/:id/export
- Then: 返回 401 Unauthorized

- Given: 用户 A 尝试导出用户 B 的对话
- When: GET /api/conversations/:id/export
- Then: 返回 403 Forbidden

- Given: 用户已登录
- When: 连续发起 10 次导出请求
- Then: 第 6 次请求返回 429 Too Many Requests

---

### AC7: 导出性能优化

#### 场景

| ID | 级别 | 优先级 | 测试 | 理由 |
|----|------|--------|------|------|
| 3.6-PERF-001 | Performance | P1 | Markdown 导出响应时间 | 性能 SLA |
| 3.6-PERF-002 | Performance | P2 | 大对话导出（100+ 消息） | 边界性能 |
| 3.6-PERF-003 | Performance | P2 | 批量导出完成时间 | 批量性能 |

**Given-When-Then 映射：**

**性能测试：performance/export.test.ts（待实现）**
- Given: 10 条消息的典型对话
- When: 导出为 Markdown
- Then: 响应时间 < 2 秒

- Given: 100 条消息的大对话
- When: 导出为 Markdown
- Then: 响应时间 < 5 秒

---

### AC8: 错误处理和边界情况

#### 场景

| ID | 级别 | 优先级 | 测试 | 理由 |
|----|------|--------|------|------|
| 3.6-INT-010 | Integration | P0 | 网络错误处理 | 可靠性 |
| 3.6-UNIT-009 | Unit | P1 | 空对话导出 | 边界情况 |
| 3.6-UNIT-010 | Unit | P1 | 特殊字符转义 | 数据完整性 |
| 3.6-E2E-004 | E2E | P1 | 用户看到错误提示 | 用户体验 |

**Given-When-Then 映射：**

**单元测试**
- Given: 对话没有消息
- When: 导出为 Markdown
- Then: 生成包含元数据但无消息的文件

- Given: 对话标题包含特殊字符 `<>:"/\|?*`
- When: 生成文件名
- Then: 特殊字符被移除或替换

**集成测试**
- Given: 数据库连接失败
- When: 导出对话
- Then: 返回 500，记录错误日志

**E2E 测试**
- Given: 用户点击导出但网络错误
- When: 导出失败
- Then: 显示错误提示"导出失败，请重试"

---

### AC9: 导出格式质量保证

#### 场景

| ID | 级别 | 优先级 | 测试 | 理由 |
|----|------|--------|------|------|
| 3.6-UNIT-011 | Unit | P1 | Markdown 标准语法验证 | 兼容性 |
| 3.6-UNIT-012 | Unit | P1 | UTF-8 编码验证 | 中文支持 |
| 3.6-E2E-005 | E2E | P2 | Markdown 在编辑器中正常显示 | 实际使用场景 |

**Given-When-Then 映射：**

**单元测试**
- Given: 对话包含中文消息
- When: 导出为 Markdown
- Then: Buffer 使用 UTF-8 编码，中文正确显示

**E2E 测试**
- Given: 下载的 Markdown 文件
- When: 在 VSCode/Typora 中打开
- Then: 格式正确，中文无乱码

---

### AC10: 导出功能监控

**状态：⚠️ 非测试场景，运维监控**

不需要测试，但需要：
- 生产环境日志记录
- 指标收集
- 告警设置

---

## 测试覆盖总结

### 已完成（✅）

**单元测试：12 个测试全部通过**

文件：
- `tests/unit/services/exportFormatter.test.ts`（7 个测试）
- `tests/unit/services/markdownExporter.test.ts`（4 个测试）

覆盖的 AC：
- AC1（Markdown 导出）
- AC5（内容格式化）
- AC9（格式质量）部分

### 待实现（❌）

**单元测试：4 个测试**
- zipGenerator.test.ts（AC3）
- ExportButton.test.tsx（AC4）
- 边界情况测试（AC8）

**集成测试：10 个测试**
- conversation-export.test.ts（AC1, AC3, AC6, AC8）
- 所有 API 端点测试
- 权限验证测试
- 错误处理测试

**E2E 测试：6 个测试**
- conversation-export.spec.ts（AC1, AC3, AC4, AC8）
- 用户导出流程
- 错误提示验证

**性能测试：3 个测试**
- export-performance.test.ts（AC7）
- 响应时间测试
- 大对话测试

---

## 覆盖缺口

### 关键缺口（必须修复）

1. **集成测试完全缺失** - 高风险
   - API 端点未测试
   - 数据库交互未验证
   - 权限逻辑未测试

2. **速率限制未实现且未测试** - 高风险
   - 功能缺失
   - 测试无法编写

3. **错误处理测试不足** - 中风险
   - ExportButton 错误场景未测试
   - API 错误响应未验证

### 次要缺口（建议修复）

4. **批量导出 UI 未实现** - 低风险
   - 功能缺失导致无法测试

5. **性能测试缺失** - 中风险
   - 无法验证性能 SLA

---

## 推荐测试执行顺序

### 阶段 1：生产部署前必须完成（P0）

1. **集成测试 - API 核心功能**
   - 3.6-INT-001（单个导出）
   - 3.6-INT-003（批量导出）
   - 3.6-INT-006（认证）
   - 3.6-INT-007（授权）
   - 3.6-INT-008（404）

2. **单元测试 - 错误处理**
   - 3.6-UNIT-009（空对话）
   - 3.6-UNIT-010（特殊字符）

3. **E2E 测试 - 基本流程**
   - 3.6-E2E-001（导出下载）
   - 3.6-E2E-004（错误提示）

### 阶段 2：生产部署后可完成（P1-P2）

4. **单元测试 - 组件**
   - 3.6-UNIT-005（ZIP）
   - 3.6-UNIT-007（ExportButton）

5. **性能测试**
   - 3.6-PERF-001（响应时间）
   - 3.6-PERF-002（大对话）

6. **E2E 测试 - 完整流程**
   - 3.6-E2E-003（UI 交互）
   - 3.6-E2E-005（格式验证）

---

## 测试数据要求

### 测试对话样本

**对话 1：简单对话（10 条消息）**
- 5 个用户问题
- 5 个 AI 回答
- 3 个回答包含引用
- 用于基本功能测试

**对话 2：大对话（100 条消息）**
- 50 个用户问题
- 50 个 AI 回答
- 30 个回答包含引用
- 用于性能测试

**对话 3：边界情况**
- 空对话（0 条消息）
- 标题包含特殊字符
- 消息包含 Markdown 特殊字符
- 引用没有页码

### 测试用户

- User A（有 5 个对话）
- User B（有 3 个对话）
- 用于权限测试

---

## 关键原则

- **测试金字塔**：单元测试 > 集成测试 > E2E 测试
- **Given-When-Then 用于文档**，不用于测试代码
- **优先 P0 测试**，确保核心功能可靠
- **快速反馈**：单元测试 < 1 秒，集成测试 < 5 秒
- **独立测试**：每个测试独立运行，不依赖顺序

---

## 质量指标

成功的测试覆盖应达到：

- ✅ 所有 P0 AC 有测试
- ✅ 单元测试覆盖率 > 80%
- ⚠️ 集成测试覆盖核心 API 端点（当前 0%）
- ⚠️ E2E 测试覆盖关键用户流程（当前 0%）

---

## 附录：测试文件映射

| 测试文件 | 覆盖的 AC | 状态 |
|---------|----------|------|
| tests/unit/services/exportFormatter.test.ts | AC1, AC5, AC9 | ✅ 完成 |
| tests/unit/services/markdownExporter.test.ts | AC1, AC5 | ✅ 完成 |
| tests/unit/services/zipGenerator.test.ts | AC3 | ❌ 待实现 |
| tests/unit/components/ExportButton.test.tsx | AC4 | ❌ 待实现 |
| tests/integration/api/conversation-export.test.ts | AC1, AC3, AC6, AC8 | ❌ 待实现 |
| tests/performance/export-performance.test.ts | AC7 | ❌ 待实现 |
| tests/e2e/conversation-export.spec.ts | AC1, AC3, AC4, AC8 | ❌ 待实现 |

---

**输出行（用于 review-story 任务）：**

```
Test design matrix: docs/qa/assessments/3.6-test-design-20250108.md
P0 tests identified: 12
```