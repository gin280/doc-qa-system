# 测试设计: Story 4.4 - AnswerService 单元测试

**日期**: 2025-01-14  
**设计者**: Quinn (测试架构师)  
**Story ID**: 4.4  
**Story标题**: AnswerService 单元测试

---

## 📊 测试策略概览

### 测试分布统计

- **测试场景总数**: 21
- **单元测试**: 21 (100%)
- **集成测试**: 0 (0%) - 由Story 4.10覆盖
- **E2E测试**: 0 (0%) - 由Story 4.10覆盖

### 优先级分布

- **P0**: 18 场景 (86%) - 核心功能和错误处理
- **P1**: 3 场景 (14%) - 边界情况和性能指标

### 覆盖率目标

| 指标 | 目标 | 说明 |
|-----|------|------|
| 行覆盖率 | ≥ 90% | answerService.ts (231行) |
| 分支覆盖率 | ≥ 85% | 所有条件分支 |
| 函数覆盖率 | 100% | generateAnswer及所有私有方法 |

---

## 🎯 测试场景设计

### AC1: 核心方法 generateAnswer 正常流程测试

#### 测试场景

| ID | Level | Priority | 测试场景 | 验证点 | 风险缓解 |
|----|-------|----------|---------|--------|---------|
| 4.4-UNIT-001 | Unit | P0 | 流式生成返回AsyncIterable | 返回类型正确，可以被for await...of遍历 | TECH-003 |
| 4.4-UNIT-002 | Unit | P0 | 问题复杂度评估（simple） | query长度≤50且无复杂关键词 → 'simple' | - |
| 4.4-UNIT-003 | Unit | P0 | 问题复杂度评估（complex） | query长度>50或有复杂关键词 → 'complex' | - |
| 4.4-UNIT-004 | Unit | P0 | 上下文截断到2000 tokens | truncateContext被调用，maxTokens=2000 | - |
| 4.4-UNIT-005 | Unit | P0 | System Prompt构建 | buildSystemPrompt被调用，使用truncated chunks | - |
| 4.4-UNIT-006 | Unit | P0 | 包含对话历史 | includeHistory=true时加载历史并转换格式 | - |
| 4.4-UNIT-007 | Unit | P0 | Messages构建顺序 | 顺序为[system, ...history, user] | - |

**测试级别选择理由**:
- **Unit**: 这些都是纯业务逻辑，不涉及外部系统集成
- **Mock策略**: Mock LLMRepositoryFactory, conversationService, promptBuilder
- **隔离性**: 每个测试独立验证一个功能点

---

### AC2: 流式生成逻辑测试

#### 测试场景

| ID | Level | Priority | 测试场景 | 验证点 | 风险缓解 |
|----|-------|----------|---------|--------|---------|
| 4.4-UNIT-008 | Unit | P0 | 正确yield多个文本chunks | 收集所有chunks，验证内容和顺序 | TECH-003 |
| 4.4-UNIT-009 | Unit | P1 | 统计totalChunks | 验证日志中记录的chunk数量正确 | - |
| 4.4-UNIT-010 | Unit | P1 | 记录firstChunkLatency | 验证首字节延迟时间被记录 | - |
| 4.4-UNIT-011 | Unit | P1 | 记录总elapsed时间 | 验证总耗时被正确计算和记录 | - |

**测试级别选择理由**:
- **Unit**: 流式生成是核心逻辑，使用AsyncGenerator mock
- **P0 vs P1**: 实际功能(P0) vs 性能指标记录(P1)

**实现策略**:
```typescript
// Mock AsyncGenerator
function createMockGenerator(chunks: string[]) {
  return async function* () {
    for (const chunk of chunks) {
      yield chunk
    }
  }
}

// 测试示例
it('应该正确yield多个文本chunks', async () => {
  const expectedChunks = ['Hello', ' ', 'World']
  mockStreamChatCompletion.mockReturnValue(
    createMockGenerator(expectedChunks)
  )
  
  const actualChunks: string[] = []
  for await (const chunk of answerService.generateAnswer(query, retrieval, null)) {
    actualChunks.push(chunk)
  }
  
  expect(actualChunks).toEqual(expectedChunks)
})
```

---

### AC3: 历史截断逻辑测试

#### 测试场景

| ID | Level | Priority | 测试场景 | 验证点 | 风险缓解 |
|----|-------|----------|---------|--------|---------|
| 4.4-UNIT-012 | Unit | P0 | 加载对话历史 | includeHistory=true时调用getConversationHistory(id, 10) | - |
| 4.4-UNIT-013 | Unit | P0 | 转换历史格式 | USER→user, ASSISTANT→assistant | DATA-001 |
| 4.4-UNIT-014 | Unit | P0 | Prompt过长时截断历史 | validatePromptLength返回invalid时，截断一半历史 | - |
| 4.4-UNIT-015 | Unit | P0 | 历史加载失败不中断 | getConversationHistory抛出错误时，继续执行 | - |

**测试级别选择理由**:
- **Unit**: 历史处理是内部逻辑，mock conversationService
- **关键验证**: 格式转换和错误处理

**边界情况**:
- 空历史数组
- 历史加载失败（网络错误、权限问题）
- 超长历史（需要多次截断）

---

### AC4: Prompt构建测试

#### 测试场景

| ID | Level | Priority | 测试场景 | 验证点 | 风险缓解 |
|----|-------|----------|---------|--------|---------|
| 4.4-UNIT-016 | Unit | P0 | 使用truncateContext截断chunks | truncateContext被调用，传入正确参数 | - |
| 4.4-UNIT-017 | Unit | P0 | 使用buildSystemPrompt构建 | buildSystemPrompt被调用，使用truncated chunks | - |
| 4.4-UNIT-018 | Unit | P0 | 构建完整messages数组 | messages = [system, ...history, user] | - |
| 4.4-UNIT-019 | Unit | P0 | 验证Prompt长度 | validatePromptLength被调用，传入system+user+history | - |

**测试级别选择理由**:
- **Unit**: Prompt构建是纯逻辑，mock promptBuilder函数
- **验证方式**: 验证调用参数和顺序，而非实际Prompt内容

---

### AC5: 超时控制测试

#### 测试场景

| ID | Level | Priority | 测试场景 | 验证点 | 风险缓解 |
|----|-------|----------|---------|--------|---------|
| 4.4-UNIT-020 | Unit | P0 | 首字节超时（5秒） | 5秒内无chunk → 抛出GENERATION_TIMEOUT | TECH-002 |
| 4.4-UNIT-021 | Unit | P0 | 总体超时（30秒） | 30秒总时间 → 抛出GENERATION_TIMEOUT | TECH-002 |
| 4.4-UNIT-022 | Unit | P0 | 超时日志记录 | 超时时记录elapsed, threshold, chunksReceived | - |
| 4.4-UNIT-023 | Unit | P0 | 正常情况不超时 | 快速响应时不抛出错误 | - |

**测试级别选择理由**:
- **Unit**: 超时控制是内部逻辑
- **关键技术**: 使用`jest.useFakeTimers()`避免真实等待

**实现策略**:
```typescript
describe('超时控制', () => {
  beforeEach(() => {
    jest.useFakeTimers()
  })
  
  afterEach(() => {
    jest.useRealTimers()
  })
  
  it('应该在首字节超时时抛出错误', async () => {
    // 模拟慢速生成器（6秒才返回第一个chunk）
    async function* slowGenerator() {
      await new Promise(resolve => setTimeout(resolve, 6000))
      yield 'delayed'
    }
    
    mockStreamChatCompletion.mockReturnValue(slowGenerator())
    
    const promise = (async () => {
      for await (const _ of answerService.generateAnswer(query, retrieval, null)) {}
    })()
    
    // 快进时间（不是真实等待）
    jest.advanceTimersByTime(6000)
    
    await expect(promise).rejects.toThrow('GENERATION_TIMEOUT')
  })
})
```

**性能要求**:
- 每个超时测试执行时间 < 1秒
- 不影响CI/CD总时间

---

### AC6: 错误处理测试

#### 测试场景

| ID | Level | Priority | 测试场景 | 验证点 | 风险缓解 |
|----|-------|----------|---------|--------|---------|
| 4.4-UNIT-024 | Unit | P0 | timeout错误转换 | error.message包含'timeout' → GENERATION_TIMEOUT | - |
| 4.4-UNIT-025 | Unit | P0 | quota错误转换 | error.message包含'quota'/'limit' → QUOTA_EXCEEDED | - |
| 4.4-UNIT-026 | Unit | P0 | 其他错误转换 | 其他错误 → GENERATION_ERROR | - |
| 4.4-UNIT-027 | Unit | P0 | 错误日志包含上下文 | console.error包含elapsed时间 | - |

**测试级别选择理由**:
- **Unit**: 错误处理是核心业务逻辑
- **关键验证**: 错误类型映射和日志完整性

**错误场景覆盖**:
```typescript
const errorScenarios = [
  { input: 'Connection timeout', expected: 'GENERATION_TIMEOUT' },
  { input: 'Request timeout', expected: 'GENERATION_TIMEOUT' },
  { input: 'Quota exceeded', expected: 'QUOTA_EXCEEDED' },
  { input: 'Rate limit exceeded', expected: 'QUOTA_EXCEEDED' },
  { input: 'Model not found', expected: 'GENERATION_ERROR' },
  { input: 'Invalid request', expected: 'GENERATION_ERROR' },
]
```

---

### AC7: 边界情况测试

#### 测试场景

| ID | Level | Priority | 测试场景 | 验证点 | 风险缓解 |
|----|-------|----------|---------|--------|---------|
| 4.4-UNIT-028 | Unit | P0 | 处理空历史 | includeHistory=true但conversationId=null → 空历史数组 | DATA-001 |
| 4.4-UNIT-029 | Unit | P0 | 处理非常长的查询 | query长度>1000字符 → 正常处理 | DATA-001 |
| 4.4-UNIT-030 | Unit | P0 | 处理特殊字符 | 中文、Emoji、特殊符号 → 正常处理 | DATA-001 |
| 4.4-UNIT-031 | Unit | P0 | 处理空检索结果 | chunks=[] → 正常生成（使用空上下文） | - |

**测试级别选择理由**:
- **Unit**: 边界情况验证业务逻辑健壮性
- **关键数据**: 使用真实的边界数据

**测试数据清单**:
```typescript
const edgeCaseData = {
  emptyHistory: {
    conversationId: null,
    includeHistory: true,
    expected: [] // 空历史
  },
  longQuery: {
    query: 'x'.repeat(1500),
    expected: 'complex' // 复杂度评估
  },
  specialChars: {
    queries: [
      '🎉💡🚀 AI + ML = ?',
      '「日本語」中文English مرحبا',
      'Query with\nnewlines\tand\ttabs'
    ]
  },
  emptyChunks: {
    chunks: [],
    expected: 'generated answer' // 应该仍能生成
  }
}
```

---

## 🔍 风险覆盖矩阵

### 测试场景 → 风险映射

| 风险ID | 风险描述 | 缓解测试场景 |
|--------|---------|-------------|
| TECH-001 | Mock依赖不稳定 | 所有测试（通过稳定的Mock模式） |
| TECH-002 | 超时测试时间长 | 4.4-UNIT-020, 4.4-UNIT-021（使用fake timers） |
| TECH-003 | AsyncIterable测试复杂 | 4.4-UNIT-001, 4.4-UNIT-008（AsyncGenerator模式） |
| TECH-004 | 覆盖率目标高 | 全部31个场景（系统性覆盖） |
| DATA-001 | 测试数据不真实 | 4.4-UNIT-013, 4.4-UNIT-028-031（真实数据） |

### 覆盖率预期

| 阶段 | 场景完成 | 预期覆盖率 |
|------|---------|-----------|
| Task 2完成 | 场景1-7 | 70%+ |
| Task 3完成 | 场景1-15 | 75%+ |
| Task 4完成 | 场景1-23 | 80%+ |
| Task 5完成 | 场景1-27 | 85%+ |
| Task 6完成 | 场景1-31 | 85%+ |
| Task 7优化 | 全部31场景 | 90%+ |

---

## 🎭 Mock策略设计

### Mock依赖清单

#### 1. LLMRepositoryFactory

```typescript
const mockStreamChatCompletion = jest.fn()

jest.mock('@/infrastructure/llm/llm-repository.factory', () => ({
  LLMRepositoryFactory: {
    create: jest.fn(() => ({
      streamChatCompletion: (...args: any[]) => mockStreamChatCompletion(...args)
    }))
  }
}))
```

**Mock行为**:
- 默认: 返回3个chunks的generator
- 超时测试: 返回延迟generator
- 错误测试: 抛出各种错误

#### 2. conversationService

```typescript
jest.mock('@/services/chat/conversationService', () => ({
  conversationService: {
    getConversationHistory: jest.fn()
  }
}))
```

**Mock行为**:
- 默认: 返回2条历史记录
- 空历史: 返回[]
- 错误: 抛出Error

#### 3. promptBuilder

```typescript
jest.mock('@/services/rag/promptBuilder', () => ({
  buildSystemPrompt: jest.fn((chunks) => `System prompt with ${chunks.length} chunks`),
  truncateContext: jest.fn((chunks, maxTokens) => chunks.slice(0, 5)),
  estimateTokenCount: jest.fn((text) => Math.ceil(text.length / 4)),
  validatePromptLength: jest.fn(() => ({ valid: true, totalTokens: 2500 }))
}))
```

**Mock行为**:
- 提供合理的默认值
- 特定测试中override行为

---

## 📋 测试执行计划

### 推荐执行顺序

**阶段1: 基础功能 (P0核心)**
1. 场景1-7: 正常流程（AC1）
2. 场景8: 流式生成基础功能（AC2）
3. 场景12-15: 历史处理（AC3）

→ **检查点**: 覆盖率应达到70%+

**阶段2: 关键路径 (P0错误处理)**
4. 场景20-23: 超时控制（AC5）
5. 场景24-27: 错误处理（AC6）
6. 场景28-31: 边界情况（AC7）

→ **检查点**: 覆盖率应达到85%+

**阶段3: 性能指标 (P1优化)**
7. 场景9-11: 性能指标记录（AC2）
8. 场景16-19: Prompt构建验证（AC4）

→ **检查点**: 覆盖率应达到90%+

### 持续验证

每完成一个阶段：
```bash
# 运行测试
npm test tests/unit/services/rag/answerService.test.ts

# 检查覆盖率
npm run test:coverage -- tests/unit/services/rag/answerService.test.ts

# 验证无flaky测试（运行10次）
for i in {1..10}; do npm test answerService; done
```

---

## ✅ 质量检查清单

### 测试设计完整性

- [x] 每个AC都有测试覆盖
- [x] 测试级别选择合理（100% unit）
- [x] 优先级分配正确（P0: 86%, P1: 14%）
- [x] 测试场景原子化且独立
- [x] Mock策略清晰可执行
- [x] 风险缓解映射完整

### 测试可执行性

- [x] 测试ID遵循命名规范 `4.4-UNIT-{SEQ}`
- [x] 每个场景验证点明确
- [x] Mock行为可实现
- [x] 执行顺序优化（快速失败）
- [x] 性能要求明确（<30秒总时间）

### 覆盖率可达性

- [x] 覆盖率目标现实（90%/85%/100%）
- [x] 关键路径100%覆盖
- [x] 边界情况全面
- [x] 错误场景完整

---

## 📊 测试场景汇总表

| AC | 场景ID | 级别 | 优先级 | 测试描述 | 风险缓解 |
|----|--------|------|--------|---------|---------|
| AC1 | 4.4-UNIT-001 | Unit | P0 | 流式生成返回AsyncIterable | TECH-003 |
| AC1 | 4.4-UNIT-002 | Unit | P0 | 问题复杂度评估（simple） | - |
| AC1 | 4.4-UNIT-003 | Unit | P0 | 问题复杂度评估（complex） | - |
| AC1 | 4.4-UNIT-004 | Unit | P0 | 上下文截断到2000 tokens | - |
| AC1 | 4.4-UNIT-005 | Unit | P0 | System Prompt构建 | - |
| AC1 | 4.4-UNIT-006 | Unit | P0 | 包含对话历史 | - |
| AC1 | 4.4-UNIT-007 | Unit | P0 | Messages构建顺序 | - |
| AC2 | 4.4-UNIT-008 | Unit | P0 | 正确yield多个文本chunks | TECH-003 |
| AC2 | 4.4-UNIT-009 | Unit | P1 | 统计totalChunks | - |
| AC2 | 4.4-UNIT-010 | Unit | P1 | 记录firstChunkLatency | - |
| AC2 | 4.4-UNIT-011 | Unit | P1 | 记录总elapsed时间 | - |
| AC3 | 4.4-UNIT-012 | Unit | P0 | 加载对话历史 | - |
| AC3 | 4.4-UNIT-013 | Unit | P0 | 转换历史格式 | DATA-001 |
| AC3 | 4.4-UNIT-014 | Unit | P0 | Prompt过长时截断历史 | - |
| AC3 | 4.4-UNIT-015 | Unit | P0 | 历史加载失败不中断 | - |
| AC4 | 4.4-UNIT-016 | Unit | P0 | 使用truncateContext截断chunks | - |
| AC4 | 4.4-UNIT-017 | Unit | P0 | 使用buildSystemPrompt构建 | - |
| AC4 | 4.4-UNIT-018 | Unit | P0 | 构建完整messages数组 | - |
| AC4 | 4.4-UNIT-019 | Unit | P0 | 验证Prompt长度 | - |
| AC5 | 4.4-UNIT-020 | Unit | P0 | 首字节超时（5秒） | TECH-002 |
| AC5 | 4.4-UNIT-021 | Unit | P0 | 总体超时（30秒） | TECH-002 |
| AC5 | 4.4-UNIT-022 | Unit | P0 | 超时日志记录 | - |
| AC5 | 4.4-UNIT-023 | Unit | P0 | 正常情况不超时 | - |
| AC6 | 4.4-UNIT-024 | Unit | P0 | timeout错误转换 | - |
| AC6 | 4.4-UNIT-025 | Unit | P0 | quota错误转换 | - |
| AC6 | 4.4-UNIT-026 | Unit | P0 | 其他错误转换 | - |
| AC6 | 4.4-UNIT-027 | Unit | P0 | 错误日志包含上下文 | - |
| AC7 | 4.4-UNIT-028 | Unit | P0 | 处理空历史 | DATA-001 |
| AC7 | 4.4-UNIT-029 | Unit | P0 | 处理非常长的查询 | DATA-001 |
| AC7 | 4.4-UNIT-030 | Unit | P0 | 处理特殊字符 | DATA-001 |
| AC7 | 4.4-UNIT-031 | Unit | P0 | 处理空检索结果 | - |

**总计**: 31个测试场景
- **P0**: 28场景 (90%)
- **P1**: 3场景 (10%)
- **Unit**: 31场景 (100%)

---

## 🎯 成功标准

### 测试质量指标

- [ ] 所有31个测试场景实现并通过
- [ ] 行覆盖率 ≥ 90%
- [ ] 分支覆盖率 ≥ 85%
- [ ] 函数覆盖率 = 100%
- [ ] 测试套件执行时间 < 30秒
- [ ] 无flaky测试（10次运行全部通过）

### 代码质量指标

- [ ] 所有Mock稳定且可维护
- [ ] 测试代码遵循最佳实践
- [ ] 测试命名清晰描述性
- [ ] 测试数据真实且全面

---

## 📚 参考资源

### 已完成的测试参考

- `tests/unit/services/rag/retrievalService.test.ts` (Story 4.3)
  - Mock策略参考
  - AsyncIterable测试模式
  - 覆盖率优化经验

- `tests/unit/services/rag/queryVectorizer.test.ts`
  - 简单服务测试模式
  - Error handling测试

### 技术文档

- `docs/testing/strategy.md` - 项目测试策略
- `docs/testing/unit-testing.md` - 单元测试指南
- `src/services/rag/answerService.ts` - 被测代码

### 工具和框架

- Jest: 测试框架
- jest.useFakeTimers(): 超时测试
- AsyncGenerator: 流式测试

---

**测试设计负责人**: Quinn (QA/测试架构师)  
**设计日期**: 2025-01-14  
**预计实施**: Sprint 1 - Day 4  
**预计工时**: 6小时

