# 风险评估：故事 3.6 - 对话导出与分享

日期：2025-01-08  
审查人：Quinn（测试架构师）

## 执行摘要

- 识别的总风险数：11
- 关键风险：2（评分 9）
- 高风险：3（评分 6）
- 中风险：4（评分 4）
- 低风险：2（评分 2-3）
- 风险评分：68/100

## 需要立即关注的关键风险

### 1. [SEC-001]: 缺少速率限制

**评分：9（关键）**  
**概率**：高 - API 端点完全没有速率限制  
**影响**：高 - 可能导致滥用、资源耗尽、DoS 攻击  

**缓解措施**：
- 实现基于用户 ID 的速率限制（每分钟最多 5 次导出）
- 批量导出限制为 50 个对话（已实现）
- 返回 429 状态码和清晰的错误消息
- 考虑使用 Redis 进行分布式速率限制

**测试重点**：
- 测试连续多次导出请求
- 验证速率限制响应
- 测试边界条件

### 2. [REL-001]: 错误处理不完整导致用户体验差

**评分：9（关键）**  
**概率**：高 - ExportButton 组件静默失败，无用户反馈  
**影响**：高 - 用户不知道导出失败，导致困惑和不满  

**缓解措施**：
- 在 ExportButton 中添加错误提示（toast）
- 区分不同错误类型并提供具体建议
- 记录所有错误到日志系统
- 添加重试机制

**测试重点**：
- 测试各种错误场景（网络错误、认证失败、服务器错误）
- 验证错误消息的清晰度
- 测试重试功能

## 风险分布

### 按类别

- 安全：2 个风险（1 个关键）
- 可靠性：3 个风险（1 个关键）
- 性能：2 个风险（1 个高）
- 数据：1 个风险（中）
- 业务：2 个风险（1 个高）
- 运维：1 个风险（低）

### 按组件

- API 端点：5 个风险
- 前端组件：3 个风险
- 导出服务：2 个风险
- 测试覆盖：1 个风险

## 详细风险登记册

| 风险 ID | 描述 | 概率 | 影响 | 评分 | 优先级 |
|---------|------|------|------|------|--------|
| SEC-001 | 缺少速率限制 | 高 (3) | 高 (3) | 9 | 关键 |
| REL-001 | 错误处理不完整 | 高 (3) | 高 (3) | 9 | 关键 |
| PERF-001 | 大对话导出性能未优化 | 中 (2) | 高 (3) | 6 | 高 |
| BUS-001 | PDF 功能被移除但 AC 未更新 | 高 (3) | 中 (2) | 6 | 高 |
| TEST-001 | 缺少集成和 E2E 测试 | 高 (3) | 中 (2) | 6 | 高 |
| DATA-001 | 文件名中文编码潜在问题 | 中 (2) | 中 (2) | 4 | 中 |
| SEC-002 | 缺少文件大小限制 | 中 (2) | 中 (2) | 4 | 中 |
| PERF-002 | 批量导出无进度反馈 | 中 (2) | 中 (2) | 4 | 中 |
| REL-002 | 批量导出部分失败处理 | 低 (1) | 高 (3) | 3 | 低 |
| BUS-002 | 缺少批量导出 UI | 中 (2) | 低 (1) | 2 | 低 |
| OPS-001 | 缺少导出监控指标 | 低 (1) | 中 (2) | 2 | 低 |

### SEC-001: 缺少速率限制

**详细描述**：  
两个导出 API 端点（`/api/conversations/[id]/export` 和 `/api/conversations/export-batch`）都没有实现速率限制。恶意用户可以：
- 发起大量导出请求消耗服务器资源
- 进行 DoS 攻击
- 滥用 API 导致正常用户受影响

**受影响组件**：
- `/api/conversations/[id]/export/route.ts`
- `/api/conversations/export-batch/route.ts`

**检测方法**：代码审查发现没有速率限制实现

**残留风险**：实现速率限制后，仍可能面临分布式攻击

**负责人**：dev  
**时间线**：生产部署前必须修复

---

### REL-001: 错误处理不完整导致用户体验差

**详细描述**：  
`ExportButton.tsx` 组件在导出失败时仅在控制台记录错误（第 63-64 行），用户完全不知道发生了什么。这导致：
- 用户认为导出成功，但实际失败
- 用户重复点击导出按钮，加重服务器负担
- 无法区分临时错误和永久错误

```typescript
// 当前实现 - 不好
} catch (error: any) {
  console.error('Export failed:', error)
  // 静默失败，仅在控制台记录
} finally {
  setIsExporting(false)
}
```

**建议改进**：
```typescript
} catch (error: any) {
  console.error('Export failed:', error)
  
  // 根据错误类型显示不同消息
  if (error.message.includes('未授权')) {
    toast.error('认证失败，请重新登录')
  } else if (error.message.includes('对话不存在')) {
    toast.error('对话不存在或已删除')
  } else {
    toast.error('导出失败，请重试', {
      action: {
        label: '重试',
        onClick: handleExport
      }
    })
  }
} finally {
  setIsExporting(false)
}
```

**受影响组件**：
- `src/components/chat/ExportButton.tsx`

**测试需求**：
- 测试网络错误场景
- 测试认证失败场景
- 测试服务器错误场景
- 验证每种错误都有清晰的用户提示

---

### PERF-001: 大对话导出性能未优化

**评分：6（高）**  
**概率**：中 - 存在包含 100+ 消息的长对话  
**影响**：高 - 导出超时、内存溢出、用户体验差

**详细描述**：  
当前实现将所有消息一次性加载到内存并生成导出文件。对于非常长的对话（100+ 消息），可能导致：
- 内存使用过高
- 响应时间过长（>10 秒）
- Serverless 函数超时（Vercel 限制 10 秒）

**缓解措施**：
- 实现流式生成（对于 Markdown）
- 添加对话大小检查，超大对话返回错误
- 考虑异步导出+邮件通知（Phase 2）
- 优化 Markdown 生成算法

**测试重点**：
- 测试包含 10, 50, 100, 200 条消息的对话
- 测量导出时间和内存使用
- 验证是否满足性能目标（< 5 秒）

---

### BUS-001: PDF 功能被移除但 AC 未更新

**评分：6（高）**  
**概率**：高 - 文档清楚显示功能被移除  
**影响**：中 - AC 与实现不一致，可能导致混淆

**详细描述**：  
AC2 明确要求 PDF 导出功能，但实际实现中已移除所有 PDF 相关代码。这导致：
- 验收标准与实现不匹配
- 未来维护者可能困惑
- 产品期望与实际交付不一致

**建议**：
- 更新 AC2，标注 PDF 功能推迟到 Phase 2
- 或者完全移除 AC2
- 在故事文档中明确说明决策原因
- 更新 Epic 文档以反映变化

---

### TEST-001: 缺少集成和 E2E 测试

**评分：6（高）**  
**概率**：高 - 代码审查确认缺失  
**影响**：中 - 可能隐藏集成问题

**详细描述**：  
虽然单元测试覆盖率良好（12/12 通过），但完全缺少：
- API 端点集成测试
- 数据库交互测试
- 认证和授权测试
- 端到端用户流程测试

**缺失的测试场景**：
1. 完整的导出流程（API + 数据库）
2. 权限验证（只能导出自己的对话）
3. 批量导出多个对话
4. 错误场景（不存在的对话、网络错误）

**建议**：
- 添加集成测试到 `tests/integration/api/conversation-export.test.ts`
- 最低要求：测试成功导出、权限验证、错误处理
- 考虑添加基本 E2E 测试验证用户可以点击导出并下载文件

---

### DATA-001: 文件名中文编码潜在问题

**评分：4（中）**  
**概率**：中 - 中文文件名在某些系统可能有问题  
**影响**：中 - 文件无法下载或文件名乱码

**详细描述**：  
导出文件名包含中文字符（如 "对话标题"），在某些操作系统或浏览器中可能出现：
- 文件名乱码
- 文件下载失败
- 文件系统不兼容

**当前缓解**：
- 使用 `encodeURIComponent()` 编码文件名（✅ 已实现）
- UTF-8 编码 Markdown 内容（✅ 已实现）

**建议增强**：
- 提供文件名选项（中文 vs 英文）
- 自动检测浏览器语言设置
- 添加文件名有效性测试

---

### SEC-002: 缺少文件大小限制

**评分：4（中）**  
**概率**：中 - 极长对话可能生成超大文件  
**影响**：中 - 资源耗尽、下载失败

**详细描述**：  
没有限制导出文件的大小。虽然 AC 提到"典型对话 < 5MB"，但代码中没有强制执行。可能导致：
- 生成过大文件（>50MB）
- 下载超时
- 浏览器内存溢出

**建议**：
- 在生成前估算文件大小
- 如果预计超过 10MB，返回错误
- AC8 中添加文件过大错误（413）

---

### PERF-002: 批量导出无进度反馈

**评分：4（中）**  
**概率**：中 - 批量导出 10+ 对话需要时间  
**影响**：中 - 用户不知道进度，可能认为卡住

**详细描述**：  
AC3 要求"显示导出进度（X/Y 已完成）"，但当前实现：
- 批量导出 API 是同步的，无进度更新
- 前端没有进度条组件
- 用户只能看到加载状态

**建议**：
- 对于 <10 个对话，同步处理可接受
- 对于 >10 个对话，考虑：
  - WebSocket 实时进度推送
  - 轮询进度端点
  - 或简单显示"正在导出 X 个对话，请稍候"

---

### REL-002: 批量导出部分失败处理

**评分：3（低）**  
**概率**：低 - 单个对话失败概率低  
**影响**：高 - 用户可能丢失部分数据

**详细描述**：  
`export-batch/route.ts` 在导出单个对话失败时会继续处理其他对话（第 109-112 行）。这是好的设计，但：
- 用户不知道哪些对话导出失败
- 无法重试失败的对话
- 缺少失败摘要

**建议**：
- 在 ZIP 中包含 `export-summary.txt` 文件
- 列出成功和失败的对话
- 返回部分成功的状态码（207 Multi-Status）

---

### BUS-002: 缺少批量导出 UI

**评分：2（低）**  
**概率**：中 - AC4 明确要求但未实现  
**影响**：低 - 功能不完整但不影响核心用例

**详细描述**：  
AC3 和 AC4 要求在对话列表添加：
- 复选框选择对话
- 批量导出按钮
- 格式选择下拉菜单

当前实现：
- ✅ 批量导出 API 已完成
- ❌ 对话列表 UI 未添加批量选择功能
- ❌ 用户无法使用批量导出功能

**建议**：
- 完成 Task 6（修改 `ConversationList.tsx`）
- 创建 `BatchExportPanel.tsx` 组件
- 或标注为 Phase 2 功能

---

### OPS-001: 缺少导出监控指标

**评分：2（低）**  
**概率**：低 - 非功能性问题  
**影响**：中 - 无法监控使用情况和性能

**详细描述**：  
AC10 要求记录导出指标，但当前实现仅有开发环境日志。缺少：
- 生产环境遥测
- 导出成功/失败率
- 导出时间 P95/P99
- 文件大小分布

**建议**：
- 集成分析服务（如 Vercel Analytics）
- 记录关键指标到日志
- 设置告警（高失败率、慢响应）

## 基于风险的测试策略

### 优先级 1：关键风险测试

必须在生产部署前完成：

1. **速率限制测试**
   - 连续 10 次导出请求
   - 验证返回 429 状态码
   - 验证错误消息

2. **错误处理测试**
   - 模拟网络错误
   - 模拟认证失败
   - 模拟服务器错误
   - 验证用户看到清晰的错误提示

### 优先级 2：高风险测试

应在生产部署前完成：

3. **大对话性能测试**
   - 测试 100 条消息的对话
   - 测量导出时间
   - 验证 < 5 秒响应时间

4. **集成测试**
   - API + 数据库完整流程
   - 权限验证
   - 批量导出

### 优先级 3：中/低风险测试

可在生产部署后完成：

5. **文件名编码测试**
   - 不同浏览器测试
   - 不同操作系统测试

6. **批量导出 UI 测试**
   - 功能实现后测试

## 风险验收标准

### 生产部署前必须修复

- 所有评分 ≥ 9 的风险（关键）
- SEC-001（速率限制）
- REL-001（错误处理）

### 可在生产中监控

- 中风险评分 4
- 低风险评分 2-3
- 通过监控和补偿控制管理

### 已接受的风险

- BUS-002（批量导出 UI）- 推迟到 Phase 2
- OPS-001（监控指标）- 可逐步添加

## 监控要求

生产部署后监控：

- 导出成功率（目标：> 99%）
- 导出响应时间（P95 < 5 秒）
- 速率限制触发频率
- 错误类型分布
- 文件大小分布
- 业务 KPI：
  - 最常导出的对话类型
  - 偏好的导出格式（当前仅 Markdown）
  - 用户使用频率

---

**风险审查触发器**

在以下情况下重新审查风险：

- 架构发生重大变化
- 添加新集成
- 发现安全漏洞
- 性能问题报告
- 用户投诉增加