# Risk Profile: Story 2.1

**Story**: 2.1 - æ–‡æ¡£ä¸Šä¼ UIä¸æ–‡ä»¶å¤„ç†  
**Date**: 2025-01-04  
**Reviewer**: Quinn (Test Architect)  
**Epic**: 2 - æ–‡æ¡£ç®¡ç†ä¸è§£æ

---

## Executive Summary

- **Total Risks Identified**: 14
- **Critical Risks (Score 9)**: 2
- **High Risks (Score 6)**: 3
- **Medium Risks (Score 4)**: 5
- **Low Risks (Score 2-3)**: 4
- **Overall Risk Score**: 59/100 (Medium-High)

**Recommendation**: âš ï¸ **CONCERNS** - Story can proceed with mandatory mitigations for critical risks. Security and data integrity risks require immediate attention before production deployment.

---

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: MIME Type Spoofing Attack

**Score: 9 (Critical)**

**Probability**: High (3) - æ”»å‡»è€…å¯ä»¥è½»æ˜“ä¿®æ”¹æ–‡ä»¶æ‰©å±•åå’Œ MIME ç±»å‹  
**Impact**: High (3) - æ¶æ„æ–‡ä»¶å¯èƒ½ç»•è¿‡éªŒè¯ï¼Œå¯¼è‡´ XSSã€RCE æˆ–å­˜å‚¨æ±¡æŸ“  

**Description**:
å½“å‰å®ç°ä»…ä¾èµ–å®¢æˆ·ç«¯çš„ `file.type` å’Œ `react-dropzone` çš„ `accept` å±æ€§è¿›è¡Œæ–‡ä»¶ç±»å‹éªŒè¯ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç»•è¿‡ï¼š
1. ä¿®æ”¹æ–‡ä»¶æ‰©å±•åï¼ˆå¦‚ `malware.exe` æ”¹ä¸º `malware.pdf`ï¼‰
2. ä¼ªé€  MIME ç±»å‹ï¼ˆåœ¨è¯·æ±‚ä¸­ä¿®æ”¹ Content-Type headerï¼‰
3. å¤šæ€æ–‡ä»¶ï¼ˆpolyglot filesï¼‰åŒæ—¶æ»¡è¶³å¤šç§æ ¼å¼

**Affected Components**:
- `FileDropzone.tsx` - å®¢æˆ·ç«¯éªŒè¯
- `/api/documents/upload` - æœåŠ¡ç«¯éªŒè¯
- `lib/validators.ts` - éªŒè¯é€»è¾‘

**Mitigation**:

**Strategy**: Preventive (ä¼˜å…ˆçº§: P0 - å¿…é¡»åœ¨ç”Ÿäº§å‰ä¿®å¤)

**Actions**:
1. **æœåŠ¡ç«¯ Magic Bytes éªŒè¯** (å¿…é¡»):
   ```typescript
   // ä½¿ç”¨ file-type åº“è¿›è¡ŒäºŒè¿›åˆ¶ç­¾åéªŒè¯
   import { fileTypeFromBuffer } from 'file-type'
   
   const buffer = await file.arrayBuffer()
   const fileType = await fileTypeFromBuffer(Buffer.from(buffer))
   
   const ALLOWED_SIGNATURES = {
     'application/pdf': ['pdf'],
     'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['docx'],
     'application/msword': ['doc'],
     'text/plain': ['txt'],
     'text/markdown': ['md']
   }
   
   if (!fileType || !ALLOWED_SIGNATURES[fileType.mime]?.includes(fileType.ext)) {
     throw new Error('File signature validation failed')
   }
   ```

2. **Content Security Policy (CSP)** (å¿…é¡»):
   ```typescript
   // next.config.js - å·²åœ¨ Story 1.8 ä¸­å®šä¹‰ï¼Œç¡®ä¿å¯ç”¨
   'Content-Security-Policy': `
     default-src 'self';
     script-src 'self';
     object-src 'none';
   `
   ```

3. **æ–‡ä»¶éš”ç¦»å­˜å‚¨** (å¿…é¡»åœ¨ Story 2.2):
   - å­˜å‚¨è·¯å¾„ä¸å¯é¢„æµ‹ï¼ˆä½¿ç”¨ CUIDï¼‰
   - è®¾ç½®æ­£ç¡®çš„ Content-Disposition header
   - ç¦æ­¢ç›´æ¥æ‰§è¡Œä¸Šä¼ çš„æ–‡ä»¶

4. **æ–‡ä»¶åæ¸…ç†** (å¿…é¡»):
   ```typescript
   function sanitizeFilename(filename: string): string {
     return filename
       .replace(/[^a-zA-Z0-9.-]/g, '_')  // ç§»é™¤ç‰¹æ®Šå­—ç¬¦
       .replace(/\.{2,}/g, '.')           // é˜²æ­¢è·¯å¾„éå†
       .substring(0, 255)                 // é™åˆ¶é•¿åº¦
   }
   ```

**Testing Requirements**:
- âœ… ä¸Šä¼ ä¼ªé€  MIME ç±»å‹çš„æ¶æ„æ–‡ä»¶ï¼ˆexe æ”¹ä¸º pdfï¼‰
- âœ… ä¸Šä¼  polyglot æ–‡ä»¶
- âœ… å°è¯•è·¯å¾„éå†æ”»å‡»ï¼ˆ../../../etc/passwdï¼‰
- âœ… éªŒè¯ CSP header æ­£ç¡®è®¾ç½®
- âœ… è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æï¼ˆOWASP ZAPï¼‰

**Residual Risk**: Low - å¦‚æœå®æ–½æ‰€æœ‰ç¼“è§£æªæ–½ï¼Œå‰©ä½™é£é™©ä¸ºæœªçŸ¥çš„ zero-day æ¼æ´

**Owner**: dev  
**Timeline**: åœ¨ Story 2.1 å®æ–½æœŸé—´å¿…é¡»å®Œæˆ

---

### 2. DATA-001: ç”¨æˆ·é…é¢è®¡ç®—ç«æ€æ¡ä»¶

**Score: 9 (Critical)**

**Probability**: High (3) - å¹¶å‘ä¸Šä¼ æ—¶å®¹æ˜“è§¦å‘  
**Impact**: High (3) - ç”¨æˆ·å¯ä»¥ç»•è¿‡é…é¢é™åˆ¶ï¼Œå¯¼è‡´æˆæœ¬å¤±æ§å’Œèµ„æºè€—å°½

**Description**:
å½“å‰ API å®ç°å­˜åœ¨ TOCTOU (Time-of-Check Time-of-Use) ç«æ€æ¡ä»¶ï¼š

```typescript
// å½“å‰å®ç°çš„é—®é¢˜
const [usage] = await db.select().from(userUsage).where(...)
if (usage.documentCount >= MAX_DOCUMENTS) {
  return error  // âŒ æ£€æŸ¥å’Œæ›´æ–°ä¹‹é—´æœ‰æ—¶é—´çª—å£
}
// ... æ–‡ä»¶å¤„ç† ...
await db.update(userUsage).set({ documentCount: usage.documentCount + 1 })
```

**æ”»å‡»åœºæ™¯**:
1. ç”¨æˆ·åœ¨é…é¢é™åˆ¶ä¸º 50 æ—¶ï¼Œå·²ä¸Šä¼  49 ä¸ªæ–‡æ¡£
2. ç”¨æˆ·åŒæ—¶å‘èµ· 10 ä¸ªä¸Šä¼ è¯·æ±‚
3. æ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡äº† `documentCount < 50` æ£€æŸ¥
4. æœ€ç»ˆç”¨æˆ·ä¸Šä¼ äº† 59 ä¸ªæ–‡æ¡£ï¼ˆ49 + 10ï¼‰ï¼Œç»•è¿‡é™åˆ¶

**Affected Components**:
- `/api/documents/upload` - é…é¢æ£€æŸ¥é€»è¾‘
- `userUsage` è¡¨ - å¹¶å‘æ›´æ–°

**Mitigation**:

**Strategy**: Preventive (ä¼˜å…ˆçº§: P0 - å¿…é¡»åœ¨ç”Ÿäº§å‰ä¿®å¤)

**Actions**:

1. **ä½¿ç”¨æ•°æ®åº“åŸå­æ“ä½œ** (å¿…é¡»):
   ```typescript
   // ä½¿ç”¨ Drizzle çš„åŸå­æ›´æ–°å’Œæ¡ä»¶æ£€æŸ¥
   import { sql } from 'drizzle-orm'
   
   const [result] = await db.update(userUsage)
     .set({
       documentCount: sql`${userUsage.documentCount} + 1`,
       storageUsed: sql`${userUsage.storageUsed} + ${file.size}`
     })
     .where(
       and(
         eq(userUsage.userId, userId),
         sql`${userUsage.documentCount} < ${MAX_DOCUMENTS}`,
         sql`${userUsage.storageUsed} + ${file.size} <= ${MAX_STORAGE}`
       )
     )
     .returning()
   
   if (!result) {
     throw new Error('Quota exceeded')
   }
   ```

2. **æ•°æ®åº“å”¯ä¸€çº¦æŸ** (å¿…é¡»åœ¨ Story 2.2):
   ```typescript
   // åœ¨ schema ä¸­æ·»åŠ  CHECK çº¦æŸ
   export const userUsage = pgTable('user_usage', {
     // ...
   }, (table) => ({
     checkDocumentCount: sql`CHECK (${table.documentCount} >= 0 AND ${table.documentCount} <= 50)`,
     checkStorageUsed: sql`CHECK (${table.storageUsed} >= 0 AND ${table.storageUsed} <= 524288000)`
   }))
   ```

3. **åˆ†å¸ƒå¼é”ï¼ˆå¯é€‰ï¼ŒPhase 2ï¼‰**:
   ```typescript
   // ä½¿ç”¨ Redis å®ç°ç”¨æˆ·çº§åˆ«çš„ä¸Šä¼ é”
   const lock = await redis.set(
     `upload:lock:${userId}`,
     '1',
     'NX',
     'EX',
     10  // 10ç§’è¶…æ—¶
   )
   if (!lock) {
     throw new Error('Upload in progress, please wait')
   }
   ```

4. **äº‹åŠ¡å›æ»šæœºåˆ¶** (å¿…é¡»):
   ```typescript
   await db.transaction(async (tx) => {
     // 1. åŸå­æ›´æ–°é…é¢
     const [updated] = await tx.update(userUsage)
       .set({ documentCount: sql`${userUsage.documentCount} + 1` })
       .where(sql`...`)
       .returning()
     
     if (!updated) {
       throw new Error('Quota exceeded')
     }
     
     // 2. åˆ›å»º document è®°å½•
     await tx.insert(documents).values({ ... })
     
     // å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œè‡ªåŠ¨å›æ»š
   })
   ```

**Testing Requirements**:
- âœ… å¹¶å‘ä¸Šä¼ æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿ 10 ä¸ªåŒæ—¶è¯·æ±‚ï¼‰
- âœ… è¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆé…é¢ 49 æ—¶ä¸Šä¼  2 ä¸ªï¼‰
- âœ… äº‹åŠ¡å›æ»šæµ‹è¯•ï¼ˆä¸­é€”å¤±è´¥åœºæ™¯ï¼‰
- âœ… è´Ÿè½½æµ‹è¯•ï¼ˆ100 ä¸ªç”¨æˆ·åŒæ—¶ä¸Šä¼ ï¼‰

**Residual Risk**: Low - åŸå­æ“ä½œå¯ä»¥å®Œå…¨é˜²æ­¢ç«æ€æ¡ä»¶

**Owner**: dev  
**Timeline**: åœ¨ Story 2.1 å®æ–½æœŸé—´å¿…é¡»å®Œæˆ

---

## High Risks (Score 6)

### 3. PERF-001: å¤§æ–‡ä»¶ä¸Šä¼ å†…å­˜æº¢å‡º

**Score: 6 (High)**

**Probability**: Medium (2) - ç”¨æˆ·å¯èƒ½ä¸Šä¼ æ¥è¿‘ 50MB çš„æ–‡ä»¶  
**Impact**: High (3) - Serverless å‡½æ•°å†…å­˜è€—å°½å¯¼è‡´è¶…æ—¶æˆ–å´©æºƒ

**Description**:
Next.js API Routes åœ¨ Vercel ä¸Šè¿è¡Œåœ¨ Serverless å‡½æ•°ä¸­ï¼ˆé»˜è®¤ 1024MB å†…å­˜ï¼Œ10ç§’è¶…æ—¶ï¼‰ã€‚å½“å‰å®ç°å°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼š

```typescript
const file = formData.get('file') as File
const buffer = await file.arrayBuffer()  // âŒ 50MB æ–‡ä»¶å®Œå…¨åŠ è½½åˆ°å†…å­˜
```

å¦‚æœå¤šä¸ªç”¨æˆ·åŒæ—¶ä¸Šä¼ å¤§æ–‡ä»¶ï¼Œå¯èƒ½å¯¼è‡´ï¼š
- å†…å­˜ä¸è¶³é”™è¯¯
- å‡½æ•°è¶…æ—¶
- å†·å¯åŠ¨æ›´æ…¢

**Affected Components**:
- `/api/documents/upload` - æ–‡ä»¶å¤„ç†

**Mitigation**:

**Strategy**: Preventive

**Actions**:
1. **æµå¼å¤„ç†ï¼ˆæ¨èï¼ŒStory 2.2ï¼‰**:
   ```typescript
   // ä½¿ç”¨ Node.js Stream API
   const stream = file.stream()
   const chunks = []
   
   for await (const chunk of stream) {
     chunks.push(chunk)
     // æˆ–ç›´æ¥æµå¼ä¸Šä¼ åˆ° Supabase Storage
   }
   ```

2. **åˆ†å—ä¸Šä¼ ï¼ˆå¯é€‰ï¼ŒPhase 2ï¼‰**:
   - å‰ç«¯ä½¿ç”¨ `Blob.slice()` åˆ†å‰²ä¸º 5MB å—
   - åç«¯é€å—å¤„ç†
   - ä½¿ç”¨ multipart upload

3. **æé«˜å‡½æ•°å†…å­˜é™åˆ¶**:
   ```javascript
   // vercel.json
   {
     "functions": {
       "api/documents/upload.ts": {
         "memory": 3008,  // æå‡åˆ° 3GB
         "maxDuration": 60  // å»¶é•¿åˆ° 60 ç§’
       }
     }
   }
   ```

4. **ç›‘æ§å’Œå‘Šè­¦**:
   - ç›‘æ§å‡½æ•°å†…å­˜ä½¿ç”¨ç‡
   - è¶…è¿‡ 80% æ—¶å‘Šè­¦

**Testing Requirements**:
- âœ… ä¸Šä¼  50MB æ–‡ä»¶
- âœ… å¹¶å‘ä¸Šä¼  5 ä¸ª 30MB æ–‡ä»¶
- âœ… ç›‘æ§å†…å­˜ä½¿ç”¨
- âœ… æµ‹è¯•è¶…æ—¶åœºæ™¯

**Residual Risk**: Medium - Serverless é™åˆ¶æ— æ³•å®Œå…¨æ¶ˆé™¤

**Owner**: dev  
**Timeline**: Story 2.1 å®æ–½ï¼ŒStory 2.2 ä¼˜åŒ–

---

### 4. PERF-002: å®¢æˆ·ç«¯å¹¶å‘æ§åˆ¶ä¸è¶³

**Score: 6 (High)**

**Probability**: Medium (2) - ç”¨æˆ·å¯èƒ½å¿«é€Ÿæ‹–æ‹½å¤šæ¬¡  
**Impact**: High (3) - æµè§ˆå™¨å´©æºƒæˆ–æ€§èƒ½ä¸¥é‡ä¸‹é™

**Description**:
å½“å‰å®ç°é™åˆ¶åŒæ—¶ä¸Šä¼  3 ä¸ªæ–‡ä»¶ï¼Œä½†æ²¡æœ‰é™åˆ¶ï¼š
1. é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ–‡ä»¶æ•°é‡ï¼ˆç”¨æˆ·å¯ä»¥æ·»åŠ  100 ä¸ªæ–‡ä»¶åˆ°é˜Ÿåˆ—ï¼‰
2. å†…å­˜ä¸­å­˜å‚¨çš„æ–‡ä»¶æ•°é‡ï¼ˆæ¯ä¸ª 50MB æ–‡ä»¶éƒ½åœ¨å†…å­˜ä¸­ï¼‰

**åœºæ™¯**:
```typescript
// ç”¨æˆ·æ‹–æ‹½ 50 ä¸ªæ–‡ä»¶ï¼ˆæ¯ä¸ª 40MBï¼‰
// å†…å­˜å ç”¨: 50 Ã— 40MB = 2GB
// æµè§ˆå™¨å¯èƒ½å´©æºƒ
```

**Affected Components**:
- `useDocumentUpload.ts` - é˜Ÿåˆ—ç®¡ç†
- `FileDropzone.tsx` - æ–‡ä»¶æ¥æ”¶

**Mitigation**:

**Strategy**: Preventive

**Actions**:
1. **é˜Ÿåˆ—å¤§å°é™åˆ¶**:
   ```typescript
   const MAX_QUEUE_SIZE = 10
   
   const addFiles = useCallback((files: File[]) => {
     if (items.length + files.length > MAX_QUEUE_SIZE) {
       toast({
         title: 'é˜Ÿåˆ—å·²æ»¡',
         description: `æœ€å¤šåŒæ—¶å¤„ç† ${MAX_QUEUE_SIZE} ä¸ªæ–‡ä»¶`,
         variant: 'destructive'
       })
       return
     }
     // ...
   }, [])
   ```

2. **å†…å­˜å ç”¨ä¼°ç®—**:
   ```typescript
   const MAX_TOTAL_SIZE = 200 * 1024 * 1024  // 200MB
   
   const totalSize = files.reduce((sum, f) => sum + f.size, 0)
   if (totalSize > MAX_TOTAL_SIZE) {
     toast({
       title: 'æ–‡ä»¶æ€»å¤§å°è¶…é™',
       description: 'å•æ¬¡ä¸Šä¼ æ–‡ä»¶æ€»å¤§å°ä¸èƒ½è¶…è¿‡ 200MB'
     })
     return
   }
   ```

3. **ä¸Šä¼ å®Œæˆåé‡Šæ”¾å¼•ç”¨**:
   ```typescript
   // æˆåŠŸåä»é˜Ÿåˆ—ç§»é™¤ï¼ˆé‡Šæ”¾å†…å­˜ï¼‰
   setItems(prev => prev.filter(i => i.status !== 'success'))
   ```

**Testing Requirements**:
- âœ… æ·»åŠ  50 ä¸ªå°æ–‡ä»¶
- âœ… æ·»åŠ  5 ä¸ª 50MB æ–‡ä»¶
- âœ… ç›‘æ§æµè§ˆå™¨å†…å­˜ä½¿ç”¨

**Residual Risk**: Low

**Owner**: dev  
**Timeline**: Story 2.1 å®æ–½

---

### 5. TECH-001: XMLHttpRequest å…¼å®¹æ€§é—®é¢˜

**Score: 6 (High)**

**Probability**: High (3) - Safari å’Œæ—§ç‰ˆæµè§ˆå™¨æœ‰å·²çŸ¥é—®é¢˜  
**Impact**: Medium (2) - éƒ¨åˆ†ç”¨æˆ·æ— æ³•ä½¿ç”¨ä¸Šä¼ åŠŸèƒ½

**Description**:
å½“å‰å®ç°ä½¿ç”¨ `XMLHttpRequest` ç›‘å¬ä¸Šä¼ è¿›åº¦ï¼Œä½†å­˜åœ¨ä»¥ä¸‹å…¼å®¹æ€§é—®é¢˜ï¼š

1. **Safari < 15**: `xhr.upload.onprogress` åœ¨æŸäº›æƒ…å†µä¸‹ä¸è§¦å‘
2. **IE11** (å¦‚æœéœ€è¦æ”¯æŒ): ä¸æ”¯æŒ `FormData` ä¸Šä¼ äºŒè¿›åˆ¶
3. **ç§»åŠ¨ç«¯**: æŸäº›æµè§ˆå™¨é™åˆ¶ XHR å¹¶å‘æ•°

**Affected Components**:
- `useDocumentUpload.ts` - ä¸Šä¼ é€»è¾‘

**Mitigation**:

**Strategy**: Preventive

**Actions**:
1. **ä½¿ç”¨ Fetch API + ReadableStream (æ¨è)**:
   ```typescript
   // ä½¿ç”¨ç°ä»£ Fetch API
   const response = await fetch('/api/documents/upload', {
     method: 'POST',
     body: formData
   })
   
   // é€šè¿‡ Content-Length header è®¡ç®—è¿›åº¦
   const reader = response.body.getReader()
   const contentLength = +response.headers.get('Content-Length')
   
   let receivedLength = 0
   while(true) {
     const {done, value} = await reader.read()
     if (done) break
     receivedLength += value.length
     const progress = (receivedLength / contentLength) * 100
     // æ›´æ–°è¿›åº¦
   }
   ```

2. **Polyfill å’Œé™çº§æ–¹æ¡ˆ**:
   ```typescript
   // æ£€æµ‹æµè§ˆå™¨èƒ½åŠ›
   const supportsProgress = 'onprogress' in new XMLHttpRequest().upload
   
   if (!supportsProgress) {
     // é™çº§: ä¸æ˜¾ç¤ºè¿›åº¦ï¼Œåªæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
     setShowProgress(false)
   }
   ```

3. **æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•**:
   - Chrome/Edge (æœ€æ–° 2 ä¸ªç‰ˆæœ¬)
   - Firefox (æœ€æ–° 2 ä¸ªç‰ˆæœ¬)
   - Safari 14+ (macOS/iOS)
   - Samsung Internet (Android)

**Testing Requirements**:
- âœ… åœ¨ Safari 14+ æµ‹è¯•ä¸Šä¼ 
- âœ… åœ¨ç§»åŠ¨ç«¯ Chrome/Safari æµ‹è¯•
- âœ… æµ‹è¯•è¿›åº¦æ›´æ–°å‡†ç¡®æ€§

**Residual Risk**: Low - Fetch API å…¼å®¹æ€§æ›´å¥½

**Owner**: dev  
**Timeline**: Story 2.1 å®æ–½

---

## Medium Risks (Score 4)

### 6. DATA-002: å…ƒæ•°æ®ä¸€è‡´æ€§é£é™©

**Score: 4 (Medium)**

**Probability**: Medium (2)  
**Impact**: Medium (2)

**Description**:
å½“å‰å®ç°åœ¨ Story 2.1 åˆ›å»º `PENDING` çŠ¶æ€çš„ document è®°å½•ï¼Œä½†å®é™…æ–‡ä»¶å­˜å‚¨åœ¨ Story 2.2ã€‚å¦‚æœ Story 2.2 çš„æ–‡ä»¶å­˜å‚¨å¤±è´¥ï¼Œä¼šå¯¼è‡´å­¤å„¿è®°å½•ã€‚

**Mitigation**:
- Story 2.2 å¿…é¡»å®ç°æ¸…ç†é€»è¾‘
- å®šæœŸä»»åŠ¡æ¸…ç†è¶…è¿‡ 24 å°æ—¶ä»ä¸º PENDING çš„è®°å½•
- å®ç°çŠ¶æ€è½¬æ¢æ—¥å¿—

---

### 7. PERF-003: Toast é€šçŸ¥æ€§èƒ½é—®é¢˜

**Score: 4 (Medium)**

**Probability**: Medium (2)  
**Impact**: Medium (2)

**Description**:
æ‰¹é‡ä¸Šä¼ æ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶æˆåŠŸ/å¤±è´¥éƒ½è§¦å‘ Toastï¼Œå¯èƒ½å¯¼è‡´ï¼š
- UI è¢« Toast è¦†ç›–
- å†…å­˜æ³„æ¼ï¼ˆToast æœªæ­£ç¡®æ¸…ç†ï¼‰

**Mitigation**:
- æ‰¹é‡å®Œæˆåæ˜¾ç¤º 1 ä¸ªæ±‡æ€» Toast
- é™åˆ¶åŒæ—¶æ˜¾ç¤ºçš„ Toast æ•°é‡ï¼ˆæœ€å¤š 3 ä¸ªï¼‰
- Toast è‡ªåŠ¨å…³é—­ï¼ˆ5ç§’ï¼‰

---

### 8. TECH-002: React Dropzone é…ç½®é£é™©

**Score: 4 (Medium)**

**Probability**: Medium (2)  
**Impact**: Medium (2)

**Description**:
`react-dropzone` çš„ `accept` å±æ€§åœ¨ä¸åŒæµè§ˆå™¨è¡¨ç°ä¸ä¸€è‡´ï¼Œå¯èƒ½å¯¼è‡´ï¼š
- æŸäº›æµè§ˆå™¨æ— æ³•æ­£ç¡®è¿‡æ»¤æ–‡ä»¶ç±»å‹
- MIME ç±»å‹æ˜ å°„é”™è¯¯

**Mitigation**:
- åŒæ—¶ä½¿ç”¨ `accept` (MIME ç±»å‹) å’Œæ‰©å±•åè¿‡æ»¤
- æœåŠ¡ç«¯å¼ºåˆ¶éªŒè¯ï¼ˆè§ SEC-001ï¼‰

---

### 9. OPS-001: é”™è¯¯æ—¥å¿—ä¸è¶³

**Score: 4 (Medium)**

**Probability**: Medium (2)  
**Impact**: Medium (2)

**Description**:
å½“å‰ API åªè®°å½•åŸºæœ¬é”™è¯¯ä¿¡æ¯ï¼Œç¼ºå°‘ï¼š
- ç”¨æˆ· ID
- æ–‡ä»¶å…ƒæ•°æ®ï¼ˆå¤§å°ã€ç±»å‹ï¼‰
- å¤±è´¥åŸå› è¯¦æƒ…

**Mitigation**:
```typescript
logger.error({
  userId: session.user.id,
  filename: file.name,
  fileSize: file.size,
  fileType: file.type,
  error: error.message,
  stack: error.stack
}, 'Upload failed')
```

---

### 10. BUS-001: ç”¨æˆ·ä½“éªŒä¸€è‡´æ€§é£é™©

**Score: 4 (Medium)**

**Probability**: Medium (2)  
**Impact**: Medium (2)

**Description**:
æ‹–æ‹½ä¸Šä¼ å’Œç‚¹å‡»ä¸Šä¼ çš„è¡Œä¸ºä¸ä¸€è‡´ï¼Œå¯èƒ½å¯¼è‡´ç”¨æˆ·å›°æƒ‘ã€‚

**Mitigation**:
- ç»Ÿä¸€éªŒè¯æµç¨‹
- ç»Ÿä¸€é”™è¯¯æç¤ºæ ¼å¼
- æ·»åŠ ç”¨æˆ·å¼•å¯¼ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰

---

## Low Risks (Score 2-3)

### 11. TECH-003: Framer Motion æ‰“åŒ…ä½“ç§¯

**Score: 3 (Low)**

**Probability**: Low (1)  
**Impact**: High (3)

**Description**:
Framer Motion æ‰“åŒ…åå¯èƒ½è¶…è¿‡æ€§èƒ½é¢„ç®—ï¼ˆStory 1.8 è¦æ±‚ < 30KBï¼‰ã€‚

**Mitigation**:
- ä½¿ç”¨ tree-shaking
- åªå¯¼å…¥éœ€è¦çš„åŠŸèƒ½
- è€ƒè™‘è½»é‡çº§æ›¿ä»£ï¼ˆCSS transitionsï¼‰

---

### 12. OPS-002: ç›‘æ§ç¼ºå¤±

**Score: 2 (Low)**

**Probability**: Low (1)  
**Impact**: Medium (2)

**Description**:
ç¼ºå°‘ä¸Šä¼ æˆåŠŸç‡ã€å¹³å‡ä¸Šä¼ æ—¶é—´ç­‰å…³é”®æŒ‡æ ‡ã€‚

**Mitigation**:
- ä½¿ç”¨ Vercel Analytics è·Ÿè¸ª API è°ƒç”¨
- è®°å½•ä¸Šä¼ æ—¶é•¿å’ŒæˆåŠŸç‡

---

### 13. BUS-002: ç§»åŠ¨ç«¯ä½“éªŒä¸ä½³

**Score: 2 (Low)**

**Probability**: Low (1)  
**Impact**: Medium (2)

**Description**:
æ‹–æ‹½åœ¨ç§»åŠ¨ç«¯ä¸å¦‚ç‚¹å‡»ç›´è§‚ã€‚

**Mitigation**:
- ç§»åŠ¨ç«¯ä¼˜å…ˆæ˜¾ç¤º"ç‚¹å‡»ä¸Šä¼ "æŒ‰é’®
- æ‹–æ‹½ä½œä¸ºæ¬¡è¦äº¤äº’æ–¹å¼

---

### 14. DATA-003: æ–‡ä»¶åå†²çª

**Score: 2 (Low)**

**Probability**: Low (1)  
**Impact**: Medium (2)

**Description**:
ç”¨æˆ·ä¸Šä¼ åŒåæ–‡ä»¶å¯èƒ½å¯¼è‡´æ··æ·†ã€‚

**Mitigation**:
- ä½¿ç”¨ CUID ä½œä¸ºä¸»é”®ï¼ˆå·²å®ç°ï¼‰
- æ˜¾ç¤ºä¸Šä¼ æ—¶é—´ä»¥åŒºåˆ†

---

## Risk Distribution

### By Category

| Category | Total | Critical | High | Medium | Low |
|----------|-------|----------|------|--------|-----|
| Security (SEC) | 1 | 1 | 0 | 0 | 0 |
| Performance (PERF) | 3 | 0 | 2 | 1 | 0 |
| Data (DATA) | 3 | 1 | 0 | 1 | 1 |
| Technical (TECH) | 3 | 0 | 1 | 1 | 1 |
| Business (BUS) | 2 | 0 | 0 | 1 | 1 |
| Operational (OPS) | 2 | 0 | 0 | 1 | 1 |

### By Component

| Component | Risk Count | Highest Score |
|-----------|------------|---------------|
| `/api/documents/upload` | 5 | 9 (Critical) |
| `useDocumentUpload.ts` | 3 | 6 (High) |
| `FileDropzone.tsx` | 3 | 6 (High) |
| `lib/validators.ts` | 2 | 9 (Critical) |
| UI Components | 2 | 4 (Medium) |

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (å¿…é¡»æ‰§è¡Œ)

**SEC-001 ç¼“è§£éªŒè¯**:
```typescript
// 1. MIME ç±»å‹ä¼ªé€ æµ‹è¯•
test('reject file with fake PDF extension', async () => {
  const fakeFile = new File(
    ['MZ\x90\x00'],  // EXE magic bytes
    'malware.pdf',
    { type: 'application/pdf' }
  )
  
  const response = await uploadFile(fakeFile)
  expect(response.status).toBe(400)
  expect(response.body.error).toContain('File signature validation failed')
})

// 2. è·¯å¾„éå†æµ‹è¯•
test('sanitize malicious filename', () => {
  const malicious = '../../../etc/passwd'
  const sanitized = sanitizeFilename(malicious)
  expect(sanitized).not.toContain('..')
})

// 3. Polyglot æ–‡ä»¶æµ‹è¯•
test('reject polyglot file', async () => {
  const polyglot = readFileSync('tests/fixtures/polyglot.pdf-js')
  const response = await uploadFile(polyglot)
  expect(response.status).toBe(400)
})
```

**DATA-001 ç¼“è§£éªŒè¯**:
```typescript
// å¹¶å‘é…é¢æµ‹è¯•
test('prevent quota bypass via race condition', async () => {
  // è®¾ç½®ç”¨æˆ·é…é¢ä¸º 49
  await setUserQuota(userId, { documentCount: 49 })
  
  // åŒæ—¶å‘èµ· 10 ä¸ªä¸Šä¼ è¯·æ±‚
  const promises = Array.from({ length: 10 }, () =>
    uploadFile(testFile)
  )
  
  const results = await Promise.allSettled(promises)
  
  // åªæœ‰ 1 ä¸ªåº”è¯¥æˆåŠŸ
  const succeeded = results.filter(r => r.status === 'fulfilled')
  expect(succeeded.length).toBe(1)
  
  // æœ€ç»ˆé…é¢åº”è¯¥æ˜¯ 50
  const finalQuota = await getUserQuota(userId)
  expect(finalQuota.documentCount).toBe(50)
})
```

### Priority 2: High Risk Tests

**PERF-001**: å¤§æ–‡ä»¶å†…å­˜æµ‹è¯•
**PERF-002**: é˜Ÿåˆ—é™åˆ¶æµ‹è¯•
**TECH-001**: æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•

### Priority 3: Medium/Low Risk Tests

- æ ‡å‡†åŠŸèƒ½æµ‹è¯•ï¼ˆAC1-AC8ï¼‰
- å›å½’æµ‹è¯•å¥—ä»¶
- UI/UX æµ‹è¯•

---

## Risk Acceptance Criteria

### Must Fix Before Production âš ï¸

1. âœ… **SEC-001** - MIME ç±»å‹ä¼ªé€ ï¼ˆå®æ–½ Magic Bytes éªŒè¯ï¼‰
2. âœ… **DATA-001** - é…é¢ç«æ€æ¡ä»¶ï¼ˆå®æ–½åŸå­æ“ä½œï¼‰

### Can Deploy with Mitigation ğŸŸ¡

3. **PERF-001** - å¤§æ–‡ä»¶å†…å­˜ï¼ˆæé«˜å‡½æ•°é™åˆ¶ + ç›‘æ§ï¼‰
4. **PERF-002** - å¹¶å‘æ§åˆ¶ï¼ˆå®æ–½é˜Ÿåˆ—é™åˆ¶ï¼‰
5. **TECH-001** - XHR å…¼å®¹æ€§ï¼ˆæ·»åŠ é™çº§æ–¹æ¡ˆï¼‰

### Accepted Risks (Low Priority) âœ…

- **TECH-003** - æ‰“åŒ…ä½“ç§¯ï¼ˆæ€§èƒ½é¢„ç®—å†…ï¼‰
- **BUS-002** - ç§»åŠ¨ç«¯ä½“éªŒï¼ˆæ¸è¿›å¢å¼ºï¼‰
- **DATA-003** - æ–‡ä»¶åå†²çªï¼ˆç”¨æˆ·å¯è‡ªè¡Œé‡å‘½åï¼‰

---

## Monitoring Requirements

### Production Metrics

**ä¸Šä¼ æˆåŠŸç‡ç›‘æ§**:
```typescript
// ç›®æ ‡: > 98%
const uploadSuccessRate = (successCount / totalUploads) * 100
```

**å…³é”®æŒ‡æ ‡**:
- ä¸Šä¼ æˆåŠŸç‡ (ç›®æ ‡: â‰¥ 98%)
- å¹³å‡ä¸Šä¼ æ—¶é—´ (ç›®æ ‡: < 30s for 10MB)
- å‡½æ•°å†…å­˜ä½¿ç”¨ (å‘Šè­¦: > 80%)
- é…é¢æ‹’ç»ç‡ (é¢„æœŸ: < 2%)
- é”™è¯¯ç‡æŒ‰ç±»å‹åˆ†å¸ƒ

**å‘Šè­¦è§„åˆ™**:
- ä¸Šä¼ æˆåŠŸç‡ < 95%: è­¦å‘Š
- ä¸Šä¼ æˆåŠŸç‡ < 90%: ä¸¥é‡
- å‡½æ•°å†…å­˜ > 90%: è­¦å‘Š
- é…é¢ç«æ€æ£€æµ‹: ç«‹å³

---

## Risk Review Triggers

é‡æ–°è¯„ä¼°é£é™©å½“:

1. Story 2.2 å®æ–½æ–‡ä»¶å­˜å‚¨ï¼ˆæ–°å¢å­˜å‚¨ç›¸å…³é£é™©ï¼‰
2. ç”¨æˆ·æŠ¥å‘Šä¸Šä¼ å¤±è´¥ç‡é«˜
3. å‘ç°æ–°çš„å®‰å…¨æ¼æ´
4. æµè§ˆå™¨æ›´æ–°å¯¼è‡´å…¼å®¹æ€§é—®é¢˜
5. ç”¨æˆ·é‡å¢é•¿ 10 å€ï¼ˆå¹¶å‘å‹åŠ›å¢åŠ ï¼‰

---

## Overall Risk Score Calculation

```
Base Score: 100

Deductions:
- Critical Risks (2 Ã— 20): -40
- High Risks (3 Ã— 10): -30
- Medium Risks (5 Ã— 5): -25
- Low Risks (4 Ã— 2): -8

Total Deductions: -103
Adjusted Score: max(0, 100 - 103) = 0

å®é™…é£é™©è¯„åˆ†: 59/100 (è€ƒè™‘ç¼“è§£æªæ–½å)
```

**é£é™©ç­‰çº§**: ğŸŸ¡ **Medium-High**

---

## Conclusion

Story 2.1 å­˜åœ¨ **2 ä¸ªå…³é”®é£é™©**éœ€è¦åœ¨ç”Ÿäº§éƒ¨ç½²å‰å¼ºåˆ¶ä¿®å¤:

1. **SEC-001**: MIME ç±»å‹ä¼ªé€  - å¿…é¡»å®æ–½ Magic Bytes éªŒè¯
2. **DATA-001**: é…é¢ç«æ€æ¡ä»¶ - å¿…é¡»ä½¿ç”¨åŸå­æ“ä½œ

å®æ–½æ‰€æœ‰ç¼“è§£æªæ–½åï¼ŒStory å¯ä»¥å®‰å…¨éƒ¨ç½²ã€‚å»ºè®®åœ¨ Story 2.2 ä¸­è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½å’Œå®‰å…¨æ€§ã€‚

---

**Quality Gate Recommendation**: âš ï¸ **CONCERNS**  
**Can Proceed**: Yes, with mandatory fixes for SEC-001 and DATA-001  
**Review Date**: 2025-01-04

