# Story 4.1 - é€Ÿç‡é™åˆ¶é…ç½®æŒ‡å—

**çŠ¶æ€**ï¼šâš ï¸ **éœ€è¦æ‰‹åŠ¨é…ç½®**  
**é—®é¢˜**ï¼šCONFIG-001 - Upstash Redis ç¯å¢ƒå˜é‡æœªé…ç½®  
**å½±å“**ï¼šé€Ÿç‡é™åˆ¶åŠŸèƒ½å®Œå…¨å¤±æ•ˆï¼ˆé™çº§æ¨¡å¼ï¼‰

---

## å¿«é€Ÿé…ç½®ï¼ˆ5-10åˆ†é’Ÿï¼‰

### æ­¥éª¤ 1ï¼šåˆ›å»º Upstash Redis æ•°æ®åº“

1. è®¿é—® [Upstash Console](https://console.upstash.com/)
2. æ³¨å†Œ/ç™»å½•ï¼ˆå…è´¹å±‚è¶³å¤Ÿï¼‰
3. ç‚¹å‡» **"Create Database"**
4. é…ç½®ï¼š
   - **Name**: `doc-qa-ratelimit`
   - **Region**: é€‰æ‹©æœ€è¿‘çš„åŒºåŸŸï¼ˆå¦‚ï¼šap-southeast-1ï¼‰
   - **Type**: Regional
   - **TLS**: âœ… Enable
5. ç‚¹å‡» **"Create"**

### æ­¥éª¤ 2ï¼šè·å– REST API å‡­è¯

1. åœ¨æ•°æ®åº“è¯¦æƒ…é¡µï¼Œåˆ‡æ¢åˆ° **"REST API"** æ ‡ç­¾
2. å¤åˆ¶ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **UPSTASH_REDIS_REST_URL**ï¼ˆä¾‹å¦‚ï¼š`https://xxxxx.upstash.io`ï¼‰
   - **UPSTASH_REDIS_REST_TOKEN**ï¼ˆé•¿å­—ç¬¦ä¸²ä»¤ç‰Œï¼‰

### æ­¥éª¤ 3ï¼šé…ç½®æœ¬åœ°ç¯å¢ƒ

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env.local` æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼š

```bash
# Upstash Redis for Rate Limiting (Story 4.1)
UPSTASH_REDIS_REST_URL="https://your-redis-url.upstash.io"
UPSTASH_REDIS_REST_TOKEN="your-redis-token-here"
```

**æ›¿æ¢**ä¸ºä½ å®é™…çš„å‡­è¯ï¼

### æ­¥éª¤ 4ï¼šéªŒè¯é…ç½®

#### æ–¹æ³• Aï¼šä½¿ç”¨éªŒè¯è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
npm run verify:redis
```

**æœŸæœ›è¾“å‡º**ï¼š
```
âœ… é…ç½®éªŒè¯é€šè¿‡ï¼
```

**å¦‚æœå¤±è´¥**ï¼Œè„šæœ¬ä¼šæç¤ºå…·ä½“é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚

#### æ–¹æ³• Bï¼šæ‰‹åŠ¨éªŒè¯

1. å¯åŠ¨åº”ç”¨ï¼š
   ```bash
   npm run dev
   ```

2. æ£€æŸ¥æ§åˆ¶å°ï¼š
   - âœ… **æˆåŠŸ**ï¼šæ—  Redis é”™è¯¯æˆ–è­¦å‘Š
   - âŒ **å¤±è´¥**ï¼šçœ‹åˆ° "Upstash Redis requires a url and token"

### æ­¥éª¤ 5ï¼šåŠŸèƒ½æµ‹è¯•

æŒ‰ç…§ [æ‰‹åŠ¨æµ‹è¯•æŒ‡å—](../tests/manual/test-rate-limit-manual.md) éªŒè¯é€Ÿç‡é™åˆ¶åŠŸèƒ½ã€‚

**å¿«é€Ÿæµ‹è¯•**ï¼š
1. ç™»å½•åº”ç”¨
2. è¿ç»­ä¸Šä¼  11 ä¸ªæ–‡æ¡£
3. ç¬¬ 11 æ¬¡åº”è¯¥è¿”å› **429 Too Many Requests**

---

## ç”Ÿäº§ç¯å¢ƒé…ç½®

### Vercel éƒ¨ç½²

1. è¿›å…¥ Vercel é¡¹ç›®è®¾ç½®
2. **"Settings" â†’ "Environment Variables"**
3. æ·»åŠ å˜é‡ï¼š
   - `UPSTASH_REDIS_REST_URL` = `https://your-redis-url.upstash.io`
   - `UPSTASH_REDIS_REST_TOKEN` = `your-redis-token-here`
   - Environments: âœ… Production, âœ… Preview
4. é‡æ–°éƒ¨ç½²

### å…¶ä»–å¹³å°

- **Docker**: åœ¨ `docker-compose.yml` æˆ–ç¯å¢ƒå˜é‡ä¸­æ·»åŠ 
- **AWS/Azure/GCP**: åœ¨ç¯å¢ƒé…ç½®ä¸­æ·»åŠ 
- **Kubernetes**: ConfigMap æˆ– Secret

---

## é…ç½®éªŒè¯æ¸…å•

åœ¨æ ‡è®° Story 4.1 ä¸º Done ä¹‹å‰ï¼Œç¡®è®¤ï¼š

- [ ] âœ… Upstash Redis æ•°æ®åº“å·²åˆ›å»º
- [ ] âœ… REST API å‡­è¯å·²å¤åˆ¶åˆ° `.env.local`
- [ ] âœ… è¿è¡Œ `npm run verify:redis` æˆåŠŸ
- [ ] âœ… åº”ç”¨å¯åŠ¨æ—  Redis è­¦å‘Š
- [ ] âœ… è¿ç»­ä¸Šä¼ æµ‹è¯•ï¼Œç¬¬ 11 æ¬¡è¿”å› 429
- [ ] âœ… å“åº”åŒ…å«æ­£ç¡®çš„é”™è¯¯æ¶ˆæ¯å’Œå¤´éƒ¨
- [ ] âœ… æ—¥å¿—è®°å½•è¶…é™äº‹ä»¶
- [ ] âœ… ï¼ˆå¯é€‰ï¼‰ç”Ÿäº§ç¯å¢ƒå˜é‡å·²é…ç½®

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šéªŒè¯è„šæœ¬è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼š`npm run verify:redis` æŠ¥é”™ "è¿æ¥å¤±è´¥"

**è§£å†³**ï¼š
1. æ£€æŸ¥å‡­è¯æ˜¯å¦æ­£ç¡®ï¼ˆé‡æ–°å¤åˆ¶ï¼‰
2. ç¡®è®¤æ•°æ®åº“çŠ¶æ€æ­£å¸¸ï¼ˆUpstash Consoleï¼‰
3. æ£€æŸ¥ç½‘ç»œè¿æ¥
4. å°è¯•ä½¿ç”¨æ›´è¿‘çš„ Redis åŒºåŸŸ

### é—®é¢˜ï¼šé€Ÿç‡é™åˆ¶ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šè¿ç»­ä¸Šä¼  11 æ¬¡éƒ½æˆåŠŸ

**è¯Šæ–­**ï¼š
1. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰ `rateLimitDegradation` äº‹ä»¶
2. è¿è¡Œ `npm run verify:redis` éªŒè¯é…ç½®
3. ç¡®è®¤ Redis æ•°æ®åº“æœªè¢«åˆ é™¤

### é—®é¢˜ï¼šé¢‘ç¹é™çº§è­¦å‘Š

**ç—‡çŠ¶**ï¼šæ—¥å¿—ä¸­é¢‘ç¹å‡ºç° `alert: 'rateLimitDegradation'`

**åŸå› **ï¼š
- Redis å‡­è¯é”™è¯¯
- Redis æ•°æ®åº“åŒºåŸŸå¤ªè¿œï¼ˆé«˜å»¶è¿Ÿï¼‰
- ç½‘ç»œä¸ç¨³å®š

**è§£å†³**ï¼š
- éªŒè¯å‡­è¯æ­£ç¡®
- è€ƒè™‘ä½¿ç”¨æ›´è¿‘çš„åŒºåŸŸ
- æ£€æŸ¥ç½‘ç»œè¿æ¥è´¨é‡

---

## ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†é…ç½®æŒ‡å—**ï¼š[docs/deployment/upstash-redis-setup.md](./deployment/upstash-redis-setup.md)
- **æ‰‹åŠ¨æµ‹è¯•æŒ‡å—**ï¼š[tests/manual/test-rate-limit-manual.md](../tests/manual/test-rate-limit-manual.md)
- **Story è¯¦æƒ…**ï¼š[docs/stories/4.1-upload-rate-limit.md](./stories/4.1-upload-rate-limit.md)
- **QA Gate**ï¼š[docs/qa/gates/4.1-upload-rate-limit.yml](./qa/gates/4.1-upload-rate-limit.yml)

---

## æˆæœ¬ä¼°ç®—

**Upstash Free Tier**ï¼š
- 10,000 å‘½ä»¤/å¤©
- 256 MB å­˜å‚¨
- é€‚åˆå°å‹é¡¹ç›®å’Œå¼€å‘

**ä¼°ç®—**ï¼šæ¯æ¬¡ä¸Šä¼ æ£€æŸ¥ = 1 ä¸ª Redis å‘½ä»¤
- 100 ç”¨æˆ· Ã— 100 ä¸Šä¼ /å¤© = 10,000 å‘½ä»¤/å¤© âœ… å…è´¹å±‚è¶³å¤Ÿ
- è¶…å‡ºåï¼š$0.2/100K å‘½ä»¤

---

## ä¸‹ä¸€æ­¥

é…ç½®å®Œæˆå¹¶éªŒè¯é€šè¿‡åï¼š

1. âœ… å®ŒæˆåŠŸèƒ½æµ‹è¯•
2. ğŸ“ å¡«å†™æµ‹è¯•æŠ¥å‘Š
3. ğŸ¯ é€šçŸ¥ QA é…ç½®å·²å®Œæˆ
4. âœ… æ›´æ–° Story çŠ¶æ€ä¸º **Done**

---

**é…ç½®å¸®åŠ©**ï¼šå¦‚æœ‰é—®é¢˜ï¼Œå‚è€ƒ [Upstash æ–‡æ¡£](https://docs.upstash.com/redis) æˆ–è”ç³»å›¢é˜Ÿã€‚

