# Story 1.5: OAuth第三方登录

**Story ID**: 1.5  
**Epic**: 1 - 基础设施与用户认证  
**优先级**: P1 (MVP重要)  
**预估工时**: 2天  
**状态**: Draft

---

## User Story

作为**新用户或已注册用户**,  
我想要**使用 Google 或 GitHub 账号快速登录系统**,  
以便**无需记住密码即可访问我的工作区和使用文档问答功能**。

---

## 验收标准

### AC1: NextAuth.js OAuth Provider 配置

- [ ] 安装必要的 OAuth 依赖包
- [ ] 在 NextAuth 配置中添加 GoogleProvider
- [ ] 在 NextAuth 配置中添加 GitHubProvider
- [ ] 配置 OAuth 回调 URL (`/api/auth/callback/{provider}`)
- [ ] 配置环境变量（Client ID 和 Secret）
- [ ] 验证 OAuth 配置在本地开发环境正常工作

### AC2: Google OAuth 集成

- [ ] 在 Google Cloud Console 创建 OAuth 2.0 应用
- [ ] 配置授权重定向 URI
- [ ] 获取 Google Client ID 和 Client Secret
- [ ] 在登录/注册页面添加"使用 Google 登录"按钮
- [ ] 实现 Google OAuth 授权流程
- [ ] 成功登录后重定向到 Dashboard

### AC3: GitHub OAuth 集成

- [ ] 在 GitHub Developer Settings 创建 OAuth App
- [ ] 配置 Authorization callback URL
- [ ] 获取 GitHub Client ID 和 Client Secret
- [ ] 在登录/注册页面添加"使用 GitHub 登录"按钮
- [ ] 实现 GitHub OAuth 授权流程
- [ ] 成功登录后重定向到 Dashboard

### AC4: OAuth 用户自动创建与关联

- [ ] 实现 `signIn` 回调处理 OAuth 用户
- [ ] 首次 OAuth 登录自动创建用户记录
- [ ] 设置 `authProvider` 字段为 'GOOGLE' 或 'GITHUB'
- [ ] OAuth 用户不设置 `passwordHash`（允许为 null）
- [ ] 提取并存储 OAuth 用户信息（email, name, avatarUrl）
- [ ] 相同邮箱的用户可以使用不同登录方式（邮箱密码 + OAuth）

### AC5: UI/UX 实现

- [ ] 在登录页添加 OAuth 按钮组（在表单下方）
- [ ] 添加"OR"分隔线
- [ ] Google 按钮样式：白底、Google 彩色图标、"使用 Google 登录"文字
- [ ] GitHub 按钮样式：深色底、GitHub 白色图标、"使用 GitHub 登录"文字
- [ ] 按钮悬停效果和加载状态
- [ ] 在注册页也添加相同的 OAuth 按钮组

### AC6: 头像存储与显示

- [ ] 从 Google/GitHub 获取用户头像 URL
- [ ] 存储头像 URL 到 `users.avatarUrl` 字段
- [ ] Dashboard 导航栏显示用户头像
- [ ] 如果头像 URL 无效，显示默认头像（用户名首字母）

### AC7: 错误处理与安全

- [ ] OAuth 授权失败时显示友好错误提示
- [ ] 用户取消授权时返回登录页并提示
- [ ] 验证 OAuth state 参数防止 CSRF 攻击（NextAuth 内置）
- [ ] 验证 OAuth 返回的 email 是否已被其他 authProvider 注册
- [ ] 限制 OAuth 回调 URL 只接受已配置的 provider

---

## Dev Technical Guidance

### 前置条件

**Story 1.4 已完成**:
- NextAuth.js v5 已安装和配置
- 认证 API 路由 `/api/auth/[...nextauth]/route.ts` 已存在
- Credentials Provider（邮箱密码登录）已实现
- Session 和 JWT 策略已配置

### 数据模型

**使用现有 Schema** [Source: drizzle/schema.ts]

```typescript
// 已存在的 users 表定义
export const authProviderEnum = pgEnum('auth_provider', ['EMAIL', 'GOOGLE', 'GITHUB'])

export const users = pgTable('users', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  email: text('email').notNull().unique(),
  passwordHash: text('password_hash'),  // OAuth 用户为 null
  name: text('name').notNull(),
  avatarUrl: text('avatar_url'),  // 存储 OAuth 头像 URL
  authProvider: authProviderEnum('auth_provider').default('EMAIL').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull()
})
```

**关键字段说明**:
- `passwordHash`: OAuth 用户此字段为 `null`（无密码）
- `avatarUrl`: 存储 Google/GitHub 返回的头像 URL
- `authProvider`: 标识用户注册方式（EMAIL, GOOGLE, GITHUB）

### NextAuth.js OAuth 配置

**文件位置**: `src/app/api/auth/[...nextauth]/route.ts`  
[Source: docs/architecture.md#authentication-flow]

**完整配置示例**:

```typescript
import NextAuth from 'next-auth'
import type { NextAuthConfig } from 'next-auth'
import GoogleProvider from 'next-auth/providers/google'
import GitHubProvider from 'next-auth/providers/github'
import CredentialsProvider from 'next-auth/providers/credentials'
import { db } from '@/lib/db'
import { users } from '@/../drizzle/schema'
import { eq } from 'drizzle-orm'
import bcrypt from 'bcrypt'

export const authOptions: NextAuthConfig = {
  providers: [
    // 现有的 Credentials Provider（Story 1.4）
    CredentialsProvider({
      name: 'credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials) {
        // ... 现有的邮箱密码验证逻辑 ...
      }
    }),
    
    // 新增: Google OAuth Provider
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      authorization: {
        params: {
          prompt: "consent",
          access_type: "offline",
          response_type: "code"
        }
      }
    }),
    
    // 新增: GitHub OAuth Provider
    GitHubProvider({
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    }),
  ],
  
  callbacks: {
    // 新增: signIn 回调处理 OAuth 用户
    async signIn({ user, account, profile }) {
      if (account?.provider === 'google' || account?.provider === 'github') {
        try {
          // 检查用户是否已存在
          const existingUser = await db.query.users.findFirst({
            where: eq(users.email, user.email!)
          })
          
          if (!existingUser) {
            // 首次 OAuth 登录，创建新用户
            await db.insert(users).values({
              email: user.email!,
              name: user.name || user.email!.split('@')[0],
              avatarUrl: user.image,
              authProvider: account.provider.toUpperCase() as 'GOOGLE' | 'GITHUB',
              passwordHash: null, // OAuth 用户无密码
            })
          } else {
            // 用户已存在，更新头像（如果有变化）
            if (user.image && user.image !== existingUser.avatarUrl) {
              await db.update(users)
                .set({ 
                  avatarUrl: user.image,
                  updatedAt: new Date()
                })
                .where(eq(users.id, existingUser.id))
            }
          }
          
          return true
        } catch (error) {
          console.error('OAuth signIn error:', error)
          return false
        }
      }
      
      return true // Credentials provider
    },
    
    // 现有的 jwt 和 session 回调保持不变
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id
        token.email = user.email
        token.name = user.name
      }
      return token
    },
    
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.id as string
        session.user.email = token.email as string
        session.user.name = token.name as string
      }
      return session
    }
  },
  
  pages: {
    signIn: '/login',
    error: '/login', // OAuth 错误也跳转到登录页
  },
  
  session: {
    strategy: 'jwt',
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
  
  secret: process.env.NEXTAUTH_SECRET,
}

const handler = NextAuth(authOptions)
export { handler as GET, handler as POST }
```

### 环境变量配置

**文件**: `.env.local.example`  
[Source: docs/architecture.md#environment-configuration]

**需要添加的 OAuth 配置**:

```bash
# OAuth Providers
GOOGLE_CLIENT_ID="your-google-client-id.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="your-google-client-secret"
GITHUB_CLIENT_ID="your-github-client-id"
GITHUB_CLIENT_SECRET="your-github-client-secret"
```

**本地开发配置**:
1. 复制 `.env.local.example` 到 `.env.local`
2. 按照下面步骤获取真实的 Client ID 和 Secret

### Google OAuth 应用创建步骤

**前往**: [Google Cloud Console](https://console.cloud.google.com/)

1. **创建项目**（如果没有）:
   - 项目名称: "DocQA System" 或自定义

2. **启用 Google+ API**:
   - APIs & Services → Library
   - 搜索 "Google+ API" → 启用

3. **创建 OAuth 2.0 凭据**:
   - APIs & Services → Credentials
   - Create Credentials → OAuth client ID
   - Application type: Web application
   - Name: "DocQA Web App"

4. **配置授权重定向 URI**:
   - Authorized redirect URIs:
     - 本地开发: `http://localhost:3000/api/auth/callback/google`
     - 生产环境: `https://your-domain.com/api/auth/callback/google`

5. **获取凭据**:
   - Client ID: 复制到 `GOOGLE_CLIENT_ID`
   - Client Secret: 复制到 `GOOGLE_CLIENT_SECRET`

### GitHub OAuth 应用创建步骤

**前往**: [GitHub Developer Settings](https://github.com/settings/developers)

1. **创建 OAuth App**:
   - Settings → Developer settings → OAuth Apps → New OAuth App

2. **填写应用信息**:
   - Application name: "DocQA System"
   - Homepage URL: 
     - 本地: `http://localhost:3000`
     - 生产: `https://your-domain.com`
   - Authorization callback URL:
     - 本地: `http://localhost:3000/api/auth/callback/github`
     - 生产: `https://your-domain.com/api/auth/callback/github`

3. **获取凭据**:
   - Client ID: 复制到 `GITHUB_CLIENT_ID`
   - Generate a new client secret → 复制到 `GITHUB_CLIENT_SECRET`

### 前端 OAuth 按钮组件

**文件**: `src/components/auth/OAuthButtons.tsx` (新建)  
[Source: docs/front-end-spec.md#login-page-design]

```typescript
'use client'

import { signIn } from 'next-auth/react'
import { Button } from '@/components/ui/button'
import { useState } from 'react'

export function OAuthButtons() {
  const [isGoogleLoading, setIsGoogleLoading] = useState(false)
  const [isGitHubLoading, setIsGitHubLoading] = useState(false)

  const handleGoogleSignIn = async () => {
    try {
      setIsGoogleLoading(true)
      await signIn('google', { callbackUrl: '/dashboard' })
    } catch (error) {
      console.error('Google sign in error:', error)
    } finally {
      setIsGoogleLoading(false)
    }
  }

  const handleGitHubSignIn = async () => {
    try {
      setIsGitHubLoading(true)
      await signIn('github', { callbackUrl: '/dashboard' })
    } catch (error) {
      console.error('GitHub sign in error:', error)
    } finally {
      setIsGitHubLoading(false)
    }
  }

  return (
    <div className="space-y-3">
      {/* 分隔线 */}
      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <span className="w-full border-t" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-background px-2 text-muted-foreground">OR</span>
        </div>
      </div>

      {/* OAuth 按钮 */}
      <div className="grid gap-3">
        {/* Google Button */}
        <Button
          variant="outline"
          type="button"
          disabled={isGoogleLoading || isGitHubLoading}
          onClick={handleGoogleSignIn}
          className="w-full"
        >
          {isGoogleLoading ? (
            <div className="mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent" />
          ) : (
            <svg className="mr-2 h-4 w-4" viewBox="0 0 24 24">
              <path
                fill="currentColor"
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
              />
              <path
                fill="#34A853"
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
              />
              <path
                fill="#FBBC05"
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
              />
              <path
                fill="#EA4335"
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
              />
            </svg>
          )}
          使用 Google 登录
        </Button>

        {/* GitHub Button */}
        <Button
          variant="outline"
          type="button"
          disabled={isGoogleLoading || isGitHubLoading}
          onClick={handleGitHubSignIn}
          className="w-full bg-[#24292F] text-white hover:bg-[#24292F]/90"
        >
          {isGitHubLoading ? (
            <div className="mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent" />
          ) : (
            <svg
              className="mr-2 h-4 w-4"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
            </svg>
          )}
          使用 GitHub 登录
        </Button>
      </div>
    </div>
  )
}
```

### 集成到登录/注册页面

**文件**: `src/app/(auth)/login/page.tsx`

```typescript
import { LoginForm } from '@/components/auth/LoginForm'
import { OAuthButtons } from '@/components/auth/OAuthButtons'

export default function LoginPage() {
  return (
    <div className="flex min-h-screen items-center justify-center">
      <Card className="w-[400px]">
        <CardHeader>
          <CardTitle>登录</CardTitle>
          <CardDescription>使用邮箱密码或第三方账号登录</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* 现有的邮箱密码表单 */}
          <LoginForm />
          
          {/* 新增: OAuth 按钮组 */}
          <OAuthButtons />
        </CardContent>
        <CardFooter>
          <p className="text-sm text-muted-foreground">
            还没有账号?{' '}
            <Link href="/register" className="text-primary hover:underline">
              注册
            </Link>
          </p>
        </CardFooter>
      </Card>
    </div>
  )
}
```

**同样方式修改**: `src/app/(auth)/register/page.tsx`

### 用户头像显示

**文件**: `src/app/dashboard/page.tsx` (或导航栏组件)

```typescript
import { getServerSession } from 'next-auth'
import { authOptions } from '@/app/api/auth/[...nextauth]/route'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'

export default async function Dashboard() {
  const session = await getServerSession(authOptions)
  
  // 获取用户头像
  const user = await db.query.users.findFirst({
    where: eq(users.email, session?.user?.email!)
  })

  return (
    <div className="flex items-center gap-3">
      <Avatar>
        <AvatarImage src={user?.avatarUrl || undefined} alt={user?.name} />
        <AvatarFallback>
          {user?.name?.charAt(0).toUpperCase()}
        </AvatarFallback>
      </Avatar>
      <div>
        <p className="text-sm font-medium">{user?.name}</p>
        <p className="text-xs text-muted-foreground">{user?.email}</p>
      </div>
    </div>
  )
}
```

### 测试策略

**单元测试**: `tests/unit/api/oauth.test.ts` (新建)

测试场景:
- [ ] 测试 `signIn` 回调正确创建 Google OAuth 用户
- [ ] 测试 `signIn` 回调正确创建 GitHub OAuth 用户
- [ ] 测试相同邮箱用户头像更新逻辑
- [ ] 测试 OAuth 用户 `passwordHash` 为 null
- [ ] 测试 OAuth 用户 `authProvider` 字段正确设置

**集成测试**: `tests/integration/oauth-flow.test.ts` (新建)

测试场景:
- [ ] 测试完整 Google OAuth 授权流程（使用 Mock）
- [ ] 测试完整 GitHub OAuth 授权流程（使用 Mock）
- [ ] 测试 OAuth 登录后成功重定向到 Dashboard
- [ ] 测试 OAuth 失败时的错误处理

**手动测试检查清单**:
- [ ] 点击"使用 Google 登录"跳转到 Google 授权页
- [ ] 授权后成功返回并登录到 Dashboard
- [ ] 点击"使用 GitHub 登录"跳转到 GitHub 授权页
- [ ] 授权后成功返回并登录到 Dashboard
- [ ] 用户头像正确显示在 Dashboard
- [ ] 取消授权时返回登录页并显示提示
- [ ] 相同邮箱的用户可以使用不同登录方式
- [ ] 按钮加载状态正常显示

### 错误处理

**OAuth 错误场景处理**:

1. **用户取消授权**:
   - NextAuth 自动返回登录页
   - URL 包含 `error=OAuthCallback` 参数
   - 在登录页检测参数并显示提示: "您已取消授权，请使用其他方式登录"

2. **OAuth Provider 配置错误**:
   - 环境变量缺失: 开发环境报错提示
   - Client ID/Secret 错误: 授权失败，显示通用错误提示

3. **数据库写入失败**:
   - `signIn` 回调返回 `false`
   - 用户停留在授权页，显示错误提示

**实现错误提示**:

```typescript
// src/app/(auth)/login/page.tsx
'use client'

import { useSearchParams } from 'next/navigation'
import { Alert, AlertDescription } from '@/components/ui/alert'

export default function LoginPage() {
  const searchParams = useSearchParams()
  const error = searchParams.get('error')

  return (
    <Card>
      {error === 'OAuthCallback' && (
        <Alert variant="destructive">
          <AlertDescription>
            OAuth 登录失败，请稍后重试或使用邮箱登录
          </AlertDescription>
        </Alert>
      )}
      {/* ... 其他内容 ... */}
    </Card>
  )
}
```

### 安全考虑

[Source: docs/architecture.md#security]

**已内置的安全机制** (NextAuth.js):
- ✅ CSRF Token 验证（state 参数）
- ✅ PKCE (Proof Key for Code Exchange) 支持
- ✅ HTTP-Only Cookie 存储 Session Token
- ✅ 加密的 JWT Token

**需要额外注意**:
- 确保 `NEXTAUTH_SECRET` 设置为随机强密钥（至少32字符）
- 生产环境必须使用 HTTPS
- 定期轮换 OAuth Client Secret
- 限制 OAuth 回调 URL 只接受已配置的域名

---

## Tasks / Subtasks

### Task 1: 环境配置与 OAuth 应用创建 (AC1, AC2, AC3)

- [ ] 更新 `.env.local.example` 添加 OAuth 环境变量模板
- [ ] 在 Google Cloud Console 创建 OAuth 2.0 应用
  - [ ] 配置本地开发回调 URL
  - [ ] 获取 Google Client ID 和 Secret
- [ ] 在 GitHub Developer Settings 创建 OAuth App
  - [ ] 配置本地开发回调 URL
  - [ ] 获取 GitHub Client ID 和 Secret
- [ ] 将真实凭据添加到本地 `.env.local` 文件
- [ ] 验证环境变量在 Next.js 中正确加载

**测试验证**: 
```bash
# 检查环境变量是否加载
node -e "console.log(process.env.GOOGLE_CLIENT_ID)"
```

### Task 2: NextAuth.js OAuth Providers 配置 (AC1)

- [ ] 安装必要的依赖包（如果缺失）:
  ```bash
  npm install next-auth @auth/drizzle-adapter
  ```
- [ ] 修改 `src/app/api/auth/[...nextauth]/route.ts`
  - [ ] 导入 GoogleProvider 和 GitHubProvider
  - [ ] 在 `providers` 数组添加 GoogleProvider 配置
  - [ ] 在 `providers` 数组添加 GitHubProvider 配置
  - [ ] 验证环境变量读取正确
- [ ] 重启开发服务器验证配置无错误

**预期结果**: NextAuth 启动无报错，访问 `/api/auth/providers` 可看到 google 和 github

### Task 3: 实现 signIn 回调处理 OAuth 用户 (AC4)

- [ ] 在 NextAuth 配置的 `callbacks` 添加 `signIn` 回调函数
- [ ] 检测 OAuth provider (`account?.provider`)
- [ ] 实现首次登录自动创建用户逻辑:
  - [ ] 查询用户是否已存在（按 email）
  - [ ] 如果不存在，插入新用户记录
  - [ ] 设置 `authProvider` 为对应的 provider（大写）
  - [ ] 设置 `passwordHash` 为 null
  - [ ] 存储 OAuth 头像 URL 到 `avatarUrl`
- [ ] 实现已存在用户的头像更新逻辑
- [ ] 添加错误处理和日志记录
- [ ] 测试回调函数逻辑（单元测试）

**单元测试**: `tests/unit/api/oauth.test.ts`
```typescript
describe('OAuth signIn callback', () => {
  it('should create new user for first-time Google login', async () => {
    // Mock Google OAuth response
    // Call signIn callback
    // Verify user created with correct authProvider
  })
  
  it('should update avatar for existing user', async () => {
    // Create existing user
    // Mock OAuth login with new avatar
    // Verify avatar updated
  })
})
```

### Task 4: 创建 OAuth 按钮组件 (AC5)

- [ ] 创建文件 `src/components/auth/OAuthButtons.tsx`
- [ ] 实现组件基础结构（按照技术指导中的示例）
- [ ] 添加 "OR" 分隔线
- [ ] 实现 Google 按钮:
  - [ ] 添加 Google 彩色图标 SVG
  - [ ] 设置白底样式
  - [ ] 绑定点击事件调用 `signIn('google')`
  - [ ] 添加加载状态
- [ ] 实现 GitHub 按钮:
  - [ ] 添加 GitHub 图标 SVG
  - [ ] 设置深色底样式 (`bg-[#24292F]`)
  - [ ] 绑定点击事件调用 `signIn('github')`
  - [ ] 添加加载状态
- [ ] 添加按钮禁用逻辑（防止重复点击）
- [ ] 测试组件样式和交互

**视觉验证**: 按钮样式符合前端规范，悬停和加载状态正常

### Task 5: 集成 OAuth 按钮到登录和注册页面 (AC5)

- [ ] 修改 `src/app/(auth)/login/page.tsx`
  - [ ] 导入 OAuthButtons 组件
  - [ ] 在 LoginForm 下方添加 OAuthButtons
  - [ ] 验证布局和间距正确
- [ ] 修改 `src/app/(auth)/register/page.tsx`
  - [ ] 导入 OAuthButtons 组件
  - [ ] 在 RegisterForm 下方添加 OAuthButtons
  - [ ] 验证布局和间距正确
- [ ] 测试登录页和注册页显示正常

**手动测试**: 访问 `/login` 和 `/register` 确认 OAuth 按钮显示正常

### Task 6: 实现用户头像显示 (AC6)

- [ ] 安装 shadcn/ui Avatar 组件（如果未安装）:
  ```bash
  npx shadcn-ui@latest add avatar
  ```
- [ ] 修改 Dashboard 页面或导航栏组件
- [ ] 从数据库查询当前用户信息（包括 avatarUrl）
- [ ] 使用 Avatar 组件显示:
  - [ ] AvatarImage 使用 user.avatarUrl
  - [ ] AvatarFallback 显示用户名首字母
- [ ] 测试头像加载失败时显示 fallback
- [ ] 测试 OAuth 用户头像正确显示

**视觉验证**: 
- OAuth 用户显示 Google/GitHub 头像
- 邮箱用户显示首字母 fallback
- 头像 URL 无效时正确显示 fallback

### Task 7: 错误处理与用户提示 (AC7)

- [ ] 在登录页检测 URL 参数 `error=OAuthCallback`
- [ ] 显示友好的错误提示 Alert
- [ ] 实现错误提示自动消失（可选）
- [ ] 测试各种错误场景:
  - [ ] 用户取消授权
  - [ ] Client ID/Secret 错误
  - [ ] 网络错误
- [ ] 确保错误提示不泄露敏感信息

**手动测试**: 故意触发各种错误场景，验证提示正确

### Task 8: 完整流程测试 (所有 AC)

**集成测试**: `tests/integration/oauth-flow.test.ts`

```typescript
describe('OAuth Authentication Flow', () => {
  it('should complete Google OAuth flow', async () => {
    // Mock Google OAuth API responses
    // Simulate authorization flow
    // Verify user created and session established
    // Verify redirect to dashboard
  })
  
  it('should complete GitHub OAuth flow', async () => {
    // Similar to Google test
  })
  
  it('should handle OAuth cancellation gracefully', async () => {
    // Simulate user canceling authorization
    // Verify error handling
  })
})
```

**手动测试完整检查清单**:

- [ ] **Google OAuth 流程**:
  - [ ] 点击"使用 Google 登录"跳转到 Google 授权页
  - [ ] 授权后成功返回并自动登录
  - [ ] 重定向到 Dashboard
  - [ ] 用户头像正确显示
  - [ ] 数据库中用户 authProvider 为 'GOOGLE'
  - [ ] passwordHash 为 null
  
- [ ] **GitHub OAuth 流程**:
  - [ ] 点击"使用 GitHub 登录"跳转到 GitHub 授权页
  - [ ] 授权后成功返回并自动登录
  - [ ] 重定向到 Dashboard
  - [ ] 用户头像正确显示
  - [ ] 数据库中用户 authProvider 为 'GITHUB'
  - [ ] passwordHash 为 null

- [ ] **边缘场景**:
  - [ ] 使用相同邮箱先用 Google 登录再用邮箱密码注册（或反过来）
  - [ ] 用户头像 URL 失效时正确显示 fallback
  - [ ] 取消授权时返回登录页并显示提示
  - [ ] OAuth 按钮在请求进行中被禁用
  - [ ] Session 过期后重新 OAuth 登录

- [ ] **跨浏览器测试**:
  - [ ] Chrome
  - [ ] Safari
  - [ ] Firefox

### Task 9: 文档更新

- [ ] 更新 `.env.local.example` 包含 OAuth 配置
- [ ] 在项目 README 添加 OAuth 配置步骤
- [ ] 添加注释说明如何获取 Google/GitHub OAuth 凭据
- [ ] 更新部署文档包含生产环境 OAuth 配置指南

---

## Definition of Done

- [x] 所有验收标准 (AC1-AC7) 已实现
- [x] NextAuth.js 配置包含 Google 和 GitHub Providers
- [x] OAuth 按钮组件已创建并集成到登录/注册页
- [x] OAuth 用户自动创建和头像存储逻辑已实现
- [x] 用户头像在 Dashboard 正确显示
- [x] 单元测试覆盖 OAuth 回调逻辑
- [x] 集成测试覆盖完整 OAuth 流程
- [x] 所有测试通过（单元 + 集成）
- [x] 手动测试完整检查清单全部通过
- [x] 代码通过 ESLint 检查
- [x] TypeScript 编译无错误
- [x] 环境配置文档已更新
- [x] 代码已 Review 并合并到主分支

---

## Dev Agent Record

### Agent Model Used
- 模型: _待填写_
- 版本: _待填写_

### Debug Log References
_Story 实现过程中的关键调试信息、命令执行记录等_

### Completion Notes
_Story 完成后的实现总结、技术决策说明、遇到的挑战及解决方案_

### File List
_所有新建、修改或删除的文件清单_

**新建文件**:
- [ ] `src/components/auth/OAuthButtons.tsx`
- [ ] `tests/unit/api/oauth.test.ts`
- [ ] `tests/integration/oauth-flow.test.ts`

**修改文件**:
- [ ] `src/app/api/auth/[...nextauth]/route.ts`
- [ ] `src/app/(auth)/login/page.tsx`
- [ ] `src/app/(auth)/register/page.tsx`
- [ ] `src/app/dashboard/page.tsx` (或导航栏组件)
- [ ] `.env.local.example`
- [ ] `README.md`

---

## Change Log

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2025-01-03 | 1.0 | Story 创建 | Bob (SM) |

---

## References

**架构文档**:
- `docs/architecture.md#authentication-flow` - 认证流程图
- `docs/architecture.md#environment-configuration` - 环境变量配置
- `docs/architecture.md#security` - 安全策略

**前端规范**:
- `docs/front-end-spec.md#login-page-design` - 登录页面 UI 设计

**数据库 Schema**:
- `drizzle/schema.ts` - users 表定义

**相关 Story**:
- Story 1.4 - 用户登录功能（前置依赖）

**外部文档**:
- [NextAuth.js v5 Documentation](https://next-auth.js.org/)
- [Google OAuth 2.0 Setup](https://developers.google.com/identity/protocols/oauth2)
- [GitHub OAuth Apps](https://docs.github.com/en/developers/apps/building-oauth-apps)

