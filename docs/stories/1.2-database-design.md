# Story 1.2: 数据库设计与初始化

**Story ID**: 1.2  
**Epic**: 1 - 基础设施与用户认证  
**优先级**: P0 (MVP必须)  
**预估工时**: 2天  
**状态**: Draft

---

## User Story

作为**开发者**,  
我想要**设计并初始化数据库架构**,  
以便**存储用户、文档和对话数据**。

---

## 验收标准

### AC1: Drizzle ORM集成
- [x] 安装drizzle-orm和drizzle-kit
- [x] 配置drizzle.config.ts
- [x] 连接到Supabase PostgreSQL成功

### AC2: 数据库Schema设计
- [x] User表Schema定义完整(id, email, password_hash, name等)
- [x] Document表Schema定义完整(id, user_id, filename, status等)
- [x] Conversation表Schema定义完整
- [x] Message表Schema定义完整
- [x] UserUsage表Schema定义完整
- [x] DocumentChunk表Schema定义完整
- [x] Citation表Schema定义完整

### AC3: 数据库关系定义
- [x] 定义User与Document的一对多关系
- [x] 定义User与Conversation的一对多关系
- [x] 定义Document与DocumentChunk的一对多关系
- [x] 定义Conversation与Message的一对多关系
- [x] 所有外键约束配置正确

### AC4: 索引优化
- [x] 为email字段创建唯一索引
- [x] 为userId外键创建索引
- [x] 为documentId外键创建索引
- [x] 为status字段创建索引

### AC5: 数据库迁移
- [x] 生成初始迁移文件
- [x] 成功执行迁移到Supabase
- [x] 验证所有表创建成功

### AC6: CRUD操作验证
- [x] 可以创建用户记录
- [x] 可以查询用户记录
- [x] 可以更新用户记录
- [x] 可以删除用户记录(级联删除关联数据)

---

## 技术实现指导

### 架构参考

**相关架构文档**:
- `docs/architecture.md#database-schema` - 完整数据库Schema定义
- `docs/architecture.md#data-architecture` - 数据架构设计

### 实现步骤

#### 1. 安装Drizzle ORM

```bash
npm install drizzle-orm postgres
npm install -D drizzle-kit
```

#### 2. 配置Drizzle

```typescript
// drizzle.config.ts
import type { Config } from 'drizzle-kit'

export default {
  schema: './drizzle/schema.ts',
  out: './drizzle/migrations',
  driver: 'pg',
  dbCredentials: {
    connectionString: process.env.DATABASE_URL!
  }
} satisfies Config
```

#### 3. 定义Schema

参考 `docs/architecture.md#database-schema` 中的完整Schema定义，创建 `drizzle/schema.ts`：

```typescript
// drizzle/schema.ts
import { pgTable, text, integer, timestamp, jsonb } from 'drizzle-orm/pg-core'
import { createId } from '@paralleldrive/cuid2'

// Users表
export const users = pgTable('users', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  email: text('email').notNull().unique(),
  passwordHash: text('password_hash'),
  name: text('name').notNull(),
  // ... 其他字段参考architecture.md
})

// Documents表
export const documents = pgTable('documents', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  // ... 其他字段
})

// 其他表定义...
```

#### 4. 创建数据库客户端

```typescript
// src/lib/db.ts
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'
import * as schema from '@/drizzle/schema'

const connectionString = process.env.DATABASE_URL!
const client = postgres(connectionString, {
  max: process.env.NODE_ENV === 'production' ? 10 : 1,
})

export const db = drizzle(client, { schema })
```

#### 5. 生成和执行迁移

```bash
# 生成迁移文件
npm run db:generate

# 执行迁移
npm run db:push

# 或使用migrate脚本
npm run db:migrate
```

---

## 任务分解

### Task 1: Drizzle ORM安装和配置 (2h)
- [ ] 安装依赖包
- [ ] 配置drizzle.config.ts
- [ ] 配置数据库连接字符串

### Task 2: Schema定义 (4h)
- [ ] 定义User表Schema
- [ ] 定义Document表Schema
- [ ] 定义Conversation和Message表Schema
- [ ] 定义UserUsage表Schema
- [ ] 定义DocumentChunk和Citation表Schema
- [ ] 定义所有关系(relations)

### Task 3: 索引和约束 (2h)
- [ ] 添加所有必要的索引
- [ ] 配置外键约束
- [ ] 配置级联删除规则

### Task 4: 数据库迁移 (2h)
- [ ] 生成迁移文件
- [ ] 执行迁移到开发数据库
- [ ] 验证所有表创建成功
- [ ] 测试CRUD操作

---

## 测试要求

### 单元测试
```typescript
// tests/unit/db/users.test.ts
import { db } from '@/lib/db'
import { users } from '@/drizzle/schema'

describe('User CRUD Operations', () => {
  it('should create a user', async () => {
    const [user] = await db.insert(users).values({
      email: 'test@example.com',
      name: 'Test User',
    }).returning()
    
    expect(user.email).toBe('test@example.com')
  })
})
```

### 集成测试
- [ ] 测试所有表的CRUD操作
- [ ] 测试外键约束(级联删除)
- [ ] 测试唯一约束(email重复)

---

## 依赖关系

**前置依赖**: 
- Story 1.1 (项目脚手架)

**后续依赖**: 
- Story 1.3-1.6 (需要数据库表)
- Epic 2 (文档管理需要数据库)

---

**创建日期**: 2025-01-03  
**负责人**: Development Team

