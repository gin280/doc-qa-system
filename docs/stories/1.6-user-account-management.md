# Story 1.6: 用户账户管理页面

**Story ID**: 1.6  
**Epic**: 1 - 基础设施与用户认证  
**优先级**: P1 (MVP重要)  
**预估工时**: 3天  
**状态**: Draft

---

## User Story

作为**已登录用户**,  
我想要**在一个集中的账户设置页面管理我的个人信息和查看使用量统计**,  
以便**更新我的个人资料、修改密码、查看我的使用情况并在需要时删除我的账户**。

---

## 验收标准

### AC1: 账户设置页面路由与布局

- [ ] 创建 `/settings` 页面路由
- [ ] 只有已登录用户可以访问（未登录自动跳转到 `/login`）
- [ ] 页面采用卡片式布局设计
- [ ] 顶部显示页面标题"账户设置"和返回主页链接
- [ ] 包含三个主要卡片区域：个人信息、使用量统计、危险操作
- [ ] 响应式设计，移动端友好（Phase 2）

### AC2: 个人信息展示与编辑

- [ ] 显示用户头像（如果有）
- [ ] 显示邮箱地址（只读，标注认证方式）
- [ ] 显示用户名（可编辑文本框）
- [ ] 显示注册时间（只读，格式化显示）
- [ ] 显示认证方式（EMAIL / GOOGLE / GITHUB）
- [ ] OAuth 用户显示提示：头像与第三方账号同步
- [ ] 用户名修改功能：
  - [ ] 实时验证（非空、长度2-50字符）
  - [ ] "保存"按钮只在内容变化时激活
  - [ ] 保存成功显示 Toast 提示
  - [ ] 保存失败显示错误信息

### AC3: 修改密码功能

- [ ] "修改密码"按钮在个人信息卡片内
- [ ] 点击打开修改密码模态框
- [ ] 模态框包含三个输入框：
  - [ ] 当前密码（必填，type="password"）
  - [ ] 新密码（必填，type="password"）
  - [ ] 确认新密码（必填，type="password"）
- [ ] 实时验证规则：
  - [ ] 新密码至少8位，包含字母和数字
  - [ ] 确认密码与新密码一致
  - [ ] 显示密码强度指示器
- [ ] 提交后验证当前密码是否正确
- [ ] 修改成功后：
  - [ ] 显示成功 Toast
  - [ ] 自动关闭模态框
  - [ ] 更新数据库 `passwordHash` 和 `updatedAt`
- [ ] OAuth 用户特殊处理：
  - [ ] 如果 `authProvider` 不是 EMAIL，不显示"修改密码"按钮
  - [ ] 或显示禁用状态并提示"您使用第三方登录，无需设置密码"

### AC4: 使用量统计展示

- [ ] 显示文档数量（当前 / 限额）
- [ ] 显示存储空间（当前 / 限额，单位自动转换 MB/GB）
- [ ] 显示查询次数（当前 / 限额，显示重置日期）
- [ ] 每项统计包含进度条可视化：
  - [ ] 绿色：使用率 < 50%
  - [ ] 黄色：使用率 50-80%
  - [ ] 红色：使用率 > 80%
- [ ] 数据从 `user_usage` 表实时查询
- [ ] 如果用户无使用记录，显示初始值 0

### AC5: 删除账户功能（危险操作）

- [ ] "删除账户"按钮在独立的危险操作卡片中
- [ ] 按钮样式：红色边框和文字
- [ ] 点击后打开确认模态框
- [ ] 确认模态框内容：
  - [ ] 警告文字："此操作无法撤销，您的所有数据将被永久删除"
  - [ ] 输入框："请输入您的邮箱以确认删除"
  - [ ] "取消"和"确认删除"按钮
- [ ] 验证邮箱输入与当前用户邮箱一致
- [ ] 确认删除后：
  - [ ] 调用删除账户 API（`DELETE /api/user/account`）
  - [ ] 数据库级联删除用户相关数据（Drizzle onDelete: 'cascade'）
  - [ ] 清除 NextAuth session
  - [ ] 跳转到首页并显示"账户已删除"Toast
  - [ ] 清除所有客户端存储（localStorage、sessionStorage）

### AC6: API 端点实现

- [ ] `PATCH /api/user/profile` - 更新用户名
  - [ ] 输入验证：name 字段 2-50 字符
  - [ ] 更新 `users.name` 和 `users.updatedAt`
  - [ ] 返回更新后的用户信息
- [ ] `PATCH /api/user/password` - 修改密码
  - [ ] 输入验证：currentPassword, newPassword, confirmPassword
  - [ ] 验证 currentPassword 与数据库 passwordHash 匹配
  - [ ] 验证 newPassword 与 confirmPassword 一致
  - [ ] 使用 bcrypt 哈希新密码（salt rounds = 10）
  - [ ] 更新 `users.passwordHash` 和 `users.updatedAt`
  - [ ] 限流保护：每用户每5分钟最多3次密码修改尝试
- [ ] `GET /api/user/usage` - 查询使用量统计
  - [ ] 从 `user_usage` 表查询当前用户的使用量
  - [ ] 返回 documentCount, storageUsed, queryCount, queryResetDate
  - [ ] 如果记录不存在，返回初始值 0
- [ ] `DELETE /api/user/account` - 删除账户
  - [ ] 验证用户已登录
  - [ ] 验证请求体中的 email 与当前用户匹配
  - [ ] 删除 `users` 表记录（级联删除相关表）
  - [ ] 清除 NextAuth session
  - [ ] 返回 204 No Content

### AC7: 错误处理与安全

- [ ] 所有 API 调用失败时显示友好错误提示
- [ ] 密码修改失败3次后显示警告
- [ ] 删除账户操作需 CSRF Token 保护（NextAuth 内置）
- [ ] 所有表单验证在客户端和服务端都执行
- [ ] 敏感操作（修改密码、删除账户）记录审计日志
- [ ] Rate Limiting：防止暴力破解和滥用
  - [ ] 密码修改：每用户5分钟最多3次
  - [ ] 账户删除：每用户每小时最多1次尝试

---

## Dev Technical Guidance

### 前置条件

**Story 1.5 已完成**:
- NextAuth.js 认证系统完整可用
- 用户可以通过邮箱密码或 OAuth 登录
- Dashboard 已显示用户头像和基本信息
- Session 管理正常工作

### 数据模型

**使用现有 Schema** [Source: drizzle/schema.ts]

**用户表**:
```typescript
export const users = pgTable('users', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  email: text('email').notNull().unique(),
  passwordHash: text('password_hash'),  // OAuth 用户为 null
  name: text('name').notNull(),
  avatarUrl: text('avatar_url'),
  authProvider: authProviderEnum('auth_provider').default('EMAIL').notNull(),
  status: userStatusEnum('status').default('active').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull()
})
```

**用户使用量表**:
```typescript
export const userUsage = pgTable('user_usage', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  userId: text('user_id').notNull().unique().references(() => users.id, { onDelete: 'cascade' }),
  documentCount: integer('document_count').default(0).notNull(),
  storageUsed: bigint('storage_used', { mode: 'number' }).default(0).notNull(),
  queryCount: integer('query_count').default(0).notNull(),
  queryResetDate: timestamp('query_reset_date').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull()
})
```

**关键字段说明**:
- `passwordHash`: OAuth 用户此字段为 `null`，不允许修改密码
- `authProvider`: 标识认证方式，用于判断是否显示密码修改功能
- `storageUsed`: 存储为字节数，前端需转换为 MB/GB
- `queryResetDate`: 查询次数重置日期（每月重置）

### 页面组件结构

**文件**: `src/app/settings/page.tsx`  
[Source: docs/front-end-spec.md#screen-4-account-settings-page]

**页面组件结构**:
```typescript
'use client'

import { useState, useEffect } from 'react'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Avatar, AvatarImage, AvatarFallback } from '@/components/ui/avatar'
import { Progress } from '@/components/ui/progress'
import { ChangePasswordModal } from '@/components/settings/ChangePasswordModal'
import { DeleteAccountModal } from '@/components/settings/DeleteAccountModal'
import { toast } from 'sonner'

interface UserProfile {
  id: string
  email: string
  name: string
  avatarUrl: string | null
  authProvider: 'EMAIL' | 'GOOGLE' | 'GITHUB'
  createdAt: string
}

interface UserUsage {
  documentCount: number
  documentLimit: number
  storageUsed: number
  storageLimit: number
  queryCount: number
  queryLimit: number
  queryResetDate: string
}

export default function SettingsPage() {
  const { data: session, status } = useSession()
  const router = useRouter()
  
  const [profile, setProfile] = useState<UserProfile | null>(null)
  const [usage, setUsage] = useState<UserUsage | null>(null)
  const [name, setName] = useState('')
  const [isNameChanged, setIsNameChanged] = useState(false)
  const [isSaving, setIsSaving] = useState(false)
  
  const [showChangePasswordModal, setShowChangePasswordModal] = useState(false)
  const [showDeleteAccountModal, setShowDeleteAccountModal] = useState(false)

  // 获取用户信息和使用量
  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/login')
      return
    }
    
    if (status === 'authenticated') {
      fetchUserProfile()
      fetchUserUsage()
    }
  }, [status, router])

  const fetchUserProfile = async () => {
    try {
      const res = await fetch('/api/user/profile')
      if (!res.ok) throw new Error('Failed to fetch profile')
      const data = await res.json()
      setProfile(data)
      setName(data.name)
    } catch (error) {
      toast.error('加载用户信息失败')
    }
  }

  const fetchUserUsage = async () => {
    try {
      const res = await fetch('/api/user/usage')
      if (!res.ok) throw new Error('Failed to fetch usage')
      const data = await res.json()
      setUsage(data)
    } catch (error) {
      toast.error('加载使用量统计失败')
    }
  }

  const handleSaveName = async () => {
    if (!name || name === profile?.name) return
    
    setIsSaving(true)
    try {
      const res = await fetch('/api/user/profile', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      })
      
      if (!res.ok) throw new Error('Failed to update name')
      
      const updated = await res.json()
      setProfile(updated)
      setIsNameChanged(false)
      toast.success('用户名更新成功')
    } catch (error) {
      toast.error('更新用户名失败，请重试')
    } finally {
      setIsSaving(false)
    }
  }

  const getUsagePercentage = (current: number, limit: number) => {
    return Math.round((current / limit) * 100)
  }

  const getUsageColor = (percentage: number) => {
    if (percentage < 50) return 'bg-green-500'
    if (percentage < 80) return 'bg-yellow-500'
    return 'bg-red-500'
  }

  const formatStorageSize = (bytes: number) => {
    if (bytes === 0) return '0 MB'
    const mb = bytes / (1024 * 1024)
    if (mb < 1024) return `${Math.round(mb)} MB`
    const gb = mb / 1024
    return `${gb.toFixed(2)} GB`
  }

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })
  }

  if (status === 'loading' || !profile || !usage) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full" />
      </div>
    )
  }

  return (
    <div className="container max-w-4xl mx-auto py-8 px-4">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <h1 className="text-3xl font-bold">账户设置</h1>
        <Button variant="outline" onClick={() => router.push('/dashboard')}>
          返回主页
        </Button>
      </div>

      {/* 个人信息卡片 */}
      <Card className="mb-6">
        <CardHeader>
          <CardTitle>个人信息</CardTitle>
          <CardDescription>管理您的个人资料和账户信息</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* 头像 */}
          <div className="flex items-center gap-4">
            <Avatar className="h-20 w-20">
              <AvatarImage src={profile.avatarUrl || undefined} alt={profile.name} />
              <AvatarFallback className="text-2xl">
                {profile.name.charAt(0).toUpperCase()}
              </AvatarFallback>
            </Avatar>
            <div>
              <p className="text-sm font-medium">用户头像</p>
              {profile.authProvider !== 'EMAIL' && (
                <p className="text-xs text-muted-foreground">
                  头像已与 {profile.authProvider} 账号同步
                </p>
              )}
            </div>
          </div>

          {/* 邮箱 */}
          <div>
            <label className="text-sm font-medium">邮箱地址</label>
            <p className="text-sm text-muted-foreground mt-1">
              {profile.email} 
              <span className="ml-2 text-xs bg-secondary px-2 py-0.5 rounded">
                {profile.authProvider} 登录
              </span>
            </p>
          </div>

          {/* 用户名 */}
          <div>
            <label className="text-sm font-medium">用户名</label>
            <div className="flex gap-2 mt-1">
              <Input
                value={name}
                onChange={(e) => {
                  setName(e.target.value)
                  setIsNameChanged(e.target.value !== profile.name)
                }}
                placeholder="输入用户名"
                maxLength={50}
              />
              <Button
                onClick={handleSaveName}
                disabled={!isNameChanged || !name || isSaving}
              >
                {isSaving ? '保存中...' : '保存'}
              </Button>
            </div>
          </div>

          {/* 注册时间 */}
          <div>
            <label className="text-sm font-medium">注册时间</label>
            <p className="text-sm text-muted-foreground mt-1">
              {formatDate(profile.createdAt)}
            </p>
          </div>

          {/* 修改密码按钮 */}
          {profile.authProvider === 'EMAIL' ? (
            <Button
              variant="outline"
              onClick={() => setShowChangePasswordModal(true)}
            >
              修改密码
            </Button>
          ) : (
            <p className="text-sm text-muted-foreground">
              您使用 {profile.authProvider} 登录，无需设置密码
            </p>
          )}
        </CardContent>
      </Card>

      {/* 使用量统计卡片 */}
      <Card className="mb-6">
        <CardHeader>
          <CardTitle>使用量统计</CardTitle>
          <CardDescription>查看您的存储和查询使用情况</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* 文档数量 */}
          <div>
            <div className="flex justify-between mb-2">
              <span className="text-sm font-medium">文档数量</span>
              <span className="text-sm text-muted-foreground">
                {usage.documentCount} / {usage.documentLimit}
              </span>
            </div>
            <Progress 
              value={getUsagePercentage(usage.documentCount, usage.documentLimit)}
              className={getUsageColor(getUsagePercentage(usage.documentCount, usage.documentLimit))}
            />
          </div>

          {/* 存储空间 */}
          <div>
            <div className="flex justify-between mb-2">
              <span className="text-sm font-medium">存储空间</span>
              <span className="text-sm text-muted-foreground">
                {formatStorageSize(usage.storageUsed)} / {formatStorageSize(usage.storageLimit)}
              </span>
            </div>
            <Progress 
              value={getUsagePercentage(usage.storageUsed, usage.storageLimit)}
              className={getUsageColor(getUsagePercentage(usage.storageUsed, usage.storageLimit))}
            />
          </div>

          {/* 查询次数 */}
          <div>
            <div className="flex justify-between mb-2">
              <span className="text-sm font-medium">查询次数（本月）</span>
              <span className="text-sm text-muted-foreground">
                {usage.queryCount} / {usage.queryLimit}
              </span>
            </div>
            <Progress 
              value={getUsagePercentage(usage.queryCount, usage.queryLimit)}
              className={getUsageColor(getUsagePercentage(usage.queryCount, usage.queryLimit))}
            />
            <p className="text-xs text-muted-foreground mt-2">
              重置日期: {formatDate(usage.queryResetDate)}
            </p>
          </div>
        </CardContent>
      </Card>

      {/* 危险操作卡片 */}
      <Card className="border-destructive">
        <CardHeader>
          <CardTitle className="text-destructive">危险操作</CardTitle>
          <CardDescription>这些操作无法撤销，请谨慎操作</CardDescription>
        </CardHeader>
        <CardContent>
          <Button
            variant="destructive"
            onClick={() => setShowDeleteAccountModal(true)}
          >
            删除账户
          </Button>
        </CardContent>
      </Card>

      {/* 模态框 */}
      <ChangePasswordModal
        open={showChangePasswordModal}
        onClose={() => setShowChangePasswordModal(false)}
      />
      <DeleteAccountModal
        open={showDeleteAccountModal}
        onClose={() => setShowDeleteAccountModal(false)}
        userEmail={profile.email}
      />
    </div>
  )
}
```

### 修改密码模态框组件

**文件**: `src/components/settings/ChangePasswordModal.tsx` (新建)

```typescript
'use client'

import { useState } from 'react'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { toast } from 'sonner'

interface Props {
  open: boolean
  onClose: () => void
}

export function ChangePasswordModal({ open, onClose }: Props) {
  const [currentPassword, setCurrentPassword] = useState('')
  const [newPassword, setNewPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [errors, setErrors] = useState<Record<string, string>>({})

  const validateForm = () => {
    const newErrors: Record<string, string> = {}

    if (!currentPassword) {
      newErrors.currentPassword = '请输入当前密码'
    }

    if (!newPassword) {
      newErrors.newPassword = '请输入新密码'
    } else if (newPassword.length < 8) {
      newErrors.newPassword = '密码至少8位'
    } else if (!/^(?=.*[A-Za-z])(?=.*\d)/.test(newPassword)) {
      newErrors.newPassword = '密码必须包含字母和数字'
    }

    if (!confirmPassword) {
      newErrors.confirmPassword = '请确认新密码'
    } else if (newPassword !== confirmPassword) {
      newErrors.confirmPassword = '两次密码输入不一致'
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!validateForm()) return

    setIsLoading(true)
    try {
      const res = await fetch('/api/user/password', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          currentPassword,
          newPassword,
          confirmPassword
        })
      })

      const data = await res.json()

      if (!res.ok) {
        throw new Error(data.error || '密码修改失败')
      }

      toast.success('密码修改成功')
      handleClose()
    } catch (error: any) {
      toast.error(error.message || '密码修改失败，请重试')
    } finally {
      setIsLoading(false)
    }
  }

  const handleClose = () => {
    setCurrentPassword('')
    setNewPassword('')
    setConfirmPassword('')
    setErrors({})
    onClose()
  }

  const getPasswordStrength = (password: string) => {
    if (password.length === 0) return { label: '', color: '' }
    if (password.length < 8) return { label: '弱', color: 'text-red-500' }
    if (!/^(?=.*[A-Za-z])(?=.*\d)/.test(password)) return { label: '弱', color: 'text-red-500' }
    if (password.length >= 12 && /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&])/.test(password)) {
      return { label: '强', color: 'text-green-500' }
    }
    return { label: '中', color: 'text-yellow-500' }
  }

  const passwordStrength = getPasswordStrength(newPassword)

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>修改密码</DialogTitle>
          <DialogDescription>
            请输入当前密码和新密码。新密码必须至少8位，包含字母和数字。
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit}>
          <div className="space-y-4">
            {/* 当前密码 */}
            <div>
              <Label htmlFor="currentPassword">当前密码</Label>
              <Input
                id="currentPassword"
                type="password"
                value={currentPassword}
                onChange={(e) => setCurrentPassword(e.target.value)}
                placeholder="输入当前密码"
              />
              {errors.currentPassword && (
                <p className="text-sm text-destructive mt-1">{errors.currentPassword}</p>
              )}
            </div>

            {/* 新密码 */}
            <div>
              <Label htmlFor="newPassword">新密码</Label>
              <Input
                id="newPassword"
                type="password"
                value={newPassword}
                onChange={(e) => setNewPassword(e.target.value)}
                placeholder="输入新密码"
              />
              {newPassword && (
                <p className={`text-sm mt-1 ${passwordStrength.color}`}>
                  密码强度: {passwordStrength.label}
                </p>
              )}
              {errors.newPassword && (
                <p className="text-sm text-destructive mt-1">{errors.newPassword}</p>
              )}
            </div>

            {/* 确认密码 */}
            <div>
              <Label htmlFor="confirmPassword">确认新密码</Label>
              <Input
                id="confirmPassword"
                type="password"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                placeholder="再次输入新密码"
              />
              {errors.confirmPassword && (
                <p className="text-sm text-destructive mt-1">{errors.confirmPassword}</p>
              )}
            </div>
          </div>

          <DialogFooter className="mt-6">
            <Button type="button" variant="outline" onClick={handleClose}>
              取消
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading ? '保存中...' : '确认修改'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

### 删除账户模态框组件

**文件**: `src/components/settings/DeleteAccountModal.tsx` (新建)

```typescript
'use client'

import { useState } from 'react'
import { signOut } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { toast } from 'sonner'

interface Props {
  open: boolean
  onClose: () => void
  userEmail: string
}

export function DeleteAccountModal({ open, onClose, userEmail }: Props) {
  const [emailConfirmation, setEmailConfirmation] = useState('')
  const [isDeleting, setIsDeleting] = useState(false)
  const router = useRouter()

  const handleDelete = async () => {
    if (emailConfirmation !== userEmail) {
      toast.error('邮箱输入不匹配，请重新输入')
      return
    }

    setIsDeleting(true)
    try {
      const res = await fetch('/api/user/account', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: emailConfirmation })
      })

      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.error || '删除账户失败')
      }

      // 清除客户端存储
      localStorage.clear()
      sessionStorage.clear()

      // 登出并跳转
      await signOut({ redirect: false })
      router.push('/')
      toast.success('账户已删除')
    } catch (error: any) {
      toast.error(error.message || '删除账户失败，请重试')
    } finally {
      setIsDeleting(false)
    }
  }

  const handleClose = () => {
    setEmailConfirmation('')
    onClose()
  }

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle className="text-destructive">删除账户</DialogTitle>
          <DialogDescription>
            ⚠️ 此操作无法撤销！您的所有数据将被永久删除，包括：
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-2 text-sm text-muted-foreground mb-4">
          <li>所有上传的文档</li>
          <li>所有对话历史记录</li>
          <li>个人资料和使用量统计</li>
        </div>

        <div className="space-y-4">
          <div>
            <Label htmlFor="emailConfirmation">
              请输入您的邮箱以确认删除：
            </Label>
            <Input
              id="emailConfirmation"
              type="email"
              value={emailConfirmation}
              onChange={(e) => setEmailConfirmation(e.target.value)}
              placeholder={userEmail}
            />
          </div>
        </div>

        <DialogFooter className="mt-6">
          <Button type="button" variant="outline" onClick={handleClose}>
            取消
          </Button>
          <Button
            variant="destructive"
            onClick={handleDelete}
            disabled={emailConfirmation !== userEmail || isDeleting}
          >
            {isDeleting ? '删除中...' : '确认删除'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

### API 路由实现

**文件 1**: `src/app/api/user/profile/route.ts` (新建)

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@/lib/auth'
import { db } from '@/lib/db'
import { users } from '@/../drizzle/schema'
import { eq } from 'drizzle-orm'
import { z } from 'zod'

// GET /api/user/profile - 获取用户信息
export async function GET(request: NextRequest) {
  try {
    const session = await auth()

    if (!session || !session.user?.email) {
      return NextResponse.json({ error: '未登录' }, { status: 401 })
    }

    const user = await db.query.users.findFirst({
      where: eq(users.email, session.user.email),
      columns: {
        id: true,
        email: true,
        name: true,
        avatarUrl: true,
        authProvider: true,
        createdAt: true,
      }
    })

    if (!user) {
      return NextResponse.json({ error: '用户不存在' }, { status: 404 })
    }

    return NextResponse.json(user)
  } catch (error) {
    console.error('Get profile error:', error)
    return NextResponse.json({ error: '获取用户信息失败' }, { status: 500 })
  }
}

// PATCH /api/user/profile - 更新用户名
export async function PATCH(request: NextRequest) {
  try {
    const session = await auth()

    if (!session || !session.user?.email) {
      return NextResponse.json({ error: '未登录' }, { status: 401 })
    }

    const body = await request.json()

    const updateSchema = z.object({
      name: z.string().min(2, '用户名至少2个字符').max(50, '用户名最多50个字符')
    })

    const validation = updateSchema.safeParse(body)
    if (!validation.success) {
      return NextResponse.json(
        { error: validation.error.errors[0].message },
        { status: 400 }
      )
    }

    const { name } = validation.data

    const [updatedUser] = await db
      .update(users)
      .set({
        name,
        updatedAt: new Date()
      })
      .where(eq(users.email, session.user.email))
      .returning({
        id: users.id,
        email: users.email,
        name: users.name,
        avatarUrl: users.avatarUrl,
        authProvider: users.authProvider,
        createdAt: users.createdAt,
      })

    return NextResponse.json(updatedUser)
  } catch (error) {
    console.error('Update profile error:', error)
    return NextResponse.json({ error: '更新用户信息失败' }, { status: 500 })
  }
}
```

**文件 2**: `src/app/api/user/password/route.ts` (新建)

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@/lib/auth'
import { db } from '@/lib/db'
import { users } from '@/../drizzle/schema'
import { eq } from 'drizzle-orm'
import { z } from 'zod'
import bcrypt from 'bcrypt'
import { rateLimit } from '@/lib/rate-limit'

const passwordLimiter = rateLimit({
  interval: 5 * 60 * 1000, // 5 minutes
  uniqueTokenPerInterval: 500
})

// PATCH /api/user/password - 修改密码
export async function PATCH(request: NextRequest) {
  try {
    const session = await auth()

    if (!session || !session.user?.email) {
      return NextResponse.json({ error: '未登录' }, { status: 401 })
    }

    // Rate limiting
    try {
      await passwordLimiter.check(session.user.email, 3)
    } catch {
      return NextResponse.json(
        { error: '操作过于频繁，请5分钟后再试' },
        { status: 429 }
      )
    }

    const body = await request.json()

    const passwordSchema = z.object({
      currentPassword: z.string().min(1, '请输入当前密码'),
      newPassword: z.string()
        .min(8, '新密码至少8位')
        .regex(/^(?=.*[A-Za-z])(?=.*\d)/, '新密码必须包含字母和数字'),
      confirmPassword: z.string().min(1, '请确认新密码')
    }).refine(data => data.newPassword === data.confirmPassword, {
      message: '两次密码输入不一致',
      path: ['confirmPassword']
    })

    const validation = passwordSchema.safeParse(body)
    if (!validation.success) {
      return NextResponse.json(
        { error: validation.error.errors[0].message },
        { status: 400 }
      )
    }

    const { currentPassword, newPassword } = validation.data

    // 查询用户
    const user = await db.query.users.findFirst({
      where: eq(users.email, session.user.email)
    })

    if (!user || !user.passwordHash) {
      return NextResponse.json(
        { error: 'OAuth 用户无法修改密码' },
        { status: 400 }
      )
    }

    // 验证当前密码
    const isValidPassword = await bcrypt.compare(currentPassword, user.passwordHash)
    if (!isValidPassword) {
      return NextResponse.json(
        { error: '当前密码错误' },
        { status: 401 }
      )
    }

    // 哈希新密码
    const newPasswordHash = await bcrypt.hash(newPassword, 10)

    // 更新密码
    await db
      .update(users)
      .set({
        passwordHash: newPasswordHash,
        updatedAt: new Date()
      })
      .where(eq(users.id, user.id))

    return NextResponse.json({ message: '密码修改成功' })
  } catch (error) {
    console.error('Change password error:', error)
    return NextResponse.json({ error: '密码修改失败' }, { status: 500 })
  }
}
```

**文件 3**: `src/app/api/user/usage/route.ts` (新建)

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@/lib/auth'
import { db } from '@/lib/db'
import { users, userUsage } from '@/../drizzle/schema'
import { eq } from 'drizzle-orm'

// GET /api/user/usage - 获取使用量统计
export async function GET(request: NextRequest) {
  try {
    const session = await auth()

    if (!session || !session.user?.email) {
      return NextResponse.json({ error: '未登录' }, { status: 401 })
    }

    // 查询用户 ID
    const user = await db.query.users.findFirst({
      where: eq(users.email, session.user.email),
      columns: { id: true }
    })

    if (!user) {
      return NextResponse.json({ error: '用户不存在' }, { status: 404 })
    }

    // 查询使用量
    let usage = await db.query.userUsage.findFirst({
      where: eq(userUsage.userId, user.id)
    })

    // 如果不存在，返回默认值
    if (!usage) {
      usage = {
        id: '',
        userId: user.id,
        documentCount: 0,
        storageUsed: 0,
        queryCount: 0,
        queryResetDate: new Date(),
        updatedAt: new Date()
      }
    }

    // 添加限额信息（可从配置文件读取，这里硬编码）
    const limits = {
      documentLimit: 50,
      storageLimit: 1 * 1024 * 1024 * 1024, // 1GB in bytes
      queryLimit: 1000
    }

    return NextResponse.json({
      ...usage,
      ...limits
    })
  } catch (error) {
    console.error('Get usage error:', error)
    return NextResponse.json({ error: '获取使用量失败' }, { status: 500 })
  }
}
```

**文件 4**: `src/app/api/user/account/route.ts` (新建)

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@/lib/auth'
import { db } from '@/lib/db'
import { users } from '@/../drizzle/schema'
import { eq } from 'drizzle-orm'
import { z } from 'zod'
import { rateLimit } from '@/lib/rate-limit'

const deleteLimiter = rateLimit({
  interval: 60 * 60 * 1000, // 1 hour
  uniqueTokenPerInterval: 500
})

// DELETE /api/user/account - 删除账户
export async function DELETE(request: NextRequest) {
  try {
    const session = await auth()

    if (!session || !session.user?.email) {
      return NextResponse.json({ error: '未登录' }, { status: 401 })
    }

    // Rate limiting
    try {
      await deleteLimiter.check(session.user.email, 1)
    } catch {
      return NextResponse.json(
        { error: '操作过于频繁，请1小时后再试' },
        { status: 429 }
      )
    }

    const body = await request.json()

    const deleteSchema = z.object({
      email: z.string().email('邮箱格式不正确')
    })

    const validation = deleteSchema.safeParse(body)
    if (!validation.success) {
      return NextResponse.json(
        { error: validation.error.errors[0].message },
        { status: 400 }
      )
    }

    const { email } = validation.data

    // 验证邮箱匹配
    if (email !== session.user.email) {
      return NextResponse.json(
        { error: '邮箱不匹配' },
        { status: 400 }
      )
    }

    // 删除用户（级联删除相关数据）
    await db
      .delete(users)
      .where(eq(users.email, email))

    // 返回 204 No Content
    return new NextResponse(null, { status: 204 })
  } catch (error) {
    console.error('Delete account error:', error)
    return NextResponse.json({ error: '删除账户失败' }, { status: 500 })
  }
}
```

### 安装必需的 UI 组件

[Source: docs/architecture.md#frontend-tech-stack]

**需要的 shadcn/ui 组件**:
```bash
# 如果尚未安装
npx shadcn-ui@latest add progress
npx shadcn-ui@latest add dialog
npx shadcn-ui@latest add label
```

**Toast 通知库** (如果尚未安装):
```bash
npm install sonner
```

### 测试策略

**单元测试**: `tests/unit/api/user-settings.test.ts` (新建)

测试场景:
- [ ] 测试 `GET /api/user/profile` 正确返回用户信息
- [ ] 测试 `PATCH /api/user/profile` 更新用户名成功
- [ ] 测试 `PATCH /api/user/profile` 验证失败（用户名过短/过长）
- [ ] 测试 `PATCH /api/user/password` 修改密码成功
- [ ] 测试 `PATCH /api/user/password` 当前密码错误时失败
- [ ] 测试 `PATCH /api/user/password` 密码强度不足时失败
- [ ] 测试 `GET /api/user/usage` 正确返回使用量统计
- [ ] 测试 `DELETE /api/user/account` 删除账户成功

**集成测试**: `tests/integration/settings-flow.test.ts` (新建)

测试场景:
- [ ] 测试完整的用户名修改流程
- [ ] 测试完整的密码修改流程
- [ ] 测试删除账户的完整流程（包含 session 清除）
- [ ] 测试 OAuth 用户不能修改密码
- [ ] 测试密码修改 rate limiting

**手动测试检查清单**:
- [ ] 访问 `/settings` 页面显示正常
- [ ] 未登录用户自动跳转到登录页
- [ ] 个人信息卡片显示完整信息
- [ ] OAuth 用户不显示"修改密码"按钮
- [ ] 修改用户名成功并显示 Toast
- [ ] 点击"修改密码"打开模态框
- [ ] 密码强度指示器正常显示
- [ ] 密码验证规则正确执行
- [ ] 修改密码成功后模态框关闭
- [ ] 使用量统计数据正确显示
- [ ] 进度条颜色根据使用率变化
- [ ] 删除账户需输入邮箱确认
- [ ] 删除账户后自动登出并跳转
- [ ] 所有 API 错误都有友好提示

---

## Tasks / Subtasks

### Task 1: 创建页面路由与基础布局 (AC1)

- [ ] 创建文件 `src/app/settings/page.tsx`
- [ ] 实现页面骨架：Header + 三个卡片区域
- [ ] 添加受保护路由逻辑（未登录跳转）
- [ ] 实现加载状态（Skeleton）
- [ ] 测试页面路由和布局显示

**测试验证**:
- 访问 `/settings` 页面正常显示
- 未登录用户自动跳转到 `/login`

### Task 2: 实现个人信息卡片 (AC2)

- [ ] 显示用户头像（使用 Avatar 组件）
- [ ] 显示邮箱地址和认证方式标签
- [ ] 实现用户名编辑表单
- [ ] 添加实时验证（长度2-50）
- [ ] 实现保存功能（调用 `/api/user/profile`）
- [ ] 显示注册时间（格式化）
- [ ] OAuth 用户显示特殊提示
- [ ] 添加成功/失败 Toast 通知

**测试验证**:
- 个人信息正确显示
- 用户名修改成功并更新显示

### Task 3: 实现修改密码功能 (AC3)

- [ ] 创建 `ChangePasswordModal.tsx` 组件
- [ ] 实现三个密码输入框（当前、新、确认）
- [ ] 添加密码强度指示器
- [ ] 实现实时验证逻辑
- [ ] OAuth 用户隐藏"修改密码"按钮或显示禁用提示
- [ ] 实现提交功能（调用 `/api/user/password`）
- [ ] 添加错误处理和 Toast 通知

**测试验证**:
- 模态框正常打开和关闭
- 密码验证规则正确执行
- 修改密码成功

### Task 4: 实现使用量统计卡片 (AC4)

- [ ] 从 `/api/user/usage` 获取数据
- [ ] 显示文档数量、存储空间、查询次数
- [ ] 实现进度条组件（使用 Progress）
- [ ] 实现颜色编码逻辑（绿/黄/红）
- [ ] 实现存储空间格式化（bytes → MB/GB）
- [ ] 显示查询重置日期

**测试验证**:
- 使用量数据正确显示
- 进度条颜色根据使用率变化

### Task 5: 实现删除账户功能 (AC5)

- [ ] 创建 `DeleteAccountModal.tsx` 组件
- [ ] 实现邮箱确认输入框
- [ ] 显示警告文字和数据删除列表
- [ ] 实现删除逻辑（调用 `/api/user/account`）
- [ ] 清除 NextAuth session
- [ ] 清除客户端存储（localStorage, sessionStorage）
- [ ] 跳转到首页并显示 Toast

**测试验证**:
- 模态框警告信息清晰
- 邮箱验证正确
- 删除后自动登出并跳转

### Task 6: 实现 API 端点 (AC6)

- [ ] 创建 `src/app/api/user/profile/route.ts`
  - [ ] 实现 GET（获取用户信息）
  - [ ] 实现 PATCH（更新用户名）
- [ ] 创建 `src/app/api/user/password/route.ts`
  - [ ] 实现 PATCH（修改密码）
  - [ ] 添加 bcrypt 密码验证和哈希
  - [ ] 实现 rate limiting
- [ ] 创建 `src/app/api/user/usage/route.ts`
  - [ ] 实现 GET（获取使用量）
  - [ ] 处理不存在记录的情况
- [ ] 创建 `src/app/api/user/account/route.ts`
  - [ ] 实现 DELETE（删除账户）
  - [ ] 实现 rate limiting
  - [ ] 验证邮箱匹配

**测试验证**:
- 所有 API 端点响应正确
- 验证逻辑完整
- Rate limiting 正常工作

### Task 7: 错误处理与安全 (AC7)

- [ ] 为所有 API 调用添加 try-catch
- [ ] 实现友好的错误提示（Toast）
- [ ] 添加表单客户端和服务端双重验证
- [ ] 实现密码修改 rate limiting（5分钟3次）
- [ ] 实现账户删除 rate limiting（1小时1次）
- [ ] 验证所有敏感操作需要登录状态
- [ ] 添加 CSRF Token 保护（NextAuth 内置）

**测试验证**:
- 所有错误都有友好提示
- Rate limiting 正常工作
- 安全验证通过

### Task 8: 完整流程测试 (所有 AC)

**单元测试**: `tests/unit/api/user-settings.test.ts` (新建)

**集成测试**: `tests/integration/settings-flow.test.ts` (新建)

**手动测试完整检查清单**: 见上文"手动测试检查清单"部分

### Task 9: UI/UX 优化和文档更新

- [ ] 添加页面过渡动画
- [ ] 优化移动端响应式布局
- [ ] 添加键盘快捷键支持（Esc 关闭模态框）
- [ ] 在 README 添加账户设置页面说明
- [ ] 更新用户手册（如果有）
- [ ] 添加代码注释说明关键逻辑

---

## Definition of Done

- [ ] 所有验收标准 (AC1-AC7) 已实现
- [ ] `/settings` 页面完整实现并可访问
- [ ] 个人信息展示和编辑功能正常
- [ ] 修改密码功能完整实现（包含 OAuth 用户特殊处理）
- [ ] 使用量统计正确显示
- [ ] 删除账户功能完整实现（包含二次确认）
- [ ] 所有 4 个 API 端点实现并测试通过
- [ ] Rate limiting 正常工作
- [ ] 单元测试覆盖所有 API 端点
- [ ] 集成测试覆盖完整流程
- [ ] 所有测试通过（单元 + 集成）
- [ ] 手动测试完整检查清单全部通过
- [ ] 代码通过 ESLint 检查
- [ ] TypeScript 编译无错误
- [ ] UI 响应式设计适配桌面和平板
- [ ] 代码已 Review 并合并到主分支

---

## QA Results

_待 QA 评审后更新_

---

## Dev Agent Record

### Agent Model Used
_待开发完成后更新_

### Debug Log References
_待开发完成后更新_

### Completion Notes
_待开发完成后更新_

### File List
_待开发完成后更新_

---

## Change Log

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2025-01-03 | 1.0 | Story 创建 | Bob (SM) |

---

## References

**架构文档**:
- `docs/architecture.md#system-architecture` - 系统架构设计
- `docs/architecture.md#database-schema` - 数据库 Schema
- `docs/architecture.md#security` - 安全策略

**前端规范**:
- `docs/front-end-spec.md#screen-4-account-settings-page` - 账户设置页面设计

**数据库 Schema**:
- `drizzle/schema.ts` - users 表和 userUsage 表定义

**相关 Story**:
- Story 1.5 - OAuth第三方登录（前置依赖）

**外部文档**:
- [shadcn/ui Progress Component](https://ui.shadcn.com/docs/components/progress)
- [shadcn/ui Dialog Component](https://ui.shadcn.com/docs/components/dialog)
- [Next.js Protected Routes](https://nextjs.org/docs/app/building-your-application/routing/middleware)

