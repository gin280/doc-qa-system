# Story 1.3: 用户注册功能

**Story ID**: 1.3  
**Epic**: 1 - 基础设施与用户认证  
**优先级**: P0 (MVP必须)  
**预估工时**: 2天  
**状态**: Draft

---

## User Story

作为**新用户**,  
我想要**使用邮箱注册账户**,  
以便**开始使用文档问答系统**。

---

## 验收标准

### AC1: 注册页面UI
- [x] 创建注册页面(`/register`)
- [x] 表单包含邮箱、密码、确认密码、用户名字段
- [x] 所有字段有清晰的label和placeholder
- [x] 页面设计符合UI规范(shadcn/ui风格)

### AC2: 前端表单验证
- [x] 邮箱格式验证(使用Zod)
- [x] 密码强度验证(至少8位,包含字母和数字)
- [x] 确认密码匹配验证
- [x] 用户名长度验证(1-50字符)
- [x] 实时显示验证错误提示

### AC3: 注册API实现
- [x] 创建`POST /api/auth/register` API
- [x] 验证邮箱唯一性(数据库查询)
- [x] 使用bcrypt哈希密码(salt rounds ≥ 10)
- [x] 创建用户记录到users表
- [x] 初始化UserUsage记录

### AC4: 注册成功流程
- [x] 注册成功后自动登录
- [x] 跳转到Dashboard(`/dashboard`)
- [x] 显示欢迎提示

### AC5: 错误处理
- [x] 邮箱已存在时显示友好错误提示
- [x] 密码不符合要求时显示具体错误
- [x] 网络错误时显示重试提示
- [x] API错误返回标准格式

---

## 技术实现指导

### 架构参考

**相关架构文档**:
- `docs/architecture.md#authentication-authorization` - 认证架构
- `docs/architecture.md#security-architecture` - 安全策略
- `docs/front-end-spec.md#authentication-pages` - UI设计规范

### 实现步骤

#### 1. 创建注册表单组件

```typescript
// src/components/auth/RegisterForm.tsx
'use client'

import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'

const registerSchema = z.object({
  email: z.string().email('邮箱格式不正确'),
  password: z.string()
    .min(8, '密码至少8位')
    .regex(/^(?=.*[A-Za-z])(?=.*\d)/, '密码必须包含字母和数字'),
  confirmPassword: z.string(),
  name: z.string().min(1).max(50),
}).refine((data) => data.password === data.confirmPassword, {
  message: '两次密码不一致',
  path: ['confirmPassword'],
})

export function RegisterForm() {
  const form = useForm({
    resolver: zodResolver(registerSchema),
  })
  
  const onSubmit = async (data) => {
    // 调用注册API
  }
  
  return (
    // 表单UI...
  )
}
```

#### 2. 实现注册API

```typescript
// src/app/api/auth/register/route.ts
import { db } from '@/lib/db'
import { users, userUsage } from '@/drizzle/schema'
import bcrypt from 'bcrypt'
import { z } from 'zod'

export async function POST(req: Request) {
  const body = await req.json()
  
  // 验证输入
  const schema = z.object({
    email: z.string().email(),
    password: z.string().min(8),
    name: z.string(),
  })
  
  const validData = schema.parse(body)
  
  // 检查邮箱是否已存在
  const [existing] = await db.select()
    .from(users)
    .where(eq(users.email, validData.email))
  
  if (existing) {
    return Response.json({ error: '邮箱已被注册' }, { status: 400 })
  }
  
  // 哈希密码
  const passwordHash = await bcrypt.hash(validData.password, 10)
  
  // 创建用户
  const [user] = await db.insert(users).values({
    email: validData.email,
    passwordHash,
    name: validData.name,
  }).returning()
  
  // 初始化UserUsage
  await db.insert(userUsage).values({
    userId: user.id,
  })
  
  return Response.json({ success: true, user })
}
```

---

## 任务分解

### Task 1: 注册表单UI (3h)
- [ ] 创建RegisterForm组件
- [ ] 使用shadcn/ui组件构建表单
- [ ] 添加表单验证(Zod + React Hook Form)
- [ ] 添加加载状态和错误提示

### Task 2: 注册API实现 (3h)
- [ ] 创建POST /api/auth/register路由
- [ ] 实现邮箱唯一性检查
- [ ] 实现密码哈希(bcrypt)
- [ ] 创建用户和UserUsage记录

### Task 3: 前后端集成 (2h)
- [ ] 前端调用注册API
- [ ] 处理成功和错误状态
- [ ] 实现自动登录逻辑
- [ ] 实现页面跳转

---

## 测试要求

### 单元测试
```typescript
// tests/unit/api/register.test.ts
describe('POST /api/auth/register', () => {
  it('should register user successfully', async () => {
    const res = await POST({
      json: async () => ({
        email: 'new@example.com',
        password: 'password123',
        name: 'Test User',
      })
    })
    
    expect(res.status).toBe(200)
  })
  
  it('should reject duplicate email', async () => {
    // 测试邮箱重复
  })
})
```

### E2E测试
- [ ] 完整注册流程测试
- [ ] 表单验证测试
- [ ] 错误处理测试

---

## 依赖关系

**前置依赖**: 
- Story 1.2 (数据库Schema)

**后续依赖**: 
- Story 1.4 (登录功能)

---

**创建日期**: 2025-01-03  
**负责人**: Development Team

