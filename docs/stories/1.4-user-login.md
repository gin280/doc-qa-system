# Story 1.4: 用户登录功能

**Story ID**: 1.4  
**Epic**: 1 - 基础设施与用户认证  
**优先级**: P0 (MVP必须)  
**预估工时**: 2天  
**状态**: Draft

---

## User Story

作为**已注册用户**,  
我想要**使用邮箱和密码登录系统**,  
以便**访问我的个人工作区和使用文档问答功能**。

---

## 验收标准

### AC1: 登录页面UI
- [ ] 创建登录页面(`/login`)
- [ ] 表单包含邮箱、密码字段
- [ ] 添加"记住我"复选框
- [ ] 添加"忘记密码"链接(UI only,功能待后续实现)
- [ ] 添加"没有账号?去注册"链接
- [ ] 页面设计符合UI规范(shadcn/ui风格)

### AC2: 前端表单验证
- [ ] 邮箱格式验证(使用Zod)
- [ ] 密码非空验证
- [ ] 实时显示验证错误提示
- [ ] 提交按钮禁用状态管理

### AC3: NextAuth.js集成与配置
- [ ] 安装并配置NextAuth.js v5
- [ ] 创建`/api/auth/[...nextauth]/route.ts`
- [ ] 配置Credentials Provider(邮箱密码)
- [ ] 配置JWT策略
- [ ] 配置Session策略(JWT存储在HTTP-Only Cookie)
- [ ] 设置Session过期时间(默认7天,记住我30天)

### AC4: 登录API实现
- [ ] 实现`authorize`回调验证用户凭证
- [ ] 从数据库查询用户(按邮箱)
- [ ] 使用bcrypt验证密码
- [ ] 验证失败返回适当错误
- [ ] 验证成功创建Session
- [ ] 实施速率限制(每IP每小时10次登录尝试)

### AC5: 登录成功流程
- [ ] 登录成功后创建Session
- [ ] 存储用户信息到Session(id, email, name)
- [ ] 跳转到Dashboard(`/dashboard`)
- [ ] 显示欢迎回来提示
- [ ] 页面刷新保持登录状态

### AC6: 错误处理
- [ ] 邮箱不存在时显示"邮箱或密码错误"(安全考虑,不透露具体原因)
- [ ] 密码错误时显示"邮箱或密码错误"
- [ ] 账户被禁用时显示适当提示
- [ ] 网络错误时显示重试提示
- [ ] API错误返回标准格式

### AC7: 登出功能
- [ ] 实现登出API(`/api/auth/signout`)
- [ ] 清除Session和Cookie
- [ ] 跳转到登录页面

---

## 技术实现指导

### 架构参考

**相关架构文档**:
- `docs/architecture.md#authentication-authorization` - 认证架构
- `docs/architecture.md#security-architecture` - 安全策略
- `docs/front-end-spec.md#authentication-pages` - UI设计规范

### 实现步骤

#### 1. 安装NextAuth.js依赖

```bash
npm install next-auth@beta
npm install -D @types/next-auth
```

#### 2. 配置NextAuth.js

```typescript
// src/app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth'
import CredentialsProvider from 'next-auth/providers/credentials'
import { db } from '@/lib/db'
import { users } from '@/drizzle/schema'
import { eq } from 'drizzle-orm'
import bcrypt from 'bcrypt'
import { checkRateLimit, getClientIp } from '@/lib/rate-limit'

export const authOptions = {
  providers: [
    CredentialsProvider({
      name: 'Credentials',
      credentials: {
        email: { label: "邮箱", type: "email" },
        password: { label: "密码", type: "password" },
        remember: { label: "记住我", type: "checkbox" }
      },
      async authorize(credentials, req) {
        if (!credentials?.email || !credentials?.password) {
          throw new Error('邮箱和密码不能为空')
        }

        // 速率限制检查
        const clientIp = getClientIp(req)
        const rateLimitResult = checkRateLimit(`login:${clientIp}`, {
          windowMs: 60 * 60 * 1000, // 1小时
          max: 10, // 最多10次尝试
        })

        if (!rateLimitResult.success) {
          throw new Error('登录尝试过于频繁，请稍后再试')
        }

        // 查询用户
        const [user] = await db
          .select()
          .from(users)
          .where(eq(users.email, credentials.email))

        if (!user) {
          throw new Error('邮箱或密码错误')
        }

        // 验证密码
        const isValid = await bcrypt.compare(
          credentials.password,
          user.passwordHash
        )

        if (!isValid) {
          throw new Error('邮箱或密码错误')
        }

        // 返回用户信息
        return {
          id: user.id,
          email: user.email,
          name: user.name,
        }
      },
    }),
  ],
  
  session: {
    strategy: 'jwt',
    maxAge: 7 * 24 * 60 * 60, // 7天(默认)
  },
  
  callbacks: {
    async jwt({ token, user, trigger }) {
      if (user) {
        token.id = user.id
        token.email = user.email
        token.name = user.name
      }
      return token
    },
    
    async session({ session, token }) {
      if (token) {
        session.user.id = token.id
        session.user.email = token.email
        session.user.name = token.name
      }
      return session
    },
  },
  
  pages: {
    signIn: '/login',
    error: '/login',
  },
  
  cookies: {
    sessionToken: {
      name: 'next-auth.session-token',
      options: {
        httpOnly: true,
        sameSite: 'lax',
        path: '/',
        secure: process.env.NODE_ENV === 'production',
      },
    },
  },
}

const handler = NextAuth(authOptions)
export { handler as GET, handler as POST }
```

#### 3. 创建登录表单组件

```typescript
// src/components/auth/LoginForm.tsx
'use client'

import { useState } from 'react'
import { signIn } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Checkbox } from '@/components/ui/checkbox'
import Link from 'next/link'

const loginSchema = z.object({
  email: z.string().email('邮箱格式不正确'),
  password: z.string().min(1, '密码不能为空'),
  remember: z.boolean().optional(),
})

type LoginFormData = z.infer<typeof loginSchema>

export function LoginForm() {
  const router = useRouter()
  const [error, setError] = useState<string | null>(null)
  const [isLoading, setIsLoading] = useState(false)

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema),
  })

  const onSubmit = async (data: LoginFormData) => {
    setError(null)
    setIsLoading(true)

    try {
      const result = await signIn('credentials', {
        email: data.email,
        password: data.password,
        remember: data.remember,
        redirect: false,
      })

      if (result?.error) {
        setError(result.error)
      } else if (result?.ok) {
        router.push('/dashboard')
        router.refresh()
      }
    } catch (err) {
      setError('登录失败，请稍后重试')
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <div className="w-full max-w-md space-y-6">
      <div className="space-y-2 text-center">
        <h1 className="text-3xl font-bold">欢迎回来</h1>
        <p className="text-gray-500">登录您的账户</p>
      </div>

      <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
        {error && (
          <div className="p-3 text-sm text-red-500 bg-red-50 rounded-md">
            {error}
          </div>
        )}

        <div className="space-y-2">
          <label htmlFor="email" className="text-sm font-medium">
            邮箱
          </label>
          <Input
            id="email"
            type="email"
            placeholder="your@email.com"
            {...register('email')}
            disabled={isLoading}
          />
          {errors.email && (
            <p className="text-sm text-red-500">{errors.email.message}</p>
          )}
        </div>

        <div className="space-y-2">
          <label htmlFor="password" className="text-sm font-medium">
            密码
          </label>
          <Input
            id="password"
            type="password"
            placeholder="••••••••"
            {...register('password')}
            disabled={isLoading}
          />
          {errors.password && (
            <p className="text-sm text-red-500">{errors.password.message}</p>
          )}
        </div>

        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-2">
            <Checkbox id="remember" {...register('remember')} />
            <label htmlFor="remember" className="text-sm">
              记住我
            </label>
          </div>
          <Link
            href="/forgot-password"
            className="text-sm text-blue-600 hover:underline"
          >
            忘记密码?
          </Link>
        </div>

        <Button type="submit" className="w-full" disabled={isLoading}>
          {isLoading ? '登录中...' : '登录'}
        </Button>
      </form>

      <div className="text-center text-sm">
        还没有账号?{' '}
        <Link href="/register" className="text-blue-600 hover:underline">
          立即注册
        </Link>
      </div>
    </div>
  )
}
```

#### 4. 创建登录页面

```typescript
// src/app/(auth)/login/page.tsx
import { LoginForm } from '@/components/auth/LoginForm'
import { Card, CardContent } from '@/components/ui/card'

export default function LoginPage() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50">
      <Card className="w-full max-w-md">
        <CardContent className="pt-6">
          <LoginForm />
        </CardContent>
      </Card>
    </div>
  )
}
```

#### 5. 创建Session Provider

```typescript
// src/components/providers/SessionProvider.tsx
'use client'

import { SessionProvider as NextAuthSessionProvider } from 'next-auth/react'

export function SessionProvider({ children }: { children: React.ReactNode }) {
  return <NextAuthSessionProvider>{children}</NextAuthSessionProvider>
}
```

#### 6. 更新根布局

```typescript
// src/app/layout.tsx
import { SessionProvider } from '@/components/providers/SessionProvider'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-CN">
      <body>
        <SessionProvider>
          {children}
        </SessionProvider>
      </body>
    </html>
  )
}
```

---

## 任务分解

### Task 1: NextAuth.js配置 (4h)
- [ ] 安装next-auth依赖
- [ ] 创建API路由配置
- [ ] 配置Credentials Provider
- [ ] 配置JWT和Session策略
- [ ] 配置Cookie选项

### Task 2: 登录表单UI (3h)
- [ ] 创建LoginForm组件
- [ ] 使用shadcn/ui组件构建表单
- [ ] 添加表单验证(Zod + React Hook Form)
- [ ] 添加加载状态和错误提示
- [ ] 实现"记住我"功能

### Task 3: 登录API实现 (3h)
- [ ] 实现authorize回调
- [ ] 邮箱用户查询
- [ ] bcrypt密码验证
- [ ] Session创建和JWT生成
- [ ] 速率限制集成

### Task 4: 前后端集成 (2h)
- [ ] 前端调用signIn方法
- [ ] 处理登录成功和错误状态
- [ ] 实现页面跳转
- [ ] 添加SessionProvider
- [ ] 测试Session持久化

### Task 5: 登出功能 (1h)
- [ ] 实现signOut调用
- [ ] 清除Session和Cookie
- [ ] 页面跳转和状态清理

---

## 测试要求

### 单元测试

```typescript
// tests/unit/api/login.test.ts
describe('POST /api/auth/callback/credentials', () => {
  it('should login user successfully', async () => {
    // 测试成功登录
  })
  
  it('should reject invalid email', async () => {
    // 测试无效邮箱
  })
  
  it('should reject incorrect password', async () => {
    // 测试密码错误
  })
  
  it('should enforce rate limiting', async () => {
    // 测试速率限制
  })
})
```

### 集成测试

```typescript
// tests/integration/auth-flow.test.ts
describe('Authentication Flow', () => {
  it('should complete login flow', async () => {
    // 测试完整登录流程
  })
  
  it('should persist session across page refresh', async () => {
    // 测试Session持久化
  })
  
  it('should handle remember me functionality', async () => {
    // 测试记住我功能
  })
})
```

### E2E测试

- [ ] 完整登录流程测试
- [ ] 表单验证测试
- [ ] 错误处理测试
- [ ] Session持久化测试
- [ ] 登出流程测试

---

## 安全考虑

### 关键安全措施

1. **密码安全**
   - ✅ 使用bcrypt验证哈希密码
   - ✅ 不在日志中记录密码
   - ✅ 错误信息不透露账户存在性

2. **Session安全**
   - ✅ JWT存储在HTTP-Only Cookie
   - ✅ 使用Secure标志(生产环境)
   - ✅ 设置合理的Session过期时间
   - ✅ 实施CSRF保护(NextAuth默认)

3. **速率限制**
   - ✅ 限制登录尝试频率(10次/小时/IP)
   - ✅ 防止暴力破解攻击

4. **错误处理**
   - ✅ 统一的错误消息(不透露具体原因)
   - ✅ 适当的HTTP状态码
   - ✅ 前端友好的错误提示

---

## 依赖关系

**前置依赖**: 
- Story 1.2 (数据库Schema - users表)
- Story 1.3 (用户注册功能 - 已有用户数据)

**后续依赖**: 
- Story 1.5 (OAuth第三方登录)
- Story 1.6 (用户账户管理)
- All Epic 2 & 3 Stories (需要用户认证)

---

## 环境变量

```env
# .env.local
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=<generate-random-secret>
```

生成SECRET命令:
```bash
openssl rand -base64 32
```

---

## Definition of Done

- [ ] 所有验收标准已实现
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 集成测试通过
- [ ] E2E测试通过
- [ ] ESLint检查通过
- [ ] TypeScript无类型错误
- [ ] 代码审查通过
- [ ] QA测试通过
- [ ] 文档已更新

---

**创建日期**: 2025-01-03  
**负责人**: Development Team  
**Scrum Master**: Bob

---

## Dev Agent Record

### Agent Model Used
_待开发agent填写_

### Completion Notes
_待开发agent填写_

### Debug Log References
_待开发agent填写_

### File List
_待开发agent填写_

### Change Log
_待开发agent填写_

### Status
Status: Draft

---

## QA Results

_待QA审查后填写_


