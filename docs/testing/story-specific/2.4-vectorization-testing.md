# æ–‡æ¡£å‘é‡åŒ–æµ‹è¯•æŒ‡å—

## æµ‹è¯•ç›®æ ‡

éªŒè¯Story 2.4çš„å®Œæ•´åŠŸèƒ½ï¼š
1. âœ… æ–‡æ¡£åˆ†å— (Chunking)
2. âœ… å‘é‡åŒ– (Embedding)
3. âœ… è‡ªåŠ¨è§¦å‘æµç¨‹
4. âœ… çŠ¶æ€ç®¡ç†
5. âœ… é”™è¯¯å¤„ç†

---

## å‰ç½®å‡†å¤‡

### 1. ç¯å¢ƒé…ç½®

ç¡®ä¿ `.env.local` å·²é…ç½®ï¼š

```bash
# å¿…éœ€é…ç½®
DATABASE_URL=...
NEXTAUTH_SECRET=...
NEXTAUTH_URL=http://localhost:3000
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...

# LLMé…ç½®ï¼ˆæ™ºè°±AIï¼‰
LLM_PROVIDER=zhipu
ZHIPU_API_KEY=your-key
```

### 2. å‡†å¤‡æµ‹è¯•æ–‡ä»¶

åœ¨ `tests/fixtures/` ä¸­å·²æœ‰æµ‹è¯•æ–‡ä»¶ï¼š

- `pdf/sample.pdf` - å°å‹PDF (10KB)
- `docx/sample.docx` - Wordæ–‡æ¡£
- `text/sample.txt` - çº¯æ–‡æœ¬

### 3. å¯åŠ¨æœåŠ¡

```bash
npm run dev
```

è®¿é—®: http://localhost:3000

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1: åŸºç¡€æµç¨‹ - å°æ–‡æ¡£å‘é‡åŒ–

**ç›®æ ‡**: éªŒè¯å®Œæ•´çš„è‡ªåŠ¨åŒ–æµç¨‹

**æ­¥éª¤**:

1. **ç™»å½•ç³»ç»Ÿ**
   - è®¿é—® http://localhost:3000
   - æ³¨å†Œ/ç™»å½•è´¦å·

2. **ä¸Šä¼ æ–‡æ¡£**
   - ç‚¹å‡»"ä¸Šä¼ æ–‡æ¡£"
   - é€‰æ‹© `tests/fixtures/pdf/sample.pdf`
   - ç¡®è®¤ä¸Šä¼ æˆåŠŸ
   - **é¢„æœŸ**: çŠ¶æ€æ˜¾ç¤º `PENDING`

3. **è§¦å‘è§£æ** (é€šå¸¸è‡ªåŠ¨è§¦å‘)
   - ç‚¹å‡»"è§£æ"æŒ‰é’®
   - **é¢„æœŸ**: çŠ¶æ€å˜ä¸º `PARSING`
   - ç­‰å¾…3-5ç§’
   - **é¢„æœŸ**: çŠ¶æ€å˜ä¸º `READY`

4. **è‡ªåŠ¨å‘é‡åŒ–** (åå°è‡ªåŠ¨)
   - æ— éœ€æ‰‹åŠ¨æ“ä½œ
   - åˆ·æ–°é¡µé¢æŸ¥çœ‹çŠ¶æ€
   - **é¢„æœŸ**: çŠ¶æ€æ˜¾ç¤º `EMBEDDING`
   - ç­‰å¾…10-30ç§’ï¼ˆå–å†³äºæ–‡æ¡£å¤§å°ï¼‰
   - **é¢„æœŸ**: çŠ¶æ€å˜ä¸º `READY`
   - **é¢„æœŸ**: chunksCount > 0

5. **éªŒè¯ç»“æœ**
   
   æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12)ï¼ŒæŸ¥çœ‹Networkæ ‡ç­¾ï¼š
   
   ```bash
   GET /api/documents/[id]/process
   
   å“åº”:
   {
     "id": "xxx",
     "status": "READY",
     "chunksCount": 15,  // å®é™…æ•°é‡
     "metadata": {
       "embedding": {
         "vectorCount": 15,
         "dimension": 1536,
         "provider": "zhipu"
       }
     }
   }
   ```

6. **æŸ¥çœ‹chunks**
   
   ```bash
   GET /api/documents/[id]/chunks
   
   å“åº”:
   {
     "chunks": [...],
     "pagination": {
       "total": 15,
       "hasMore": false
     }
   }
   ```

**é¢„æœŸç»“æœ**:
- âœ… æ–‡æ¡£çŠ¶æ€: PENDING â†’ PARSING â†’ READY â†’ EMBEDDING â†’ READY
- âœ… chunksCount: > 0
- âœ… å‘é‡ç»´åº¦: 1536
- âœ… æä¾›å•†: zhipu

---

### æµ‹è¯•2: å¤§æ–‡æ¡£å¤„ç†

**ç›®æ ‡**: éªŒè¯æ‰¹é‡å¤„ç†å’Œæ€§èƒ½

**æ­¥éª¤**:

1. ä¸Šä¼ è¾ƒå¤§çš„PDF (50-100KB)
2. è§‚å¯Ÿå¤„ç†æ—¶é—´
3. æ£€æŸ¥æ˜¯å¦æœ‰æ‰¹å¤„ç†æ—¥å¿—

**åœ¨æœåŠ¡å™¨æ—¥å¿—ä¸­æŸ¥æ‰¾**:

```
[Chunking] Document xxx: å¼€å§‹åˆ†å—, æ–‡æœ¬é•¿åº¦=45678å­—ç¬¦
[Chunking] åˆ†å—å®Œæˆ: 45ä¸ªchunks
[Embedding] Document xxx: å¼€å§‹å‘é‡åŒ–, chunksæ•°=45
[Embedding] å¤„ç†æ‰¹æ¬¡ 1/3: chunks 0-20
[Embedding] æ‰¹æ¬¡ 1 å®Œæˆ
[Embedding] å¤„ç†æ‰¹æ¬¡ 2/3: chunks 20-40
[Embedding] æ‰¹æ¬¡ 2 å®Œæˆ
[Embedding] å¤„ç†æ‰¹æ¬¡ 3/3: chunks 40-45
[Embedding] æ‰¹æ¬¡ 3 å®Œæˆ
[Embedding] Document xxx: å‘é‡åŒ–å®Œæˆ
```

**é¢„æœŸç»“æœ**:
- âœ… å¤§æ–‡æ¡£æ­£ç¡®åˆ†å—ï¼ˆæ¯å—çº¦1000å­—ç¬¦ï¼‰
- âœ… æ‰¹é‡å¤„ç†ï¼ˆ20 chunks/batchï¼‰
- âœ… å¤„ç†æ—¶é—´ < 60ç§’

---

### æµ‹è¯•3: é”™è¯¯å¤„ç†

**ç›®æ ‡**: éªŒè¯é”™è¯¯å¤„ç†æœºåˆ¶

#### 3.1 æ— æ•ˆçš„API Key

**æ­¥éª¤**:
1. ä¸´æ—¶ä¿®æ”¹ `.env.local`ï¼Œè®¾ç½®é”™è¯¯çš„API Key
2. é‡å¯æœåŠ¡
3. ä¸Šä¼ æ–‡æ¡£
4. è§‚å¯Ÿé”™è¯¯å¤„ç†

**é¢„æœŸç»“æœ**:
- âœ… çŠ¶æ€å˜ä¸º `FAILED`
- âœ… metadata.error åŒ…å«é”™è¯¯ä¿¡æ¯
- âœ… å‰ç«¯æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º

#### 3.2 è¶…å¤§æ–‡æ¡£

**æ­¥éª¤**:
1. å°è¯•ä¸Šä¼  > 10MB çš„æ–‡æ¡£
2. è§‚å¯Ÿå¤„ç†ç»“æœ

**é¢„æœŸç»“æœ**:
- âœ… ä¸Šä¼ é˜¶æ®µå³è¢«æ‹¦æˆªï¼ˆæ–‡ä»¶å¤§å°é™åˆ¶ï¼‰
- âœ… æˆ–è§£æé˜¶æ®µè¶…æ—¶å¤„ç†

---

### æµ‹è¯•4: APIç«¯ç‚¹æµ‹è¯•

ä½¿ç”¨curlæˆ–Postmanæµ‹è¯•APIï¼š

#### 4.1 è§¦å‘å¤„ç†

```bash
curl -X POST http://localhost:3000/api/documents/[id]/process \
  -H "Cookie: your-session-cookie"
```

**é¢„æœŸ**: è¿”å›å¤„ç†ç»“æœ

#### 4.2 æŸ¥è¯¢çŠ¶æ€

```bash
curl http://localhost:3000/api/documents/[id]/process \
  -H "Cookie: your-session-cookie"
```

**é¢„æœŸ**: è¿”å›å½“å‰çŠ¶æ€å’Œchunksæ•°é‡

#### 4.3 æŸ¥è¯¢chunks

```bash
curl http://localhost:3000/api/documents/[id]/chunks?limit=5 \
  -H "Cookie: your-session-cookie"
```

**é¢„æœŸ**: è¿”å›åˆ†é¡µçš„chunksåˆ—è¡¨

---

### æµ‹è¯•5: å¤šæ–‡æ¡£å¹¶å‘

**ç›®æ ‡**: éªŒè¯å¹¶å‘å¤„ç†èƒ½åŠ›

**æ­¥éª¤**:
1. è¿ç»­ä¸Šä¼ 3-5ä¸ªæ–‡æ¡£
2. è§¦å‘æ‰€æœ‰æ–‡æ¡£çš„è§£æ
3. è§‚å¯Ÿå¹¶å‘å¤„ç†æƒ…å†µ

**é¢„æœŸç»“æœ**:
- âœ… æ‰€æœ‰æ–‡æ¡£éƒ½èƒ½æ­£ç¡®å¤„ç†
- âœ… ä¸ä¼šäº’ç›¸å¹²æ‰°
- âœ… çŠ¶æ€ç‹¬ç«‹ç®¡ç†

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

å¼€å‘ç¯å¢ƒä¸­ï¼ŒæœåŠ¡å™¨æ—¥å¿—ä¼šå®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦ï¼š

```bash
npm run dev

# æŸ¥çœ‹æ—¥å¿—è¾“å‡º
[ParseService] Successfully parsed document xxx
[Chunking] Document xxx: å¼€å§‹åˆ†å—...
[Embedding] Document xxx: å¼€å§‹å‘é‡åŒ–...
```

### 2. ä½¿ç”¨æµè§ˆå™¨DevTools

- **Networkæ ‡ç­¾**: æŸ¥çœ‹APIè¯·æ±‚å“åº”
- **Consoleæ ‡ç­¾**: æŸ¥çœ‹å‰ç«¯æ—¥å¿—
- **Application â†’ Storage**: æŸ¥çœ‹sessionçŠ¶æ€

### 3. æ•°æ®åº“æ£€æŸ¥

ä½¿ç”¨Drizzle StudioæŸ¥çœ‹æ•°æ®ï¼š

```bash
npm run db:studio
```

æ£€æŸ¥ï¼š
- `documents` è¡¨çš„ status å’Œ metadata
- `document_chunks` è¡¨çš„ chunks å’Œ embedding
- embedding å‘é‡æ˜¯å¦æ­£ç¡®å­˜å‚¨

### 4. æ€§èƒ½ç›‘æ§

åœ¨ä»£ç ä¸­æ·»åŠ æ—¶é—´æˆ³ï¼š

```typescript
console.time('åˆ†å—å¤„ç†')
// ... åˆ†å—ä»£ç 
console.timeEnd('åˆ†å—å¤„ç†')

console.time('å‘é‡åŒ–')
// ... å‘é‡åŒ–ä»£ç 
console.timeEnd('å‘é‡åŒ–')
```

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹æ‰€æœ‰æµ‹è¯•é¡¹ï¼š

### åŸºç¡€åŠŸèƒ½
- [ ] å°æ–‡æ¡£ (10KB) å®Œæ•´æµç¨‹
- [ ] ä¸­æ–‡æ¡£ (50KB) å®Œæ•´æµç¨‹
- [ ] PDFæ–‡æ¡£å¤„ç†
- [ ] Wordæ–‡æ¡£å¤„ç†
- [ ] çº¯æ–‡æœ¬å¤„ç†

### çŠ¶æ€ç®¡ç†
- [ ] PENDING â†’ PARSING è½¬æ¢
- [ ] PARSING â†’ READY è½¬æ¢
- [ ] READY â†’ EMBEDDING è½¬æ¢
- [ ] EMBEDDING â†’ READY è½¬æ¢
- [ ] é”™è¯¯æ—¶ â†’ FAILED è½¬æ¢

### æ•°æ®éªŒè¯
- [ ] chunksCount æ­£ç¡®
- [ ] embedding ç»´åº¦ = 1536
- [ ] æä¾›å•† = zhipu
- [ ] chunks å†…å®¹æ­£ç¡®
- [ ] metadata å®Œæ•´

### é”™è¯¯å¤„ç†
- [ ] æ— æ•ˆAPI Key
- [ ] ç½‘ç»œè¶…æ—¶
- [ ] æ–‡æ¡£è¿‡å¤§
- [ ] å¹¶å‘å¤„ç†

### æ€§èƒ½æŒ‡æ ‡
- [ ] 10KBæ–‡æ¡£ < 10ç§’
- [ ] 50KBæ–‡æ¡£ < 30ç§’
- [ ] 100KBæ–‡æ¡£ < 60ç§’
- [ ] æ‰¹é‡å¤„ç†ç”Ÿæ•ˆ

---

## ğŸ› å¸¸è§é—®é¢˜

### Q: çŠ¶æ€ä¸€ç›´æ˜¯EMBEDDINGï¼Ÿ

**å¯èƒ½åŸå› **:
- API Keyæ— æ•ˆ
- ç½‘ç»œé—®é¢˜
- æœåŠ¡å™¨é”™è¯¯

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—
2. éªŒè¯API Key
3. æŸ¥çœ‹æ•°æ®åº“ metadata.error

### Q: chunksä¸ºç©ºï¼Ÿ

**å¯èƒ½åŸå› **:
- æ–‡æ¡£è§£æå¤±è´¥
- åˆ†å—æœåŠ¡é”™è¯¯

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥æ–‡æ¡£æ˜¯å¦æ­£ç¡®è§£æ
2. æŸ¥çœ‹ metadata.content æ˜¯å¦å­˜åœ¨
3. æ£€æŸ¥åˆ†å—æœåŠ¡æ—¥å¿—

### Q: å‘é‡åŒ–å¾ˆæ…¢ï¼Ÿ

**å¯èƒ½åŸå› **:
- æ–‡æ¡£å¤ªå¤§
- ç½‘ç»œå»¶è¿Ÿ
- APIé™æµ

**è§£å†³æ–¹æ³•**:
1. å‡å°æ–‡æ¡£å¤§å°
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. å¢åŠ è¶…æ—¶æ—¶é—´

---

## ğŸ“Š æ€§èƒ½åŸºå‡†

å‚è€ƒæ€§èƒ½æŒ‡æ ‡ï¼š

| æ–‡æ¡£å¤§å° | Chunksæ•° | åˆ†å—æ—¶é—´ | å‘é‡åŒ–æ—¶é—´ | æ€»æ—¶é—´ |
|---------|---------|---------|-----------|--------|
| 10KB    | ~10     | <1s     | ~5s       | <10s   |
| 50KB    | ~50     | <2s     | ~15s      | <20s   |
| 100KB   | ~100    | <5s     | ~30s      | <40s   |

---

**æµ‹è¯•å®Œæˆåï¼Œè¯·åœ¨GitHub Issueä¸­æŠ¥å‘Šç»“æœï¼** ğŸ‰
